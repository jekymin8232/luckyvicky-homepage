<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#c0392b">
<title>VitalGuard AI v4.1.7 ‚Äî Infrastructure‚ÄëIndependent Survival Framework</title>
<link rel="manifest" id="pwa-manifest">
<style>
/* ============================================================
   VitalGuard AI v4.1.7 ‚Äî MASTER STYLESHEET
   ¬© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI
   https://mcorpai.org | contact@mcorpai.org
   Managed by: https://mcorpai.org
   M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
   Exclusively for civilian, agricultural, and humanitarian use.
   Zero External Dependencies | 100% Offline | Vanilla CSS/JS
   ============================================================ */
:root{--bg-primary:#0d1117;--bg-secondary:#161b22;--bg-card:#1c2333;--bg-elevated:#21283b;--text-primary:#e6edf3;--text-secondary:#8b949e;--text-muted:#6e7681;--accent-red:#c0392b;--accent-green:#2ecc71;--accent-yellow:#f1c40f;--accent-orange:#e67e22;--accent-blue:#3498db;--zone-safe:#2ecc71;--zone-caution:#f1c40f;--zone-warning:#e67e22;--zone-danger:#e74c3c;--zone-lost:#9b59b6;--border-color:#30363d;--radius-sm:8px;--radius-md:12px;--radius-lg:20px;--shadow-soft:0 2px 12px rgba(0,0,0,.3);--tr-fast:.15s ease;--tr-norm:.3s ease;--font-body:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;--font-mono:'Courier New',Courier,monospace}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;user-select:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg-primary)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
#app{max-width:480px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:72px}
.header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:14px 20px 10px;text-align:center;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:100}
.header-logo{font-size:2rem}.header-title{font-family:'Georgia',serif;font-size:1.4rem;color:var(--accent-red);letter-spacing:1px;text-shadow:0 0 20px rgba(192,57,43,.4)}
.header-sub{font-size:.68rem;color:var(--text-muted);margin-top:2px}
.header-mission{font-size:.62rem;color:var(--accent-blue);margin-top:3px;font-style:italic;opacity:.85;line-height:1.3}
.header-disclaimer{font-size:.58rem;color:var(--accent-orange);margin-top:3px;line-height:1.3;opacity:.9}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;z-index:100;max-width:480px;margin:0 auto}
.bnav-btn{flex:1;padding:8px 4px 6px;text-align:center;cursor:pointer;border:none;background:none;color:var(--text-muted);font-size:.63rem;font-family:var(--font-body);display:flex;flex-direction:column;align-items:center;gap:2px;transition:color var(--tr-fast)}
.bnav-btn .bnav-icon{font-size:1.3rem}.bnav-btn.active{color:var(--accent-red)}.bnav-btn:active{opacity:.7}
.panel{display:none;padding:16px;animation:fadeIn .25s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-color);padding:14px;margin-bottom:10px}
.pet-card{display:flex;align-items:center;gap:12px;padding:14px;margin-bottom:10px;background:var(--bg-card);border-radius:var(--radius-md);border:2px solid var(--border-color);transition:all var(--tr-norm);cursor:pointer;position:relative}
.pet-card:active{transform:scale(.98)}
.pet-card.zone-safe{border-color:rgba(46,204,113,.4)}.pet-card.zone-caution{border-color:rgba(241,196,15,.5)}.pet-card.zone-warning{border-color:rgba(230,126,34,.6)}.pet-card.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 15px rgba(231,76,60,.25);animation:pulseDanger 1.2s ease infinite}.pet-card.zone-lost{border-color:var(--zone-lost);opacity:.85}
@keyframes pulseDanger{0%,100%{box-shadow:0 0 15px rgba(231,76,60,.25)}50%{box-shadow:0 0 25px rgba(231,76,60,.45)}}
.pet-icon-circle{width:48px;height:48px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0}
.pet-details{flex:1;min-width:0}.pet-name{font-weight:700;font-size:.95rem;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pet-status-row{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text-secondary)}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pet-signal{text-align:right;flex-shrink:0}.pet-rssi{font-size:.9rem;font-weight:600;font-family:var(--font-mono);line-height:1}
.trend-arrow{font-size:.7rem;margin-left:2px}
.zone-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.6rem;font-weight:700;letter-spacing:.5px;margin-top:3px;color:#000}
.zone-badge.safe{background:var(--zone-safe)}.zone-badge.caution{background:var(--zone-caution)}.zone-badge.warning{background:var(--zone-warning)}.zone-badge.danger{background:var(--zone-danger);color:#fff}.zone-badge.lost{background:var(--zone-lost);color:#fff}
.pet-conf{font-size:.6rem;color:var(--text-muted);margin-top:2px}
.pet-why{font-size:.58rem;color:var(--accent-orange);margin-top:1px;font-style:italic}
.section-title{font-size:.85rem;font-weight:700;margin-bottom:10px;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.btn{padding:10px 18px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:var(--font-body);font-size:.85rem;font-weight:600;transition:all var(--tr-fast);text-align:center}
.btn:active{transform:scale(.96)}.btn-primary{background:var(--accent-red);color:#fff}.btn-success{background:var(--accent-green);color:#000}
.btn-secondary{background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-danger-outline{background:transparent;color:var(--zone-danger);border:1px solid var(--zone-danger);font-size:.75rem;padding:6px 12px}
.btn-sm{font-size:.75rem;padding:6px 12px}.btn-block{width:100%}
.btn-add{background:linear-gradient(135deg,var(--accent-red),#e74c3c);color:#fff;font-size:1rem;padding:14px;border-radius:var(--radius-md);width:100%;margin-top:8px;box-shadow:var(--shadow-soft)}
.hidden{display:none!important}
.text-center{text-align:center}.text-muted{color:var(--text-muted)}
.divider{height:1px;background:var(--border-color);margin:16px 0}
.empty-state{text-align:center;padding:40px 20px}.empty-icon{font-size:3.5rem;margin-bottom:12px}.empty-text{color:var(--text-secondary);font-size:.9rem;line-height:1.5}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);color:var(--text-primary);padding:10px 20px;border-radius:var(--radius-lg);font-size:.82rem;z-index:9999;border:1px solid var(--border-color);box-shadow:var(--shadow-soft);white-space:nowrap;max-width:90%}
/* OVERLAY */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:200;overflow-y:auto;padding:0}
.overlay.active{display:block}.overlay-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border-color);position:sticky;top:0;background:var(--bg-primary);z-index:10}
.overlay-title{font-weight:700;font-size:1.05rem}.overlay-close{background:none;border:none;color:var(--text-primary);font-size:1.4rem;cursor:pointer;padding:4px 8px}
.overlay-body{padding:16px 20px 80px}
/* WIZARD */
.wizard-step{display:none}.wizard-step.active{display:block}
.step-pills{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
.step-pill{width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);color:var(--text-muted);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;border:2px solid var(--border-color)}
.step-pill.current{border-color:var(--accent-red);color:var(--accent-red)}.step-pill.done{background:var(--accent-green);color:#000;border-color:var(--accent-green)}
.scan-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;border:2px solid transparent;cursor:pointer;transition:all var(--tr-fast)}
.scan-item.selected{border-color:var(--accent-green);background:rgba(46,204,113,.08)}
.scan-item-name{font-weight:600;font-size:.85rem}.scan-item-id{font-size:.65rem;color:var(--text-muted);font-family:var(--font-mono)}
.tag-score{font-size:.65rem;color:var(--accent-blue);margin-top:2px}
.scan-item-right{text-align:right}.scan-rssi{font-size:.85rem;font-weight:600;font-family:var(--font-mono)}
.rssi-bar-track{width:60px;height:4px;background:var(--bg-primary);border-radius:2px;margin-top:4px}
.rssi-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.icon-picker{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
.icon-opt{width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border-radius:var(--radius-sm);background:var(--bg-elevated);border:2px solid transparent;cursor:pointer}
.icon-opt.selected{border-color:var(--accent-green);background:rgba(46,204,113,.1)}
/* SOS */
.sos-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;flex-direction:column;align-items:center;justify-content:center;background:#000}
.sos-active.active{display:flex}
.sos-active-text{font-size:2rem;font-weight:900;color:#fff;text-align:center;padding:20px;letter-spacing:2px}
.hc-display{text-align:center;padding:20px;background:var(--bg-card);border-radius:var(--radius-md);margin:10px 0}
.hc-arrow{font-size:3rem;display:block;margin-bottom:8px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color)}
.toggle{width:44px;height:24px;border-radius:12px;background:var(--bg-elevated);border:1px solid var(--border-color);position:relative;cursor:pointer;transition:all var(--tr-fast);flex-shrink:0}
.toggle::after{content:'';width:20px;height:20px;border-radius:50%;background:var(--text-muted);position:absolute;top:1px;left:1px;transition:all var(--tr-fast)}
.toggle.on{background:var(--accent-green);border-color:var(--accent-green)}.toggle.on::after{left:22px;background:#fff}
/* TIP CARDS */
.tip-card{padding:14px;border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--accent-blue);background:var(--bg-card)}
.tip-card.warn{border-left-color:var(--accent-orange)}.tip-card.danger{border-left-color:var(--zone-danger)}
.tip-card.info{border-left-color:var(--accent-blue)}
.tip-title{font-weight:700;font-size:.85rem;margin-bottom:4px}.tip-body{font-size:.78rem;color:var(--text-secondary);line-height:1.5}
/* PET DETAIL OVERLAY */
.detail-ring{width:160px;height:160px;border-radius:50%;border:6px solid var(--zone-safe);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:20px auto;transition:all .5s;position:relative}
.detail-ring.zone-safe{border-color:var(--zone-safe);box-shadow:0 0 30px rgba(46,204,113,.2)}.detail-ring.zone-caution{border-color:var(--zone-caution);box-shadow:0 0 30px rgba(241,196,15,.3)}.detail-ring.zone-warning{border-color:var(--zone-warning);box-shadow:0 0 30px rgba(230,126,34,.3)}.detail-ring.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 40px rgba(231,76,60,.4);animation:pulseDanger 1.2s ease infinite}.detail-ring.zone-lost{border-color:var(--zone-lost);box-shadow:0 0 30px rgba(155,89,182,.3)}
.detail-dist{font-size:2rem;font-weight:900;line-height:1}.detail-unit{font-size:.7rem;color:var(--text-muted)}.detail-zone{font-size:.75rem;font-weight:700;margin-top:4px}
.rssi-meter{height:8px;background:var(--bg-elevated);border-radius:4px;margin:8px 0;overflow:hidden}.rssi-meter-fill{height:100%;border-radius:4px;transition:width .4s,background .4s}
.signal-bars{display:flex;gap:3px;align-items:flex-end;justify-content:center;height:20px;margin:8px 0}
.signal-bars .bar{width:6px;border-radius:2px;background:var(--text-muted);transition:background .3s}
.alert-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:.75rem;border-bottom:1px solid rgba(48,54,61,.5)}
.alert-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:6px}
/* LEASH PRESETS */
.leash-row{display:flex;gap:6px;margin:8px 0}.leash-btn{flex:1;padding:8px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);cursor:pointer;font-size:.75rem;font-weight:600;transition:all var(--tr-fast)}
.leash-btn.active{border-color:var(--accent-green);color:var(--accent-green);background:rgba(46,204,113,.08)}
.slider-row{display:flex;align-items:center;gap:8px;margin:6px 0}
.slider-row label{font-size:.72rem;color:var(--text-secondary);min-width:55px}
.slider-row input[type=range]{flex:1;accent-color:var(--accent-blue)}
.slider-row .val{font-size:.72rem;color:var(--accent-blue);min-width:50px;text-align:right;font-family:var(--font-mono)}
/* CHARITY */
.charity-box{background:linear-gradient(135deg,rgba(46,204,113,.08),rgba(52,152,219,.08));border:1px solid rgba(46,204,113,.25);border-radius:var(--radius-md);padding:14px;margin:10px 0;text-align:center}
.charity-box p{font-size:.8rem;margin:4px 0}
.highlight-box{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:14px;margin:10px 0}
.highlight-box p{font-size:.8rem;margin:4px 0;line-height:1.5;color:var(--text-secondary)}
.warning-legal{background:rgba(231,76,60,.06);border:1px solid rgba(231,76,60,.2);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.warning-legal p{font-size:.78rem;margin:3px 0;color:var(--text-secondary)}
.perf-select{display:flex;gap:4px;margin:8px 0}.perf-opt{flex:1;padding:8px 4px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-muted);cursor:pointer;font-size:.68rem;font-weight:600}
.perf-opt.active{border-color:var(--accent-blue);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.rescue-card{background:linear-gradient(135deg,rgba(192,57,43,.08),rgba(231,76,60,.05));border:2px solid rgba(192,57,43,.3);border-radius:var(--radius-md);padding:16px;margin:10px 0;text-align:center}
.rescue-id{font-size:1.6rem;font-weight:900;font-family:var(--font-mono);letter-spacing:4px;color:var(--accent-red);margin:8px 0}
.collapsible-header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;cursor:pointer;border-bottom:1px solid var(--border-color)}
.collapsible-header .arrow{transition:transform .2s}.collapsible-header.open .arrow{transform:rotate(90deg)}
.collapsible-body{display:none;padding:12px 0}.collapsible-body.open{display:block}


/* ============================================================
   V4.1 UI & FEATURE ADDITIONS
   (Merged from V20 feature set + V35 engine hardening + V38 layout ideas)
   ============================================================ */
.header-links{margin-top:6px;font-size:.62rem;color:var(--text-muted);display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.header-link{color:var(--accent-blue);text-decoration:none;border-bottom:1px dotted rgba(52,152,219,.45);padding-bottom:1px}
.header-link:active{opacity:.7}
.header-link-sep{opacity:.45}
.lang-select{background:var(--bg-elevated);border:1px solid var(--border-color);color:var(--text-primary);border-radius:10px;padding:6px 10px;font-size:.78rem;min-height:32px;cursor:pointer}
.lang-select:focus{outline:2px solid rgba(52,152,219,.35);outline-offset:2px}

.lang-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.lang-grid .btn{width:100%;justify-content:center}
@media (max-width:360px){.lang-grid{grid-template-columns:1fr}}


.install-banner{display:none;background:rgba(52,152,219,.12);border-bottom:1px solid rgba(52,152,219,.25);padding:10px 14px;font-size:.72rem}
.install-banner.active{display:flex;align-items:center;justify-content:space-between;gap:10px}
.install-banner .btn{padding:6px 10px;font-size:.7rem}

.file-warning{background:rgba(241,196,15,.08);border:1px solid rgba(241,196,15,.25);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.file-warning .title{font-weight:800;font-size:.78rem;color:var(--accent-yellow);margin-bottom:6px}
.file-warning .body{font-size:.72rem;color:var(--text-secondary);line-height:1.5}
.file-warning .actions{display:flex;gap:8px;margin-top:10px}

.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:.6rem;font-weight:800;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary)}
.badge.ok{border-color:rgba(46,204,113,.35);color:var(--accent-green)}
.badge.med{border-color:rgba(241,196,15,.35);color:var(--accent-yellow)}
.badge.high{border-color:rgba(231,76,60,.35);color:var(--zone-danger)}

.scan-health-row{display:flex;align-items:center;gap:8px;margin:8px 0}
.scan-health-label{font-size:.65rem;color:var(--text-muted);min-width:74px}
.scan-health-bar{flex:1;height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;border:1px solid rgba(48,54,61,.85)}
.scan-health-fill{height:100%;width:0%;background:var(--accent-green);transition:width .35s,background .35s}
.scan-health-meta{font-size:.62rem;color:var(--text-muted);min-width:86px;text-align:right;font-family:var(--font-mono)}

.pet-chips{display:flex;gap:6px;overflow-x:auto;padding:6px 2px 10px;margin-bottom:4px}
.pet-chip{flex:0 0 auto;padding:6px 10px;border-radius:999px;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap}
.pet-chip.active{border-color:rgba(52,152,219,.6);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.pet-chip:active{transform:scale(.98)}

.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:10px 0}
.qr-canvas{width:180px;height:180px;border-radius:12px;border:1px solid rgba(48,54,61,.8);background:#fff}

.voice-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.voice-row .btn{flex:1}
.slider-mini{width:100%;accent-color:var(--accent-blue)}

.emergency-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:400;background:#000;color:#fff;align-items:center;justify-content:center;flex-direction:column;padding:20px;text-align:center}
.emergency-active.active{display:flex}
.strobe-on{background:#fff!important;color:#000!important}
.emergency-big{font-size:2.1rem;font-weight:900;letter-spacing:1px}
.emergency-sub{font-size:.85rem;color:rgba(255,255,255,.85);line-height:1.4;margin-top:10px;max-width:520px}
.kbd{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-elevated);font-family:var(--font-mono);font-size:.68rem;color:var(--text-secondary)}

/* ----------------------------- v4.1.7 UI polish (CSS only) ----------------------------- */
@keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
#i18n_hero_pillars { animation: fadeInUp 0.6s ease-out; }
.highlight-box { border-left: 4px solid var(--accent, #1e88e5); }
#i18n_hero_pillars p { line-height: 1.6; font-size: 15px; }

</style>
</head>
<body>

<div id="app">
  <!-- INSTALL BANNER (APP INSTALL) -->
  <div id="installBanner" class="install-banner">
    <div>
      <strong id="i18n_install_title">Install VitalGuard AI</strong><br>
      <span id="i18n_install_sub" style="color:var(--text-secondary)">Works better as an installed app ‚Äî faster launch, more reliable Bluetooth behavior.</span>
    </div>
    <div style="display:flex;gap:6px;flex-shrink:0">
      <button class="btn btn-sm btn-secondary" id="installDismiss">Not now</button>
      <button class="btn btn-sm btn-primary" id="installBtn">Install</button>
    </div>
  </div>

  <header class="header">
    <div class="header-logo">üõ°Ô∏è</div>
    <div class="header-title" id="i18n_app_title">VitalGuard AI</div>
    <div class="header-sub" id="i18n_app_sub">v4.1.7 ‚Äî Infrastructure‚ÄëIndependent Survival Framework | McorpAI</div>
    <div class="header-mission" id="i18n_app_mission">Runs fully offline. No cloud. No telemetry. GDPR‚Äëfriendly by design.</div>
    <div class="header-disclaimer" id="i18n_app_disclaimer">Demo skin: ‚ÄúPet Safety Leash‚Äù using Bluetooth proximity (not GPS). Built to keep working when networks fail.</div>
    <div class="header-links">
      <a class="header-link" href="https://github.com/henrymorgan10/mcorpai-org" target="_blank" rel="noopener" id="i18n_github_link">GitHub Source</a>
      <span class="header-link-sep">¬∑</span>
      <a class="header-link" href="#" onclick="Help.open();return false;" id="i18n_help_link">Help</a>
      <span class="header-link-sep">¬∑</span>
      <a class="header-link" href="#" onclick="Legal.open();return false;" id="i18n_about_link">About</a>
      <span class="header-link-sep">¬∑</span>
      <a class="header-link" href="#" onclick="Lang.open();return false;" id="i18n_lang_link">Language</a>
      <span class="header-link-sep">¬∑</span>
      <select id="langSelect" class="lang-select" aria-label="Language" title="Language" onchange="try{I18N.setLang(this.value);}catch(e){}" oninput="try{I18N.setLang(this.value);}catch(e){}">
        <option value="en">English</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="fr">Fran√ßais</option>
        <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá(Âè∞ÁÅ£)</option>
        <option value="es">Espa√±ol</option>
      </select>
    </div>
  </header>

  <!-- HOME -->
  <div id="panel-home" class="panel active">
    <div id="first-run-banner" class="file-warning hidden">
      <div class="title" id="i18n_firstrun_title">‚ö† Important: Run via HTTPS / localhost for best BLE reliability</div>
      <div class="body" id="i18n_firstrun_body">
        You are running from <span class="kbd" id="fr-proto">file://</span>. Some browsers restrict Bluetooth scanning, audio, and background behavior on local files.<br>
        <br>
        Recommended:
        <ul style="margin:8px 0 0 16px;line-height:1.5">
          <li>Use <span class="kbd">https://</span> hosting, or</li>
          <li>Use <span class="kbd">http://localhost</span> (local server), or</li>
          <li>Install as an App when available.</li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn btn-secondary btn-sm" id="i18n_firstrun_ok" onclick="App.dismissFirstRun()">Got it</button>
        <button class="btn btn-sm btn-secondary" id="i18n_firstrun_help" onclick="Help.open()">Open Help</button>
      </div>
    </div>


    <div id="vgHero" class="card" style="margin-top:12px">
      <div class="section-title" id="i18n_hero_title">üõ°Ô∏è Infrastructure‚ÄëIndependent Survival Framework</div>
      <div id="i18n_hero_body" style="font-size:.82rem;color:var(--text-secondary);line-height:1.6">
        VitalGuard AI v4.1.7 is a single‚Äëfile, offline‚Äëfirst continuity toolkit combining Bluetooth beacon proximity and lightweight on‚Äëdevice logic‚Äîdesigned to operate during outages and off‚Äëgrid deployments, with data kept on‚Äëdevice by default (no cloud retention unless you export).
      </div>
      <div class="small" id="i18n_contact_line" style="margin-top:10px;opacity:.85;text-align:center">Contact: contact@mcorpai.org ‚Ä¢ mcorpai.org </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px">
        <span class="badge ok" id="i18n_badge_offline">100% Offline</span>
        <span class="badge ok" id="i18n_badge_gdpr">GDPR‚Äëfriendly</span>
        <span class="badge med" id="i18n_badge_ble">BLE Proximity + Assist</span>
        <span class="badge med" id="i18n_badge_tiny">Single‚Äëfile (~0 KB)</span>
      </div>

      <div class="highlight-box" id="i18n_hero_pillars" style="margin-top:12px">
        <p><strong>Infrastructure‚ÄëIndependent Survival Framework</strong> ‚Äî designed for continuity during outages and off‚Äëgrid deployments.</p>
        <p>üîç <strong>Extreme S&amp;R (Avalanche/Landslide)</strong>: Bluetooth beacon proximity to guide a radar‚Äëlike life‚Äëlocator workflow when responders are off‚Äëgrid.</p>
        <p>‚ôªÔ∏è <strong>Upcycling E‚ÄëWaste (ESG &amp; SDGs)</strong>: repurpose retired smartphones into offline relief nodes.</p>
        <p>üêÑ <strong>Off‚ÄëGrid Agriculture &amp; Asset Protection</strong>: practical patterns for livestock and asset safety where coverage is unavailable.</p>
        <p>üåç <strong>Arabic &amp; Global Ready</strong>: built‚Äëin multilingual UI (7 languages) including Arabic (RTL).</p>
      </div>
    </div>
<div id="empty-state" class="empty-state">
      <div class="empty-icon">üõ°Ô∏è</div>
      <div class="empty-text" id="i18n_empty_text">No demo tags registered yet.<br>Add a cheap BLE key‚Äëfinder tag to run the offline proximity demo.</div>
      <button class="btn-add" onclick="Wizard.open()" id="i18n_empty_btn">+ Add Demo Tag</button>
    </div>

    <div id="dash-controls" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="section-title" style="margin-bottom:0">üêæ My Pets</div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm btn-secondary" id="btn-mode-all" onclick="App.setTrackMode('all')" style="font-size:.65rem">Track All</button>
          <button class="btn btn-sm btn-secondary" id="btn-mode-focus" onclick="App.setTrackMode('focus')" style="font-size:.65rem">Focus</button>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div id="scan-status-bar" style="font-size:.68rem;color:var(--text-muted);flex:1;min-width:0"></div>
        <span id="congestionBadge" class="badge ok">LOW</span>
      </div>

      <div id="scan-health-row" class="scan-health-row hidden">
        <div class="scan-health-label">Scan health</div>
        <div class="scan-health-bar"><div id="scan-health-fill" class="scan-health-fill"></div></div>
        <div id="scan-health-meta" class="scan-health-meta">--</div>
      </div>

      <div class="pet-chips hidden" id="pet-chips"></div>

      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" id="btn-scan-toggle" style="flex:1" onclick="App.toggleMonitoring()">‚ñ∂ Start Monitoring</button>
          <button class="btn btn-secondary" id="btn-demo-toggle" style="flex:1" onclick="App.toggleDemo()">üß™ Demo</button>
        </div>
        <div style="margin-top:10px;font-size:.7rem;color:var(--text-muted);line-height:1.5">
          Tip: Monitoring works best when the screen stays on. In emergencies, use SOS Finder or Emergency Mode.
        </div>
      </div>

      <div id="coach-card" class="card" style="display:none">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üß† Safety Coach</div>
        <div id="coach-body" style="font-size:.78rem;color:var(--text-secondary);line-height:1.55"></div>
      </div>
    </div>

    <div id="pet-list"></div>

    <div id="dash-controls2" class="hidden">
      <button class="btn-add" onclick="Wizard.open()">+ Add New Pet</button>
    </div>
  </div>

  <!-- SOS -->
  <div id="panel-sos" class="panel">
    <div id="sos-no-pets" class="text-center" style="padding:40px 0;color:var(--text-muted)">Add a pet first to use SOS Finder.</div>
    <div id="sos-content" class="hidden">
      <div class="section-title">üîç SOS Pet Finder</div>
      <div id="sos-pet-select"></div>

      <div class="hc-display">
        <div id="hc-arrow" class="hc-arrow">üîç</div>
        <div id="hc-text" style="font-size:.9rem;font-weight:600;margin-bottom:4px">Select a pet to begin</div>
        <div id="hc-rssi" style="font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">--</div>
      </div>

      <div id="sos-snapshot" class="card" style="font-size:.8rem;line-height:1.6"></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.saveLocation()">üìç Save Location</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.shareMessage()">üì§ Share Alert</button>
      </div>

      <div class="card" style="margin-top:12px;text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds for full pet alarm</div>
        <button class="btn btn-primary" style="font-size:1.1rem;padding:16px 30px;border-radius:50px"
          ontouchstart="SOS.holdStart()" ontouchend="SOS.holdEnd()"
          onmousedown="SOS.holdStart()" onmouseup="SOS.holdEnd()"
        >üö® SOS ALARM</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üõ° Personal Emergency Mode</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          For personal safety (siren + strobe + QR contact card). Works even without internet.
        </div>
        <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Open Emergency Mode</button>
      </div>

      <div id="sos-focus-banner" class="hidden" style="margin-top:10px;padding:10px;background:rgba(52,152,219,.1);border:1px solid rgba(52,152,219,.3);border-radius:var(--radius-sm);font-size:.72rem;color:var(--accent-blue);text-align:center">
        üéØ Focus Mode ON ‚Äî tracking only selected pet for best accuracy
      </div>
    </div>
  </div>

  <!-- TIPS -->
  <div id="panel-tips" class="panel">
    <div class="section-title" id="i18n_tips_title">üìã Demo Guide & Field Notes</div>
    <div id="tipsI18n"></div>
  </div>

  <!-- SETTINGS -->
<div id="panel-settings" class="panel">
    <div class="section-title">‚öôÔ∏è Settings</div>

    <div class="card">
      <div class="setting-row"><span style="font-size:.82rem">üîä Sound</span><div class="toggle" id="toggle-sound" onclick="Settings.toggle('sound')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">üì≥ Vibration</span><div class="toggle" id="toggle-vibrate" onclick="Settings.toggle('vibrate')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">üîî Notifications</span><div class="toggle" id="toggle-notif" onclick="Settings.toggleNotif()"></div></div>
      <div id="notif-hint" class="hidden" style="font-size:.72rem;color:var(--accent-orange);margin-top:8px">Enable notifications in browser settings if denied.</div>
      <div class="setting-row"><span style="font-size:.82rem">‚ö° High Alert Mode</span><div class="toggle" id="toggle-highalert" onclick="Settings.toggle('highAlert')"></div></div>

      <div style="margin-top:12px">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Performance</div>
        <div class="perf-select">
          <div class="perf-opt" id="perf-saver" onclick="Settings.setPerf('saver')">Saver</div>
          <div class="perf-opt active" id="perf-balanced" onclick="Settings.setPerf('balanced')">Balanced</div>
          <div class="perf-opt" id="perf-fast" onclick="Settings.setPerf('fast')">Fast</div>
        </div>
        <div style="font-size:.68rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
          Saver reduces battery use. Fast increases responsiveness (may use more CPU/battery).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üéô Voice & Audio Tools</div>

      <div class="setting-row">
        <span style="font-size:.82rem">üß† Voice Recall (play your voice on CAUTION)</span>
        <div class="toggle" id="toggle-voiceRecall" onclick="Settings.toggle('voiceRecall')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Example: Record ‚ÄúCome here!‚Äù and it will play when your pet enters CAUTION zone (best effort).
      </div>
      <div class="voice-row">
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">üéô Record 5s</button>
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">‚ñ∂ Play</button>
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">üó£ Voice Announcer (TTS)</span>
        <div class="toggle" id="toggle-tts" onclick="Settings.toggle('tts')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Speaks zone changes (requires device voices). If blocked, use sound/vibration instead.
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">üéß Audio Keepalive (prevents suspension)</span>
        <div class="toggle" id="toggle-keepAlive" onclick="Settings.toggle('keepAlive')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Uses a near-silent audio signal to keep monitoring alive on some devices. May slightly increase battery usage.
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:.78rem;color:var(--text-secondary)">Master volume</span>
          <span id="volumeVal" style="font-size:.72rem;color:var(--text-muted);font-family:var(--font-mono)">70%</span>
        </div>
        <input id="volumeSlider" class="slider-mini" type="range" min="0" max="100" value="70" oninput="Settings.setVolume(this.value)">
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üõ° Emergency Mode</div>
      <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
        Personal siren + strobe + QR contact card. Configure once, then activate quickly when needed.
      </div>
      <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Configure / Activate</button>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üêæ Registered Pets</div>
      <div id="settings-pet-list"></div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üíæ Backup & Data</div>
      <button class="btn btn-secondary btn-block" onclick="DataManager.exportAll()">‚¨áÔ∏è Export Backup (JSON)</button>
      <input type="file" id="import-input" accept="application/json" style="display:none" onchange="DataManager.handleImport(event)">
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="DataManager.importFile()">‚¨ÜÔ∏è Import Backup</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Diag.open()">üß™ Diagnostics</button>
      <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="Settings.resetApp()">üóëÔ∏è RESET ALL DATA</button>
      <div style="font-size:.7rem;color:var(--text-muted);margin-top:10px;line-height:1.45">
        Backups stay on your device. No cloud. No tracking. You can delete everything anytime.
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üìö Guides</div>
      <button class="btn btn-secondary btn-block" onclick="Help.open()">Open Help</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Legal.open()">About & Legal</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bnav-btn active" data-tab="home" onclick="Nav.go('home')"><span class="bnav-icon">üè†</span><span>Home</span></button>
    <button class="bnav-btn" data-tab="sos" onclick="Nav.go('sos')"><span class="bnav-icon">üö®</span><span>SOS</span></button>
    <button class="bnav-btn" data-tab="tips" onclick="Nav.go('tips')"><span class="bnav-icon">üìã</span><span>Tips</span></button>
    <button class="bnav-btn" data-tab="settings" onclick="Nav.go('settings')"><span class="bnav-icon">‚öôÔ∏è</span><span>Settings</span></button>
  </nav>

  <!-- WIZARD OVERLAY -->
  <div id="wizard-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="wizard-title">Add Demo Tag Wizard</div>
      <button class="overlay-close" onclick="Wizard.close()">‚úï</button>
    </div>
    <div class="overlay-body">
      <div class="step-pills">
        <div class="step-pill current" id="sp-1">1</div>
        <div class="step-pill" id="sp-2">2</div>
        <div class="step-pill" id="sp-3">3</div>
      </div>

      <!-- STEP 1 -->
      <div class="wizard-step active" id="wiz-step-1">
        <div class="tip-card info">
          <div class="tip-title">Step 1 ‚Äî Scan nearby BLE tags</div>
          <div class="tip-body">Hold the tag <strong>2‚Äì5 cm</strong> from your phone for 10 seconds. Pick the strongest signal.</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div id="scan-status" style="font-size:.75rem;color:var(--text-muted)">Starting scan...</div>
          <button class="btn btn-sm btn-secondary" onclick="Wizard.rescan()">üîÑ Rescan</button>
        </div>
        <div id="scan-list" style="margin-top:10px"></div>
      </div>

      <!-- STEP 2 -->
      <div class="wizard-step" id="wiz-step-2">
        <div class="tip-card info">
          <div class="tip-title">Step 2 ‚Äî Verify (reduce false matches)</div>
          <div class="tip-body">Move the tag <strong>2‚Äì3 meters</strong> away. We confirm a noticeable signal drop.</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:.72rem;color:var(--text-muted)">Signal drop</div>
          <div id="verify-delta" style="font-size:2rem;font-weight:900;margin:6px 0">0</div>
          <div id="verify-status" style="font-size:.8rem;color:var(--text-muted)">Waiting for movement...</div>
          <button class="btn btn-success btn-block hidden" id="btn-verified" style="margin-top:12px" onclick="Wizard.goStep3()">‚úÖ Verified</button>
          <button class="btn btn-secondary btn-block" id="btn-skip-verify" style="margin-top:12px" onclick="Wizard.skipVerify()">Skip</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üìè Optional: Distance Calibration</div>
          <div style="font-size:.75rem;color:var(--text-secondary);line-height:1.5">
            For better distance estimates (still approximate): record RSSI at known distances.
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(1)">Record 1m</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(10)">Record 10m</button>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:.72rem;color:var(--text-muted)">
            <span>1m: <span id="calib-1m">--</span></span>
            <span>10m: <span id="calib-10m">--</span></span>
          </div>
          <button class="btn btn-sm btn-secondary" style="margin-top:10px;width:100%" onclick="Wizard.clearCalib()">Clear calibration</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="wizard-step" id="wiz-step-3">
        <div class="tip-card info">
          <div class="tip-title">Step 3 ‚Äî Name your pet</div>
          <div class="tip-body">Choose an icon and a name. You can change it later.</div>
        </div>

        <div style="margin-top:12px">
          <div class="icon-picker" id="icon-picker"></div>

          <div style="margin-top:10px">
            <label style="font-size:.72rem;color:var(--text-secondary)">Pet Name</label>
            <input id="input-name" type="text" placeholder="My Pet" style="width:100%;margin-top:6px;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
          </div>

          <button class="btn btn-primary btn-block" id="btn-wiz-save" style="margin-top:14px" onclick="Wizard.save()">‚úÖ Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAIL OVERLAY -->
  <div id="detail-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="detail-title">Pet</div>
      <button class="overlay-close" onclick="Detail.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="detail-body"></div>
  </div>

  <!-- HELP OVERLAY -->
  <div id="help-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="i18n_help_title">Help</div>
      <button class="overlay-close" onclick="Help.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="help-body"></div>
  </div>

  <!-- LEGAL OVERLAY -->
  <div id="legal-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="i18n_legal_title">About</div>
      <button class="overlay-close" onclick="Legal.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="legal-body"></div>
  </div>

  <!-- LANGUAGE OVERLAY -->
  <div id="lang-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="i18n_lang_title">Language</div>
      <button class="overlay-close" onclick="Lang.close()">‚úï</button>
    </div>
    <div class="overlay-body">
      <div class="card" style="margin-top:0">
        <div class="section-title" id="i18n_lang_subtitle">Choose your UI language</div>
        <div class="small" id="i18n_lang_note" style="margin-top:6px;line-height:1.5">
          This changes UI text only. Bluetooth behavior and offline processing remain the same.
        </div>
        <div class="lang-grid" style="margin-top:12px">
          <button class="btn btn-secondary" data-lang="en" onclick="Lang.choose('en')">English</button>
          <button class="btn btn-secondary" data-lang="ko" onclick="Lang.choose('ko')">ÌïúÍµ≠Ïñ¥</button>
          <button class="btn btn-secondary" data-lang="ar" onclick="Lang.choose('ar')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
          <button class="btn btn-secondary" data-lang="ja" onclick="Lang.choose('ja')">Êó•Êú¨Ë™û</button>
          <button class="btn btn-secondary" data-lang="fr" onclick="Lang.choose('fr')">Fran√ßais</button>
          <button class="btn btn-secondary" data-lang="zh-TW" onclick="Lang.choose('zh-TW')">ÁπÅÈ´î‰∏≠Êñá(Âè∞ÁÅ£)</button>
          <button class="btn btn-secondary" data-lang="es" onclick="Lang.choose('es')">Espa√±ol</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DIAGNOSTICS OVERLAY -->
  <div id="diag-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Diagnostics</div>
      <button class="overlay-close" onclick="Diag.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="diag-body"></div>
  </div>

  <!-- EMERGENCY OVERLAY -->
  <div id="emg-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Emergency Mode</div>
      <button class="overlay-close" onclick="Emergency.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="emg-body"></div>
  </div>

  <!-- SOS ACTIVE SCREEN -->
  <div id="sos-active" class="sos-active" onclick="SOS.deactivate()">
    <div id="sos-strobe-area" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.2"></div>
    <div class="sos-active-text">üö® SOS<br><span id="sos-active-name">PET</span></div>
    <div style="font-size:.75rem;color:#fff;opacity:.8">Tap screen to stop</div>
  </div>

  <!-- EMERGENCY ACTIVE SCREEN -->
  <div id="emergency-active" class="emergency-active">
    <div id="emg-strobe" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.25"></div>
    <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center">
      <div class="emergency-big">üõ° EMERGENCY</div>
      <div id="emg-active-name" style="margin-top:8px;font-size:1.05rem;font-weight:800"></div>
      <div id="emg-active-sub" class="emergency-sub"></div>
      <div class="qr-wrap">
        <canvas id="emg-qr" class="qr-canvas" width="180" height="180"></canvas>
        <div style="font-size:.72rem;color:rgba(255,255,255,.85)">Scan for contact info</div>
      </div>
      <div style="display:flex;gap:10px;width:100%;max-width:360px;margin-top:12px">
        <a id="emg-call" class="btn btn-primary" style="flex:1;text-decoration:none;text-align:center" href="#">üìû Call</a>
        <button class="btn btn-secondary" style="flex:1" onclick="Emergency.share()">üì§ Share</button>
      </div>
      <button class="btn btn-danger-outline" style="margin-top:14px" onclick="Emergency.deactivate()">Stop Siren</button>
      <div style="margin-top:10px;font-size:.7rem;color:rgba(255,255,255,.75)">Tip: If Shake SOS is enabled, shaking your phone will activate Emergency.</div>
    </div>
  </div>

</div>

<script>

/* ============================================================
   VitalGuard AI v4.1.7
   - Merged: V20 feature richness + V35 engine hardening + V38 UI ideas
   - Vanilla HTML/CSS/JS, single-file, offline-first.
   - Ethical AI License: Hippocratic 3.0 Derivative (Humanitarian use only)
   ============================================================ */

'use strict';

/* ----------------------------- CONFIG ----------------------------- */
const APP_VERSION = '4.1.7';
const SCHEMA_VERSION = 2;

// Backward compatibility (do not change)
const DB_NAME = 'VitalGuardAI_V41';
const DB_VERSION = 2; // v3.9+ adds optional blob store
const LS_PREFIX = 'vg41_';

const MAX_RSSI_SAMPLES = 60;
const ZONE_CONFIRM_COUNT = 4; // v4.1: more stable zone transitions
const ZONE_CONFIRM_MS = 2000; // v4.1: more stable zone transitions
const ALERT_COOLDOWN_MS = 20000;
const MAX_RESTARTS_PER_MIN = 3;

// High Alert tightens RSSI boundaries by +10 dBm (stronger signal required)
const HIGH_ALERT_SHRINK = 10;

// Collision gap from V35 (0.08)
const GAP_MIN = 0.08;
const MATCH_THRESHOLD_CONFIRMED = 0.40;
const MATCH_THRESHOLD_UNCONFIRMED = 0.55;

// Icons
const ICONS = ['üê∂','üê±','üê∞','ü¶ä','üêª','üêº','üêπ','üêØ','üêµ','üê∏','ü¶Æ','üêï','üê©','üêà','üêæ','ü¶ú','üê¶','üê¢','üê†','ü¶é'];

// Leash presets
const DEFAULT_THRESHOLDS = {
  cautionEnter:-65, cautionExit:-60,
  warningEnter:-78, warningExit:-72,
  dangerEnter:-88, dangerExit:-82
};

const LEASH_PRESETS = {
  '5m':  {cautionEnter:-58,cautionExit:-53,warningEnter:-68,warningExit:-63,dangerEnter:-78,dangerExit:-73},
  '10m': {cautionEnter:-65,cautionExit:-60,warningEnter:-78,warningExit:-72,dangerEnter:-88,dangerExit:-82},
  '15m': {cautionEnter:-72,cautionExit:-67,warningEnter:-85,warningExit:-79,dangerEnter:-94,dangerExit:-88}
};

const PERF_PROFILES = {
  saver:    {petInterval:1200, renderInterval:800,  lostMs:12000, restartMs:18000, restartCooldown:22000, scanStallMs:12000, globalThrottleMs:140},
  balanced: {petInterval:800,  renderInterval:450,  lostMs:9000,  restartMs:14000, restartCooldown:15000, scanStallMs:9000,  globalThrottleMs:80},
  fast:     {petInterval:500,  renderInterval:300,  lostMs:7000,  restartMs:10000, restartCooldown:9000,  scanStallMs:6500,  globalThrottleMs:60}
};

const ZONE_ORDER = {SAFE:0, CAUTION:1, WARNING:2, DANGER:3, LOST:4};

/* ----------------------------- UTILS ----------------------------- */
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function median(arr) {
  if(!arr || !arr.length) return 0;
  const s=[...arr].sort((a,b)=>a-b);
  const m=Math.floor(s.length/2);
  return s.length%2?s[m]:(s[m-1]+s[m])/2;
}
function genRescueId() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r='';
  for(let i=0;i<8;i++) r+=c[Math.floor(Math.random()*c.length)];
  return r;
}
function fmtAgo(ms) {
  if(!ms) return '--';
  const s=Math.max(0, Math.round(ms/100)/10); // 0.1s precision
  if(s<1) return s.toFixed(1)+'s';
  if(s<60) return Math.round(s)+'s';
  const m=Math.floor(s/60);
  return m+'m';
}
function safeJson(obj) {
  try { return JSON.stringify(obj, null, 2); } catch(e){ return '{"error":"json_failed"}'; }
}
function nowMs(){ return Date.now(); }

/* ----------------------------- ETHICAL MANIFEST ----------------------------- */
const ETHICAL_MANIFEST = {
  version: APP_VERSION,
  license: 'Hippocratic 3.0 Derivative',
  purpose: 'Life‚Äësaving offline AI demo (no cloud, no telemetry)',
  prohibited: ['weaponization','coercive_tracking','data_exploitation','oppression','border_enforcement'],
  principles: ['minimize_hallucinations','transparency','accessibility','no_data_exploitation','low_resource','no_liability','affordable','simplicity','non_specialist','allow_deletion']
};

/* ----------------------------- STATE ----------------------------- */
let perfProfile = PERF_PROFILES.balanced;
let globalLastProcessMs = 0;

/* ----------------------------- TOAST ----------------------------- */
const Toast = {
  show(msg, dur=2500) {
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=msg;
    document.body.appendChild(el);
    setTimeout(()=>{
      el.style.opacity='0';
      el.style.transition='0.3s';
      setTimeout(()=>el.remove(),300);
    }, dur);
  }
};


/* ----------------------------- I18N (7 Languages) ----------------------------- */
/*
  VitalGuard AI is intended to be shown to non-technical audiences (diplomats, NGOs, universities, companies).
  This tiny i18n layer keeps everything in a single offline HTML file (no libraries, no network).
*/
const I18N = (function(){
  const STORAGE_KEY = 'vg_lang_v41';
  const LEGACY_KEY = 'vg_lang_v412';
  const RTL_LANGS = new Set(['ar']);

  const STR = {
    en: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî Infrastructure‚ÄëIndependent Survival Framework | McorpAI',
      app_mission: 'Runs fully offline. No cloud. No telemetry. GDPR‚Äëfriendly by design.',
      app_disclaimer: 'Demo skin: ‚ÄúPet Safety Leash‚Äù using Bluetooth proximity (not GPS). Built to keep working when networks fail.',
      github: 'GitHub Source',
      help: 'Help',
      about: 'About',
      help_title: 'Help',
      legal_title: 'About',
      tips_title: 'üìã Demo Guide & Field Notes',
      install_title: 'Install VitalGuard AI',
      empty_text: 'No demo tags registered yet.<br>Add a cheap BLE key‚Äëfinder tag to run the offline proximity demo.',
      empty_btn: '+ Add Demo Tag',
      hero_title: 'üõ°Ô∏è Infrastructure‚ÄëIndependent Survival Framework',
      hero_body: 'VitalGuard AI v4.1.7 is a single‚Äëfile, offline‚Äëfirst continuity toolkit combining Bluetooth beacon proximity and lightweight on‚Äëdevice logic‚Äîdesigned to operate during outages and off‚Äëgrid deployments, with data kept on‚Äëdevice by default (no cloud retention unless you export).',
      hero_pillars_html: '<p><strong>Infrastructure‚ÄëIndependent Survival Framework</strong> ‚Äî designed for continuity during outages and off‚Äëgrid deployments.</p><p>‚Ä¢ <strong>Extreme S&amp;R (Avalanche/Landslide)</strong>: Bluetooth beacon proximity to guide a radar‚Äëlike life‚Äëlocator workflow when responders are off‚Äëgrid.</p><p>‚Ä¢ <strong>Upcycling E‚ÄëWaste (ESG &amp; SDGs)</strong>: repurpose retired smartphones into offline relief nodes.</p><p>‚Ä¢ <strong>Off‚ÄëGrid Agriculture &amp; Asset Protection</strong>: practical patterns for livestock and asset safety where coverage is unavailable.</p><p>‚Ä¢ <strong>Arabic &amp; Global Ready</strong>: built‚Äëin multilingual UI (7 languages) including Arabic (RTL).</p>',
      badge_offline: '100% Offline',
      badge_gdpr: 'GDPR‚Äëfriendly',
      badge_ble: 'BLE Proximity + Assist',
      badge_tiny: 'Single‚Äëfile (~{KB} KB)',
      contact_line: 'Contact: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Home',
      nav_sos: 'SOS',
      nav_tips: 'Guide',
      nav_settings: 'Settings',
      install_sub: 'Works better as an installed app ‚Äî faster launch, more reliable Bluetooth behavior.',
      install_btn: 'Install',
      install_dismiss: 'Not now'
    },
    ko: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî Ïù∏ÌîÑÎùº ÎèÖÎ¶ΩÌòï ÏÉùÏ°¥ ÌîÑÎ†àÏûÑÏõåÌÅ¨ | McorpAI',
      app_mission: 'ÏôÑÏ†Ñ Ïò§ÌîÑÎùºÏù∏. ÌÅ¥ÎùºÏö∞Îìú ÏóÜÏùå. Ï∂îÏ†Å(ÌÖîÎ†àÎ©îÌä∏Î¶¨) ÏóÜÏùå. GDPR ÏπúÌôî ÏÑ§Í≥Ñ.',
      app_disclaimer: 'Îç∞Î™® Ïä§ÌÇ®: ‚ÄúÍ∞ïÏïÑÏßÄ ÏïàÏ†Ñ Î™©Ï§Ñ(Pet Safety Leash)‚Äù ‚Äî Î∏îÎ£®Ìà¨Ïä§ Í∑ºÏ†ë( GPS ÏïÑÎãò ). ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä ÎÅäÍ≤®ÎèÑ ÎèôÏûëÌïòÎèÑÎ°ù ÏÑ§Í≥Ñ.',
      github: 'GitHub ÏÜåÏä§',
      help: 'ÏÇ¨Ïö©Î≤ï',
      about: 'ÏÜåÍ∞ú',
      help_title: 'ÏÇ¨Ïö©Î≤ï',
      legal_title: 'ÏÜåÍ∞ú',
      tips_title: 'üìã Îç∞Î™® Í∞ÄÏù¥Îìú & ÌïÑÎìú ÎÖ∏Ìä∏',
      install_title: 'VitalGuard AI ÏÑ§Ïπò',
      empty_text: 'Îì±Î°ùÎêú Îç∞Î™® ÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.<br>Ï†ÄÍ∞Ä BLE ÌÇ§ÌååÏù∏Îçî ÌÉúÍ∑∏Î•º Ï∂îÍ∞ÄÌï¥ Ïò§ÌîÑÎùºÏù∏ Í∑ºÏ†ë Îç∞Î™®Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî.',
      empty_btn: '+ Îç∞Î™® ÌÉúÍ∑∏ Ï∂îÍ∞Ä',
      hero_title: 'üõ°Ô∏è Ïù∏ÌîÑÎùº ÎèÖÎ¶ΩÌòï ÏÉùÏ°¥ ÌîÑÎ†àÏûÑÏõåÌÅ¨',
      hero_body: 'VitalGuard AI v4.1.7Îäî Îã®Ïùº HTML ÌååÏùº Í∏∞Î∞òÏùò Ïò§ÌîÑÎùºÏù∏ Ïó∞ÏÜçÏÑ± ÎèÑÍµ¨Î°ú, BLE ÎπÑÏΩò Í∑ºÏ†ëÎèÑÏôÄ Ïò®ÎîîÎ∞îÏù¥Ïä§ Í≤ΩÎüâ Î°úÏßÅÏùÑ Í≤∞Ìï©Ìï¥ Ï†ÑÎ†•¬∑ÌÜµÏã† Ïû•Ïï† Î∞è Ïò§ÌîÑÍ∑∏Î¶¨Îìú ÌôòÍ≤ΩÏóêÏÑúÎèÑ ÏûëÎèôÌïòÎèÑÎ°ù ÏÑ§Í≥ÑÎêòÏóàÏäµÎãàÎã§. Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Í∏∞ÏóêÎßå Î≥¥Í¥ÄÎê©ÎãàÎã§.',
      hero_pillars_html: '<p><strong>Ïù∏ÌîÑÎùº ÎèÖÎ¶ΩÌòï ÏÉùÏ°¥ ÌîÑÎ†àÏûÑÏõåÌÅ¨</strong> ‚Äî Ï†ÑÎ†•¬∑ÌÜµÏã† Ïû•Ïï† Î∞è Ïò§ÌîÑÍ∑∏Î¶¨Îìú ÌôòÍ≤ΩÏóêÏÑúÎèÑ Ïó∞ÏÜçÏÑ±ÏùÑ ÌôïÎ≥¥Ìï©ÎãàÎã§.</p><p>‚Ä¢ <strong>Í∑πÌïú ÏàòÏÉâ¬∑Íµ¨Ï°∞(ÎààÏÇ¨ÌÉú/ÏÇ∞ÏÇ¨ÌÉú)</strong>: BLE ÎπÑÏΩò Í∑ºÏ†ëÎèÑÏôÄ Ïò®ÎîîÎ∞îÏù¥Ïä§ Î°úÏßÅÏúºÎ°ú, Íµ¨Ï°∞ÎåÄÍ∞Ä Ïò§ÌîÑÎùºÏù∏ÏóêÏÑúÎèÑ Îã®Í≥ÑÏ†ÅÏúºÎ°ú ÏúÑÏπòÎ•º Ï¢ÅÌòÄÍ∞à Ïàò ÏûàÎèÑÎ°ù ÏßÄÏõêÌï©ÎãàÎã§.</p><p>‚Ä¢ <strong>ÌèêÏä§ÎßàÌä∏Ìè∞ ÏóÖÏÇ¨Ïù¥ÌÅ¥ÎßÅ(ESG/SDGs)</strong>: Î∞©ÏπòÎêú Í∏∞Í∏∞Î•º ‚ÄòÏò§ÌîÑÎùºÏù∏ Íµ¨Ìò∏ ÎÖ∏Îìú‚ÄôÎ°ú Ïû¨ÌÉÑÏÉùÏãúÌÇµÎãàÎã§.</p><p>‚Ä¢ <strong>Ïò§ÌîÑÍ∑∏Î¶¨Îìú Î™©Ï∂ï¬∑ÏûêÏÇ∞ Î≥¥Ìò∏</strong>: Ï¥àÏõê/ÏÇ¨Îßâ Îì± Î¨¥Ïª§Î≤ÑÎ¶¨ÏßÄ ÌôòÍ≤ΩÏóêÏÑú Í∞ÄÏ∂ï¬∑ÏûêÏÇ∞ ÏïàÏ†Ñ Ìå®ÌÑ¥ÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.</p><p>‚Ä¢ <strong>Arabic Ìè¨Ìï® 7Í∞úÍµ≠Ïñ¥</strong>: ÏïÑÎûçÏñ¥(RTL)ÍπåÏßÄ ÎÇ¥Ïû•ÎêòÏñ¥ Ï¶âÏãú Î∞∞Ìè¨ Í∞ÄÎä•Ìï©ÎãàÎã§.</p>',
      badge_offline: 'ÏôÑÏ†Ñ Ïò§ÌîÑÎùºÏù∏',
      badge_gdpr: 'GDPR ÏπúÌôî',
      badge_ble: 'BLE Í∑ºÏ†ë + ÌòëÎ†• ÌÉêÏÉâ',
      badge_tiny: 'Îã®Ïùº ÌååÏùº (~{KB}KB)',
      contact_line: 'Î¨∏Ïùò: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (ÌïúÍµ≠Î™Ö: Gyumin Jeon)'
    ,
      nav_home: 'Ìôà',
      nav_sos: 'Í∏¥Í∏â',
      nav_tips: 'Í∞ÄÏù¥Îìú',
      nav_settings: 'ÏÑ§Ï†ï',
      install_sub: 'Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÎ©¥ Îçî ÏïàÏ†ïÏ†ÅÏûÖÎãàÎã§ ‚Äî Îçî Îπ†Î•∏ Ïã§Ìñâ, Î∏îÎ£®Ìà¨Ïä§ ÎèôÏûë ÏïàÏ†ï.',
      install_btn: 'Ïï± ÏÑ§Ïπò',
      install_dismiss: 'ÎÇòÏ§ëÏóê'
    },
    ar: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî ÿ•ÿ∑ÿßÿ± ÿ®ŸÇÿßÿ° ŸÖÿ≥ÿ™ŸÇŸÑ ÿπŸÜ ÿßŸÑÿ®ŸÜŸäÿ© ÿßŸÑÿ™ÿ≠ÿ™Ÿäÿ© | McorpAI',
      app_mission: 'ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ. ŸÑÿß ÿ≥ÿ≠ÿßÿ®ÿ©. ŸÑÿß ÿ™ÿ™ÿ®ÿπ. ŸÖÿµŸÖŸÖ ŸÑŸäŸÉŸàŸÜ ŸÖÿ™ŸàÿßŸÅŸÇŸãÿß ŸÖÿπ GDPR.',
      app_disclaimer: 'Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿπÿ±ÿ∂: ¬´ŸÖŸÇŸàÿØ ÿ£ŸÖÿßŸÜ ŸÑŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÑŸäŸÅÿ©¬ª ÿπÿ®ÿ± ŸÇÿ±ÿ® Bluetooth (ŸÑŸäÿ≥ GPS). ŸÖÿµŸÖŸÖ ŸÑŸÑÿπŸÖŸÑ ÿ≠ÿ™Ÿâ ÿπŸÜÿØ ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ¥ÿ®ŸÉÿßÿ™.',
      github: 'ŸÖÿµÿØÿ± GitHub',
      help: 'ŸÖÿ≥ÿßÿπÿØÿ©',
      about: 'ÿ≠ŸàŸÑ',
      help_title: 'ŸÖÿ≥ÿßÿπÿØÿ©',
      legal_title: 'ÿ≠ŸàŸÑ',
      tips_title: 'üìã ÿØŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ŸàŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸäÿØÿßŸÜŸäÿ©',
      install_title: 'ÿ™ÿ´ÿ®Ÿäÿ™ VitalGuard AI',
      empty_text: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÑÿßŸÖÿßÿ™ ŸÖÿ≥ÿ¨ŸëŸÑÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿ®ÿπÿØ.<br>ÿ£ÿ∂ŸÅ ÿπŸÑÿßŸÖÿ© BLE ÿ±ÿÆŸäÿµÿ© (ŸÖŸèÿπŸéÿ´ŸëŸêÿ± ŸÖŸÅÿßÿ™Ÿäÿ≠) ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿπÿ±ÿ∂ ÿßŸÑŸÇÿ±ÿ® ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ.',
      empty_btn: '+ ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÑŸÑÿπÿ±ÿ∂',
      hero_title: 'üõ°Ô∏è ÿ•ÿ∑ÿßÿ± ÿ®ŸÇÿßÿ° ŸÖÿ≥ÿ™ŸÇŸÑ ÿπŸÜ ÿßŸÑÿ®ŸÜŸäÿ© ÿßŸÑÿ™ÿ≠ÿ™Ÿäÿ©',
      hero_body: 'VitalGuard AI v4.1.7 ÿ£ÿØÿßÿ© ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ© ÿ∂ŸÖŸÜ ŸÖŸÑŸÅ Ÿàÿßÿ≠ÿØ ÿ™ÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑÿå ÿ™ÿ¨ŸÖÿπ ÿ®ŸäŸÜ ŸÇÿ±ÿ® ŸÖŸÜÿßÿ±ÿ© Bluetooth ŸàŸÖŸÜÿ∑ŸÇ ÿÆŸÅŸäŸÅ ÿπŸÑŸâ ÿßŸÑÿ¨Ÿáÿßÿ≤‚ÄîŸÑÿ™ÿπŸÖŸÑ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπÿßÿ™ ŸàŸÅŸä ÿßŸÑÿ®Ÿäÿ¶ÿßÿ™ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ¥ÿ®ŸÉÿ©ÿå ŸÖÿπ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ®ÿØŸàŸÜ ÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ≥ÿ≠ÿßÿ®Ÿä ÿ•ŸÑÿß ÿπŸÜÿØ ÿßŸÑÿ™ÿµÿØŸäÿ±).',
      hero_pillars_html: '<p><strong>ÿ•ÿ∑ÿßÿ± ÿ®ŸÇÿßÿ° ŸÖÿ≥ÿ™ŸÇŸÑ ÿπŸÜ ÿßŸÑÿ®ŸÜŸäÿ© ÿßŸÑÿ™ÿ≠ÿ™Ÿäÿ©</strong> ‚Äî ŸÑŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπÿßÿ™ ŸàÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ¥ÿ®ŸÉÿ©.</p><p>‚Ä¢ <strong>ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ•ŸÜŸÇÿßÿ∞ ŸÅŸä ÿßŸÑÿ∏ÿ±ŸàŸÅ ÿßŸÑŸÇÿßÿ≥Ÿäÿ© (ÿßŸÜŸáŸäÿßÿ±ÿßÿ™ ÿ´ŸÑÿ¨Ÿäÿ©/ÿßŸÜÿ≤ŸÑÿßŸÇÿßÿ™ ÿ£ÿ±ÿ∂Ÿäÿ©)</strong>: ŸÇÿ±ÿ® ŸÖŸÜÿßÿ±ÿßÿ™ BLE ŸÑÿØÿπŸÖ ÿ≥Ÿäÿ± ÿπŸÖŸÑ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπ Ÿäÿ¥ÿ®Ÿá ÿßŸÑÿ±ÿßÿØÿßÿ± ÿπŸÜÿØ ÿßŸÑÿπŸÖŸÑ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ¥ÿ®ŸÉÿ©.</p><p>‚Ä¢ <strong>ÿ•ÿπÿßÿØÿ© ÿ™Ÿàÿ∏ŸäŸÅ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ© (ESG/SDGs)</strong>: ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸáŸàÿßÿ™ŸÅ ÿßŸÑŸÖÿ™ŸÇÿßÿπÿØÿ© ÿ•ŸÑŸâ ÿπŸÇÿØ ÿ•ÿ∫ÿßÿ´ÿ© ÿ™ÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ.</p><p>‚Ä¢ <strong>ÿ≤ÿ±ÿßÿπÿ© ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ¥ÿ®ŸÉÿ© Ÿàÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ£ÿµŸàŸÑ</strong>: ÿ£ŸÜŸÖÿßÿ∑ ÿπŸÖŸÑŸäÿ© ŸÑÿ≥ŸÑÿßŸÖÿ© ÿßŸÑŸÖÿßÿ¥Ÿäÿ© ŸàÿßŸÑÿ£ÿµŸàŸÑ ÿ≠Ÿäÿ´ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∫ÿ∑Ÿäÿ©.</p><p>‚Ä¢ <strong>ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿπÿ±ÿ®Ÿäÿ© ŸàÿßŸÑÿπÿßŸÑŸÖ</strong>: Ÿàÿßÿ¨Ÿáÿ© ŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÑÿ∫ÿßÿ™ (7 ŸÑÿ∫ÿßÿ™) ÿ®ŸÖÿß ŸÅŸä ÿ∞ŸÑŸÉ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (RTL).</p>',
      badge_offline: 'ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ 100%',
      badge_gdpr: 'ÿµÿØŸäŸÇ ŸÑŸÄ GDPR',
      badge_ble: 'ŸÇÿ±ÿ® BLE + ŸÖÿ≥ÿßÿπÿØÿ© ÿ•ŸÜŸÇÿßÿ∞',
      badge_tiny: 'ŸÖŸÑŸÅ Ÿàÿßÿ≠ÿØ (~{KB} ŸÉŸäŸÑŸàÿ®ÿßŸäÿ™)',
      contact_line: 'ŸÑŸÑÿ™ŸàÿßÿµŸÑ: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
      nav_sos: 'SOS',
      nav_tips: 'ÿßŸÑÿØŸÑŸäŸÑ',
      nav_settings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
      install_sub: 'ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑ ŸÉÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸèÿ´ÿ®ÿ™ ‚Äî ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ£ÿ≥ÿ±ÿπ ŸàBluetooth ÿ£ŸÉÿ´ÿ± ŸÖŸàÿ´ŸàŸÇŸäÿ©.',
      install_btn: 'ÿ™ÿ´ÿ®Ÿäÿ™',
      install_dismiss: 'ŸÑŸäÿ≥ ÿßŸÑÿ¢ŸÜ'
    },
    ja: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî „Ç§„É≥„Éï„É©Èùû‰æùÂ≠ò„Çµ„Éê„Ç§„Éê„É´„Éª„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ | McorpAI',
      app_mission: 'ÂÆåÂÖ®„Ç™„Éï„É©„Ç§„É≥„ÄÇ„ÇØ„É©„Ç¶„Éâ„Å™„Åó„ÄÇ„ÉÜ„É¨„É°„Éà„É™„Éº„Å™„Åó„ÄÇGDPR„Å´ÈÖçÊÖÆ„Åó„ÅüË®≠Ë®à„ÄÇ',
      app_disclaimer: '„Éá„É¢Áî®„Çπ„Ç≠„É≥Ôºö„Äå„Éö„ÉÉ„ÉàÂÆâÂÖ®„É™„Éº„Éâ„Äç‚Äî BluetoothËøëÊé•ÔºàGPS„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÈöúÂÆ≥ÊôÇ„Åß„ÇÇÂãï‰Ωú„Åô„ÇãË®≠Ë®à„ÄÇ',
      github: 'GitHub „ÇΩ„Éº„Çπ',
      help: '‰Ωø„ÅÑÊñπ',
      about: 'Ê¶ÇË¶Å',
      help_title: '‰Ωø„ÅÑÊñπ',
      legal_title: 'Ê¶ÇË¶Å',
      tips_title: 'üìã „Éá„É¢„Ç¨„Ç§„Éâ & „Éï„Ç£„Éº„É´„Éâ„Éé„Éº„Éà',
      install_title: 'VitalGuard AI „Çí„Ç§„É≥„Çπ„Éà„Éº„É´',
      empty_text: '„Éá„É¢Áî®„Çø„Ç∞„Åå„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>ÂÆâ‰æ°„Å™BLE„Ç≠„Éº„Éï„Ç°„Ç§„É≥„ÉÄ„Éº„ÇíËøΩÂä†„Åó„Å¶„Ç™„Éï„É©„Ç§„É≥ËøëÊé•„Éá„É¢„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      empty_btn: '+ „Éá„É¢„Çø„Ç∞„ÇíËøΩÂä†',
      hero_title: 'üõ°Ô∏è „Ç§„É≥„Éï„É©Èùû‰æùÂ≠ò„Çµ„Éê„Ç§„Éê„É´„Éª„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ',
      hero_body: 'VitalGuard AI v4.1.7 „ÅØÂçò‰∏Ä HTML „Éï„Ç°„Ç§„É´„ÅÆ„Ç™„Éï„É©„Ç§„É≥Á∂ôÁ∂öÊÄß„ÉÑ„Éº„É´„Åß„Åô„ÄÇBLE „Éì„Éº„Ç≥„É≥ËøëÊé•„Å®ËªΩÈáè„Å™„Ç™„É≥„Éá„Éê„Ç§„Çπ„Éª„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„ÄÅÂÅúÈõª„ÇÑÈÄö‰ø°ÈöúÂÆ≥„ÄÅ„Ç™„Éï„Ç∞„É™„ÉÉ„ÉâÁí∞Â¢É„Åß„ÇÇÂãï‰Ωú„Åô„Çã„Çà„ÅÜË®≠Ë®à„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éá„Éº„Çø„ÅØÁ´ØÊú´ÂÜÖ„Å´„ÅÆ„Åø‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ',
      hero_pillars_html: '<p><strong>„Ç§„É≥„Éï„É©Èùû‰æùÂ≠ò„Çµ„Éê„Ç§„Éê„É´„Éª„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ</strong> ‚Äî ÂÅúÈõª„ÉªÈÄö‰ø°ÈöúÂÆ≥„ÇÑ„Ç™„Éï„Ç∞„É™„ÉÉ„ÉâÈÖçÂÇô„Åß„ÇÇÁ∂ôÁ∂öÈÅãÁî®„Åß„Åç„ÇãË®≠Ë®à„Åß„Åô„ÄÇ</p><p>‚Ä¢ <strong>Ê•µÈôê„ÅÆÊçúÁ¥¢ÊïëÂä©ÔºàÈõ™Â¥©/ÂúüÁ†ÇÂ¥©„ÇåÔºâ</strong>: BLE „Éì„Éº„Ç≥„É≥ËøëÊé•„Å´„Çà„Çä„ÄÅ„Ç™„Éï„Ç∞„É™„ÉÉ„ÉâÁí∞Â¢É„Åß„ÇÇÊÆµÈöéÁöÑ„Å´‰ΩçÁΩÆ„ÇíÁµû„ÇäËæº„ÇÄ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÊîØÊè¥„Åó„Åæ„Åô„ÄÇ</p><p>‚Ä¢ <strong>E‚ÄëWaste „ÅÆ„Ç¢„ÉÉ„Éó„Çµ„Ç§„ÇØ„É´ÔºàESG/SDGsÔºâ</strong>: ÈÄÄÂΩπ„Åó„Åü„Çπ„Éû„Éõ„Çí„Ç™„Éï„É©„Ç§„É≥ÊïëÊè¥„Éé„Éº„Éâ„Å®„Åó„Å¶ÂÜçÂà©Áî®„Åó„Åæ„Åô„ÄÇ</p><p>‚Ä¢ <strong>„Ç™„Éï„Ç∞„É™„ÉÉ„ÉâËæ≤Ê•≠ÔºÜË≥áÁî£‰øùË≠∑</strong>: ÈõªÊ≥¢„ÅÆÂ±ä„Åã„Å™„ÅÑÁí∞Â¢É„Åß„ÅÆÂÆ∂Áïú„ÉªË≥áÁî£„ÅÆÂÆâÂÖ®„Éë„Çø„Éº„É≥„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ</p><p>‚Ä¢ <strong>„Ç¢„É©„Éì„Ç¢Ë™û„ÇíÂê´„ÇÄ 7 Ë®ÄË™û</strong>: „Ç¢„É©„Éì„Ç¢Ë™ûÔºàRTLÔºâ„ÇíÂê´„ÇÄÂ§öË®ÄË™û UI „ÇíÂÜÖËîµ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>',
      badge_offline: 'ÂÆåÂÖ®„Ç™„Éï„É©„Ç§„É≥',
      badge_gdpr: 'GDPRÈÖçÊÖÆ',
      badge_ble: 'BLEËøëÊé• + ÂçîÂäõÊé¢Á¥¢',
      badge_tiny: 'Âçò‰∏Ä„Éï„Ç°„Ç§„É´ÔºàÁ¥Ñ{KB}KBÔºâ',
      contact_line: 'ÈÄ£Áµ°ÂÖà: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: '„Éõ„Éº„É†',
      nav_sos: 'SOS',
      nav_tips: '„Ç¨„Ç§„Éâ',
      nav_settings: 'Ë®≠ÂÆö',
      install_sub: '„Ç§„É≥„Çπ„Éà„Éº„É´„Åô„Çã„Å®ÂÆâÂÆö„Åó„Åæ„Åô ‚Äî Ëµ∑Âãï„ÅåÈÄü„Åè„ÄÅBluetooth„Åå„Çà„ÇäÁ¢∫ÂÆü„ÄÇ',
      install_btn: '„Ç§„É≥„Çπ„Éà„Éº„É´',
      install_dismiss: '‰ªä„ÅØ„Åó„Å™„ÅÑ'
    },
    fr: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî Cadre de survie ind√©pendant de l‚Äôinfrastructure | McorpAI',
      app_mission: 'Fonctionne enti√®rement hors ligne. Pas de cloud. Pas de t√©l√©m√©trie. Con√ßu pour √™tre compatible RGPD.',
      app_disclaimer: 'Habillage de d√©mo¬†: ¬´¬†Laisse de s√©curit√© pour animaux¬†¬ª via la proximit√© Bluetooth (pas GPS). Con√ßu pour fonctionner m√™me quand les r√©seaux tombent.',
      github: 'Code GitHub',
      help: 'Aide',
      about: '√Ä propos',
      help_title: 'Aide',
      legal_title: '√Ä propos',
      tips_title: 'üìã Guide de d√©mo & notes terrain',
      install_title: 'Installer VitalGuard AI',
      empty_text: 'Aucune balise de d√©mo enregistr√©e.<br>Ajoutez une balise BLE bon march√© (porte‚Äëcl√©s anti‚Äëperte) pour lancer la d√©mo de proximit√© hors ligne.',
      empty_btn: '+ Ajouter une balise',
      hero_title: 'üõ°Ô∏è Cadre de survie ind√©pendant de l‚Äôinfrastructure',
      hero_body: 'VitalGuard AI v4.1.7 est un outil de continuit√© hors‚Äëligne en fichier unique, combinant la proximit√© de balises Bluetooth et une logique l√©g√®re sur l‚Äôappareil‚Äîcon√ßu pour fonctionner pendant les pannes et les d√©ploiements hors‚Äër√©seau, avec des donn√©es conserv√©es localement (pas de r√©tention dans le cloud sauf export).',
      hero_pillars_html: '<p><strong>Cadre de survie ind√©pendant de l‚Äôinfrastructure</strong> ‚Äî pour assurer la continuit√© pendant les pannes et les d√©ploiements hors‚Äër√©seau.</p><p>‚Ä¢ <strong>S&amp;R extr√™me (avalanche/glissement de terrain)</strong> : proximit√© de balises BLE pour soutenir un workflow de localisation ¬´ type radar ¬ª en mode hors‚Äër√©seau.</p><p>‚Ä¢ <strong>Upcycling des e‚Äëd√©chets (ESG &amp; ODD)</strong> : r√©utiliser des smartphones retrait√©s comme n≈ìuds de secours hors‚Äëligne.</p><p>‚Ä¢ <strong>Agriculture hors‚Äër√©seau &amp; protection des actifs</strong> : patterns pratiques pour le b√©tail et les actifs sans couverture.</p><p>‚Ä¢ <strong>Arabe &amp; pr√™t pour le monde</strong> : UI multilingue int√©gr√©e (7 langues) dont l‚Äôarabe (RTL).</p>',
      badge_offline: '100% hors ligne',
      badge_gdpr: 'RGPD‚Äëfriendly',
      badge_ble: 'Proximit√© BLE + Assistance',
      badge_tiny: 'Fichier unique (~{KB} Ko)',
      contact_line: 'Contact: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Accueil',
      nav_sos: 'SOS',
      nav_tips: 'Guide',
      nav_settings: 'Param√®tres',
      install_sub: 'Meilleur en appli install√©e ‚Äî d√©marrage plus rapide, Bluetooth plus fiable.',
      install_btn: 'Installer',
      install_dismiss: 'Plus tard'
    },
    'zh-TW': {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî ÊïëÂëΩÈõ¢Á∑ö AI Á§∫ÁØÑ | McorpAI',
      app_mission: 'ÂÆåÂÖ®Èõ¢Á∑öÈÅã‰Ωú„ÄÇÁÑ°Èõ≤Á´Ø„ÄÇÁÑ°ËøΩËπ§„ÄÇ‰ª• GDPR ÂèãÂñÑÁÇ∫Ë®≠Ë®àÂéüÂâá„ÄÇ',
      app_disclaimer: 'Á§∫ÁØÑÂ§ñËßÄÔºö„ÄåÂØµÁâ©ÂÆâÂÖ®ÁâΩÁπ©„Äç‚Äî ‰ª•ËóçÁâôËøëË∑ùÈõ¢ÂÅµÊ∏¨ÔºàÈùû GPSÔºâ„ÄÇÁÇ∫Á∂≤Ë∑Ø‰∏≠Êñ∑ÊÉÖÂ¢ÉËÄåË®≠Ë®à„ÄÇ',
      github: 'GitHub ÂéüÂßãÁ¢º',
      help: 'Ë™™Êòé',
      about: 'ÈóúÊñº',
      help_title: 'Ë™™Êòé',
      legal_title: 'ÈóúÊñº',
      tips_title: 'üìã Á§∫ÁØÑÊåáÂçóËàáÁèæÂ†¥Á≠ÜË®ò',
      install_title: 'ÂÆâË£ù VitalGuard AI',
      empty_text: 'Â∞öÊú™Ë®ªÂÜä‰ªª‰ΩïÁ§∫ÁØÑÊ®ôÁ±§„ÄÇ<br>Êñ∞Â¢û‰æøÂÆúÁöÑ BLE Èò≤‰∏üÈë∞ÂåôÂúàÊ®ôÁ±§ÔºåÂç≥ÂèØÈñãÂßãÈõ¢Á∑öËøëË∑ùÈõ¢Á§∫ÁØÑ„ÄÇ',
      empty_btn: '+ Êñ∞Â¢ûÁ§∫ÁØÑÊ®ôÁ±§',
      hero_title: 'üõ°Ô∏è ÊïëÂëΩÈõ¢Á∑ö AI Á§∫ÁØÑ',
      hero_body: 'VitalGuard AI ÊòØ„ÄåAI + ËóçÁâôËøëË∑ùÈõ¢„ÄçÁöÑÈõ¢Á∑öÁ§∫ÁØÑÔºöÈõ≤Á´Ø‰∏çÂèØÁî®ÊôÇ‰ªçËÉΩÈÅã‰Ωú„ÄÇÊ≤íÊúâÂ∏≥Ëôü„ÄÅÊ≤íÊúâÈõ≤Á´ØÂêåÊ≠•„ÄÅÊ≤íÊúâÊöó‰∏≠‰∏äÂÇ≥„ÄÇÈô§Èùû‰Ω†ÈÅ∏ÊìáÂåØÂá∫ÔºåÊâÄÊúâË≥áÊñôÈÉΩÂè™ÁïôÂú®‰Ω†ÁöÑË£ùÁΩÆ‰∏ä„ÄÇ',
      badge_offline: 'ÂÆåÂÖ®Èõ¢Á∑ö',
      badge_gdpr: 'GDPR ÂèãÂñÑ',
      badge_ble: 'BLE ËøëË∑ùÈõ¢ + Âçî‰Ωú',
      badge_tiny: 'ÂñÆ‰∏ÄÊ™îÊ°àÔºàÁ¥Ñ{KB} KBÔºâ',
      contact_line: 'ËÅØÁµ°: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'È¶ñÈ†Å',
      nav_sos: 'SOS',
      nav_tips: 'ÊåáÂçó',
      nav_settings: 'Ë®≠ÂÆö',
      install_sub: 'ÂÆâË£ùÊàê App ÊúÉÊõ¥Á©©ÂÆö ‚Äî ÂïüÂãïÊõ¥Âø´„ÄÅËóçÁâôÊõ¥ÂèØÈù†„ÄÇ',
      install_btn: 'ÂÆâË£ù',
      install_dismiss: 'Á®çÂæå'
    },
    es: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.7 ‚Äî Marco de supervivencia independiente de la infraestructura | McorpAI',
      app_mission: 'Funciona totalmente sin conexi√≥n. Sin nube. Sin telemetr√≠a. Dise√±ado para ser compatible con el GDPR.',
      app_disclaimer: 'Piel de demo: ‚ÄúCorrea de seguridad para mascotas‚Äù usando proximidad Bluetooth (no GPS). Dise√±ado para funcionar cuando fallan las redes.',
      github: 'C√≥digo en GitHub',
      help: 'Ayuda',
      about: 'Acerca de',
      help_title: 'Ayuda',
      legal_title: 'Acerca de',
      tips_title: 'üìã Gu√≠a de demo y notas de campo',
      install_title: 'Instalar VitalGuard AI',
      empty_text: 'A√∫n no hay etiquetas registradas.<br>Agrega una etiqueta BLE barata (buscador de llaves) para iniciar la demo de proximidad sin conexi√≥n.',
      empty_btn: '+ A√±adir etiqueta',
      hero_title: 'üõ°Ô∏è Marco de supervivencia independiente de la infraestructura',
      hero_body: 'VitalGuard AI v4.1.7 es una herramienta de continuidad en un solo archivo y sin conexi√≥n, que combina proximidad de balizas Bluetooth y l√≥gica ligera en el dispositivo‚Äîdise√±ada para funcionar durante interrupciones y despliegues fuera de red, con los datos guardados en el dispositivo (sin retenci√≥n en la nube salvo exportaci√≥n).',
      hero_pillars_html: '<p><strong>Marco de supervivencia independiente de la infraestructura</strong> ‚Äî para continuidad durante interrupciones y despliegues fuera de red.</p><p>‚Ä¢ <strong>B&amp;R extremo (avalancha/deslizamiento)</strong>: proximidad de balizas BLE para apoyar un flujo de localizaci√≥n ¬´tipo radar¬ª fuera de red.</p><p>‚Ä¢ <strong>Upcycling de e‚Äëwaste (ESG &amp; ODS)</strong>: reutilizar smartphones retirados como nodos de ayuda sin conexi√≥n.</p><p>‚Ä¢ <strong>Agricultura fuera de red &amp; protecci√≥n de activos</strong>: patrones pr√°cticos para ganado y activos sin cobertura.</p><p>‚Ä¢ <strong>√Årabe y listo para el mundo</strong>: UI multiling√ºe integrada (7 idiomas), incluido √°rabe (RTL).</p>',
      badge_offline: '100% sin conexi√≥n',
      badge_gdpr: 'Compatible GDPR',
      badge_ble: 'Proximidad BLE + Asistencia',
      badge_tiny: 'Archivo √∫nico (~{KB} KB)',
      contact_line: 'Contacto: contact@mcorpai.org ‚Ä¢ mcorpai.org ‚Ä¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Inicio',
      nav_sos: 'SOS',
      nav_tips: 'Gu√≠a',
      nav_settings: 'Ajustes',
      install_sub: 'Mejor como app instalada ‚Äî inicio m√°s r√°pido, Bluetooth m√°s fiable.',
      install_btn: 'Instalar',
      install_dismiss: 'Ahora no'
    }
  };

  const HTML = {
    tips: {
      en: `
        <div class="tip-card info">
          <div class="tip-title">What you are looking at</div>
          <div class="tip-body">
            This page is a <strong>technology demonstration</strong>. The UI is intentionally ‚ÄúPet Safety Leash‚Äù because it is universal and harmless,
            but the underlying engine is built for <strong>life‚Äësaving offline scenarios</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2‚Äëminute demo</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Get a cheap BLE key‚Äëfinder tag (often called <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home ‚Üí <strong>Add Demo Tag</strong> ‚Üí follow the wizard (near ‚Üí move away ‚Üí name).</li>
              <li>Start monitoring. Watch the zone change (SAFE ‚Üí CAUTION ‚Üí WARNING) as distance changes.</li>
              <li>Try SOS: generate an offline QR card and test the audio beacon.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã Why offline matters in disasters</div>
        <div class="tip-card warn">
          <div class="tip-title">When the network fails</div>
          <div class="tip-body">
            During wildfires, landslides, tsunamis, and mass evacuations, cloud apps can fail: no signal, no power, no accounts, no payments.
            VitalGuard AI keeps a <strong>tiny offline ‚Äúbrain‚Äù</strong> on the device, so the demo still runs.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Example deployments (easy to understand)</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Evacuation centers:</strong> put BLE tags on medical kits / generators ‚Üí alert if moved outside a zone.</li>
              <li><strong>Search & rescue:</strong> tag team members or gear ‚Üí help locate what is nearby when visibility is poor.</li>
              <li><strong>Family reunification:</strong> a phone can monitor proximity between a guardian and a child (not GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Privacy & GDPR</div>
          <div class="tip-body">
            No accounts. No analytics. No cloud calls. Data is stored locally and can be erased anytime.
            Exports (backup/diagnostics) happen only when you press the button.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Important limitation</div>
          <div class="tip-body">
            Bluetooth RSSI is noisy (walls, crowds, pockets). Use zones as <em>signals</em>, not exact meters.
            This is a demo, not a certified life‚Äëcritical device.
          </div>
        </div>
      `,
      ko: `
        <div class="tip-card info">
          <div class="tip-title">ÏßÄÍ∏à Î≥¥Í≥† ÏûàÎäî Í≤ÉÏùÄ?</div>
          <div class="tip-body">
            Ïù¥ ÌéòÏù¥ÏßÄÎäî <strong>Í∏∞Ïà† ÏãúÏó∞(Îç∞Î™®)</strong>ÏûÖÎãàÎã§. UIÍ∞Ä ‚ÄúÍ∞ïÏïÑÏßÄ ÏïàÏ†Ñ Î™©Ï§Ñ‚ÄùÏ≤òÎüº Î≥¥Ïù¥ÎèÑÎ°ù ÎßåÎì† Ïù¥Ïú†Îäî Í∞ÄÏû• Î≥¥Ìé∏Ï†ÅÏù¥Í≥† Î¨¥Ìï¥Ìïú ÏÇ¨Î°ÄÏù¥Í∏∞ ÎïåÎ¨∏Ïù¥Î©∞,
            Ïã§Ï†ú ÌïµÏã¨ÏùÄ <strong>Ïû¨ÎÇú/ÏÖßÎã§Ïö¥ ÌôòÍ≤ΩÏóêÏÑúÎèÑ ÎèôÏûëÌïòÎäî Ïò§ÌîÑÎùºÏù∏ AI ÏóîÏßÑ</strong>ÏûÖÎãàÎã§.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2Î∂Ñ Îç∞Î™® Ï†àÏ∞®</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Ï†ÄÍ∞Ä BLE ÌÇ§ÌååÏù∏Îçî ÌÉúÍ∑∏ Ï§ÄÎπÑ (<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> Îì±).</li>
              <li>Home ‚Üí <strong>Îç∞Î™® ÌÉúÍ∑∏ Ï∂îÍ∞Ä</strong> ‚Üí ÏúÑÏûêÎìú(Í∞ÄÍπåÏù¥ ‚Üí Î©ÄÎ¶¨ Ïù¥Îèô ‚Üí Ïù¥Î¶Ñ ÏßÄÏ†ï).</li>
              <li>Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë ‚Üí Í±∞Î¶¨ Î≥ÄÌôîÏóê Îî∞Îùº SAFE ‚Üí CAUTION ‚Üí WARNING Ï°¥Ïù¥ Î∞îÎÄåÎäîÏßÄ ÌôïÏù∏.</li>
              <li>SOSÏóêÏÑú Ïò§ÌîÑÎùºÏù∏ QR Ïπ¥Îìú ÏÉùÏÑ± + Ïò§ÎîîÏò§ ÎπÑÏΩò ÌÖåÏä§Ìä∏.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã Ïû¨ÎÇúÏóêÏÑú ‚ÄúÏò§ÌîÑÎùºÏù∏‚ÄùÏù¥ Ï§ëÏöîÌïú Ïù¥Ïú†</div>
        <div class="tip-card warn">
          <div class="tip-title">ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä ÎÅäÍ∏∞Î©¥</div>
          <div class="tip-body">
            ÏÇ∞Î∂à¬∑ÏÇ∞ÏÇ¨ÌÉú¬∑Ïì∞ÎÇòÎØ∏¬∑ÎåÄÍ∑úÎ™® ÎåÄÌîº ÏÉÅÌô©ÏóêÏÑúÎäî Ïã†Ìò∏/Ï†ÑÎ†•/Í≥ÑÏ†ï/Í≤∞Ï†úÍ∞Ä Î™®Îëê Î∂àÏïàÏ†ïÌï¥Ïßà Ïàò ÏûàÏäµÎãàÎã§.
            VitalGuard AIÎäî Í∏∞Í∏∞ ÏïàÏóê <strong>ÏûëÏùÄ Ïò§ÌîÑÎùºÏù∏ ÎëêÎáå</strong>Î•º ÎÑ£Ïñ¥ Ïù¥Îü∞ ÏÉÅÌô©ÏóêÏÑúÎèÑ Îç∞Î™®Í∞Ä Í≥ÑÏÜç ÎèôÏûëÌïòÎèÑÎ°ù ÏÑ§Í≥ÑÌñàÏäµÎãàÎã§.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ïù¥Ìï¥ÌïòÍ∏∞ Ïâ¨Ïö¥ ÌôúÏö© ÏòàÏãú</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ÎåÄÌîºÏÜå:</strong> ÏùòÎ£å ÌÇ§Ìä∏/Î∞úÏ†ÑÍ∏∞ Îì±Ïóê BLE ÌÉúÍ∑∏ Î∂ÄÏ∞© ‚Üí ÏßÄÏ†ï Íµ¨Ïó≠ Ïù¥ÌÉà Ïãú Í≤ΩÎ≥¥.</li>
              <li><strong>ÏàòÏÉâ/Íµ¨Ï°∞:</strong> ÌåÄÏõê/Ïû•ÎπÑÏóê ÌÉúÍ∑∏ ‚Üí ÏãúÏïºÍ∞Ä ÎÇòÏÅ† Îïå ‚ÄúÍ∑ºÏ≤òÏóê Î¨¥ÏóáÏù¥ ÏûàÎäîÏßÄ‚Äù Îπ†Î•¥Í≤å ÌååÏïÖ.</li>
              <li><strong>Í∞ÄÏ°± Ïû¨Í≤∞Ìï©:</strong> Î≥¥Ìò∏Ïûê‚ÄëÏïÑÏù¥ Í∑ºÏ†ë Î™®ÎãàÌÑ∞ÎßÅ( GPS ÏïÑÎãò ).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Í∞úÏù∏Ï†ïÎ≥¥ & GDPR</div>
          <div class="tip-body">
            Í≥ÑÏ†ï ÏóÜÏùå ¬∑ Î∂ÑÏÑù ÏóÜÏùå ¬∑ ÌÅ¥ÎùºÏö∞Îìú ÌÜµÏã† ÏóÜÏùå. Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Í∏∞ÏóêÎßå Ï†ÄÏû•ÎêòÎ©∞ Ïñ∏Ï†úÎì† ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.
            Î∞±ÏóÖ/ÏßÑÎã® ÎÇ¥Î≥¥ÎÇ¥Í∏∞Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ ÎïåÎßå ÏàòÌñâÎê©ÎãàÎã§.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Ï§ëÏöîÌïú ÌïúÍ≥Ñ</div>
          <div class="tip-body">
            BLE RSSIÎäî Î≤Ω/ÏÇ¨Îûå/Ï£ºÎ®∏Îãà Îì± ÌôòÍ≤ΩÏóê Îî∞Îùº ÌÅ¨Í≤å ÌùîÎì§Î¶ΩÎãàÎã§. ÎØ∏ÌÑ∞ Îã®ÏúÑ ‚ÄúÏ†ïÌôïÌïú Í±∞Î¶¨‚ÄùÍ∞Ä ÏïÑÎãàÎùº <em>Ïã†Ìò∏</em>Î°ú Î≥¥ÏÑ∏Ïöî.
            Î≥∏ ÌååÏùºÏùÄ Îç∞Î™®Ïù¥Î©∞ ÏÉùÎ™Ö‚ÄëÏïàÏ†Ñ Ïù∏Ï¶ù Ïû•ÎπÑÍ∞Ä ÏïÑÎãôÎãàÎã§.
          </div>
        </div>
      `,
      ar: `
        <div class="tip-card info">
          <div class="tip-title">ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ™ÿ±ÿßŸá ŸáŸÜÿßÿü</div>
          <div class="tip-body">
            Ÿáÿ∞Ÿá <strong>ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ™ŸÇŸÜŸäÿ©</strong>. ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± Ÿàÿßÿ¨Ÿáÿ© ‚ÄúŸÖŸÇŸàÿØ ÿ£ŸÖÿßŸÜ ŸÑŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÑŸäŸÅÿ©‚Äù ŸÑÿ£ŸÜŸáÿß ÿπÿßŸÖÿ© Ÿàÿ∫Ÿäÿ± ÿ≠ÿ≥ÿßÿ≥ÿ©ÿå
            ŸÑŸÉŸÜ ÿßŸÑŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ŸÖŸàÿ¨ŸëŸá ŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸàŸáÿßÿ™ <strong>ÿßŸÑÿ•ŸÜŸÇÿßÿ∞ ŸàÿßŸÑÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ÿπÿ±ÿ∂ ÿÆŸÑÿßŸÑ ÿØŸÇŸäŸÇÿ™ŸäŸÜ</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿπŸÑÿßŸÖÿ© BLE ÿ±ÿÆŸäÿµÿ© (ÿ∫ÿßŸÑÿ®Ÿãÿß <span class="kbd">iTag</span> ÿ£Ÿà <span class="kbd">Key Finder</span>).</li>
              <li>Home ‚Üí <strong>ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÑŸÑÿπÿ±ÿ∂</strong> ÿ´ŸÖ ÿßÿ™ÿ®ÿπ ÿßŸÑŸÖÿπÿßŸÑÿ¨ (ŸÇÿ±Ÿäÿ® ‚Üí ÿßÿ®ÿ™ÿπÿØ ‚Üí ÿ≥ŸÖŸëŸêŸáÿß).</li>
              <li>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© Ÿàÿ¥ÿßŸáÿØ ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ (SAFE ‚Üí CAUTION ‚Üí WARNING) ŸÖÿπ ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑŸÇÿ±ÿ®.</li>
              <li>ÿ¨ÿ±Ÿëÿ® SOS: ÿ£ŸÜÿ¥ÿ¶ ÿ®ÿ∑ÿßŸÇÿ© QR ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸàÿßÿÆÿ™ÿ®ÿ± ŸÖŸÜÿßÿ±ÿ© ÿßŸÑÿµŸàÿ™.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã ŸÑŸÖÿßÿ∞ÿß ŸäŸáŸÖ ÿßŸÑÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸÅŸä ÿßŸÑŸÉŸàÿßÿ±ÿ´</div>
        <div class="tip-card warn">
          <div class="tip-title">ÿπŸÜÿØŸÖÿß ÿ™ÿ™ÿπÿ∑ŸÑ ÿßŸÑÿ¥ÿ®ŸÉÿßÿ™</div>
          <div class="tip-body">
            ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ÿ±ÿßÿ¶ŸÇ ŸàÿßŸÑÿßŸÜŸáŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ£ÿ±ÿ∂Ÿäÿ© Ÿàÿ£ŸÖŸàÿßÿ¨ ÿ™ÿ≥ŸàŸÜÿßŸÖŸä ŸàÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ•ÿ¨ŸÑÿßÿ° ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ŸÇÿØ ÿ™ŸÅÿ¥ŸÑ ÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©: ŸÑÿß ÿ•ÿ¥ÿßÿ±ÿ©ÿå ŸÑÿß ÿ∑ÿßŸÇÿ©ÿå ŸÑÿß ÿ≠ÿ≥ÿßÿ®ÿßÿ™.
            VitalGuard AI Ÿäÿ≠ÿ™ŸÅÿ∏ ÿ®ŸÄ <strong>ÿπŸÇŸÑ ÿµÿ∫Ÿäÿ± ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ</strong> ÿØÿßÿÆŸÑ ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÑŸäÿ≥ÿ™ŸÖÿ± ÿßŸÑÿπÿ±ÿ∂.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ÿ£ŸÖÿ´ŸÑÿ© ÿ≥ŸáŸÑÿ© ÿßŸÑŸÅŸáŸÖ</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑÿ•ŸäŸàÿßÿ°:</strong> ÿ∂ÿπ ÿπŸÑÿßŸÖÿßÿ™ ÿπŸÑŸâ ÿ≠ŸÇÿßÿ¶ÿ® ÿßŸÑÿ•ÿ≥ÿπÿßŸÅ/ÿßŸÑŸÖŸàŸÑÿØÿßÿ™ ‚Üí ÿ™ŸÜÿ®ŸäŸá ÿπŸÜÿØ ÿÆÿ±Ÿàÿ¨Ÿáÿß ŸÖŸÜ ŸÖŸÜÿ∑ŸÇÿ©.</li>
              <li><strong>ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ•ŸÜŸÇÿßÿ∞:</strong> ÿπŸÑŸëŸÖ ÿ£ÿπÿ∂ÿßÿ° ÿßŸÑŸÅÿ±ŸäŸÇ ÿ£Ÿà ÿßŸÑŸÖÿπÿØÿßÿ™ ‚Üí ŸÖÿπÿ±ŸÅÿ© ŸÖÿß ŸáŸà ŸÇÿ±Ÿäÿ® ÿπŸÜÿØ ÿ∂ÿπŸÅ ÿßŸÑÿ±ÿ§Ÿäÿ©.</li>
              <li><strong>ŸÑŸÖŸë ÿ¥ŸÖŸÑ ÿßŸÑÿπÿßÿ¶ŸÑÿ©:</strong> ŸÖÿ±ÿßŸÇÿ®ÿ© ŸÇÿ±ÿ® ÿ∑ŸÅŸÑ ŸàŸàŸÑŸä ÿ£ŸÖÿ± (ŸÑŸäÿ≥ GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">ÿßŸÑÿÆÿµŸàÿµŸäÿ© Ÿà GDPR</div>
          <div class="tip-body">
            ŸÑÿß ÿ≠ÿ≥ÿßÿ®ÿßÿ™ÿå ŸÑÿß ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ÿå ŸÑÿß ÿ≥ÿ≠ÿßÿ®ÿ©. ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿ© ŸàŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅŸáÿß ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™. ÿßŸÑÿ™ÿµÿØŸäÿ± Ÿäÿ™ŸÖ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ≤ÿ±.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ŸÇŸäÿØ ŸÖŸáŸÖ</div>
          <div class="tip-body">
            ÿ•ÿ¥ÿßÿ±ÿ© Bluetooth (RSSI) ŸÖÿ™ŸÇŸÑÿ®ÿ© ÿ®ÿ≥ÿ®ÿ® ÿßŸÑÿ¨ÿØÿ±ÿßŸÜ ŸàÿßŸÑÿ≠ÿ¥ŸàÿØ ŸàÿßŸÑÿ¨ŸäŸàÿ®. ÿßÿπÿ™ÿ®ÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ•ÿ¥ÿßÿ±ÿßÿ™ ŸÑÿß ÿ£ŸÖÿ™ÿßÿ± ÿØŸÇŸäŸÇÿ©.
            Ÿáÿ∞ÿß ÿπÿ±ÿ∂ ÿ™ŸÇŸÜŸä ŸàŸÑŸäÿ≥ ÿ¨Ÿáÿßÿ≤Ÿãÿß ŸÖÿπÿ™ŸÖÿØŸãÿß ŸÑŸÑÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿ≠ÿ±ÿ¨ÿ©.
          </div>
        </div>
      `,
      ja: `
        <div class="tip-card info">
          <div class="tip-title">„Åì„Çå„ÅØ‰Ωï„ÅÆ„Éá„É¢Ôºü</div>
          <div class="tip-body">
            „Åì„Çå„ÅØ <strong>ÊäÄË°ì„Éá„É¢</strong> „Åß„Åô„ÄÇUI „Çí„Äå„Éö„ÉÉ„ÉàÂÆâÂÖ®„É™„Éº„Éâ„Äç„Å´„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅØ„ÄÅÊúÄ„ÇÇÊôÆÈÅçÁöÑ„ÅßÁÑ°ÂÆ≥„Å™‰æã„Å†„Åã„Çâ„Åß„Åô„ÄÇ
            „Åó„Åã„Åó‰∏≠Ë∫´„ÅØ <strong>ÁÅΩÂÆ≥/„Ç∑„É£„ÉÉ„Éà„ÉÄ„Ç¶„É≥Áí∞Â¢É„Åß„ÇÇÂãï„Åè„Ç™„Éï„É©„Ç§„É≥AI„Ç®„É≥„Ç∏„É≥</strong> „ÇíÁ§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2ÂàÜ„Éá„É¢</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>ÂÆâ‰æ°„Å™ BLE „Ç≠„Éº„Éï„Ç°„Ç§„É≥„ÉÄ„ÉºÔºà<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> „Å™„Å©Ôºâ„ÇíÁî®ÊÑè„ÄÇ</li>
              <li>Home ‚Üí <strong>„Éá„É¢„Çø„Ç∞ËøΩÂä†</strong> ‚Üí „Ç¶„Ç£„Ç∂„Éº„ÉâÔºàËøë„Åè‚ÜíÈõ¢„Çå„Çã‚ÜíÂêçÂâçÔºâ„ÄÇ</li>
              <li>Áõ£Ë¶ñ„ÇíÈñãÂßã„Åó„ÄÅSAFE ‚Üí CAUTION ‚Üí WARNING „ÅÆÂ§âÂåñ„ÇíÁ¢∫Ë™ç„ÄÇ</li>
              <li>SOS: „Ç™„Éï„É©„Ç§„É≥ QR „Ç´„Éº„ÉâÁîüÊàê + Èü≥„ÅÆ„Éì„Éº„Ç≥„É≥„Çí„ÉÜ„Çπ„Éà„ÄÇ</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã ÁÅΩÂÆ≥„Åß„Äå„Ç™„Éï„É©„Ç§„É≥„Äç„ÅåÈáçË¶Å„Å™ÁêÜÁî±</div>
        <div class="tip-card warn">
          <div class="tip-title">„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÅåËêΩ„Å°„Çã„Å®</div>
          <div class="tip-body">
            Â±±ÁÅ´‰∫ã„ÉªÂúüÁ†ÇÁÅΩÂÆ≥„ÉªÊ¥•Ê≥¢„ÉªÂ§ßË¶èÊ®°ÈÅøÈõ£„Åß„ÅØ„ÄÅÈõªÊ≥¢/ÈõªÂäõ/„Ç¢„Ç´„Ç¶„É≥„Éà/Ë™≤Èáë„ÅåÊàêÁ´ã„Åó„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
            VitalGuard AI „ÅØÁ´ØÊú´ÂÜÖ„Å´ <strong>Â∞è„Åï„Å™„Ç™„Éï„É©„Ç§„É≥ËÑ≥</strong> „ÇíÊåÅ„Å°„ÄÅ„Éá„É¢„ÇíÁ∂ôÁ∂ö„Åß„Åç„Åæ„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑÁî®ÈÄî‰æã</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ÈÅøÈõ£ÊâÄ:</strong> ÂåªÁôÇ„Ç≠„ÉÉ„Éà/Áô∫ÈõªÊ©ü„Å´„Çø„Ç∞ ‚Üí „Çæ„Éº„É≥Â§ñ„Å´Âá∫„Åü„ÇâË≠¶Âëä„ÄÇ</li>
              <li><strong>ÊçúÁ¥¢ÊïëÂä©:</strong> ÈöäÂì°/Ë£ÖÂÇô„Å´„Çø„Ç∞ ‚Üí Ë¶ñÁïå‰∏çËâØ„Åß„ÇÇ„ÄåËøë„Åè„Å´‰Ωï„Åå„ÅÇ„Çã„Åã„Äç„ÇíÊääÊè°„ÄÇ</li>
              <li><strong>ÂÆ∂Êóè„ÅÆÂÜç‰ºö:</strong> ‰øùË≠∑ËÄÖ„Å®Â≠ê„Å©„ÇÇ„ÅÆËøëÊé•Áõ£Ë¶ñÔºàGPS„Åß„ÅØ„Å™„ÅÑÔºâ„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">„Éó„É©„Ç§„Éê„Ç∑„Éº / GDPR</div>
          <div class="tip-body">
            „Ç¢„Ç´„Ç¶„É≥„Éà„Å™„Åó„ÉªËß£Êûê„Å™„Åó„Éª„ÇØ„É©„Ç¶„ÉâÈÄö‰ø°„Å™„Åó„ÄÇ„Éá„Éº„Çø„ÅØÁ´ØÊú´ÂÜÖ„Å´‰øùÂ≠ò„Åï„Çå„ÄÅ„ÅÑ„Å§„Åß„ÇÇÊ∂àÂéª„Åß„Åç„Åæ„Åô„ÄÇ
            „Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅØ„Éú„Çø„É≥Êìç‰ΩúÊôÇ„ÅÆ„Åø„Åß„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ÈáçË¶Å„Å™Âà∂Èôê</div>
          <div class="tip-body">
            Bluetooth RSSI „ÅØÂ£Å„ÇÑ‰∫∫Ê∑∑„Åø„ÅßÂ§ß„Åç„ÅèÊè∫„Çå„Åæ„Åô„ÄÇË∑ùÈõ¢„Çí„ÄåÊ≠£Á¢∫„Å™„É°„Éº„Éà„É´„Äç„Å®„Åó„Å¶Êâ±„Çè„Åö„ÄÅ„Çæ„Éº„É≥„Çí <em>ÁõÆÂÆâ</em> „Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            Êú¨„Éï„Ç°„Ç§„É´„ÅØ„Éá„É¢„Åß„ÅÇ„Çä„ÄÅÁîüÂëΩÂÆâÂÖ®„ÅÆË™çË®ºÊ©üÂô®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
          </div>
        </div>
      `,
      fr: `
        <div class="tip-card info">
          <div class="tip-title">Ce que vous voyez</div>
          <div class="tip-body">
            Ceci est une <strong>d√©mo technologique</strong>. L‚Äôinterface ‚ÄúLaisse de s√©curit√©‚Äù est volontairement neutre,
            mais le moteur sert des sc√©narios <strong>hors ligne et de sauvetage</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">D√©mo en 2 minutes</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Procurez‚Äëvous une balise BLE bon march√© (souvent <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home ‚Üí <strong>Ajouter une balise</strong> ‚Üí assistant (pr√®s ‚Üí √©loignez‚Äëvous ‚Üí nom).</li>
              <li>D√©marrez le suivi et observez SAFE ‚Üí CAUTION ‚Üí WARNING selon la proximit√©.</li>
              <li>Testez SOS¬†: QR hors ligne + balise audio.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã Pourquoi le hors‚Äëligne est crucial</div>
        <div class="tip-card warn">
          <div class="tip-title">Quand le r√©seau tombe</div>
          <div class="tip-body">
            Incendies, glissements de terrain, tsunamis, √©vacuations¬†: les applis cloud peuvent √©chouer (signal/paiement/comptes).
            VitalGuard AI garde un <strong>petit ‚Äúcerveau‚Äù</strong> sur l‚Äôappareil pour continuer.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Exemples simples</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Centres d‚Äô√©vacuation:</strong> balises sur kits m√©dicaux/g√©n√©rateurs ‚Üí alerte si sortie de zone.</li>
              <li><strong>Recherche & sauvetage:</strong> balises sur personnes/√©quipements ‚Üí savoir ce qui est proche quand la visibilit√© est faible.</li>
              <li><strong>R√©unification familiale:</strong> suivi de proximit√© (pas GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Vie priv√©e & RGPD</div>
          <div class="tip-body">
            Pas de comptes, pas d‚Äôanalytics, pas de cloud. Donn√©es locales, effa√ßables √† tout moment. Export uniquement sur action.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Limitation importante</div>
          <div class="tip-body">
            Le RSSI Bluetooth est bruit√© (murs, foule). Utilisez les zones comme <em>indications</em>, pas des m√®tres exacts.
            D√©mo non certifi√©e pour un usage vital.
          </div>
        </div>
      `,
      'zh-TW': `
        <div class="tip-card info">
          <div class="tip-title">‰Ω†Ê≠£Âú®ÁúãÁöÑÂÖßÂÆπ</div>
          <div class="tip-body">
            ÈÄôÊòØ‰∏ÄÂÄã <strong>ÊäÄË°ìÁ§∫ÁØÑ</strong>„ÄÇ‰ªãÈù¢ÂàªÊÑèÂÅöÊàê„ÄåÂØµÁâ©ÂÆâÂÖ®ÁâΩÁπ©„ÄçÊòØÂõ†ÁÇ∫ÂÆÉÊúÄÊôÆÈÅç‰∏î‰∏çÂÖ∑Áà≠Ë≠∞Ôºõ
            ‰ΩÜÊ†∏ÂøÉÂÖ∂ÂØ¶ÊòØÂú®Â±ïÁ§∫ <strong>Èõ¢Á∑ö„ÄÅÂèØÊïëÂëΩÁöÑ AI ÂºïÊìé</strong>„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2 ÂàÜÈêòÁ§∫ÁØÑÊµÅÁ®ã</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Ê∫ñÂÇô‰æøÂÆúÁöÑ BLE Èò≤‰∏üÈë∞ÂåôÂúàÔºàÂ∏∏Ë¶ãÈóúÈçµÂ≠ó <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>Ôºâ„ÄÇ</li>
              <li>Home ‚Üí <strong>Êñ∞Â¢ûÁ§∫ÁØÑÊ®ôÁ±§</strong> ‚Üí ‰æùÁ≤æÈùàÊµÅÁ®ãÔºàÈù†Ëøë‚ÜíËµ∞ÈÅ†‚ÜíÂëΩÂêçÔºâ„ÄÇ</li>
              <li>ÈñãÂßãÁõ£Ê∏¨ÔºåËßÄÂØü SAFE ‚Üí CAUTION ‚Üí WARNING ‰æùËøëË∑ùÈõ¢ËÆäÂåñ„ÄÇ</li>
              <li>Ê∏¨Ë©¶ SOSÔºöÁî¢ÁîüÈõ¢Á∑ö QR ÂêçÁâáËàáÈü≥Ë®ä‰ø°Ê®ô„ÄÇ</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã ÁÇ∫‰ªÄÈ∫ºÁÅΩÂÆ≥ÊÉÖÂ¢ÉÈúÄË¶ÅÈõ¢Á∑ö</div>
        <div class="tip-card warn">
          <div class="tip-title">Áï∂Á∂≤Ë∑ØÂ§±Êïà</div>
          <div class="tip-body">
            Â±±ÁÅ´„ÄÅÂúüÁü≥ÊµÅ„ÄÅÊµ∑ÂòØ„ÄÅÂ§ßË¶èÊ®°Êí§Èõ¢ÊôÇÔºåÈõ≤Á´Ø App ÂèØËÉΩÂ§±ÊïàÔºàÁÑ°Ë®äËôü/ÁÑ°Èõª/ÁÑ°Â∏≥Ëôü/ÁÑ°‰ªòÊ¨æÔºâ„ÄÇ
            VitalGuard AI Êää <strong>Â∞èÂûãÈõ¢Á∑öÂ§ßËÖ¶</strong> ÊîæÂú®Ë£ùÁΩÆÂÖßÔºåÊâÄ‰ª•Á§∫ÁØÑ‰ªçËÉΩÈÅã‰Ωú„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ÂÆπÊòìÁêÜËß£ÁöÑÈÉ®ÁΩ≤‰æãÂ≠ê</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ÈÅøÈõ£‰∏≠ÂøÉ:</strong> ÈÜ´ÁôÇÂåÖ/ÁôºÈõªÊ©üË≤º BLE Ê®ôÁ±§ ‚Üí Ë∂ÖÂá∫ÂçÄÂüüÂ∞±Ë≠¶Á§∫„ÄÇ</li>
              <li><strong>ÊêúÊïë:</strong> ‰∫∫Âì°/Ë£ùÂÇôË≤ºÊ®ôÁ±§ ‚Üí Ë¶ñÁ∑öÂ∑ÆÊôÇÂø´ÈÄüÁü•ÈÅì„ÄåÈôÑËøëÊúâ‰ªÄÈ∫º„Äç„ÄÇ</li>
              <li><strong>ÂÆ∂Â±¨ÈáçËÅö:</strong> Áõ£Ê∏¨‰øùË≠∑ËÄÖËàáÂ≠©Á´•ÁöÑËøëË∑ùÈõ¢ÔºàÈùû GPSÔºâ„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Èö±ÁßÅËàá GDPR</div>
          <div class="tip-body">
            ÁÑ°Â∏≥Ëôü„ÄÅÁÑ°ÂàÜÊûê„ÄÅÁÑ°Èõ≤Á´ØÂëºÂè´„ÄÇË≥áÊñôÂè™Âú®Êú¨Ê©üÔºåÂèØÈö®ÊôÇÂà™Èô§ÔºõÂåØÂá∫Âè™Âú®‰Ω†Êåâ‰∏ãÊåâÈàïÊôÇÁôºÁîü„ÄÇ
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ÈáçË¶ÅÈôêÂà∂</div>
          <div class="tip-body">
            ËóçÁâô RSSI ÊúÉÂèóÁâÜÂ£Å/‰∫∫ÊΩÆ/Âè£Ë¢ãÂΩ±ÈüøËÄåÂ§ßÂπÖÊ≥¢Âãï„ÄÇË´ãÊääÂçÄÂüüÁï∂‰Ωú <em>Ë®äËôü</em> ËÄåÈùûÁ≤æÊ∫ñÂÖ¨Â∞∫„ÄÇ
            ÈÄôÊòØÁ§∫ÁØÑÔºåÈùûÁîüÂëΩÈóúÈçµË™çË≠âË®≠ÂÇô„ÄÇ
          </div>
        </div>
      `,
      es: `
        <div class="tip-card info">
          <div class="tip-title">Qu√© est√°s viendo</div>
          <div class="tip-body">
            Esto es una <strong>demostraci√≥n tecnol√≥gica</strong>. La interfaz ‚ÄúCorrea de seguridad‚Äù es neutral y f√°cil de entender,
            pero el motor est√° pensado para <strong>escenarios offline que salvan vidas</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Demo en 2 minutos</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Consigue una etiqueta BLE barata (a menudo <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home ‚Üí <strong>A√±adir etiqueta</strong> ‚Üí asistente (cerca ‚Üí al√©jate ‚Üí n√≥mbrala).</li>
              <li>Inicia la monitorizaci√≥n y observa SAFE ‚Üí CAUTION ‚Üí WARNING seg√∫n la proximidad.</li>
              <li>Prueba SOS: QR sin conexi√≥n + baliza de audio.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">üåã Por qu√© el modo offline importa</div>
        <div class="tip-card warn">
          <div class="tip-title">Cuando falla la red</div>
          <div class="tip-body">
            Incendios, deslizamientos, tsunamis y evacuaciones: las apps en la nube pueden fallar (sin se√±al, sin energ√≠a, sin cuentas).
            VitalGuard AI mantiene un <strong>peque√±o ‚Äúcerebro‚Äù offline</strong> en el dispositivo para seguir funcionando.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ejemplos f√°ciles</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Centros de evacuaci√≥n:</strong> etiquetas en kits m√©dicos/generadores ‚Üí alerta si salen de una zona.</li>
              <li><strong>B√∫squeda y rescate:</strong> etiquetas en personas/equipo ‚Üí saber qu√© est√° cerca con poca visibilidad.</li>
              <li><strong>Reunificaci√≥n familiar:</strong> monitorizaci√≥n de proximidad (no GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Privacidad y GDPR</div>
          <div class="tip-body">
            Sin cuentas, sin anal√≠ticas, sin nube. Datos locales y borrables. Exportaci√≥n solo cuando t√∫ lo decides.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Limitaci√≥n importante</div>
          <div class="tip-body">
            El RSSI Bluetooth es ruidoso (paredes, gente). Usa las zonas como <em>se√±ales</em>, no metros exactos.
            Demo no certificada para uso cr√≠tico.
          </div>
        </div>
      `
    },

    help: {
      en: `
        <h2 style="margin-bottom:12px">üìñ Quick Start (for non‚Äëtechnical audiences)</h2>

        <div class="tip-card info">
          <div class="tip-title">Why this demo looks like ‚ÄúPet Safety Leash‚Äù</div>
          <div class="tip-body">
            To test how flawlessly the offline AI engine and BLE proximity system perform in everyday environments, I initially built the prototype skinned as a ‚ÄúPet Safety Leash‚Äù ‚Äî the most universal and harmless use case.
            <br><br>
            The same engine can be re‚Äëskinned for evacuation, search & rescue, and humanitarian field operations.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) What you need</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> is recommended.<br>
            Get a cheap BLE key‚Äëfinder tag (keywords: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti‚Äëlost BLE</span>).<br>
            For best reliability, run via <span class="kbd">https://</span> or <span class="kbd">localhost</span> (not all browsers allow BLE from file://).
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Register a demo tag</div>
          <div class="tip-body">
            Home ‚Üí <strong>Add Demo Tag</strong>.<br>
            The wizard asks you to (A) hold the tag near the phone, then (B) move it away.
            This helps the app identify the right tag in crowded BLE environments.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Start monitoring</div>
          <div class="tip-body">
            Tap <strong>Start</strong>. You will see a zone such as SAFE / CAUTION / WARNING.
            The ‚ÄúAI‚Äù is not a giant model ‚Äî it is a set of compact algorithms that:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>smooth noisy signals (Kalman filter),</li>
              <li>stabilize decisions to prevent alert spam (hysteresis + anti‚Äëflapping),</li>
              <li>optionally learn locally from feedback (lightweight learning modules).</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">What this is NOT</div>
          <div class="tip-body">
            This is <strong>not GPS</strong>. Bluetooth proximity works best within tens of meters and is affected by walls, bodies, metal, and pockets.
            Treat it as a <strong>signal</strong> that helps decisions when internet/phones are unreliable.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Emergency demo</h3>
        <div class="tip-card info">
          <div class="tip-title">Offline QR + audio beacon</div>
          <div class="tip-body">
            SOS mode can generate an <strong>offline QR contact card</strong> and play a loud <strong>audio beacon</strong>.
            This is a demo of ‚Äúresilience primitives‚Äù: simple tools that still work during blackouts or severe network disruptions.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí Privacy / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">No data collection</div>
          <div class="tip-body">
            VitalGuard AI does not send telemetry, analytics, or personal data to any server. Data stays on the device.
            You can export/backup only by explicit user action, and you can erase everything at any time.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Safety note</div>
          <div class="tip-body">
            This is a technical demonstration. Do not use as the sole tool for life‚Äëcritical decisions.
          </div>
        </div>
      `,
      ko: `
        <h2 style="margin-bottom:12px">üìñ Îπ†Î•∏ ÏÇ¨Ïö©Î≤ï (ÎπÑÏ†ÑÎ¨∏Í∞ÄÏö©)</h2>

        <div class="tip-card info">
          <div class="tip-title">Ïôú ‚ÄúÍ∞ïÏïÑÏßÄ ÏïàÏ†Ñ Î™©Ï§Ñ‚ÄùÏ≤òÎüº Î≥¥Ïù¥ÎÇòÏöî?</div>
          <div class="tip-body">
            Ïò§ÌîÑÎùºÏù∏ AI ÏóîÏßÑÍ≥º BLE Í∑ºÏ†ë ÏãúÏä§ÌÖúÍ∞Ä ÏùºÏÉÅ ÌôòÍ≤ΩÏóêÏÑú ÏñºÎßàÎÇò ÏïàÏ†ïÏ†ÅÏúºÎ°ú ÎèôÏûëÌïòÎäîÏßÄ ÏãúÌóòÌïòÍ∏∞ ÏúÑÌï¥,
            Í∞ÄÏû• Î≥¥Ìé∏Ï†ÅÏù¥Í≥† Î¨¥Ìï¥Ìïú ÏÇ¨Î°ÄÏù∏ ‚ÄúÍ∞ïÏïÑÏßÄ ÏïàÏ†Ñ Î™©Ï§Ñ(Pet Safety Leash)‚Äù Ïä§ÌÇ®ÏúºÎ°ú ÌîÑÎ°úÌÜ†ÌÉÄÏûÖÏùÑ ÎßåÎì§ÏóàÏäµÎãàÎã§.
            <br><br>
            Í∞ôÏùÄ ÏóîÏßÑÏùÑ ÎåÄÌîº/ÏàòÏÉâ¬∑Íµ¨Ï°∞/Ïù∏ÎèÑÏ£ºÏùò ÌòÑÏû• Ïö¥ÏòÅÏö©ÏúºÎ°ú ÏâΩÍ≤å Ïû¨Ìè¨Ïû•(Ïä§ÌÇ® Î≥ÄÍ≤Ω)Ìï† Ïàò ÏûàÏäµÎãàÎã§.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) Ï§ÄÎπÑÎ¨º</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> Í∂åÏû•.<br>
            Ï†ÄÍ∞Ä BLE ÌÇ§ÌååÏù∏Îçî ÌÉúÍ∑∏ Ï§ÄÎπÑ (Í≤ÄÏÉâÏñ¥: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti‚Äëlost BLE</span>).<br>
            BLE ÏïàÏ†ïÏÑ±ÏùÑ ÏúÑÌï¥ <span class="kbd">https://</span> ÎòêÎäî <span class="kbd">localhost</span> Ïã§ÌñâÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Îç∞Î™® ÌÉúÍ∑∏ Îì±Î°ù</div>
          <div class="tip-body">
            Home ‚Üí <strong>Îç∞Î™® ÌÉúÍ∑∏ Ï∂îÍ∞Ä</strong>.<br>
            ÏúÑÏûêÎìúÎäî (A) ÌÉúÍ∑∏Î•º Í∞ÄÍπåÏù¥ ÎåÄÍ∏∞ ‚Üí (B) Î©ÄÎ¶¨ Ïù¥ÎèôÌïòÍ∏∞Î•º ÏöîÏ≤≠Ìï©ÎãàÎã§.
            Ï£ºÎ≥Ä BLE Í∏∞Í∏∞Í∞Ä ÎßéÏùÑ ÎïåÎèÑ ‚ÄúÎÇ¥ ÌÉúÍ∑∏‚ÄùÎ•º Ï∞æÍ∏∞ ÏúÑÌïú Ï†àÏ∞®ÏûÖÎãàÎã§.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë</div>
          <div class="tip-body">
            <strong>Start</strong>Î•º ÎàÑÎ•¥Î©¥ SAFE / CAUTION / WARNING Í∞ôÏùÄ Ï°¥Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.
            Ïó¨Í∏∞ÏÑú ÎßêÌïòÎäî ‚ÄúAI‚ÄùÎäî Í±∞ÎåÄÌïú Î™®Îç∏Ïù¥ ÏïÑÎãàÎùº, ÏûëÏùÄ ÏïåÍ≥†Î¶¨Ï¶ò Î¨∂ÏùåÏûÖÎãàÎã§:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>ÎÖ∏Ïù¥Ï¶à Ïã†Ìò∏Î•º Î∂ÄÎìúÎüΩÍ≤å(ÏπºÎßå ÌïÑÌÑ∞),</li>
              <li>ÏïåÎ¶º Ìè≠Ï£º Î∞©ÏßÄ(ÌûàÏä§ÌÖåÎ¶¨ÏãúÏä§ + ÌîåÎûòÌïë ÏñµÏ†ú),</li>
              <li>ÏõêÌïòÎ©¥ ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞±ÏùÑ Î°úÏª¨ÏóêÏÑú ÌïôÏäµ(Í≤ΩÎüâ ÌïôÏäµ Î™®Îìà).</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ïù¥Í≤ÉÏùÄ Î¨¥ÏóáÏù¥ ‚ÄúÏïÑÎãåÍ∞Ä‚Äù</div>
          <div class="tip-body">
            <strong>GPSÍ∞Ä ÏïÑÎãôÎãàÎã§.</strong> BLE Í∑ºÏ†ëÏùÄ ÏàòÏã≠ ÎØ∏ÌÑ∞ ÎÇ¥ÏóêÏÑú Ïú†Ïö©ÌïòÏßÄÎßå, Î≤Ω/ÏÇ¨Îûå/Í∏àÏÜç/Ï£ºÎ®∏ÎãàÏóê ÌÅ¨Í≤å ÏòÅÌñ•ÏùÑ Î∞õÏäµÎãàÎã§.
            ‚ÄúÏ†ïÎãµ‚ÄùÏù¥ ÏïÑÎãàÎùº <strong>Ï∞∏Í≥† Ïã†Ìò∏</strong>Î°ú ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Í∏¥Í∏â Îç∞Î™®</h3>
        <div class="tip-card info">
          <div class="tip-title">Ïò§ÌîÑÎùºÏù∏ QR + Ïò§ÎîîÏò§ ÎπÑÏΩò</div>
          <div class="tip-body">
            SOS Î™®ÎìúÎäî <strong>Ïò§ÌîÑÎùºÏù∏ QR Ïó∞ÎùΩ Ïπ¥Îìú</strong>Î•º ÎßåÎì§Í≥†, ÌÅ∞ ÏÜåÎ¶¨Ïùò <strong>Ïò§ÎîîÏò§ ÎπÑÏΩò</strong>ÏùÑ Ïû¨ÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
            Ï†ïÏ†Ñ/ÌÜµÏã†Ïû•Ïï† ÏÉÅÌô©ÏóêÏÑúÎèÑ ÎèôÏûëÌïòÎäî ‚ÄúÎ≥µÏõêÎ†•(Resilience) Í∏∞Î≥∏ ÎèÑÍµ¨‚Äù ÏãúÏó∞ÏûÖÎãàÎã§.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí Í∞úÏù∏Ï†ïÎ≥¥ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏóÜÏùå</div>
          <div class="tip-body">
            VitalGuard AIÎäî ÏÑúÎ≤ÑÎ°ú ÌÖîÎ†àÎ©îÌä∏Î¶¨/Î∂ÑÏÑù/Í∞úÏù∏Ï†ïÎ≥¥Î•º Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÏäµÎãàÎã§. Î™®Îì† Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Í∏∞ÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§.
            Î∞±ÏóÖ/ÎÇ¥Î≥¥ÎÇ¥Í∏∞Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ ÎïåÎßå ÏàòÌñâÎêòÎ©∞, Ïñ∏Ï†úÎì† Ï†ÑÏ≤¥ ÏÇ≠Ï†úÍ∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ÏïàÏ†Ñ Ï£ºÏùò</div>
          <div class="tip-body">
            Î≥∏ ÌååÏùºÏùÄ Í∏∞Ïà† ÏãúÏó∞Ïö©ÏûÖÎãàÎã§. ÏÉùÎ™Ö‚ÄëÏïàÏ†Ñ ÏùòÏÇ¨Í≤∞Ï†ïÏùò Ïú†ÏùºÌïú ÎèÑÍµ¨Î°ú ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
          </div>
        </div>
      `,
      ar: `
        <h2 style="margin-bottom:12px">üìñ ÿ®ÿØÿ° ÿ≥ÿ±Ÿäÿπ (ŸÑÿ∫Ÿäÿ± ÿßŸÑŸÖÿÆÿ™ÿµŸäŸÜ)</h2>

        <div class="tip-card info">
          <div class="tip-title">ŸÑŸÖÿßÿ∞ÿß ÿ™ÿ®ÿØŸà ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÉŸÄ ‚ÄúŸÖŸÇŸàÿØ ÿ£ŸÖÿßŸÜ ŸÑŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™‚Äùÿü</div>
          <div class="tip-body">
            ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ£ÿØÿßÿ° ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸàŸÜÿ∏ÿßŸÖ ÿßŸÑŸÇÿ±ÿ® BLE ŸÅŸä ÿßŸÑÿ≠Ÿäÿßÿ© ÿßŸÑŸäŸàŸÖŸäÿ©ÿå ÿ™ŸÖ ÿ™ŸÇÿØŸäŸÖŸá ÿ®Ÿàÿßÿ¨Ÿáÿ© ‚ÄúŸÖŸÇŸàÿØ ÿ£ŸÖÿßŸÜ ŸÑŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™‚Äù ŸÑÿ£ŸÜŸáÿß ÿ≠ÿßŸÑÿ© ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπÿßŸÖÿ© Ÿàÿ∫Ÿäÿ± ÿ≠ÿ≥ÿßÿ≥ÿ©.
            <br><br>
            ŸàŸäŸÖŸÉŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ÿ±ŸÉ ŸÜŸÅÿ≥Ÿá ŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ•ÿ¨ŸÑÿßÿ° ŸàÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ•ŸÜŸÇÿßÿ∞ ŸàÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜŸäÿ© ÿßŸÑŸÖŸäÿØÿßŸÜŸäÿ©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) ÿßŸÑŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™</div>
          <div class="tip-body">
            ŸäŸàÿµŸâ ÿ®ŸÄ <strong>Android + Chrome</strong>.<br>
            ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿπŸÑÿßŸÖÿ© BLE ÿ±ÿÆŸäÿµÿ© (ŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´: <span class="kbd">iTag</span>ÿå <span class="kbd">Key Finder</span>ÿå <span class="kbd">Anti‚Äëlost BLE</span>).<br>
            ŸÑÿ£ŸÅÿ∂ŸÑ ŸÖŸàÿ´ŸàŸÇŸäÿ© ÿßÿ≥ÿ™ÿÆÿØŸÖ <span class="kbd">https://</span> ÿ£Ÿà <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÑÿßŸÖÿ©</div>
          <div class="tip-body">
            Home ‚Üí <strong>ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÑŸÑÿπÿ±ÿ∂</strong>.<br>
            ÿ≥Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ ÿßŸÑŸÖÿπÿßŸÑÿ¨ ÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑÿπŸÑÿßŸÖÿ© ÿ´ŸÖ ÿ•ÿ®ÿπÿßÿØŸáÿß ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿπŸÑŸâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÅŸä ÿ®Ÿäÿ¶ÿßÿ™ BLE ÿßŸÑŸÖÿ≤ÿØÿ≠ŸÖÿ©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©</div>
          <div class="tip-body">
            ÿßÿ∂ÿ∫ÿ∑ <strong>Start</strong>. ÿ≥ÿ™ÿ±Ÿâ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ´ŸÑ SAFE / CAUTION / WARNING.
            ‚ÄúÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä‚Äù ŸáŸÜÿß ŸÑŸäÿ≥ ŸÜŸÖŸàÿ∞ÿ¨Ÿãÿß ÿ∂ÿÆŸÖŸãÿßÿå ÿ®ŸÑ ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿßÿ™ ÿµÿ∫Ÿäÿ±ÿ©:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>ÿ™ŸÜÿπŸäŸÖ ÿßŸÑÿ∂ÿ¨Ÿäÿ¨ (Kalman)ÿå</li>
              <li>ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÇÿ±ÿßÿ± ŸÑŸÖŸÜÿπ ÿßŸÑÿ™ŸÜÿ®ŸäŸá ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± (hysteresis + anti‚Äëflapping)ÿå</li>
              <li>ÿ™ÿπŸÑŸÖ ŸÖÿ≠ŸÑŸä ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ŸÖŸÜ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ŸÖÿß ŸÑŸäÿ≥ ÿπŸÑŸäŸá Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
          <div class="tip-body">
            Ÿáÿ∞ÿß <strong>ŸÑŸäÿ≥ GPS</strong>. ÿßŸÑŸÇÿ±ÿ® ÿπÿ®ÿ± Bluetooth Ÿäÿ™ÿ£ÿ´ÿ± ÿ®ÿßŸÑÿ¨ÿØÿ±ÿßŸÜ ŸàÿßŸÑÿ£ÿ¨ÿ≥ÿßŸÖ ŸàÿßŸÑÿßÿ≤ÿØÿ≠ÿßŸÖ ŸàÿßŸÑÿ¨ŸäŸàÿ®.
            ÿßÿ≥ÿ™ÿÆÿØŸÖŸá ŸÉÿ•ÿ¥ÿßÿ±ÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸàŸÑŸäÿ≥ ŸÉŸÖÿ≥ÿßŸÅÿ© ÿØŸÇŸäŸÇÿ©.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶</h3>
        <div class="tip-card info">
          <div class="tip-title">QR ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ + ŸÖŸÜÿßÿ±ÿ© ÿµŸàÿ™Ÿäÿ©</div>
          <div class="tip-body">
            ŸäŸÖŸÉŸÜ ŸÑŸàÿ∂ÿπ SOS ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© QR ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ Ÿàÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖŸÜÿßÿ±ÿ© ÿµŸàÿ™Ÿäÿ© ÿπÿßŸÑŸäÿ©.
            Ÿáÿ∞ÿß ÿπÿ±ÿ∂ ŸÑÿ£ÿØŸàÿßÿ™ ÿ®ÿ≥Ÿäÿ∑ÿ© ÿ™ÿπŸÖŸÑ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ° ÿ£Ÿà ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí ÿßŸÑÿÆÿµŸàÿµŸäÿ© / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ŸÑÿß ÿ¨ŸÖÿπ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
          <div class="tip-body">
            ŸÑÿß Ÿäÿ±ÿ≥ŸÑ VitalGuard AI ÿ£Ÿä ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ£Ÿà ÿ®ŸäÿßŸÜÿßÿ™ ÿ¥ÿÆÿµŸäÿ© ÿ•ŸÑŸâ ÿÆŸàÿßÿØŸÖ. ŸÉŸÑ ÿ¥Ÿäÿ° Ÿäÿ®ŸÇŸâ ÿπŸÑŸâ ÿßŸÑÿ¨Ÿáÿßÿ≤.
            ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿµÿØŸäÿ± ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿå ŸàŸäŸÖŸÉŸÜ ÿßŸÑÿ≠ÿ∞ŸÅ ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ≥ŸÑÿßŸÖÿ©</div>
          <div class="tip-body">
            Ÿáÿ∞ÿß ÿπÿ±ÿ∂ ÿ™ŸÇŸÜŸä. ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖŸá ŸÉÿ£ÿØÿßÿ© Ÿàÿ≠ŸäÿØÿ© ŸÑŸÇÿ±ÿßÿ±ÿßÿ™ ÿ≠ÿ±ÿ¨ÿ© ŸÑŸÑÿ≠Ÿäÿßÿ©.
          </div>
        </div>
      `,
      ja: `
        <h2 style="margin-bottom:12px">üìñ „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„ÉàÔºàÈùûÊäÄË°ìËÄÖÂêë„ÅëÔºâ</h2>

        <div class="tip-card info">
          <div class="tip-title">„Å™„Åú„Äå„Éö„ÉÉ„ÉàÂÆâÂÖ®„É™„Éº„Éâ„Äç„Å™„ÅÆ„Åã</div>
          <div class="tip-body">
            „Ç™„Éï„É©„Ç§„É≥AI„Ç®„É≥„Ç∏„É≥„Å® BLE ËøëÊé•„Ç∑„Çπ„ÉÜ„É†„ÅÆÂãï‰Ωú„ÇíÊó•Â∏∏Áí∞Â¢É„ÅßÊ§úË®º„Åô„Çã„Åü„ÇÅ„ÄÅÊúÄ„ÇÇÊôÆÈÅçÁöÑ„ÅßÁÑ°ÂÆ≥„Å™‰æã„Å®„Åó„Å¶„Äå„Éö„ÉÉ„ÉàÂÆâÂÖ®„É™„Éº„Éâ„Äç„Çπ„Ç≠„É≥„Åß‰Ωú„Çä„Åæ„Åó„Åü„ÄÇ
            <br><br>
            Âêå„Åò„Ç®„É≥„Ç∏„É≥„ÅØ„ÄÅÈÅøÈõ£„ÉªÊçúÁ¥¢ÊïëÂä©„Éª‰∫∫ÈÅìÊîØÊè¥„ÅÆÁèæÂ†¥Âêë„Åë„Å´„Çπ„Ç≠„É≥„ÇíÂ§â„Åà„Å¶ÂÜçÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) ÂøÖË¶Å„Å™„ÇÇ„ÅÆ</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> Êé®Â•®„ÄÇ<br>
            ÂÆâ‰æ°„Å™ BLE „Ç≠„Éº„Éï„Ç°„Ç§„É≥„ÉÄ„ÉºÔºàÊ§úÁ¥¢: <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> / <span class="kbd">Anti‚Äëlost BLE</span>Ôºâ„ÄÇ<br>
            „Åß„Åç„Çå„Å∞ <span class="kbd">https://</span> „Åã <span class="kbd">localhost</span> „ÅßÂÆüË°å„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) „Éá„É¢„Çø„Ç∞ÁôªÈå≤</div>
          <div class="tip-body">
            Home ‚Üí <strong>„Éá„É¢„Çø„Ç∞ËøΩÂä†</strong>„ÄÇ<br>
            Ëøë„Å•„Åë„Çã‚ÜíÈõ¢„ÅôÊâãÈ†Ü„Åß„ÄÅÊ∑∑Èõë„Åó„Åü BLE Áí∞Â¢É„Åß„ÇÇÊ≠£„Åó„ÅÑ„Çø„Ç∞„ÇíË¶ãÂàÜ„Åë„ÇÑ„Åô„Åè„Åó„Åæ„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Áõ£Ë¶ñÈñãÂßã</div>
          <div class="tip-body">
            <strong>Start</strong> „ÇíÊäº„Åô„Å® SAFE / CAUTION / WARNING „ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
            „Åì„Åì„Åß„ÅÆ ‚ÄúAI‚Äù „ÅØÂ∑®Â§ß„É¢„Éá„É´„Åß„ÅØ„Å™„Åè„ÄÅÂ∞è„Åï„Å™„Ç¢„É´„Ç¥„É™„Ç∫„É†Áæ§„Åß„ÅôÔºö
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>„Éé„Ç§„Ç∫„ÇíÂπ≥ÊªëÂåñÔºàKalmanÔºâ„ÄÅ</li>
              <li>Âà§Êñ≠„ÇíÂÆâÂÆöÂåñ„Åó„Å¶„Ç¢„É©„Éº„Éà‰π±Áô∫„ÇíÈò≤„ÅêÔºà„Éí„Çπ„ÉÜ„É™„Ç∑„ÇπÔºã„Éï„É©„ÉÉ„Éî„É≥„Ç∞ÊäëÂà∂Ôºâ„ÄÅ</li>
              <li>ÂøÖË¶Å„Å´Âøú„Åò„Å¶Á´ØÊú´ÂÜÖ„ÅßÂ≠¶ÁøíÔºàËªΩÈáèÂ≠¶ÁøíÔºâ„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">„Åì„Çå„ÅØ GPS „Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
          <div class="tip-body">
            Bluetooth ËøëÊé•„ÅØÂ£Å„ÇÑ‰∫∫Ê∑∑„Åø„ÅßÂ§ß„Åç„ÅèÂ§âÂãï„Åó„Åæ„Åô„ÄÇË∑ùÈõ¢„ÅÆ‚ÄúÊ≠£Á¢∫„Åï‚Äù„Åß„ÅØ„Å™„Åè„ÄÅÂà§Êñ≠„ÅÆ„Åü„ÇÅ„ÅÆ <strong>ÁõÆÂÆâ</strong> „Å®„Åó„Å¶Êâ±„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Á∑äÊÄ•„Éá„É¢</h3>
        <div class="tip-card info">
          <div class="tip-title">„Ç™„Éï„É©„Ç§„É≥ QR + Èü≥„Éì„Éº„Ç≥„É≥</div>
          <div class="tip-body">
            SOS „Åß„ÅØ„Ç™„Éï„É©„Ç§„É≥ QR ÈÄ£Áµ°„Ç´„Éº„Éâ„ÇíÁîüÊàê„Åó„ÄÅÂ§ßÈü≥Èáè„ÅÆÈü≥„Éì„Éº„Ç≥„É≥„ÇíÂÜçÁîü„Åß„Åç„Åæ„Åô„ÄÇ
            ÂÅúÈõª„ÇÑ„Éç„ÉÉ„ÉàÈöúÂÆ≥„Åß„ÇÇÂãï„Åè ‚Äú„É¨„Ç∏„É™„Ç®„É≥„ÇπË¶ÅÁ¥†‚Äù „ÅÆ„Éá„É¢„Åß„Åô„ÄÇ
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí „Éó„É©„Ç§„Éê„Ç∑„Éº / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">„Éá„Éº„ÇøÂèéÈõÜ„Å™„Åó</div>
          <div class="tip-body">
            VitalGuard AI „ÅØ„Çµ„Éº„Éê„Éº„Å∏„ÉÜ„É¨„É°„Éà„É™„Éº/Ëß£Êûê/ÂÄã‰∫∫ÊÉÖÂ†±„ÇíÈÄÅ‰ø°„Åó„Åæ„Åõ„Çì„ÄÇ„Éá„Éº„Çø„ÅØÁ´ØÊú´ÂÜÖ„ÅÆ„Åø„ÄÇ
            „Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅØ„Éú„Çø„É≥Êìç‰ΩúÊôÇ„ÅÆ„Åø„Åß„ÄÅ„ÅÑ„Å§„Åß„ÇÇÂÖ®Ê∂àÂéª„Åß„Åç„Åæ„Åô„ÄÇ
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ÂÆâÂÖ®‰∏ä„ÅÆÊ≥®ÊÑè</div>
          <div class="tip-body">
            Êú¨„Éï„Ç°„Ç§„É´„ÅØÊäÄË°ì„Éá„É¢„Åß„Åô„ÄÇÁîüÂëΩ„Å´Èñ¢„Çè„ÇãÂà§Êñ≠„ÅÆÂîØ‰∏Ä„ÅÆÊâãÊÆµ„Å®„Åó„Å¶‰ΩøÁî®„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
          </div>
        </div>
      `,
      fr: `
        <h2 style="margin-bottom:12px">üìñ D√©marrage rapide (public non technique)</h2>

        <div class="tip-card info">
          <div class="tip-title">Pourquoi ‚ÄúLaisse de s√©curit√©‚Äù ?</div>
          <div class="tip-body">
            Pour tester le moteur IA hors ligne et la syst√®me de proximit√© BLE en conditions r√©elles, le prototype est habill√© en ‚ÄúLaisse de s√©curit√©‚Äù ‚Äî un cas d‚Äôusage universel et neutre.
            <br><br>
            Le m√™me moteur peut √™tre r√©habill√© pour l‚Äô√©vacuation, la recherche‚Äësauvetage et les op√©rations humanitaires.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) Ce qu‚Äôil faut</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> recommand√©.<br>
            Balise BLE bon march√© (mots‚Äëcl√©s¬†: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti‚Äëlost BLE</span>).<br>
            Pour plus de fiabilit√©, ex√©cuter via <span class="kbd">https://</span> ou <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Enregistrer une balise</div>
          <div class="tip-body">
            Home ‚Üí <strong>Ajouter une balise</strong>.<br>
            L‚Äôassistant demande de rapprocher puis d‚Äô√©loigner la balise pour l‚Äôidentifier dans un environnement BLE charg√©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Lancer le suivi</div>
          <div class="tip-body">
            Appuyez sur <strong>Start</strong>. Vous verrez SAFE / CAUTION / WARNING.
            Ici, ‚ÄúIA‚Äù = algorithmes compacts :
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>lisser le signal (Kalman),</li>
              <li>stabiliser les d√©cisions (hyst√©r√©sis + anti‚Äëflapping),</li>
              <li>apprentissage local optionnel.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ce n‚Äôest pas du GPS</div>
          <div class="tip-body">
            Le RSSI Bluetooth est bruit√©. Utilisez les zones comme <strong>indications</strong>, pas comme une distance exacte.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Urgence</h3>
        <div class="tip-card info">
          <div class="tip-title">QR hors ligne + balise audio</div>
          <div class="tip-body">
            Le mode SOS peut g√©n√©rer une carte QR hors ligne et jouer une balise sonore.
            D√©monstration de primitives simples qui fonctionnent pendant une panne.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí Vie priv√©e / RGPD</h3>
        <div class="tip-card info">
          <div class="tip-title">Aucune collecte</div>
          <div class="tip-body">
            VitalGuard AI n‚Äôenvoie pas de t√©l√©m√©trie/analytics/donn√©es personnelles. Tout reste sur l‚Äôappareil.
            Export uniquement sur action explicite, suppression possible √† tout moment.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Note de s√©curit√©</div>
          <div class="tip-body">
            D√©mo technique. Ne pas utiliser comme seul outil pour des d√©cisions vitales.
          </div>
        </div>
      `,
      'zh-TW': `
        <h2 style="margin-bottom:12px">üìñ Âø´ÈÄü‰∏äÊâãÔºàÈùûÊäÄË°ì‰∫∫Âì°Ôºâ</h2>

        <div class="tip-card info">
          <div class="tip-title">ÁÇ∫‰ªÄÈ∫ºÁúãËµ∑‰æÜÂÉè„ÄåÂØµÁâ©ÂÆâÂÖ®ÁâΩÁπ©„ÄçÔºü</div>
          <div class="tip-body">
            ÁÇ∫‰∫ÜÂú®Êó•Â∏∏Áí∞Â¢ÉÊ∏¨Ë©¶Èõ¢Á∑ö AI ÂºïÊìéËàá BLE ËøëË∑ùÈõ¢Á≥ªÁµ±ÁöÑÁ©©ÂÆöÊÄßÔºåÂéüÂûãÂÖà‰ª•„ÄåÂØµÁâ©ÂÆâÂÖ®ÁâΩÁπ©„ÄçÂëàÁèæ‚Äî‚ÄîÊúÄÊôÆÈÅç‰∏îÁÑ°ÂÆ≥ÁöÑÊÉÖÂ¢É„ÄÇ
            <br><br>
            Âêå‰∏ÄÂ•óÂºïÊìé‰πüËÉΩÈÄèÈÅéÊèõÁöÆÔºåÂø´ÈÄüÊîπÊàêÊí§Èõ¢„ÄÅÊêúÊïëËàá‰∫∫ÈÅìÁèæÂ†¥‰ΩúÊ•≠Áî®ÈÄî„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) ‰Ω†ÈúÄË¶Å‰ªÄÈ∫º</div>
          <div class="tip-body">
            Âª∫Ë≠∞‰ΩøÁî® <strong>Android + Chrome</strong>„ÄÇ<br>
            Ê∫ñÂÇô‰æøÂÆúÁöÑ BLE Èò≤‰∏üÈë∞ÂåôÂúàÔºàÊêúÂ∞ãÔºö<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> / <span class="kbd">Anti‚Äëlost BLE</span>Ôºâ„ÄÇ<br>
            ÁÇ∫‰∫ÜÊõ¥Á©©ÂÆöÔºåÂª∫Ë≠∞Âú® <span class="kbd">https://</span> Êàñ <span class="kbd">localhost</span> Âü∑Ë°å„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Ë®ªÂÜäÁ§∫ÁØÑÊ®ôÁ±§</div>
          <div class="tip-body">
            Home ‚Üí <strong>Êñ∞Â¢ûÁ§∫ÁØÑÊ®ôÁ±§</strong>„ÄÇ<br>
            Á≤æÈùàÊúÉË¶ÅÊ±ÇÂÖàÈù†ËøëÂÜçËµ∞ÈÅ†ÔºåÁî®‰æÜÂú® BLE ÂæàÊìÅÊì†ÁöÑÁí∞Â¢É‰∏≠ÊâæÂà∞Ê≠£Á¢∫ÁöÑÊ®ôÁ±§„ÄÇ
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) ÈñãÂßãÁõ£Ê∏¨</div>
          <div class="tip-body">
            Êåâ‰∏ã <strong>Start</strong> ÂæåÊúÉÁúãÂà∞ SAFE / CAUTION / WARNING„ÄÇ
            ÈÄôË£°ÁöÑ ‚ÄúAI‚Äù ‰∏çÊòØÂ∑®Â§ßÊ®°ÂûãÔºåËÄåÊòØÂ∞èÂûãÊºîÁÆóÊ≥ïÁµÑÂêàÔºö
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>Âπ≥ÊªëÈõúË®äÔºàKalmanÔºâ„ÄÅ</li>
              <li>Á©©ÂÆöÂà§Êñ∑ÈÅøÂÖçÁãÇË∑≥ÔºàÈÅ≤ÊªØ + Èò≤ÊäñÔºâ„ÄÅ</li>
              <li>ÂèØÈÅ∏ÔºöÂú®Êú¨Ê©üÂæûÂõûÈ•ãÂ≠∏Áøí„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ÈÄô‰∏çÊòØ GPS</div>
          <div class="tip-body">
            ËóçÁâô RSSI ÊúÉÂèóÁâÜÂ£Å„ÄÅ‰∫∫Áæ§„ÄÅÂè£Ë¢ãÂΩ±Èüø„ÄÇË´ãÊääÂçÄÂüüÁï∂‰Ωú <strong>ÊåáÊ®ô</strong>Ôºå‰∏çË¶ÅË¶ñÁÇ∫Á≤æÊ∫ñË∑ùÈõ¢„ÄÇ
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Á∑äÊÄ•Á§∫ÁØÑ</h3>
        <div class="tip-card info">
          <div class="tip-title">Èõ¢Á∑ö QR + Èü≥Ë®ä‰ø°Ê®ô</div>
          <div class="tip-body">
            SOS ÂèØÁî¢ÁîüÈõ¢Á∑ö QR ËÅØÁµ°Âç°‰∏¶Êí≠ÊîæÈ´òÂàÜË≤ùÈü≥Ë®ä‰ø°Ê®ô„ÄÇÈÄôÊòØÂú®Â±ïÁ§∫ÂÅúÈõª/Êñ∑Á∂≤ÊôÇ‰ªçÂèØÁî®ÁöÑÂü∫Á§éÂ∑•ÂÖ∑„ÄÇ
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí Èö±ÁßÅ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">‰∏çÊî∂ÈõÜË≥áÊñô</div>
          <div class="tip-body">
            VitalGuard AI ‰∏çÊúÉÊää‰ªª‰ΩïÂàÜÊûêÊàñÂÄãË≥áÈÄÅÂà∞‰º∫ÊúçÂô®„ÄÇË≥áÊñôÂè™Âú®Êú¨Ê©ü„ÄÇ
            ÂåØÂá∫ÂÉÖÂú®‰Ω†Êåâ‰∏ãÊåâÈàïÊôÇÁôºÁîüÔºå‰∏îÂèØÈö®ÊôÇÂÖ®ÈÉ®Âà™Èô§„ÄÇ
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ÂÆâÂÖ®ÊèêÈÜí</div>
          <div class="tip-body">
            ÈÄôÊòØÊäÄË°ìÁ§∫ÁØÑÔºåË´ãÂãø‰ΩúÁÇ∫ÁîüÂëΩÈóúÈçµÊ±∫Á≠ñÁöÑÂîØ‰∏ÄÂ∑•ÂÖ∑„ÄÇ
          </div>
        </div>
      `,
      es: `
        <h2 style="margin-bottom:12px">üìñ Inicio r√°pido (para no t√©cnicos)</h2>

        <div class="tip-card info">
          <div class="tip-title">Por qu√© parece una ‚Äúcorrea para mascotas‚Äù</div>
          <div class="tip-body">
            Para probar el motor de IA offline y la sistema de proximidad BLE en entornos cotidianos, el prototipo se mostr√≥ como ‚ÄúCorrea de seguridad para mascotas‚Äù, el caso m√°s universal y neutro.
            <br><br>
            El mismo motor puede ‚Äúcambiar de piel‚Äù para evacuaci√≥n, b√∫squeda y rescate, y operaciones humanitarias.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) Qu√© necesitas</div>
          <div class="tip-body">
            Recomendado: <strong>Android + Chrome</strong>.<br>
            Etiqueta BLE barata (busca: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti‚Äëlost BLE</span>).<br>
            Para mayor fiabilidad, ejecuta con <span class="kbd">https://</span> o <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Registrar una etiqueta</div>
          <div class="tip-body">
            Home ‚Üí <strong>A√±adir etiqueta</strong>.<br>
            El asistente te pide acercar y luego alejar la etiqueta para identificarla en entornos BLE con mucho ruido.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Iniciar la monitorizaci√≥n</div>
          <div class="tip-body">
            Pulsa <strong>Start</strong>. Ver√°s SAFE / CAUTION / WARNING.
            Aqu√≠ ‚ÄúIA‚Äù significa algoritmos compactos:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>suavizar el ruido (Kalman),</li>
              <li>estabilizar decisiones (hist√©resis + anti‚Äëflapping),</li>
              <li>aprendizaje local opcional.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Esto NO es GPS</div>
          <div class="tip-body">
            El RSSI Bluetooth es ruidoso. Usa las zonas como <strong>se√±ales</strong>, no como distancia exacta.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üö® SOS / Emergencia</h3>
        <div class="tip-card info">
          <div class="tip-title">QR offline + baliza de audio</div>
          <div class="tip-body">
            SOS puede generar una tarjeta QR sin conexi√≥n y reproducir una baliza sonora.
            Es una demo de herramientas simples que funcionan durante apagones.
          </div>
        </div>

        <div class="divider"></div>

        <h3>üîí Privacidad / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Sin recopilaci√≥n de datos</div>
          <div class="tip-body">
            VitalGuard AI no env√≠a anal√≠ticas ni datos personales a servidores. Todo queda en el dispositivo.
            Exportaci√≥n solo con acci√≥n expl√≠cita, borrado disponible en cualquier momento.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Nota de seguridad</div>
          <div class="tip-body">
            Demostraci√≥n t√©cnica. No usar como √∫nica herramienta para decisiones cr√≠ticas.
          </div>
        </div>
      `
    },

    legal: {
      en: `
        <h2 style="margin-bottom:10px">About VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> is a single‚Äëfile, offline‚Äëonly demonstration of a tiny on‚Äëdevice AI engine paired with Bluetooth proximity sensing.</p>
          <p style="margin-top:8px"><strong>Designed for outage conditions:</strong> no internet, no cloud, no accounts, no app store ‚Äî still functional.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">What makes this credible</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Auditable:</strong> one HTML file, no external libraries, no hidden network calls.</li>
              <li><strong>Privacy‚Äëfirst:</strong> zero telemetry. Data stays on the device by default.</li>
              <li><strong>Resilient:</strong> BLE proximity + compact math‚Äëbased AI (filters, decision stability, local learning).</li>
              <li><strong>Deployable:</strong> runs on older Android phones with cheap BLE tags.</li>
              <li><strong>Cooperative search (Rescue Assist):</strong> share an offline ‚ÄúRescue Pack‚Äù so another phone can scan for the same tag.</li>
              <li><strong>Secure exports:</strong> optional encrypted ‚ÄúRescue Pack‚Äù backups for audits/hand‚Äëoff.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>How it works (plain language)</h3>
        <div class="tip-card info">
          <div class="tip-title">1) Listen</div>
          <div class="tip-body">The phone listens for BLE advertisements. Each advertisement includes an RSSI value (signal strength).</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">2) Stabilize</div>
          <div class="tip-body">RSSI is noisy, so the engine filters it and stabilizes zone decisions to avoid ‚Äúalert spam‚Äù.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">3) Act</div>
          <div class="tip-body">When the zone crosses a threshold for long enough, the app can alert, log, and provide SOS primitives (QR, audio).</div>
        </div>

        <div class="divider"></div>

        <h3>Privacy / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">No data collection</div>
          <div class="tip-body">
            The demo does not send analytics or personal data anywhere. Optional exports are user‚Äëinitiated. You can erase everything.
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ethical use</div>
          <div class="tip-body">
            Exclusively for civilian, agricultural, and humanitarian use (privacy‚Äëfirst, local‚Äëonly).
          </div>
        </div>

        <div class="divider"></div>

        <h3>Contact</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Disclaimer</div>
          <div class="tip-body">This is a technology demonstration, not a certified life‚Äëcritical device.</div>
        </div>
      `,
      ko: `
        <h2 style="margin-bottom:10px">VitalGuard AI ÏÜåÍ∞ú</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong>Îäî ‚ÄúÎã®Ïùº HTML ÌååÏùº‚Äù ÏïàÏóêÏÑú ÎèôÏûëÌïòÎäî <strong>Ïò§ÌîÑÎùºÏù∏ AI ÏóîÏßÑ + Î∏îÎ£®Ìà¨Ïä§ Í∑ºÏ†ë</strong> Í∏∞Ïà† ÏãúÏó∞ÏûÖÎãàÎã§.</p>
          <p style="margin-top:8px"><strong>Ïò§ÌîÑÍ∑∏Î¶¨Îìú(Off‚Äëgrid)¬∑ÌÜµÏã† Ïû•Ïï†(Outage) Ï°∞Í±¥</strong>‚ÄîÏù∏ÌÑ∞ÎÑ∑ ÏóÜÏùå, ÌÅ¥ÎùºÏö∞Îìú ÏóÜÏùå, Í≥ÑÏ†ï ÏóÜÏùå, Ïï±Ïä§ÌÜ†Ïñ¥ ÏóÜÏùå‚ÄîÏóêÏÑúÎèÑ ÎèôÏûëÌïòÎèÑÎ°ù ÏÑ§Í≥ÑÌñàÏäµÎãàÎã§.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ïôú Ïã†Î¢∞Ìï† ÎßåÌïúÍ∞Ä?</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Í∞êÏÇ¨ Í∞ÄÎä•:</strong> Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏóÜÏù¥ Îã®Ïùº HTML ÌååÏùº(Ïà®ÏùÄ ÎÑ§Ìä∏ÏõåÌÅ¨ Ìò∏Ï∂ú ÏóÜÏùå).</li>
              <li><strong>ÌîÑÎùºÏù¥Î≤ÑÏãú Ïö∞ÏÑ†:</strong> ÌÖîÎ†àÎ©îÌä∏Î¶¨ 0. Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Í∏∞Í∏∞ÏóêÎßå.</li>
              <li><strong>Î≥µÏõêÎ†•:</strong> BLE Í∑ºÏ†ë + ÏàòÌïô Í∏∞Î∞ò Í≤ΩÎüâ AI(ÌïÑÌÑ∞/ÏïàÏ†ïÌôî/Î°úÏª¨ ÌïôÏäµ).</li>
              <li><strong>ÌòÑÏû•ÏÑ±:</strong> Íµ¨Ìòï ÏïàÎìúÎ°úÏù¥ÎìúÌè∞ + Ï†ÄÍ∞Ä BLE ÌÉúÍ∑∏Î°úÎèÑ ÏãúÏó∞ Í∞ÄÎä•.</li>
              <li><strong>ÌòëÎ†• ÌÉêÏÉâ(Rescue Assist):</strong> Ïò§ÌîÑÎùºÏù∏ ‚ÄúRescue Pack‚ÄùÏùÑ Í≥µÏú†Ìï¥ Îã§Î•∏ Ìè∞ÎèÑ ÎèôÏùº ÌÉúÍ∑∏Î•º Ïä§Ï∫îÌï† Ïàò ÏûàÏäµÎãàÎã§.</li>
              <li><strong>Î≥¥Ïïà ÎÇ¥Î≥¥ÎÇ¥Í∏∞:</strong> ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú ÏïîÌò∏ÌôîÎêú ‚ÄúRescue Pack‚Äù Î∞±ÏóÖÏùÑ Ï†úÍ≥µ.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ÏûëÎèô ÏõêÎ¶¨(ÏâΩÍ≤å)</h3>
        <div class="tip-card info">
          <div class="tip-title">1) Îì£Í∏∞</div>
          <div class="tip-body">Ìú¥ÎåÄÌè∞Ïù¥ BLE Í¥ëÍ≥† Ìå®ÌÇ∑ÏùÑ Îì£ÏäµÎãàÎã§. Ìå®ÌÇ∑ÏóêÎäî RSSI(Ïã†Ìò∏ÏÑ∏Í∏∞)Í∞Ä Ìè¨Ìï®Îê©ÎãàÎã§.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">2) ÏïàÏ†ïÌôî</div>
          <div class="tip-body">RSSIÎäî ÎÖ∏Ïù¥Ï¶àÍ∞Ä Ïª§ÏÑú ÌïÑÌÑ∞ÎßÅÌïòÍ≥†, Ï°¥ ÌåêÏ†ïÏùÑ ÏïàÏ†ïÌôîÌï¥ ‚ÄúÏïåÎ¶º Ìè≠Ï£º‚ÄùÎ•º Ï§ÑÏûÖÎãàÎã§.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">3) ÌñâÎèô</div>
          <div class="tip-body">ÏûÑÍ≥ÑÍ∞íÏùÑ Ï∂©Î∂ÑÌûà Ïò§Îûò ÎÑòÏúºÎ©¥ Í≤ΩÎ≥¥/Í∏∞Î°ùÏùÑ ÎßåÎì§Í≥†, SOS(Ïò§ÌîÑÎùºÏù∏ QR, Ïò§ÎîîÏò§)Î•º Ï†úÍ≥µÌï©ÎãàÎã§.</div>
        </div>

        <div class="divider"></div>

        <h3>Í∞úÏù∏Ï†ïÎ≥¥ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏóÜÏùå</div>
          <div class="tip-body">
            Ïù¥ Îç∞Î™®Îäî Î∂ÑÏÑù/Í∞úÏù∏Ï†ïÎ≥¥Î•º Ïô∏Î∂ÄÎ°ú Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÏäµÎãàÎã§. ÎÇ¥Î≥¥ÎÇ¥Í∏∞/Î∞±ÏóÖÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ ÎïåÎßå Ïã§ÌñâÎê©ÎãàÎã§. Ï†ÑÏ≤¥ ÏÇ≠Ï†úÎèÑ Í∞ÄÎä•Ìï©ÎãàÎã§.
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ïú§Î¶¨Ï†Å ÏÇ¨Ïö©</div>
          <div class="tip-body">
            Ïù∏ÎèÑÏ£ºÏùò Î™©Ï†ÅÏóê ÌïúÌï®. Íµ∞ÏÇ¨Ïö©/Í∞êÏãúÏö© ÏÇ¨Ïö©ÏùÄ Ïú§Î¶¨ ÎùºÏù¥ÏÑ†Ïä§Î°ú Í∏àÏßÄÌï©ÎãàÎã§.
          </div>
        </div>

        <div class="divider"></div>

        <h3>Ïó∞ÎùΩÏ≤ò</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Î©¥Ï±Ö</div>
          <div class="tip-body">Î≥∏ ÌååÏùºÏùÄ Í∏∞Ïà† ÏãúÏó∞Ïù¥Î©∞ ÏÉùÎ™Ö‚ÄëÏïàÏ†Ñ Ïù∏Ï¶ù Ïû•ÎπÑÍ∞Ä ÏïÑÎãôÎãàÎã§.</div>
        </div>
      `,
      ar: `
        <h2 style="margin-bottom:10px">ÿ≠ŸàŸÑ VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> ŸáŸà ÿπÿ±ÿ∂ ÿ™Ÿàÿ∂Ÿäÿ≠Ÿä ÿØÿßÿÆŸÑ ŸÖŸÑŸÅ HTML Ÿàÿßÿ≠ÿØ ŸÑŸÖÿ≠ÿ±ŸÉ ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿµÿ∫Ÿäÿ± ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸÖÿπ ÿßÿ≥ÿ™ÿ¥ÿπÿßÿ± ÿßŸÑŸÇÿ±ÿ® ÿπÿ®ÿ± Bluetooth.</p>
          <p style="margin-top:8px"><strong>ŸÖÿµŸÖŸÖ ŸÑÿ∏ÿ±ŸàŸÅ ‚ÄúÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ/ÿßŸÑÿßŸÜŸÇÿ∑ÿßÿπ‚Äù:</strong> ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™ÿå ÿ®ÿØŸàŸÜ ÿ≥ÿ≠ÿßÿ®ÿ©ÿå ÿ®ÿØŸàŸÜ ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ‚Äî ŸàŸÖÿπ ÿ∞ŸÑŸÉ ŸäÿπŸÖŸÑ.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ŸÑŸÖÿßÿ∞ÿß ŸáŸà ŸÖŸÇŸÜÿπ</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ÿØŸÇŸäŸÇ:</strong> ŸÖŸÑŸÅ Ÿàÿßÿ≠ÿØÿå ÿ®ÿØŸàŸÜ ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿÆÿßÿ±ÿ¨Ÿäÿ©ÿå ÿ®ÿØŸàŸÜ ŸÖŸÉÿßŸÑŸÖÿßÿ™ ÿ¥ÿ®ŸÉÿ© ŸÖÿÆŸÅŸäÿ©.</li>
              <li><strong>ÿÆÿµŸàÿµŸäÿ© ÿ£ŸàŸÑÿßŸã:</strong> ŸÑÿß ÿ™ŸÑŸäŸÖÿ™ÿ±Ÿäÿ©ÿå ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿ©.</li>
              <li><strong>ŸÖÿ±ŸÜ:</strong> ŸÇÿ±ÿ® BLE + ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿßÿ™ ÿ±Ÿäÿßÿ∂Ÿäÿ© ÿµÿ∫Ÿäÿ±ÿ© ŸÑÿ™ŸÜÿπŸäŸÖ ÿßŸÑŸÇÿ±ÿßÿ±.</li>
              <li><strong>ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÜÿ¥ÿ±:</strong> ŸäÿπŸÖŸÑ ÿπŸÑŸâ ŸáŸàÿßÿ™ŸÅ Android ŸÇÿØŸäŸÖÿ© ŸÖÿπ ÿπŸÑÿßŸÖÿßÿ™ BLE ÿ±ÿÆŸäÿµÿ©.</li>
              <li><strong>ÿ®ÿ≠ÿ´ ÿ™ÿπÿßŸàŸÜŸä (Rescue Assist):</strong> ÿ¥ÿßÿ±ŸÉ ‚ÄúRescue Pack‚Äù ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸÑŸäÿ™ŸÖŸÉŸÜ Ÿáÿßÿ™ŸÅ ÿ¢ÿÆÿ± ŸÖŸÜ ŸÖÿ≥ÿ≠ ŸÜŸÅÿ≥ ÿßŸÑÿπŸÑÿßŸÖÿ©.</li>
              <li><strong>ÿ™ÿµÿØŸäÿ± ÿ¢ŸÖŸÜ:</strong> ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ‚ÄúRescue Pack‚Äù ŸÖÿ¥ŸÅŸëÿ±ÿ© ÿßÿÆÿ™Ÿäÿßÿ±ŸäŸãÿß.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ŸÉŸäŸÅ ŸäÿπŸÖŸÑ (ÿ®ÿ®ÿ≥ÿßÿ∑ÿ©)</h3>
        <div class="tip-card info"><div class="tip-title">1) ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ</div><div class="tip-body">ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ≥ÿ™ŸÖÿπ ŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ BLE ŸàŸäŸÇÿ±ÿ£ RSSI (ŸÇŸàÿ© ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ©).</div></div>
        <div class="tip-card info"><div class="tip-title">2) ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™</div><div class="tip-body">ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ∂ÿ¨Ÿäÿ¨Ÿäÿ©ÿå ŸÑÿ∞ŸÑŸÉ Ÿäÿ™ŸÖ ÿ™ŸÜÿπŸäŸÖŸáÿß Ÿàÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÇÿ±ÿßÿ± ŸÑŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ™ŸÜÿ®ŸäŸá.</div></div>
        <div class="tip-card info"><div class="tip-title">3) ÿßŸÑŸÅÿπŸÑ</div><div class="tip-body">ÿπŸÜÿØ ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿπÿ™ÿ®ÿ© ŸÑŸÅÿ™ÿ±ÿ© ŸÉÿßŸÅŸäÿ©ÿå ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÜÿ®ŸäŸá Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ Ÿàÿ™ŸÅÿπŸäŸÑ ÿ£ÿØŸàÿßÿ™ SOS.</div></div>

        <div class="divider"></div>

        <h3>ÿßŸÑÿÆÿµŸàÿµŸäÿ© / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ŸÑÿß ÿ¨ŸÖÿπ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
          <div class="tip-body">ŸÑÿß Ÿäÿ±ÿ≥ŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿ£Ÿä ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿÆŸàÿßÿØŸÖ. ÿßŸÑÿ™ÿµÿØŸäÿ± ÿßÿÆÿ™Ÿäÿßÿ±Ÿä Ÿàÿ®ŸÇÿ±ÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ. ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ°.</div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ÿÆŸÑÿßŸÇŸä</div>
          <div class="tip-body">ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜŸä ŸÅŸÇÿ∑. ŸäŸèÿ≠ÿ∏ÿ± ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿπÿ≥ŸÉÿ±Ÿä ÿ£Ÿà ŸÑŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ŸàŸÅŸÇŸãÿß ŸÑŸÑÿ™ÿ±ÿÆŸäÿµ ÿßŸÑÿ£ÿÆŸÑÿßŸÇŸä.</div>
        </div>

        <div class="divider"></div>

        <h3>ÿßÿ™ÿµÿßŸÑ</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            ÿßŸÑŸÖŸàŸÇÿπ: <span class="kbd">mcorpai.org</span><br>
            ÿßŸÑŸÖŸÜÿ¥ÿ¶: <strong>Morgan J.</strong> (ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉŸàÿ±Ÿä: <strong>Gyumin Jeon</strong>)<br>
            ÿßŸÑÿ®ÿ±ŸäÿØ: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">ÿ™ŸÜÿ®ŸäŸá</div><div class="tip-body">Ÿáÿ∞ÿß ÿπÿ±ÿ∂ ÿ™ŸÇŸÜŸä ŸàŸÑŸäÿ≥ ÿ¨Ÿáÿßÿ≤Ÿãÿß ŸÖÿπÿ™ŸÖÿØŸãÿß ŸÑŸÑÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿ≠ÿ±ÿ¨ÿ©.</div></div>
      `,
      ja: `
        <h2 style="margin-bottom:10px">VitalGuard AI „Å´„Å§„ÅÑ„Å¶</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> „ÅØ„ÄÅ1„Å§„ÅÆHTML„Éï„Ç°„Ç§„É´ÂÜÖ„ÅßÂãï‰Ωú„Åô„Çã„ÄåÂ∞è„Åï„Å™„Ç™„Éï„É©„Ç§„É≥AI„Ç®„É≥„Ç∏„É≥ + BluetoothËøëÊé•„Äç„ÅÆÊäÄË°ì„Éá„É¢„Åß„Åô„ÄÇ</p>
          <p style="margin-top:8px"><strong>„Ç∑„É£„ÉÉ„Éà„ÉÄ„Ç¶„É≥Êù°‰ª∂</strong>Ôºà„Éç„ÉÉ„Éà„Å™„Åó„Éª„ÇØ„É©„Ç¶„Éâ„Å™„Åó„Éª„Ç¢„Ç´„Ç¶„É≥„Éà„Å™„ÅóÔºâ„Åß„ÇÇÂãï„Åè„Åì„Å®„ÇíÁõÆÁöÑ„Å´Ë®≠Ë®à„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">‰ø°È†º„Åß„Åç„Çã„Éù„Ç§„É≥„Éà</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Áõ£Êüª„Åó„ÇÑ„Åô„ÅÑ:</strong> Âçò‰∏ÄHTML„ÄÅÂ§ñÈÉ®„É©„Ç§„Éñ„É©„É™„Å™„Åó„ÄÅÈö†„Çå„ÅüÈÄö‰ø°„Å™„Åó„ÄÇ</li>
              <li><strong>„Éó„É©„Ç§„Éê„Ç∑„ÉºÂÑ™ÂÖà:</strong> „ÉÜ„É¨„É°„Éà„É™„Éº„Å™„Åó„ÄÇ„Éá„Éº„Çø„ÅØÁ´ØÊú´ÂÜÖ„ÄÇ</li>
              <li><strong>„É¨„Ç∏„É™„Ç®„É≥„Çπ:</strong> BLEËøëÊé• + Êï∞Â≠¶„Éô„Éº„Çπ„ÅÆËªΩÈáèAI„ÄÇ</li>
              <li><strong>ÁèæÂ†¥Âêë„Åë:</strong> Âè§„ÅÑAndroidÁ´ØÊú´ + ÂÆâ‰æ°„Å™BLE„Çø„Ç∞„ÅßÂãï‰Ωú„ÄÇ</li>
              <li><strong>ÂçîÂäõÊé¢Á¥¢ÔºàRescue AssistÔºâ:</strong> „Ç™„Éï„É©„Ç§„É≥„ÅÆ„ÄåRescue Pack„Äç„ÇíÂÖ±Êúâ„Åó„Å¶„ÄÅÂà•„ÅÆÁ´ØÊú´„Åß„ÇÇÂêå„Åò„Çø„Ç∞„Çí„Çπ„Ç≠„É£„É≥„Åß„Åç„Åæ„Åô„ÄÇ</li>
              <li><strong>ÂÆâÂÖ®„Å™„Ç®„ÇØ„Çπ„Éù„Éº„Éà:</strong> ‰ªªÊÑè„ÅßÊöóÂè∑Âåñ„Åï„Çå„Åü„ÄåRescue Pack„Äç„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>‰ªïÁµÑ„ÅøÔºà„ÇÑ„Åï„Åó„ÅèÔºâ</h3>
        <div class="tip-card info"><div class="tip-title">1) Âèó‰ø°</div><div class="tip-body">BLEÂ∫ÉÂëä„ÇíÂèó‰ø°„Åó„ÄÅRSSIÔºà‰ø°Âè∑Âº∑Â∫¶Ôºâ„ÇíË™≠„Åø„Åæ„Åô„ÄÇ</div></div>
        <div class="tip-card info"><div class="tip-title">2) ÂÆâÂÆöÂåñ</div><div class="tip-body">„Éé„Ç§„Ç∫„ÅåÂ§ß„Åç„ÅÑ„ÅÆ„Åß„Éï„Ç£„É´„Çø„ÅßÂπ≥ÊªëÂåñ„Åó„ÄÅ„Çæ„Éº„É≥Âà§ÂÆö„ÇíÂÆâÂÆöÂåñ„Åó„Åæ„Åô„ÄÇ</div></div>
        <div class="tip-card info"><div class="tip-title">3) Ë°åÂãï</div><div class="tip-body">‰∏ÄÂÆöÊù°‰ª∂„Åß„Ç¢„É©„Éº„Éà„ÇÑ„É≠„Ç∞„ÄÅSOSÔºàQR/Èü≥Ôºâ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ</div></div>

        <div class="divider"></div>

        <h3>„Éó„É©„Ç§„Éê„Ç∑„Éº / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">„Éá„Éº„ÇøÂèéÈõÜ„Å™„Åó</div><div class="tip-body">„Éá„É¢„ÅØÂàÜÊûê„ÇÑÂÄã‰∫∫ÊÉÖÂ†±„ÇíÈÄÅ‰ø°„Åó„Åæ„Åõ„Çì„ÄÇ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅØ‰ªªÊÑè„Åß„ÄÅÂÖ®Ê∂àÂéª„Åß„Åç„Åæ„Åô„ÄÇ</div></div>

        <div class="tip-card warn"><div class="tip-title">ÂÄ´ÁêÜÁöÑÂà©Áî®</div><div class="tip-body">‰∫∫ÈÅìÁõÆÁöÑ„ÅÆ„Åø„ÄÇËªç‰∫ã/Áõ£Ë¶ñÁî®ÈÄî„ÅØÁ¶ÅÊ≠¢ÔºàÂÄ´ÁêÜ„É©„Ç§„Çª„É≥„ÇπÔºâ„ÄÇ</div></div>

        <div class="divider"></div>

        <h3>ÈÄ£Áµ°ÂÖà</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">ÂÖçË≤¨</div><div class="tip-body">ÊäÄË°ì„Éá„É¢„Åß„ÅÇ„Çä„ÄÅÁîüÂëΩÂÆâÂÖ®„ÅÆË™çË®ºÊ©üÂô®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div></div>
      `,
      fr: `
        <h2 style="margin-bottom:10px">√Ä propos de VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> est une d√©monstration ‚Äútout‚Äëen‚Äëun‚Äù (un seul fichier HTML) d‚Äôun petit moteur IA hors ligne coupl√© √† la proximit√© Bluetooth.</p>
          <p style="margin-top:8px"><strong>Con√ßu pour les sc√©narios de panne :</strong> pas d‚Äôinternet, pas de cloud, pas de comptes ‚Äî et pourtant fonctionnel.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Pourquoi c‚Äôest cr√©dible</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Auditabilit√©:</strong> un seul fichier, aucune d√©pendance externe.</li>
              <li><strong>Vie priv√©e:</strong> z√©ro t√©l√©m√©trie, donn√©es locales.</li>
              <li><strong>R√©silience:</strong> BLE + IA math√©matique compacte.</li>
              <li><strong>D√©ployable:</strong> vieux Android + balises bon march√©.</li>
              <li><strong>Recherche coop√©rative (Rescue Assist):</strong> partagez un ‚ÄúRescue Pack‚Äù hors ligne pour qu‚Äôun autre t√©l√©phone scanne la m√™me balise.</li>
              <li><strong>Exports s√©curis√©s:</strong> sauvegardes ‚ÄúRescue Pack‚Äù chiffr√©es en option.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>Fonctionnement (simple)</h3>
        <div class="tip-card info"><div class="tip-title">1) √âcouter</div><div class="tip-body">Le t√©l√©phone √©coute les annonces BLE et lit le RSSI.</div></div>
        <div class="tip-card info"><div class="tip-title">2) Stabiliser</div><div class="tip-body">Filtrage + stabilit√© de d√©cision pour √©viter les alertes en boucle.</div></div>
        <div class="tip-card info"><div class="tip-title">3) Agir</div><div class="tip-body">Alerte/Journal/SOS (QR, audio) quand les conditions sont remplies.</div></div>

        <div class="divider"></div>

        <h3>Vie priv√©e / RGPD</h3>
        <div class="tip-card info"><div class="tip-title">Aucune collecte</div><div class="tip-body">Aucune donn√©e n‚Äôest envoy√©e √† des serveurs. Export sur action de l‚Äôutilisateur, suppression possible.</div></div>

        <div class="tip-card warn"><div class="tip-title">Usage √©thique</div><div class="tip-body">Usage humanitaire uniquement. Usage militaire/Monitoring interdit par la licence.</div></div>

        <div class="divider"></div>

        <h3>Contact</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Site: <span class="kbd">mcorpai.org</span><br>
            Cr√©ateur: <strong>Morgan J.</strong> (Nom cor√©en¬†: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">Avertissement</div><div class="tip-body">D√©mo technique, pas un dispositif certifi√©.</div></div>
      `,
      'zh-TW': `
        <h2 style="margin-bottom:10px">ÈóúÊñº VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> ÊòØÂñÆ‰∏Ä HTML Ê™îÊ°àÁöÑÈõ¢Á∑öÊäÄË°ìÁ§∫ÁØÑÔºöÂ∞èÂûã AI ÂºïÊìé + ËóçÁâôËøëË∑ùÈõ¢ÂÅµÊ∏¨„ÄÇ</p>
          <p style="margin-top:8px"><strong>ÁÇ∫„ÄåÁ∂≤Ë∑Ø/ÈõªÂäõ‰∏≠Êñ∑„ÄçÊÉÖÂ¢ÉËÄåË®≠Ë®àÔºö</strong>Ê≤íÁ∂≤Ë∑Ø„ÄÅÊ≤íÈõ≤Á´Ø„ÄÅÊ≤íÂ∏≥Ëôü‰πüËÉΩÈÅã‰Ωú„ÄÇ</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ÁÇ∫‰ªÄÈ∫ºÂÆÉÂÄºÂæó‰ø°‰ªª</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ÂèØÂØ©Ë®à:</strong> ÂñÆ‰∏ÄÊ™îÊ°à„ÄÅÁÑ°Â§ñÈÉ®Â•ó‰ª∂„ÄÅÁÑ°Èö±ËóèÁ∂≤Ë∑ØÂëºÂè´„ÄÇ</li>
              <li><strong>Èö±ÁßÅÂÑ™ÂÖà:</strong> Èõ∂ÈÅôÊ∏¨ÔºåË≥áÊñôÂè™Âú®Êú¨Ê©ü„ÄÇ</li>
              <li><strong>ÈüåÊÄß:</strong> BLE ËøëË∑ùÈõ¢ + Êï∏Â≠∏ÂºèËºïÈáè AI„ÄÇ</li>
              <li><strong>ÂèØÈÉ®ÁΩ≤:</strong> Ëàä Android + ‰æøÂÆú BLE Ê®ôÁ±§„ÄÇ</li>
              <li><strong>Âçî‰ΩúÊêúÂ∞ãÔºàRescue AssistÔºâ:</strong> Èõ¢Á∑öÂàÜ‰∫´„ÄåRescue Pack„ÄçËÆìÂè¶‰∏ÄÊîØÊâãÊ©ü‰πüËÉΩÊéÉÊèèÂêå‰∏ÄÊ®ôÁ±§„ÄÇ</li>
              <li><strong>ÂÆâÂÖ®ÂåØÂá∫:</strong> ÂèØÈÅ∏Âä†ÂØÜ„ÄåRescue Pack„ÄçÂÇô‰ªΩÔºåÊñπ‰æø‰∫§Êé•/Á®ΩÊ†∏„ÄÇ</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ÈÅã‰ΩúÊñπÂºèÔºàÁôΩË©±Ôºâ</h3>
        <div class="tip-card info"><div class="tip-title">1) Áõ£ËÅΩ</div><div class="tip-body">ÊâãÊ©üÁõ£ËÅΩ BLE Âª£Êí≠‰∏¶ËÆÄÂèñ RSSIÔºàË®äËôüÂº∑Â∫¶Ôºâ„ÄÇ</div></div>
        <div class="tip-card info"><div class="tip-title">2) Á©©ÂÆö</div><div class="tip-body">RSSI ÂæàÂêµÔºåÂÖàÁî®ÊøæÊ≥¢Âπ≥ÊªëÔºåÂÜçÊääÂçÄÂüüÂà§Êñ∑Á©©ÂÆöÂåñÈÅøÂÖçÁãÇË∑≥„ÄÇ</div></div>
        <div class="tip-card info"><div class="tip-title">3) Ë°åÂãï</div><div class="tip-body">Á¨¶ÂêàÊ¢ù‰ª∂ÊôÇËß∏ÁôºÊèêÈÜí/Ë®òÈåÑÔºå‰∏¶Êèê‰æõ SOSÔºàQR/Èü≥Ë®äÔºâ„ÄÇ</div></div>

        <div class="divider"></div>

        <h3>Èö±ÁßÅ / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">‰∏çÊî∂ÈõÜË≥áÊñô</div><div class="tip-body">Á§∫ÁØÑ‰∏çÊúÉÊääË≥áÊñôÈÄÅÂà∞‰º∫ÊúçÂô®„ÄÇÂåØÂá∫ÈúÄ‰ΩøÁî®ËÄÖÊìç‰ΩúÔºå‰∫¶ÂèØÈö®ÊôÇÂÖ®Âà™„ÄÇ</div></div>

        <div class="tip-card warn"><div class="tip-title">ÂÄ´ÁêÜ‰ΩøÁî®</div><div class="tip-body">ÂÉÖÈôê‰∫∫ÈÅìÁî®ÈÄî„ÄÇËªç‰∫ã/Áõ£ÊéßÁî®ÈÄîÁî±ÂÄ´ÁêÜÊéàÊ¨äÁ¶ÅÊ≠¢„ÄÇ</div></div>

        <div class="divider"></div>

        <h3>ËÅØÁµ°ÊñπÂºè</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">ÂÖçË≤¨ËÅ≤Êòé</div><div class="tip-body">ÊäÄË°ìÁ§∫ÁØÑÔºåÈùûÁîüÂëΩÈóúÈçµË™çË≠âË®≠ÂÇô„ÄÇ</div></div>
      `,
      es: `
        <h2 style="margin-bottom:10px">Acerca de VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> es una demostraci√≥n en un solo archivo HTML de un peque√±o motor de IA offline combinado con proximidad Bluetooth.</p>
          <p style="margin-top:8px"><strong>Dise√±ado para interrupciones:</strong> sin internet, sin nube, sin cuentas ‚Äî y aun as√≠ funciona.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Por qu√© es cre√≠ble</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Auditable:</strong> un solo archivo, sin librer√≠as externas, sin llamadas ocultas.</li>
              <li><strong>Privacidad primero:</strong> cero telemetr√≠a, datos locales.</li>
              <li><strong>Resiliente:</strong> BLE + IA matem√°tica compacta.</li>
              <li><strong>Desplegable:</strong> funciona en Android antiguos con etiquetas BLE baratas.</li>
              <li><strong>B√∫squeda cooperativa (Rescue Assist):</strong> comparte un ‚ÄúRescue Pack‚Äù offline para que otro tel√©fono escanee la misma etiqueta.</li>
              <li><strong>Exportaciones seguras:</strong> copias ‚ÄúRescue Pack‚Äù cifradas opcionales.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>C√≥mo funciona (simple)</h3>
        <div class="tip-card info"><div class="tip-title">1) Escuchar</div><div class="tip-body">El tel√©fono escucha anuncios BLE y lee el RSSI.</div></div>
        <div class="tip-card info"><div class="tip-title">2) Estabilizar</div><div class="tip-body">Filtra el ruido y estabiliza decisiones para evitar alertas constantes.</div></div>
        <div class="tip-card info"><div class="tip-title">3) Actuar</div><div class="tip-body">Activa alertas, registros y SOS (QR/audio) cuando se cumplen condiciones.</div></div>

        <div class="divider"></div>

        <h3>Privacidad / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">Sin recopilaci√≥n</div><div class="tip-body">No se env√≠a informaci√≥n a servidores. Exportaci√≥n solo con acci√≥n del usuario y borrado disponible.</div></div>

        <div class="tip-card warn"><div class="tip-title">Uso √©tico</div><div class="tip-body">Solo uso humanitario. Prohibido uso militar o de vigilancia por licencia √©tica.</div></div>

        <div class="divider"></div>

        <h3>Contacto</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Web: <span class="kbd">mcorpai.org</span><br>
            Creador: <strong>Morgan J.</strong> (Nombre coreano: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">Aviso</div><div class="tip-body">Demostraci√≥n t√©cnica, no un dispositivo certificado.</div></div>
      `
    }
  };

  // v4.1.7 additions (Language menu + first-run HTTPS notice)
  try{
    Object.assign(STR.en, {
      lang_link: 'Language',
      lang_title: 'Language',
      lang_subtitle: 'Choose your UI language',
      lang_note: 'This changes UI text only. Bluetooth behavior and offline processing remain the same.',
      firstrun_title: '‚ö† Important: Run via HTTPS / localhost for best BLE reliability',
      firstrun_body: `You are running from <span class="kbd" id="fr-proto">file://</span>. Some browsers restrict Bluetooth scanning, audio, and background behavior on local files.<br><br>
      Recommended:<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li>Use <span class="kbd">https://</span> hosting, or</li>
        <li>Use <span class="kbd">http://localhost</span> (local server), or</li>
        <li>Install as an App when available.</li>
      </ul>`,
      firstrun_ok: 'Got it',
      firstrun_help: 'Open Help'
    });

    Object.assign(STR.ko, {
      lang_link: 'Ïñ∏Ïñ¥',
      lang_title: 'Ïñ∏Ïñ¥',
      lang_subtitle: 'ÌôîÎ©¥ Ïñ∏Ïñ¥ ÏÑ†ÌÉù',
      lang_note: 'ÌôîÎ©¥ Î¨∏Íµ¨Îßå Î∞îÎÄùÎãàÎã§. Î∏îÎ£®Ìà¨Ïä§ ÎèôÏûëÍ≥º Ïò§ÌîÑÎùºÏù∏ Ï≤òÎ¶¨Îäî Í∑∏ÎåÄÎ°úÏûÖÎãàÎã§.',
      firstrun_title: '‚ö† Ï§ëÏöî: BLE ÏïàÏ†ïÏÑ±ÏùÑ ÏúÑÌï¥ HTTPS / localhostÎ°ú Ïã§ÌñâÌïòÏÑ∏Ïöî',
      firstrun_body: `ÌòÑÏû¨ <span class="kbd" id="fr-proto">file://</span> ÌôòÍ≤ΩÏóêÏÑú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§. ÏùºÎ∂Ä Î∏åÎùºÏö∞Ï†ÄÎäî Î°úÏª¨ ÌååÏùºÏóêÏÑú Î∏îÎ£®Ìà¨Ïä§ Ïä§Ï∫î/Ïò§ÎîîÏò§/Î∞±Í∑∏ÎùºÏö¥Îìú ÎèôÏûëÏùÑ Ï†úÌïúÌï† Ïàò ÏûàÏäµÎãàÎã§.<br><br>
      Í∂åÏû•:<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li><span class="kbd">https://</span>Î°ú Ìò∏Ïä§ÌåÖÌïòÍ±∞ÎÇò</li>
        <li><span class="kbd">http://localhost</span> (Î°úÏª¨ ÏÑúÎ≤Ñ)Î•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò</li>
        <li>Í∞ÄÎä•ÌïòÎ©¥ Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÏÑ∏Ïöî.</li>
      </ul>`,
      firstrun_ok: 'ÌôïÏù∏',
      firstrun_help: 'ÏÇ¨Ïö©Î≤ï'
    });

    Object.assign(STR.ar, {
      lang_link: 'ÿßŸÑŸÑÿ∫ÿ©',
      lang_title: 'ÿßŸÑŸÑÿ∫ÿ©',
      lang_subtitle: 'ÿßÿÆÿ™ÿ± ŸÑÿ∫ÿ© ÿßŸÑŸàÿßÿ¨Ÿáÿ©',
      lang_note: 'Ÿáÿ∞ÿß Ÿäÿ∫ŸäŸëÿ± ŸÜÿµ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÅŸÇÿ∑. ÿ≥ŸÑŸàŸÉ Bluetooth ŸàÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä.',
      firstrun_title: '‚ö† ŸÖŸáŸÖ: ÿ¥ÿ∫ŸëŸÑ ÿπÿ®ÿ± HTTPS / localhost ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± BLE',
      firstrun_body: `ÿ£ŸÜÿ™ ÿ™ÿπŸÖŸÑ ŸÖŸÜ <span class="kbd" id="fr-proto">file://</span>. ŸÇÿØ ÿ™ŸÇŸäŸëÿØ ÿ®ÿπÿ∂ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ŸÖÿ≥ÿ≠ Bluetooth ŸàÿßŸÑÿµŸàÿ™ Ÿàÿ≥ŸÑŸàŸÉ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿπŸÜÿØ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿ≠ŸÑŸäŸãÿß.<br><br>
      ÿßŸÑŸÖŸàÿµŸâ ÿ®Ÿá:<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li>ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßÿ≥ÿ™ÿ∂ÿßŸÅÿ© <span class="kbd">https://</span>ÿå ÿ£Ÿà</li>
        <li>ÿßÿ≥ÿ™ÿÆÿØŸÖ <span class="kbd">http://localhost</span> (ÿÆÿßÿØŸÖ ŸÖÿ≠ŸÑŸä)ÿå ÿ£Ÿà</li>
        <li>ÿ´ÿ®Ÿëÿ™ ŸÉÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÜÿØŸÖÿß Ÿäÿ™ŸàŸÅÿ± ÿ∞ŸÑŸÉ.</li>
      </ul>`,
      firstrun_ok: 'ÿ≠ÿ≥ŸÜŸãÿß',
      firstrun_help: 'ŸÖÿ≥ÿßÿπÿØÿ©'
    });

    Object.assign(STR.ja, {
      lang_link: 'Ë®ÄË™û',
      lang_title: 'Ë®ÄË™û',
      lang_subtitle: 'Ë°®Á§∫Ë®ÄË™û„ÇíÈÅ∏Êäû',
      lang_note: 'Ë°®Á§∫„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„ÅøÂ§âÊõ¥„Åï„Çå„Åæ„Åô„ÄÇBluetooth „ÅÆÊåôÂãï„Å®„Ç™„Éï„É©„Ç§„É≥Âá¶ÁêÜ„ÅØÂêå„Åò„Åß„Åô„ÄÇ',
      firstrun_title: '‚ö† ÈáçË¶Å: BLE „ÅÆÂÆâÂÆöÊÄß„ÅÆ„Åü„ÇÅ HTTPS / localhost „ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
      firstrun_body: `ÁèæÂú® <span class="kbd" id="fr-proto">file://</span> „ÅßÂÆüË°å‰∏≠„Åß„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„Å´„Çà„Å£„Å¶„ÅØ„É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„Åß Bluetooth „Çπ„Ç≠„É£„É≥/Èü≥Â£∞/„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂãï‰Ωú„ÅåÂà∂Èôê„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br><br>
      Êé®Â•®:<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li><span class="kbd">https://</span> „Åß„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞„Åô„Çã„ÄÅ„Åæ„Åü„ÅØ</li>
        <li><span class="kbd">http://localhost</span>Ôºà„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÉºÔºâ„Çí‰ΩøÁî®„Åô„Çã„ÄÅ„Åæ„Åü„ÅØ</li>
        <li>ÂèØËÉΩ„Åß„ÅÇ„Çå„Å∞„Ç¢„Éó„É™„Å®„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
      </ul>`,
      firstrun_ok: 'OK',
      firstrun_help: '„Éò„É´„Éó'
    });

    Object.assign(STR.fr, {
      lang_link: 'Langue',
      lang_title: 'Langue',
      lang_subtitle: 'Choisir la langue de l‚Äôinterface',
      lang_note: 'Cela change uniquement le texte de l‚Äôinterface. Le Bluetooth et le traitement hors‚Äëligne restent identiques.',
      firstrun_title: '‚ö† Important : ex√©cutez via HTTPS / localhost pour une meilleure fiabilit√© BLE',
      firstrun_body: `Vous ex√©cutez depuis <span class="kbd" id="fr-proto">file://</span>. Certains navigateurs limitent le scan Bluetooth, l‚Äôaudio et le fonctionnement en arri√®re‚Äëplan pour les fichiers locaux.<br><br>
      Recommand√© :<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li>Utiliser un h√©bergement <span class="kbd">https://</span>, ou</li>
        <li>Utiliser <span class="kbd">http://localhost</span> (serveur local), ou</li>
        <li>Installer en tant qu‚Äôapplication lorsque disponible.</li>
      </ul>`,
      firstrun_ok: 'Compris',
      firstrun_help: 'Aide'
    });

    Object.assign(STR['zh-TW'], {
      lang_link: 'Ë™ûË®Ä',
      lang_title: 'Ë™ûË®Ä',
      lang_subtitle: 'ÈÅ∏Êìá‰ªãÈù¢Ë™ûË®Ä',
      lang_note: 'Âè™ÊúÉÊõ¥Êîπ‰ªãÈù¢ÊñáÂ≠ó„ÄÇBluetooth Ë°åÁÇ∫ËàáÈõ¢Á∑öËôïÁêÜ‰øùÊåÅ‰∏çËÆä„ÄÇ',
      firstrun_title: '‚ö† ÈáçË¶ÅÔºöÁÇ∫‰∫Ü BLE Á©©ÂÆöÊÄßÔºåË´ã‰ΩøÁî® HTTPS / localhost Âü∑Ë°å',
      firstrun_body: `‰Ω†Ê≠£Âú®Âæû <span class="kbd" id="fr-proto">file://</span> Âü∑Ë°å„ÄÇÈÉ®ÂàÜÁÄèË¶ΩÂô®Âú®Êú¨Ê©üÊ™îÊ°àÁí∞Â¢ÉÂèØËÉΩÈôêÂà∂ËóçÁâôÊéÉÊèè„ÄÅÈü≥Ë®äËàáËÉåÊôØË°åÁÇ∫„ÄÇ<br><br>
      Âª∫Ë≠∞Ôºö<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li>‰ΩøÁî® <span class="kbd">https://</span> Ë®óÁÆ°ÔºåÊàñ</li>
        <li>‰ΩøÁî® <span class="kbd">http://localhost</span>ÔºàÊú¨Ê©ü‰º∫ÊúçÂô®ÔºâÔºåÊàñ</li>
        <li>ÂèØÁî®ÊôÇÂÆâË£ùÁÇ∫ App ‰ª•Áç≤ÂæóÊõ¥‰Ω≥È´îÈ©ó„ÄÇ</li>
      </ul>`,
      firstrun_ok: 'Áü•ÈÅì‰∫Ü',
      firstrun_help: 'Ë™™Êòé'
    });

    Object.assign(STR.es, {
      lang_link: 'Idioma',
      lang_title: 'Idioma',
      lang_subtitle: 'Elige el idioma de la interfaz',
      lang_note: 'Esto solo cambia el texto de la interfaz. El Bluetooth y el procesamiento sin conexi√≥n siguen igual.',
      firstrun_title: '‚ö† Importante: ejecuta v√≠a HTTPS / localhost para mejor fiabilidad BLE',
      firstrun_body: `Est√°s ejecutando desde <span class="kbd" id="fr-proto">file://</span>. Algunos navegadores restringen el escaneo Bluetooth, el audio y el comportamiento en segundo plano en archivos locales.<br><br>
      Recomendado:<ul style="margin:8px 0 0 16px;line-height:1.5">
        <li>Usar alojamiento <span class="kbd">https://</span>, o</li>
        <li>Usar <span class="kbd">http://localhost</span> (servidor local), o</li>
        <li>Instalar como app cuando est√© disponible.</li>
      </ul>`,
      firstrun_ok: 'Entendido',
      firstrun_help: 'Ayuda'
    });
  }catch(e){}

  let lang = 'en';

  function currentDict(){
    return STR[lang] || STR.en;
  }
  function t(key){
    const d = currentDict();
    return (d && d[key]) || (STR.en && STR.en[key]) || key;
  }
  function setLang(next){
    if(!next || !STR[next]) next = 'en';
    lang = next;
    try{ localStorage.setItem(STORAGE_KEY, lang); }catch(e){}
    apply();
  }
  function getLang(){ return lang; }

  function apply(){
    // html lang/dir
    const htmlLang = (lang==='zh-TW') ? 'zh-Hant' : lang;
    document.documentElement.lang = htmlLang;
    document.documentElement.dir = RTL_LANGS.has(lang) ? 'rtl' : 'ltr';

    // Header
    if($('i18n_app_title')) $('i18n_app_title').textContent = t('app_title');
    if($('i18n_app_sub')) $('i18n_app_sub').textContent = t('app_sub');
    if($('i18n_app_mission')) $('i18n_app_mission').textContent = t('app_mission');
    if($('i18n_app_disclaimer')) $('i18n_app_disclaimer').textContent = t('app_disclaimer');
    if($('i18n_github_link')) $('i18n_github_link').textContent = t('github');
    if($('i18n_help_link')) $('i18n_help_link').textContent = t('help');
    if($('i18n_about_link')) $('i18n_about_link').textContent = t('about');

    // Overlay titles
    if($('i18n_help_title')) $('i18n_help_title').textContent = t('help_title');
    if($('i18n_legal_title')) $('i18n_legal_title').textContent = t('legal_title');

    // Install banner
    if($('i18n_install_title')) $('i18n_install_title').textContent = t('install_title');
    if($('i18n_install_sub')) $('i18n_install_sub').textContent = t('install_sub');
    if($('installBtn')) $('installBtn').textContent = t('install_btn');
    if($('installDismiss')) $('installDismiss').textContent = t('install_dismiss');

    // Home hero
    if($('i18n_hero_title')) $('i18n_hero_title').textContent = t('hero_title');
    if($('i18n_hero_body')) $('i18n_hero_body').textContent = t('hero_body');
    if($('i18n_hero_pillars')) $('i18n_hero_pillars').innerHTML = t('hero_pillars_html');
    if($('i18n_badge_offline')) $('i18n_badge_offline').textContent = t('badge_offline');
    if($('i18n_badge_gdpr')) $('i18n_badge_gdpr').textContent = t('badge_gdpr');
    if($('i18n_badge_ble')) $('i18n_badge_ble').textContent = t('badge_ble');
    if($('i18n_badge_tiny')){
      let kb=0;
      try{ kb = Math.round(new Blob([document.documentElement.outerHTML]).size/1024); }catch(e){ kb=0; }
      $('i18n_badge_tiny').textContent = t('badge_tiny').replace('{KB}', kb||0);
    }
    if($('i18n_contact_line')) $('i18n_contact_line').textContent = t('contact_line');

    // Empty state
    if($('i18n_empty_text')) $('i18n_empty_text').innerHTML = t('empty_text');
    if($('i18n_empty_btn')) $('i18n_empty_btn').textContent = t('empty_btn');

    // Tips
    if($('i18n_tips_title')) $('i18n_tips_title').textContent = t('tips_title');
    if($('tipsI18n')) $('tipsI18n').innerHTML = (HTML.tips[lang] || HTML.tips.en);

    // Bottom nav labels
    document.querySelectorAll('.bnav-btn').forEach(btn=>{
      const tab = btn.getAttribute('data-tab');
      const label = btn.querySelector('span:last-child');
      if(!label) return;
      if(tab==='home') label.textContent = t('nav_home');
      else if(tab==='sos') label.textContent = t('nav_sos');
      else if(tab==='tips') label.textContent = t('nav_tips');
      else if(tab==='settings') label.textContent = t('nav_settings');
    });

    // Language UI
    if($('i18n_lang_link')) $('i18n_lang_link').textContent = t('lang_link');
    if($('i18n_lang_title')) $('i18n_lang_title').textContent = t('lang_title');
    if($('i18n_lang_subtitle')) $('i18n_lang_subtitle').textContent = t('lang_subtitle');
    if($('i18n_lang_note')) $('i18n_lang_note').textContent = t('lang_note');

    // First-run banner (HTTPS / localhost notice)
    if($('i18n_firstrun_title')) $('i18n_firstrun_title').textContent = t('firstrun_title');
    if($('i18n_firstrun_body')) $('i18n_firstrun_body').innerHTML = t('firstrun_body');
    if($('i18n_firstrun_ok')) $('i18n_firstrun_ok').textContent = t('firstrun_ok');
    if($('i18n_firstrun_help')) $('i18n_firstrun_help').textContent = t('firstrun_help');
    try{ const p=$('fr-proto'); if(p) p.textContent = location.protocol; }catch(e){}
  }

  function init(){
    try{
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved && STR[saved]) lang = saved;
    }catch(e){}
    const sel = $('langSelect');
    if(sel){
      sel.value = lang;
      sel.addEventListener('change', ()=>setLang(sel.value));
    }
    apply();
  }

  return { init, apply, t, setLang, getLang, HTML };
})();

/* ----------------------------- STORAGE ----------------------------- */
const Store = {
  db: null,

  async init() {
    return new Promise(resolve=>{
      try{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains('pets')) db.createObjectStore('pets',{keyPath:'id'});
          if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings',{keyPath:'key'});
          if(!db.objectStoreNames.contains('ai')) db.createObjectStore('ai',{keyPath:'key'});
          if(!db.objectStoreNames.contains('alerts')) db.createObjectStore('alerts',{keyPath:'id'});
          if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs',{keyPath:'key'});
        };
        req.onsuccess = e => { this.db = e.target.result; resolve(); };
        req.onerror = () => { console.warn('IndexedDB open failed'); resolve(); };
      }catch(err){
        console.warn('IndexedDB init exception', err);
        resolve();
      }
    });
  },

  async savePet(pet) {
    const data = pet.toJSON();
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').put(data);
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data));
  },

  async getAllPets() {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('pets','readonly').objectStore('pets').getAll();
        req.onsuccess=()=>r(req.result||[]);
        req.onerror=()=>r(this._lsPets());
      });
    }
    return this._lsPets();
  },

  _lsPets() {
    const p=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX+'pet_')){
        try{ p.push(JSON.parse(localStorage.getItem(k))); }catch(e){}
      }
    }
    return p;
  },

  async deletePet(id) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').delete(id);
        tx.oncomplete=()=>r();
        tx.onerror=()=>r();
      });
    }
    localStorage.removeItem(LS_PREFIX+'pet_'+id);
  },

  async clearAll() {
    if(this.db){
      const tx=this.db.transaction(['pets','settings','ai','alerts','blobs'],'readwrite');
      tx.objectStore('pets').clear();
      tx.objectStore('settings').clear();
      tx.objectStore('ai').clear();
      tx.objectStore('alerts').clear();
      tx.objectStore('blobs').clear();
    }
    // SAFE: only delete our keys, NEVER clear all local storage
    const toRemove=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX)) toRemove.push(k);
    }
    toRemove.forEach(k=>localStorage.removeItem(k));
  },

  async saveSetting(key, value) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('settings','readwrite');
        tx.objectStore('settings').put({key,value});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value));
  },

  async getSetting(key, def) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('settings','readonly').objectStore('settings').get(key);
        req.onsuccess=()=>r(req.result ? req.result.value : def);
        req.onerror=()=>r(def);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'s_'+key);
    return v!==null ? JSON.parse(v) : def;
  },

  async saveAI(key, data) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('ai','readwrite');
        tx.objectStore('ai').put({key, ...data});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data));
  },

  async getAI(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('ai','readonly').objectStore('ai').get(key);
        req.onsuccess=()=>r(req.result || null);
        req.onerror=()=>r(null);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'ai_'+key);
    return v ? JSON.parse(v) : null;
  },

  async saveBlob(key, blob) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('blobs','readwrite');
        tx.objectStore('blobs').put({key, blob, type: blob ? blob.type : ''});
        tx.oncomplete=()=>r(true);
        tx.onerror=()=>r(false);
      });
    }
    // fallback: base64 in localStorage (best-effort)
    if(!blob){ localStorage.removeItem(LS_PREFIX+'blob_'+key); return false; }
    return new Promise(res=>{
      const fr=new FileReader();
      fr.onload=()=>{ try{ localStorage.setItem(LS_PREFIX+'blob_'+key, fr.result); res(true); }catch(e){ res(false); } };
      fr.onerror=()=>res(false);
      fr.readAsDataURL(blob);
    });
  },

  async getBlob(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('blobs','readonly').objectStore('blobs').get(key);
        req.onsuccess=()=>r(req.result ? req.result.blob : null);
        req.onerror=()=>r(null);
      });
    }
    const dataUrl = localStorage.getItem(LS_PREFIX+'blob_'+key);
    if(!dataUrl) return null;
    // Convert dataURL back to Blob
    try{
      const parts=dataUrl.split(',');
      const meta=parts[0] || '';
      const b64=parts[1] || '';
      const mime=(meta.match(/data:(.*?);base64/)||[])[1] || 'audio/webm';
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    }catch(e){
      return null;
    }
  }
};

/* ----------------------------- SIGNAL FILTER (KALMAN) ----------------------------- */
// Advanced Kalman filter (from V20, adapted)
class KalmanRSSI {
  constructor(){
    this.x=-70;
    this.v=0;
    this.P=[[2,0],[0,2]];
    this.Q=0.15;
    this.R=5;
    this.history=[];
    this.maxHistory=30;
  }
  update(z){
    const xPred=this.x+this.v;
    const pPred=this.P[0][0]+this.Q;
    const innov=z-xPred;
    const K=pPred/(pPred+this.R);
    this.x=xPred+K*innov;
    this.v=this.v+0.1*(innov-this.v);
    this.P[0][0]=(1-K)*pPred;

    this.history.push(z);
    if(this.history.length>this.maxHistory) this.history.shift();

    if(this.history.length>=5){
      const m=this.history.reduce((a,b)=>a+b,0)/this.history.length;
      const vr=this.history.reduce((a,b)=>a+(b-m)**2,0)/this.history.length;
      this.R=clamp(vr*0.5,1,15);
    }
    return this.x;
  }
  getVelocity(){ return this.v; }
  reset(){ this.x=-70; this.v=0; this.R=5; this.history=[]; }
}

/* ----------------------------- DISTANCE ESTIMATOR (V20) ----------------------------- */
class DistanceEstimator {
  constructor(){
    this.txPower=-59;
    this.n=2.5;
    this.calibPoints=[];
  }
  estimate(rssi){
    if(rssi>=0 || isNaN(rssi)) return 0;
    return clamp(Math.pow(10, (this.txPower - rssi)/(10*this.n)), 0, 100);
  }
  addCalibration(rssi, dist){
    this.calibPoints.push({rssi, dist});
    this._recalc();
  }
  _recalc(){
    if(this.calibPoints.length<2) return;
    const p1=this.calibPoints[this.calibPoints.length-2];
    const p2=this.calibPoints[this.calibPoints.length-1];
    if(p1.dist>0 && p2.dist>0 && p1.dist!==p2.dist){
      const lr=Math.log10(p2.dist/p1.dist);
      if(lr!==0){
        this.n = clamp((p1.rssi - p2.rssi)/(10*lr), 1.5, 4);
        this.txPower = p1.rssi + 10*this.n*Math.log10(p1.dist);
      }
    }
  }
  export(){ return {txPower:this.txPower, n:this.n, calibPoints:this.calibPoints}; }
  import(d){
    if(!d) return;
    this.txPower = typeof d.txPower==='number' ? d.txPower : this.txPower;
    this.n = typeof d.n==='number' ? d.n : this.n;
    this.calibPoints = Array.isArray(d.calibPoints) ? d.calibPoints : [];
  }
}

/* ----------------------------- Q-LEARNING LITE (V20/V35) ----------------------------- */
class QLearningLite {
  constructor(){
    this.qTable={};
    this.lr=0.3;
    this.eps=0.2;
    this.count=0;
  }
  _key(zone){ return zone; }
  _getQ(s){
    if(!this.qTable[s]) this.qTable[s]={widen:0, maintain:0, narrow:0};
    return this.qTable[s];
  }
  chooseAction(zone){
    const q=this._getQ(this._key(zone));
    if(Math.random()<this.eps){
      const a=['widen','maintain','narrow'];
      return a[Math.floor(Math.random()*3)];
    }
    return Object.entries(q).reduce((a,b)=>b[1]>a[1]?b:a, ['maintain',-Infinity])[0];
  }
  update(zone, isHelpful, action){
    const s=this._key(zone);
    const q=this._getQ(s);
    const reward=isHelpful?1:-1;
    q[action]=q[action]+this.lr*(reward-q[action]);
    this.count++;
    if(this.count>50) this.lr=0.1;
    if(this.count>200) this.lr=0.05;
    this.eps=Math.max(0.05, this.eps*0.995);
  }
  applyAction(action, thresholds){
    const step=2;
    const t={...thresholds};
    if(action==='widen'){
      t.cautionEnter=Math.max(-90, t.cautionEnter-step);
      t.warningEnter=Math.max(-98, t.warningEnter-step);
      t.dangerEnter=Math.max(-100, t.dangerEnter-step);
    }else if(action==='narrow'){
      t.cautionEnter=Math.min(-40, t.cautionEnter+step);
      t.warningEnter=Math.min(-55, t.warningEnter+step);
      t.dangerEnter=Math.min(-70, t.dangerEnter+step);
    }
    // maintain exit thresholds relative
    t.cautionExit=t.cautionEnter+5;
    t.warningExit=t.warningEnter+6;
    t.dangerExit=t.dangerEnter+6;
    return t;
  }
  export(){ return {qTable:this.qTable, count:this.count, lr:this.lr, eps:this.eps}; }
  import(d){
    if(!d) return;
    this.qTable=d.qTable||{};
    this.count=d.count||0;
    this.lr=typeof d.lr==='number'?d.lr:this.lr;
    this.eps=typeof d.eps==='number'?d.eps:this.eps;
  }
  reset(){ this.qTable={}; this.lr=0.3; this.eps=0.2; this.count=0; }
}

/* ----------------------------- BEHAVIORAL FINGERPRINT ----------------------------- */
class BehavioralFingerprint {
  constructor(){
    this.window=[];
    this.windowSize=60;
  }
  addReading(rssi){
    this.window.push(rssi);
    if(this.window.length>this.windowSize) this.window.shift();
  }
  getFeatures(){
    if(this.window.length<10) return null;
    const w=this.window;
    const mean=w.reduce((a,b)=>a+b,0)/w.length;
    const variance=w.reduce((a,b)=>a+(b-mean)**2,0)/w.length;
    const recent=w.slice(-5);
    const older=w.slice(-10,-5);
    const trendMean=recent.reduce((a,b)=>a+b,0)/recent.length;
    const olderMean=older.length?older.reduce((a,b)=>a+b,0)/older.length:mean;
    const trend=trendMean-olderMean;
    return {mean, variance, trend};
  }
  classify(){
    const f=this.getFeatures();
    if(!f) return 'unknown';
    if(f.trend<-5 && f.variance>30) return 'rapid_departure';
    if(f.trend<-3) return 'moving_away';
    if(f.trend>3) return 'approaching';
    if(f.variance>50) return 'unstable';
    return 'stable';
  }
}

/* ----------------------------- RING BUFFER ----------------------------- */
class RingBuffer {
  constructor(size){ this.size=size; this.buf=[]; }
  push(v){ this.buf.push(v); if(this.buf.length>this.size) this.buf.shift(); }
  get data(){ return this.buf; }
  get length(){ return this.buf.length; }
  get last(){ return this.buf[this.buf.length-1]; }
  clear(){ this.buf=[]; }
  slice(a,b){ return this.buf.slice(a,b); }
}

/* ----------------------------- PET MODEL ----------------------------- */
class Pet {
  constructor(data){
    this.id = data.id || ('pet_'+Date.now()+'_'+Math.random().toString(36).slice(2,6));
    this.name = data.name || 'My Pet';
    this.icon = data.icon || 'üê∂';
    this.createdAt = data.createdAt || Date.now();
    this.signature = data.signature || {};
    this.rescueId = data.rescueId || genRescueId();
    this.thresholds = data.thresholds || {...DEFAULT_THRESHOLDS};
    this.leashPreset = data.leashPreset || '10m';
    this.aiToggles = data.aiToggles || {qlearn:false, behavior:true};
    this.aiState = data.aiState || {};

    // Runtime modules (not raw-persisted; but we import params when available)
    this.kalman = new KalmanRSSI();
    this.distance = new DistanceEstimator();
    if(data.distanceCalib) this.distance.import(data.distanceCalib);

    this.qlearn = new QLearningLite();
    if(this.aiState && this.aiState.qlearn) this.qlearn.import(this.aiState.qlearn);

    this.behavior = new BehavioralFingerprint();
    this.rssiRing = new RingBuffer(MAX_RSSI_SAMPLES);

    // runtime state
    this.lastSeenMs=0;
    this.lastRawRssi=null;
    this.smoothedRssi=-100;
    this.lastProcessMs=0;

    this.zone={stable:'SAFE', candidate:'SAFE', candidateCount:0, candidateSinceMs:0, lastAlertMs:0};
    this.trendArrow='‚Üí';
    this.confidence=0;
    this.whyText='';
    this.alertHistory = Array.isArray(data.alertHistory) ? data.alertHistory : [];
    this.ambiguousCount = data.ambiguousCount || 0;
    this.lastAmbiguousMs = data.lastAmbiguousMs || 0;
    this.distMeters=0;
    this.lostFlips=0;
    this.batterySuspect=false;

    // AI coach state
    this.lastAiSuggestion=null;
  }

  getMinInterval(){
    const z=this.zone.stable;
    const base=perfProfile.petInterval;
    if(z==='SAFE') return base*2;
    if(z==='CAUTION') return base*1.4;
    if(z==='WARNING') return base*0.7;
    return base*0.5;
  }

  ingestRaw(rssi, now){
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    if(this.aiToggles.behavior) this.behavior.addReading(rssi);
  }

  _effectiveThresholds(){
    const t=this.thresholds;
    const ha = Settings.prefs.highAlert ? HIGH_ALERT_SHRINK : 0;
    const te = {
      cautionEnter: clamp(t.cautionEnter + ha, -90, -40),
      cautionExit:  clamp(t.cautionExit  + ha, -85, -35),
      warningEnter: clamp(t.warningEnter + ha, -98, -55),
      warningExit:  clamp(t.warningExit  + ha, -92, -49),
      dangerEnter: clamp(t.dangerEnter + ha, -100, -70),
      dangerExit:  clamp(t.dangerExit  + ha, -94, -64)
    };
    // ensure hysteresis remains valid
    if(te.cautionExit <= te.cautionEnter) te.cautionExit = te.cautionEnter + 5;
    if(te.warningExit <= te.warningEnter) te.warningExit = te.warningEnter + 6;
    if(te.dangerExit <= te.dangerEnter) te.dangerExit = te.dangerEnter + 6;
    return te;
  }

  processRssi(rssi, now){
    const dtProcess = this.lastProcessMs ? (now - this.lastProcessMs) : 9999;
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    this.lastProcessMs = now;

    this.smoothedRssi = this.kalman.update(rssi);
    this.rssiRing.push(this.smoothedRssi);

    if(this.aiToggles.behavior) this.behavior.addReading(rssi);

    this.distMeters = this.distance.estimate(this.smoothedRssi);

    // Confidence estimation
    const freshness=clamp(1-(dtProcess)/10000,0,1);
    const sampleCount=clamp(this.rssiRing.length/20,0,1);
    const f=this.behavior.getFeatures();
    const stability=f?clamp(1-f.variance/120,0,1):0.5;
    this.confidence=Math.round((freshness*0.25 + sampleCount*0.35 + stability*0.40)*100);

    // Zone w/ hysteresis
    const sr=this.smoothedRssi;
    const prev=this.zone.stable;
    const t=this._effectiveThresholds();
    let instant;

    if(prev==='SAFE'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }else if(prev==='CAUTION'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr>t.cautionExit?'SAFE' : 'CAUTION';
    }else if(prev==='WARNING'){
      instant = sr<=t.dangerEnter?'DANGER' : sr>t.warningExit?'CAUTION' : 'WARNING';
    }else if(prev==='DANGER'){
      instant = sr>t.dangerExit?'WARNING' : 'DANGER';
    }else{
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }

    // Stabilize transitions
    if(instant===this.zone.candidate){
      this.zone.candidateCount++;
    }else{
      this.zone.candidate = instant;
      this.zone.candidateCount = 1;
      this.zone.candidateSinceMs = now;
    }

    const confirmReq = Settings.prefs.highAlert ? Math.max(2, ZONE_CONFIRM_COUNT-1) : ZONE_CONFIRM_COUNT;
    const stable = this.zone.candidateCount>=confirmReq || ((now-this.zone.candidateSinceMs)>=ZONE_CONFIRM_MS && this.zone.candidateCount>=2);

    if(stable && this.zone.candidate!==this.zone.stable){
      const prevS=this.zone.stable;
      this.zone.stable=this.zone.candidate;

      if(ZONE_ORDER[this.zone.stable] > ZONE_ORDER[prevS]){
        // Escalation (worse zone)
        const vel=this.kalman.getVelocity();
        const beh=this.behavior.classify();
        if(beh==='rapid_departure') this.whyText='Signal weakening fast';
        else if(vel<-2) this.whyText='Signal declining steadily';
        else this.whyText='Boundary threshold crossed';

        if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
          this.zone.lastAlertMs = now;
          App.triggerAlert(this);
          this._addAlert(now);
        }
      }else{
        this.whyText='Signal improving';
      }
    }

    // Trend arrow
    if(this.rssiRing.length>=8){
      const recent=median(this.rssiRing.slice(-4));
      const older=median(this.rssiRing.slice(-8,-4));
      const diff=recent-older;
      this.trendArrow = diff>3?'‚Üë':diff<-3?'‚Üì':'‚Üí';
    }

    // Battery suspicion heuristic
    if(this.zone.stable==='LOST') this.lostFlips++;
    if(this.lostFlips>=3) this.batterySuspect=true;
  }

  markLost(now){
    if(this.zone.stable!=='LOST'){
      this.zone.stable='LOST';
      this.zone.candidate='LOST';
      this.zone.candidateCount=99;
      this.trendArrow='‚úï';
      this.whyText='No signal for '+Math.round((now-this.lastSeenMs)/1000)+'s';
      this.confidence=0;

      this.lostFlips++;
      if(this.lostFlips>=3) this.batterySuspect=true;

      if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
        this.zone.lastAlertMs = now;
        App.triggerAlert(this);
        this._addAlert(now);
      }
    }
  }

  _addAlert(now){
    this.alertHistory.unshift({
      time: now,
      zone: this.zone.stable,
      rssi: Math.round(this.smoothedRssi),
      dist: this.distMeters.toFixed(1),
      why: this.whyText
    });
    if(this.alertHistory.length>40) this.alertHistory.pop();
  }

  getLastSeenText(now){
    if(!this.lastSeenMs) return 'Never';
    const s=Math.round((now-this.lastSeenMs)/1000);
    if(s<2) return 'Just now';
    if(s<60) return s+'s ago';
    if(s<3600) return Math.floor(s/60)+'m ago';
    return 'Long ago';
  }

  signatureStrength(){
    // Quick heuristic
    const sig=this.signature||{};
    let s=0;
    if(sig.confirmed) s+=2;
    if(sig.nameExact) s+=2;
    if(sig.namePrefix) s+=1;
    if(sig.manufacturerId!==undefined) s+=1;
    if(sig.manufacturerDataPrefixHex) s+=1;
    if(sig.serviceUuids && sig.serviceUuids.length) s+=1;
    if(sig.deviceId) s+=1;
    return s; // 0..8
  }

  toJSON(){
    return {
      id:this.id,
      name:this.name,
      icon:this.icon,
      signature:this.signature,
      createdAt:this.createdAt,
      rescueId:this.rescueId,
      thresholds:this.thresholds,
      leashPreset:this.leashPreset,
      aiToggles:this.aiToggles,
      aiState:{ qlearn: this.qlearn.export() },
      distanceCalib:this.distance.export(),
      alertHistory:this.alertHistory.slice(0,40),
      ambiguousCount:this.ambiguousCount,
      lastAmbiguousMs:this.lastAmbiguousMs
    };
  }
}


/* ----------------------------- QR GENERATOR (V4.1: Standard QR) ----------------------------- */
/*
  ‚úÖ Standard QR (scannable)
  Offline embedded library: Project Nayuki QR Code generator (MIT License).
  (The library code is included below for offline-first operation.)
*/
/*
 * QR Code generator library (TypeScript)
 *
 * Copyright (c) Project Nayuki. (MIT License)
 * https://www.nayuki.io/page/qr-code-generator-library
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 * - The above copyright notice and this permission notice shall be included in
 *   all copies or substantial portions of the Software.
 * - The Software is provided "as is", without warranty of any kind, express or
 *   implied, including but not limited to the warranties of merchantability,
 *   fitness for a particular purpose and noninfringement. In no event shall the
 *   authors or copyright holders be liable for any claim, damages or other
 *   liability, whether in an action of contract, tort or otherwise, arising from,
 *   out of or in connection with the Software or the use or other dealings in the
 *   Software.
 */
"use strict";
var qrcodegen;
(function (qrcodegen) {
    /*---- QR Code symbol class ----*/
    /*
     * A QR Code symbol, which is a type of two-dimension barcode.
     * Invented by Denso Wave and described in the ISO/IEC 18004 standard.
     * Instances of this class represent an immutable square grid of dark and light cells.
     * The class provides static factory functions to create a QR Code from text or binary data.
     * The class covers the QR Code Model 2 specification, supporting all versions (sizes)
     * from 1 to 40, all 4 error correction levels, and 4 character encoding modes.
     *
     * Ways to create a QR Code object:
     * - High level: Take the payload data and call QrCode.encodeText() or QrCode.encodeBinary().
     * - Mid level: Custom-make the list of segments and call QrCode.encodeSegments().
     * - Low level: Custom-make the array of data codeword bytes (including
     *   segment headers and final padding, excluding error correction codewords),
     *   supply the appropriate version number, and call the QrCode() constructor.
     * (Note that all ways require supplying the desired error correction level.)
     */
    var QrCode = /** @class */ (function () {
        /*-- Constructor (low level) and fields --*/
        // Creates a new QR Code with the given version number,
        // error correction level, data codeword bytes, and mask number.
        // This is a low-level API that most users should not use directly.
        // A mid-level API is the encodeSegments() function.
        function QrCode(
        // The version number of this QR Code, which is between 1 and 40 (inclusive).
        // This determines the size of this barcode.
        version, 
        // The error correction level used in this QR Code.
        errorCorrectionLevel, dataCodewords, msk) {
            this.version = version;
            this.errorCorrectionLevel = errorCorrectionLevel;
            // The modules of this QR Code (false = light, true = dark).
            // Immutable after constructor finishes. Accessed through getModule().
            this.modules = [];
            // Indicates function modules that are not subjected to masking. Discarded when constructor finishes.
            this.isFunction = [];
            // Check scalar arguments
            if (version < QrCode.MIN_VERSION || version > QrCode.MAX_VERSION)
                throw new RangeError("Version value out of range");
            if (msk < -1 || msk > 7)
                throw new RangeError("Mask value out of range");
            this.size = version * 4 + 17;
            // Initialize both grids to be size*size arrays of Boolean false
            var row = [];
            for (var i = 0; i < this.size; i++)
                row.push(false);
            for (var i = 0; i < this.size; i++) {
                this.modules.push(row.slice()); // Initially all light
                this.isFunction.push(row.slice());
            }
            // Compute ECC, draw modules
            this.drawFunctionPatterns();
            var allCodewords = this.addEccAndInterleave(dataCodewords);
            this.drawCodewords(allCodewords);
            // Do masking
            if (msk == -1) { // Automatically choose best mask
                var minPenalty = 1000000000;
                for (var i = 0; i < 8; i++) {
                    this.applyMask(i);
                    this.drawFormatBits(i);
                    var penalty = this.getPenaltyScore();
                    if (penalty < minPenalty) {
                        msk = i;
                        minPenalty = penalty;
                    }
                    this.applyMask(i); // Undoes the mask due to XOR
                }
            }
            assert(0 <= msk && msk <= 7);
            this.mask = msk;
            this.applyMask(msk); // Apply the final choice of mask
            this.drawFormatBits(msk); // Overwrite old format bits
            this.isFunction = [];
        }
        /*-- Static factory functions (high level) --*/
        // Returns a QR Code representing the given Unicode text string at the given error correction level.
        // As a conservative upper bound, this function is guaranteed to succeed for strings that have 738 or fewer
        // Unicode code points (not UTF-16 code units) if the low error correction level is used. The smallest possible
        // QR Code version is automatically chosen for the output. The ECC level of the result may be higher than the
        // ecl argument if it can be done without increasing the version.
        QrCode.encodeText = function (text, ecl) {
            var segs = qrcodegen.QrSegment.makeSegments(text);
            return QrCode.encodeSegments(segs, ecl);
        };
        // Returns a QR Code representing the given binary data at the given error correction level.
        // This function always encodes using the binary segment mode, not any text mode. The maximum number of
        // bytes allowed is 2953. The smallest possible QR Code version is automatically chosen for the output.
        // The ECC level of the result may be higher than the ecl argument if it can be done without increasing the version.
        QrCode.encodeBinary = function (data, ecl) {
            var seg = qrcodegen.QrSegment.makeBytes(data);
            return QrCode.encodeSegments([seg], ecl);
        };
        /*-- Static factory functions (mid level) --*/
        // Returns a QR Code representing the given segments with the given encoding parameters.
        // The smallest possible QR Code version within the given range is automatically
        // chosen for the output. Iff boostEcl is true, then the ECC level of the result
        // may be higher than the ecl argument if it can be done without increasing the
        // version. The mask number is either between 0 to 7 (inclusive) to force that
        // mask, or -1 to automatically choose an appropriate mask (which may be slow).
        // This function allows the user to create a custom sequence of segments that switches
        // between modes (such as alphanumeric and byte) to encode text in less space.
        // This is a mid-level API; the high-level API is encodeText() and encodeBinary().
        QrCode.encodeSegments = function (segs, ecl, minVersion, maxVersion, mask, boostEcl) {
            if (minVersion === void 0) { minVersion = 1; }
            if (maxVersion === void 0) { maxVersion = 40; }
            if (mask === void 0) { mask = -1; }
            if (boostEcl === void 0) { boostEcl = true; }
            if (!(QrCode.MIN_VERSION <= minVersion && minVersion <= maxVersion && maxVersion <= QrCode.MAX_VERSION)
                || mask < -1 || mask > 7)
                throw new RangeError("Invalid value");
            // Find the minimal version number to use
            var version;
            var dataUsedBits;
            for (version = minVersion;; version++) {
                var dataCapacityBits_1 = QrCode.getNumDataCodewords(version, ecl) * 8; // Number of data bits available
                var usedBits = QrSegment.getTotalBits(segs, version);
                if (usedBits <= dataCapacityBits_1) {
                    dataUsedBits = usedBits;
                    break; // This version number is found to be suitable
                }
                if (version >= maxVersion) // All versions in the range could not fit the given data
                    throw new RangeError("Data too long");
            }
            // Increase the error correction level while the data still fits in the current version number
            for (var _i = 0, _a = [QrCode.Ecc.MEDIUM, QrCode.Ecc.QUARTILE, QrCode.Ecc.HIGH]; _i < _a.length; _i++) { // From low to high
                var newEcl = _a[_i];
                if (boostEcl && dataUsedBits <= QrCode.getNumDataCodewords(version, newEcl) * 8)
                    ecl = newEcl;
            }
            // Concatenate all segments to create the data bit string
            var bb = [];
            for (var _b = 0, segs_1 = segs; _b < segs_1.length; _b++) {
                var seg = segs_1[_b];
                appendBits(seg.mode.modeBits, 4, bb);
                appendBits(seg.numChars, seg.mode.numCharCountBits(version), bb);
                for (var _c = 0, _d = seg.getData(); _c < _d.length; _c++) {
                    var b = _d[_c];
                    bb.push(b);
                }
            }
            assert(bb.length == dataUsedBits);
            // Add terminator and pad up to a byte if applicable
            var dataCapacityBits = QrCode.getNumDataCodewords(version, ecl) * 8;
            assert(bb.length <= dataCapacityBits);
            appendBits(0, Math.min(4, dataCapacityBits - bb.length), bb);
            appendBits(0, (8 - bb.length % 8) % 8, bb);
            assert(bb.length % 8 == 0);
            // Pad with alternating bytes until data capacity is reached
            for (var padByte = 0xEC; bb.length < dataCapacityBits; padByte ^= 0xEC ^ 0x11)
                appendBits(padByte, 8, bb);
            // Pack bits into bytes in big endian
            var dataCodewords = [];
            while (dataCodewords.length * 8 < bb.length)
                dataCodewords.push(0);
            bb.forEach(function (b, i) {
                return dataCodewords[i >>> 3] |= b << (7 - (i & 7));
            });
            // Create the QR Code object
            return new QrCode(version, ecl, dataCodewords, mask);
        };
        /*-- Accessor methods --*/
        // Returns the color of the module (pixel) at the given coordinates, which is false
        // for light or true for dark. The top left corner has the coordinates (x=0, y=0).
        // If the given coordinates are out of bounds, then false (light) is returned.
        QrCode.prototype.getModule = function (x, y) {
            return 0 <= x && x < this.size && 0 <= y && y < this.size && this.modules[y][x];
        };
        /*-- Private helper methods for constructor: Drawing function modules --*/
        // Reads this object's version field, and draws and marks all function modules.
        QrCode.prototype.drawFunctionPatterns = function () {
            // Draw horizontal and vertical timing patterns
            for (var i = 0; i < this.size; i++) {
                this.setFunctionModule(6, i, i % 2 == 0);
                this.setFunctionModule(i, 6, i % 2 == 0);
            }
            // Draw 3 finder patterns (all corners except bottom right; overwrites some timing modules)
            this.drawFinderPattern(3, 3);
            this.drawFinderPattern(this.size - 4, 3);
            this.drawFinderPattern(3, this.size - 4);
            // Draw numerous alignment patterns
            var alignPatPos = this.getAlignmentPatternPositions();
            var numAlign = alignPatPos.length;
            for (var i = 0; i < numAlign; i++) {
                for (var j = 0; j < numAlign; j++) {
                    // Don't draw on the three finder corners
                    if (!(i == 0 && j == 0 || i == 0 && j == numAlign - 1 || i == numAlign - 1 && j == 0))
                        this.drawAlignmentPattern(alignPatPos[i], alignPatPos[j]);
                }
            }
            // Draw configuration data
            this.drawFormatBits(0); // Dummy mask value; overwritten later in the constructor
            this.drawVersion();
        };
        // Draws two copies of the format bits (with its own error correction code)
        // based on the given mask and this object's error correction level field.
        QrCode.prototype.drawFormatBits = function (mask) {
            // Calculate error correction code and pack bits
            var data = this.errorCorrectionLevel.formatBits << 3 | mask; // errCorrLvl is uint2, mask is uint3
            var rem = data;
            for (var i = 0; i < 10; i++)
                rem = (rem << 1) ^ ((rem >>> 9) * 0x537);
            var bits = (data << 10 | rem) ^ 0x5412; // uint15
            assert(bits >>> 15 == 0);
            // Draw first copy
            for (var i = 0; i <= 5; i++)
                this.setFunctionModule(8, i, getBit(bits, i));
            this.setFunctionModule(8, 7, getBit(bits, 6));
            this.setFunctionModule(8, 8, getBit(bits, 7));
            this.setFunctionModule(7, 8, getBit(bits, 8));
            for (var i = 9; i < 15; i++)
                this.setFunctionModule(14 - i, 8, getBit(bits, i));
            // Draw second copy
            for (var i = 0; i < 8; i++)
                this.setFunctionModule(this.size - 1 - i, 8, getBit(bits, i));
            for (var i = 8; i < 15; i++)
                this.setFunctionModule(8, this.size - 15 + i, getBit(bits, i));
            this.setFunctionModule(8, this.size - 8, true); // Always dark
        };
        // Draws two copies of the version bits (with its own error correction code),
        // based on this object's version field, iff 7 <= version <= 40.
        QrCode.prototype.drawVersion = function () {
            if (this.version < 7)
                return;
            // Calculate error correction code and pack bits
            var rem = this.version; // version is uint6, in the range [7, 40]
            for (var i = 0; i < 12; i++)
                rem = (rem << 1) ^ ((rem >>> 11) * 0x1F25);
            var bits = this.version << 12 | rem; // uint18
            assert(bits >>> 18 == 0);
            // Draw two copies
            for (var i = 0; i < 18; i++) {
                var color = getBit(bits, i);
                var a = this.size - 11 + i % 3;
                var b = Math.floor(i / 3);
                this.setFunctionModule(a, b, color);
                this.setFunctionModule(b, a, color);
            }
        };
        // Draws a 9*9 finder pattern including the border separator,
        // with the center module at (x, y). Modules can be out of bounds.
        QrCode.prototype.drawFinderPattern = function (x, y) {
            for (var dy = -4; dy <= 4; dy++) {
                for (var dx = -4; dx <= 4; dx++) {
                    var dist = Math.max(Math.abs(dx), Math.abs(dy)); // Chebyshev/infinity norm
                    var xx = x + dx;
                    var yy = y + dy;
                    if (0 <= xx && xx < this.size && 0 <= yy && yy < this.size)
                        this.setFunctionModule(xx, yy, dist != 2 && dist != 4);
                }
            }
        };
        // Draws a 5*5 alignment pattern, with the center module
        // at (x, y). All modules must be in bounds.
        QrCode.prototype.drawAlignmentPattern = function (x, y) {
            for (var dy = -2; dy <= 2; dy++) {
                for (var dx = -2; dx <= 2; dx++)
                    this.setFunctionModule(x + dx, y + dy, Math.max(Math.abs(dx), Math.abs(dy)) != 1);
            }
        };
        // Sets the color of a module and marks it as a function module.
        // Only used by the constructor. Coordinates must be in bounds.
        QrCode.prototype.setFunctionModule = function (x, y, isDark) {
            this.modules[y][x] = isDark;
            this.isFunction[y][x] = true;
        };
        /*-- Private helper methods for constructor: Codewords and masking --*/
        // Returns a new byte string representing the given data with the appropriate error correction
        // codewords appended to it, based on this object's version and error correction level.
        QrCode.prototype.addEccAndInterleave = function (data) {
            var ver = this.version;
            var ecl = this.errorCorrectionLevel;
            if (data.length != QrCode.getNumDataCodewords(ver, ecl))
                throw new RangeError("Invalid argument");
            // Calculate parameter numbers
            var numBlocks = QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
            var blockEccLen = QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver];
            var rawCodewords = Math.floor(QrCode.getNumRawDataModules(ver) / 8);
            var numShortBlocks = numBlocks - rawCodewords % numBlocks;
            var shortBlockLen = Math.floor(rawCodewords / numBlocks);
            // Split data into blocks and append ECC to each block
            var blocks = [];
            var rsDiv = QrCode.reedSolomonComputeDivisor(blockEccLen);
            for (var i = 0, k = 0; i < numBlocks; i++) {
                var dat = data.slice(k, k + shortBlockLen - blockEccLen + (i < numShortBlocks ? 0 : 1));
                k += dat.length;
                var ecc = QrCode.reedSolomonComputeRemainder(dat, rsDiv);
                if (i < numShortBlocks)
                    dat.push(0);
                blocks.push(dat.concat(ecc));
            }
            // Interleave (not concatenate) the bytes from every block into a single sequence
            var result = [];
            var _loop_1 = function (i) {
                blocks.forEach(function (block, j) {
                    // Skip the padding byte in short blocks
                    if (i != shortBlockLen - blockEccLen || j >= numShortBlocks)
                        result.push(block[i]);
                });
            };
            for (var i = 0; i < blocks[0].length; i++) {
                _loop_1(i);
            }
            assert(result.length == rawCodewords);
            return result;
        };
        // Draws the given sequence of 8-bit codewords (data and error correction) onto the entire
        // data area of this QR Code. Function modules need to be marked off before this is called.
        QrCode.prototype.drawCodewords = function (data) {
            if (data.length != Math.floor(QrCode.getNumRawDataModules(this.version) / 8))
                throw new RangeError("Invalid argument");
            var i = 0; // Bit index into the data
            // Do the funny zigzag scan
            for (var right = this.size - 1; right >= 1; right -= 2) { // Index of right column in each column pair
                if (right == 6)
                    right = 5;
                for (var vert = 0; vert < this.size; vert++) { // Vertical counter
                    for (var j = 0; j < 2; j++) {
                        var x = right - j; // Actual x coordinate
                        var upward = ((right + 1) & 2) == 0;
                        var y = upward ? this.size - 1 - vert : vert; // Actual y coordinate
                        if (!this.isFunction[y][x] && i < data.length * 8) {
                            this.modules[y][x] = getBit(data[i >>> 3], 7 - (i & 7));
                            i++;
                        }
                        // If this QR Code has any remainder bits (0 to 7), they were assigned as
                        // 0/false/light by the constructor and are left unchanged by this method
                    }
                }
            }
            assert(i == data.length * 8);
        };
        // XORs the codeword modules in this QR Code with the given mask pattern.
        // The function modules must be marked and the codeword bits must be drawn
        // before masking. Due to the arithmetic of XOR, calling applyMask() with
        // the same mask value a second time will undo the mask. A final well-formed
        // QR Code needs exactly one (not zero, two, etc.) mask applied.
        QrCode.prototype.applyMask = function (mask) {
            if (mask < 0 || mask > 7)
                throw new RangeError("Mask value out of range");
            for (var y = 0; y < this.size; y++) {
                for (var x = 0; x < this.size; x++) {
                    var invert = void 0;
                    switch (mask) {
                        case 0:
                            invert = (x + y) % 2 == 0;
                            break;
                        case 1:
                            invert = y % 2 == 0;
                            break;
                        case 2:
                            invert = x % 3 == 0;
                            break;
                        case 3:
                            invert = (x + y) % 3 == 0;
                            break;
                        case 4:
                            invert = (Math.floor(x / 3) + Math.floor(y / 2)) % 2 == 0;
                            break;
                        case 5:
                            invert = x * y % 2 + x * y % 3 == 0;
                            break;
                        case 6:
                            invert = (x * y % 2 + x * y % 3) % 2 == 0;
                            break;
                        case 7:
                            invert = ((x + y) % 2 + x * y % 3) % 2 == 0;
                            break;
                        default: throw new Error("Unreachable");
                    }
                    if (!this.isFunction[y][x] && invert)
                        this.modules[y][x] = !this.modules[y][x];
                }
            }
        };
        // Calculates and returns the penalty score based on state of this QR Code's current modules.
        // This is used by the automatic mask choice algorithm to find the mask pattern that yields the lowest score.
        QrCode.prototype.getPenaltyScore = function () {
            var result = 0;
            // Adjacent modules in row having same color, and finder-like patterns
            for (var y = 0; y < this.size; y++) {
                var runColor = false;
                var runX = 0;
                var runHistory = [0, 0, 0, 0, 0, 0, 0];
                for (var x = 0; x < this.size; x++) {
                    if (this.modules[y][x] == runColor) {
                        runX++;
                        if (runX == 5)
                            result += QrCode.PENALTY_N1;
                        else if (runX > 5)
                            result++;
                    }
                    else {
                        this.finderPenaltyAddHistory(runX, runHistory);
                        if (!runColor)
                            result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                        runColor = this.modules[y][x];
                        runX = 1;
                    }
                }
                result += this.finderPenaltyTerminateAndCount(runColor, runX, runHistory) * QrCode.PENALTY_N3;
            }
            // Adjacent modules in column having same color, and finder-like patterns
            for (var x = 0; x < this.size; x++) {
                var runColor = false;
                var runY = 0;
                var runHistory = [0, 0, 0, 0, 0, 0, 0];
                for (var y = 0; y < this.size; y++) {
                    if (this.modules[y][x] == runColor) {
                        runY++;
                        if (runY == 5)
                            result += QrCode.PENALTY_N1;
                        else if (runY > 5)
                            result++;
                    }
                    else {
                        this.finderPenaltyAddHistory(runY, runHistory);
                        if (!runColor)
                            result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                        runColor = this.modules[y][x];
                        runY = 1;
                    }
                }
                result += this.finderPenaltyTerminateAndCount(runColor, runY, runHistory) * QrCode.PENALTY_N3;
            }
            // 2*2 blocks of modules having same color
            for (var y = 0; y < this.size - 1; y++) {
                for (var x = 0; x < this.size - 1; x++) {
                    var color = this.modules[y][x];
                    if (color == this.modules[y][x + 1] &&
                        color == this.modules[y + 1][x] &&
                        color == this.modules[y + 1][x + 1])
                        result += QrCode.PENALTY_N2;
                }
            }
            // Balance of dark and light modules
            var dark = 0;
            for (var _i = 0, _a = this.modules; _i < _a.length; _i++) {
                var row = _a[_i];
                dark = row.reduce(function (sum, color) { return sum + (color ? 1 : 0); }, dark);
            }
            var total = this.size * this.size; // Note that size is odd, so dark/total != 1/2
            // Compute the smallest integer k >= 0 such that (45-5k)% <= dark/total <= (55+5k)%
            var k = Math.ceil(Math.abs(dark * 20 - total * 10) / total) - 1;
            assert(0 <= k && k <= 9);
            result += k * QrCode.PENALTY_N4;
            assert(0 <= result && result <= 2568888); // Non-tight upper bound based on default values of PENALTY_N1, ..., N4
            return result;
        };
        /*-- Private helper functions --*/
        // Returns an ascending list of positions of alignment patterns for this version number.
        // Each position is in the range [0,177), and are used on both the x and y axes.
        // This could be implemented as lookup table of 40 variable-length lists of integers.
        QrCode.prototype.getAlignmentPatternPositions = function () {
            if (this.version == 1)
                return [];
            else {
                var numAlign = Math.floor(this.version / 7) + 2;
                var step = Math.floor((this.version * 8 + numAlign * 3 + 5) / (numAlign * 4 - 4)) * 2;
                var result = [6];
                for (var pos = this.size - 7; result.length < numAlign; pos -= step)
                    result.splice(1, 0, pos);
                return result;
            }
        };
        // Returns the number of data bits that can be stored in a QR Code of the given version number, after
        // all function modules are excluded. This includes remainder bits, so it might not be a multiple of 8.
        // The result is in the range [208, 29648]. This could be implemented as a 40-entry lookup table.
        QrCode.getNumRawDataModules = function (ver) {
            if (ver < QrCode.MIN_VERSION || ver > QrCode.MAX_VERSION)
                throw new RangeError("Version number out of range");
            var result = (16 * ver + 128) * ver + 64;
            if (ver >= 2) {
                var numAlign = Math.floor(ver / 7) + 2;
                result -= (25 * numAlign - 10) * numAlign - 55;
                if (ver >= 7)
                    result -= 36;
            }
            assert(208 <= result && result <= 29648);
            return result;
        };
        // Returns the number of 8-bit data (i.e. not error correction) codewords contained in any
        // QR Code of the given version number and error correction level, with remainder bits discarded.
        // This stateless pure function could be implemented as a (40*4)-cell lookup table.
        QrCode.getNumDataCodewords = function (ver, ecl) {
            return Math.floor(QrCode.getNumRawDataModules(ver) / 8) -
                QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver] *
                    QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
        };
        // Returns a Reed-Solomon ECC generator polynomial for the given degree. This could be
        // implemented as a lookup table over all possible parameter values, instead of as an algorithm.
        QrCode.reedSolomonComputeDivisor = function (degree) {
            if (degree < 1 || degree > 255)
                throw new RangeError("Degree out of range");
            // Polynomial coefficients are stored from highest to lowest power, excluding the leading term which is always 1.
            // For example the polynomial x^3 + 255x^2 + 8x + 93 is stored as the uint8 array [255, 8, 93].
            var result = [];
            for (var i = 0; i < degree - 1; i++)
                result.push(0);
            result.push(1); // Start off with the monomial x^0
            // Compute the product polynomial (x - r^0) * (x - r^1) * (x - r^2) * ... * (x - r^{degree-1}),
            // and drop the highest monomial term which is always 1x^degree.
            // Note that r = 0x02, which is a generator element of this field GF(2^8/0x11D).
            var root = 1;
            for (var i = 0; i < degree; i++) {
                // Multiply the current product by (x - r^i)
                for (var j = 0; j < result.length; j++) {
                    result[j] = QrCode.reedSolomonMultiply(result[j], root);
                    if (j + 1 < result.length)
                        result[j] ^= result[j + 1];
                }
                root = QrCode.reedSolomonMultiply(root, 0x02);
            }
            return result;
        };
        // Returns the Reed-Solomon error correction codeword for the given data and divisor polynomials.
        QrCode.reedSolomonComputeRemainder = function (data, divisor) {
            var result = divisor.map(function (_) { return 0; });
            var _loop_2 = function (b) {
                var factor = b ^ result.shift();
                result.push(0);
                divisor.forEach(function (coef, i) {
                    return result[i] ^= QrCode.reedSolomonMultiply(coef, factor);
                });
            };
            for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {
                var b = data_1[_i];
                _loop_2(b);
            }
            return result;
        };
        // Returns the product of the two given field elements modulo GF(2^8/0x11D). The arguments and result
        // are unsigned 8-bit integers. This could be implemented as a lookup table of 256*256 entries of uint8.
        QrCode.reedSolomonMultiply = function (x, y) {
            if (x >>> 8 != 0 || y >>> 8 != 0)
                throw new RangeError("Byte out of range");
            // Russian peasant multiplication
            var z = 0;
            for (var i = 7; i >= 0; i--) {
                z = (z << 1) ^ ((z >>> 7) * 0x11D);
                z ^= ((y >>> i) & 1) * x;
            }
            assert(z >>> 8 == 0);
            return z;
        };
        // Can only be called immediately after a light run is added, and
        // returns either 0, 1, or 2. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyCountPatterns = function (runHistory) {
            var n = runHistory[1];
            assert(n <= this.size * 3);
            var core = n > 0 && runHistory[2] == n && runHistory[3] == n * 3 && runHistory[4] == n && runHistory[5] == n;
            return (core && runHistory[0] >= n * 4 && runHistory[6] >= n ? 1 : 0)
                + (core && runHistory[6] >= n * 4 && runHistory[0] >= n ? 1 : 0);
        };
        // Must be called at the end of a line (row or column) of modules. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyTerminateAndCount = function (currentRunColor, currentRunLength, runHistory) {
            if (currentRunColor) { // Terminate dark run
                this.finderPenaltyAddHistory(currentRunLength, runHistory);
                currentRunLength = 0;
            }
            currentRunLength += this.size; // Add light border to final run
            this.finderPenaltyAddHistory(currentRunLength, runHistory);
            return this.finderPenaltyCountPatterns(runHistory);
        };
        // Pushes the given value to the front and drops the last value. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyAddHistory = function (currentRunLength, runHistory) {
            if (runHistory[0] == 0)
                currentRunLength += this.size; // Add light border to initial run
            runHistory.pop();
            runHistory.unshift(currentRunLength);
        };
        /*-- Constants and tables --*/
        // The minimum version number supported in the QR Code Model 2 standard.
        QrCode.MIN_VERSION = 1;
        // The maximum version number supported in the QR Code Model 2 standard.
        QrCode.MAX_VERSION = 40;
        // For use in getPenaltyScore(), when evaluating which mask is best.
        QrCode.PENALTY_N1 = 3;
        QrCode.PENALTY_N2 = 3;
        QrCode.PENALTY_N3 = 40;
        QrCode.PENALTY_N4 = 10;
        QrCode.ECC_CODEWORDS_PER_BLOCK = [
            // Version: (note that index 0 is for padding, and is set to an illegal value)
            //0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40    Error correction level
            [-1, 7, 10, 15, 20, 26, 18, 20, 24, 30, 18, 20, 24, 26, 30, 22, 24, 28, 30, 28, 28, 28, 28, 30, 30, 26, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // Low
            [-1, 10, 16, 26, 18, 24, 16, 18, 22, 22, 26, 30, 22, 22, 24, 24, 28, 28, 26, 26, 26, 26, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28], // Medium
            [-1, 13, 22, 18, 26, 18, 24, 18, 22, 20, 24, 28, 26, 24, 20, 30, 24, 28, 28, 26, 30, 28, 30, 30, 30, 30, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // Quartile
            [-1, 17, 28, 22, 16, 22, 28, 26, 26, 24, 28, 24, 28, 22, 24, 24, 30, 28, 28, 26, 28, 30, 24, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // High
        ];
        QrCode.NUM_ERROR_CORRECTION_BLOCKS = [
            // Version: (note that index 0 is for padding, and is set to an illegal value)
            //0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40    Error correction level
            [-1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 4, 4, 4, 4, 4, 6, 6, 6, 6, 7, 8, 8, 9, 9, 10, 12, 12, 12, 13, 14, 15, 16, 17, 18, 19, 19, 20, 21, 22, 24, 25], // Low
            [-1, 1, 1, 1, 2, 2, 4, 4, 4, 5, 5, 5, 8, 9, 9, 10, 10, 11, 13, 14, 16, 17, 17, 18, 20, 21, 23, 25, 26, 28, 29, 31, 33, 35, 37, 38, 40, 43, 45, 47, 49], // Medium
            [-1, 1, 1, 2, 2, 4, 4, 6, 6, 8, 8, 8, 10, 12, 16, 12, 17, 16, 18, 21, 20, 23, 23, 25, 27, 29, 34, 34, 35, 38, 40, 43, 45, 48, 51, 53, 56, 59, 62, 65, 68], // Quartile
            [-1, 1, 1, 2, 4, 4, 4, 5, 6, 8, 8, 11, 11, 16, 16, 18, 16, 19, 21, 25, 25, 25, 34, 30, 32, 35, 37, 40, 42, 45, 48, 51, 54, 57, 60, 63, 66, 70, 74, 77, 81], // High
        ];
        return QrCode;
    }());
    qrcodegen.QrCode = QrCode;
    // Appends the given number of low-order bits of the given value
    // to the given buffer. Requires 0 <= len <= 31 and 0 <= val < 2^len.
    function appendBits(val, len, bb) {
        if (len < 0 || len > 31 || val >>> len != 0)
            throw new RangeError("Value out of range");
        for (var i = len - 1; i >= 0; i--) // Append bit by bit
            bb.push((val >>> i) & 1);
    }
    // Returns true iff the i'th bit of x is set to 1.
    function getBit(x, i) {
        return ((x >>> i) & 1) != 0;
    }
    // Throws an exception if the given condition is false.
    function assert(cond) {
        if (!cond)
            throw new Error("Assertion error");
    }
    /*---- Data segment class ----*/
    /*
     * A segment of character/binary/control data in a QR Code symbol.
     * Instances of this class are immutable.
     * The mid-level way to create a segment is to take the payload data
     * and call a static factory function such as QrSegment.makeNumeric().
     * The low-level way to create a segment is to custom-make the bit buffer
     * and call the QrSegment() constructor with appropriate values.
     * This segment class imposes no length restrictions, but QR Codes have restrictions.
     * Even in the most favorable conditions, a QR Code can only hold 7089 characters of data.
     * Any segment longer than this is meaningless for the purpose of generating QR Codes.
     */
    var QrSegment = /** @class */ (function () {
        /*-- Constructor (low level) and fields --*/
        // Creates a new QR Code segment with the given attributes and data.
        // The character count (numChars) must agree with the mode and the bit buffer length,
        // but the constraint isn't checked. The given bit buffer is cloned and stored.
        function QrSegment(
        // The mode indicator of this segment.
        mode, 
        // The length of this segment's unencoded data. Measured in characters for
        // numeric/alphanumeric/kanji mode, bytes for byte mode, and 0 for ECI mode.
        // Always zero or positive. Not the same as the data's bit length.
        numChars, 
        // The data bits of this segment. Accessed through getData().
        bitData) {
            this.mode = mode;
            this.numChars = numChars;
            this.bitData = bitData;
            if (numChars < 0)
                throw new RangeError("Invalid argument");
            this.bitData = bitData.slice(); // Make defensive copy
        }
        /*-- Static factory functions (mid level) --*/
        // Returns a segment representing the given binary data encoded in
        // byte mode. All input byte arrays are acceptable. Any text string
        // can be converted to UTF-8 bytes and encoded as a byte mode segment.
        QrSegment.makeBytes = function (data) {
            var bb = [];
            for (var _i = 0, data_2 = data; _i < data_2.length; _i++) {
                var b = data_2[_i];
                appendBits(b, 8, bb);
            }
            return new QrSegment(QrSegment.Mode.BYTE, data.length, bb);
        };
        // Returns a segment representing the given string of decimal digits encoded in numeric mode.
        QrSegment.makeNumeric = function (digits) {
            if (!QrSegment.isNumeric(digits))
                throw new RangeError("String contains non-numeric characters");
            var bb = [];
            for (var i = 0; i < digits.length;) { // Consume up to 3 digits per iteration
                var n = Math.min(digits.length - i, 3);
                appendBits(parseInt(digits.substring(i, i + n), 10), n * 3 + 1, bb);
                i += n;
            }
            return new QrSegment(QrSegment.Mode.NUMERIC, digits.length, bb);
        };
        // Returns a segment representing the given text string encoded in alphanumeric mode.
        // The characters allowed are: 0 to 9, A to Z (uppercase only), space,
        // dollar, percent, asterisk, plus, hyphen, period, slash, colon.
        QrSegment.makeAlphanumeric = function (text) {
            if (!QrSegment.isAlphanumeric(text))
                throw new RangeError("String contains unencodable characters in alphanumeric mode");
            var bb = [];
            var i;
            for (i = 0; i + 2 <= text.length; i += 2) { // Process groups of 2
                var temp = QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)) * 45;
                temp += QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i + 1));
                appendBits(temp, 11, bb);
            }
            if (i < text.length) // 1 character remaining
                appendBits(QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)), 6, bb);
            return new QrSegment(QrSegment.Mode.ALPHANUMERIC, text.length, bb);
        };
        // Returns a new mutable list of zero or more segments to represent the given Unicode text string.
        // The result may use various segment modes and switch modes to optimize the length of the bit stream.
        QrSegment.makeSegments = function (text) {
            // Select the most efficient segment encoding automatically
            if (text == "")
                return [];
            else if (QrSegment.isNumeric(text))
                return [QrSegment.makeNumeric(text)];
            else if (QrSegment.isAlphanumeric(text))
                return [QrSegment.makeAlphanumeric(text)];
            else
                return [QrSegment.makeBytes(QrSegment.toUtf8ByteArray(text))];
        };
        // Returns a segment representing an Extended Channel Interpretation
        // (ECI) designator with the given assignment value.
        QrSegment.makeEci = function (assignVal) {
            var bb = [];
            if (assignVal < 0)
                throw new RangeError("ECI assignment value out of range");
            else if (assignVal < (1 << 7))
                appendBits(assignVal, 8, bb);
            else if (assignVal < (1 << 14)) {
                appendBits(2, 2, bb);
                appendBits(assignVal, 14, bb);
            }
            else if (assignVal < 1000000) {
                appendBits(6, 3, bb);
                appendBits(assignVal, 21, bb);
            }
            else
                throw new RangeError("ECI assignment value out of range");
            return new QrSegment(QrSegment.Mode.ECI, 0, bb);
        };
        // Tests whether the given string can be encoded as a segment in numeric mode.
        // A string is encodable iff each character is in the range 0 to 9.
        QrSegment.isNumeric = function (text) {
            return QrSegment.NUMERIC_REGEX.test(text);
        };
        // Tests whether the given string can be encoded as a segment in alphanumeric mode.
        // A string is encodable iff each character is in the following set: 0 to 9, A to Z
        // (uppercase only), space, dollar, percent, asterisk, plus, hyphen, period, slash, colon.
        QrSegment.isAlphanumeric = function (text) {
            return QrSegment.ALPHANUMERIC_REGEX.test(text);
        };
        /*-- Methods --*/
        // Returns a new copy of the data bits of this segment.
        QrSegment.prototype.getData = function () {
            return this.bitData.slice(); // Make defensive copy
        };
        // (Package-private) Calculates and returns the number of bits needed to encode the given segments at
        // the given version. The result is infinity if a segment has too many characters to fit its length field.
        QrSegment.getTotalBits = function (segs, version) {
            var result = 0;
            for (var _i = 0, segs_2 = segs; _i < segs_2.length; _i++) {
                var seg = segs_2[_i];
                var ccbits = seg.mode.numCharCountBits(version);
                if (seg.numChars >= (1 << ccbits))
                    return Infinity; // The segment's length doesn't fit the field's bit width
                result += 4 + ccbits + seg.bitData.length;
            }
            return result;
        };
        // Returns a new array of bytes representing the given string encoded in UTF-8.
        QrSegment.toUtf8ByteArray = function (str) {
            str = encodeURI(str);
            var result = [];
            for (var i = 0; i < str.length; i++) {
                if (str.charAt(i) != "%")
                    result.push(str.charCodeAt(i));
                else {
                    result.push(parseInt(str.substring(i + 1, i + 3), 16));
                    i += 2;
                }
            }
            return result;
        };
        /*-- Constants --*/
        // Describes precisely all strings that are encodable in numeric mode.
        QrSegment.NUMERIC_REGEX = /^[0-9]*$/;
        // Describes precisely all strings that are encodable in alphanumeric mode.
        QrSegment.ALPHANUMERIC_REGEX = /^[A-Z0-9 $%*+.\/:-]*$/;
        // The set of all legal characters in alphanumeric mode,
        // where each character value maps to the index in the string.
        QrSegment.ALPHANUMERIC_CHARSET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:";
        return QrSegment;
    }());
    qrcodegen.QrSegment = QrSegment;
})(qrcodegen || (qrcodegen = {}));
/*---- Public helper enumeration ----*/
(function (qrcodegen) {
    var QrCode;
    (function (QrCode) {
        /*
         * The error correction level in a QR Code symbol. Immutable.
         */
        var Ecc = /** @class */ (function () {
            /*-- Constructor and fields --*/
            function Ecc(
            // In the range 0 to 3 (unsigned 2-bit integer).
            ordinal, 
            // (Package-private) In the range 0 to 3 (unsigned 2-bit integer).
            formatBits) {
                this.ordinal = ordinal;
                this.formatBits = formatBits;
            }
            /*-- Constants --*/
            Ecc.LOW = new Ecc(0, 1); // The QR Code can tolerate about  7% erroneous codewords
            Ecc.MEDIUM = new Ecc(1, 0); // The QR Code can tolerate about 15% erroneous codewords
            Ecc.QUARTILE = new Ecc(2, 3); // The QR Code can tolerate about 25% erroneous codewords
            Ecc.HIGH = new Ecc(3, 2); // The QR Code can tolerate about 30% erroneous codewords
            return Ecc;
        }());
        QrCode.Ecc = Ecc;
    })(QrCode = qrcodegen.QrCode || (qrcodegen.QrCode = {}));
})(qrcodegen || (qrcodegen = {}));
/*---- Public helper enumeration ----*/
(function (qrcodegen) {
    var QrSegment;
    (function (QrSegment) {
        /*
         * Describes how a segment's data bits are interpreted. Immutable.
         */
        var Mode = /** @class */ (function () {
            /*-- Constructor and fields --*/
            function Mode(
            // The mode indicator bits, which is a uint4 value (range 0 to 15).
            modeBits, 
            // Number of character count bits for three different version ranges.
            numBitsCharCount) {
                this.modeBits = modeBits;
                this.numBitsCharCount = numBitsCharCount;
            }
            /*-- Method --*/
            // (Package-private) Returns the bit width of the character count field for a segment in
            // this mode in a QR Code at the given version number. The result is in the range [0, 16].
            Mode.prototype.numCharCountBits = function (ver) {
                return this.numBitsCharCount[Math.floor((ver + 7) / 17)];
            };
            /*-- Constants --*/
            Mode.NUMERIC = new Mode(0x1, [10, 12, 14]);
            Mode.ALPHANUMERIC = new Mode(0x2, [9, 11, 13]);
            Mode.BYTE = new Mode(0x4, [8, 16, 16]);
            Mode.KANJI = new Mode(0x8, [8, 10, 12]);
            Mode.ECI = new Mode(0x7, [0, 0, 0]);
            return Mode;
        }());
        QrSegment.Mode = Mode;
    })(QrSegment = qrcodegen.QrSegment || (qrcodegen.QrSegment = {}));
})(qrcodegen || (qrcodegen = {}));


const QRGenerator = {
  // payload: string | object
  generate(payload, canvas, size=180, opts={}){
    try{
      if(!canvas) return;
      const text = (typeof payload === 'string') ? payload : safeJson(payload);
      const ecc = (opts.ecc || 'M').toUpperCase();
      const border = (opts.border ?? 4);
      const ecl = ({
        'L': qrcodegen.QrCode.Ecc.LOW,
        'M': qrcodegen.QrCode.Ecc.MEDIUM,
        'Q': qrcodegen.QrCode.Ecc.QUARTILE,
        'H': qrcodegen.QrCode.Ecc.HIGH
      })[ecc] || qrcodegen.QrCode.Ecc.MEDIUM;

      const qr = qrcodegen.QrCode.encodeText(text, ecl);
      this._draw(canvas, qr, size, border);
    }catch(e){
      console.warn('QRGenerator failed:', e);
      try{
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.height = size;
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = '#111';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText('QR error', 10, 20);
      }catch(_){}
      Toast.show('QR generation failed. Try shorter text / code.', 2500);
    }
  },
  _draw(canvas, qr, size, border){
    const n = qr.size;
    const scale = Math.floor(size / (n + border*2)) || 1;
    const realSize = (n + border*2) * scale;

    const ctx = canvas.getContext('2d');
    canvas.width = canvas.height = realSize;

    // background
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,realSize,realSize);

    ctx.fillStyle = '#000';
    for(let y=0;y<n;y++){
      for(let x=0;x<n;x++){
        if(qr.getModule(x,y)){
          ctx.fillRect((x+border)*scale, (y+border)*scale, scale, scale);
        }
      }
    }
  }
};


/* ----------------------------- VOICE RECALL (V20) ----------------------------- */
const VoiceRecall = {
  key:'voice_recall',
  rec:null,
  chunks:[],
  recording:false,

  async hasClip(){
    const b=await Store.getBlob(this.key);
    return !!b;
  },

  async record5s(){
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        Toast.show('Mic not supported on this device/browser');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
      const mr = new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
      this.rec=mr;
      this.chunks=[];
      this.recording=true;

      Toast.show('Recording... (5 seconds)');
      mr.ondataavailable = e => { if(e.data && e.data.size>0) this.chunks.push(e.data); };
      mr.onstop = async () => {
        this.recording=false;
        stream.getTracks().forEach(t=>t.stop());
        const blob = new Blob(this.chunks, {type: mr.mimeType || 'audio/webm'});
        const ok = await Store.saveBlob(this.key, blob);
        if(ok) Toast.show('Voice Recall saved ‚úî');
        else Toast.show('Could not save recording (storage full?)');
      };

      mr.start();
      setTimeout(()=>{ try{ mr.stop(); }catch(e){} }, 5000);
    }catch(e){
      Toast.show('Recording failed: '+(e.message||e.name||'unknown'));
    }
  },

  async play(opts={}){
    try{
      const blob = await Store.getBlob(this.key);
      if(!blob){
        if(!opts.silentFail) Toast.show('No voice clip yet. Record first.');
        return false;
      }
      // Best effort unlock audio context
      await AudioEngine.ensure();

      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.volume = AudioEngine.vol;
      const p = a.play();
      if(p && p.catch) await p.catch(()=>{});
      setTimeout(()=>URL.revokeObjectURL(url), 15000);
      return true;
    }catch(e){
      if(!opts.silentFail) Toast.show('Playback blocked by browser');
      return false;
    }
  },

  async clear(){
    await Store.saveBlob(this.key, null);
    Toast.show('Voice clip cleared');
  }
};

/* ----------------------------- VOICE ANNOUNCER (TTS) ----------------------------- */
const VoiceAnnouncer = {
  lastSpokenMs:0,

  supported(){
    return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
  },

  speak(text){
    if(!Settings.prefs.tts) return;
    if(!this.supported()) return;
    const now=nowMs();
    if(now-this.lastSpokenMs<4500) return; // avoid spam
    this.lastSpokenMs=now;

    try{
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.02;
      u.pitch = 1.0;
      u.volume = clamp(AudioEngine.vol, 0.1, 1);
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  },

  zoneMessage(pet){
    const z=pet.zone.stable;
    if(z==='SAFE') return `${pet.name} safe.`;
    if(z==='CAUTION') return `${pet.name} caution.`;
    if(z==='WARNING') return `${pet.name} warning.`;
    if(z==='DANGER') return `${pet.name} danger.`;
    if(z==='LOST') return `${pet.name} lost signal.`;
    return `${pet.name} status changed.`;
  }
};

/* ----------------------------- BLE MATCHING ----------------------------- */
function _mfgPrefixHexFromEvent(event){
  try{
    if(!event.manufacturerData) return null;
    let pref=null;
    event.manufacturerData.forEach((v,k)=>{
      if(pref) return;
      const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
      pref=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    });
    return pref;
  }catch(e){
    return null;
  }
}

function matchScore(event, sig){
  if(!sig) return 0;
  let score=0;
  const dn=event.device.name||'';
  const di=event.device.id||'';

  if(sig.deviceId && di===sig.deviceId) score+=0.60;

  if(sig.nameExact && dn===sig.nameExact) score+=0.50;
  else if(sig.namePrefix && dn.toLowerCase().startsWith(sig.namePrefix.toLowerCase())) score+=0.30;

  if(sig.serviceUuids && event.uuids){
    const eu=event.uuids.map(u=>u.toString().toLowerCase());
    if(sig.serviceUuids.some(u=>eu.includes(u.toLowerCase()))) score+=0.25;
  }

  if(sig.manufacturerId!==undefined && event.manufacturerData){
    event.manufacturerData.forEach((v,k)=>{ if(k===sig.manufacturerId) score+=0.20; });
  }

  if(sig.manufacturerDataPrefixHex && event.manufacturerData){
    const pref=_mfgPrefixHexFromEvent(event);
    if(pref && pref===sig.manufacturerDataPrefixHex) score+=0.20; // v4.1: stronger manufacturer prefix weight
  }

  if(sig.confirmed) score=Math.min(1, score*1.15);
  return Math.min(1, score);
}

function routeAdvertisement(event, pets, now){
  if(!pets.length) return;

  const rssi=event.rssi;
  if(typeof rssi!=='number' || isNaN(rssi)) return;

  const scores=pets
    .map(p=>({pet:p, score:matchScore(event,p.signature)}))
    .filter(s=>s.score>0)
    .sort((a,b)=>b.score-a.score);

  if(scores.length===0) return;

  const top1=scores[0];
  const threshold = (top1.pet.signature && top1.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
  if(top1.score < threshold) return;

  // Collision protection
  if(scores.length>=2){
    const top2=scores[1];
    const t2=(top2.pet.signature && top2.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
    if(top2.score>=t2 && (top1.score-top2.score)<GAP_MIN){
      top1.pet.ambiguousCount++;
      top1.pet.lastAmbiguousMs=now;
      top1.pet.whyText='Signal ambiguous (multiple tags match)';
      return;
    }
  }

  // Focus mode: process only focused pet; others keep raw
  if(App.trackMode==='focus' && App.focusPetId && top1.pet.id!==App.focusPetId){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  // Per-pet throttle
  if(now-top1.pet.lastProcessMs < top1.pet.getMinInterval()){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  top1.pet.processRssi(rssi, now);
}

/* ----------------------------- BLE ENGINE (V35 hardened + V40 fixes) ----------------------------- */
const BLE = {
  scanning:false,
  scanReq:null,
  _handler:null,
  supported:false,

  // restart protection
  restartCount:0,
  restartWindowStart:0,
  restartInProgress:false,
  lastRestartMs:0,
  lastRestartReason:'',

  // scan mode
  lastScanMode:'track',
  usingFilters:false,

  // scan health
  lastAnyAdvMs:0,
  stallCount:0,

  // adv/sec rolling
  advPerSec:0,
  _secStart:0,
  _secCount:0,
  _secRing:new RingBuffer(6),

  lastErrorName:'',
  lastErrorMessage:'',

  checkSupport(){
    if(!navigator.bluetooth) return false;
    if(typeof navigator.bluetooth.requestLEScan!=='function') return false;
    if(location.protocol!=='https:' && location.hostname!=='localhost' && location.hostname!=='127.0.0.1' && !location.protocol.startsWith('file')) return false;
    return true;
  },

  _resetCounters(){
    this.lastAnyAdvMs = nowMs();
    this.advPerSec = 0;
    this._secStart = nowMs();
    this._secCount = 0;
    this._secRing.clear();
  },

  markAdv(now){
    // rolling adv/sec
    if(!this._secStart) this._secStart=now;
    if(now - this._secStart >= 1000){
      this._secRing.push(this._secCount);
      const avg = this._secRing.length ? (this._secRing.data.reduce((a,b)=>a+b,0)/this._secRing.length) : this._secCount;
      this.advPerSec = Math.round(avg*10)/10;
      this._secStart = now;
      this._secCount = 0;
    }
    this._secCount++;
    this.lastAnyAdvMs = now;
  },

  congestionLevel(){
    const a=this.advPerSec;
    if(a>12) return 'high';
    if(a>=3) return 'med';
    return 'low';
  },

  _buildTrackFilters(){
    // Prefer filters to reduce overload.
    // Only uses namePrefix (safe), because IDs aren't usable in scan filters.
    let pets = App.pets || [];
    if(App.trackMode==='focus' && App.focusPetId){
      pets = pets.filter(p=>p.id===App.focusPetId);
    }
    const prefixes = pets
      .map(p=>p.signature && p.signature.namePrefix ? String(p.signature.namePrefix).trim() : '')
      .filter(x=>x && x.length>=2);

    // De-dup
    const uniq=[...new Set(prefixes)].slice(0,5);
    if(!uniq.length) return null;

    // Build filters
    return uniq.map(p=>({namePrefix:p}));
  },

  async startScan(mode='track', opts={}){
    this.lastErrorName=''; this.lastErrorMessage='';
    this.supported=this.checkSupport();
    if(!this.supported) return false;

    // If already scanning in same mode, do nothing
    if(this.scanning && this.lastScanMode===mode && this.scanReq) return true;

    // Switch mode: stop first (important when track uses filters)
    if(this.scanning && this.lastScanMode!==mode){
      this.stopScan();
      await new Promise(r=>setTimeout(r, 250));
    }

    try{
      // Ensure single event handler registration
      if(!this._handler){
        this._handler = e => {
          const n=nowMs();
          this.markAdv(n);
          App.onAdvertisement(e);
        };
        navigator.bluetooth.addEventListener('advertisementreceived', this._handler);
      }

      let options={keepRepeatedDevices:true};

      if(mode==='track'){
        const filters=this._buildTrackFilters();
        if(filters && filters.length){
          options.filters=filters;
          this.usingFilters=true;
        }else{
          options.acceptAllAdvertisements=true;
          this.usingFilters=false;
        }
      }else{
        // register / wizard
        options.acceptAllAdvertisements=true;
        this.usingFilters=false;
      }

      // request scan
      this.lastScanMode=mode;
      this.scanReq = await navigator.bluetooth.requestLEScan(options);
      this.scanning = true;
      this._resetCounters();
      return true;

    }catch(e){
      console.error('BLE scan error:', e);
      this.lastErrorName = e && e.name ? e.name : 'Error';
      this.lastErrorMessage = e && e.message ? e.message : '';

      // Do not spam on silent attempts (auto-start)
      if(!opts.silent){
        if(this.lastErrorName==='NotAllowedError') Toast.show('Bluetooth permission denied');
        else if(this.lastErrorName==='SecurityError') Toast.show('Scan blocked: insecure context');
        else Toast.show('Scan failed: '+(this.lastErrorMessage||this.lastErrorName||'Unknown'));
      }
      this.scanning=false;
      this.scanReq=null;
      this.advPerSec=0;
      return false;
    }
  },

  stopScan(){
    if(this.scanReq){
      try{ this.scanReq.stop(); }catch(e){}
    }
    this.scanReq=null;
    this.scanning=false;
    this.advPerSec=0;
    this._secCount=0;
    this._secStart=nowMs();
  },

  async restartScan(reason='restart'){
    if(this.restartInProgress) return;
    const now=nowMs();

    if(now-this.lastRestartMs < perfProfile.restartCooldown) return;

    if(now-this.restartWindowStart > 60000){
      this.restartCount=0;
      this.restartWindowStart=now;
    }
    if(this.restartCount >= MAX_RESTARTS_PER_MIN) return;

    this.restartInProgress=true;
    this.restartCount++;
    this.lastRestartMs=now;
    this.lastRestartReason=reason;

    this.stopScan();
    await new Promise(r=>setTimeout(r, 600));
    await this.startScan(this.lastScanMode || 'track', {silent:true});
    this.restartInProgress=false;
  }
};

/* ----------------------------- WIZARD (V35 + V40 signature hardening) ----------------------------- */
const Wizard = {
  mode:'add', // 'add' | 'reverify'
  targetPetId:null,

  candidates:{},
  selectedId:null,
  selectedSig:null,
  baselineRssi:null,
  verified:false,
  chosenIcon:'üê∂',

  scanTimer:null,
  verifyTimer:null,

  calib:{}, // {1:rssi,10:rssi}

  isOpen(){
    return $('wizard-overlay').classList.contains('active');
  },

  open(petId=null){
    this.mode = petId ? 'reverify' : 'add';
    this.targetPetId = petId || null;

    $('wizard-title').textContent = (this.mode==='reverify') ? 'Re-verify Tag' : 'Add Pet Wizard';

    $('wizard-overlay').classList.add('active');

    this.candidates={};
    this.selectedId=null;
    this.selectedSig=null;
    this.baselineRssi=null;
    this.verified=false;
    this.calib={};

    this.chosenIcon='üê∂';
    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===petId);
      if(p){ this.chosenIcon=p.icon; }
    }

    this._showStep(1);
    this._buildIconPicker();

    // Switch to register scan (accept all), real restart
    this._startScan();
  },

  close(){
    $('wizard-overlay').classList.remove('active');
    clearInterval(this.scanTimer);
    clearInterval(this.verifyTimer);

    // Return to tracking scan if monitoring desired
    if(App.pets.length>0 && App.monitoringWanted){
      BLE.startScan('track', {silent:true});
    }
  },

  _showStep(n){
    document.querySelectorAll('.wizard-step').forEach(el=>el.classList.remove('active'));
    $('wiz-step-'+n).classList.add('active');
    for(let i=1;i<=3;i++){
      const p=$('sp-'+i);
      p.className='step-pill';
      if(i<n) p.classList.add('done');
      else if(i===n) p.classList.add('current');
    }

    // Update save button label for reverify
    if(n===3){
      $('btn-wiz-save').textContent = (this.mode==='reverify') ? '‚úÖ Update' : '‚úÖ Save';
      if(this.mode==='reverify'){
        const p=App.pets.find(x=>x.id===this.targetPetId);
        if(p){
          $('input-name').value=p.name;
          this.chosenIcon=p.icon;
          this._buildIconPicker();
        }
      }else{
        $('input-name').value='';
      }
    }
  },

  async _startScan(){
    $('scan-status').textContent='Starting scan...';
    $('scan-list').innerHTML='';
    this.candidates={};

    // Always ensure register scan mode
    BLE.stopScan();
    await new Promise(r=>setTimeout(r, 250));
    const ok = await BLE.startScan('register');
    if(!ok){
      $('scan-status').textContent='BLE not supported or blocked. Showing demo devices.';
      this._startDemoScan();
      return;
    }
    $('scan-status').textContent='Scanning... Hold tag close to phone.';
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>this._renderCandidates(), 900);
  },

  _startDemoScan(){
    const dd=[
      {id:'demo_itag_001',name:'iTAG'},
      {id:'demo_finder_002',name:'Key Finder'},
      {id:'demo_unknown_003',name:''},
      {id:'demo_buds_004',name:'Galaxy Buds Pro'}
    ];
    let t=0;
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>{
      const d=dd[t%dd.length];
      const r=d.name==='iTAG' ? (-48-Math.random()*8) : (-65-Math.random()*25);
      this.handleAdv({device:{id:d.id,name:d.name}, rssi:r, uuids:[]});
      t++;
      this._renderCandidates();
    }, 320);
  },

  handleAdv(ev){
    const id = ev.device.id || ('unknown_'+Math.random().toString(36).slice(2,8));
    const name = ev.device.name || '';
    const rssi = ev.rssi;
    if(typeof rssi!=='number' || isNaN(rssi)) return;

    if(!this.candidates[id]){
      this.candidates[id]={
        id, name,
        rssiSamples:new RingBuffer(30),
        firstSeen:nowMs(),
        lastSeen:0,
        uuids:ev.uuids||[],
        manufacturerData:null,
        manufacturerId:null
      };
    }
    const c=this.candidates[id];
    c.rssiSamples.push(rssi);
    c.lastSeen=nowMs();

    if(ev.manufacturerData){
      c.manufacturerData=ev.manufacturerData;
      ev.manufacturerData.forEach((v,k)=>{ c.manufacturerId=k; });
    }
    if(name && !c.name) c.name=name;
  },

  _tagLikelihood(c){
    // Simple heuristic from V35 (kept)
    let s=0;
    const med=median(c.rssiSamples.data);
    s += clamp((med+100)/50,0,1)*40;
    s += clamp(c.rssiSamples.length/15,0,1)*25;

    if(c.rssiSamples.length>=5){
      const m=median(c.rssiSamples.data);
      const v=c.rssiSamples.data.reduce((a,b)=>a+(b-m)**2,0)/c.rssiSamples.length;
      s += clamp(1 - v/200, 0, 1)*15;
    }

    const n=(c.name||'').toLowerCase();
    if(/itag|finder|anti.?lost|isearch|key|tile|nut|tag/.test(n)) s+=15;
    if(/buds|watch|band|airpod|galaxy|pixel|bose|sony|jbl|speaker|headphone|tv|car/.test(n)) s-=30;

    return Math.round(clamp(s,0,100));
  },

  _renderCandidates(){
    const now=nowMs();
    const arr = Object.values(this.candidates)
      .filter(c => now - c.lastSeen < 6000 && c.rssiSamples.length>=2)
      .map(c => ({...c, med: median(c.rssiSamples.data), score: this._tagLikelihood(c)}))
      .sort((a,b)=>b.score-a.score)
      .slice(0, 8);

    if(!arr.length){
      $('scan-list').innerHTML='<div class="text-center" style="color:var(--text-muted);padding:20px">No devices found yet...</div>';
      return;
    }

    $('scan-list').innerHTML = arr.map(c=>{
      const pct=clamp((c.med+100)*2,0,100);
      const col=pct>60?'var(--accent-green)':pct>30?'var(--accent-yellow)':'var(--accent-red)';
      const sel=this.selectedId===c.id;
      const displayId = c.id.length>16 ? (c.id.slice(0,8)+'‚Ä¶'+c.id.slice(-4)) : c.id;
      return `
        <div class="scan-item ${sel?'selected':''}" onclick="Wizard.selectCandidate('${c.id}')">
          <div>
            <div class="scan-item-name">${c.name||'‚ü®Unknown Tag‚ü©'}</div>
            <div class="scan-item-id">${displayId}</div>
            <div class="tag-score">Tag likelihood: ${c.score}%</div>
          </div>
          <div class="scan-item-right">
            <div class="scan-rssi" style="color:${col}">${Math.round(c.med)} dBm</div>
            <div class="rssi-bar-track"><div class="rssi-bar-fill" style="width:${pct}%;background:${col}"></div></div>
          </div>
        </div>
      `;
    }).join('');
  },

  selectCandidate(id){
    this.selectedId=id;
    const c=this.candidates[id];
    if(!c) return;

    // manufacturer prefix hex (first 2 bytes)
    let mfgPrefix=null;
    try{
      if(c.manufacturerData){
        for(const [k,v] of c.manufacturerData.entries()){
          const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
          mfgPrefix=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
          break;
        }
      }
    }catch(e){ mfgPrefix=null; }

    this.selectedSig = {
      deviceId: c.id,
      nameExact: c.name || null,
      namePrefix: c.name ? c.name.slice(0, Math.min(6, c.name.length)) : null,
      serviceUuids: (c.uuids && c.uuids.length) ? c.uuids.map(u=>u.toString()) : null,
      manufacturerId: (c.manufacturerId!==null && c.manufacturerId!==undefined) ? c.manufacturerId : undefined,
      manufacturerDataPrefixHex: mfgPrefix || null,
      confirmed:false
    };

    this._renderCandidates();
    setTimeout(()=>this._goStep2(), 350);
  },

  _goStep2(){
    this._showStep(2);
    const c=this.candidates[this.selectedId];
    if(!c) return;

    this.baselineRssi = median(c.rssiSamples.slice(-6));
    this.verified=false;

    $('verify-delta').textContent='0';
    $('verify-delta').style.color='var(--text-muted)';
    $('verify-status').textContent='Waiting for movement...';
    $('verify-status').style.color='var(--text-muted)';

    $('btn-verified').classList.add('hidden');
    $('btn-skip-verify').classList.remove('hidden');

    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';

    clearInterval(this.verifyTimer);
    this.verifyTimer=setInterval(()=>{
      const cc=this.candidates[this.selectedId];
      if(!cc || cc.rssiSamples.length<3) return;

      const cur=median(cc.rssiSamples.slice(-4));
      const delta=this.baselineRssi-cur;

      $('verify-delta').textContent = Math.round(delta);

      if(delta>=10){
        $('verify-delta').style.color='var(--accent-green)';
        $('verify-status').textContent='Signal drop confirmed!';
        $('verify-status').style.color='var(--accent-green)';
        $('btn-verified').classList.remove('hidden');
        $('btn-skip-verify').classList.add('hidden');
        this.verified=true;
        clearInterval(this.verifyTimer);
      }else if(delta>=5){
        $('verify-delta').style.color='var(--accent-yellow)';
        $('verify-status').textContent='Keep moving further away...';
      }else{
        $('verify-delta').style.color='var(--text-muted)';
      }
    }, 520);
  },

  skipVerify(){
    this.verified=false;
    clearInterval(this.verifyTimer);
    this.goStep3();
  },

  goStep3(){
    clearInterval(this.verifyTimer);
    if(this.selectedSig) this.selectedSig.confirmed=this.verified;
    this._showStep(3);

    if(this.mode==='add'){
      $('input-name').value='';
      $('input-name').focus();
    }else{
      $('input-name').focus();
    }
  },

  _buildIconPicker(){
    $('icon-picker').innerHTML = ICONS.map(ic=>`
      <div class="icon-opt ${ic===this.chosenIcon?'selected':''}" onclick="Wizard.pickIcon('${ic}')">${ic}</div>
    `).join('');
  },

  pickIcon(ic){
    this.chosenIcon=ic;
    this._buildIconPicker();
  },

  rescan(){
    // Force true scan restart (fixes V38 issue)
    this.candidates={};
    this.selectedId=null;
    $('scan-list').innerHTML='';
    $('scan-status').textContent='Re-scanning...';
    BLE.stopScan();
    setTimeout(()=>this._startScan(), 280);
  },

  _currentCandidateMedian(){
    const c=this.candidates[this.selectedId];
    if(!c || c.rssiSamples.length<3) return null;
    return median(c.rssiSamples.slice(-4));
  },

  recordCalib(dist){
    const med=this._currentCandidateMedian();
    if(med===null) { Toast.show('Need more samples‚Ä¶'); return; }
    this.calib[dist]=med;
    if(dist===1) $('calib-1m').textContent=Math.round(med)+' dBm';
    if(dist===10) $('calib-10m').textContent=Math.round(med)+' dBm';
    Toast.show(`Calibration recorded at ${dist}m`);
  },

  clearCalib(){
    this.calib={};
    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';
    Toast.show('Calibration cleared');
  },

  async save(){
    const name = ($('input-name').value||'').trim() || 'My Pet';
    const sig = this.selectedSig || {};
    sig.confirmed = !!this.verified;

    // Attach calibration to be applied on pet.distance later
    const calibPoints=[];
    if(typeof this.calib[1]==='number') calibPoints.push({rssi:this.calib[1], dist:1});
    if(typeof this.calib[10]==='number') calibPoints.push({rssi:this.calib[10], dist:10});

    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===this.targetPetId);
      if(!p){ Toast.show('Pet not found'); this.close(); return; }
      p.name=name;
      p.icon=this.chosenIcon;
      p.signature=sig;
      p.ambiguousCount=0;
      p.lastAmbiguousMs=0;
      if(calibPoints.length){
        p.distance = new DistanceEstimator();
        calibPoints.forEach(pt=>p.distance.addCalibration(pt.rssi, pt.dist));
      }
      await Store.savePet(p);
      Toast.show('Tag signature updated ‚úî');
      this.close();
      App.render();
      return;
    }

    const pet=new Pet({name, icon:this.chosenIcon, signature:sig, createdAt:nowMs()});
    if(calibPoints.length){
      calibPoints.forEach(pt=>pet.distance.addCalibration(pt.rssi, pt.dist));
    }

    App.addPet(pet);
    await Store.savePet(pet);

    Toast.show(name+' is now protected!');
    this.close();

    // Auto suggestions if signature seems weak
    if(pet.signatureStrength()<=2){
      Toast.show('Tip: Use Focus mode for best accuracy (weak tag signature)');
    }

    // Start monitoring if user wants
    if(App.monitoringWanted) BLE.startScan('track', {silent:true});
  }
};

/* ----------------------------- SOS MODULE (V35) ----------------------------- */
const SOS = {
  active:false,
  holdTimer:null,
  strobeTimer:null,
  targetPet:null,
  hcHistory:new RingBuffer(12),
  savedLocation:null,

  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  activate(){
    this.active=true;
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    $('sos-active-name').textContent = p ? p.name : 'PET';
    $('sos-active').classList.add('active');
    if(navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
    AudioEngine.alertForZone('DANGER');
    this._startStrobe();
  },

  deactivate(){
    this.active=false;
    $('sos-active').classList.remove('active');
    clearInterval(this.strobeTimer);
    $('sos-strobe-area').style.background='';
    $('sos-active').style.background='#000';
  },

  _startStrobe(){
    let on=false;
    this.strobeTimer=setInterval(()=>{
      $('sos-strobe-area').style.background=on?'#fff':'#e74c3c';
      $('sos-active').style.background=on?'#300':'#000';
      on=!on;
    }, 420);
  },

  updateHC(rssi){
    this.hcHistory.push(rssi);
    if(this.hcHistory.length<6) return;
    const r=median(this.hcHistory.slice(-3));
    const o=median(this.hcHistory.slice(-6,-3));
    const d=r-o;
    const a=$('hc-arrow'), t=$('hc-text'), rv=$('hc-rssi');
    rv.textContent=Math.round(r)+' dBm';
    if(d>3){
      a.textContent='üî•';
      t.textContent='HOT ‚Äî Getting Closer!';
      t.style.color='var(--zone-danger)';
    }else if(d<-3){
      a.textContent='üßä';
      t.textContent='COLD ‚Äî Moving Away';
      t.style.color='var(--accent-blue)';
    }else{
      a.textContent='‚û°Ô∏è';
      t.textContent='STEADY ‚Äî Keep searching';
      t.style.color='var(--text-muted)';
    }
  },

  updateSnapshot(pet){
    if(!pet) return;
    const now=nowMs();
    const l=[
      '<strong>'+pet.name+'</strong> '+pet.icon,
      'Status: <span style="color:var(--zone-'+pet.zone.stable.toLowerCase()+')">'+pet.zone.stable+'</span>',
      'Last seen: '+pet.getLastSeenText(now),
      'Signal: '+(pet.lastRawRssi!==null ? Math.round(pet.smoothedRssi)+' dBm' : 'N/A'),
      'Distance: ~'+pet.distMeters.toFixed(1)+'m (approx)',
      'Confidence: '+pet.confidence+'%',
      'Rescue ID: <strong>'+pet.rescueId+'</strong>'
    ];
    if(pet.batterySuspect) l.push('‚ö† Possible weak battery (frequent LOST)');
    if(this.savedLocation) l.push('üìç '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5));
    $('sos-snapshot').innerHTML=l.join('<br>');
  },

  async saveLocation(){
    if(!navigator.geolocation){ Toast.show('Geolocation not available'); return; }
    try{
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000}));
      this.savedLocation={lat:pos.coords.latitude, lon:pos.coords.longitude, time:nowMs()};
      Toast.show('Location saved!');
      const p=this.targetPet || App.pets[0];
      if(p) this.updateSnapshot(p);
    }catch(e){
      Toast.show('Could not get location: '+(e.message||'Denied'));
    }
  },

  shareMessage(){
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    let m='LOST PET ALERT\n';
    if(p){
      m+='Name: '+p.name+'\nRescue ID: '+p.rescueId+'\nLast signal: '+p.getLastSeenText(nowMs())+'\nStatus: '+p.zone.stable+'\nApprox distance: ~'+p.distMeters.toFixed(1)+'m\n';
    }
    if(this.savedLocation){
      m+='Owner location: '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5)+'\n';
      m+='Map: https://maps.google.com/?q='+this.savedLocation.lat+','+this.savedLocation.lon+'\n';
    }
    m+='\nSent via VitalGuard AI (mcorpai.org)\nNOT GPS ‚Äî Bluetooth proximity only';

    if(navigator.share){
      navigator.share({title:'Lost Pet Alert', text:m}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(m).then(()=>Toast.show('Copied to clipboard!')).catch(()=>Toast.show('Could not copy'));
    }
  },

  renderPetSelect(){
    if(!App.pets.length) return;
    $('sos-pet-select').innerHTML =
      '<div class="section-title" style="margin-top:0">Select Pet</div>' +
      App.pets.map(p=>`
        <button class="btn btn-sm ${this.targetPet && this.targetPet.id===p.id ? 'btn-success':'btn-secondary'}"
          style="margin:0 4px 4px 0"
          onclick="SOS.selectPet('${p.id}')"
        >${p.icon} ${p.name}</button>
      `).join('');
  },

  selectPet(id){
    this.targetPet = App.pets.find(p=>p.id===id) || null;
    this.hcHistory.clear();
    this.renderPetSelect();
    if(this.targetPet){
      this.updateSnapshot(this.targetPet);
      App.focusPetId=this.targetPet.id;
      $('sos-focus-banner').classList.remove('hidden');
      if(App.trackMode==='focus') Toast.show('Focus Mode: '+this.targetPet.name);
    }
  }
};

/* ----------------------------- EMERGENCY MODE (V20) ----------------------------- */
const Emergency = {
  active:false,
  strobeTimer:null,
  wakeLock:null,
  shakeEnabled:false,
  shakeArmed:false,
  lastShakeMs:0,

  data:{ name:'', phone:'', medical:'' },

  async load(){
    this.data.name = await Store.getSetting('emg_name','');
    this.data.phone = await Store.getSetting('emg_phone','');
    this.data.medical = await Store.getSetting('emg_medical','');
    this.shakeEnabled = await Store.getSetting('emg_shake', false);
  },

  async save(){
    await Store.saveSetting('emg_name', this.data.name||'');
    await Store.saveSetting('emg_phone', this.data.phone||'');
    await Store.saveSetting('emg_medical', this.data.medical||'');
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Emergency profile saved');
  },

  open(){
    $('emg-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('emg-overlay').classList.remove('active');
  },

  render(){
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    const shakeState = this.shakeEnabled ? 'ON' : 'OFF';

    $('emg-body').innerHTML = `
      <div class="tip-card danger">
        <div class="tip-title">Emergency Mode</div>
        <div class="tip-body">
          This mode is for <strong>personal safety</strong> (siren + strobe + QR contact card).
          Configure now, so you can activate fast when needed.
        </div>
      </div>

      <div class="card">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Your name</div>
        <input id="emg-name" type="text" value="${(this.data.name||'').replace(/"/g,'&quot;')}" placeholder="Your Name"
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Emergency phone</div>
        <input id="emg-phone" type="text" value="${(this.data.phone||'').replace(/"/g,'&quot;')}" placeholder="+82..."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Medical / notes (optional)</div>
        <textarea id="emg-medical" rows="3" placeholder="Allergies, conditions, etc."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem;resize:vertical">${(this.data.medical||'')}</textarea>

        <button class="btn btn-secondary btn-block" style="margin-top:12px" onclick="Emergency.saveFromUI()">üíæ Save Profile</button>
      </div>

      <div class="card">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">Shake SOS</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Current: <strong>${shakeState}</strong><br>
          If enabled, shaking your phone can activate Emergency (best effort; may need permission on iOS).
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.toggleShake()">Toggle</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.requestMotionPermission()">iOS Permission</button>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds to activate</div>
        <button class="btn btn-primary" style="font-size:1.05rem;padding:14px 26px;border-radius:50px"
          ontouchstart="Emergency.holdStart()" ontouchend="Emergency.holdEnd()"
          onmousedown="Emergency.holdStart()" onmouseup="Emergency.holdEnd()"
        >üõ° ACTIVATE EMERGENCY</button>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Safety Note</div>
        <div class="tip-body">
          This tool helps call attention and share contact info. It does not guarantee safety.
          Always prioritize real emergency services in your region.
        </div>
      </div>
    `;
  },

  saveFromUI(){
    this.data.name = ($('emg-name').value||'').trim();
    this.data.phone = ($('emg-phone').value||'').trim();
    this.data.medical = ($('emg-medical').value||'').trim();
    this.save();
    this.render();
  },

  async toggleShake(){
    this.shakeEnabled = !this.shakeEnabled;
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Shake SOS ' + (this.shakeEnabled?'ON':'OFF'));
    this.render();
  },

  async requestMotionPermission(){
    // iOS 13+ requires permission for motion sensors
    try{
      if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        const res = await DeviceMotionEvent.requestPermission();
        Toast.show('Motion permission: '+res);
      }else{
        Toast.show('Motion permission not required on this device');
      }
    }catch(e){
      Toast.show('Motion permission failed');
    }
  },

  holdTimer:null,
  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  async activate(){
    this.data.name = ($('emg-name') ? ($('emg-name').value||'').trim() : this.data.name);
    this.data.phone = ($('emg-phone') ? ($('emg-phone').value||'').trim() : this.data.phone);
    this.data.medical = ($('emg-medical') ? ($('emg-medical').value||'').trim() : this.data.medical);

    await this.save();

    this.active=true;
    $('emergency-active').classList.add('active');

    // Wake lock (best effort)
    try{
      if('wakeLock' in navigator && navigator.wakeLock && navigator.wakeLock.request){
        this.wakeLock = await navigator.wakeLock.request('screen');
      }
    }catch(e){ this.wakeLock=null; }

    // Strobe
    this._startStrobe();

    // Siren & vibration
    AudioEngine.startEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([800,200,800,200,800,400,1200]);

    // QR contact card
    const payload = this.getPayload();
    QRGenerator.generate(payload, $('emg-qr'), 180);

    // UI fields
    $('emg-active-name').textContent = this.data.name ? this.data.name : 'UNKNOWN';
    $('emg-active-sub').textContent = this.data.medical ? ('Info: '+this.data.medical) : 'Tap CALL or SHARE to contact someone.';
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    $('emg-call').href = phoneSan ? ('tel:'+phoneSan) : '#';

    // Arm shake detection
    this.shakeArmed = this.shakeEnabled;
    this.lastShakeMs=0;
  },

  async deactivate(){
    this.active=false;
    $('emergency-active').classList.remove('active');

    clearInterval(this.strobeTimer);
    this.strobeTimer=null;

    AudioEngine.stopEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([100,60,100]);

    if(this.wakeLock){
      try{ await this.wakeLock.release(); }catch(e){}
      this.wakeLock=null;
    }
  },

  _startStrobe(){
    let on=false;
    clearInterval(this.strobeTimer);
    this.strobeTimer=setInterval(()=>{
      const root=$('emergency-active');
      if(!root) return;
      root.classList.toggle('strobe-on', on);
      on=!on;
    }, 320);
  },

  getPayload(){
    // short payload string
    const phone=(this.data.phone||'').trim();
    const med=(this.data.medical||'').trim();
    return `EMERGENCY|NAME:${this.data.name||''}|PHONE:${phone}|INFO:${med}|APP:VitalGuardAI`;
  },

  share(){
    const text = `EMERGENCY\nName: ${this.data.name||'N/A'}\nPhone: ${this.data.phone||'N/A'}\nInfo: ${this.data.medical||''}\nSent via VitalGuard AI`;
    if(navigator.share){
      navigator.share({title:'Emergency', text}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(text).then(()=>Toast.show('Copied to clipboard')).catch(()=>Toast.show('Could not copy'));
    }
  },

  // Shake detection (best effort)
  handleMotion(e){
    if(!this.shakeEnabled) return;
    if(this.active) return;
    if(!this.shakeArmed) return;

    const now=nowMs();
    const a=e.accelerationIncludingGravity;
    if(!a) return;

    const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
    if(mag>25){
      if(now-this.lastShakeMs<1800) return;
      this.lastShakeMs=now;
      Toast.show('Shake detected ‚Äî activating Emergency');
      this.activate();
    }
  }
};

// Register motion listener once (no permission request on load)
window.addEventListener('devicemotion', e=>Emergency.handleMotion(e), {passive:true});

/* ----------------------------- PET DETAIL OVERLAY (expanded) ----------------------------- */
const Detail = {
  pet:null,

  open(id){
    this.pet=App.pets.find(p=>p.id===id);
    if(!this.pet) return;

    if(App.trackMode==='focus'){
      App.focusPetId=id;
      App.renderPetChips();
    }

    $('detail-title').textContent=this.pet.icon+' '+this.pet.name;
    $('detail-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('detail-overlay').classList.remove('active');
  },

  async render(){
    const p=this.pet;
    if(!p) return;

    const z=p.zone.stable.toLowerCase();
    const now=nowMs();
    const sig=p.signature||{};
    const strength=p.signatureStrength();

    const sigLines=[];
    if(sig.nameExact) sigLines.push('Name: <span class="kbd">'+sig.nameExact+'</span>');
    if(sig.namePrefix) sigLines.push('Prefix: <span class="kbd">'+sig.namePrefix+'</span>');
    if(sig.manufacturerId!==undefined) sigLines.push('MFG ID: <span class="kbd">'+sig.manufacturerId+'</span>');
    if(sig.manufacturerDataPrefixHex) sigLines.push('MFG HEX: <span class="kbd">'+sig.manufacturerDataPrefixHex+'</span>');
    if(sig.deviceId) sigLines.push('Device ID: <span class="kbd">'+(sig.deviceId.length>16?(sig.deviceId.slice(0,8)+'‚Ä¶'+sig.deviceId.slice(-4)):sig.deviceId)+'</span>');
    if(sig.confirmed) sigLines.push('Verified: <span class="kbd">YES</span>');

    const congestion = BLE.congestionLevel();

    let html=`
      <div class="detail-ring zone-${z}">
        <div class="detail-dist">${p.distMeters<1?p.distMeters.toFixed(1):Math.round(p.distMeters)}</div>
        <div class="detail-unit">meters (approx)</div>
        <div class="detail-zone" style="color:var(--zone-${z})">${p.zone.stable}</div>
      </div>

      <div style="text-align:center;font-size:.65rem;color:var(--text-muted)">
        Not GPS ‚Äî Bluetooth proximity estimate only
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
        <span style="font-size:.78rem">Signal Strength</span>
        <span style="font-size:.78rem;font-family:var(--font-mono)">${Math.round(p.smoothedRssi)} dBm ${p.trendArrow}</span>
      </div>

      <div class="rssi-meter">
        <div class="rssi-meter-fill" style="width:${clamp((p.smoothedRssi+100)/70*100,0,100)}%;background:var(--zone-${z})"></div>
      </div>

      <div class="signal-bars">
        ${[12,16,20,24,28].map((h,i)=>`<div class="bar" style="height:${h}px;width:6px;border-radius:2px;background:${i<Math.ceil(clamp((p.smoothedRssi+100)/70*5,0,5))?'var(--zone-'+z+')':'var(--text-muted)'}"></div>`).join('')}
      </div>

      <div style="display:flex;justify-content:space-between;margin:8px 0">
        <span style="font-size:.75rem;color:var(--text-secondary)">Confidence: <strong>${p.confidence}%</strong></span>
        <span style="font-size:.72rem;color:var(--accent-orange);font-style:italic">${p.whyText||''}</span>
      </div>

      ${p.ambiguousCount>0 ? `
        <div class="warning-legal" style="margin-top:10px">
          <p><strong>‚ö† Signal ambiguous</strong> ‚Äî multiple tags look similar.</p>
          <p style="font-size:.75rem">Fix: Bring tag close ‚Üí Re-verify signature. This improves matching and prevents false alerts.</p>
          <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      `:''}

      ${p.batterySuspect ? `
        <div class="tip-card warn">
          <div class="tip-title">üîã Battery Suspected</div>
          <div class="tip-body">Frequent LOST flips suggest a weak CR2032 battery or signal shielding. Consider replacing battery and keeping the tag outside metal/waterproof cages.</div>
        </div>
      `:''}

      <div class="rescue-card">
        <div style="font-size:.72rem;color:var(--text-secondary)">Rescue ID (write on collar)</div>
        <div class="rescue-id">${p.rescueId}</div>
        <div style="font-size:.62rem;color:var(--text-muted)">If found, rescuer can contact you using this ID.</div>
        <div class="qr-wrap">
          <canvas id="qr-${p.id}" class="qr-canvas" width="180" height="180"></canvas>
          <div style="font-size:.72rem;color:var(--text-secondary)">QR contact code (visual)</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üéô Voice Tools</div>
      <div class="card" style="margin-bottom:12px">
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Voice Recall plays on <strong>CAUTION</strong> zone to call your pet back (best effort).
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span style="font-size:.78rem">Voice Recall</span>
          <div class="toggle ${Settings.prefs.voiceRecall?'on':''}" onclick="Settings.toggle('voiceRecall')"></div>
        </div>
        <div class="voice-row">
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">üéô Record 5s</button>
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">‚ñ∂ Play</button>
        </div>
      </div>

      <div class="section-title" style="font-size:.8rem">üéö Invisible Leash Distance</div>
      <div class="leash-row">
        ${Object.keys(LEASH_PRESETS).map(k=>`<div class="leash-btn ${p.leashPreset===k?'active':''}" onclick="Detail.setLeash('${k}')">${k}</div>`).join('')}
        <div class="leash-btn ${p.leashPreset==='custom'?'active':''}" onclick="Detail.setLeash('custom')">Custom</div>
      </div>

      <div style="margin-top:12px">
        <div class="slider-row"><label>Caution</label><input type="range" min="-90" max="-40" value="${p.thresholds.cautionEnter}" oninput="Detail.updateThreshold('cautionEnter',this.value)"><span class="val" id="dt-caution">${p.thresholds.cautionEnter} dBm</span></div>
        <div class="slider-row"><label>Warning</label><input type="range" min="-98" max="-55" value="${p.thresholds.warningEnter}" oninput="Detail.updateThreshold('warningEnter',this.value)"><span class="val" id="dt-warning">${p.thresholds.warningEnter} dBm</span></div>
        <div class="slider-row"><label>Danger</label><input type="range" min="-100" max="-70" value="${p.thresholds.dangerEnter}" oninput="Detail.updateThreshold('dangerEnter',this.value)"><span class="val" id="dt-danger">${p.thresholds.dangerEnter} dBm</span></div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üß† AI Modules</div>
      <div class="card">
        <div class="setting-row">
          <span style="font-size:.78rem">Behavior Fingerprint</span>
          <div class="toggle ${p.aiToggles.behavior?'on':''}" onclick="Detail.toggleAI('behavior')"></div>
        </div>
        <div class="setting-row">
          <span style="font-size:.78rem">Q-Learning Coach (suggest thresholds)</span>
          <div class="toggle ${p.aiToggles.qlearn?'on':''}" onclick="Detail.toggleAI('qlearn')"></div>
        </div>

        <div style="margin-top:10px;font-size:.75rem;color:var(--text-secondary);line-height:1.5">
          Current behavior: <strong>${p.behavior.classify()}</strong><br>
          Congestion: <strong>${congestion.toUpperCase()}</strong> (${BLE.advPerSec} adv/s)
        </div>

        <button class="btn btn-secondary btn-sm" style="margin-top:10px;width:100%" onclick="Detail.suggestAI()">‚ú® Suggest Adjustment</button>

        <div id="ai-suggestion" style="margin-top:10px;font-size:.75rem;color:var(--text-muted);line-height:1.5"></div>
        <div id="ai-feedback" class="hidden" style="margin-top:10px">
          <div style="font-size:.72rem;color:var(--text-secondary);margin-bottom:6px">Was this suggestion helpful?</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(true)">üëç Helpful</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(false)">üëé False alarm</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üîé Tag Signature</div>
      <div class="card" style="font-size:.75rem;color:var(--text-secondary);line-height:1.6">
        Strength: <strong>${strength}/8</strong><br>
        ${sigLines.length ? sigLines.join('<br>') : 'No signature captured'}
        <div style="margin-top:10px">
          <button class="btn btn-secondary btn-sm" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üìú Alert History</div>
      <div id="detail-alerts">
        ${p.alertHistory.length ? p.alertHistory.slice(0,18).map(a=>{
          const t=new Date(a.time);
          return `
            <div class="alert-item">
              <span><span class="alert-dot" style="background:var(--zone-${a.zone.toLowerCase()})"></span>${a.zone} ‚Äî ~${a.dist}m</span>
              <span style="color:var(--text-muted)">${t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${a.why?('('+a.why+')'):''}</span>
            </div>
          `;
        }).join('') : '<div style="font-size:.75rem;color:var(--text-muted);text-align:center;padding:12px">No alerts yet</div>'}
      </div>
    `;

    $('detail-body').innerHTML=html;

    // Generate QR for rescue ID and name (visual code)
    const qrPayload = `VG_TAG|NAME:${p.name}|RESCUE:${p.rescueId}|APP:VitalGuardAI`;
    QRGenerator.generate(qrPayload, $('qr-'+p.id), 180);
  },

  async setLeash(preset){
    if(!this.pet) return;
    if(preset==='custom'){
      this.pet.leashPreset='custom';
    }else{
      this.pet.leashPreset=preset;
      this.pet.thresholds={...LEASH_PRESETS[preset]};
    }
    await Store.savePet(this.pet);
    this.render();
  },

  async updateThreshold(key,val){
    if(!this.pet) return;
    val=parseInt(val);
    this.pet.thresholds[key]=val;

    if(key==='cautionEnter') this.pet.thresholds.cautionExit=val+5;
    if(key==='warningEnter') this.pet.thresholds.warningExit=val+6;
    if(key==='dangerEnter') this.pet.thresholds.dangerExit=val+6;

    this.pet.leashPreset='custom';

    const id = key==='cautionEnter'?'dt-caution':key==='warningEnter'?'dt-warning':'dt-danger';
    $(id).textContent = val+' dBm';

    await Store.savePet(this.pet);
  },

  async toggleAI(key){
    if(!this.pet) return;
    this.pet.aiToggles[key]=!this.pet.aiToggles[key];
    await Store.savePet(this.pet);
    this.render();
  },

  async suggestAI(){
    const p=this.pet;
    if(!p) return;

    if(!p.aiToggles.qlearn){
      Toast.show('Enable Q-Learning Coach first');
      return;
    }

    const zone=p.zone.stable;
    const action=p.qlearn.chooseAction(zone);
    p.lastAiSuggestion={zone, action, at:nowMs()};

    const msg = (action==='widen') ? 'Suggestion: WIDEN boundaries (less sensitive)'
              : (action==='narrow') ? 'Suggestion: NARROW boundaries (more sensitive)'
              : 'Suggestion: MAINTAIN current boundaries';

    $('ai-suggestion').innerHTML = `
      <div style="padding:10px;border-radius:10px;border:1px solid rgba(52,152,219,.25);background:rgba(52,152,219,.06)">
        <strong>${msg}</strong><br>
        <span style="color:var(--text-muted)">Tap ‚ÄúApply‚Äù to update thresholds.</span>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.applySuggestion()">Apply</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.resetQ()">Reset AI</button>
        </div>
      </div>
    `;
    $('ai-feedback').classList.add('hidden');
  },

  async applySuggestion(){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;

    const newT=p.qlearn.applyAction(action, p.thresholds);
    p.thresholds=newT;
    p.leashPreset='custom';
    await Store.savePet(p);

    $('ai-feedback').classList.remove('hidden');
    Toast.show('Thresholds updated ('+action+')');
    this.render();
  },

  async aiFeedback(helpful){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;
    p.qlearn.update(zone, !!helpful, action);
    p.lastAiSuggestion=null;
    await Store.savePet(p);
    Toast.show(helpful?'AI reward saved':'AI penalty saved');
    $('ai-feedback').classList.add('hidden');
  },

  async resetQ(){
    const p=this.pet;
    if(!p) return;
    p.qlearn.reset();
    await Store.savePet(p);
    Toast.show('AI state reset');
    this.render();
  }
};

/* ----------------------------- NAV ----------------------------- */
const Nav = {
  current:'home',
  go(tab){
    this.current=tab;
    document.querySelectorAll('.panel').forEach(el=>el.classList.remove('active'));
    $('panel-'+tab).classList.add('active');

    document.querySelectorAll('.bnav-btn').forEach(el=>{
      el.classList.toggle('active', el.dataset.tab===tab);
    });

    if(tab==='sos'){
      if(App.pets.length>0){
        $('sos-no-pets').classList.add('hidden');
        $('sos-content').classList.remove('hidden');
        if(!SOS.targetPet && App.pets.length) SOS.selectPet(App.pets[0].id);
        SOS.renderPetSelect();
      }else{
        $('sos-no-pets').classList.remove('hidden');
        $('sos-content').classList.add('hidden');
      }
    }

    if(tab==='settings') Settings.renderPetList();
  }
};

/* ----------------------------- SETTINGS ----------------------------- */
const Settings = {
  prefs:{
    sound:true,
    vibrate:true,
    notifWanted:false,
    highAlert:false,
    perfMode:'balanced',
    voiceRecall:false,
    tts:false,
    keepAlive:true,
    volume:70
  },

  async load(){
    this.prefs.sound = await Store.getSetting('sound', true);
    this.prefs.vibrate = await Store.getSetting('vibrate', true);
    this.prefs.notifWanted = await Store.getSetting('notifWanted', false);
    this.prefs.highAlert = await Store.getSetting('highAlert', false);
    this.prefs.perfMode = await Store.getSetting('perfMode', 'balanced');

    this.prefs.voiceRecall = await Store.getSetting('voiceRecall', false);
    this.prefs.tts = await Store.getSetting('tts', false);
    this.prefs.keepAlive = await Store.getSetting('keepAlive', true);
    this.prefs.volume = await Store.getSetting('volume', 70);

    perfProfile = PERF_PROFILES[this.prefs.perfMode] || PERF_PROFILES.balanced;
    this._updateToggles();
    this._updatePerfUI();
    this._updateVolumeUI();
  },

  _updateToggles(){
    const ts=$('toggle-sound'), tv=$('toggle-vibrate'), tn=$('toggle-notif'), th=$('toggle-highalert');
    const tvr=$('toggle-voiceRecall'), tts=$('toggle-tts'), tka=$('toggle-keepAlive');

    if(ts) ts.classList.toggle('on', this.prefs.sound);
    if(tv) tv.classList.toggle('on', this.prefs.vibrate);
    if(tn) tn.classList.toggle('on', this.prefs.notifWanted && ('Notification' in window) && Notification.permission==='granted');
    if(th) th.classList.toggle('on', this.prefs.highAlert);

    if(tvr) tvr.classList.toggle('on', this.prefs.voiceRecall);
    if(tts) tts.classList.toggle('on', this.prefs.tts);
    if(tka) tka.classList.toggle('on', this.prefs.keepAlive);
  },

  _updatePerfUI(){
    document.querySelectorAll('.perf-opt').forEach(el=>el.classList.remove('active'));
    const id='perf-'+this.prefs.perfMode;
    if($(id)) $(id).classList.add('active');
  },

  _updateVolumeUI(){
    const v=clamp(parseInt(this.prefs.volume)||0,0,100);
    const sv=$('volumeSlider');
    const vv=$('volumeVal');
    if(sv) sv.value=v;
    if(vv) vv.textContent=v+'%';
    AudioEngine.setVolume01(v/100);
  },

  async toggle(key){
    this.prefs[key]=!this.prefs[key];
    await Store.saveSetting(key, this.prefs[key]);
    this._updateToggles();

    if(key==='highAlert') Toast.show(this.prefs.highAlert?'High Alert ON':'High Alert OFF');
    if(key==='keepAlive'){
      Toast.show(this.prefs.keepAlive?'Audio Keepalive ON':'Audio Keepalive OFF');
      if(this.prefs.keepAlive && App.monitoringWanted) AudioEngine.startKeepAlive();
      else AudioEngine.stopKeepAlive();
    }
    if(key==='sound' && !this.prefs.sound) AudioEngine.stopKeepAlive();
  },

  async toggleNotif(){
    if(!('Notification' in window)){ Toast.show('Notifications not supported'); return; }

    if(Notification.permission==='granted'){
      this.prefs.notifWanted=!this.prefs.notifWanted;
      await Store.saveSetting('notifWanted', this.prefs.notifWanted);
      this._updateToggles();
      return;
    }
    if(Notification.permission==='denied'){
      $('notif-hint').classList.remove('hidden');
      Toast.show('Denied. Enable in browser settings.');
      return;
    }

    // request on user gesture
    const result = await Notification.requestPermission();
    if(result==='granted'){
      this.prefs.notifWanted=true;
      await Store.saveSetting('notifWanted', true);
      Toast.show('Notifications enabled!');
    }else{
      $('notif-hint').classList.remove('hidden');
      Toast.show('Permission denied');
    }
    this._updateToggles();
  },

  async setPerf(mode){
    this.prefs.perfMode=mode;
    perfProfile = PERF_PROFILES[mode] || PERF_PROFILES.balanced;
    await Store.saveSetting('perfMode', mode);
    this._updatePerfUI();

    // Reset timers to apply new profile
    App.resetTimers();
    Toast.show('Performance: '+mode);
  },

  async setVolume(v){
    v=clamp(parseInt(v)||0,0,100);
    this.prefs.volume=v;
    await Store.saveSetting('volume', v);
    this._updateVolumeUI();
  },

  renderPetList(){
    const el=$('settings-pet-list');
    if(!App.pets.length){
      el.innerHTML='<div style="color:var(--text-muted);font-size:.82rem;padding:8px 0">No pets registered.</div>';
      return;
    }
    el.innerHTML = App.pets.map(p=>`
      <div class="setting-row">
        <div>
          <span style="font-size:1.2rem">${p.icon}</span> <strong>${p.name}</strong>
          <div style="font-size:.65rem;color:var(--text-muted)">ID: ${p.rescueId} | Added ${new Date(p.createdAt).toLocaleDateString()}</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="Settings.removePet('${p.id}')">Remove</button>
      </div>
    `).join('');
  },

  async removePet(id){
    if(!confirm('Remove this pet?')) return;
    await Store.deletePet(id);
    App.pets = App.pets.filter(p=>p.id!==id);
    App.render();
    this.renderPetList();
    Toast.show('Pet removed');
    if(!App.pets.length) BLE.stopScan();
  },

  resetApp(){
    if(!confirm('DELETE ALL VitalGuard AI DATA?')) return;
    if(!confirm('Are you sure? This cannot be undone.')) return;
    Store.clearAll();
    location.reload();
  }
};

/* ----------------------------- DATA MANAGER ----------------------------- */
const DataManager = {
  async exportAll(){
    const includeVoice = await Store.getBlob(VoiceRecall.key) ? confirm('Include Voice Recall audio in backup? (file will be larger)') : false;
    let voiceBase64=null;

    if(includeVoice){
      const blob=await Store.getBlob(VoiceRecall.key);
      if(blob){
        voiceBase64 = await new Promise(res=>{
          const fr=new FileReader();
          fr.onload=()=>res(fr.result);
          fr.onerror=()=>res(null);
          fr.readAsDataURL(blob);
        });
      }
    }

    const data={
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      exported:new Date().toISOString(),
      pets:App.pets.map(p=>p.toJSON()),
      settings:Settings.prefs,
      voiceRecall: voiceBase64 ? {included:true, dataUrl:voiceBase64} : {included:false}
    };

    const blob=new Blob([safeJson(data)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-7-backup-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Backup exported!');
  },

  importFile(){ $('import-input').click(); },

  async handleImport(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;

    try{
      const text=await file.text();
      const data=JSON.parse(text);
      if(!data.pets || !Array.isArray(data.pets)) throw new Error('Invalid backup');

      const merge = (App.pets.length>0) ? confirm('Merge with existing pets?\nCancel = Replace all') : true;

      if(!merge){
        App.pets=[];
        await Store.clearAll();
        await Store.init();
      }

      let imported=0;
      for(const pd of data.pets){
        if(App.pets.find(p=>p.id===pd.id)) continue;
        const pet=new Pet(pd);
        App.pets.push(pet);
        await Store.savePet(pet);
        imported++;
      }

      if(data.settings){
        // Import known settings only
        const keys=['sound','vibrate','notifWanted','highAlert','perfMode','voiceRecall','tts','keepAlive','volume'];
        for(const k of keys){
          if(k in data.settings){
            Settings.prefs[k]=data.settings[k];
            await Store.saveSetting(k, data.settings[k]);
          }
        }
        perfProfile = PERF_PROFILES[Settings.prefs.perfMode] || PERF_PROFILES.balanced;
        Settings._updateToggles();
        Settings._updatePerfUI();
        Settings._updateVolumeUI();
        App.resetTimers();
      }

      if(data.voiceRecall && data.voiceRecall.included && data.voiceRecall.dataUrl){
        // restore voice clip
        try{
          const parts=data.voiceRecall.dataUrl.split(',');
          const meta=parts[0]||'';
          const b64=parts[1]||'';
          const mime=(meta.match(/data:(.*?);base64/)||[])[1]||'audio/webm';
          const bin=atob(b64);
          const u8=new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
          const blob=new Blob([u8], {type:mime});
          await Store.saveBlob(VoiceRecall.key, blob);
        }catch(e){}
      }

      App.render();
      Toast.show(imported+' pet(s) imported');

    }catch(e){
      Toast.show('Import failed: '+(e.message||'unknown'));
    }

    ev.target.value='';
  }
};

/* ----------------------------- HELP (expanded) ----------------------------- */
/* ----------------------------- HELP (i18n) ----------------------------- */
const Help = {
  open(){
    try{
      if($('help-body')) $('help-body').innerHTML = this._content();
    }catch(e){}
    $('help-overlay').classList.add('active');
  },
  close(){
    $('help-overlay').classList.remove('active');
  },
  _content(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.help && (I18N.HTML.help[lang] || I18N.HTML.help.en)) || '';
  }
};

/* ----------------------------- ABOUT / LEGAL (i18n) ----------------------------- */
const Legal = {
  open(){
    try{
      if($('legal-body')) $('legal-body').innerHTML = this._content();
    }catch(e){}
    $('legal-overlay').classList.add('active');
  },
  close(){
    $('legal-overlay').classList.remove('active');
  },
  _content(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
  }
};

/* ----------------------------- LANGUAGE MENU ----------------------------- */
const Lang = {
  open(){
    const ov = $('lang-overlay');
    if(!ov) return;
    ov.classList.add('active');
    this._syncUI();
  },
  close(){
    const ov = $('lang-overlay');
    if(ov) ov.classList.remove('active');
  },
  choose(code){
    try{ if(window.I18N && I18N.setLang) I18N.setLang(code); }catch(e){}
    const sel = $('langSelect');
    if(sel){
      try{ sel.value = (window.I18N && I18N.getLang) ? I18N.getLang() : code; }catch(e){ sel.value = code; }
    }
    this.close();
  },
  _syncUI(){
    const current = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    document.querySelectorAll('#lang-overlay [data-lang]').forEach(btn=>{
      const is = btn.getAttribute('data-lang') === current;
      btn.classList.toggle('btn-primary', is);
      btn.classList.toggle('btn-secondary', !is);
    });
  }
};

/* ----------------------------- DIAGNOSTICS (Download JSON) ----------------------------- */
const Diag = {
  open(){
    $('diag-overlay').classList.add('active');
    this.render();
  },
  close(){ $('diag-overlay').classList.remove('active'); },

  snapshot(){
    const now=nowMs();
    return {
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      time:new Date().toISOString(),
      env:{
        ua:navigator.userAgent,
        protocol:location.protocol,
        secureContext: !!window.isSecureContext,
        bluetooth: !!navigator.bluetooth,
        leScan: !!(navigator.bluetooth && navigator.bluetooth.requestLEScan),
        notifications: ('Notification' in window)? Notification.permission : 'unsupported'
      },
      perfMode: Settings.prefs.perfMode,
      scan:{
        supported: BLE.supported,
        scanning: BLE.scanning,
        mode: BLE.lastScanMode,
        usingFilters: BLE.usingFilters,
        advPerSec: BLE.advPerSec,
        congestion: BLE.congestionLevel(),
        lastAnyAdvAgoMs: BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null,
        restartsInMinute: BLE.restartCount,
        lastRestartReason: BLE.lastRestartReason,
        stallCount: BLE.stallCount,
        lastErrorName: BLE.lastErrorName,
        lastErrorMessage: BLE.lastErrorMessage
      },
      monitoringWanted: App.monitoringWanted,
      trackMode: App.trackMode,
      focusPetId: App.focusPetId,
      pets: App.pets.map(p=>({
        id:p.id,
        name:p.name,
        rescueId:p.rescueId,
        zone:p.zone.stable,
        rssi:p.smoothedRssi,
        dist:p.distMeters,
        confidence:p.confidence,
        lastSeenAgoMs: p.lastSeenMs ? (now-p.lastSeenMs) : null,
        signatureStrength: p.signatureStrength(),
        ambiguousCount: p.ambiguousCount,
        batterySuspect: p.batterySuspect
      }))
    };
  },

  render(){
    const snap=this.snapshot();
    $('diag-body').innerHTML = `
      <div class="tip-card info">
        <div class="tip-title">Diagnostics Snapshot</div>
        <div class="tip-body">
          Use this for debugging scan issues, sharing with maintainers, or checking device compatibility.
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:10px 0">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.copy()">üìã Copy</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.download()">‚¨áÔ∏è Download</button>
      </div>

      <pre id="diag-pre" style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4">${safeJson(snap)}</pre>

      <div class="tip-card warn">
        <div class="tip-title">Privacy Note</div>
        <div class="tip-body">
          This snapshot stays local unless you manually share it. It contains device info (user-agent) but no GPS history or cloud identifiers.
        </div>
      </div>
    `;
  },

  copy(){
    const text = $('diag-pre') ? $('diag-pre').textContent : safeJson(this.snapshot());
    navigator.clipboard.writeText(text).then(()=>Toast.show('Copied')).catch(()=>Toast.show('Copy blocked'));
  },

  download(){
    const snap=this.snapshot();
    const blob=new Blob([safeJson(snap)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-7-diagnostics-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Downloaded');
  }
};

/* ----------------------------- META-COGNITIVE COACH (Idea Amplifier) ----------------------------- */
const Coach = {
  lastRenderMs:0,

  compute(){
    const now=nowMs();
    const tips=[];

    // Environment
    if(location.protocol.startsWith('file')){
      tips.push('You are running from <span class="kbd">file://</span>. For best BLE reliability, use HTTPS/localhost or install as an app (Ïï± ÏÑ§Ïπò).');
    }
    if(!BLE.checkSupport()){
      tips.push('This browser may not support BLE scanning (Web Bluetooth LE Scan). Use Android Chrome, or Demo mode.');
    }

    // Scan health
    if(App.monitoringWanted && !BLE.scanning){
      tips.push('Monitoring is OFF. Tap <strong>Start Monitoring</strong>.');
      if(BLE.lastErrorName==='NotAllowedError') tips.push('Bluetooth permission was denied. Enable Bluetooth permission and retry.');
      if(BLE.lastErrorName==='SecurityError') tips.push('Secure context required. Use HTTPS/localhost.');
    }

    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);
      if(silent > perfProfile.scanStallMs*0.8){
        tips.push('Scan looks stalled. The watchdog will auto-restart if needed. Try keeping the screen on.');
      }
      const cong = BLE.congestionLevel();
      if(cong==='high'){
        tips.push('High BLE congestion detected. Use <strong>Focus</strong> mode to improve accuracy.');
      }
      if(!BLE.usingFilters){
        tips.push('No scan filters available (tags may have no name). Focus mode helps when multiple devices are nearby.');
      }
    }

    // Pet-specific hints
    for(const p of App.pets){
      if(p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000){
        tips.push(`<strong>${p.name}</strong>: Signal ambiguous. Tap pet card ‚Üí Re-verify Tag.`);
        break;
      }
      if(p.batterySuspect){
        tips.push(`<strong>${p.name}</strong>: Possible weak battery. Replace CR2032 and re-verify.`);
        break;
      }
    }

    return tips;
  },

  render(){
    const tips=this.compute();
    const card=$('coach-card');
    const body=$('coach-body');
    if(!card || !body) return;

    if(!tips.length){
      card.style.display='none';
      return;
    }

    body.innerHTML = `
      <ul style="margin-left:18px;line-height:1.6">
        ${tips.slice(0,6).map(t=>'<li>'+t+'</li>').join('')}
      </ul>
    `;
    card.style.display='block';
  }
};

/* ----------------------------- APP CORE ----------------------------- */
const App = {
  pets:[],
  trackMode:'all',
  focusPetId:null,
  demoMode:false,
  monitoringWanted:false,

  renderTimer:null,
  watchdogTimer:null,

  async init(){
    // First-run banner / context warning
    this.initFirstRunBanner();

    await Store.init();
    await Settings.load();
    await Emergency.load();

    // Apply volume early
    Settings._updateVolumeUI();

    // Load pets
    const petsData = await Store.getAllPets();
    this.pets = petsData.map(d=>new Pet(d));

    // Hide first-run banner once you already have pets (file:// first-run condition)
    if(location.protocol.startsWith('file') && this.pets.length>0){
      const b=$('first-run-banner');
      if(b) b.classList.add('hidden');
    }

    // Restore monitoring preference
    this.monitoringWanted = await Store.getSetting('monitoringWanted', false);

    this.render();

    // timers
    this.resetTimers();

    // PWA
    this.registerPWA();

    // install banner
    this.setupInstallBanner();

    // Attempt auto-start if wanted
    if(this.pets.length && this.monitoringWanted){
      // silent attempt; if user gesture is required, show banner + keep button
      await BLE.startScan('track', {silent:true});
      if(BLE.scanning){
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        // show coach guidance
        Coach.render();
      }
    }

    // Visibility resume
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible'){
        if(this.monitoringWanted && this.pets.length && !BLE.scanning && !this.demoMode){
          BLE.startScan('track', {silent:true});
        }
      }
    });

    // Safety: stop keepalive when leaving
    window.addEventListener('pagehide', ()=>{
      AudioEngine.stopKeepAlive();
    });

    Toast.show('VitalGuard AI v'+APP_VERSION+' ready');
  },

  initFirstRunBanner(){
    const banner=$('first-run-banner');
    if(!banner) return;
    const dismissed = localStorage.getItem(LS_PREFIX+'firstRunDismissed')==='1';
    const protoSpan=$('fr-proto');
    if(protoSpan) protoSpan.textContent=location.protocol;
    if(dismissed) return;

    // show when file:// OR insecure context
    if(location.protocol.startsWith('file') || !window.isSecureContext){
      banner.classList.remove('hidden');
    }
  },

  dismissFirstRun(){
    localStorage.setItem(LS_PREFIX+'firstRunDismissed','1');
    $('first-run-banner').classList.add('hidden');
  },

  resetTimers(){
    if(this.renderTimer) clearInterval(this.renderTimer);
    if(this.watchdogTimer) clearInterval(this.watchdogTimer);

    this.renderTimer=setInterval(()=>this.render(), perfProfile.renderInterval);
    this.watchdogTimer=setInterval(()=>this._watchdog(), 2000);
  },

  async toggleMonitoring(){
    if(this.demoMode){
      Toast.show('Demo mode is ON. Turn it off to use BLE monitoring.');
      return;
    }

    this.monitoringWanted = !this.monitoringWanted;
    await Store.saveSetting('monitoringWanted', this.monitoringWanted);

    if(this.monitoringWanted){
      const ok = await BLE.startScan('track');
      if(ok){
        Toast.show('Monitoring started');
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        Toast.show('Could not start scanning (see Coach/Help)');
        this.monitoringWanted=false;
        await Store.saveSetting('monitoringWanted', false);
      }
    }else{
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      Toast.show('Monitoring stopped');
    }

    this.render();
    Coach.render();
  },

  async toggleDemo(){
    this.demoMode=!this.demoMode;
    if(this.demoMode){
      this.monitoringWanted=false;
      await Store.saveSetting('monitoringWanted', false);
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      this._startDemo();
      Toast.show('Demo mode ON');
    }else{
      this._stopDemo();
      Toast.show('Demo mode OFF');
    }
    this.render();
    Coach.render();
  },
  _startDemo(){
    if(this.demoTimer) clearInterval(this.demoTimer);
    // Initialize per-pet demo phases
    this.pets.forEach(p=>{ if(p._demoPhase===undefined) p._demoPhase=Math.random()*Math.PI*2; });
    this.demoTimer=setInterval(()=>this._demoTick(), 450);
  },

  _stopDemo(){
    if(this.demoTimer){ clearInterval(this.demoTimer); this.demoTimer=null; }
  },

  _demoTick(){
    const now=nowMs();
    // Simulated RSSI wave: shows zone transitions without BLE hardware.
    this.pets.forEach(p=>{
      const t=now/1000;
      const phase=p._demoPhase||0;
      const swing = 32*Math.abs(Math.sin((t+phase)/7)); // 0..32
      const noise = Math.random()*4;
      const rssi = -54 - swing - noise;

      if(now - p.lastProcessMs >= p.getMinInterval()){
        p.processRssi(rssi, now);
      }else{
        p.ingestRaw(rssi, now);
      }
    });

    if(SOS.targetPet) SOS.updateSnapshot(SOS.targetPet);
  },



  setTrackMode(mode){
    this.trackMode=mode;
    const allBtn=$('btn-mode-all'), focusBtn=$('btn-mode-focus');
    if(allBtn) allBtn.classList.toggle('btn-success', mode==='all');
    if(focusBtn) focusBtn.classList.toggle('btn-success', mode==='focus');

    if(mode==='all'){
      this.focusPetId=null;
      $('sos-focus-banner').classList.add('hidden');
      Toast.show('Tracking all pets');
    }else{
      Toast.show('Focus mode: tap a pet to focus');
    }
    this.renderPetChips();
  },

  addPet(pet){
    this.pets.push(pet);
    this.render();
    this.renderPetChips();
  },

  onAdvertisement(event){
    // Route to Wizard if open
    if(Wizard.isOpen()){
      Wizard.handleAdv(event);
      return;
    }

    const now=nowMs();

    // Global throttle (dynamic by mode + congestion)
    let throttle = perfProfile.globalThrottleMs;
    if(BLE.congestionLevel()==='high') throttle=Math.max(throttle, 120);
    if(BLE.usingFilters) throttle=Math.min(throttle, 90);

    if(now - globalLastProcessMs < throttle) return;
    globalLastProcessMs = now;

    // Route
    routeAdvertisement(event, this.pets, now);

    // SOS update
    if(SOS.targetPet){
      if(event.rssi && matchScore(event, SOS.targetPet.signature)>0.4){
        SOS.updateHC(event.rssi);
      }
      SOS.updateSnapshot(SOS.targetPet);
    }
  },

  async triggerAlert(pet){
    if(this.demoMode) return;
    // Audio / vibration
    if(Settings.prefs.sound) AudioEngine.alertForZone(pet.zone.stable);
    if(Settings.prefs.vibrate && navigator.vibrate){
      const z=pet.zone.stable;
      if(z==='CAUTION') navigator.vibrate([120,80,120]);
      else if(z==='WARNING') navigator.vibrate([160,80,160,80,220]);
      else if(z==='DANGER') navigator.vibrate([220,80,220,80,220,120,360]);
      else if(z==='LOST') navigator.vibrate([400,200,400,200,600]);
    }

    // Notifications
    if(Settings.prefs.notifWanted && 'Notification' in window && Notification.permission==='granted'){
      try{
        new Notification('VitalGuard AI: '+pet.name, {body:`${pet.zone.stable} ‚Äî ~${pet.distMeters.toFixed(1)}m (approx)`});
      }catch(e){}
    }

    // TTS
    if(Settings.prefs.tts){
      VoiceAnnouncer.speak(VoiceAnnouncer.zoneMessage(pet));
    }
  },

  _watchdog(){
    const now=nowMs();

    // If scanning is on but silent for too long, restart
    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);

      if(silent > perfProfile.scanStallMs){
        BLE.stallCount++;
        BLE.restartScan('scan_stall');
      }

      // advPerSec should drop to 0 if silent
      if(silent > 2000) BLE.advPerSec=0;
    }

    // Pet LOST detection
    for(const p of this.pets){
      if(!p.lastSeenMs) continue;
      const silence = now - p.lastSeenMs;

      if(silence > perfProfile.lostMs){
        p.markLost(now);
      }
    }

    // Render coach occasionally
    Coach.render();
  },

  renderPetChips(){
    const row=$('pet-chips');
    if(!row) return;

    if(this.pets.length<=1){
      row.classList.add('hidden');
      row.innerHTML='';
      return;
    }

    row.classList.remove('hidden');
    row.innerHTML = this.pets.map(p=>{
      const active = (this.trackMode==='focus' && this.focusPetId===p.id);
      return `<div class="pet-chip ${active?'active':''}" onclick="App.focusFromChip('${p.id}')">${p.icon} ${p.name}</div>`;
    }).join('');
  },

  focusFromChip(id){
    if(this.trackMode!=='focus'){
      this.setTrackMode('focus');
    }
    this.focusPetId=id;
    Toast.show('Focus: '+(((this.pets.find(p=>p.id===id)||{}).name||'Pet')));
    this.renderPetChips();
    if(BLE.scanning && BLE.lastScanMode==='track') BLE.restartScan('focus_change');
    if(SOS.targetPet && SOS.targetPet.id===id) $('sos-focus-banner').classList.remove('hidden');
  },

  render(){
    // Empty vs dashboard
    const empty=$('empty-state');
    const dash=$('dash-controls');
    const dash2=$('dash-controls2');

    if(!this.pets.length){
      if(empty) empty.classList.remove('hidden');
      if(dash) dash.classList.add('hidden');
      if(dash2) dash2.classList.add('hidden');
      $('pet-list').innerHTML='';
      return;
    }else{
      if(empty) empty.classList.add('hidden');
      if(dash) dash.classList.remove('hidden');
      if(dash2) dash2.classList.remove('hidden');
    }

    // Buttons state
    const scanBtn=$('btn-scan-toggle');
    if(scanBtn){
      if(this.demoMode){
        scanBtn.textContent='‚ñ∂ Start Monitoring';
        scanBtn.disabled=true;
        scanBtn.style.opacity='.6';
      }else{
        scanBtn.disabled=false;
        scanBtn.style.opacity='1';
        scanBtn.textContent = this.monitoringWanted ? '‚èπ Stop Monitoring' : '‚ñ∂ Start Monitoring';
      }
    }
    const demoBtn=$('btn-demo-toggle');
    if(demoBtn){
      demoBtn.textContent = this.demoMode ? 'üß™ Demo ON' : 'üß™ Demo';
      demoBtn.classList.toggle('btn-success', this.demoMode);
    }

    // Status bar
    const bar=$('scan-status-bar');
    const badge=$('congestionBadge');
    const now=nowMs();

    if(bar){
      if(this.demoMode){
        bar.textContent='üß™ Demo Mode ‚Äî simulated data';
      }else if(BLE.scanning){
        const silent = BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null;
        const modeTxt = BLE.usingFilters ? 'filters' : 'accept-all';
        bar.textContent=`üì° Scanning (${BLE.advPerSec} adv/s, ${modeTxt}) ¬∑ last adv ${silent!==null?fmtAgo(silent):'--'} ago`;
      }else{
        bar.textContent='üì° Not scanning';
      }
    }

    if(badge){
      const lvl = this.demoMode ? 'low' : BLE.congestionLevel();
      badge.className='badge '+(lvl==='high'?'high':lvl==='med'?'med':'ok');
      badge.textContent = lvl.toUpperCase();
    }

    // Scan health bar
    const row=$('scan-health-row');
    if(row){
      if(this.demoMode || !BLE.scanning){
        row.classList.add('hidden');
      }else{
        row.classList.remove('hidden');
        const silent = BLE.lastAnyAdvMs ? (now - BLE.lastAnyAdvMs) : 999999;
        const ratio = clamp(1 - silent/perfProfile.scanStallMs, 0, 1);
        const fill=$('scan-health-fill');
        const meta=$('scan-health-meta');
        if(fill){
          fill.style.width=Math.round(ratio*100)+'%';
          fill.style.background = silent<2000 ? 'var(--accent-green)' : (silent<perfProfile.scanStallMs*0.7 ? 'var(--accent-yellow)' : 'var(--zone-danger)');
        }
        if(meta){
          meta.textContent = silent<999999 ? fmtAgo(silent)+' ago' : '--';
        }
      }
    }

    // Render pet chips
    this.renderPetChips();

    // Render pet list
    const list=$('pet-list');
    if(list){
      const now=nowMs();
      list.innerHTML = this.pets.map(p=>{
        const z=p.zone.stable.toLowerCase();
        const dotColor = 'var(--zone-'+z+')';
        const strength=p.signatureStrength();
        const weakSig = strength<=2;
        const amb = p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000;

        return `
          <div class="pet-card zone-${z}" onclick="Detail.open('${p.id}')">
            <div class="pet-icon-circle">${p.icon}</div>
            <div class="pet-details">
              <div class="pet-name">${p.name}</div>
              <div class="pet-status-row">
                <span class="status-dot" style="background:${dotColor}"></span>
                <span>${p.zone.stable}</span>
                <span style="opacity:.55">¬∑</span>
                <span>${p.getLastSeenText(now)}</span>
              </div>
              <div class="zone-badge ${z}">${p.zone.stable}</div>
              <div class="pet-conf">${p.confidence}% confidence ¬∑ ~${p.distMeters.toFixed(1)}m</div>
              ${amb ? `<div class="pet-why">‚ö† Signal ambiguous ‚Äî tap to re-verify</div>` :
                weakSig ? `<div class="pet-why">Tip: weak signature ‚Äî Focus mode recommended</div>` :
                (p.batterySuspect ? `<div class="pet-why">üîã Battery suspected ‚Äî replace CR2032</div>` :
                (p.whyText ? `<div class="pet-why">${p.whyText}</div>` : '')
              )}
            </div>
            <div class="pet-signal">
              <div class="pet-rssi" style="color:${dotColor}">
                ${p.lastRawRssi!==null ? Math.round(p.smoothedRssi) : '--'} dBm
                <span class="trend-arrow">${p.trendArrow}</span>
              </div>
              <div style="font-size:.62rem;color:var(--text-muted);margin-top:2px">${p.rescueId}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // SOS availability
    if(this.pets.length>0){
      $('sos-no-pets').classList.add('hidden');
      $('sos-content').classList.remove('hidden');
    }else{
      $('sos-no-pets').classList.remove('hidden');
      $('sos-content').classList.add('hidden');
    }
  },

  /* ----------------------------- PWA ----------------------------- */
  registerPWA(){
    if(!('serviceWorker' in navigator)) return;

    const startUrl = location.href;

    const manifest = {
      name: "VitalGuard AI v"+APP_VERSION,
      short_name: "VitalGuard AI",
      start_url: startUrl,
      display: "standalone",
      background_color: "#0d1117",
      theme_color: "#c0392b",
      description: "Life‚ÄëSaving Offline AI Demo ‚Äî Bluetooth proximity + tiny on‚Äëdevice AI (no cloud).",
      icons: [
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' rx='40' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='120'%3E%F0%9F%9B%A1%3C/text%3E%3C/svg%3E", sizes:"192x192", type:"image/svg+xml"},
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512'%3E%3Crect width='512' height='512' rx='96' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='340'%3E%F0%9F%9B%A1%3C/text%3E%3C/svg%3E", sizes:"512x512", type:"image/svg+xml"}
      ]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('pwa-manifest');
    if(link) link.setAttribute('href', url);

    const swCode = `
      const CACHE='vitalguard-ai-${APP_VERSION}-cache';
      const START_URL=${JSON.stringify(startUrl)};
      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll([START_URL])));
      });
      self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  },

  setupInstallBanner(){
    let deferredPrompt=null;
    const banner=$('installBanner');
    const btn=$('installBtn');
    const dismiss=$('installDismiss');
    const dismissed = localStorage.getItem(LS_PREFIX+'installDismissed')==='1';

    window.addEventListener('beforeinstallprompt', e=>{
      e.preventDefault();
      deferredPrompt=e;
      if(!dismissed && banner) banner.classList.add('active');
    });

    if(btn){
      btn.addEventListener('click', async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(()=>{});
        deferredPrompt=null;
        if(banner) banner.classList.remove('active');
      });
    }

    if(dismiss){
      dismiss.addEventListener('click', ()=>{
        localStorage.setItem(LS_PREFIX+'installDismissed','1');
        if(banner) banner.classList.remove('active');
      });
    }
  }
};


/* ============================================================
   V4.1 Upgrade Pack (VitalGuardAI)
   - Adds: Reset/Initialize center, ErrorShield, Conductor AI,
           AI Pack v4 (kNN + IsolationForestLite + RLS calibration),
           Encrypted backup (AES-GCM), Wake Lock for monitoring,
           Accessibility toggles, richer About & Social Impact deck.
   ============================================================ */

(function(){
  /* ----------------------------- SAFE TEXT / SANITIZER ----------------------------- */
  const Sanitizer = {
    // Remove risky characters while keeping names readable (prevents HTML injection from user input/import).
    name(s){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      s = s.replace(/[<>`]/g,'');
      if(!s) return 'My Pet';
      return s.slice(0, 28);
    },
    phone(s){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      // allow digits + + - space
      s = s.replace(/[^0-9+\-\s]/g,'');
      return s.slice(0, 24);
    },
    text(s, max=220){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      s = s.replace(/[<>`]/g,'');
      return s.slice(0, max);
    },
    icon(s){
      s = String((s===undefined||s===null)?'üê∂':s);
      // allow only known icons (prevents weird glyphs breaking UI)
      return ICONS.includes(s) ? s : 'üê∂';
    }
  };

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  function downloadText(filename, text, mime='text/plain'){
    const blob=new Blob([text], {type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2500);
  }

  /* ----------------------------- ERROR SHIELD (Crash-safe logging) ----------------------------- */
  const ErrorShield = {
    ring: new RingBuffer(36),
    loaded:false,
    persistTimer:null,
    lastCaptureAt:0,

    async load(){
      try{
        const saved = await Store.getAI('errors');
        if(saved && Array.isArray(saved.items)){
          saved.items.slice(-36).forEach(it=>this.ring.push(it));
        }
      }catch(e){}
      this.loaded=true;
    },

    _schedulePersist(){
      clearTimeout(this.persistTimer);
      this.persistTimer = setTimeout(async ()=>{
        try{
          await Store.saveAI('errors', {key:'errors', items:this.ring.data});
        }catch(e){}
      }, 1200);
    },

    capture(kind, info){
      const now = nowMs();
      // avoid loops
      if(now - this.lastCaptureAt < 60) return;
      this.lastCaptureAt = now;

      const entry = {
        t: new Date(now).toISOString(),
        kind,
        msg: Sanitizer.text((info && info.msg!=null)?info.msg:'unknown', 260),
        where: Sanitizer.text((info && info.where!=null)?info.where:'', 120),
        stack: Sanitizer.text((info && info.stack!=null)?info.stack:'', 700)
      };
      try{ this.ring.push(entry); }catch(e){}
      this._schedulePersist();
    },

    hook(){
      window.addEventListener('error', (e)=>{
        this.capture('error', {
          msg: e.message || 'window.error',
          where: (e.filename||'') + ':' + (e.lineno||0) + ':' + (e.colno||0),
          stack: e.error && e.error.stack ? e.error.stack : ''
        });
      });
      window.addEventListener('unhandledrejection', (e)=>{
        const r=e.reason;
        this.capture('promise', {
          msg: (r && (r.message||r.name)) ? (r.name? (r.name+': '+(r.message||'')) : r.message) : String(r),
          where: 'unhandledrejection',
          stack: (r && r.stack) ? r.stack : ''
        });
      });
    },

    clear(){
      this.ring.clear();
      Store.saveAI('errors', {key:'errors', items:[]}).catch(()=>{});
      Toast.show('Error log cleared');
      var d=$('diag-overlay'); if(d && d.classList.contains('active')) Diag.render();
    }
  };

  /* ----------------------------- CAPABILITY MATRIX ----------------------------- */
  const Capabilities = {
    async battery(){
      try{
        if(navigator.getBattery) return await navigator.getBattery();
      }catch(e){}
      return null;
    },
    computeSync(){
      const caps = {
        secureContext: !!window.isSecureContext,
        protocol: location.protocol,
        webBluetooth: !!navigator.bluetooth,
        leScan: !!(navigator.bluetooth && navigator.bluetooth.requestLEScan),
        advEvents: !!(navigator.bluetooth && navigator.bluetooth.addEventListener),
        serviceWorker: 'serviceWorker' in navigator,
        caches: 'caches' in window,
        wakeLock: !!(navigator.wakeLock && navigator.wakeLock.request),
        notification: 'Notification' in window,
        vibration: !!navigator.vibrate,
        share: !!navigator.share,
        clipboard: !!(navigator.clipboard && navigator.clipboard.writeText),
        geolocation: 'geolocation' in navigator,
        mediaDevices: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
        mediaRecorder: 'MediaRecorder' in window,
        tts: ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window)
      };
      return caps;
    },
    badgeHTML(ok){
      return ok ? '<span class="kbd" style="background:rgba(46,204,113,.14);border-color:rgba(46,204,113,.22);color:var(--accent-green)">OK</span>'
                : '<span class="kbd" style="background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.22);color:var(--accent-red)">NO</span>';
    },
    renderHTML(extra={}){
      const c = {...this.computeSync(), ...extra};
      const rows = [
        ['Secure context', c.secureContext],
        ['Web Bluetooth', c.webBluetooth],
        ['LE Scan API', c.leScan],
        ['Wake Lock', c.wakeLock],
        ['Service Worker', c.serviceWorker],
        ['Notifications', c.notification],
        ['Vibration', c.vibration],
        ['Share', c.share],
        ['Clipboard', c.clipboard],
        ['Geolocation', c.geolocation],
        ['Voice/TTS', c.tts],
        ['MediaRecorder', c.mediaRecorder],
      ];
      return `
        <div class="card" style="margin-top:10px">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">Device Capability Matrix</div>
          ${rows.map(r=>`
            <div class="setting-row" style="padding:10px 0">
              <span style="font-size:.78rem;color:var(--text-secondary)">${r[0]}</span>
              ${this.badgeHTML(!!r[1])}
            </div>
          `).join('')}
          <div style="margin-top:8px;font-size:.72rem;color:var(--text-muted)">
            Protocol: <span class="kbd">${Sanitizer.text(c.protocol, 18)}</span>
          </div>
        </div>
      `;
    }
  };

  /* ----------------------------- ACCESSIBILITY (UX) ----------------------------- */
  const Accessibility = {
    apply(){
      const root=document.documentElement;
      root.classList.toggle('a11y-large', !!Settings.prefs.largeText);
      root.classList.toggle('a11y-contrast', !!Settings.prefs.highContrast);
      root.classList.toggle('a11y-reduceMotion', !!Settings.prefs.reduceMotion);
    },
    injectCSS(){
      if(document.getElementById('v40-a11y-style')) return;
      const css = document.createElement('style');
      css.id='v40-a11y-style';
      css.textContent = `
        :root.a11y-large{ font-size: 18px; }
        :root.a11y-contrast{
          --bg-primary:#000;
          --bg-secondary:#060606;
          --bg-elevated:#0c0c0c;
          --text-primary:#fff;
          --text-secondary:#dcdcdc;
          --text-muted:#b5b5b5;
          --border-color: rgba(255,255,255,.18);
        }
        :root.a11y-reduceMotion *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
      `;
      document.head.appendChild(css);
    }
  };

  /* ----------------------------- WAKE LOCK (Monitoring keep-awake) ----------------------------- */
  const WakeLockManager = {
    lock:null,
    async request(){
      try{
        if(!Settings.prefs.screenAwake) return false;
        if(!(navigator.wakeLock && navigator.wakeLock.request)) return false;
        this.lock = await navigator.wakeLock.request('screen');
        this.lock.addEventListener('release', ()=>{ this.lock=null; });
        return true;
      }catch(e){
        this.lock=null;
        return false;
      }
    },
    async release(){
      try{
        if(this.lock){ await this.lock.release(); }
      }catch(e){}
      this.lock=null;
    },
    hookVisibility(){
      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState==='visible'){
          if(App.monitoringWanted && BLE.scanning && Settings.prefs.screenAwake){
            this.request();
          }
        }else{
          // don't force release; browser may auto-release anyway
        }
      });
    }
  };

  /* ----------------------------- AI PACK v4.1 ----------------------------- */

  // kNN classifier (personalized, learns from feedback)
  class KNNLite {
    constructor(k=5){
      this.k=k;
      this.samples=[]; // {x:number[], y:0|1}
    }
    _dist(a,b){
      let s=0;
      for(let i=0;i<a.length;i++){
        const d=(a[i]-b[i]);
        s+=d*d;
      }
      return Math.sqrt(s);
    }
    add(x,y){
      if(!Array.isArray(x) || x.length<3) return;
      this.samples.push({x:x.slice(0,8), y: y?1:0, t: nowMs()});
      if(this.samples.length>180) this.samples.shift();
    }
    predict(x){
      if(!Array.isArray(x) || this.samples.length<6) return {label:null, conf:0};
      const k=Math.min(this.k, this.samples.length);
      const sorted=this.samples
        .map(s=>({d:this._dist(x,s.x), y:s.y}))
        .sort((a,b)=>a.d-b.d)
        .slice(0,k);
      const sum=sorted.reduce((a,b)=>a+b.y,0);
      const p=sum/k;
      return {label: p>=0.5?1:0, conf: Math.round(Math.max(p,1-p)*100)};
    }
    export(){
      return {k:this.k, samples:this.samples.slice(-180)};
    }
    import(d){
      if(!d) return;
      this.k = typeof d.k==='number' ? d.k : this.k;
      if(Array.isArray(d.samples)) this.samples = d.samples.slice(-180);
    }
    reset(){
      this.samples=[];
    }
  }

  // RLS calibration for path-loss model: RSSI = a + b*log10(dist)
  class RLSCalibrator {
    constructor(){
      this.theta=[-59, -25]; // [a, b] where b‚âà-10n
      this.P=[[100,0],[0,100]];
      this.lambda=0.985;
      this.count=0;
    }
    update(dist, rssi){
      if(!dist || dist<=0 || !isFinite(dist) || !isFinite(rssi)) return;
      const x=[1, Math.log10(dist)];
      // P*x
      const Px=[this.P[0][0]*x[0]+this.P[0][1]*x[1], this.P[1][0]*x[0]+this.P[1][1]*x[1]];
      const denom = this.lambda + x[0]*Px[0] + x[1]*Px[1];
      const K=[Px[0]/denom, Px[1]/denom];
      const yHat = this.theta[0]*x[0] + this.theta[1]*x[1];
      const err = rssi - yHat;
      this.theta[0] += K[0]*err;
      this.theta[1] += K[1]*err;

      // P = (P - K*x^T*P)/lambda
      const xTP=[x[0]*this.P[0][0]+x[1]*this.P[1][0], x[0]*this.P[0][1]+x[1]*this.P[1][1]];
      const KP=[[K[0]*xTP[0], K[0]*xTP[1]],[K[1]*xTP[0], K[1]*xTP[1]]];
      this.P=[
        [(this.P[0][0]-KP[0][0])/this.lambda, (this.P[0][1]-KP[0][1])/this.lambda],
        [(this.P[1][0]-KP[1][0])/this.lambda, (this.P[1][1]-KP[1][1])/this.lambda]
      ];

      this.count++;
    }
    params(){
      // Convert to txPower & n (approx)
      const a=this.theta[0];
      const b=this.theta[1];
      const n = clamp(Math.abs(b)/10, 1.5, 4.5);
      const tx = clamp(a, -78, -40);
      return {txPower:tx, n:n, a:a, b:b, count:this.count};
    }
    export(){ return {theta:this.theta, P:this.P, lambda:this.lambda, count:this.count}; }
    import(d){
      if(!d) return;
      if(Array.isArray(d.theta) && d.theta.length===2) this.theta=[d.theta[0], d.theta[1]];
      if(Array.isArray(d.P) && d.P.length===2) this.P=d.P;
      if(typeof d.lambda==='number') this.lambda=d.lambda;
      this.count = d.count||0;
    }
    reset(){
      this.theta=[-59,-25];
      this.P=[[100,0],[0,100]];
      this.count=0;
    }
  }

  // Isolation Forest (lite, small dimensional) for anomaly scoring
  class IsolationForestLite {
    constructor(opts={}){
      this.trees=[];
      this.nTrees=opts.nTrees||10;
      this.sampleSize=opts.sampleSize||48;
      this.maxDepth=opts.maxDepth||8;
      this.trained=false;
      this.dim=opts.dim||5;
    }

    _randInt(n){ return Math.floor(Math.random()*n); }
    _harmonic(n){
      // approximation H(n) ~ ln(n) + gamma
      const gamma=0.5772156649;
      return Math.log(n) + gamma;
    }
    _c(n){
      if(n<=1) return 0;
      return 2*this._harmonic(n-1) - (2*(n-1)/n);
    }

    _buildTree(samples, depth){
      if(depth>=this.maxDepth || samples.length<=1){
        return {leaf:true, n:samples.length, depth};
      }
      const q=this._randInt(this.dim);
      let min=Infinity,max=-Infinity;
      for(const s of samples){
        const v=s[q];
        if(v<min) min=v;
        if(v>max) max=v;
      }
      if(!isFinite(min) || !isFinite(max) || min===max){
        return {leaf:true, n:samples.length, depth};
      }
      const split = min + Math.random()*(max-min);
      const left=[], right=[];
      for(const s of samples){
        (s[q] < split ? left : right).push(s);
      }
      return {leaf:false, q, split, left:this._buildTree(left, depth+1), right:this._buildTree(right, depth+1), depth};
    }

    train(data){
      if(!Array.isArray(data) || data.length<12) { this.trained=false; this.trees=[]; return; }
      // sample subset for each tree
      this.dim = data[0].length;
      this.trees=[];
      for(let i=0;i<this.nTrees;i++){
        const subset=[];
        for(let j=0;j<Math.min(this.sampleSize, data.length);j++){
          subset.push(data[this._randInt(data.length)]);
        }
        this.trees.push(this._buildTree(subset, 0));
      }
      this.trained=true;
    }

    _pathLen(x, node){
      if(!node || node.leaf){
        const n = node ? node.n : 1;
        // leaf adjustment
        return (node ? node.depth : 0) + this._c(n);
      }
      if(x[node.q] < node.split) return this._pathLen(x, node.left);
      return this._pathLen(x, node.right);
    }

    score(x){
      if(!this.trained || !this.trees.length) return 0.0;
      let sum=0;
      for(const t of this.trees) sum += this._pathLen(x, t);
      const Eh = sum/this.trees.length;
      const cn = this._c(this.sampleSize);
      const s = Math.pow(2, -Eh / (cn || 1));
      return clamp(s, 0, 1);
    }

    export(){
      // Keep it light: don't persist trees (huge). Persist only config.
      return {nTrees:this.nTrees, sampleSize:this.sampleSize, maxDepth:this.maxDepth, dim:this.dim, trained:false};
    }
    import(d){
      if(!d) return;
      if(typeof d.nTrees==='number') this.nTrees=d.nTrees;
      if(typeof d.sampleSize==='number') this.sampleSize=d.sampleSize;
      if(typeof d.maxDepth==='number') this.maxDepth=d.maxDepth;
      if(typeof d.dim==='number') this.dim=d.dim;
    }
    reset(){ this.trees=[]; this.trained=false; }
  }

  const AIPackV4 = {
    enabledDefault: true,

    attachPet(p){
      if(!p) return;
      p.aiToggles = Object.assign({knn:true, anomaly:true, rls:false}, p.aiToggles||{});
      if(!p.ai4){
        p.ai4 = {
          knn: new KNNLite(5),
          rls: new RLSCalibrator(),
          iso: new IsolationForestLite({nTrees:10, sampleSize:48, maxDepth:8, dim:5}),
          // safe baseline samples for training
          safeSamples: new RingBuffer(120),
          lastX: null,
          lastAnom: 0,
          lastKnn: {label:null, conf:0},
          lastTrainMs: 0
        };
      }
      // import persisted states if present
      try{
        const st = p.aiState || {};
        if(st.knn) p.ai4.knn.import(st.knn);
        if(st.rls) p.ai4.rls.import(st.rls);
        if(st.iso) p.ai4.iso.import(st.iso);
      }catch(e){}
    },

    featureVector(p, now){
      // Normalize into small [0..1]ish space for learning
      const rssi = clamp((p.smoothedRssi + 100)/70, 0, 1);                 // -100..-30
      const vel = clamp((p.kalman.getVelocity() + 10)/20, 0, 1);           // approx
      const f = p.behavior.getFeatures() || {variance:60, trend:0};
      const varN = clamp(f.variance/160, 0, 1);
      const trendN = clamp((f.trend + 12)/24, 0, 1);
      const silentN = clamp(((now - (p.lastSeenMs||now))/ (perfProfile.lostMs||9000)), 0, 1);
      return [rssi, vel, varN, trendN, silentN];
    },

    onPetProcessed(p, now){
      if(!p || !p.ai4) return;
      const x=this.featureVector(p, now);
      p.ai4.lastX = x;

      // Anomaly: train only on SAFE windows to learn baseline
      if(p.aiToggles.anomaly){
        if(p.zone.stable==='SAFE' && p.confidence>=50){
          p.ai4.safeSamples.push(x);
        }
        // retrain occasionally
        if(p.ai4.safeSamples.length>=30 && (now - p.ai4.lastTrainMs)>30000){
          try{
            p.ai4.iso.train(p.ai4.safeSamples.data);
            p.ai4.lastTrainMs=now;
          }catch(e){}
        }
        const a = p.ai4.iso.trained ? p.ai4.iso.score(x) : 0;
        // hybrid with heuristic when untrained
        const heuristic = clamp((Math.max(0, (-p.kalman.getVelocity())/6) + (((p.behavior.getFeatures && p.behavior.getFeatures())||{}).variance||60)/220)/2, 0, 1);
        p.ai4.lastAnom = p.ai4.iso.trained ? clamp((a*0.7 + heuristic*0.3),0,1) : heuristic;
      }

      // kNN prediction only when we have samples
      if(p.aiToggles.knn){
        p.ai4.lastKnn = p.ai4.knn.predict(x);
      }
    },

    learnFromFeedback(p, helpful){
      if(!p || !p.ai4 || !p.ai4.lastX) return;
      // label: 1 means "real danger (helpful)", 0 means "false alarm / safe"
      p.ai4.knn.add(p.ai4.lastX, helpful?1:0);
    },

    exportState(p){
      const st = p.aiState || {};
      if(p.ai4){
        st.knn = p.ai4.knn.export();
        st.rls = p.ai4.rls.export();
        st.iso = p.ai4.iso.export();
      }
      return st;
    },

    explain(p){
      if(!p || !p.ai4) return {anom:0, knn:null};
      return {
        anom: Math.round((p.ai4.lastAnom||0)*100),
        knn: (!p.ai4.lastKnn || p.ai4.lastKnn.label===null) ? null : {label:p.ai4.lastKnn.label, conf:p.ai4.lastKnn.conf}
      };
    }
  };

  /* ----------------------------- CONDUCTOR AI (Self-heal / UX suggestions) ----------------------------- */
  const ConductorAI = {
    enabled:true,
    lastTick:0,
    lastSuggest:0,
    safeMode:false,
    battery:null,
    lastBatteryAt:0,

    async init(){
      this.enabled = await Store.getSetting('autoOptimize', true);
      try{
        this.battery = await Capabilities.battery();
      }catch(e){ this.battery=null; }
    },

    async refreshBattery(){
      const now=nowMs();
      if(now - this.lastBatteryAt < 15000) return;
      this.lastBatteryAt=now;
      try{
        if(navigator.getBattery){
          this.battery = await navigator.getBattery();
        }
      }catch(e){}
    },

    batteryInfo(){
      const b=this.battery;
      if(!b) return null;
      return {
        level: (typeof b.level==='number') ? b.level : null,
        charging: !!b.charging
      };
    },

    compute(){
      const now=nowMs();
      const tips=[];
      const actions=[];

      // Environment guidance
      if(location.protocol.startsWith('file')){
        tips.push({k:'env_file', t:'Running from file:// can reduce BLE reliability. Use HTTPS/localhost or install as an app (Ïï± ÏÑ§Ïπò).'});
      }
      if(!window.isSecureContext && !location.hostname.includes('localhost')){
        tips.push({k:'env_secure', t:'Secure context required for reliable BLE. Use HTTPS/localhost.'});
      }

      // Scan health
      if(App.monitoringWanted && !BLE.scanning){
        tips.push({k:'scan_off', t:'Monitoring is OFF. Tap Start Monitoring.'});
      }
      if(BLE.scanning){
        const silent = now - (BLE.lastAnyAdvMs||0);
        if(silent > perfProfile.scanStallMs*0.9){
          tips.push({k:'scan_stall', t:'Scan looks stalled. The watchdog will try restart. Keep screen awake, or enable Audio Keepalive.'});
          if(!Settings.prefs.keepAlive) actions.push({label:'Enable Keepalive', fn:()=>Settings.toggle('keepAlive')});
          if(!Settings.prefs.screenAwake) actions.push({label:'Enable Screen Awake', fn:()=>Settings.toggleV40('screenAwake')});
        }
        if(BLE.congestionLevel()==='high'){
          tips.push({k:'scan_cong', t:'High BLE congestion. Use Focus mode on one pet for better accuracy.'});
          if(App.trackMode!=='focus') actions.push({label:'Switch to Focus', fn:()=>App.setTrackMode('focus')});
        }
      }

      // Battery / performance
      const bi=this.batteryInfo();
      if(bi && bi.level!==null){
        const pct=Math.round(bi.level*100);
        if(pct<=18 && App.monitoringWanted && Settings.prefs.perfMode!=='saver'){
          tips.push({k:'bat_low', t:`Battery is low (${pct}%). Consider Saver performance mode.`});
          actions.push({label:'Set Saver Mode', fn:()=>Settings.setPerf('saver')});
        }
      }

      // Pet-specific detection errors
      const troubled = App.pets.find(p=>p.ambiguousCount>0 && (now-(p.lastAmbiguousMs||0))<120000);
      if(troubled){
        tips.push({k:'ambig', t:`${troubled.name}: signal ambiguous. Re-verify tag near the phone to improve matching.`});
        actions.push({label:'Re-verify Tag', fn:()=>Wizard.open(troubled.id)});
      }

      // Safe mode suggestion
      if(BLE.stallCount>=3 || BLE.restartCount>=MAX_RESTARTS_PER_MIN){
        tips.push({k:'safe', t:'Frequent scan restarts detected. Consider Safe Mode (reduces CPU, increases stability).'});
        if(!this.safeMode) actions.push({label:'Enable Safe Mode', fn:()=>SafeMode.enable('scan_instability')});
      }

      return {tips, actions};
    },

    tick(){
      const now=nowMs();
      if(now - this.lastTick < 900) return;
      this.lastTick=now;
      if(!this.enabled) return;
      this.refreshBattery();
      // no auto-actions without consent; only suggestions
    }
  };

  const SafeMode = {
    active:false,
    reason:'',
    async enable(reason='manual'){
      if(this.active) return;
      this.active=true;
      this.reason=reason;
      await Store.saveSetting('safeMode', true);
      await Store.saveSetting('safeModeReason', reason);
      // apply conservative settings
      if(Settings.prefs.perfMode!=='saver') await Settings.setPerf('saver');
      // reduce motion can help old devices
      if(!Settings.prefs.reduceMotion){ Settings.prefs.reduceMotion=true; await Store.saveSetting('reduceMotion', true); }
      Accessibility.apply();
      V40UI.renderSafeBanner();
      Toast.show('Safe Mode enabled');
    },
    async disable(){
      this.active=false;
      this.reason='';
      await Store.saveSetting('safeMode', false);
      await Store.saveSetting('safeModeReason', '');
      V40UI.renderSafeBanner();
      Toast.show('Safe Mode disabled');
    },
    async load(){
      this.active = await Store.getSetting('safeMode', false);
      this.reason = await Store.getSetting('safeModeReason', '') || '';
    }
  };

  /* ----------------------------- RESET / INITIALIZE CENTER ----------------------------- */
  const ResetCenter = {
    ensureUI(){
      if($('reset-overlay')) return;
      const wrap=document.createElement('div');
      wrap.innerHTML = `
        <div id="reset-overlay" class="overlay">
          <div class="overlay-header">
            <div class="overlay-title">Reset / Initialize</div>
            <button class="overlay-close" onclick="ResetCenter.close()">‚úï</button>
          </div>
          <div class="overlay-body" id="reset-body"></div>
        </div>
      `;
      document.body.appendChild(wrap.firstElementChild);
    },

    open(){
      this.ensureUI();
      this.render();
      $('reset-overlay').classList.add('active');
    },
    close(){
      var ro=$('reset-overlay'); if(ro) ro.classList.remove('active');
    },

    async render(){
      const caps = Capabilities.computeSync();
      const pwaHint = caps.serviceWorker ? 'This may also clear app cache depending on option.' : 'Service Worker not supported here.';
      $('reset-body').innerHTML = `
        <div class="tip-card warn">
          <div class="tip-title">Reset Options (V4.1)</div>
          <div class="tip-body">
            Use this if you experience bugs, tag confusion, or you want to hand the phone to a new owner.
            <br><br>
            <strong>Reminder:</strong> VitalGuard AI stores data locally (IndexedDB/localStorage). No cloud sync.
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">1) Soft Reset (recommended first)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Clears temporary state: scan timers, recent errors, UI cache. Keeps pets, signatures, and calibration.
          </div>
          <button class="btn btn-secondary btn-block" style="margin-top:10px" onclick="ResetCenter.soft()">Soft Reset</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">2) Hard Reset (re-tag required)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Deletes pets, signatures, alerts, AI learning, and settings. You will need to re-add tags.
          </div>
          <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="ResetCenter.hard()">Hard Reset</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">3) Factory Reset (deep clean)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Hard Reset + clear Service Worker registrations and caches (best effort). ${pwaHint}
          </div>
          <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="ResetCenter.factory()">Factory Reset</button>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Export before you wipe</div>
          <div class="tip-body">
            Tip: Go to Settings ‚Üí Backup to export your pets/signatures before hard reset.
          </div>
        </div>
      `;
    },

    async soft(){
      if(!confirm('Soft reset? (Keeps pets)')) return;
      try{
        // stop timers and restart scan cleanly
        BLE.stopScan();
        App.resetTimers();
        ErrorShield.clear();
        // clear minor UI settings
        await Store.saveSetting('lastTab', 'home');
        await Store.saveSetting('coachDismissed', false);
      }catch(e){}
      Toast.show('Soft reset done');
      this.close();
      // best effort: restart monitoring if it was wanted
      if(App.monitoringWanted) BLE.startScan('track', {silent:true});
    },

    async _confirmHard(){
      const msg = 'Type RESET to confirm (case-sensitive).';
      const v = prompt(msg, '');
      return v === 'RESET';
    },

    async hard(){
      if(!await this._confirmHard()) { Toast.show('Cancelled'); return; }
      try{
        BLE.stopScan();
        AudioEngine.stopKeepAlive();
        await WakeLockManager.release();
      }catch(e){}

      try{
        await Store.clearAll();
      }catch(e){}
      Toast.show('Hard reset complete');
      this.close();
      setTimeout(()=>location.reload(), 700);
    },

    async factory(){
      if(!await this._confirmHard()) { Toast.show('Cancelled'); return; }

      try{
        BLE.stopScan();
        AudioEngine.stopKeepAlive();
        await WakeLockManager.release();
      }catch(e){}

      try{
        await Store.clearAll();
      }catch(e){}

      // Best effort: unregister SW and delete caches
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
      }catch(e){}
      try{
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
      }catch(e){}

      // Best effort: delete our database (may fail if open)
      try{ indexedDB.deleteDatabase(DB_NAME); }catch(e){}

      Toast.show('Factory reset complete');
      this.close();
      setTimeout(()=>location.reload(), 900);
    }
  };

  /* ----------------------------- ENCRYPTED BACKUP (AES-GCM) ----------------------------- */
  const CryptoBox = {
    supported(){
      return !!(window.crypto && crypto.subtle && window.TextEncoder && window.TextDecoder);
    },
    _b64(u8){
      let s='';
      for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]);
      return btoa(s);
    },
    _u8(b64){
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return u8;
    },
    async _deriveKey(pass, salt){
      const enc=new TextEncoder();
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'},
        baseKey,
        {name:'AES-GCM', length:256},
        false,
        ['encrypt','decrypt']
      );
    },
    async encryptString(plain, pass){
      const enc=new TextEncoder();
      const salt=crypto.getRandomValues(new Uint8Array(16));
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const key=await this._deriveKey(pass, salt);
      const ct=await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plain));
      return {
        enc:true,
        v:1,
        alg:'AES-GCM',
        it:120000,
        salt:this._b64(salt),
        iv:this._b64(iv),
        ct:this._b64(new Uint8Array(ct))
      };
    },
    async decryptToString(pack, pass){
      const dec=new TextDecoder();
      const salt=this._u8(pack.salt);
      const iv=this._u8(pack.iv);
      const ct=this._u8(pack.ct);
      const key=await this._deriveKey(pass, salt);
      const pt=await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return dec.decode(pt);
    }
  };

  /* ----------------------------- V40 UI INJECTION ----------------------------- */
  const V40UI = {
    injected:false,

    inject(){
      if(this.injected) return;
      this.injected=true;

      Accessibility.injectCSS();
      ResetCenter.ensureUI();

      // Inject Advanced toggles card into Settings panel (UX)
      const panel=$('panel-settings');
      if(panel && !document.getElementById('v40-advanced-card')){
        const card=document.createElement('div');
        card.className='card';
        card.id='v40-advanced-card';
        card.innerHTML = `
          <div class="section-title" style="font-size:.8rem;margin-top:0">V4.1 Advanced</div>

          <div class="setting-row">
            <span style="font-size:.78rem">Screen Awake (Wake Lock)</span>
            <div class="toggle" id="toggle-screenAwake" onclick="Settings.toggleV40('screenAwake')"></div>
          </div>

          <div class="setting-row">
            <span style="font-size:.78rem">Use Scan Filters (less noise)</span>
            <div class="toggle" id="toggle-scanFilters" onclick="Settings.toggleV40('useScanFilters')"></div>
          </div>

          <div class="setting-row">
            <span style="font-size:.78rem">Auto Optimize (Conductor)</span>
            <div class="toggle" id="toggle-autoOptimize" onclick="Settings.toggleV40('autoOptimize')"></div>
          </div>

          <div class="divider"></div>

          <div class="section-title" style="font-size:.8rem;margin-top:0">Accessibility</div>

          <div class="setting-row">
            <span style="font-size:.78rem">Large Text</span>
            <div class="toggle" id="toggle-largeText" onclick="Settings.toggleV40('largeText')"></div>
          </div>
          <div class="setting-row">
            <span style="font-size:.78rem">High Contrast</span>
            <div class="toggle" id="toggle-highContrast" onclick="Settings.toggleV40('highContrast')"></div>
          </div>
          <div class="setting-row">
            <span style="font-size:.78rem">Reduce Motion</span>
            <div class="toggle" id="toggle-reduceMotion" onclick="Settings.toggleV40('reduceMotion')"></div>
          </div>

          <div class="divider"></div>

          <div class="section-title" style="font-size:.8rem;margin-top:0">Tools</div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-secondary btn-sm" onclick="ResetCenter.open()">üßº Reset / Initialize</button>
            <button class="btn btn-secondary btn-sm" onclick="V40UI.exportEncrypted()">üîê Encrypted Backup</button>
            <button class="btn btn-secondary btn-sm" onclick="V40UI.showPitch()">üìä Impact Deck</button>
          </div>

          <div id="v40-adv-hint" style="margin-top:10px;font-size:.72rem;color:var(--text-muted);line-height:1.45">
            Tip: Screen Awake helps prevent OS from pausing BLE scanning.
          </div>
        `;
        // place near bottom but before the "Guides" card if possible
        const guidesBtn = panel.querySelector('button[onclick="Help.open()"]');
        const guidesCard = guidesBtn ? guidesBtn.closest('.card') : null;
        panel.insertBefore(card, guidesCard || null);
      }

      this.renderSafeBanner();
    },

    renderSafeBanner(){
      // small banner in Home panel if safe mode
      const home=$('panel-home');
      if(!home) return;
      let banner=document.getElementById('safe-banner');
      if(!banner){
        banner=document.createElement('div');
        banner.id='safe-banner';
        banner.style.margin='10px 0';
        home.insertBefore(banner, (home.firstElementChild && home.firstElementChild.nextElementSibling) ? home.firstElementChild.nextElementSibling : null);
      }
      if(SafeMode.active){
        banner.innerHTML = `
          <div class="tip-card warn" style="margin:0">
            <div class="tip-title">üõ° Safe Mode ON</div>
            <div class="tip-body">
              Stability-first settings are active ${SafeMode.reason?('('+Sanitizer.text(SafeMode.reason,60)+')'):''}.
              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SafeMode.disable()">Disable</button>
                <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.open()">Diagnostics</button>
              </div>
            </div>
          </div>
        `;
      }else{
        banner.innerHTML='';
      }
    },

    async exportEncrypted(){
      if(!CryptoBox.supported()){ Toast.show('WebCrypto not supported'); return; }
      const pass = prompt('Set a passphrase for encrypted backup (write it down).', '');
      if(!pass || pass.length<6){ Toast.show('Passphrase too short'); return; }

      // Use DataManager export structure
      const includeVoice = await Store.getBlob(VoiceRecall.key) ? confirm('Include Voice Recall audio? (larger file)') : false;
      let voiceBase64=null;

      if(includeVoice){
        const blob=await Store.getBlob(VoiceRecall.key);
        if(blob){
          voiceBase64 = await new Promise(res=>{
            const fr=new FileReader();
            fr.onload=()=>res(fr.result);
            fr.onerror=()=>res(null);
            fr.readAsDataURL(blob);
          });
        }
      }

      const data={
        appVersion:APP_VERSION,
        schemaVersion:SCHEMA_VERSION,
        exported:new Date().toISOString(),
        pets:App.pets.map(p=>p.toJSON()),
        settings:Settings.prefs,
        voiceRecall: voiceBase64 ? {included:true, dataUrl:voiceBase64} : {included:false}
      };

      try{
        const pack = await CryptoBox.encryptString(JSON.stringify(data), pass);
        downloadText('vitalguard-ai-v41-7-backup-encrypted-'+Date.now()+'.json', safeJson(pack), 'application/json');
        Toast.show('Encrypted backup exported');
      }catch(e){
        Toast.show('Encrypt failed');
      }
    },

    showPitch(){
      // open About & Legal directly on Impact tab
      try{
        Legal.open('impact');
      }catch(e){
        Legal.open();
      }
    }
  };

  /* ----------------------------- PATCH: Settings (new prefs + toggles) ----------------------------- */
  Settings.prefs = Object.assign({
    useScanFilters:true,
    screenAwake:false,
    autoOptimize:true,
    largeText:false,
    highContrast:false,
    reduceMotion:false
  }, Settings.prefs||{});

  const _settingsLoad = Settings.load.bind(Settings);
  Settings.load = async function(){
    await _settingsLoad();

    this.prefs.useScanFilters = await Store.getSetting('useScanFilters', true);
    this.prefs.screenAwake = await Store.getSetting('screenAwake', false);
    this.prefs.autoOptimize = await Store.getSetting('autoOptimize', true);
    this.prefs.largeText = await Store.getSetting('largeText', false);
    this.prefs.highContrast = await Store.getSetting('highContrast', false);
    this.prefs.reduceMotion = await Store.getSetting('reduceMotion', false);

    Accessibility.apply();
    this._updateToggles();
    this._updateTogglesV40();
  };

  Settings._updateTogglesV40 = function(){
    const t1=$('toggle-scanFilters');
    const t2=$('toggle-screenAwake');
    const t3=$('toggle-autoOptimize');
    const t4=$('toggle-largeText');
    const t5=$('toggle-highContrast');
    const t6=$('toggle-reduceMotion');
    if(t1) t1.classList.toggle('on', !!this.prefs.useScanFilters);
    if(t2) t2.classList.toggle('on', !!this.prefs.screenAwake);
    if(t3) t3.classList.toggle('on', !!this.prefs.autoOptimize);
    if(t4) t4.classList.toggle('on', !!this.prefs.largeText);
    if(t5) t5.classList.toggle('on', !!this.prefs.highContrast);
    if(t6) t6.classList.toggle('on', !!this.prefs.reduceMotion);
  };

  Settings.toggleV40 = async function(key){
    if(!(key in this.prefs)) return;
    this.prefs[key]=!this.prefs[key];
    await Store.saveSetting(key, this.prefs[key]);

    if(key==='useScanFilters'){
      Toast.show(this.prefs.useScanFilters?'Scan filters ON':'Scan filters OFF');
      // Apply immediately: restart scan (best effort)
      if(BLE.scanning) BLE.restartScan('toggle_filters');
    }
    if(key==='screenAwake'){
      Toast.show(this.prefs.screenAwake?'Screen Awake ON':'Screen Awake OFF');
      if(this.prefs.screenAwake && App.monitoringWanted && BLE.scanning) WakeLockManager.request();
      else WakeLockManager.release();
    }
    if(key==='autoOptimize'){
      Toast.show(this.prefs.autoOptimize?'Conductor ON':'Conductor OFF');
      ConductorAI.enabled=this.prefs.autoOptimize;
      await Store.saveSetting('autoOptimize', this.prefs.autoOptimize);
    }
    if(key==='largeText' || key==='highContrast' || key==='reduceMotion'){
      Accessibility.apply();
      Toast.show('Accessibility updated');
    }

    this._updateTogglesV40();
  };

  // Replace the old destructive Settings.resetApp with the reset center
  Settings.resetApp = function(){ ResetCenter.open(); };

  /* ----------------------------- PATCH: BLE filters toggle ----------------------------- */
  const _buildTrackFilters = BLE._buildTrackFilters.bind(BLE);
  BLE._buildTrackFilters = function(pets){
    if(Settings && Settings.prefs && Settings.prefs.useScanFilters===false) return null;
    return _buildTrackFilters(pets);
  };

  /* ----------------------------- PATCH: Pet AI attach + safe sanitize ----------------------------- */
  const _origPetToJSON = Pet.prototype.toJSON;
  Pet.prototype.toJSON = function(){
    const d=_origPetToJSON.call(this);
    d.name = Sanitizer.name(d.name);
    d.icon = Sanitizer.icon(d.icon);
    d.aiToggles = Object.assign({knn:true, anomaly:true, rls:false}, d.aiToggles||{});
    d.aiState = d.aiState || {};
    try{
      if(this.ai4){
        d.aiState.knn = this.ai4.knn.export();
        d.aiState.rls = this.ai4.rls.export();
        d.aiState.iso = this.ai4.iso.export();
      }
    }catch(e){}
    return d;
  };

  const _origProcess = Pet.prototype.processRssi;
  Pet.prototype.processRssi = function(rssi, now){
    _origProcess.call(this, rssi, now);
    try{
      AIPackV4.attachPet(this);
      AIPackV4.onPetProcessed(this, now);
    }catch(e){}
  };

  const _origMarkLost = Pet.prototype.markLost;
  Pet.prototype.markLost = function(now){
    _origMarkLost.call(this, now);
    try{
      AIPackV4.attachPet(this);
      AIPackV4.onPetProcessed(this, now);
    }catch(e){}
  };

  /* ----------------------------- PATCH: Detail feedback => kNN learning + extra explain ----------------------------- */
  const _origAiFeedback = Detail.aiFeedback.bind(Detail);
  Detail.aiFeedback = async function(helpful){
    try{
      if(this.pet){
        AIPackV4.attachPet(this.pet);
        AIPackV4.learnFromFeedback(this.pet, helpful);
        await Store.savePet(this.pet);
      }
    }catch(e){}
    return _origAiFeedback(helpful);
  };

  const _origDetailRender = Detail.render.bind(Detail);
  Detail.render = async function(){
    await _origDetailRender();

    const p=this.pet;
    if(!p) return;
    AIPackV4.attachPet(p);

    // Add V4 AI explain block under AI section (best effort)
    try{
      const explain=AIPackV4.explain(p);
      const aiSuggestion = document.getElementById('ai-suggestion');
      if(aiSuggestion){
        const box=document.createElement('div');
        box.className='tip-card info';
        box.style.marginTop='10px';
        const knnText = (explain.knn===null) ? 'kNN: learning‚Ä¶ (need feedback samples)'
          : (`kNN: <strong>${explain.knn.label? 'DANGER':'SAFE'}</strong> (${explain.knn.conf}% confidence)`);
        box.innerHTML = `
          <div class="tip-title">AI Explain (V4)</div>
          <div class="tip-body">
            Anomaly score: <strong>${explain.anom}%</strong><br>
            ${knnText}<br>
            <span style="color:var(--text-muted)">These are advisory signals. Primary logic remains hysteresis + Kalman smoothing.</span>
          </div>
        `;
        // Insert only once
        if(!document.getElementById('v40-ai-explain')){
          box.id='v40-ai-explain';
          aiSuggestion.parentElement.appendChild(box);
        }
      }
    }catch(e){}
  };

  /* ----------------------------- PATCH: Wizard + Emergency sanitize ----------------------------- */
  const _wizardSave = Wizard.save.bind(Wizard);
  Wizard.save = async function(){
    try{
      if($('input-name')) $('input-name').value = Sanitizer.name($('input-name').value||'');
      this.chosenIcon = Sanitizer.icon(this.chosenIcon);
    }catch(e){}
    return _wizardSave();
  };

  const _emgSaveFromUI = Emergency.saveFromUI.bind(Emergency);
  Emergency.saveFromUI = function(){
    try{
      if($('emg-name')) $('emg-name').value = Sanitizer.text($('emg-name').value||'', 50);
      if($('emg-phone')) $('emg-phone').value = Sanitizer.phone($('emg-phone').value||'');
      if($('emg-medical')) $('emg-medical').value = Sanitizer.text($('emg-medical').value||'', 220);
    }catch(e){}
    return _emgSaveFromUI();
  };

  /* ----------------------------- PATCH: App init / monitoring => wake lock + conductor + error shield ----------------------------- */
  const _appInit = App.init.bind(App);
  App.init = async function(){
    ErrorShield.hook();
    V40UI.inject();

    await _appInit();

    // Post-init loads
    try{ await ErrorShield.load(); }catch(e){}
    try{ await SafeMode.load(); }catch(e){}
    try{ await ConductorAI.init(); }catch(e){}
    try{ WakeLockManager.hookVisibility(); }catch(e){}

    // Upgrade pets with new AI + sanitize imported names/icons
    try{
      for(const p of this.pets){
        p.name = Sanitizer.name(p.name);
        p.icon = Sanitizer.icon(p.icon);
        AIPackV4.attachPet(p);
      }
    }catch(e){}

    Accessibility.apply();
    if(Settings._updateTogglesV40) Settings._updateTogglesV40();
    V40UI.renderSafeBanner();
  };

  const _toggleMonitoring = App.toggleMonitoring.bind(App);
  App.toggleMonitoring = async function(){
    const before = this.monitoringWanted;
    await _toggleMonitoring();
    const after = this.monitoringWanted;
    if(after && !before){
      // just turned on
      if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      if(Settings.prefs.screenAwake) WakeLockManager.request();
    }
    if(!after && before){
      await WakeLockManager.release();
    }
  };

  const _watchdog = App._watchdog.bind(App);
  App._watchdog = function(){
    try{ _watchdog(); }catch(e){}
    try{ ConductorAI.tick(); }catch(e){}
    // auto safe-mode trigger (best effort, non-destructive)
    try{
      if(!SafeMode.active && (BLE.stallCount>=4 || BLE.restartCount>=MAX_RESTARTS_PER_MIN+1)){
        SafeMode.enable('auto_scan_instability');
      }
    }catch(e){}
  };

  /* ----------------------------- PATCH: Diagnostics (capabilities + error log + battery) ----------------------------- */
  const _diagSnapshot = Diag.snapshot.bind(Diag);
  Diag.snapshot = function(){
    const s=_diagSnapshot();
    try{
      s.capabilities = Capabilities.computeSync();
      s.safeMode = {active:SafeMode.active, reason:SafeMode.reason};
      s.errors = ErrorShield.ring.data;
      const bi=ConductorAI.batteryInfo();
      if(bi) s.battery = bi;
    }catch(e){}
    return s;
  };

  Diag.render = function(){
    const snap=this.snapshot();
    const errs = (snap.errors||[]).slice(-12).reverse();
    $('diag-body').innerHTML = `
      <div class="tip-card info">
        <div class="tip-title">Diagnostics Snapshot (V4.1)</div>
        <div class="tip-body">
          Use this for debugging scan issues, checking device compatibility, or sharing with maintainers.
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:10px 0">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.copy()">üìã Copy</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.download()">‚¨áÔ∏è Download</button>
      </div>

      ${Capabilities.renderHTML()}

      <div class="card" style="margin-top:10px">
        <div class="section-title" style="font-size:.8rem;margin:0 0 8px">Recent Errors</div>
        ${errs.length ? errs.map(e=>`
          <div style="border-top:1px solid var(--border-color);padding:10px 0;font-size:.72rem;color:var(--text-secondary);line-height:1.45">
            <div style="color:var(--text-muted)">${e.t} ¬∑ <span class="kbd">${e.kind}</span></div>
            <div><strong>${e.msg}</strong></div>
            ${e.where?`<div style="color:var(--text-muted)">${e.where}</div>`:''}
          </div>
        `).join('') : `<div style="font-size:.75rem;color:var(--text-muted);padding:6px 0">No errors captured.</div>`}
        <button class="btn btn-secondary btn-sm" style="margin-top:10px;width:100%" onclick="ErrorShield.clear()">Clear Error Log</button>
      </div>

      <pre id="diag-pre" style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4;margin-top:10px">${safeJson(snap)}</pre>

      <div class="tip-card warn">
        <div class="tip-title">Privacy Note</div>
        <div class="tip-body">
          This snapshot stays local unless you manually share it. It contains device info (user-agent), but no cloud identifiers.
        </div>
      </div>
    `;
  };

  Diag.download = function(){
    const snap=this.snapshot();
    const blob=new Blob([safeJson(snap)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-7-diagnostics-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Downloaded');
  };

  /* ----------------------------- PATCH: Coach card (tips + one-tap actions) ----------------------------- */
  Coach.compute = function(){
    const {tips, actions} = ConductorAI.compute();
    // keep original small tips too (fallback)
    const baseTips=[];
    try{
      if(!BLE.checkSupport()){
        baseTips.push({k:'ble', t:'This browser may not support BLE scanning. Use Android Chrome or Demo mode.'});
      }
    }catch(e){}
    return {tips:[...baseTips, ...tips], actions};
  };

  Coach.render = function(){
    const res=this.compute();
    const tips=res.tips||[];
    const actions=res.actions||[];
    const card=$('coach-card');
    const body=$('coach-body');
    if(!card || !body) return;
    if(!tips.length && !actions.length){ card.style.display='none'; return; }

    body.innerHTML = `
      <ul style="margin-left:18px;line-height:1.6">
        ${tips.slice(0,6).map(t=>'<li>'+t.t+'</li>').join('')}
      </ul>
      ${actions.length ? `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          ${actions.slice(0,3).map((a,i)=>`<button class="btn btn-secondary btn-sm" onclick="(${a.fn.toString()})()">${a.label}</button>`).join('')}
        </div>
      `:''}
    `;
    card.style.display='block';
  };

    /* ----------------------------- PATCH: Legal / About (VitalGuard Demo) ----------------------------- */
  // Replace the previous social-impact deck with a diplomacy‚Äëfriendly, life‚Äësaving demo explanation.
  Legal.open = function(){
    try{
      const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
      if($('legal-body')) $('legal-body').innerHTML = (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
    }catch(e){
      if($('legal-body')) $('legal-body').textContent = '';
    }
    $('legal-overlay').classList.add('active');
  };
  Legal._content = function(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
  };

  /* ----------------------------- PATCH: SOS snapshot sanitize ----------------------------- */
  const _sosUpdateSnapshot = SOS.updateSnapshot.bind(SOS);
  SOS.updateSnapshot = function(pet){
    try{
      if(pet){
        pet.name = Sanitizer.name(pet.name);
        pet.icon = Sanitizer.icon(pet.icon);
      }
    }catch(e){}
    return _sosUpdateSnapshot(pet);
  };

  /* ----------------------------- PATCH: Data import supports encrypted pack ----------------------------- */
  const _handleImport = DataManager.handleImport.bind(DataManager);
  DataManager.handleImport = async function(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;
    try{
      const text=await file.text();
      let data=JSON.parse(text);

      if(data && data.enc){
        if(!CryptoBox.supported()) throw new Error('Crypto not supported');
        const pass = prompt('Enter passphrase to decrypt this backup:', '');
        if(!pass) throw new Error('No passphrase');
        const plain = await CryptoBox.decryptToString(data, pass);
        data = JSON.parse(plain);
        // Build a fake event payload for original handler
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const f2 = new File([blob], 'decrypted-backup.json', {type:'application/json'});
        const ev2 = {target:{files:[f2]}};
        return _handleImport(ev2);
      }
    }catch(e){
      // fall through to normal handler
    }
    return _handleImport(ev);
  };

  
/* ----------------------------- V4.1 EXTRA PATCHES -----------------------------
   Goals:
   - Real scannable QR (handled earlier via Nayuki QR generator)
   - Calibration Pro (RLS) fully integrated (Wizard + Detail)
   - Rescue Pack share/import standardized in SOS panel (text/code/QR)
   - Per-pet alert preferences (sound/vibrate/voice + min zone)
   - Stability improvements: max 10 active pets, lost flip counter fix, better false-lost resistance
------------------------------------------------------------------------------- */

const V41_MAX_ACTIVE_PETS = 10;

const V41_DEFAULT_ALERT_PREFS = {
  sound: true,
  vibrate: true,
  tts: true,
  minZone: 'WARNING' // v4.1 default: reduce noise (no beep on CAUTION by default)
};

const V41_ZONE_RANK = { SAFE:0, CAUTION:1, WARNING:2, DANGER:3, LOST:4 };

function v41ZoneRank(z){ return V41_ZONE_RANK[z] ?? 0; }

function v41EnsureAlertPrefs(p){
  if(!p) return;
  if(!p.alertPrefs || typeof p.alertPrefs !== 'object') p.alertPrefs = {};
  for(const k of Object.keys(V41_DEFAULT_ALERT_PREFS)){
    if(p.alertPrefs[k] === undefined) p.alertPrefs[k] = V41_DEFAULT_ALERT_PREFS[k];
  }
  if(!(p.alertPrefs.minZone in V41_ZONE_RANK)) p.alertPrefs.minZone = 'WARNING';
}

/* -------- Lost flip counter fix (batterySuspect) -------- */
(function(){
  const WINDOW_MS_DEFAULT = 30 * 60 * 1000; // 30 minutes
  const _origMarkLost = Pet.prototype.markLost;
  const _origProcess = Pet.prototype.processRssi;

  Pet.prototype._v41PruneLostEvents = function(now){
    const windowMs = (Settings?.prefs?.batteryWindowMs ?? WINDOW_MS_DEFAULT);
    const arr = Array.isArray(this.lostEvents) ? this.lostEvents : [];
    this.lostEvents = arr.filter(t => (now - t) < windowMs);
    this.lostFlips = this.lostEvents.length;
    this.batterySuspect = (this.lostFlips >= 3);
  };

  Pet.prototype.markLost = function(now){
    if(this.disabled) return;
      // v4.1 walking/unstable guard: delay LOST a bit when the signal is fluctuating (reduces false LOST while walking)
      try{
        const stable = this.zone?.stable;
        const silence = now - (this.lastSeenMs || 0);
        const cls = this.behavior?.classify?.() || '';
        const extendMs = 12000;
        if(stable !== 'LOST' && stable !== 'DANGER' && (cls === 'moving_away' || cls === 'unstable')){
          if(silence < extendMs) return;
        }
      }catch(_){}

    const wasLost = (this.zone?.stable === 'LOST');
    _origMarkLost.call(this, now);
    if(!Array.isArray(this.lostEvents)) this.lostEvents = [];
    if(!wasLost && this.zone?.stable === 'LOST'){
      this.lostEvents.push(now);
    }
    this._v41PruneLostEvents(now);
  };

  Pet.prototype.processRssi = function(rssi, now){
    if(this.disabled) return;
    _origProcess.call(this, rssi, now);
    if(!Array.isArray(this.lostEvents)) this.lostEvents = [];
    this._v41PruneLostEvents(now);
  };
})();

/* -------- Per-pet alerts (sound/vibrate/tts + min zone) -------- */
(function(){
  const _origTrigger = App.triggerAlert.bind(App);
  App.triggerAlert = function(pet, from, to){
    try{
      if(!pet || pet.disabled) return;

      v41EnsureAlertPrefs(pet);
      const prefs = pet.alertPrefs || V41_DEFAULT_ALERT_PREFS;
      const minRank = v41ZoneRank(prefs.minZone || 'WARNING');
      if(v41ZoneRank(to) < minRank) return;

      const key = `${pet.id}:${from}->${to}`;
      const now = nowMs();
      const last = this._alertCooldown.get(key) || 0;
      if(now - last < ALERT_COOLDOWN_MS) return;
      this._alertCooldown.set(key, now);

      if(Settings.prefs.sound && prefs.sound) AudioEngine.alertForZone(to);
      if(Settings.prefs.vibrate && prefs.vibrate && navigator.vibrate) navigator.vibrate([200,120,200]);
      if(Settings.prefs.tts && prefs.tts) VoiceAnnouncer.say(`${pet.name} ${to.toLowerCase()}`);
    }catch(e){
      console.warn('v4.1 triggerAlert patch failed:', e);
      return _origTrigger(pet, from, to);
    }
  };
})();

/* -------- Max 10 active pets: enforce + disable overflow -------- */
(function(){
  const _origAddPet = App.addPet.bind(App);
  App.addPet = function(pet){
    try{
      if(!pet) return;
      const activeCount = this.pets.filter(p => !p.disabled).length;
      if(activeCount >= V41_MAX_ACTIVE_PETS){
        Toast.show(`Max ${V41_MAX_ACTIVE_PETS} active pets for stability. Disable/remove one first.`, 3200);
        return;
      }
      pet.disabled = false;
      v41EnsureAlertPrefs(pet);
      return _origAddPet(pet);
    }catch(e){
      console.warn('v4.1 addPet patch failed:', e);
      return _origAddPet(pet);
    }
  };
})();

/* -------- Leash distance slider (2m‚Äì15m) in Detail -> auto thresholds -------- */
const V41UI = {};

V41UI._distanceToRssi = function(pet, meters){
  const tx = (pet?.distance?.txPower ?? -59);
  const n = (pet?.distance?.n ?? 2.5);
  return tx - 10 * n * Math.log10(Math.max(1, meters));
};

V41UI.applyMetersLeash = function(pet, meters){
  if(!pet) return;
  const m = Math.max(2, Math.min(15, Math.round(Number(meters)||10)));
  const warn = Math.round(this._distanceToRssi(pet, m));
  const caution = warn + 8;
  const danger = warn - 7;

  pet.thresholds = pet.thresholds || {...DEFAULT_THRESHOLDS};
  pet.thresholds.cautionEnter = caution;
  pet.thresholds.cautionExit  = caution + 5;
  pet.thresholds.warningEnter = warn;
  pet.thresholds.warningExit  = warn + 6;
  pet.thresholds.dangerEnter  = danger;
  pet.thresholds.dangerExit   = danger + 6;

  pet.leashPreset = 'custom'; // we still store exact thresholds
  pet.leashDistanceM = m;
  Store.savePet(pet);

  // update UI sliders + labels if present
  const ct = document.getElementById('custom-thresholds');
  if(ct){
    const labels = {
      'dt-caution': caution,
      'dt-warning': warn,
      'dt-danger': danger
    };
    for(const id in labels){
      const el = document.getElementById(id);
      if(el) el.textContent = `${labels[id]} dBm`;
    }
    // sliders are in order: caution, warning, danger (in the template)
    const sliders = ct.querySelectorAll('input[type="range"]');
    if(sliders && sliders.length >= 3){
      sliders[0].value = caution;
      sliders[1].value = warn;
      sliders[2].value = danger;
    }
  }
  Toast.show(`Leash distance set to ${m}m (auto thresholds).`, 1800);
};

V41UI.injectDetailMetersLeash = function(pet){
  try{
    if(!pet) return;
    v41EnsureAlertPrefs(pet);
    const host = document.getElementById('custom-thresholds');
    if(!host) return;
    if(document.getElementById('v41-meters-leash')) return;

    const m0 = pet.leashDistanceM || (pet.leashPreset && /^\d+m$/.test(pet.leashPreset) ? parseInt(pet.leashPreset,10) : 10);

    const box = document.createElement('div');
    box.id = 'v41-meters-leash';
    box.style.margin = '0 0 12px 0';
    box.innerHTML = `
      <div class="section-title" style="margin-top:0">Distance leash (2‚Äì15m)</div>
      <div style="font-size:.74rem;color:var(--text-muted);line-height:1.45;margin:-4px 0 10px 0">
        Sets thresholds from your calibration model (txPower / n). For best accuracy, run <b>Calibration Pro</b>.
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <input id="v41-leash-m" type="range" min="2" max="15" step="1" value="${m0}" style="flex:1" />
        <span class="kbd" id="v41-leash-m-label">${m0}m</span>
        <button class="btn btn-sm btn-secondary" id="v41-leash-apply">Apply</button>
      </div>
    `;
    host.prepend(box);

    const slider = box.querySelector('#v41-leash-m');
    const label = box.querySelector('#v41-leash-m-label');
    const applyBtn = box.querySelector('#v41-leash-apply');

    slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });
    applyBtn.addEventListener('click', ()=>{ V41UI.applyMetersLeash(pet, slider.value); });
  }catch(e){
    console.warn('injectDetailMetersLeash failed:', e);
  }
};

/* -------- Calibration Pro (RLS) UI (Wizard + Detail) -------- */
(function(){
  // Extend Wizard with Calibration Pro state
  Wizard._ensureCalibPro = function(){
    if(!this.calibPro || typeof this.calibPro !== 'object') this.calibPro = { points: [], rls: new RLSCalibrator() };
    if(!Array.isArray(this.calibPro.points)) this.calibPro.points = [];
    if(!this.calibPro.rls) this.calibPro.rls = new RLSCalibrator();
    return this.calibPro;
  };

  Wizard.clearCalibPro = function(){
    const cp = this._ensureCalibPro();
    cp.points = [];
    cp.rls.reset();
    Toast.show('Calibration Pro cleared.', 1600);
    this._refreshCalibModelUI();
    V41UI.renderWizardCalibPro();
  };

  Wizard.recordCalibPro = function(dist){
    const cand = this.selectedCandidate();
    if(!cand){
      Toast.show('Select your tag first.', 2000);
      return;
    }
    const d = Math.max(2, Math.min(15, Number(dist)||5));
    const rssi = cand.rssi;
    if(!Number.isFinite(rssi)){
      Toast.show('RSSI not ready. Wait a moment and try again.', 2200);
      return;
    }
    const cp = this._ensureCalibPro();
    cp.points.push({dist:d, rssi:rssi, t: nowMs()});
    cp.rls.update(d, rssi);
    Toast.show(`Pro sample saved: ${d}m @ ${rssi}dBm`, 1700);
    this._refreshCalibModelUI('pro');
    V41UI.renderWizardCalibPro();
  };

  Wizard._refreshCalibModelUI = function(force){
    const txEl = document.getElementById('calib-tx');
    const nEl = document.getElementById('calib-n');
    if(!txEl || !nEl) return;

    let tx = -59, n = 2.5;
    try{
      if(force === 'pro'){
        const cp = this._ensureCalibPro();
        if(cp.points.length >= 2){
          const p = cp.rls.params();
          tx = p.txPower;
          n = p.n;
        }
      }else{
        const tmp = new DistanceEstimator();
        if(this.calib['1m'] && Number.isFinite(this.calib['1m'].rssi)) tmp.addCalibration(this.calib['1m'].rssi, 1);
        if(this.calib['10m'] && Number.isFinite(this.calib['10m'].rssi)) tmp.addCalibration(this.calib['10m'].rssi, 10);
        tx = tmp.txPower;
        n = tmp.n;
      }
    }catch(e){}

    txEl.textContent = Math.round(tx);
    nEl.textContent = Number(n).toFixed(2);
  };

  // Patch Wizard.recordCalib to update model label in real-time
  const _wizRecord = Wizard.recordCalib.bind(Wizard);
  Wizard.recordCalib = function(dist){
    _wizRecord(dist);
    this._refreshCalibModelUI();
  };

  // Reset pro state when wizard resets
  const _wizReset = Wizard.reset.bind(Wizard);
  Wizard.reset = function(){
    _wizReset();
    this.calibPro = { points: [], rls: new RLSCalibrator() };
    this._refreshCalibModelUI();
    V41UI.renderWizardCalibPro();
  };

  // Override Wizard.save to apply Pro calibration cleanly
  const _wizSaveFallback = Wizard.save.bind(Wizard);
  Wizard.save = async function(){
    try{
      const cand = this.selectedCandidate();
      if(!cand){
        Toast.show('Select your tag first.', 2200);
        return;
      }

      // Stability guard: max active pets
      if(this.mode !== 'reverify'){
        const activeCount = App.pets.filter(p => !p.disabled).length;
        if(activeCount >= V41_MAX_ACTIVE_PETS){
          Toast.show(`Max ${V41_MAX_ACTIVE_PETS} active pets for stability. Disable/remove one first.`, 3200);
          return;
        }
      }

      // Sanitize inputs
      let name = ($('wiz-name').value || '').trim() || 'My Pet';
      name = name.replace(/[\n\r\t]+/g,' ').slice(0,24);
      let icon = ($('wiz-icon').value || 'üê∂').trim() || 'üê∂';
      if(icon.length > 2) icon = icon.slice(0,2);

      // Use the selected signature (Step 1 ‚Üí Select)
      const signature = this.selectedSig ? {...this.selectedSig} : null;
      if(!signature){
        Toast.show('Tag signature not ready. Select your tag again.', 2200);
        return;
      }

      let pet;
      if(this.mode === 'reverify' && this.petRef){
        pet = this.petRef;
        pet.name = name;
        pet.icon = icon;
        pet.signature = signature;
        pet.disabled = false;
      }else{
        pet = new Pet({ name, icon, signature });
        pet.disabled = false;
        v41EnsureAlertPrefs(pet);
        App.addPet(pet);
      }

      // Basic calibration points (1m, 10m)
      pet.distance = pet.distance || new DistanceEstimator();
      if(this.calib['1m'] && Number.isFinite(this.calib['1m'].rssi)) pet.distance.addCalibration(this.calib['1m'].rssi, 1);
      if(this.calib['10m'] && Number.isFinite(this.calib['10m'].rssi)) pet.distance.addCalibration(this.calib['10m'].rssi, 10);

      // Pro calibration (RLS): needs 3+ samples for stability
      const cp = this.calibPro;
      if(cp && Array.isArray(cp.points) && cp.points.length >= 3){
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(pet.ai4 && pet.ai4.rls){
          pet.ai4.rls.reset();
          cp.points.forEach(pt=>{
            if(Number.isFinite(pt.dist) && Number.isFinite(pt.rssi)) pet.ai4.rls.update(pt.dist, pt.rssi);
          });
          pet.aiToggles = pet.aiToggles || {};
          pet.aiToggles.rls = true;

          pet.aiState = pet.aiState || {};
          pet.aiState.rls = pet.ai4.rls.export();

          const params = pet.ai4.rls.params();
          pet.distance.txPower = params.txPower;
          pet.distance.n = params.n;

          // keep samples for reference (do not call addCalibration -> would re-fit using only last 2 points)
          pet.distance.calibPoints = Array.isArray(pet.distance.calibPoints) ? pet.distance.calibPoints : [];
          cp.points.forEach(pt=> pet.distance.calibPoints.push({dist:pt.dist, rssi:pt.rssi, pro:true, t:pt.t||nowMs()}));
        }
      }

      Store.savePet(pet);
      App.render();

      this.close();
      Toast.show('Saved!', 1500);
    }catch(e){
      console.warn('Wizard.save v4.1 failed; falling back.', e);
      return _wizSaveFallback();
    }
  };

  /* Wizard UI injection */
  V41UI.injectWizardCalibPro = function(){
    try{
      const step2 = document.getElementById('wizard-step-2');
      if(!step2) return;
      if(document.getElementById('v41-calibpro-wizard')) return;

      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'v41-calibpro-wizard';
      card.innerHTML = `
        <div class="section-title">Calibration Pro (RLS)</div>
        <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
          Optional: record multiple samples (2‚Äì15m). The model learns <b>txPower</b> & <b>n</b> for better distance accuracy.
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <input id="v41-calibpro-dist" type="range" min="2" max="15" step="1" value="5" style="flex:1" />
          <span class="kbd" id="v41-calibpro-dist-label">5m</span>
          <button class="btn btn-sm btn-secondary" id="v41-calibpro-record">Record</button>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-sm btn-secondary" style="flex:1" id="v41-calibpro-clear">Clear</button>
          <button class="btn btn-sm btn-primary" style="flex:1" id="v41-calibpro-preview">Use Pro model</button>
        </div>

        <div id="v41-calibpro-stats" style="margin-top:10px;font-size:.74rem;color:var(--text-secondary);line-height:1.45"></div>
        <div id="v41-calibpro-list" style="margin-top:8px;font-size:.72rem;color:var(--text-muted);max-height:90px;overflow:auto;border:1px solid var(--border-color);border-radius:10px;padding:8px;background:var(--bg-elevated)"></div>
      `;
      step2.appendChild(card);

      const slider = card.querySelector('#v41-calibpro-dist');
      const label = card.querySelector('#v41-calibpro-dist-label');

      slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });
      card.querySelector('#v41-calibpro-record').addEventListener('click', ()=>Wizard.recordCalibPro(Number(slider.value)));
      card.querySelector('#v41-calibpro-clear').addEventListener('click', ()=>Wizard.clearCalibPro());
      card.querySelector('#v41-calibpro-preview').addEventListener('click', ()=>{
        Wizard._refreshCalibModelUI('pro');
        Toast.show('Using Pro model for the preview. It will be applied on Save.', 1800);
      });

      V41UI.renderWizardCalibPro();
    }catch(e){
      console.warn('injectWizardCalibPro failed:', e);
    }
  };

  V41UI.renderWizardCalibPro = function(){
    const card = document.getElementById('v41-calibpro-wizard');
    if(!card) return;
    const stats = card.querySelector('#v41-calibpro-stats');
    const list = card.querySelector('#v41-calibpro-list');
    const cp = Wizard._ensureCalibPro();

    const pts = cp.points || [];
    if(pts.length === 0){
      stats.textContent = 'No samples yet. Tip: record 3‚Äì6 points (e.g., 2m, 5m, 10m).';
      list.textContent = '‚Äî';
      return;
    }

    const params = cp.rls.params();
    stats.innerHTML = `
      Samples: <b>${pts.length}</b> ¬∑ txPower: <b>${Math.round(params.txPower)}</b>dBm ¬∑ n: <b>${params.n.toFixed(2)}</b>
      <div style="margin-top:6px;color:var(--text-muted)">Pro calibration is stored when you press <b>Save</b>.</div>
    `;

    list.innerHTML = pts.slice().reverse().map(pt=>{
      const t = pt.t ? new Date(pt.t).toLocaleTimeString() : '';
      return `<div style="display:flex;justify-content:space-between;gap:10px">
        <span>${pt.dist}m</span>
        <span>${pt.rssi}dBm</span>
        <span style="opacity:.7">${t}</span>
      </div>`;
    }).join('');
  };

  /* Detail UI injection */
  V41UI.injectDetailCalibPro = function(pet){
    try{
      if(!pet) return;
      const body = document.getElementById('detail-body');
      if(!body) return;
      if(document.getElementById('v41-calibpro-detail')) return;

      try{ AIPackV4.attachPet(pet); }catch(_){}

      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'v41-calibpro-detail';
      card.innerHTML = `
        <div class="section-title">Calibration Pro (RLS)</div>
        <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
          Record distance samples while standing still. The model updates <b>txPower</b> & <b>n</b> immediately.
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <input id="v41-dcalib-dist" type="range" min="2" max="15" step="1" value="5" style="flex:1" />
          <span class="kbd" id="v41-dcalib-dist-label">5m</span>
          <button class="btn btn-sm btn-secondary" id="v41-dcalib-record">Record</button>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-sm btn-secondary" style="flex:1" id="v41-dcalib-clear">Reset</button>
          <button class="btn btn-sm btn-primary" style="flex:1" id="v41-dcalib-apply-leash">Apply to leash</button>
        </div>

        <div id="v41-dcalib-stats" style="margin-top:10px;font-size:.74rem;color:var(--text-secondary);line-height:1.45"></div>
        <div id="v41-dcalib-list" style="margin-top:8px;font-size:.72rem;color:var(--text-muted);max-height:90px;overflow:auto;border:1px solid var(--border-color);border-radius:10px;padding:8px;background:var(--bg-elevated)"></div>
      `;

      // insert close to leash section if possible
      const anchor = Array.from(body.querySelectorAll('.card')).find(c => c.innerText.includes('Leash Presets')) || null;
      if(anchor && anchor.nextSibling) body.insertBefore(card, anchor.nextSibling);
      else body.appendChild(card);

      const slider = card.querySelector('#v41-dcalib-dist');
      const label = card.querySelector('#v41-dcalib-dist-label');
      slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });

      const getRssi = ()=>{
        const arr = (pet.rssiRing && Array.isArray(pet.rssiRing.data)) ? pet.rssiRing.data.filter(v=>Number.isFinite(v)) : [];
        if(arr.length === 0) return pet.smoothedRssi;
        const tail = arr.slice(-8);
        tail.sort((a,b)=>a-b);
        const mid = Math.floor(tail.length/2);
        return tail.length%2 ? tail[mid] : Math.round((tail[mid-1]+tail[mid])/2);
      };

      const render = ()=>{
        const stats = card.querySelector('#v41-dcalib-stats');
        const list = card.querySelector('#v41-dcalib-list');

        const rls = pet.ai4?.rls;
        const pts = (pet.distance?.calibPoints || []).filter(pt => pt && pt.pro);
        if(!rls){
          stats.textContent = 'RLS calibrator not ready yet.';
          list.textContent = '‚Äî';
          return;
        }
        const params = rls.params();
        stats.innerHTML = `
          Samples: <b>${pts.length}</b> ¬∑ txPower: <b>${Math.round(params.txPower)}</b>dBm ¬∑ n: <b>${params.n.toFixed(2)}</b>
          <div style="margin-top:6px;color:var(--text-muted)">Tip: record 3‚Äì6 points (2m, 5m, 10m). Then set leash distance slider.</div>
        `;
        list.innerHTML = (pts.slice().reverse().slice(0,12).map(pt=>{
          const t = pt.t ? new Date(pt.t).toLocaleTimeString() : '';
          return `<div style="display:flex;justify-content:space-between;gap:10px">
            <span>${pt.dist}m</span><span>${pt.rssi}dBm</span><span style="opacity:.7">${t}</span>
          </div>`;
        }).join('')) || '‚Äî';
      };

      card.querySelector('#v41-dcalib-record').addEventListener('click', ()=>{
        const rssi = getRssi();
        if(!Number.isFinite(rssi)){
          Toast.show('RSSI not ready. Start monitoring first.', 2200);
          return;
        }
        const d = Number(slider.value);
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(!pet.ai4?.rls){
          Toast.show('RLS calibrator not ready.', 2000);
          return;
        }
        pet.ai4.rls.update(d, rssi);
        pet.aiToggles = pet.aiToggles || {};
        pet.aiToggles.rls = true;

        pet.aiState = pet.aiState || {};
        pet.aiState.rls = pet.ai4.rls.export();

        const params = pet.ai4.rls.params();
        pet.distance.txPower = params.txPower;
        pet.distance.n = params.n;

        pet.distance.calibPoints = Array.isArray(pet.distance.calibPoints) ? pet.distance.calibPoints : [];
        pet.distance.calibPoints.push({dist:d, rssi:rssi, pro:true, t: nowMs()});

        Store.savePet(pet);
        Toast.show(`Saved: ${d}m @ ${rssi}dBm`, 1600);

        render();
      });

      card.querySelector('#v41-dcalib-clear').addEventListener('click', ()=>{
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(pet.ai4?.rls){
          pet.ai4.rls.reset();
          pet.aiState = pet.aiState || {};
          pet.aiState.rls = pet.ai4.rls.export();
        }
        if(pet.distance?.calibPoints) pet.distance.calibPoints = pet.distance.calibPoints.filter(pt => !pt.pro);
        Store.savePet(pet);
        Toast.show('Calibration Pro reset.', 1600);
        render();
      });

      card.querySelector('#v41-dcalib-apply-leash').addEventListener('click', ()=>{
        const m = pet.leashDistanceM || 10;
        V41UI.applyMetersLeash(pet, m);
        render();
      });

      render();
    }catch(e){
      console.warn('injectDetailCalibPro failed:', e);
    }
  };
})();

/* -------- Per-pet alerts UI in Detail -------- */
V41UI.injectDetailAlertPrefs = function(pet){
  try{
    if(!pet) return;
    const body = document.getElementById('detail-body');
    if(!body) return;
    if(document.getElementById('v41-alertprefs-detail')) return;

    v41EnsureAlertPrefs(pet);
    const prefs = pet.alertPrefs;

    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'v41-alertprefs-detail';
    card.innerHTML = `
      <div class="section-title">Alerts (per pet)</div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Alarm sound</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Works only when global <b>Sound</b> is enabled.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-sound" ${prefs.sound ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Vibrate</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Uses global Vibrate setting as master switch.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-vibrate" ${prefs.vibrate ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Voice</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Uses global Voice/TTS as master switch.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-tts" ${prefs.tts ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row" style="align-items:flex-start">
        <div>
          <div style="font-weight:700">Alert starts at</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">
            Recommended: <b>WARNING</b> for ‚Äúout of range‚Äù. Use CAUTION if you want early beeps.
          </div>
        </div>
        <select id="v41-ap-minzone" class="input" style="max-width:160px">
          <option value="CAUTION">CAUTION</option>
          <option value="WARNING">WARNING</option>
          <option value="DANGER">DANGER</option>
          <option value="LOST">LOST</option>
        </select>
      </div>
    `;

    const anchor = Array.from(body.querySelectorAll('.card')).find(c => c.innerText.includes('Leash Presets')) || null;
    if(anchor && anchor.nextSibling) body.insertBefore(card, anchor.nextSibling);
    else body.appendChild(card);

    const sel = card.querySelector('#v41-ap-minzone');
    sel.value = prefs.minZone || 'WARNING';

    const save = ()=>{
      Store.savePet(pet);
      Toast.show('Alert settings saved.', 1200);
    };

    card.querySelector('#v41-ap-sound').addEventListener('change', (e)=>{ pet.alertPrefs.sound = e.target.checked; save(); });
    card.querySelector('#v41-ap-vibrate').addEventListener('change', (e)=>{ pet.alertPrefs.vibrate = e.target.checked; save(); });
    card.querySelector('#v41-ap-tts').addEventListener('change', (e)=>{ pet.alertPrefs.tts = e.target.checked; save(); });
    sel.addEventListener('change', (e)=>{ pet.alertPrefs.minZone = e.target.value; save(); });
  }catch(e){
    console.warn('injectDetailAlertPrefs failed:', e);
  }
};

/* -------- Rescue Pack (share/import) for SOS panel -------- */
(function(){
  function b64urlEncodeUtf8(str){
    const u8 = new TextEncoder().encode(str);
    let bin = '';
    const chunk = 0x8000;
    for(let i=0;i<u8.length;i+=chunk){
      bin += String.fromCharCode(...u8.subarray(i, i+chunk));
    }
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  function b64urlDecodeUtf8(b64){
    let s = b64.replace(/-/g,'+').replace(/_/g,'/');
    const pad = s.length % 4;
    if(pad) s += '='.repeat(4-pad);
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(u8);
  }

  // Small CRC32 for paste/typing integrity
  const CRC32_TABLE = (function(){
    const table = new Uint32Array(256);
    for(let i=0;i<256;i++){
      let c = i;
      for(let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
      table[i] = c >>> 0;
    }
    return table;
  })();

  function crc32(str){
    const u8 = new TextEncoder().encode(str);
    let c = 0xFFFFFFFF;
    for(const b of u8){
      c = CRC32_TABLE[(c ^ b) & 0xFF] ^ (c >>> 8);
    }
    return (c ^ 0xFFFFFFFF) >>> 0;
  }

  function crcHex(u32){ return u32.toString(16).padStart(8,'0'); }

  SOS.buildRescuePack = function(pet){
    if(!pet) return null;

    const sig = pet.signature || {};
    const pack = {
      v: 1,
      t: nowMs(),
      e: nowMs() + (72 * 60 * 60 * 1000), // expires in 72h
      p: {
        n: pet.name,
        i: pet.icon,
        r: pet.rescueId
      },
      s: {
        ne: sig.nameExact || null,
        np: sig.namePrefix || null,
        mi: sig.manufacturerId || null,
        mf: sig.manufacturerDataPrefixHex || null,
        sv: Array.isArray(sig.serviceUuids) ? sig.serviceUuids.slice(0,6) : [],
        ap: (sig.appearance ?? null)
      }
    };

    // optional: include last saved location (if any)
    if(SOS.savedLocation && SOS.savedLocation.lat && SOS.savedLocation.lon){
      pack.l = { la: SOS.savedLocation.lat, lo: SOS.savedLocation.lon, ts: SOS.savedLocation.ts || nowMs() };
    }
    return pack;
  };

  SOS.encodeRescuePack = function(pack){
    const json = safeJson(pack);
    const crc = crcHex(crc32(json));
    return `VG-RP1.${b64urlEncodeUtf8(json)}.${crc}`;
  };

  SOS.decodeRescuePack = function(code){
    if(!code || typeof code !== 'string') throw new Error('Empty code');
    const txt = code.trim();
    if(!txt.startsWith('VG-RP1.')) throw new Error('Not a Rescue Pack (VG-RP1)');
    const parts = txt.split('.');
    if(parts.length < 3) throw new Error('Invalid code format');
    const b64 = parts[1];
    const crc = (parts[2] || '').toLowerCase();
    const json = b64urlDecodeUtf8(b64);
    const want = crcHex(crc32(json));
    if(crc && crc !== want) throw new Error('Checksum mismatch (code may be corrupted)');
    const pack = safeParseJson(json);
    if(!pack || pack.v !== 1) throw new Error('Unsupported pack version');
    return pack;
  };

  SOS._assist = { active:false, pet:null, pack:null, lastMatch:0 };

  SOS.startRescueAssist = function(code){
    try{
      const pack = SOS.decodeRescuePack(code);
      const sig = pack.s || {};
      const signature = {
        deviceId: null,
        nameExact: sig.ne || null,
        namePrefix: sig.np || null,
        manufacturerDataPrefixHex: sig.mf || null,
        manufacturerId: sig.mi || null,
        serviceUuids: sig.sv || [],
        appearance: (sig.ap ?? null)
      };

      const pet = new Pet({
        name: (pack.p?.n || 'Rescue Target'),
        icon: (pack.p?.i || 'üêæ'),
        rescueId: (pack.p?.r || 'UNKNOWN'),
        signature
      });
      pet.disabled = false; // it is not in App.pets; but keep consistent
      v41EnsureAlertPrefs(pet);
      pet.alertPrefs.sound = false; // helpers: silent by default (use HOT/COLD UI)
      pet.alertPrefs.vibrate = true;
      pet.alertPrefs.tts = false;
      pet.alertPrefs.minZone = 'WARNING';

      SOS._assist = { active:true, pet, pack, lastMatch:0 };
      Toast.show('Rescue Assist started. Keep monitoring on and walk around.', 2600);

      // Restart scan so filters include assist prefix when possible
      try{
        if(BLE.scanning){
          BLE.stopScan();
          setTimeout(()=>BLE.startScan('track', {silent:true}), 250);
        }else{
          BLE.startScan('track', {silent:false});
        }
      }catch(_){}

      V41UI.renderRescueAssist();
    }catch(e){
      Toast.show(`Import failed: ${e.message}`, 2600);
    }
  };

  SOS.stopRescueAssist = function(){
    SOS._assist = { active:false, pet:null, pack:null, lastMatch:0 };
    Toast.show('Rescue Assist stopped.', 1600);
    V41UI.renderRescueAssist();
  };

  SOS._handleAssistAdv = function(ev){
    try{
      if(!SOS._assist.active || !SOS._assist.pet) return;
      const s = matchScore(ev, SOS._assist.pet.signature);
      if(s < 0.48) return;

      SOS._assist.lastMatch = nowMs();
      SOS._assist.pet.processRssi(ev.rssi, nowMs());
    }catch(e){}
  };

  // Patch App.onAdvertisement to also update Rescue Assist
  const _origOnAdv = App.onAdvertisement.bind(App);
  App.onAdvertisement = function(ev){
    _origOnAdv(ev);
    SOS._handleAssistAdv(ev);
    V41UI.renderRescueAssistMini(); // lightweight
  };

  // Patch BLE filter builder to include assist namePrefix (if present)
  const _origBuild = BLE._buildTrackFilters.bind(BLE);
  BLE._buildTrackFilters = function(){
    const filters = _origBuild();
    try{
      if(!Settings.prefs.useScanFilters) return null;
      const ap = SOS._assist?.active && SOS._assist.pet?.signature?.namePrefix ? SOS._assist.pet.signature.namePrefix : null;
      if(!ap || ap.length < 2) return filters;
      const f = Array.isArray(filters) ? filters.slice() : (filters ? [filters] : []);
      if(!f.some(x=>x.namePrefix === ap)){
        f.push({namePrefix: ap});
      }
      return f.length ? f.slice(0,5) : null;
    }catch(e){
      return filters;
    }
  };

  V41UI.injectSOSRescuePack = function(){
    const panel = document.getElementById('panel-sos');
    if(!panel) return;
    if(document.getElementById('v41-rescuepack-card')) return;

    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'v41-rescuepack-card';
    card.innerHTML = `
      <div class="section-title">Rescue Pack (code / QR)</div>
      <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
        Share this to helpers. They can import it to scan for your tag signature on their device.
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-sm btn-secondary" id="v41-rp-generate" style="flex:1;min-width:150px">Generate for selected pet</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-share" style="flex:1;min-width:120px">Share</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-copy" style="flex:1;min-width:120px">Copy</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-sms" style="flex:1;min-width:120px">SMS</button>
      </div>

      <textarea id="v41-rp-code" class="input" style="margin-top:10px;height:88px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:.72rem" placeholder="Rescue Pack code appears here..."></textarea>

      <div style="display:flex;gap:12px;align-items:flex-start;margin-top:10px">
        <canvas id="v41-rp-qr" width="220" height="220" style="border:1px solid var(--border-color);border-radius:12px;background:#fff"></canvas>
        <div style="flex:1">
          <div class="section-title" style="margin-top:0">Import to help others</div>
          <div style="font-size:.74rem;color:var(--text-muted);line-height:1.45;margin:-4px 0 8px 0">
            Paste a Rescue Pack code and start <b>Rescue Assist</b>.
          </div>
          <textarea id="v41-rp-import" class="input" style="height:74px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:.72rem" placeholder="Paste code..."></textarea>
          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-sm btn-primary" id="v41-rp-start" style="flex:1">Start Assist</button>
            <button class="btn btn-sm btn-secondary" id="v41-rp-stop" style="flex:1">Stop</button>
          </div>
        </div>
      </div>

      <div id="v41-rp-assist" class="highlight-box" style="margin-top:12px;display:none"></div>
    `;

    // Insert right after the first SOS card (Rescue Broadcast)
    const cards = panel.querySelectorAll('.card');
    if(cards && cards.length > 0) panel.insertBefore(card, cards[1] || null);
    else panel.appendChild(card);

    const codeEl = card.querySelector('#v41-rp-code');
    const qrCanvas = card.querySelector('#v41-rp-qr');

    const generate = ()=>{
      const pet = SOS.selectedPet();
      if(!pet){
        Toast.show('No pet selected.', 2000);
        return;
      }
      const pack = SOS.buildRescuePack(pet);
      const code = SOS.encodeRescuePack(pack);
      codeEl.value = code;
      QRGenerator.generate(code, qrCanvas, 220, {ecc:'M', border:4});
      Toast.show('Rescue Pack generated.', 1400);
    };

    card.querySelector('#v41-rp-generate').addEventListener('click', generate);

    card.querySelector('#v41-rp-copy').addEventListener('click', async ()=>{
      try{
        if(!codeEl.value.trim()){ generate(); }
        await navigator.clipboard.writeText(codeEl.value.trim());
        Toast.show('Copied.', 1200);
      }catch(e){
        Toast.show('Copy failed (clipboard permission).', 2200);
      }
    });

    card.querySelector('#v41-rp-share').addEventListener('click', async ()=>{
      try{
        if(!codeEl.value.trim()){ generate(); }
        const text = codeEl.value.trim();
        if(navigator.share){
          await navigator.share({ title:'VitalGuard AI Rescue Pack', text });
        }else{
          await navigator.clipboard.writeText(text);
          Toast.show('Share not supported. Copied to clipboard.', 2400);
        }
      }catch(e){
        Toast.show('Share cancelled.', 1500);
      }
    });

    card.querySelector('#v41-rp-start').addEventListener('click', ()=>{
      const txt = card.querySelector('#v41-rp-import').value.trim();
      if(!txt){ Toast.show('Paste a code first.', 2000); return; }
      SOS.startRescueAssist(txt);
      V41UI.renderRescueAssist();
    });

    card.querySelector('#v41-rp-stop').addEventListener('click', ()=>{
      SOS.stopRescueAssist();
      V41UI.renderRescueAssist();
    });

    // draw placeholder
    try{
      const ctx = qrCanvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,qrCanvas.width, qrCanvas.height);
      ctx.fillStyle = '#999'; ctx.font = '12px system-ui'; ctx.fillText('QR', 10, 20);
    }catch(_){}
  };

  V41UI.renderRescueAssist = function(){
    const box = document.getElementById('v41-rp-assist');
    if(!box) return;

    if(!SOS._assist.active || !SOS._assist.pet){
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }
    box.style.display = 'block';
    const pet = SOS._assist.pet;
    const age = pet.lastSeenMs ? Math.round((nowMs() - pet.lastSeenMs)/1000) : null;
    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:900">${pet.icon} ${pet.name} <span class="badge">${pet.zone?.stable || '‚Äî'}</span></div>
          <div style="font-size:.74rem;color:var(--text-muted);line-height:1.4">
            Rescue ID: <b>${pet.rescueId}</b> ¬∑ last seen: <b>${age===null?'‚Äî':age+'s'}</b> ago
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:.78rem">RSSI: <b>${Number.isFinite(pet.smoothedRssi)? Math.round(pet.smoothedRssi):'‚Äî'}</b>dBm</div>
          <div style="font-size:.78rem">Distance: <b>${Number.isFinite(pet.estimatedDistanceM)? pet.estimatedDistanceM.toFixed(1):'‚Äî'}</b>m</div>
        </div>
      </div>
    `;
  };

  // lightweight periodic update without DOM churn
  V41UI._lastAssistPaint = 0;
  V41UI.renderRescueAssistMini = function(){
    const now = nowMs();
    if(now - V41UI._lastAssistPaint < 600) return;
    V41UI._lastAssistPaint = now;
    V41UI.renderRescueAssist();
  };
})();

/* -------- Patch Detail.render to inject v4.1 UI blocks -------- */
(function(){
  const _origDetailRender = Detail.render.bind(Detail);
  Detail.render = function(p){
    _origDetailRender(p);
    V41UI.injectDetailMetersLeash(p);
    V41UI.injectDetailAlertPrefs(p);
    V41UI.injectDetailCalibPro(p);
  };
})();

/* -------- Patch V40UI.inject to include v4.1 injections -------- */
(function(){
  const _origInject = V40UI.inject.bind(V40UI);
  V40UI.inject = function(){
    _origInject();
    V41UI.injectWizardCalibPro();
    V41UI.injectSOSRescuePack();
  };
})();

/* -------- Diagnostics: implement missing Run Self-Test button -------- */
(function(){
  if(typeof Diag.runQuickTest === 'function') return;
  Diag._lastSelfTest = null;

  const _origSnapshot = Diag.snapshot.bind(Diag);
  Diag.snapshot = function(){
    const snap = _origSnapshot();
    if(Diag._lastSelfTest) snap.selfTest = Diag._lastSelfTest;
    return snap;
  };

  Diag.runQuickTest = function(){
    const results = [];
    const t0 = performance.now();

    // 1) QR generator
    try{
      const qr = qrcodegen.QrCode.encodeText('VG-SELFTEST', qrcodegen.QrCode.Ecc.MEDIUM);
      results.push({test:'QR', ok:true, detail:`version ${qr.version} size ${qr.size}`});
    }catch(e){
      results.push({test:'QR', ok:false, detail:String(e)});
    }

    // 2) RLS calibrator sanity
    try{
      const rls = new RLSCalibrator();
      // synthetic: tx=-59, n=2.2
      const tx = -59, n = 2.2;
      const dists = [2,3,5,8,10,12];
      dists.forEach(d=>{
        const rssi = tx - 10*n*Math.log10(d);
        rls.update(d, rssi);
      });
      card.querySelector('#v41-rp-sms').addEventListener('click', ()=>{
        try{
          if(!codeEl.value.trim()){ generate(); }
          const text = encodeURIComponent(codeEl.value.trim());
          // NOTE: SMS URL schemes vary by platform; this works on most mobile browsers.
          window.location.href = `sms:?&body=${text}`;
        }catch(e){
          Toast.show('SMS not supported on this device.', 2400);
        }
      });

      const p = rls.params();
      const ok = Math.abs(p.txPower - tx) < 6 && Math.abs(p.n - n) < 0.8;
      results.push({test:'RLS', ok, detail:`tx ${p.txPower.toFixed(1)} n ${p.n.toFixed(2)}`});
    }catch(e){
      results.push({test:'RLS', ok:false, detail:String(e)});
    }

    // 3) Rescue Pack encode/decode sanity (if pet exists)
    try{
      const pet = App.pets && App.pets[0] ? App.pets[0] : null;
      if(pet && SOS.buildRescuePack){
        const code = SOS.encodeRescuePack(SOS.buildRescuePack(pet));
        const pack = SOS.decodeRescuePack(code);
        const ok = pack && pack.p && pack.p.r === pet.rescueId;
        results.push({test:'RescuePack', ok, detail: ok ? 'encode/decode ok' : 'mismatch'});
      }else{
        results.push({test:'RescuePack', ok:true, detail:'skipped (no pets)'});
      }
    }catch(e){
      results.push({test:'RescuePack', ok:false, detail:String(e)});
    }

    // 4) Performance micro-bench (10 pets √ó 200 adv)
    try{
      const pets = [];
      for(let i=0;i<10;i++){
        const p = new Pet({name:'T'+i, icon:'üêæ', signature:{namePrefix:'TAG'+i}});
        pets.push(p);
      }
      // fake advertisement event (name matches only one)
      const fakeEv = { device:{id:'x'}, name:'TAG3_ABC', manufacturerData:null, serviceData:null, uuids:[] };
      const t1 = performance.now();
      for(let k=0;k<200;k++){
        pets.forEach(p=>matchScore(fakeEv, p.signature));
      }
      const ms = performance.now() - t1;
      results.push({test:'Perf', ok: ms < 40, detail:`matchScore loop ~${ms.toFixed(1)}ms`});
    }catch(e){
      results.push({test:'Perf', ok:false, detail:String(e)});
    }

    const dt = performance.now() - t0;
    const okAll = results.every(r=>r.ok);

    Diag._lastSelfTest = { time: new Date().toISOString(), ok: okAll, dtMs: Math.round(dt), results };
    console.log('[VitalGuardAI SelfTest]', Diag._lastSelfTest);

    Toast.show(okAll ? `Self-Test OK (${Math.round(dt)}ms)` : `Self-Test found issues (see Diagnostics)`, 2600);

    try{
      // refresh diag view if open
      if(document.getElementById('diag-overlay')?.classList.contains('active')){
        Diag.open();
      }
    }catch(_){}
  };
})();



/* -------- Persist & restore v4.1 per-pet fields (alertPrefs / leashDistanceM / disabled / lostEvents) -------- */
(function(){
  // 1) Persist extra fields
  const _toJSON = Pet.prototype.toJSON;
  Pet.prototype.toJSON = function(){
    const base = _toJSON.call(this);
    try{
      base.alertPrefs = this.alertPrefs;
      base.leashDistanceM = this.leashDistanceM;
      base.disabled = !!this.disabled;
      base.lostEvents = Array.isArray(this.lostEvents) ? this.lostEvents : [];
    }catch(_){}
    return base;
  };

  // 2) Restore extra fields after App.init loads pets
  const _origInit = App.init.bind(App);
  App.init = async function(){
    await _origInit();
    try{
      const raws = await Store.getAllPets();
      const byId = new Map(raws.map(r => [r.id, r]));

      let activeCount = 0;
      let autoDisabled = 0;
      let changed = 0;

      for(const p of this.pets){
        const r = byId.get(p.id);
        if(r){
          if(r.alertPrefs) p.alertPrefs = r.alertPrefs;
          if(Number.isFinite(r.leashDistanceM)) p.leashDistanceM = r.leashDistanceM;
          if(r.disabled !== undefined) p.disabled = !!r.disabled;
          if(Array.isArray(r.lostEvents)) p.lostEvents = r.lostEvents;
        }

        v41EnsureAlertPrefs(p);

        if(!p.leashDistanceM){
          const m = (p.leashPreset && /^\d+m$/.test(p.leashPreset)) ? parseInt(p.leashPreset,10) : null;
          if(m){ p.leashDistanceM = m; changed++; }
        }

        if(!p.disabled){
          activeCount++;
          if(activeCount > V41_MAX_ACTIVE_PETS){
            p.disabled = true;
            autoDisabled++;
            changed++;
          }
        }
      }

      if(autoDisabled > 0){
        Toast.show(`Stability: ${autoDisabled} pets auto-disabled (over ${V41_MAX_ACTIVE_PETS} active).`, 4200);
      }

      // Persist changes only if needed
      if(changed > 0){
        for(const p of this.pets){
          Store.savePet(p);
        }
      }

      this.render();
    }catch(e){
      console.warn('v4.1 init migrate failed:', e);
    }
  };
})();


/* ----------------------------- FINAL: boot once ----------------------------- */
  // Ensure injection is ready even if Settings tab opened before init
  try{ V40UI.inject(); }catch(e){}

})();


/* ----------------------------- GLOBAL EVENT HOOKS ----------------------------- */
// Prime audio on first user gesture (helps autoplay restrictions)
document.addEventListener('pointerdown', async ()=>{
  await AudioEngine.ensure();
}, {once:true});

/* ----------------------------- INIT ----------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  try{ I18N.init(); }catch(e){ console.warn('I18N init:', e); }
  App.init();
});

</script>
</body>
</html>
