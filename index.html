<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#c0392b">
<title>Santa Claus AI v3.9 ‚Äî Offline Pet Safety</title>
<link rel="manifest" id="pwa-manifest">
<style>
/* ============================================================
   SANTA CLAUS AI v3.9 ‚Äî MASTER STYLESHEET
   ¬© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI
   https://mcorpai.org | contact@mcorpai.org
   Managed by: https://mediatorsfoundation.org
   M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
   Humanitarian use only. Military/surveillance use prohibited.
   Zero External Dependencies | 100% Offline | Vanilla CSS/JS
   ============================================================ */
:root{--bg-primary:#0d1117;--bg-secondary:#161b22;--bg-card:#1c2333;--bg-elevated:#21283b;--text-primary:#e6edf3;--text-secondary:#8b949e;--text-muted:#6e7681;--accent-red:#c0392b;--accent-green:#2ecc71;--accent-yellow:#f1c40f;--accent-orange:#e67e22;--accent-blue:#3498db;--zone-safe:#2ecc71;--zone-caution:#f1c40f;--zone-warning:#e67e22;--zone-danger:#e74c3c;--zone-lost:#9b59b6;--border-color:#30363d;--radius-sm:8px;--radius-md:12px;--radius-lg:20px;--shadow-soft:0 2px 12px rgba(0,0,0,.3);--tr-fast:.15s ease;--tr-norm:.3s ease;--font-body:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;--font-mono:'Courier New',Courier,monospace}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;user-select:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg-primary)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
#app{max-width:480px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:72px}
.header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:14px 20px 10px;text-align:center;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:100}
.header-logo{font-size:2rem}.header-title{font-family:'Georgia',serif;font-size:1.4rem;color:var(--accent-red);letter-spacing:1px;text-shadow:0 0 20px rgba(192,57,43,.4)}
.header-sub{font-size:.68rem;color:var(--text-muted);margin-top:2px}
.header-mission{font-size:.62rem;color:var(--accent-blue);margin-top:3px;font-style:italic;opacity:.85;line-height:1.3}
.header-disclaimer{font-size:.58rem;color:var(--accent-orange);margin-top:3px;line-height:1.3;opacity:.9}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;z-index:100;max-width:480px;margin:0 auto}
.bnav-btn{flex:1;padding:8px 4px 6px;text-align:center;cursor:pointer;border:none;background:none;color:var(--text-muted);font-size:.63rem;font-family:var(--font-body);display:flex;flex-direction:column;align-items:center;gap:2px;transition:color var(--tr-fast)}
.bnav-btn .bnav-icon{font-size:1.3rem}.bnav-btn.active{color:var(--accent-red)}.bnav-btn:active{opacity:.7}
.panel{display:none;padding:16px;animation:fadeIn .25s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-color);padding:14px;margin-bottom:10px}
.pet-card{display:flex;align-items:center;gap:12px;padding:14px;margin-bottom:10px;background:var(--bg-card);border-radius:var(--radius-md);border:2px solid var(--border-color);transition:all var(--tr-norm);cursor:pointer;position:relative}
.pet-card:active{transform:scale(.98)}
.pet-card.zone-safe{border-color:rgba(46,204,113,.4)}.pet-card.zone-caution{border-color:rgba(241,196,15,.5)}.pet-card.zone-warning{border-color:rgba(230,126,34,.6)}.pet-card.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 15px rgba(231,76,60,.25);animation:pulseDanger 1.2s ease infinite}.pet-card.zone-lost{border-color:var(--zone-lost);opacity:.85}
@keyframes pulseDanger{0%,100%{box-shadow:0 0 15px rgba(231,76,60,.25)}50%{box-shadow:0 0 25px rgba(231,76,60,.45)}}
.pet-icon-circle{width:48px;height:48px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0}
.pet-details{flex:1;min-width:0}.pet-name{font-weight:700;font-size:.95rem;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pet-status-row{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text-secondary)}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pet-signal{text-align:right;flex-shrink:0}.pet-rssi{font-size:.9rem;font-weight:600;font-family:var(--font-mono);line-height:1}
.trend-arrow{font-size:.7rem;margin-left:2px}
.zone-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.6rem;font-weight:700;letter-spacing:.5px;margin-top:3px;color:#000}
.zone-badge.safe{background:var(--zone-safe)}.zone-badge.caution{background:var(--zone-caution)}.zone-badge.warning{background:var(--zone-warning)}.zone-badge.danger{background:var(--zone-danger);color:#fff}.zone-badge.lost{background:var(--zone-lost);color:#fff}
.pet-conf{font-size:.6rem;color:var(--text-muted);margin-top:2px}
.pet-why{font-size:.58rem;color:var(--accent-orange);margin-top:1px;font-style:italic}
.section-title{font-size:.85rem;font-weight:700;margin-bottom:10px;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.btn{padding:10px 18px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:var(--font-body);font-size:.85rem;font-weight:600;transition:all var(--tr-fast);text-align:center}
.btn:active{transform:scale(.96)}.btn-primary{background:var(--accent-red);color:#fff}.btn-success{background:var(--accent-green);color:#000}
.btn-secondary{background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-danger-outline{background:transparent;color:var(--zone-danger);border:1px solid var(--zone-danger);font-size:.75rem;padding:6px 12px}
.btn-sm{font-size:.75rem;padding:6px 12px}.btn-block{width:100%}
.btn-add{background:linear-gradient(135deg,var(--accent-red),#e74c3c);color:#fff;font-size:1rem;padding:14px;border-radius:var(--radius-md);width:100%;margin-top:8px;box-shadow:var(--shadow-soft)}
.hidden{display:none!important}
.text-center{text-align:center}.text-muted{color:var(--text-muted)}
.divider{height:1px;background:var(--border-color);margin:16px 0}
.empty-state{text-align:center;padding:40px 20px}.empty-icon{font-size:3.5rem;margin-bottom:12px}.empty-text{color:var(--text-secondary);font-size:.9rem;line-height:1.5}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);color:var(--text-primary);padding:10px 20px;border-radius:var(--radius-lg);font-size:.82rem;z-index:9999;border:1px solid var(--border-color);box-shadow:var(--shadow-soft);white-space:nowrap;max-width:90%}
/* OVERLAY */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:200;overflow-y:auto;padding:0}
.overlay.active{display:block}.overlay-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border-color);position:sticky;top:0;background:var(--bg-primary);z-index:10}
.overlay-title{font-weight:700;font-size:1.05rem}.overlay-close{background:none;border:none;color:var(--text-primary);font-size:1.4rem;cursor:pointer;padding:4px 8px}
.overlay-body{padding:16px 20px 80px}
/* WIZARD */
.wizard-step{display:none}.wizard-step.active{display:block}
.step-pills{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
.step-pill{width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);color:var(--text-muted);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;border:2px solid var(--border-color)}
.step-pill.current{border-color:var(--accent-red);color:var(--accent-red)}.step-pill.done{background:var(--accent-green);color:#000;border-color:var(--accent-green)}
.scan-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;border:2px solid transparent;cursor:pointer;transition:all var(--tr-fast)}
.scan-item.selected{border-color:var(--accent-green);background:rgba(46,204,113,.08)}
.scan-item-name{font-weight:600;font-size:.85rem}.scan-item-id{font-size:.65rem;color:var(--text-muted);font-family:var(--font-mono)}
.tag-score{font-size:.65rem;color:var(--accent-blue);margin-top:2px}
.scan-item-right{text-align:right}.scan-rssi{font-size:.85rem;font-weight:600;font-family:var(--font-mono)}
.rssi-bar-track{width:60px;height:4px;background:var(--bg-primary);border-radius:2px;margin-top:4px}
.rssi-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.icon-picker{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
.icon-opt{width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border-radius:var(--radius-sm);background:var(--bg-elevated);border:2px solid transparent;cursor:pointer}
.icon-opt.selected{border-color:var(--accent-green);background:rgba(46,204,113,.1)}
/* SOS */
.sos-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;flex-direction:column;align-items:center;justify-content:center;background:#000}
.sos-active.active{display:flex}
.sos-active-text{font-size:2rem;font-weight:900;color:#fff;text-align:center;padding:20px;letter-spacing:2px}
.hc-display{text-align:center;padding:20px;background:var(--bg-card);border-radius:var(--radius-md);margin:10px 0}
.hc-arrow{font-size:3rem;display:block;margin-bottom:8px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color)}
.toggle{width:44px;height:24px;border-radius:12px;background:var(--bg-elevated);border:1px solid var(--border-color);position:relative;cursor:pointer;transition:all var(--tr-fast);flex-shrink:0}
.toggle::after{content:'';width:20px;height:20px;border-radius:50%;background:var(--text-muted);position:absolute;top:1px;left:1px;transition:all var(--tr-fast)}
.toggle.on{background:var(--accent-green);border-color:var(--accent-green)}.toggle.on::after{left:22px;background:#fff}
/* TIP CARDS */
.tip-card{padding:14px;border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--accent-blue);background:var(--bg-card)}
.tip-card.warn{border-left-color:var(--accent-orange)}.tip-card.danger{border-left-color:var(--zone-danger)}
.tip-card.info{border-left-color:var(--accent-blue)}
.tip-title{font-weight:700;font-size:.85rem;margin-bottom:4px}.tip-body{font-size:.78rem;color:var(--text-secondary);line-height:1.5}
/* PET DETAIL OVERLAY */
.detail-ring{width:160px;height:160px;border-radius:50%;border:6px solid var(--zone-safe);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:20px auto;transition:all .5s;position:relative}
.detail-ring.zone-safe{border-color:var(--zone-safe);box-shadow:0 0 30px rgba(46,204,113,.2)}.detail-ring.zone-caution{border-color:var(--zone-caution);box-shadow:0 0 30px rgba(241,196,15,.3)}.detail-ring.zone-warning{border-color:var(--zone-warning);box-shadow:0 0 30px rgba(230,126,34,.3)}.detail-ring.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 40px rgba(231,76,60,.4);animation:pulseDanger 1.2s ease infinite}.detail-ring.zone-lost{border-color:var(--zone-lost);box-shadow:0 0 30px rgba(155,89,182,.3)}
.detail-dist{font-size:2rem;font-weight:900;line-height:1}.detail-unit{font-size:.7rem;color:var(--text-muted)}.detail-zone{font-size:.75rem;font-weight:700;margin-top:4px}
.rssi-meter{height:8px;background:var(--bg-elevated);border-radius:4px;margin:8px 0;overflow:hidden}.rssi-meter-fill{height:100%;border-radius:4px;transition:width .4s,background .4s}
.signal-bars{display:flex;gap:3px;align-items:flex-end;justify-content:center;height:20px;margin:8px 0}
.signal-bars .bar{width:6px;border-radius:2px;background:var(--text-muted);transition:background .3s}
.alert-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:.75rem;border-bottom:1px solid rgba(48,54,61,.5)}
.alert-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:6px}
/* LEASH PRESETS */
.leash-row{display:flex;gap:6px;margin:8px 0}.leash-btn{flex:1;padding:8px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);cursor:pointer;font-size:.75rem;font-weight:600;transition:all var(--tr-fast)}
.leash-btn.active{border-color:var(--accent-green);color:var(--accent-green);background:rgba(46,204,113,.08)}
.slider-row{display:flex;align-items:center;gap:8px;margin:6px 0}
.slider-row label{font-size:.72rem;color:var(--text-secondary);min-width:55px}
.slider-row input[type=range]{flex:1;accent-color:var(--accent-blue)}
.slider-row .val{font-size:.72rem;color:var(--accent-blue);min-width:50px;text-align:right;font-family:var(--font-mono)}
/* CHARITY */
.charity-box{background:linear-gradient(135deg,rgba(46,204,113,.08),rgba(52,152,219,.08));border:1px solid rgba(46,204,113,.25);border-radius:var(--radius-md);padding:14px;margin:10px 0;text-align:center}
.charity-box p{font-size:.8rem;margin:4px 0}
.highlight-box{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:14px;margin:10px 0}
.highlight-box p{font-size:.8rem;margin:4px 0;line-height:1.5;color:var(--text-secondary)}
.warning-legal{background:rgba(231,76,60,.06);border:1px solid rgba(231,76,60,.2);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.warning-legal p{font-size:.78rem;margin:3px 0;color:var(--text-secondary)}
.perf-select{display:flex;gap:4px;margin:8px 0}.perf-opt{flex:1;padding:8px 4px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-muted);cursor:pointer;font-size:.68rem;font-weight:600}
.perf-opt.active{border-color:var(--accent-blue);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.rescue-card{background:linear-gradient(135deg,rgba(192,57,43,.08),rgba(231,76,60,.05));border:2px solid rgba(192,57,43,.3);border-radius:var(--radius-md);padding:16px;margin:10px 0;text-align:center}
.rescue-id{font-size:1.6rem;font-weight:900;font-family:var(--font-mono);letter-spacing:4px;color:var(--accent-red);margin:8px 0}
.collapsible-header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;cursor:pointer;border-bottom:1px solid var(--border-color)}
.collapsible-header .arrow{transition:transform .2s}.collapsible-header.open .arrow{transform:rotate(90deg)}
.collapsible-body{display:none;padding:12px 0}.collapsible-body.open{display:block}


/* ============================================================
   V3.9 UI & FEATURE ADDITIONS
   (Merged from V20 feature set + V35 engine hardening + V38 layout ideas)
   ============================================================ */
.header-links{margin-top:6px;font-size:.62rem;color:var(--text-muted);display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.header-link{color:var(--accent-blue);text-decoration:none;border-bottom:1px dotted rgba(52,152,219,.45);padding-bottom:1px}
.header-link:active{opacity:.7}
.header-link-sep{opacity:.45}

.install-banner{display:none;background:rgba(52,152,219,.12);border-bottom:1px solid rgba(52,152,219,.25);padding:10px 14px;font-size:.72rem}
.install-banner.active{display:flex;align-items:center;justify-content:space-between;gap:10px}
.install-banner .btn{padding:6px 10px;font-size:.7rem}

.file-warning{background:rgba(241,196,15,.08);border:1px solid rgba(241,196,15,.25);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.file-warning .title{font-weight:800;font-size:.78rem;color:var(--accent-yellow);margin-bottom:6px}
.file-warning .body{font-size:.72rem;color:var(--text-secondary);line-height:1.5}
.file-warning .actions{display:flex;gap:8px;margin-top:10px}

.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:.6rem;font-weight:800;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary)}
.badge.ok{border-color:rgba(46,204,113,.35);color:var(--accent-green)}
.badge.med{border-color:rgba(241,196,15,.35);color:var(--accent-yellow)}
.badge.high{border-color:rgba(231,76,60,.35);color:var(--zone-danger)}

.scan-health-row{display:flex;align-items:center;gap:8px;margin:8px 0}
.scan-health-label{font-size:.65rem;color:var(--text-muted);min-width:74px}
.scan-health-bar{flex:1;height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;border:1px solid rgba(48,54,61,.85)}
.scan-health-fill{height:100%;width:0%;background:var(--accent-green);transition:width .35s,background .35s}
.scan-health-meta{font-size:.62rem;color:var(--text-muted);min-width:86px;text-align:right;font-family:var(--font-mono)}

.pet-chips{display:flex;gap:6px;overflow-x:auto;padding:6px 2px 10px;margin-bottom:4px}
.pet-chip{flex:0 0 auto;padding:6px 10px;border-radius:999px;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap}
.pet-chip.active{border-color:rgba(52,152,219,.6);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.pet-chip:active{transform:scale(.98)}

.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:10px 0}
.qr-canvas{width:180px;height:180px;border-radius:12px;border:1px solid rgba(48,54,61,.8);background:#fff}

.voice-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.voice-row .btn{flex:1}
.slider-mini{width:100%;accent-color:var(--accent-blue)}

.emergency-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:400;background:#000;color:#fff;align-items:center;justify-content:center;flex-direction:column;padding:20px;text-align:center}
.emergency-active.active{display:flex}
.strobe-on{background:#fff!important;color:#000!important}
.emergency-big{font-size:2.1rem;font-weight:900;letter-spacing:1px}
.emergency-sub{font-size:.85rem;color:rgba(255,255,255,.85);line-height:1.4;margin-top:10px;max-width:520px}
.kbd{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-elevated);font-family:var(--font-mono);font-size:.68rem;color:var(--text-secondary)}
</style>
</head>
<body>

<div id="app">
  <!-- INSTALL BANNER (PWA) -->
  <div id="installBanner" class="install-banner">
    <div>
      <strong>Install Santa Claus AI</strong><br>
      <span style="color:var(--text-secondary)">Works better as an installed app (PWA) ‚Äî faster launch, more reliable background behavior.</span>
    </div>
    <div style="display:flex;gap:6px;flex-shrink:0">
      <button class="btn btn-sm btn-secondary" id="installDismiss">Not now</button>
      <button class="btn btn-sm btn-primary" id="installBtn">Install</button>
    </div>
  </div>

  <header class="header">
    <div class="header-logo">üéÖ</div>
    <div class="header-title">Santa Claus AI</div>
    <div class="header-sub">v3.9 ‚Äî Offline Pet Safety | M-Corp Ethical AI</div>
    <div class="header-mission">"The more people know about this AI, the more homeless people can become independent."</div>
    <div class="header-disclaimer">Bluetooth Invisible Leash ‚Äî NOT GPS. All data stays on your device.</div>
    <div class="header-links">
      <a class="header-link" href="https://github.com/mcorpai/santa-claus-ai" target="_blank" rel="noopener">GitHub Source</a>
      <span class="header-link-sep">¬∑</span>
      <a class="header-link" href="#" onclick="Help.open();return false;">Help</a>
      <span class="header-link-sep">¬∑</span>
      <a class="header-link" href="#" onclick="Legal.open();return false;">About & Legal</a>
    </div>
  </header>

  <!-- HOME -->
  <div id="panel-home" class="panel active">
    <div id="first-run-banner" class="file-warning hidden">
      <div class="title">‚ö† Important: Run via HTTPS / localhost for best BLE reliability</div>
      <div class="body">
        You are running from <span class="kbd" id="fr-proto">file://</span>. Some browsers restrict Bluetooth scanning, audio, and background behavior on local files.<br>
        <br>
        Recommended:
        <ul style="margin:8px 0 0 16px;line-height:1.5">
          <li>Use <span class="kbd">https://</span> hosting, or</li>
          <li>Use <span class="kbd">http://localhost</span> (local server), or</li>
          <li>Install as a PWA when available.</li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn btn-secondary btn-sm" onclick="App.dismissFirstRun()">Got it</button>
        <button class="btn btn-sm btn-secondary" onclick="Help.open()">Open Help</button>
      </div>
    </div>

    <div id="empty-state" class="empty-state">
      <div class="empty-icon">üêæ</div>
      <div class="empty-text">No pets registered yet.<br>Add your pet with a cheap BLE tag ($2‚Äì$5).</div>
      <button class="btn-add" onclick="Wizard.open()">+ Add New Pet</button>
    </div>

    <div id="dash-controls" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="section-title" style="margin-bottom:0">üêæ My Pets</div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm btn-secondary" id="btn-mode-all" onclick="App.setTrackMode('all')" style="font-size:.65rem">Track All</button>
          <button class="btn btn-sm btn-secondary" id="btn-mode-focus" onclick="App.setTrackMode('focus')" style="font-size:.65rem">Focus</button>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div id="scan-status-bar" style="font-size:.68rem;color:var(--text-muted);flex:1;min-width:0"></div>
        <span id="congestionBadge" class="badge ok">LOW</span>
      </div>

      <div id="scan-health-row" class="scan-health-row hidden">
        <div class="scan-health-label">Scan health</div>
        <div class="scan-health-bar"><div id="scan-health-fill" class="scan-health-fill"></div></div>
        <div id="scan-health-meta" class="scan-health-meta">--</div>
      </div>

      <div class="pet-chips hidden" id="pet-chips"></div>

      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" id="btn-scan-toggle" style="flex:1" onclick="App.toggleMonitoring()">‚ñ∂ Start Monitoring</button>
          <button class="btn btn-secondary" id="btn-demo-toggle" style="flex:1" onclick="App.toggleDemo()">üß™ Demo</button>
        </div>
        <div style="margin-top:10px;font-size:.7rem;color:var(--text-muted);line-height:1.5">
          Tip: Monitoring works best when the screen stays on. In emergencies, use SOS Finder or Emergency Mode.
        </div>
      </div>

      <div id="coach-card" class="card" style="display:none">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üß† Safety Coach</div>
        <div id="coach-body" style="font-size:.78rem;color:var(--text-secondary);line-height:1.55"></div>
      </div>
    </div>

    <div id="pet-list"></div>

    <div id="dash-controls2" class="hidden">
      <button class="btn-add" onclick="Wizard.open()">+ Add New Pet</button>
    </div>
  </div>

  <!-- SOS -->
  <div id="panel-sos" class="panel">
    <div id="sos-no-pets" class="text-center" style="padding:40px 0;color:var(--text-muted)">Add a pet first to use SOS Finder.</div>
    <div id="sos-content" class="hidden">
      <div class="section-title">üîç SOS Pet Finder</div>
      <div id="sos-pet-select"></div>

      <div class="hc-display">
        <div id="hc-arrow" class="hc-arrow">üîç</div>
        <div id="hc-text" style="font-size:.9rem;font-weight:600;margin-bottom:4px">Select a pet to begin</div>
        <div id="hc-rssi" style="font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">--</div>
      </div>

      <div id="sos-snapshot" class="card" style="font-size:.8rem;line-height:1.6"></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.saveLocation()">üìç Save Location</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.shareMessage()">üì§ Share Alert</button>
      </div>

      <div class="card" style="margin-top:12px;text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds for full pet alarm</div>
        <button class="btn btn-primary" style="font-size:1.1rem;padding:16px 30px;border-radius:50px"
          ontouchstart="SOS.holdStart()" ontouchend="SOS.holdEnd()"
          onmousedown="SOS.holdStart()" onmouseup="SOS.holdEnd()"
        >üö® SOS ALARM</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üõ° Personal Emergency Mode</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          For personal safety (siren + strobe + QR contact card). Works even without internet.
        </div>
        <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Open Emergency Mode</button>
      </div>

      <div id="sos-focus-banner" class="hidden" style="margin-top:10px;padding:10px;background:rgba(52,152,219,.1);border:1px solid rgba(52,152,219,.3);border-radius:var(--radius-sm);font-size:.72rem;color:var(--accent-blue);text-align:center">
        üéØ Focus Mode ON ‚Äî tracking only selected pet for best accuracy
      </div>
    </div>
  </div>

  <!-- TIPS -->
  <div id="panel-tips" class="panel">
    <div class="section-title">üìã Must-Read Safety Tips</div>

    <div class="tip-card danger"><div class="tip-title">üö´ TOXIC FOODS</div><div class="tip-body">Chocolate, grapes/raisins, xylitol (sugar-free gum), onions, garlic, macadamia nuts, alcohol, caffeine, avocado pits. Keep ALL of these away from your pet.</div></div>
    <div class="tip-card warn"><div class="tip-title">‚ö° If Your Dog Ate Something Toxic</div><div class="tip-body">Call your vet IMMEDIATELY. Do NOT induce vomiting unless instructed. Note what was eaten, how much, and when. Time is critical ‚Äî especially for xylitol and chocolate.</div></div>
    <div class="tip-card info"><div class="tip-title">‚úÖ Safe Snacks</div><div class="tip-body">Carrots, blueberries, watermelon (seedless), plain cooked chicken, pumpkin (plain), apple slices (no seeds), green beans, sweet potato.</div></div>

    <div class="divider"></div>

    <div class="section-title">üì° BLE Tag Tips</div>
    <div class="tip-card info"><div class="tip-title">üè∑Ô∏è How to Buy a Tag</div><div class="tip-body">Search: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti-lost BLE</span>. Cost: $2‚Äì$5. Usually CR2032 battery (6‚Äì12 months). Waterproof case recommended for outdoor use.</div></div>
    <div class="tip-card info"><div class="tip-title">üîã Battery & Range Reality Check</div><div class="tip-body">Typical BLE range: 10‚Äì30m in clear line-of-sight. Walls, metal, water, pockets, crowds, and your own body reduce range significantly. Sudden LOST flips often mean weak battery or shielding.</div></div>
    <div class="tip-card warn"><div class="tip-title">üì± Platform Limitations</div><div class="tip-body">This app uses Bluetooth signal strength ‚Äî it is NOT GPS and cannot show a precise map location. Android Chrome recommended. Many iOS browsers block BLE scanning due to platform policy. Background restrictions vary by device.</div></div>
    <div class="tip-card info"><div class="tip-title">‚ö° High Alert (Fireworks/Storms)</div><div class="tip-body">Enable <strong>High Alert</strong> in Settings before loud events. It tightens boundaries and speeds up zone confirmation to reduce reaction delay.</div></div>

    <div class="divider"></div>

    <div class="section-title">üåç Social Impact</div>
    <div class="charity-box">
      <p><strong>Every share helps.</strong></p>
      <p style="color:var(--text-secondary);line-height:1.5">Santa Claus AI is designed so that as more people learn about it, more homeless people can become independent through ethical micro-income ecosystems. Your adoption + sharing creates real-world impact.</p>
      <p style="font-size:.72rem;color:var(--text-muted)">Managed by Mediators Foundation ¬∑ mcorpai.org</p>
    </div>

    <div class="highlight-box">
      <p><strong>Pro tip:</strong> Use <span class="kbd">Focus</span> mode when you have multiple pets or noisy areas. It reduces BLE overload and improves match accuracy.</p>
      <p><strong>Pro tip:</strong> If you see <span class="kbd">Signal ambiguous</span>, tap the pet card ‚Üí <strong>Re-verify Tag</strong>.</p>
    </div>

    <div class="warning-legal">
      <p><strong>Safety Disclaimer:</strong> This system provides proximity alerts only. It does not guarantee prevention of harm, loss, injury, or theft.</p>
      <p><strong>Ethical Use:</strong> Prohibited for surveillance, stalking, military, oppression, border militarization, or individual tracking without consent.</p>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="panel-settings" class="panel">
    <div class="section-title">‚öôÔ∏è Settings</div>

    <div class="card">
      <div class="setting-row"><span style="font-size:.82rem">üîä Sound</span><div class="toggle" id="toggle-sound" onclick="Settings.toggle('sound')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">üì≥ Vibration</span><div class="toggle" id="toggle-vibrate" onclick="Settings.toggle('vibrate')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">üîî Notifications</span><div class="toggle" id="toggle-notif" onclick="Settings.toggleNotif()"></div></div>
      <div id="notif-hint" class="hidden" style="font-size:.72rem;color:var(--accent-orange);margin-top:8px">Enable notifications in browser settings if denied.</div>
      <div class="setting-row"><span style="font-size:.82rem">‚ö° High Alert Mode</span><div class="toggle" id="toggle-highalert" onclick="Settings.toggle('highAlert')"></div></div>

      <div style="margin-top:12px">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Performance</div>
        <div class="perf-select">
          <div class="perf-opt" id="perf-saver" onclick="Settings.setPerf('saver')">Saver</div>
          <div class="perf-opt active" id="perf-balanced" onclick="Settings.setPerf('balanced')">Balanced</div>
          <div class="perf-opt" id="perf-fast" onclick="Settings.setPerf('fast')">Fast</div>
        </div>
        <div style="font-size:.68rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
          Saver reduces battery use. Fast increases responsiveness (may use more CPU/battery).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üéô Voice & Audio Tools</div>

      <div class="setting-row">
        <span style="font-size:.82rem">üß† Voice Recall (play your voice on CAUTION)</span>
        <div class="toggle" id="toggle-voiceRecall" onclick="Settings.toggle('voiceRecall')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Example: Record ‚ÄúCome here!‚Äù and it will play when your pet enters CAUTION zone (best effort).
      </div>
      <div class="voice-row">
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">üéô Record 5s</button>
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">‚ñ∂ Play</button>
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">üó£ Voice Announcer (TTS)</span>
        <div class="toggle" id="toggle-tts" onclick="Settings.toggle('tts')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Speaks zone changes (requires device voices). If blocked, use sound/vibration instead.
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">üéß Audio Keepalive (prevents suspension)</span>
        <div class="toggle" id="toggle-keepAlive" onclick="Settings.toggle('keepAlive')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Uses a near-silent audio signal to keep monitoring alive on some devices. May slightly increase battery usage.
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:.78rem;color:var(--text-secondary)">Master volume</span>
          <span id="volumeVal" style="font-size:.72rem;color:var(--text-muted);font-family:var(--font-mono)">70%</span>
        </div>
        <input id="volumeSlider" class="slider-mini" type="range" min="0" max="100" value="70" oninput="Settings.setVolume(this.value)">
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üõ° Emergency Mode</div>
      <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
        Personal siren + strobe + QR contact card. Configure once, then activate quickly when needed.
      </div>
      <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Configure / Activate</button>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üêæ Registered Pets</div>
      <div id="settings-pet-list"></div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üíæ Backup & Data</div>
      <button class="btn btn-secondary btn-block" onclick="DataManager.exportAll()">‚¨áÔ∏è Export Backup (JSON)</button>
      <input type="file" id="import-input" accept="application/json" style="display:none" onchange="DataManager.handleImport(event)">
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="DataManager.importFile()">‚¨ÜÔ∏è Import Backup</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Diag.open()">üß™ Diagnostics</button>
      <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="Settings.resetApp()">üóëÔ∏è RESET ALL DATA</button>
      <div style="font-size:.7rem;color:var(--text-muted);margin-top:10px;line-height:1.45">
        Backups stay on your device. No cloud. No tracking. You can delete everything anytime.
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üìö Guides</div>
      <button class="btn btn-secondary btn-block" onclick="Help.open()">Open Help</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Legal.open()">About & Legal</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bnav-btn active" data-tab="home" onclick="Nav.go('home')"><span class="bnav-icon">üè†</span><span>Home</span></button>
    <button class="bnav-btn" data-tab="sos" onclick="Nav.go('sos')"><span class="bnav-icon">üö®</span><span>SOS</span></button>
    <button class="bnav-btn" data-tab="tips" onclick="Nav.go('tips')"><span class="bnav-icon">üìã</span><span>Tips</span></button>
    <button class="bnav-btn" data-tab="settings" onclick="Nav.go('settings')"><span class="bnav-icon">‚öôÔ∏è</span><span>Settings</span></button>
  </nav>

  <!-- WIZARD OVERLAY -->
  <div id="wizard-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="wizard-title">Add Pet Wizard</div>
      <button class="overlay-close" onclick="Wizard.close()">‚úï</button>
    </div>
    <div class="overlay-body">
      <div class="step-pills">
        <div class="step-pill current" id="sp-1">1</div>
        <div class="step-pill" id="sp-2">2</div>
        <div class="step-pill" id="sp-3">3</div>
      </div>

      <!-- STEP 1 -->
      <div class="wizard-step active" id="wiz-step-1">
        <div class="tip-card info">
          <div class="tip-title">Step 1 ‚Äî Scan nearby BLE tags</div>
          <div class="tip-body">Hold the tag <strong>2‚Äì5 cm</strong> from your phone for 10 seconds. Pick the strongest signal.</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div id="scan-status" style="font-size:.75rem;color:var(--text-muted)">Starting scan...</div>
          <button class="btn btn-sm btn-secondary" onclick="Wizard.rescan()">üîÑ Rescan</button>
        </div>
        <div id="scan-list" style="margin-top:10px"></div>
      </div>

      <!-- STEP 2 -->
      <div class="wizard-step" id="wiz-step-2">
        <div class="tip-card info">
          <div class="tip-title">Step 2 ‚Äî Verify (reduce false matches)</div>
          <div class="tip-body">Move the tag <strong>2‚Äì3 meters</strong> away. We confirm a noticeable signal drop.</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:.72rem;color:var(--text-muted)">Signal drop</div>
          <div id="verify-delta" style="font-size:2rem;font-weight:900;margin:6px 0">0</div>
          <div id="verify-status" style="font-size:.8rem;color:var(--text-muted)">Waiting for movement...</div>
          <button class="btn btn-success btn-block hidden" id="btn-verified" style="margin-top:12px" onclick="Wizard.goStep3()">‚úÖ Verified</button>
          <button class="btn btn-secondary btn-block" id="btn-skip-verify" style="margin-top:12px" onclick="Wizard.skipVerify()">Skip</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin-bottom:8px">üìè Optional: Distance Calibration</div>
          <div style="font-size:.75rem;color:var(--text-secondary);line-height:1.5">
            For better distance estimates (still approximate): record RSSI at known distances.
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(1)">Record 1m</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(10)">Record 10m</button>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:.72rem;color:var(--text-muted)">
            <span>1m: <span id="calib-1m">--</span></span>
            <span>10m: <span id="calib-10m">--</span></span>
          </div>
          <button class="btn btn-sm btn-secondary" style="margin-top:10px;width:100%" onclick="Wizard.clearCalib()">Clear calibration</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="wizard-step" id="wiz-step-3">
        <div class="tip-card info">
          <div class="tip-title">Step 3 ‚Äî Name your pet</div>
          <div class="tip-body">Choose an icon and a name. You can change it later.</div>
        </div>

        <div style="margin-top:12px">
          <div class="icon-picker" id="icon-picker"></div>

          <div style="margin-top:10px">
            <label style="font-size:.72rem;color:var(--text-secondary)">Pet Name</label>
            <input id="input-name" type="text" placeholder="My Pet" style="width:100%;margin-top:6px;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
          </div>

          <button class="btn btn-primary btn-block" id="btn-wiz-save" style="margin-top:14px" onclick="Wizard.save()">‚úÖ Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAIL OVERLAY -->
  <div id="detail-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="detail-title">Pet</div>
      <button class="overlay-close" onclick="Detail.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="detail-body"></div>
  </div>

  <!-- HELP OVERLAY -->
  <div id="help-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Help</div>
      <button class="overlay-close" onclick="Help.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="help-body"></div>
  </div>

  <!-- LEGAL OVERLAY -->
  <div id="legal-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">About & Legal</div>
      <button class="overlay-close" onclick="Legal.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="legal-body"></div>
  </div>

  <!-- DIAGNOSTICS OVERLAY -->
  <div id="diag-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Diagnostics</div>
      <button class="overlay-close" onclick="Diag.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="diag-body"></div>
  </div>

  <!-- EMERGENCY OVERLAY -->
  <div id="emg-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Emergency Mode</div>
      <button class="overlay-close" onclick="Emergency.close()">‚úï</button>
    </div>
    <div class="overlay-body" id="emg-body"></div>
  </div>

  <!-- SOS ACTIVE SCREEN -->
  <div id="sos-active" class="sos-active" onclick="SOS.deactivate()">
    <div id="sos-strobe-area" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.2"></div>
    <div class="sos-active-text">üö® SOS<br><span id="sos-active-name">PET</span></div>
    <div style="font-size:.75rem;color:#fff;opacity:.8">Tap screen to stop</div>
  </div>

  <!-- EMERGENCY ACTIVE SCREEN -->
  <div id="emergency-active" class="emergency-active">
    <div id="emg-strobe" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.25"></div>
    <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center">
      <div class="emergency-big">üõ° EMERGENCY</div>
      <div id="emg-active-name" style="margin-top:8px;font-size:1.05rem;font-weight:800"></div>
      <div id="emg-active-sub" class="emergency-sub"></div>
      <div class="qr-wrap">
        <canvas id="emg-qr" class="qr-canvas" width="180" height="180"></canvas>
        <div style="font-size:.72rem;color:rgba(255,255,255,.85)">Scan for contact info</div>
      </div>
      <div style="display:flex;gap:10px;width:100%;max-width:360px;margin-top:12px">
        <a id="emg-call" class="btn btn-primary" style="flex:1;text-decoration:none;text-align:center" href="#">üìû Call</a>
        <button class="btn btn-secondary" style="flex:1" onclick="Emergency.share()">üì§ Share</button>
      </div>
      <button class="btn btn-danger-outline" style="margin-top:14px" onclick="Emergency.deactivate()">Stop Siren</button>
      <div style="margin-top:10px;font-size:.7rem;color:rgba(255,255,255,.75)">Tip: If Shake SOS is enabled, shaking your phone will activate Emergency.</div>
    </div>
  </div>

</div>

<script>

/* ============================================================
   Santa Claus AI v3.9 (V3.9)
   - Merged: V20 feature richness + V35 engine hardening + V38 UI ideas
   - Vanilla HTML/CSS/JS, single-file, offline-first.
   - Ethical AI License: Hippocratic 3.0 Derivative (Humanitarian use only)
   ============================================================ */

'use strict';

/* ----------------------------- CONFIG ----------------------------- */
const APP_VERSION = '3.9';
const SCHEMA_VERSION = 2;

// Backward compatibility (do not change)
const DB_NAME = 'SantaAI_V35';
const DB_VERSION = 2; // v3.9 adds optional blob store
const LS_PREFIX = 'santa35_';

const MAX_RSSI_SAMPLES = 60;
const ZONE_CONFIRM_COUNT = 3;
const ZONE_CONFIRM_MS = 1200;
const ALERT_COOLDOWN_MS = 20000;
const MAX_RESTARTS_PER_MIN = 3;

// High Alert tightens RSSI boundaries by +10 dBm (stronger signal required)
const HIGH_ALERT_SHRINK = 10;

// Collision gap from V35 (0.08)
const GAP_MIN = 0.08;
const MATCH_THRESHOLD_CONFIRMED = 0.40;
const MATCH_THRESHOLD_UNCONFIRMED = 0.55;

// Icons
const ICONS = ['üê∂','üê±','üê∞','ü¶ä','üêª','üêº','üêπ','üêØ','üêµ','üê∏','ü¶Æ','üêï','üê©','üêà','üêæ','ü¶ú','üê¶','üê¢','üê†','ü¶é'];

// Leash presets
const DEFAULT_THRESHOLDS = {
  cautionEnter:-65, cautionExit:-60,
  warningEnter:-78, warningExit:-72,
  dangerEnter:-88, dangerExit:-82
};

const LEASH_PRESETS = {
  '5m':  {cautionEnter:-58,cautionExit:-53,warningEnter:-68,warningExit:-63,dangerEnter:-78,dangerExit:-73},
  '10m': {cautionEnter:-65,cautionExit:-60,warningEnter:-78,warningExit:-72,dangerEnter:-88,dangerExit:-82},
  '15m': {cautionEnter:-72,cautionExit:-67,warningEnter:-85,warningExit:-79,dangerEnter:-94,dangerExit:-88}
};

const PERF_PROFILES = {
  saver:    {petInterval:1200, renderInterval:800,  lostMs:12000, restartMs:18000, restartCooldown:22000, scanStallMs:12000, globalThrottleMs:140},
  balanced: {petInterval:800,  renderInterval:450,  lostMs:9000,  restartMs:14000, restartCooldown:15000, scanStallMs:9000,  globalThrottleMs:80},
  fast:     {petInterval:500,  renderInterval:300,  lostMs:7000,  restartMs:10000, restartCooldown:9000,  scanStallMs:6500,  globalThrottleMs:60}
};

const ZONE_ORDER = {SAFE:0, CAUTION:1, WARNING:2, DANGER:3, LOST:4};

/* ----------------------------- UTILS ----------------------------- */
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function median(arr) {
  if(!arr || !arr.length) return 0;
  const s=[...arr].sort((a,b)=>a-b);
  const m=Math.floor(s.length/2);
  return s.length%2?s[m]:(s[m-1]+s[m])/2;
}
function genRescueId() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r='';
  for(let i=0;i<8;i++) r+=c[Math.floor(Math.random()*c.length)];
  return r;
}
function fmtAgo(ms) {
  if(!ms) return '--';
  const s=Math.max(0, Math.round(ms/100)/10); // 0.1s precision
  if(s<1) return s.toFixed(1)+'s';
  if(s<60) return Math.round(s)+'s';
  const m=Math.floor(s/60);
  return m+'m';
}
function safeJson(obj) {
  try { return JSON.stringify(obj, null, 2); } catch(e){ return '{"error":"json_failed"}'; }
}
function nowMs(){ return Date.now(); }

/* ----------------------------- ETHICAL MANIFEST ----------------------------- */
const ETHICAL_MANIFEST = {
  version: APP_VERSION,
  license: 'Hippocratic 3.0 Derivative',
  purpose: 'Humanitarian pet safety for low-income families',
  prohibited: ['military','surveillance','weapons','individual_tracking','oppression','border_militarization'],
  principles: ['minimize_hallucinations','transparency','accessibility','no_data_exploitation','low_resource','no_liability','affordable','simplicity','non_specialist','allow_deletion']
};

/* ----------------------------- STATE ----------------------------- */
let perfProfile = PERF_PROFILES.balanced;
let globalLastProcessMs = 0;

/* ----------------------------- TOAST ----------------------------- */
const Toast = {
  show(msg, dur=2500) {
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=msg;
    document.body.appendChild(el);
    setTimeout(()=>{
      el.style.opacity='0';
      el.style.transition='0.3s';
      setTimeout(()=>el.remove(),300);
    }, dur);
  }
};

/* ----------------------------- STORAGE ----------------------------- */
const Store = {
  db: null,

  async init() {
    return new Promise(resolve=>{
      try{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains('pets')) db.createObjectStore('pets',{keyPath:'id'});
          if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings',{keyPath:'key'});
          if(!db.objectStoreNames.contains('ai')) db.createObjectStore('ai',{keyPath:'key'});
          if(!db.objectStoreNames.contains('alerts')) db.createObjectStore('alerts',{keyPath:'id'});
          if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs',{keyPath:'key'});
        };
        req.onsuccess = e => { this.db = e.target.result; resolve(); };
        req.onerror = () => { console.warn('IndexedDB open failed'); resolve(); };
      }catch(err){
        console.warn('IndexedDB init exception', err);
        resolve();
      }
    });
  },

  async savePet(pet) {
    const data = pet.toJSON();
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').put(data);
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data));
  },

  async getAllPets() {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('pets','readonly').objectStore('pets').getAll();
        req.onsuccess=()=>r(req.result||[]);
        req.onerror=()=>r(this._lsPets());
      });
    }
    return this._lsPets();
  },

  _lsPets() {
    const p=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX+'pet_')){
        try{ p.push(JSON.parse(localStorage.getItem(k))); }catch(e){}
      }
    }
    return p;
  },

  async deletePet(id) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').delete(id);
        tx.oncomplete=()=>r();
        tx.onerror=()=>r();
      });
    }
    localStorage.removeItem(LS_PREFIX+'pet_'+id);
  },

  async clearAll() {
    if(this.db){
      const tx=this.db.transaction(['pets','settings','ai','alerts','blobs'],'readwrite');
      tx.objectStore('pets').clear();
      tx.objectStore('settings').clear();
      tx.objectStore('ai').clear();
      tx.objectStore('alerts').clear();
      tx.objectStore('blobs').clear();
    }
    // SAFE: only delete our keys, NEVER clear all local storage
    const toRemove=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX)) toRemove.push(k);
    }
    toRemove.forEach(k=>localStorage.removeItem(k));
  },

  async saveSetting(key, value) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('settings','readwrite');
        tx.objectStore('settings').put({key,value});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value));
  },

  async getSetting(key, def) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('settings','readonly').objectStore('settings').get(key);
        req.onsuccess=()=>r(req.result ? req.result.value : def);
        req.onerror=()=>r(def);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'s_'+key);
    return v!==null ? JSON.parse(v) : def;
  },

  async saveAI(key, data) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('ai','readwrite');
        tx.objectStore('ai').put({key, ...data});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data));
  },

  async getAI(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('ai','readonly').objectStore('ai').get(key);
        req.onsuccess=()=>r(req.result || null);
        req.onerror=()=>r(null);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'ai_'+key);
    return v ? JSON.parse(v) : null;
  },

  async saveBlob(key, blob) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('blobs','readwrite');
        tx.objectStore('blobs').put({key, blob, type: blob ? blob.type : ''});
        tx.oncomplete=()=>r(true);
        tx.onerror=()=>r(false);
      });
    }
    // fallback: base64 in localStorage (best-effort)
    if(!blob){ localStorage.removeItem(LS_PREFIX+'blob_'+key); return false; }
    return new Promise(res=>{
      const fr=new FileReader();
      fr.onload=()=>{ try{ localStorage.setItem(LS_PREFIX+'blob_'+key, fr.result); res(true); }catch(e){ res(false); } };
      fr.onerror=()=>res(false);
      fr.readAsDataURL(blob);
    });
  },

  async getBlob(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('blobs','readonly').objectStore('blobs').get(key);
        req.onsuccess=()=>r(req.result ? req.result.blob : null);
        req.onerror=()=>r(null);
      });
    }
    const dataUrl = localStorage.getItem(LS_PREFIX+'blob_'+key);
    if(!dataUrl) return null;
    // Convert dataURL back to Blob
    try{
      const parts=dataUrl.split(',');
      const meta=parts[0] || '';
      const b64=parts[1] || '';
      const mime=(meta.match(/data:(.*?);base64/)||[])[1] || 'audio/webm';
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    }catch(e){
      return null;
    }
  }
};

/* ----------------------------- SIGNAL FILTER (KALMAN) ----------------------------- */
// Advanced Kalman filter (from V20, adapted)
class KalmanRSSI {
  constructor(){
    this.x=-70;
    this.v=0;
    this.P=[[2,0],[0,2]];
    this.Q=0.15;
    this.R=5;
    this.history=[];
    this.maxHistory=30;
  }
  update(z){
    const xPred=this.x+this.v;
    const pPred=this.P[0][0]+this.Q;
    const innov=z-xPred;
    const K=pPred/(pPred+this.R);
    this.x=xPred+K*innov;
    this.v=this.v+0.1*(innov-this.v);
    this.P[0][0]=(1-K)*pPred;

    this.history.push(z);
    if(this.history.length>this.maxHistory) this.history.shift();

    if(this.history.length>=5){
      const m=this.history.reduce((a,b)=>a+b,0)/this.history.length;
      const vr=this.history.reduce((a,b)=>a+(b-m)**2,0)/this.history.length;
      this.R=clamp(vr*0.5,1,15);
    }
    return this.x;
  }
  getVelocity(){ return this.v; }
  reset(){ this.x=-70; this.v=0; this.R=5; this.history=[]; }
}

/* ----------------------------- DISTANCE ESTIMATOR (V20) ----------------------------- */
class DistanceEstimator {
  constructor(){
    this.txPower=-59;
    this.n=2.5;
    this.calibPoints=[];
  }
  estimate(rssi){
    if(rssi>=0 || isNaN(rssi)) return 0;
    return clamp(Math.pow(10, (this.txPower - rssi)/(10*this.n)), 0, 100);
  }
  addCalibration(rssi, dist){
    this.calibPoints.push({rssi, dist});
    this._recalc();
  }
  _recalc(){
    if(this.calibPoints.length<2) return;
    const p1=this.calibPoints[this.calibPoints.length-2];
    const p2=this.calibPoints[this.calibPoints.length-1];
    if(p1.dist>0 && p2.dist>0 && p1.dist!==p2.dist){
      const lr=Math.log10(p2.dist/p1.dist);
      if(lr!==0){
        this.n = clamp((p1.rssi - p2.rssi)/(10*lr), 1.5, 4);
        this.txPower = p1.rssi + 10*this.n*Math.log10(p1.dist);
      }
    }
  }
  export(){ return {txPower:this.txPower, n:this.n, calibPoints:this.calibPoints}; }
  import(d){
    if(!d) return;
    this.txPower = typeof d.txPower==='number' ? d.txPower : this.txPower;
    this.n = typeof d.n==='number' ? d.n : this.n;
    this.calibPoints = Array.isArray(d.calibPoints) ? d.calibPoints : [];
  }
}

/* ----------------------------- Q-LEARNING LITE (V20/V35) ----------------------------- */
class QLearningLite {
  constructor(){
    this.qTable={};
    this.lr=0.3;
    this.eps=0.2;
    this.count=0;
  }
  _key(zone){ return zone; }
  _getQ(s){
    if(!this.qTable[s]) this.qTable[s]={widen:0, maintain:0, narrow:0};
    return this.qTable[s];
  }
  chooseAction(zone){
    const q=this._getQ(this._key(zone));
    if(Math.random()<this.eps){
      const a=['widen','maintain','narrow'];
      return a[Math.floor(Math.random()*3)];
    }
    return Object.entries(q).reduce((a,b)=>b[1]>a[1]?b:a, ['maintain',-Infinity])[0];
  }
  update(zone, isHelpful, action){
    const s=this._key(zone);
    const q=this._getQ(s);
    const reward=isHelpful?1:-1;
    q[action]=q[action]+this.lr*(reward-q[action]);
    this.count++;
    if(this.count>50) this.lr=0.1;
    if(this.count>200) this.lr=0.05;
    this.eps=Math.max(0.05, this.eps*0.995);
  }
  applyAction(action, thresholds){
    const step=2;
    const t={...thresholds};
    if(action==='widen'){
      t.cautionEnter=Math.max(-90, t.cautionEnter-step);
      t.warningEnter=Math.max(-98, t.warningEnter-step);
      t.dangerEnter=Math.max(-100, t.dangerEnter-step);
    }else if(action==='narrow'){
      t.cautionEnter=Math.min(-40, t.cautionEnter+step);
      t.warningEnter=Math.min(-55, t.warningEnter+step);
      t.dangerEnter=Math.min(-70, t.dangerEnter+step);
    }
    // maintain exit thresholds relative
    t.cautionExit=t.cautionEnter+5;
    t.warningExit=t.warningEnter+6;
    t.dangerExit=t.dangerEnter+6;
    return t;
  }
  export(){ return {qTable:this.qTable, count:this.count, lr:this.lr, eps:this.eps}; }
  import(d){
    if(!d) return;
    this.qTable=d.qTable||{};
    this.count=d.count||0;
    this.lr=typeof d.lr==='number'?d.lr:this.lr;
    this.eps=typeof d.eps==='number'?d.eps:this.eps;
  }
  reset(){ this.qTable={}; this.lr=0.3; this.eps=0.2; this.count=0; }
}

/* ----------------------------- BEHAVIORAL FINGERPRINT ----------------------------- */
class BehavioralFingerprint {
  constructor(){
    this.window=[];
    this.windowSize=60;
  }
  addReading(rssi){
    this.window.push(rssi);
    if(this.window.length>this.windowSize) this.window.shift();
  }
  getFeatures(){
    if(this.window.length<10) return null;
    const w=this.window;
    const mean=w.reduce((a,b)=>a+b,0)/w.length;
    const variance=w.reduce((a,b)=>a+(b-mean)**2,0)/w.length;
    const recent=w.slice(-5);
    const older=w.slice(-10,-5);
    const trendMean=recent.reduce((a,b)=>a+b,0)/recent.length;
    const olderMean=older.length?older.reduce((a,b)=>a+b,0)/older.length:mean;
    const trend=trendMean-olderMean;
    return {mean, variance, trend};
  }
  classify(){
    const f=this.getFeatures();
    if(!f) return 'unknown';
    if(f.trend<-5 && f.variance>30) return 'rapid_departure';
    if(f.trend<-3) return 'moving_away';
    if(f.trend>3) return 'approaching';
    if(f.variance>50) return 'unstable';
    return 'stable';
  }
}

/* ----------------------------- RING BUFFER ----------------------------- */
class RingBuffer {
  constructor(size){ this.size=size; this.buf=[]; }
  push(v){ this.buf.push(v); if(this.buf.length>this.size) this.buf.shift(); }
  get data(){ return this.buf; }
  get length(){ return this.buf.length; }
  get last(){ return this.buf[this.buf.length-1]; }
  clear(){ this.buf=[]; }
  slice(a,b){ return this.buf.slice(a,b); }
}

/* ----------------------------- PET MODEL ----------------------------- */
class Pet {
  constructor(data){
    this.id = data.id || ('pet_'+Date.now()+'_'+Math.random().toString(36).slice(2,6));
    this.name = data.name || 'My Pet';
    this.icon = data.icon || 'üê∂';
    this.createdAt = data.createdAt || Date.now();
    this.signature = data.signature || {};
    this.rescueId = data.rescueId || genRescueId();
    this.thresholds = data.thresholds || {...DEFAULT_THRESHOLDS};
    this.leashPreset = data.leashPreset || '10m';
    this.aiToggles = data.aiToggles || {qlearn:false, behavior:true};
    this.aiState = data.aiState || {};

    // Runtime modules (not raw-persisted; but we import params when available)
    this.kalman = new KalmanRSSI();
    this.distance = new DistanceEstimator();
    if(data.distanceCalib) this.distance.import(data.distanceCalib);

    this.qlearn = new QLearningLite();
    if(this.aiState && this.aiState.qlearn) this.qlearn.import(this.aiState.qlearn);

    this.behavior = new BehavioralFingerprint();
    this.rssiRing = new RingBuffer(MAX_RSSI_SAMPLES);

    // runtime state
    this.lastSeenMs=0;
    this.lastRawRssi=null;
    this.smoothedRssi=-100;
    this.lastProcessMs=0;

    this.zone={stable:'SAFE', candidate:'SAFE', candidateCount:0, candidateSinceMs:0, lastAlertMs:0};
    this.trendArrow='‚Üí';
    this.confidence=0;
    this.whyText='';
    this.alertHistory = Array.isArray(data.alertHistory) ? data.alertHistory : [];
    this.ambiguousCount = data.ambiguousCount || 0;
    this.lastAmbiguousMs = data.lastAmbiguousMs || 0;
    this.distMeters=0;
    this.lostFlips=0;
    this.batterySuspect=false;

    // AI coach state
    this.lastAiSuggestion=null;
  }

  getMinInterval(){
    const z=this.zone.stable;
    const base=perfProfile.petInterval;
    if(z==='SAFE') return base*2;
    if(z==='CAUTION') return base*1.4;
    if(z==='WARNING') return base*0.7;
    return base*0.5;
  }

  ingestRaw(rssi, now){
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    if(this.aiToggles.behavior) this.behavior.addReading(rssi);
  }

  _effectiveThresholds(){
    const t=this.thresholds;
    const ha = Settings.prefs.highAlert ? HIGH_ALERT_SHRINK : 0;
    const te = {
      cautionEnter: clamp(t.cautionEnter + ha, -90, -40),
      cautionExit:  clamp(t.cautionExit  + ha, -85, -35),
      warningEnter: clamp(t.warningEnter + ha, -98, -55),
      warningExit:  clamp(t.warningExit  + ha, -92, -49),
      dangerEnter: clamp(t.dangerEnter + ha, -100, -70),
      dangerExit:  clamp(t.dangerExit  + ha, -94, -64)
    };
    // ensure hysteresis remains valid
    if(te.cautionExit <= te.cautionEnter) te.cautionExit = te.cautionEnter + 5;
    if(te.warningExit <= te.warningEnter) te.warningExit = te.warningEnter + 6;
    if(te.dangerExit <= te.dangerEnter) te.dangerExit = te.dangerEnter + 6;
    return te;
  }

  processRssi(rssi, now){
    const dtProcess = this.lastProcessMs ? (now - this.lastProcessMs) : 9999;
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    this.lastProcessMs = now;

    this.smoothedRssi = this.kalman.update(rssi);
    this.rssiRing.push(this.smoothedRssi);

    if(this.aiToggles.behavior) this.behavior.addReading(rssi);

    this.distMeters = this.distance.estimate(this.smoothedRssi);

    // Confidence estimation
    const freshness=clamp(1-(dtProcess)/10000,0,1);
    const sampleCount=clamp(this.rssiRing.length/20,0,1);
    const f=this.behavior.getFeatures();
    const stability=f?clamp(1-f.variance/120,0,1):0.5;
    this.confidence=Math.round((freshness*0.25 + sampleCount*0.35 + stability*0.40)*100);

    // Zone w/ hysteresis
    const sr=this.smoothedRssi;
    const prev=this.zone.stable;
    const t=this._effectiveThresholds();
    let instant;

    if(prev==='SAFE'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }else if(prev==='CAUTION'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr>t.cautionExit?'SAFE' : 'CAUTION';
    }else if(prev==='WARNING'){
      instant = sr<=t.dangerEnter?'DANGER' : sr>t.warningExit?'CAUTION' : 'WARNING';
    }else if(prev==='DANGER'){
      instant = sr>t.dangerExit?'WARNING' : 'DANGER';
    }else{
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }

    // Stabilize transitions
    if(instant===this.zone.candidate){
      this.zone.candidateCount++;
    }else{
      this.zone.candidate = instant;
      this.zone.candidateCount = 1;
      this.zone.candidateSinceMs = now;
    }

    const confirmReq = Settings.prefs.highAlert ? Math.max(2, ZONE_CONFIRM_COUNT-1) : ZONE_CONFIRM_COUNT;
    const stable = this.zone.candidateCount>=confirmReq || ((now-this.zone.candidateSinceMs)>=ZONE_CONFIRM_MS && this.zone.candidateCount>=2);

    if(stable && this.zone.candidate!==this.zone.stable){
      const prevS=this.zone.stable;
      this.zone.stable=this.zone.candidate;

      if(ZONE_ORDER[this.zone.stable] > ZONE_ORDER[prevS]){
        // Escalation (worse zone)
        const vel=this.kalman.getVelocity();
        const beh=this.behavior.classify();
        if(beh==='rapid_departure') this.whyText='Signal weakening fast';
        else if(vel<-2) this.whyText='Signal declining steadily';
        else this.whyText='Boundary threshold crossed';

        if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
          this.zone.lastAlertMs = now;
          App.triggerAlert(this);
          this._addAlert(now);
        }
      }else{
        this.whyText='Signal improving';
      }
    }

    // Trend arrow
    if(this.rssiRing.length>=8){
      const recent=median(this.rssiRing.slice(-4));
      const older=median(this.rssiRing.slice(-8,-4));
      const diff=recent-older;
      this.trendArrow = diff>3?'‚Üë':diff<-3?'‚Üì':'‚Üí';
    }

    // Battery suspicion heuristic
    if(this.zone.stable==='LOST') this.lostFlips++;
    if(this.lostFlips>=3) this.batterySuspect=true;
  }

  markLost(now){
    if(this.zone.stable!=='LOST'){
      this.zone.stable='LOST';
      this.zone.candidate='LOST';
      this.zone.candidateCount=99;
      this.trendArrow='‚úï';
      this.whyText='No signal for '+Math.round((now-this.lastSeenMs)/1000)+'s';
      this.confidence=0;

      this.lostFlips++;
      if(this.lostFlips>=3) this.batterySuspect=true;

      if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
        this.zone.lastAlertMs = now;
        App.triggerAlert(this);
        this._addAlert(now);
      }
    }
  }

  _addAlert(now){
    this.alertHistory.unshift({
      time: now,
      zone: this.zone.stable,
      rssi: Math.round(this.smoothedRssi),
      dist: this.distMeters.toFixed(1),
      why: this.whyText
    });
    if(this.alertHistory.length>40) this.alertHistory.pop();
  }

  getLastSeenText(now){
    if(!this.lastSeenMs) return 'Never';
    const s=Math.round((now-this.lastSeenMs)/1000);
    if(s<2) return 'Just now';
    if(s<60) return s+'s ago';
    if(s<3600) return Math.floor(s/60)+'m ago';
    return 'Long ago';
  }

  signatureStrength(){
    // Quick heuristic
    const sig=this.signature||{};
    let s=0;
    if(sig.confirmed) s+=2;
    if(sig.nameExact) s+=2;
    if(sig.namePrefix) s+=1;
    if(sig.manufacturerId!==undefined) s+=1;
    if(sig.manufacturerDataPrefixHex) s+=1;
    if(sig.serviceUuids && sig.serviceUuids.length) s+=1;
    if(sig.deviceId) s+=1;
    return s; // 0..8
  }

  toJSON(){
    return {
      id:this.id,
      name:this.name,
      icon:this.icon,
      signature:this.signature,
      createdAt:this.createdAt,
      rescueId:this.rescueId,
      thresholds:this.thresholds,
      leashPreset:this.leashPreset,
      aiToggles:this.aiToggles,
      aiState:{ qlearn: this.qlearn.export() },
      distanceCalib:this.distance.export(),
      alertHistory:this.alertHistory.slice(0,40),
      ambiguousCount:this.ambiguousCount,
      lastAmbiguousMs:this.lastAmbiguousMs
    };
  }
}

/* ----------------------------- QR GENERATOR (V20) ----------------------------- */
const QRGenerator = {
  // Note: This is a QR-like visual code (not a strict ISO QR encoder).
  generate(text, canvas, size=180){
    if(!canvas) return;
    const ctx=canvas.getContext('2d');
    canvas.width=size; canvas.height=size;
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size);

    // Hash text into deterministic pattern
    let hash=0;
    for(let i=0;i<text.length;i++){
      hash=(hash*31 + text.charCodeAt(i)) >>> 0;
    }

    const grid=25;
    const cell=Math.floor(size/grid);
    for(let y=0;y<grid;y++){
      for(let x=0;x<grid;x++){
        const v = (hash + x*73856093 + y*19349663) >>> 0;
        const on = ((v ^ (v>>>16) ^ (v>>>8)) & 1) === 1;
        // Finder pattern corners
        const inFinder = (x<7 && y<7) || (x>grid-8 && y<7) || (x<7 && y>grid-8);
        if(inFinder){
          const fx = x%7, fy = y%7;
          const border = fx===0||fy===0||fx===6||fy===6;
          const inner = fx>=2&&fx<=4&&fy>=2&&fy<=4;
          if(border||inner){
            ctx.fillStyle='#000';
            ctx.fillRect(x*cell,y*cell,cell,cell);
          }
        }else if(on){
          ctx.fillStyle='#000';
          ctx.fillRect(x*cell,y*cell,cell,cell);
        }
      }
    }

    // Footer text (tiny)
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.font='10px monospace';
    ctx.fillText('SantaAI', 6, size-6);
  }
};

/* ----------------------------- AUDIO ENGINE (V20+V35) ----------------------------- */
const AudioEngine = {
  ctx:null,
  keepOsc:null,
  keepGain:null,
  vol:0.7,
  unlocked:false,
  emergencyOsc:null,
  emergencyGain:null,
  emergencyTimer:null,

  async ensure(){
    if(!Settings.prefs.sound && !Emergency.active && !Settings.prefs.keepAlive) return null;
    if(!this.ctx){
      try{ this.ctx = new (window.AudioContext||window.webkitAudioContext)(); }
      catch(e){ return null; }
    }
    try{
      if(this.ctx.state==='suspended') await this.ctx.resume();
    }catch(e){}
    this.unlocked=true;
    return this.ctx;
  },

  setVolume01(v){
    this.vol = clamp(v, 0, 1);
  },

  async beep(freq=800, dur=0.18, gain=0.35){
    const c = await this.ensure();
    if(!c) return;
    try{
      const o=c.createOscillator();
      const g=c.createGain();
      o.connect(g); g.connect(c.destination);
      o.frequency.value=freq;
      g.gain.value=(gain*this.vol);
      o.start();
      o.stop(c.currentTime + dur);
    }catch(e){}
  },

  async pattern(list){
    // list: [{f,d,g,wait}]
    for(const it of list){
      await this.beep(it.f, it.d, it.g);
      await new Promise(r=>setTimeout(r, it.wait||60));
    }
  },

  async alertForZone(zone){
    if(!Settings.prefs.sound && zone!=='EMERGENCY') return;

    if(zone==='CAUTION'){
      // Try voice recall first (best effort)
      if(Settings.prefs.voiceRecall){
        const ok = await VoiceRecall.play({silentFail:true});
        if(ok) return;
      }
      await this.beep(650, 0.14, 0.25);
      return;
    }
    if(zone==='WARNING'){
      await this.pattern([{f:820,d:0.12,g:0.35,wait:160},{f:820,d:0.12,g:0.35,wait:60}]);
      return;
    }
    if(zone==='DANGER'){
      await this.pattern([{f:1000,d:0.18,g:0.55,wait:120},{f:1300,d:0.18,g:0.55,wait:120},{f:1500,d:0.22,g:0.55,wait:60}]);
      return;
    }
    if(zone==='LOST'){
      await this.pattern([{f:420,d:0.35,g:0.55,wait:120},{f:320,d:0.45,g:0.55,wait:60}]);
      return;
    }
  },

  async startKeepAlive(){
    if(!Settings.prefs.keepAlive) return;
    const c = await this.ensure();
    if(!c || this.keepOsc) return;
    try{
      // Near-inaudible keepalive (very low gain, high frequency)
      const o=c.createOscillator();
      const g=c.createGain();
      o.connect(g); g.connect(c.destination);
      o.frequency.value=19000;
      g.gain.value=0.00001;
      o.start();
      this.keepOsc=o;
      this.keepGain=g;
    }catch(e){}
  },

  stopKeepAlive(){
    try{ if(this.keepOsc) this.keepOsc.stop(); }catch(e){}
    this.keepOsc=null; this.keepGain=null;
  },

  async startEmergencySiren(){
    const c = await this.ensure();
    if(!c) return;
    if(this.emergencyOsc) return;

    try{
      const o=c.createOscillator();
      const g=c.createGain();
      o.connect(g); g.connect(c.destination);
      g.gain.value=0.55*this.vol;
      o.type='sawtooth';
      o.frequency.value=600;
      o.start();
      this.emergencyOsc=o;
      this.emergencyGain=g;

      // Sweep frequency
      let up=true;
      this.emergencyTimer=setInterval(()=>{
        if(!this.emergencyOsc) return;
        const f=this.emergencyOsc.frequency.value;
        if(up){
          this.emergencyOsc.frequency.value = Math.min(1400, f+120);
          if(this.emergencyOsc.frequency.value>=1400) up=false;
        }else{
          this.emergencyOsc.frequency.value = Math.max(600, f-140);
          if(this.emergencyOsc.frequency.value<=600) up=true;
        }
      }, 120);
    }catch(e){}
  },

  stopEmergencySiren(){
    if(this.emergencyTimer){ clearInterval(this.emergencyTimer); this.emergencyTimer=null; }
    try{ if(this.emergencyOsc) this.emergencyOsc.stop(); }catch(e){}
    this.emergencyOsc=null; this.emergencyGain=null;
  }
};

/* ----------------------------- VOICE RECALL (V20) ----------------------------- */
const VoiceRecall = {
  key:'voice_recall',
  rec:null,
  chunks:[],
  recording:false,

  async hasClip(){
    const b=await Store.getBlob(this.key);
    return !!b;
  },

  async record5s(){
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        Toast.show('Mic not supported on this device/browser');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
      const mr = new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
      this.rec=mr;
      this.chunks=[];
      this.recording=true;

      Toast.show('Recording... (5 seconds)');
      mr.ondataavailable = e => { if(e.data && e.data.size>0) this.chunks.push(e.data); };
      mr.onstop = async () => {
        this.recording=false;
        stream.getTracks().forEach(t=>t.stop());
        const blob = new Blob(this.chunks, {type: mr.mimeType || 'audio/webm'});
        const ok = await Store.saveBlob(this.key, blob);
        if(ok) Toast.show('Voice Recall saved ‚úî');
        else Toast.show('Could not save recording (storage full?)');
      };

      mr.start();
      setTimeout(()=>{ try{ mr.stop(); }catch(e){} }, 5000);
    }catch(e){
      Toast.show('Recording failed: '+(e.message||e.name||'unknown'));
    }
  },

  async play(opts={}){
    try{
      const blob = await Store.getBlob(this.key);
      if(!blob){
        if(!opts.silentFail) Toast.show('No voice clip yet. Record first.');
        return false;
      }
      // Best effort unlock audio context
      await AudioEngine.ensure();

      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.volume = AudioEngine.vol;
      const p = a.play();
      if(p && p.catch) await p.catch(()=>{});
      setTimeout(()=>URL.revokeObjectURL(url), 15000);
      return true;
    }catch(e){
      if(!opts.silentFail) Toast.show('Playback blocked by browser');
      return false;
    }
  },

  async clear(){
    await Store.saveBlob(this.key, null);
    Toast.show('Voice clip cleared');
  }
};

/* ----------------------------- VOICE ANNOUNCER (TTS) ----------------------------- */
const VoiceAnnouncer = {
  lastSpokenMs:0,

  supported(){
    return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
  },

  speak(text){
    if(!Settings.prefs.tts) return;
    if(!this.supported()) return;
    const now=nowMs();
    if(now-this.lastSpokenMs<4500) return; // avoid spam
    this.lastSpokenMs=now;

    try{
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.02;
      u.pitch = 1.0;
      u.volume = clamp(AudioEngine.vol, 0.1, 1);
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  },

  zoneMessage(pet){
    const z=pet.zone.stable;
    if(z==='SAFE') return `${pet.name} safe.`;
    if(z==='CAUTION') return `${pet.name} caution.`;
    if(z==='WARNING') return `${pet.name} warning.`;
    if(z==='DANGER') return `${pet.name} danger.`;
    if(z==='LOST') return `${pet.name} lost signal.`;
    return `${pet.name} status changed.`;
  }
};

/* ----------------------------- BLE MATCHING ----------------------------- */
function _mfgPrefixHexFromEvent(event){
  try{
    if(!event.manufacturerData) return null;
    let pref=null;
    event.manufacturerData.forEach((v,k)=>{
      if(pref) return;
      const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
      pref=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    });
    return pref;
  }catch(e){
    return null;
  }
}

function matchScore(event, sig){
  if(!sig) return 0;
  let score=0;
  const dn=event.device.name||'';
  const di=event.device.id||'';

  if(sig.deviceId && di===sig.deviceId) score+=0.60;

  if(sig.nameExact && dn===sig.nameExact) score+=0.50;
  else if(sig.namePrefix && dn.toLowerCase().startsWith(sig.namePrefix.toLowerCase())) score+=0.30;

  if(sig.serviceUuids && event.uuids){
    const eu=event.uuids.map(u=>u.toString().toLowerCase());
    if(sig.serviceUuids.some(u=>eu.includes(u.toLowerCase()))) score+=0.25;
  }

  if(sig.manufacturerId!==undefined && event.manufacturerData){
    event.manufacturerData.forEach((v,k)=>{ if(k===sig.manufacturerId) score+=0.20; });
  }

  if(sig.manufacturerDataPrefixHex && event.manufacturerData){
    const pref=_mfgPrefixHexFromEvent(event);
    if(pref && pref===sig.manufacturerDataPrefixHex) score+=0.12;
  }

  if(sig.confirmed) score=Math.min(1, score*1.15);
  return Math.min(1, score);
}

function routeAdvertisement(event, pets, now){
  if(!pets.length) return;

  const rssi=event.rssi;
  if(typeof rssi!=='number' || isNaN(rssi)) return;

  const scores=pets
    .map(p=>({pet:p, score:matchScore(event,p.signature)}))
    .filter(s=>s.score>0)
    .sort((a,b)=>b.score-a.score);

  if(scores.length===0) return;

  const top1=scores[0];
  const threshold = (top1.pet.signature && top1.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
  if(top1.score < threshold) return;

  // Collision protection
  if(scores.length>=2){
    const top2=scores[1];
    const t2=(top2.pet.signature && top2.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
    if(top2.score>=t2 && (top1.score-top2.score)<GAP_MIN){
      top1.pet.ambiguousCount++;
      top1.pet.lastAmbiguousMs=now;
      top1.pet.whyText='Signal ambiguous (multiple tags match)';
      return;
    }
  }

  // Focus mode: process only focused pet; others keep raw
  if(App.trackMode==='focus' && App.focusPetId && top1.pet.id!==App.focusPetId){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  // Per-pet throttle
  if(now-top1.pet.lastProcessMs < top1.pet.getMinInterval()){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  top1.pet.processRssi(rssi, now);
}

/* ----------------------------- BLE ENGINE (V35 hardened + V39 fixes) ----------------------------- */
const BLE = {
  scanning:false,
  scanReq:null,
  _handler:null,
  supported:false,

  // restart protection
  restartCount:0,
  restartWindowStart:0,
  restartInProgress:false,
  lastRestartMs:0,
  lastRestartReason:'',

  // scan mode
  lastScanMode:'track',
  usingFilters:false,

  // scan health
  lastAnyAdvMs:0,
  stallCount:0,

  // adv/sec rolling
  advPerSec:0,
  _secStart:0,
  _secCount:0,
  _secRing:new RingBuffer(6),

  lastErrorName:'',
  lastErrorMessage:'',

  checkSupport(){
    if(!navigator.bluetooth) return false;
    if(typeof navigator.bluetooth.requestLEScan!=='function') return false;
    if(location.protocol!=='https:' && location.hostname!=='localhost' && location.hostname!=='127.0.0.1' && !location.protocol.startsWith('file')) return false;
    return true;
  },

  _resetCounters(){
    this.lastAnyAdvMs = nowMs();
    this.advPerSec = 0;
    this._secStart = nowMs();
    this._secCount = 0;
    this._secRing.clear();
  },

  markAdv(now){
    // rolling adv/sec
    if(!this._secStart) this._secStart=now;
    if(now - this._secStart >= 1000){
      this._secRing.push(this._secCount);
      const avg = this._secRing.length ? (this._secRing.data.reduce((a,b)=>a+b,0)/this._secRing.length) : this._secCount;
      this.advPerSec = Math.round(avg*10)/10;
      this._secStart = now;
      this._secCount = 0;
    }
    this._secCount++;
    this.lastAnyAdvMs = now;
  },

  congestionLevel(){
    const a=this.advPerSec;
    if(a>12) return 'high';
    if(a>=3) return 'med';
    return 'low';
  },

  _buildTrackFilters(){
    // Prefer filters to reduce overload.
    // Only uses namePrefix (safe), because IDs aren't usable in scan filters.
    let pets = App.pets || [];
    if(App.trackMode==='focus' && App.focusPetId){
      pets = pets.filter(p=>p.id===App.focusPetId);
    }
    const prefixes = pets
      .map(p=>p.signature && p.signature.namePrefix ? String(p.signature.namePrefix).trim() : '')
      .filter(x=>x && x.length>=2);

    // De-dup
    const uniq=[...new Set(prefixes)].slice(0,5);
    if(!uniq.length) return null;

    // Build filters
    return uniq.map(p=>({namePrefix:p}));
  },

  async startScan(mode='track', opts={}){
    this.lastErrorName=''; this.lastErrorMessage='';
    this.supported=this.checkSupport();
    if(!this.supported) return false;

    // If already scanning in same mode, do nothing
    if(this.scanning && this.lastScanMode===mode && this.scanReq) return true;

    // Switch mode: stop first (important when track uses filters)
    if(this.scanning && this.lastScanMode!==mode){
      this.stopScan();
      await new Promise(r=>setTimeout(r, 250));
    }

    try{
      // Ensure single event handler registration
      if(!this._handler){
        this._handler = e => {
          const n=nowMs();
          this.markAdv(n);
          App.onAdvertisement(e);
        };
        navigator.bluetooth.addEventListener('advertisementreceived', this._handler);
      }

      let options={keepRepeatedDevices:true};

      if(mode==='track'){
        const filters=this._buildTrackFilters();
        if(filters && filters.length){
          options.filters=filters;
          this.usingFilters=true;
        }else{
          options.acceptAllAdvertisements=true;
          this.usingFilters=false;
        }
      }else{
        // register / wizard
        options.acceptAllAdvertisements=true;
        this.usingFilters=false;
      }

      // request scan
      this.lastScanMode=mode;
      this.scanReq = await navigator.bluetooth.requestLEScan(options);
      this.scanning = true;
      this._resetCounters();
      return true;

    }catch(e){
      console.error('BLE scan error:', e);
      this.lastErrorName = e && e.name ? e.name : 'Error';
      this.lastErrorMessage = e && e.message ? e.message : '';

      // Do not spam on silent attempts (auto-start)
      if(!opts.silent){
        if(this.lastErrorName==='NotAllowedError') Toast.show('Bluetooth permission denied');
        else if(this.lastErrorName==='SecurityError') Toast.show('Scan blocked: insecure context');
        else Toast.show('Scan failed: '+(this.lastErrorMessage||this.lastErrorName||'Unknown'));
      }
      this.scanning=false;
      this.scanReq=null;
      this.advPerSec=0;
      return false;
    }
  },

  stopScan(){
    if(this.scanReq){
      try{ this.scanReq.stop(); }catch(e){}
    }
    this.scanReq=null;
    this.scanning=false;
    this.advPerSec=0;
    this._secCount=0;
    this._secStart=nowMs();
  },

  async restartScan(reason='restart'){
    if(this.restartInProgress) return;
    const now=nowMs();

    if(now-this.lastRestartMs < perfProfile.restartCooldown) return;

    if(now-this.restartWindowStart > 60000){
      this.restartCount=0;
      this.restartWindowStart=now;
    }
    if(this.restartCount >= MAX_RESTARTS_PER_MIN) return;

    this.restartInProgress=true;
    this.restartCount++;
    this.lastRestartMs=now;
    this.lastRestartReason=reason;

    this.stopScan();
    await new Promise(r=>setTimeout(r, 600));
    await this.startScan(this.lastScanMode || 'track', {silent:true});
    this.restartInProgress=false;
  }
};

/* ----------------------------- WIZARD (V35 + V39 signature hardening) ----------------------------- */
const Wizard = {
  mode:'add', // 'add' | 'reverify'
  targetPetId:null,

  candidates:{},
  selectedId:null,
  selectedSig:null,
  baselineRssi:null,
  verified:false,
  chosenIcon:'üê∂',

  scanTimer:null,
  verifyTimer:null,

  calib:{}, // {1:rssi,10:rssi}

  isOpen(){
    return $('wizard-overlay').classList.contains('active');
  },

  open(petId=null){
    this.mode = petId ? 'reverify' : 'add';
    this.targetPetId = petId || null;

    $('wizard-title').textContent = (this.mode==='reverify') ? 'Re-verify Tag' : 'Add Pet Wizard';

    $('wizard-overlay').classList.add('active');

    this.candidates={};
    this.selectedId=null;
    this.selectedSig=null;
    this.baselineRssi=null;
    this.verified=false;
    this.calib={};

    this.chosenIcon='üê∂';
    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===petId);
      if(p){ this.chosenIcon=p.icon; }
    }

    this._showStep(1);
    this._buildIconPicker();

    // Switch to register scan (accept all), real restart
    this._startScan();
  },

  close(){
    $('wizard-overlay').classList.remove('active');
    clearInterval(this.scanTimer);
    clearInterval(this.verifyTimer);

    // Return to tracking scan if monitoring desired
    if(App.pets.length>0 && App.monitoringWanted){
      BLE.startScan('track', {silent:true});
    }
  },

  _showStep(n){
    document.querySelectorAll('.wizard-step').forEach(el=>el.classList.remove('active'));
    $('wiz-step-'+n).classList.add('active');
    for(let i=1;i<=3;i++){
      const p=$('sp-'+i);
      p.className='step-pill';
      if(i<n) p.classList.add('done');
      else if(i===n) p.classList.add('current');
    }

    // Update save button label for reverify
    if(n===3){
      $('btn-wiz-save').textContent = (this.mode==='reverify') ? '‚úÖ Update' : '‚úÖ Save';
      if(this.mode==='reverify'){
        const p=App.pets.find(x=>x.id===this.targetPetId);
        if(p){
          $('input-name').value=p.name;
          this.chosenIcon=p.icon;
          this._buildIconPicker();
        }
      }else{
        $('input-name').value='';
      }
    }
  },

  async _startScan(){
    $('scan-status').textContent='Starting scan...';
    $('scan-list').innerHTML='';
    this.candidates={};

    // Always ensure register scan mode
    BLE.stopScan();
    await new Promise(r=>setTimeout(r, 250));
    const ok = await BLE.startScan('register');
    if(!ok){
      $('scan-status').textContent='BLE not supported or blocked. Showing demo devices.';
      this._startDemoScan();
      return;
    }
    $('scan-status').textContent='Scanning... Hold tag close to phone.';
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>this._renderCandidates(), 900);
  },

  _startDemoScan(){
    const dd=[
      {id:'demo_itag_001',name:'iTAG'},
      {id:'demo_finder_002',name:'Key Finder'},
      {id:'demo_unknown_003',name:''},
      {id:'demo_buds_004',name:'Galaxy Buds Pro'}
    ];
    let t=0;
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>{
      const d=dd[t%dd.length];
      const r=d.name==='iTAG' ? (-48-Math.random()*8) : (-65-Math.random()*25);
      this.handleAdv({device:{id:d.id,name:d.name}, rssi:r, uuids:[]});
      t++;
      this._renderCandidates();
    }, 320);
  },

  handleAdv(ev){
    const id = ev.device.id || ('unknown_'+Math.random().toString(36).slice(2,8));
    const name = ev.device.name || '';
    const rssi = ev.rssi;
    if(typeof rssi!=='number' || isNaN(rssi)) return;

    if(!this.candidates[id]){
      this.candidates[id]={
        id, name,
        rssiSamples:new RingBuffer(30),
        firstSeen:nowMs(),
        lastSeen:0,
        uuids:ev.uuids||[],
        manufacturerData:null,
        manufacturerId:null
      };
    }
    const c=this.candidates[id];
    c.rssiSamples.push(rssi);
    c.lastSeen=nowMs();

    if(ev.manufacturerData){
      c.manufacturerData=ev.manufacturerData;
      ev.manufacturerData.forEach((v,k)=>{ c.manufacturerId=k; });
    }
    if(name && !c.name) c.name=name;
  },

  _tagLikelihood(c){
    // Simple heuristic from V35 (kept)
    let s=0;
    const med=median(c.rssiSamples.data);
    s += clamp((med+100)/50,0,1)*40;
    s += clamp(c.rssiSamples.length/15,0,1)*25;

    if(c.rssiSamples.length>=5){
      const m=median(c.rssiSamples.data);
      const v=c.rssiSamples.data.reduce((a,b)=>a+(b-m)**2,0)/c.rssiSamples.length;
      s += clamp(1 - v/200, 0, 1)*15;
    }

    const n=(c.name||'').toLowerCase();
    if(/itag|finder|anti.?lost|isearch|key|tile|nut|tag/.test(n)) s+=15;
    if(/buds|watch|band|airpod|galaxy|pixel|bose|sony|jbl|speaker|headphone|tv|car/.test(n)) s-=30;

    return Math.round(clamp(s,0,100));
  },

  _renderCandidates(){
    const now=nowMs();
    const arr = Object.values(this.candidates)
      .filter(c => now - c.lastSeen < 6000 && c.rssiSamples.length>=2)
      .map(c => ({...c, med: median(c.rssiSamples.data), score: this._tagLikelihood(c)}))
      .sort((a,b)=>b.score-a.score)
      .slice(0, 8);

    if(!arr.length){
      $('scan-list').innerHTML='<div class="text-center" style="color:var(--text-muted);padding:20px">No devices found yet...</div>';
      return;
    }

    $('scan-list').innerHTML = arr.map(c=>{
      const pct=clamp((c.med+100)*2,0,100);
      const col=pct>60?'var(--accent-green)':pct>30?'var(--accent-yellow)':'var(--accent-red)';
      const sel=this.selectedId===c.id;
      const displayId = c.id.length>16 ? (c.id.slice(0,8)+'‚Ä¶'+c.id.slice(-4)) : c.id;
      return `
        <div class="scan-item ${sel?'selected':''}" onclick="Wizard.selectCandidate('${c.id}')">
          <div>
            <div class="scan-item-name">${c.name||'‚ü®Unknown Tag‚ü©'}</div>
            <div class="scan-item-id">${displayId}</div>
            <div class="tag-score">Tag likelihood: ${c.score}%</div>
          </div>
          <div class="scan-item-right">
            <div class="scan-rssi" style="color:${col}">${Math.round(c.med)} dBm</div>
            <div class="rssi-bar-track"><div class="rssi-bar-fill" style="width:${pct}%;background:${col}"></div></div>
          </div>
        </div>
      `;
    }).join('');
  },

  selectCandidate(id){
    this.selectedId=id;
    const c=this.candidates[id];
    if(!c) return;

    // manufacturer prefix hex (first 2 bytes)
    let mfgPrefix=null;
    try{
      if(c.manufacturerData){
        for(const [k,v] of c.manufacturerData.entries()){
          const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
          mfgPrefix=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
          break;
        }
      }
    }catch(e){ mfgPrefix=null; }

    this.selectedSig = {
      deviceId: c.id,
      nameExact: c.name || null,
      namePrefix: c.name ? c.name.slice(0, Math.min(6, c.name.length)) : null,
      serviceUuids: (c.uuids && c.uuids.length) ? c.uuids.map(u=>u.toString()) : null,
      manufacturerId: (c.manufacturerId!==null && c.manufacturerId!==undefined) ? c.manufacturerId : undefined,
      manufacturerDataPrefixHex: mfgPrefix || null,
      confirmed:false
    };

    this._renderCandidates();
    setTimeout(()=>this._goStep2(), 350);
  },

  _goStep2(){
    this._showStep(2);
    const c=this.candidates[this.selectedId];
    if(!c) return;

    this.baselineRssi = median(c.rssiSamples.slice(-6));
    this.verified=false;

    $('verify-delta').textContent='0';
    $('verify-delta').style.color='var(--text-muted)';
    $('verify-status').textContent='Waiting for movement...';
    $('verify-status').style.color='var(--text-muted)';

    $('btn-verified').classList.add('hidden');
    $('btn-skip-verify').classList.remove('hidden');

    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';

    clearInterval(this.verifyTimer);
    this.verifyTimer=setInterval(()=>{
      const cc=this.candidates[this.selectedId];
      if(!cc || cc.rssiSamples.length<3) return;

      const cur=median(cc.rssiSamples.slice(-4));
      const delta=this.baselineRssi-cur;

      $('verify-delta').textContent = Math.round(delta);

      if(delta>=10){
        $('verify-delta').style.color='var(--accent-green)';
        $('verify-status').textContent='Signal drop confirmed!';
        $('verify-status').style.color='var(--accent-green)';
        $('btn-verified').classList.remove('hidden');
        $('btn-skip-verify').classList.add('hidden');
        this.verified=true;
        clearInterval(this.verifyTimer);
      }else if(delta>=5){
        $('verify-delta').style.color='var(--accent-yellow)';
        $('verify-status').textContent='Keep moving further away...';
      }else{
        $('verify-delta').style.color='var(--text-muted)';
      }
    }, 520);
  },

  skipVerify(){
    this.verified=false;
    clearInterval(this.verifyTimer);
    this.goStep3();
  },

  goStep3(){
    clearInterval(this.verifyTimer);
    if(this.selectedSig) this.selectedSig.confirmed=this.verified;
    this._showStep(3);

    if(this.mode==='add'){
      $('input-name').value='';
      $('input-name').focus();
    }else{
      $('input-name').focus();
    }
  },

  _buildIconPicker(){
    $('icon-picker').innerHTML = ICONS.map(ic=>`
      <div class="icon-opt ${ic===this.chosenIcon?'selected':''}" onclick="Wizard.pickIcon('${ic}')">${ic}</div>
    `).join('');
  },

  pickIcon(ic){
    this.chosenIcon=ic;
    this._buildIconPicker();
  },

  rescan(){
    // Force true scan restart (fixes V38 issue)
    this.candidates={};
    this.selectedId=null;
    $('scan-list').innerHTML='';
    $('scan-status').textContent='Re-scanning...';
    BLE.stopScan();
    setTimeout(()=>this._startScan(), 280);
  },

  _currentCandidateMedian(){
    const c=this.candidates[this.selectedId];
    if(!c || c.rssiSamples.length<3) return null;
    return median(c.rssiSamples.slice(-4));
  },

  recordCalib(dist){
    const med=this._currentCandidateMedian();
    if(med===null) { Toast.show('Need more samples‚Ä¶'); return; }
    this.calib[dist]=med;
    if(dist===1) $('calib-1m').textContent=Math.round(med)+' dBm';
    if(dist===10) $('calib-10m').textContent=Math.round(med)+' dBm';
    Toast.show(`Calibration recorded at ${dist}m`);
  },

  clearCalib(){
    this.calib={};
    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';
    Toast.show('Calibration cleared');
  },

  async save(){
    const name = ($('input-name').value||'').trim() || 'My Pet';
    const sig = this.selectedSig || {};
    sig.confirmed = !!this.verified;

    // Attach calibration to be applied on pet.distance later
    const calibPoints=[];
    if(typeof this.calib[1]==='number') calibPoints.push({rssi:this.calib[1], dist:1});
    if(typeof this.calib[10]==='number') calibPoints.push({rssi:this.calib[10], dist:10});

    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===this.targetPetId);
      if(!p){ Toast.show('Pet not found'); this.close(); return; }
      p.name=name;
      p.icon=this.chosenIcon;
      p.signature=sig;
      p.ambiguousCount=0;
      p.lastAmbiguousMs=0;
      if(calibPoints.length){
        p.distance = new DistanceEstimator();
        calibPoints.forEach(pt=>p.distance.addCalibration(pt.rssi, pt.dist));
      }
      await Store.savePet(p);
      Toast.show('Tag signature updated ‚úî');
      this.close();
      App.render();
      return;
    }

    const pet=new Pet({name, icon:this.chosenIcon, signature:sig, createdAt:nowMs()});
    if(calibPoints.length){
      calibPoints.forEach(pt=>pet.distance.addCalibration(pt.rssi, pt.dist));
    }

    App.addPet(pet);
    await Store.savePet(pet);

    Toast.show(name+' is now protected!');
    this.close();

    // Auto suggestions if signature seems weak
    if(pet.signatureStrength()<=2){
      Toast.show('Tip: Use Focus mode for best accuracy (weak tag signature)');
    }

    // Start monitoring if user wants
    if(App.monitoringWanted) BLE.startScan('track', {silent:true});
  }
};

/* ----------------------------- SOS MODULE (V35) ----------------------------- */
const SOS = {
  active:false,
  holdTimer:null,
  strobeTimer:null,
  targetPet:null,
  hcHistory:new RingBuffer(12),
  savedLocation:null,

  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  activate(){
    this.active=true;
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    $('sos-active-name').textContent = p ? p.name : 'PET';
    $('sos-active').classList.add('active');
    if(navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
    AudioEngine.alertForZone('DANGER');
    this._startStrobe();
  },

  deactivate(){
    this.active=false;
    $('sos-active').classList.remove('active');
    clearInterval(this.strobeTimer);
    $('sos-strobe-area').style.background='';
    $('sos-active').style.background='#000';
  },

  _startStrobe(){
    let on=false;
    this.strobeTimer=setInterval(()=>{
      $('sos-strobe-area').style.background=on?'#fff':'#e74c3c';
      $('sos-active').style.background=on?'#300':'#000';
      on=!on;
    }, 420);
  },

  updateHC(rssi){
    this.hcHistory.push(rssi);
    if(this.hcHistory.length<6) return;
    const r=median(this.hcHistory.slice(-3));
    const o=median(this.hcHistory.slice(-6,-3));
    const d=r-o;
    const a=$('hc-arrow'), t=$('hc-text'), rv=$('hc-rssi');
    rv.textContent=Math.round(r)+' dBm';
    if(d>3){
      a.textContent='üî•';
      t.textContent='HOT ‚Äî Getting Closer!';
      t.style.color='var(--zone-danger)';
    }else if(d<-3){
      a.textContent='üßä';
      t.textContent='COLD ‚Äî Moving Away';
      t.style.color='var(--accent-blue)';
    }else{
      a.textContent='‚û°Ô∏è';
      t.textContent='STEADY ‚Äî Keep searching';
      t.style.color='var(--text-muted)';
    }
  },

  updateSnapshot(pet){
    if(!pet) return;
    const now=nowMs();
    const l=[
      '<strong>'+pet.name+'</strong> '+pet.icon,
      'Status: <span style="color:var(--zone-'+pet.zone.stable.toLowerCase()+')">'+pet.zone.stable+'</span>',
      'Last seen: '+pet.getLastSeenText(now),
      'Signal: '+(pet.lastRawRssi!==null ? Math.round(pet.smoothedRssi)+' dBm' : 'N/A'),
      'Distance: ~'+pet.distMeters.toFixed(1)+'m (approx)',
      'Confidence: '+pet.confidence+'%',
      'Rescue ID: <strong>'+pet.rescueId+'</strong>'
    ];
    if(pet.batterySuspect) l.push('‚ö† Possible weak battery (frequent LOST)');
    if(this.savedLocation) l.push('üìç '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5));
    $('sos-snapshot').innerHTML=l.join('<br>');
  },

  async saveLocation(){
    if(!navigator.geolocation){ Toast.show('Geolocation not available'); return; }
    try{
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000}));
      this.savedLocation={lat:pos.coords.latitude, lon:pos.coords.longitude, time:nowMs()};
      Toast.show('Location saved!');
      const p=this.targetPet || App.pets[0];
      if(p) this.updateSnapshot(p);
    }catch(e){
      Toast.show('Could not get location: '+(e.message||'Denied'));
    }
  },

  shareMessage(){
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    let m='LOST PET ALERT\n';
    if(p){
      m+='Name: '+p.name+'\nRescue ID: '+p.rescueId+'\nLast signal: '+p.getLastSeenText(nowMs())+'\nStatus: '+p.zone.stable+'\nApprox distance: ~'+p.distMeters.toFixed(1)+'m\n';
    }
    if(this.savedLocation){
      m+='Owner location: '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5)+'\n';
      m+='Map: https://maps.google.com/?q='+this.savedLocation.lat+','+this.savedLocation.lon+'\n';
    }
    m+='\nSent via Santa Claus AI (mcorpai.org)\nNOT GPS ‚Äî Bluetooth proximity only';

    if(navigator.share){
      navigator.share({title:'Lost Pet Alert', text:m}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(m).then(()=>Toast.show('Copied to clipboard!')).catch(()=>Toast.show('Could not copy'));
    }
  },

  renderPetSelect(){
    if(!App.pets.length) return;
    $('sos-pet-select').innerHTML =
      '<div class="section-title" style="margin-top:0">Select Pet</div>' +
      App.pets.map(p=>`
        <button class="btn btn-sm ${this.targetPet && this.targetPet.id===p.id ? 'btn-success':'btn-secondary'}"
          style="margin:0 4px 4px 0"
          onclick="SOS.selectPet('${p.id}')"
        >${p.icon} ${p.name}</button>
      `).join('');
  },

  selectPet(id){
    this.targetPet = App.pets.find(p=>p.id===id) || null;
    this.hcHistory.clear();
    this.renderPetSelect();
    if(this.targetPet){
      this.updateSnapshot(this.targetPet);
      App.focusPetId=this.targetPet.id;
      $('sos-focus-banner').classList.remove('hidden');
      if(App.trackMode==='focus') Toast.show('Focus Mode: '+this.targetPet.name);
    }
  }
};

/* ----------------------------- EMERGENCY MODE (V20) ----------------------------- */
const Emergency = {
  active:false,
  strobeTimer:null,
  wakeLock:null,
  shakeEnabled:false,
  shakeArmed:false,
  lastShakeMs:0,

  data:{ name:'', phone:'', medical:'' },

  async load(){
    this.data.name = await Store.getSetting('emg_name','');
    this.data.phone = await Store.getSetting('emg_phone','');
    this.data.medical = await Store.getSetting('emg_medical','');
    this.shakeEnabled = await Store.getSetting('emg_shake', false);
  },

  async save(){
    await Store.saveSetting('emg_name', this.data.name||'');
    await Store.saveSetting('emg_phone', this.data.phone||'');
    await Store.saveSetting('emg_medical', this.data.medical||'');
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Emergency profile saved');
  },

  open(){
    $('emg-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('emg-overlay').classList.remove('active');
  },

  render(){
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    const shakeState = this.shakeEnabled ? 'ON' : 'OFF';

    $('emg-body').innerHTML = `
      <div class="tip-card danger">
        <div class="tip-title">Emergency Mode</div>
        <div class="tip-body">
          This mode is for <strong>personal safety</strong> (siren + strobe + QR contact card).
          Configure now, so you can activate fast when needed.
        </div>
      </div>

      <div class="card">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Your name</div>
        <input id="emg-name" type="text" value="${(this.data.name||'').replace(/"/g,'&quot;')}" placeholder="Your Name"
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Emergency phone</div>
        <input id="emg-phone" type="text" value="${(this.data.phone||'').replace(/"/g,'&quot;')}" placeholder="+82..."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Medical / notes (optional)</div>
        <textarea id="emg-medical" rows="3" placeholder="Allergies, conditions, etc."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem;resize:vertical">${(this.data.medical||'')}</textarea>

        <button class="btn btn-secondary btn-block" style="margin-top:12px" onclick="Emergency.saveFromUI()">üíæ Save Profile</button>
      </div>

      <div class="card">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">Shake SOS</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Current: <strong>${shakeState}</strong><br>
          If enabled, shaking your phone can activate Emergency (best effort; may need permission on iOS).
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.toggleShake()">Toggle</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.requestMotionPermission()">iOS Permission</button>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds to activate</div>
        <button class="btn btn-primary" style="font-size:1.05rem;padding:14px 26px;border-radius:50px"
          ontouchstart="Emergency.holdStart()" ontouchend="Emergency.holdEnd()"
          onmousedown="Emergency.holdStart()" onmouseup="Emergency.holdEnd()"
        >üõ° ACTIVATE EMERGENCY</button>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Safety Note</div>
        <div class="tip-body">
          This tool helps call attention and share contact info. It does not guarantee safety.
          Always prioritize real emergency services in your region.
        </div>
      </div>
    `;
  },

  saveFromUI(){
    this.data.name = ($('emg-name').value||'').trim();
    this.data.phone = ($('emg-phone').value||'').trim();
    this.data.medical = ($('emg-medical').value||'').trim();
    this.save();
    this.render();
  },

  async toggleShake(){
    this.shakeEnabled = !this.shakeEnabled;
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Shake SOS ' + (this.shakeEnabled?'ON':'OFF'));
    this.render();
  },

  async requestMotionPermission(){
    // iOS 13+ requires permission for motion sensors
    try{
      if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        const res = await DeviceMotionEvent.requestPermission();
        Toast.show('Motion permission: '+res);
      }else{
        Toast.show('Motion permission not required on this device');
      }
    }catch(e){
      Toast.show('Motion permission failed');
    }
  },

  holdTimer:null,
  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  async activate(){
    this.data.name = ($('emg-name') ? ($('emg-name').value||'').trim() : this.data.name);
    this.data.phone = ($('emg-phone') ? ($('emg-phone').value||'').trim() : this.data.phone);
    this.data.medical = ($('emg-medical') ? ($('emg-medical').value||'').trim() : this.data.medical);

    await this.save();

    this.active=true;
    $('emergency-active').classList.add('active');

    // Wake lock (best effort)
    try{
      if('wakeLock' in navigator && navigator.wakeLock && navigator.wakeLock.request){
        this.wakeLock = await navigator.wakeLock.request('screen');
      }
    }catch(e){ this.wakeLock=null; }

    // Strobe
    this._startStrobe();

    // Siren & vibration
    AudioEngine.startEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([800,200,800,200,800,400,1200]);

    // QR contact card
    const payload = this.getPayload();
    QRGenerator.generate(payload, $('emg-qr'), 180);

    // UI fields
    $('emg-active-name').textContent = this.data.name ? this.data.name : 'UNKNOWN';
    $('emg-active-sub').textContent = this.data.medical ? ('Info: '+this.data.medical) : 'Tap CALL or SHARE to contact someone.';
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    $('emg-call').href = phoneSan ? ('tel:'+phoneSan) : '#';

    // Arm shake detection
    this.shakeArmed = this.shakeEnabled;
    this.lastShakeMs=0;
  },

  async deactivate(){
    this.active=false;
    $('emergency-active').classList.remove('active');

    clearInterval(this.strobeTimer);
    this.strobeTimer=null;

    AudioEngine.stopEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([100,60,100]);

    if(this.wakeLock){
      try{ await this.wakeLock.release(); }catch(e){}
      this.wakeLock=null;
    }
  },

  _startStrobe(){
    let on=false;
    clearInterval(this.strobeTimer);
    this.strobeTimer=setInterval(()=>{
      const root=$('emergency-active');
      if(!root) return;
      root.classList.toggle('strobe-on', on);
      on=!on;
    }, 320);
  },

  getPayload(){
    // short payload string
    const phone=(this.data.phone||'').trim();
    const med=(this.data.medical||'').trim();
    return `EMERGENCY|NAME:${this.data.name||''}|PHONE:${phone}|INFO:${med}|APP:SantaAI`;
  },

  share(){
    const text = `EMERGENCY\nName: ${this.data.name||'N/A'}\nPhone: ${this.data.phone||'N/A'}\nInfo: ${this.data.medical||''}\nSent via Santa Claus AI`;
    if(navigator.share){
      navigator.share({title:'Emergency', text}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(text).then(()=>Toast.show('Copied to clipboard')).catch(()=>Toast.show('Could not copy'));
    }
  },

  // Shake detection (best effort)
  handleMotion(e){
    if(!this.shakeEnabled) return;
    if(this.active) return;
    if(!this.shakeArmed) return;

    const now=nowMs();
    const a=e.accelerationIncludingGravity;
    if(!a) return;

    const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
    if(mag>25){
      if(now-this.lastShakeMs<1800) return;
      this.lastShakeMs=now;
      Toast.show('Shake detected ‚Äî activating Emergency');
      this.activate();
    }
  }
};

// Register motion listener once (no permission request on load)
window.addEventListener('devicemotion', e=>Emergency.handleMotion(e), {passive:true});

/* ----------------------------- PET DETAIL OVERLAY (expanded) ----------------------------- */
const Detail = {
  pet:null,

  open(id){
    this.pet=App.pets.find(p=>p.id===id);
    if(!this.pet) return;

    if(App.trackMode==='focus'){
      App.focusPetId=id;
      App.renderPetChips();
    }

    $('detail-title').textContent=this.pet.icon+' '+this.pet.name;
    $('detail-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('detail-overlay').classList.remove('active');
  },

  async render(){
    const p=this.pet;
    if(!p) return;

    const z=p.zone.stable.toLowerCase();
    const now=nowMs();
    const sig=p.signature||{};
    const strength=p.signatureStrength();

    const sigLines=[];
    if(sig.nameExact) sigLines.push('Name: <span class="kbd">'+sig.nameExact+'</span>');
    if(sig.namePrefix) sigLines.push('Prefix: <span class="kbd">'+sig.namePrefix+'</span>');
    if(sig.manufacturerId!==undefined) sigLines.push('MFG ID: <span class="kbd">'+sig.manufacturerId+'</span>');
    if(sig.manufacturerDataPrefixHex) sigLines.push('MFG HEX: <span class="kbd">'+sig.manufacturerDataPrefixHex+'</span>');
    if(sig.deviceId) sigLines.push('Device ID: <span class="kbd">'+(sig.deviceId.length>16?(sig.deviceId.slice(0,8)+'‚Ä¶'+sig.deviceId.slice(-4)):sig.deviceId)+'</span>');
    if(sig.confirmed) sigLines.push('Verified: <span class="kbd">YES</span>');

    const congestion = BLE.congestionLevel();

    let html=`
      <div class="detail-ring zone-${z}">
        <div class="detail-dist">${p.distMeters<1?p.distMeters.toFixed(1):Math.round(p.distMeters)}</div>
        <div class="detail-unit">meters (approx)</div>
        <div class="detail-zone" style="color:var(--zone-${z})">${p.zone.stable}</div>
      </div>

      <div style="text-align:center;font-size:.65rem;color:var(--text-muted)">
        Not GPS ‚Äî Bluetooth proximity estimate only
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
        <span style="font-size:.78rem">Signal Strength</span>
        <span style="font-size:.78rem;font-family:var(--font-mono)">${Math.round(p.smoothedRssi)} dBm ${p.trendArrow}</span>
      </div>

      <div class="rssi-meter">
        <div class="rssi-meter-fill" style="width:${clamp((p.smoothedRssi+100)/70*100,0,100)}%;background:var(--zone-${z})"></div>
      </div>

      <div class="signal-bars">
        ${[12,16,20,24,28].map((h,i)=>`<div class="bar" style="height:${h}px;width:6px;border-radius:2px;background:${i<Math.ceil(clamp((p.smoothedRssi+100)/70*5,0,5))?'var(--zone-'+z+')':'var(--text-muted)'}"></div>`).join('')}
      </div>

      <div style="display:flex;justify-content:space-between;margin:8px 0">
        <span style="font-size:.75rem;color:var(--text-secondary)">Confidence: <strong>${p.confidence}%</strong></span>
        <span style="font-size:.72rem;color:var(--accent-orange);font-style:italic">${p.whyText||''}</span>
      </div>

      ${p.ambiguousCount>0 ? `
        <div class="warning-legal" style="margin-top:10px">
          <p><strong>‚ö† Signal ambiguous</strong> ‚Äî multiple tags look similar.</p>
          <p style="font-size:.75rem">Fix: Bring tag close ‚Üí Re-verify signature. This improves matching and prevents false alerts.</p>
          <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      `:''}

      ${p.batterySuspect ? `
        <div class="tip-card warn">
          <div class="tip-title">üîã Battery Suspected</div>
          <div class="tip-body">Frequent LOST flips suggest a weak CR2032 battery or signal shielding. Consider replacing battery and keeping the tag outside metal/waterproof cages.</div>
        </div>
      `:''}

      <div class="rescue-card">
        <div style="font-size:.72rem;color:var(--text-secondary)">Rescue ID (write on collar)</div>
        <div class="rescue-id">${p.rescueId}</div>
        <div style="font-size:.62rem;color:var(--text-muted)">If found, rescuer can contact you using this ID.</div>
        <div class="qr-wrap">
          <canvas id="qr-${p.id}" class="qr-canvas" width="180" height="180"></canvas>
          <div style="font-size:.72rem;color:var(--text-secondary)">QR contact code (visual)</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üéô Voice Tools</div>
      <div class="card" style="margin-bottom:12px">
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Voice Recall plays on <strong>CAUTION</strong> zone to call your pet back (best effort).
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span style="font-size:.78rem">Voice Recall</span>
          <div class="toggle ${Settings.prefs.voiceRecall?'on':''}" onclick="Settings.toggle('voiceRecall')"></div>
        </div>
        <div class="voice-row">
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">üéô Record 5s</button>
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">‚ñ∂ Play</button>
        </div>
      </div>

      <div class="section-title" style="font-size:.8rem">üéö Invisible Leash Distance</div>
      <div class="leash-row">
        ${Object.keys(LEASH_PRESETS).map(k=>`<div class="leash-btn ${p.leashPreset===k?'active':''}" onclick="Detail.setLeash('${k}')">${k}</div>`).join('')}
        <div class="leash-btn ${p.leashPreset==='custom'?'active':''}" onclick="Detail.setLeash('custom')">Custom</div>
      </div>

      <div style="margin-top:12px">
        <div class="slider-row"><label>Caution</label><input type="range" min="-90" max="-40" value="${p.thresholds.cautionEnter}" oninput="Detail.updateThreshold('cautionEnter',this.value)"><span class="val" id="dt-caution">${p.thresholds.cautionEnter} dBm</span></div>
        <div class="slider-row"><label>Warning</label><input type="range" min="-98" max="-55" value="${p.thresholds.warningEnter}" oninput="Detail.updateThreshold('warningEnter',this.value)"><span class="val" id="dt-warning">${p.thresholds.warningEnter} dBm</span></div>
        <div class="slider-row"><label>Danger</label><input type="range" min="-100" max="-70" value="${p.thresholds.dangerEnter}" oninput="Detail.updateThreshold('dangerEnter',this.value)"><span class="val" id="dt-danger">${p.thresholds.dangerEnter} dBm</span></div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üß† AI Modules</div>
      <div class="card">
        <div class="setting-row">
          <span style="font-size:.78rem">Behavior Fingerprint</span>
          <div class="toggle ${p.aiToggles.behavior?'on':''}" onclick="Detail.toggleAI('behavior')"></div>
        </div>
        <div class="setting-row">
          <span style="font-size:.78rem">Q-Learning Coach (suggest thresholds)</span>
          <div class="toggle ${p.aiToggles.qlearn?'on':''}" onclick="Detail.toggleAI('qlearn')"></div>
        </div>

        <div style="margin-top:10px;font-size:.75rem;color:var(--text-secondary);line-height:1.5">
          Current behavior: <strong>${p.behavior.classify()}</strong><br>
          Congestion: <strong>${congestion.toUpperCase()}</strong> (${BLE.advPerSec} adv/s)
        </div>

        <button class="btn btn-secondary btn-sm" style="margin-top:10px;width:100%" onclick="Detail.suggestAI()">‚ú® Suggest Adjustment</button>

        <div id="ai-suggestion" style="margin-top:10px;font-size:.75rem;color:var(--text-muted);line-height:1.5"></div>
        <div id="ai-feedback" class="hidden" style="margin-top:10px">
          <div style="font-size:.72rem;color:var(--text-secondary);margin-bottom:6px">Was this suggestion helpful?</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(true)">üëç Helpful</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(false)">üëé False alarm</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üîé Tag Signature</div>
      <div class="card" style="font-size:.75rem;color:var(--text-secondary);line-height:1.6">
        Strength: <strong>${strength}/8</strong><br>
        ${sigLines.length ? sigLines.join('<br>') : 'No signature captured'}
        <div style="margin-top:10px">
          <button class="btn btn-secondary btn-sm" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">üìú Alert History</div>
      <div id="detail-alerts">
        ${p.alertHistory.length ? p.alertHistory.slice(0,18).map(a=>{
          const t=new Date(a.time);
          return `
            <div class="alert-item">
              <span><span class="alert-dot" style="background:var(--zone-${a.zone.toLowerCase()})"></span>${a.zone} ‚Äî ~${a.dist}m</span>
              <span style="color:var(--text-muted)">${t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${a.why?('('+a.why+')'):''}</span>
            </div>
          `;
        }).join('') : '<div style="font-size:.75rem;color:var(--text-muted);text-align:center;padding:12px">No alerts yet</div>'}
      </div>
    `;

    $('detail-body').innerHTML=html;

    // Generate QR for rescue ID and name (visual code)
    const qrPayload = `SANTA_PET|NAME:${p.name}|RESCUE:${p.rescueId}|APP:SantaAI`;
    QRGenerator.generate(qrPayload, $('qr-'+p.id), 180);
  },

  async setLeash(preset){
    if(!this.pet) return;
    if(preset==='custom'){
      this.pet.leashPreset='custom';
    }else{
      this.pet.leashPreset=preset;
      this.pet.thresholds={...LEASH_PRESETS[preset]};
    }
    await Store.savePet(this.pet);
    this.render();
  },

  async updateThreshold(key,val){
    if(!this.pet) return;
    val=parseInt(val);
    this.pet.thresholds[key]=val;

    if(key==='cautionEnter') this.pet.thresholds.cautionExit=val+5;
    if(key==='warningEnter') this.pet.thresholds.warningExit=val+6;
    if(key==='dangerEnter') this.pet.thresholds.dangerExit=val+6;

    this.pet.leashPreset='custom';

    const id = key==='cautionEnter'?'dt-caution':key==='warningEnter'?'dt-warning':'dt-danger';
    $(id).textContent = val+' dBm';

    await Store.savePet(this.pet);
  },

  async toggleAI(key){
    if(!this.pet) return;
    this.pet.aiToggles[key]=!this.pet.aiToggles[key];
    await Store.savePet(this.pet);
    this.render();
  },

  async suggestAI(){
    const p=this.pet;
    if(!p) return;

    if(!p.aiToggles.qlearn){
      Toast.show('Enable Q-Learning Coach first');
      return;
    }

    const zone=p.zone.stable;
    const action=p.qlearn.chooseAction(zone);
    p.lastAiSuggestion={zone, action, at:nowMs()};

    const msg = (action==='widen') ? 'Suggestion: WIDEN boundaries (less sensitive)'
              : (action==='narrow') ? 'Suggestion: NARROW boundaries (more sensitive)'
              : 'Suggestion: MAINTAIN current boundaries';

    $('ai-suggestion').innerHTML = `
      <div style="padding:10px;border-radius:10px;border:1px solid rgba(52,152,219,.25);background:rgba(52,152,219,.06)">
        <strong>${msg}</strong><br>
        <span style="color:var(--text-muted)">Tap ‚ÄúApply‚Äù to update thresholds.</span>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.applySuggestion()">Apply</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.resetQ()">Reset AI</button>
        </div>
      </div>
    `;
    $('ai-feedback').classList.add('hidden');
  },

  async applySuggestion(){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;

    const newT=p.qlearn.applyAction(action, p.thresholds);
    p.thresholds=newT;
    p.leashPreset='custom';
    await Store.savePet(p);

    $('ai-feedback').classList.remove('hidden');
    Toast.show('Thresholds updated ('+action+')');
    this.render();
  },

  async aiFeedback(helpful){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;
    p.qlearn.update(zone, !!helpful, action);
    p.lastAiSuggestion=null;
    await Store.savePet(p);
    Toast.show(helpful?'AI reward saved':'AI penalty saved');
    $('ai-feedback').classList.add('hidden');
  },

  async resetQ(){
    const p=this.pet;
    if(!p) return;
    p.qlearn.reset();
    await Store.savePet(p);
    Toast.show('AI state reset');
    this.render();
  }
};

/* ----------------------------- NAV ----------------------------- */
const Nav = {
  current:'home',
  go(tab){
    this.current=tab;
    document.querySelectorAll('.panel').forEach(el=>el.classList.remove('active'));
    $('panel-'+tab).classList.add('active');

    document.querySelectorAll('.bnav-btn').forEach(el=>{
      el.classList.toggle('active', el.dataset.tab===tab);
    });

    if(tab==='sos'){
      if(App.pets.length>0){
        $('sos-no-pets').classList.add('hidden');
        $('sos-content').classList.remove('hidden');
        if(!SOS.targetPet && App.pets.length) SOS.selectPet(App.pets[0].id);
        SOS.renderPetSelect();
      }else{
        $('sos-no-pets').classList.remove('hidden');
        $('sos-content').classList.add('hidden');
      }
    }

    if(tab==='settings') Settings.renderPetList();
  }
};

/* ----------------------------- SETTINGS ----------------------------- */
const Settings = {
  prefs:{
    sound:true,
    vibrate:true,
    notifWanted:false,
    highAlert:false,
    perfMode:'balanced',
    voiceRecall:false,
    tts:false,
    keepAlive:true,
    volume:70
  },

  async load(){
    this.prefs.sound = await Store.getSetting('sound', true);
    this.prefs.vibrate = await Store.getSetting('vibrate', true);
    this.prefs.notifWanted = await Store.getSetting('notifWanted', false);
    this.prefs.highAlert = await Store.getSetting('highAlert', false);
    this.prefs.perfMode = await Store.getSetting('perfMode', 'balanced');

    this.prefs.voiceRecall = await Store.getSetting('voiceRecall', false);
    this.prefs.tts = await Store.getSetting('tts', false);
    this.prefs.keepAlive = await Store.getSetting('keepAlive', true);
    this.prefs.volume = await Store.getSetting('volume', 70);

    perfProfile = PERF_PROFILES[this.prefs.perfMode] || PERF_PROFILES.balanced;
    this._updateToggles();
    this._updatePerfUI();
    this._updateVolumeUI();
  },

  _updateToggles(){
    const ts=$('toggle-sound'), tv=$('toggle-vibrate'), tn=$('toggle-notif'), th=$('toggle-highalert');
    const tvr=$('toggle-voiceRecall'), tts=$('toggle-tts'), tka=$('toggle-keepAlive');

    if(ts) ts.classList.toggle('on', this.prefs.sound);
    if(tv) tv.classList.toggle('on', this.prefs.vibrate);
    if(tn) tn.classList.toggle('on', this.prefs.notifWanted && ('Notification' in window) && Notification.permission==='granted');
    if(th) th.classList.toggle('on', this.prefs.highAlert);

    if(tvr) tvr.classList.toggle('on', this.prefs.voiceRecall);
    if(tts) tts.classList.toggle('on', this.prefs.tts);
    if(tka) tka.classList.toggle('on', this.prefs.keepAlive);
  },

  _updatePerfUI(){
    document.querySelectorAll('.perf-opt').forEach(el=>el.classList.remove('active'));
    const id='perf-'+this.prefs.perfMode;
    if($(id)) $(id).classList.add('active');
  },

  _updateVolumeUI(){
    const v=clamp(parseInt(this.prefs.volume)||0,0,100);
    const sv=$('volumeSlider');
    const vv=$('volumeVal');
    if(sv) sv.value=v;
    if(vv) vv.textContent=v+'%';
    AudioEngine.setVolume01(v/100);
  },

  async toggle(key){
    this.prefs[key]=!this.prefs[key];
    await Store.saveSetting(key, this.prefs[key]);
    this._updateToggles();

    if(key==='highAlert') Toast.show(this.prefs.highAlert?'High Alert ON':'High Alert OFF');
    if(key==='keepAlive'){
      Toast.show(this.prefs.keepAlive?'Audio Keepalive ON':'Audio Keepalive OFF');
      if(this.prefs.keepAlive && App.monitoringWanted) AudioEngine.startKeepAlive();
      else AudioEngine.stopKeepAlive();
    }
    if(key==='sound' && !this.prefs.sound) AudioEngine.stopKeepAlive();
  },

  async toggleNotif(){
    if(!('Notification' in window)){ Toast.show('Notifications not supported'); return; }

    if(Notification.permission==='granted'){
      this.prefs.notifWanted=!this.prefs.notifWanted;
      await Store.saveSetting('notifWanted', this.prefs.notifWanted);
      this._updateToggles();
      return;
    }
    if(Notification.permission==='denied'){
      $('notif-hint').classList.remove('hidden');
      Toast.show('Denied. Enable in browser settings.');
      return;
    }

    // request on user gesture
    const result = await Notification.requestPermission();
    if(result==='granted'){
      this.prefs.notifWanted=true;
      await Store.saveSetting('notifWanted', true);
      Toast.show('Notifications enabled!');
    }else{
      $('notif-hint').classList.remove('hidden');
      Toast.show('Permission denied');
    }
    this._updateToggles();
  },

  async setPerf(mode){
    this.prefs.perfMode=mode;
    perfProfile = PERF_PROFILES[mode] || PERF_PROFILES.balanced;
    await Store.saveSetting('perfMode', mode);
    this._updatePerfUI();

    // Reset timers to apply new profile
    App.resetTimers();
    Toast.show('Performance: '+mode);
  },

  async setVolume(v){
    v=clamp(parseInt(v)||0,0,100);
    this.prefs.volume=v;
    await Store.saveSetting('volume', v);
    this._updateVolumeUI();
  },

  renderPetList(){
    const el=$('settings-pet-list');
    if(!App.pets.length){
      el.innerHTML='<div style="color:var(--text-muted);font-size:.82rem;padding:8px 0">No pets registered.</div>';
      return;
    }
    el.innerHTML = App.pets.map(p=>`
      <div class="setting-row">
        <div>
          <span style="font-size:1.2rem">${p.icon}</span> <strong>${p.name}</strong>
          <div style="font-size:.65rem;color:var(--text-muted)">ID: ${p.rescueId} | Added ${new Date(p.createdAt).toLocaleDateString()}</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="Settings.removePet('${p.id}')">Remove</button>
      </div>
    `).join('');
  },

  async removePet(id){
    if(!confirm('Remove this pet?')) return;
    await Store.deletePet(id);
    App.pets = App.pets.filter(p=>p.id!==id);
    App.render();
    this.renderPetList();
    Toast.show('Pet removed');
    if(!App.pets.length) BLE.stopScan();
  },

  resetApp(){
    if(!confirm('DELETE ALL Santa AI DATA?')) return;
    if(!confirm('Are you sure? This cannot be undone.')) return;
    Store.clearAll();
    location.reload();
  }
};

/* ----------------------------- DATA MANAGER ----------------------------- */
const DataManager = {
  async exportAll(){
    const includeVoice = await Store.getBlob(VoiceRecall.key) ? confirm('Include Voice Recall audio in backup? (file will be larger)') : false;
    let voiceBase64=null;

    if(includeVoice){
      const blob=await Store.getBlob(VoiceRecall.key);
      if(blob){
        voiceBase64 = await new Promise(res=>{
          const fr=new FileReader();
          fr.onload=()=>res(fr.result);
          fr.onerror=()=>res(null);
          fr.readAsDataURL(blob);
        });
      }
    }

    const data={
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      exported:new Date().toISOString(),
      pets:App.pets.map(p=>p.toJSON()),
      settings:Settings.prefs,
      voiceRecall: voiceBase64 ? {included:true, dataUrl:voiceBase64} : {included:false}
    };

    const blob=new Blob([safeJson(data)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='santa-ai-v39-backup-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Backup exported!');
  },

  importFile(){ $('import-input').click(); },

  async handleImport(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;

    try{
      const text=await file.text();
      const data=JSON.parse(text);
      if(!data.pets || !Array.isArray(data.pets)) throw new Error('Invalid backup');

      const merge = (App.pets.length>0) ? confirm('Merge with existing pets?\nCancel = Replace all') : true;

      if(!merge){
        App.pets=[];
        await Store.clearAll();
        await Store.init();
      }

      let imported=0;
      for(const pd of data.pets){
        if(App.pets.find(p=>p.id===pd.id)) continue;
        const pet=new Pet(pd);
        App.pets.push(pet);
        await Store.savePet(pet);
        imported++;
      }

      if(data.settings){
        // Import known settings only
        const keys=['sound','vibrate','notifWanted','highAlert','perfMode','voiceRecall','tts','keepAlive','volume'];
        for(const k of keys){
          if(k in data.settings){
            Settings.prefs[k]=data.settings[k];
            await Store.saveSetting(k, data.settings[k]);
          }
        }
        perfProfile = PERF_PROFILES[Settings.prefs.perfMode] || PERF_PROFILES.balanced;
        Settings._updateToggles();
        Settings._updatePerfUI();
        Settings._updateVolumeUI();
        App.resetTimers();
      }

      if(data.voiceRecall && data.voiceRecall.included && data.voiceRecall.dataUrl){
        // restore voice clip
        try{
          const parts=data.voiceRecall.dataUrl.split(',');
          const meta=parts[0]||'';
          const b64=parts[1]||'';
          const mime=(meta.match(/data:(.*?);base64/)||[])[1]||'audio/webm';
          const bin=atob(b64);
          const u8=new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
          const blob=new Blob([u8], {type:mime});
          await Store.saveBlob(VoiceRecall.key, blob);
        }catch(e){}
      }

      App.render();
      Toast.show(imported+' pet(s) imported');

    }catch(e){
      Toast.show('Import failed: '+(e.message||'unknown'));
    }

    ev.target.value='';
  }
};

/* ----------------------------- HELP (expanded) ----------------------------- */
const Help = {
  open(){
    $('help-overlay').classList.add('active');
    $('help-body').innerHTML=this._content();
  },
  close(){ $('help-overlay').classList.remove('active'); },

  _content(){
    // Long-form manual (adds size intentionally; improves real usability)
    return `
      <h2 style="margin-bottom:12px">üìñ Quick Start (60 seconds)</h2>

      <div class="tip-card info">
        <div class="tip-title">1) Get a BLE Tag ($2‚Äì$5)</div>
        <div class="tip-body">
          Search keywords: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Anti-lost BLE</span>.<br>
          Most use a CR2032 coin battery and advertise a Bluetooth signal every few hundred milliseconds.
          Santa Claus AI listens for that signal ‚Äî <strong>no GPS</strong>, no SIM, no cloud.
        </div>
      </div>

      <div class="tip-card info">
        <div class="tip-title">2) Add a Pet (Wizard)</div>
        <div class="tip-body">
          Home ‚Üí <strong>+ Add New Pet</strong> ‚Üí hold the tag <strong>2‚Äì5 cm</strong> from your phone.<br>
          Select the strongest device ‚Üí Step 2 verifies by requiring a signal drop when you move the tag away.<br>
          This reduces false matches when multiple tags are nearby.
        </div>
      </div>

      <div class="tip-card info">
        <div class="tip-title">3) Start Monitoring</div>
        <div class="tip-body">
          On Home, tap <strong>Start Monitoring</strong>. Keep the screen on for maximum reliability.<br>
          If your phone blocks background scanning, install as PWA (Install banner) or keep the app foreground.
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px">Zones Explained (Bluetooth Invisible Leash)</h3>
      <div class="tip-card info">
        <div class="tip-title">SAFE / CAUTION / WARNING / DANGER / LOST</div>
        <div class="tip-body">
          Zones are decided from smoothed RSSI (signal strength) using hysteresis + confirmation:
          <ul style="margin:8px 0 0 18px;line-height:1.5">
            <li><strong>SAFE</strong> ‚Äî close & stable.</li>
            <li><strong>CAUTION</strong> ‚Äî drifting away; this is where Voice Recall can play your voice.</li>
            <li><strong>WARNING</strong> ‚Äî likely leaving range soon.</li>
            <li><strong>DANGER</strong> ‚Äî urgent; treat as near-loss risk.</li>
            <li><strong>LOST</strong> ‚Äî no signal for several seconds (tag out of range, dead battery, or blocked).</li>
          </ul>
        </div>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Distance ‚âà Approximate</div>
        <div class="tip-body">
          The ‚Äúmeters‚Äù estimate is a radio model, not a ruler. Human bodies, walls, metal, and tag orientation can change readings drastically.
          Use distance as a <em>trend indicator</em>, not an exact measurement.
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px">Modes: Track All vs Focus</h3>
      <div class="tip-card info">
        <div class="tip-title">Track All</div>
        <div class="tip-body">
          Tracks every registered pet at once. Best for 1‚Äì2 pets in calm RF environments.
        </div>
      </div>

      <div class="tip-card info">
        <div class="tip-title">Focus Mode</div>
        <div class="tip-body">
          Tracks one selected pet with maximum accuracy and less BLE overload.
          Recommended for crowded places, apartments, or when multiple tags are in range.
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px">SOS Finder</h3>
      <div class="tip-card info">
        <div class="tip-title">Hot / Cold Navigation</div>
        <div class="tip-body">
          SOS Finder uses a rolling median of RSSI to tell if you are getting closer.
          <ul style="margin:8px 0 0 18px;line-height:1.5">
            <li><strong>üî• HOT</strong> ‚Äî stronger signal than a moment ago.</li>
            <li><strong>üßä COLD</strong> ‚Äî weaker signal.</li>
            <li><strong>‚û°Ô∏è STEADY</strong> ‚Äî similar; keep searching.</li>
          </ul>
          Tip: Walk in a grid pattern. If signal improves, keep that direction.
        </div>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">If You See ‚ÄúSignal ambiguous‚Äù</div>
        <div class="tip-body">
          When multiple tags look similar, the engine blocks routing to avoid false alarms.
          Fix: bring your tag close ‚Üí open pet card ‚Üí <strong>Re-verify Tag</strong>.
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px">Troubleshooting</h3>
      <div class="tip-card warn">
        <div class="tip-title">No devices found</div>
        <div class="tip-body">
          1) Confirm tag battery is installed correctly.<br>
          2) Move tag closer (2‚Äì5 cm).<br>
          3) Ensure Bluetooth is ON.<br>
          4) Use Android Chrome for best support.<br>
          5) If running from <span class="kbd">file://</span>, try HTTPS/localhost.
        </div>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Monitoring stops / freezes</div>
        <div class="tip-body">
          Try:
          <ul style="margin:8px 0 0 18px;line-height:1.5">
            <li>Enable <strong>Audio Keepalive</strong> in Settings.</li>
            <li>Install as PWA when the banner appears.</li>
            <li>Disable battery optimization for your browser/app (Android).</li>
            <li>Keep screen on (some devices pause BLE in background).</li>
          </ul>
          V3.9 includes a scan stall watchdog and auto-restart to reduce freezes.
        </div>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Too many false alarms</div>
        <div class="tip-body">
          Use Focus mode, re-verify tag signature, and consider loosening thresholds (widen boundaries).
          Also check for BLE congestion in the Home status bar.
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 10px">Privacy & Offline Guarantee</h3>
      <div class="tip-card info">
        <div class="tip-title">No Cloud</div>
        <div class="tip-body">
          Santa Claus AI stores data locally (IndexedDB / localStorage). There is no account, no tracking, no analytics.
          Export/Import backups are manual JSON files you control.
        </div>
      </div>

      <div class="tip-card info">
        <div class="tip-title">Ethical Use</div>
        <div class="tip-body">
          This project is designed for humanitarian pet safety and social impact.
          Prohibited for surveillance, stalking, oppression, or military use.
        </div>
      </div>
    `;
  }
};

/* ----------------------------- LEGAL + SOCIAL IMPACT (expanded) ----------------------------- */
const Legal = {
  open(){
    $('legal-overlay').classList.add('active');
    $('legal-body').innerHTML=this._content();
  },
  close(){ $('legal-overlay').classList.remove('active'); },

  _content(){
    return `
      <h2 style="margin-bottom:10px">About Santa Claus AI</h2>
      <div class="highlight-box">
        <p><strong>Santa Claus AI</strong> is an offline-first, single-file, ethical tool for pet safety using Bluetooth proximity (not GPS).</p>
        <p style="margin-top:8px"><strong>Core social mission:</strong> ‚ÄúThe more people know about this AI, the more homeless people can become independent.‚Äù</p>
      </div>

      <div class="warning-legal">
        <p><strong>No Warranty / No Liability:</strong> This app provides best-effort alerts only. Use common sense and real-world safety practices.</p>
        <p><strong>Not GPS:</strong> Bluetooth RSSI cannot produce an accurate map location.</p>
      </div>

      <div class="divider"></div>

      <h3>Ethical License (Hippocratic 3.0 Derivative)</h3>
      <div class="tip-card info">
        <div class="tip-title">Humanitarian Use Only</div>
        <div class="tip-body">
          Allowed: pet safety, family safety, rescue coordination, accessibility tools, humanitarian support.<br>
          Prohibited: military, surveillance, oppression, non-consensual tracking, border militarization, weaponization.
        </div>
      </div>

      <div class="divider"></div>

      <h3>Social Impact Ecosystem (How this helps independence)</h3>
      <div class="tip-card info">
        <div class="tip-title">A Share ‚Üí A Skill ‚Üí A Micro-Income</div>
        <div class="tip-body">
          The Santa AI ecosystem is designed as a lightweight bridge from <em>need</em> to <em>skill</em> to <em>stable autonomy</em>.
          When more people adopt the tool, partners can route ethical micro-work (translation, local delivery coordination, community support)
          to people who need a path back to independence ‚Äî without exploitation.
        </div>
      </div>

      <div class="tip-card info">
        <div class="tip-title">Community-First Partnerships</div>
        <div class="tip-body">
          Managed by Mediators Foundation. Partnerships focus on:
          <ul style="margin:8px 0 0 18px;line-height:1.5">
            <li>low-income pet guardians,</li>
            <li>shelters and rescues,</li>
            <li>local shops & repair services,</li>
            <li>ethical logistics support.</li>
          </ul>
          This is not a surveillance network ‚Äî it is a trust network.
        </div>
      </div>

      <div class="divider"></div>

      <h3>Partnership Direction Document (Market Expansion Concepts)</h3>
      <div class="highlight-box">
        <p><strong>Concept A ‚Äî ‚ÄúFishing Rod BLE Guard‚Äù</strong></p>
        <p style="margin-top:6px">
          Adapt the same BLE proximity engine to prevent loss/theft of fishing rods, bikes, backpacks, or tools.
          The same principles apply: proximity alert, SOS search, and offline-first operation.
        </p>
        <p style="margin-top:10px"><strong>Concept B ‚Äî Shelter Toolkit</strong></p>
        <p style="margin-top:6px">
          A shelter can use low-cost tags for temporary outdoor play yards, volunteer check-ins, and quick recovery workflows
          without needing expensive proprietary systems.
        </p>
      </div>

      <div class="divider"></div>

      <h3>Contact</h3>
      <div class="tip-card info">
        <div class="tip-title">M-Corp Ethical AI</div>
        <div class="tip-body">
          Website: mcorpai.org<br>
          Managed by: mediatorsfoundation.org<br>
          Source: GitHub (header link)
        </div>
      </div>

      <div class="divider"></div>

      <h3>Technical Manifest</h3>
      <pre style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4">${safeJson(ETHICAL_MANIFEST)}</pre>
    `;
  }
};

/* ----------------------------- DIAGNOSTICS (Download JSON) ----------------------------- */
const Diag = {
  open(){
    $('diag-overlay').classList.add('active');
    this.render();
  },
  close(){ $('diag-overlay').classList.remove('active'); },

  snapshot(){
    const now=nowMs();
    return {
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      time:new Date().toISOString(),
      env:{
        ua:navigator.userAgent,
        protocol:location.protocol,
        secureContext: !!window.isSecureContext,
        bluetooth: !!navigator.bluetooth,
        leScan: !!(navigator.bluetooth && navigator.bluetooth.requestLEScan),
        notifications: ('Notification' in window)? Notification.permission : 'unsupported'
      },
      perfMode: Settings.prefs.perfMode,
      scan:{
        supported: BLE.supported,
        scanning: BLE.scanning,
        mode: BLE.lastScanMode,
        usingFilters: BLE.usingFilters,
        advPerSec: BLE.advPerSec,
        congestion: BLE.congestionLevel(),
        lastAnyAdvAgoMs: BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null,
        restartsInMinute: BLE.restartCount,
        lastRestartReason: BLE.lastRestartReason,
        stallCount: BLE.stallCount,
        lastErrorName: BLE.lastErrorName,
        lastErrorMessage: BLE.lastErrorMessage
      },
      monitoringWanted: App.monitoringWanted,
      trackMode: App.trackMode,
      focusPetId: App.focusPetId,
      pets: App.pets.map(p=>({
        id:p.id,
        name:p.name,
        rescueId:p.rescueId,
        zone:p.zone.stable,
        rssi:p.smoothedRssi,
        dist:p.distMeters,
        confidence:p.confidence,
        lastSeenAgoMs: p.lastSeenMs ? (now-p.lastSeenMs) : null,
        signatureStrength: p.signatureStrength(),
        ambiguousCount: p.ambiguousCount,
        batterySuspect: p.batterySuspect
      }))
    };
  },

  render(){
    const snap=this.snapshot();
    $('diag-body').innerHTML = `
      <div class="tip-card info">
        <div class="tip-title">Diagnostics Snapshot</div>
        <div class="tip-body">
          Use this for debugging scan issues, sharing with maintainers, or checking device compatibility.
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:10px 0">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.copy()">üìã Copy</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.download()">‚¨áÔ∏è Download</button>
      </div>

      <pre id="diag-pre" style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4">${safeJson(snap)}</pre>

      <div class="tip-card warn">
        <div class="tip-title">Privacy Note</div>
        <div class="tip-body">
          This snapshot stays local unless you manually share it. It contains device info (user-agent) but no GPS history or cloud identifiers.
        </div>
      </div>
    `;
  },

  copy(){
    const text = $('diag-pre') ? $('diag-pre').textContent : safeJson(this.snapshot());
    navigator.clipboard.writeText(text).then(()=>Toast.show('Copied')).catch(()=>Toast.show('Copy blocked'));
  },

  download(){
    const snap=this.snapshot();
    const blob=new Blob([safeJson(snap)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='santa-ai-v39-diagnostics-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Downloaded');
  }
};

/* ----------------------------- META-COGNITIVE COACH (Idea Amplifier) ----------------------------- */
const Coach = {
  lastRenderMs:0,

  compute(){
    const now=nowMs();
    const tips=[];

    // Environment
    if(location.protocol.startsWith('file')){
      tips.push('You are running from <span class="kbd">file://</span>. For best BLE reliability, use HTTPS/localhost or install as PWA.');
    }
    if(!BLE.checkSupport()){
      tips.push('This browser may not support BLE scanning (Web Bluetooth LE Scan). Use Android Chrome, or Demo mode.');
    }

    // Scan health
    if(App.monitoringWanted && !BLE.scanning){
      tips.push('Monitoring is OFF. Tap <strong>Start Monitoring</strong>.');
      if(BLE.lastErrorName==='NotAllowedError') tips.push('Bluetooth permission was denied. Enable Bluetooth permission and retry.');
      if(BLE.lastErrorName==='SecurityError') tips.push('Secure context required. Use HTTPS/localhost.');
    }

    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);
      if(silent > perfProfile.scanStallMs*0.8){
        tips.push('Scan looks stalled. The watchdog will auto-restart if needed. Try keeping the screen on.');
      }
      const cong = BLE.congestionLevel();
      if(cong==='high'){
        tips.push('High BLE congestion detected. Use <strong>Focus</strong> mode to improve accuracy.');
      }
      if(!BLE.usingFilters){
        tips.push('No scan filters available (tags may have no name). Focus mode helps when multiple devices are nearby.');
      }
    }

    // Pet-specific hints
    for(const p of App.pets){
      if(p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000){
        tips.push(`<strong>${p.name}</strong>: Signal ambiguous. Tap pet card ‚Üí Re-verify Tag.`);
        break;
      }
      if(p.batterySuspect){
        tips.push(`<strong>${p.name}</strong>: Possible weak battery. Replace CR2032 and re-verify.`);
        break;
      }
    }

    return tips;
  },

  render(){
    const tips=this.compute();
    const card=$('coach-card');
    const body=$('coach-body');
    if(!card || !body) return;

    if(!tips.length){
      card.style.display='none';
      return;
    }

    body.innerHTML = `
      <ul style="margin-left:18px;line-height:1.6">
        ${tips.slice(0,6).map(t=>'<li>'+t+'</li>').join('')}
      </ul>
    `;
    card.style.display='block';
  }
};

/* ----------------------------- APP CORE ----------------------------- */
const App = {
  pets:[],
  trackMode:'all',
  focusPetId:null,
  demoMode:false,
  monitoringWanted:false,

  renderTimer:null,
  watchdogTimer:null,

  async init(){
    // First-run banner / context warning
    this.initFirstRunBanner();

    await Store.init();
    await Settings.load();
    await Emergency.load();

    // Apply volume early
    Settings._updateVolumeUI();

    // Load pets
    const petsData = await Store.getAllPets();
    this.pets = petsData.map(d=>new Pet(d));

    // Hide first-run banner once you already have pets (file:// first-run condition)
    if(location.protocol.startsWith('file') && this.pets.length>0){
      const b=$('first-run-banner');
      if(b) b.classList.add('hidden');
    }

    // Restore monitoring preference
    this.monitoringWanted = await Store.getSetting('monitoringWanted', false);

    this.render();

    // timers
    this.resetTimers();

    // PWA
    this.registerPWA();

    // install banner
    this.setupInstallBanner();

    // Attempt auto-start if wanted
    if(this.pets.length && this.monitoringWanted){
      // silent attempt; if user gesture is required, show banner + keep button
      await BLE.startScan('track', {silent:true});
      if(BLE.scanning){
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        // show coach guidance
        Coach.render();
      }
    }

    // Visibility resume
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible'){
        if(this.monitoringWanted && this.pets.length && !BLE.scanning && !this.demoMode){
          BLE.startScan('track', {silent:true});
        }
      }
    });

    // Safety: stop keepalive when leaving
    window.addEventListener('pagehide', ()=>{
      AudioEngine.stopKeepAlive();
    });

    Toast.show('Santa Claus AI v'+APP_VERSION+' ready');
  },

  initFirstRunBanner(){
    const banner=$('first-run-banner');
    if(!banner) return;
    const dismissed = localStorage.getItem(LS_PREFIX+'firstRunDismissed')==='1';
    const protoSpan=$('fr-proto');
    if(protoSpan) protoSpan.textContent=location.protocol;
    if(dismissed) return;

    // show when file:// OR insecure context
    if(location.protocol.startsWith('file') || !window.isSecureContext){
      banner.classList.remove('hidden');
    }
  },

  dismissFirstRun(){
    localStorage.setItem(LS_PREFIX+'firstRunDismissed','1');
    $('first-run-banner').classList.add('hidden');
  },

  resetTimers(){
    if(this.renderTimer) clearInterval(this.renderTimer);
    if(this.watchdogTimer) clearInterval(this.watchdogTimer);

    this.renderTimer=setInterval(()=>this.render(), perfProfile.renderInterval);
    this.watchdogTimer=setInterval(()=>this._watchdog(), 2000);
  },

  async toggleMonitoring(){
    if(this.demoMode){
      Toast.show('Demo mode is ON. Turn it off to use BLE monitoring.');
      return;
    }

    this.monitoringWanted = !this.monitoringWanted;
    await Store.saveSetting('monitoringWanted', this.monitoringWanted);

    if(this.monitoringWanted){
      const ok = await BLE.startScan('track');
      if(ok){
        Toast.show('Monitoring started');
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        Toast.show('Could not start scanning (see Coach/Help)');
        this.monitoringWanted=false;
        await Store.saveSetting('monitoringWanted', false);
      }
    }else{
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      Toast.show('Monitoring stopped');
    }

    this.render();
    Coach.render();
  },

  async toggleDemo(){
    this.demoMode=!this.demoMode;
    if(this.demoMode){
      this.monitoringWanted=false;
      await Store.saveSetting('monitoringWanted', false);
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      this._startDemo();
      Toast.show('Demo mode ON');
    }else{
      this._stopDemo();
      Toast.show('Demo mode OFF');
    }
    this.render();
    Coach.render();
  },
  _startDemo(){
    if(this.demoTimer) clearInterval(this.demoTimer);
    // Initialize per-pet demo phases
    this.pets.forEach(p=>{ if(p._demoPhase===undefined) p._demoPhase=Math.random()*Math.PI*2; });
    this.demoTimer=setInterval(()=>this._demoTick(), 450);
  },

  _stopDemo(){
    if(this.demoTimer){ clearInterval(this.demoTimer); this.demoTimer=null; }
  },

  _demoTick(){
    const now=nowMs();
    // Simulated RSSI wave: shows zone transitions without BLE hardware.
    this.pets.forEach(p=>{
      const t=now/1000;
      const phase=p._demoPhase||0;
      const swing = 32*Math.abs(Math.sin((t+phase)/7)); // 0..32
      const noise = Math.random()*4;
      const rssi = -54 - swing - noise;

      if(now - p.lastProcessMs >= p.getMinInterval()){
        p.processRssi(rssi, now);
      }else{
        p.ingestRaw(rssi, now);
      }
    });

    if(SOS.targetPet) SOS.updateSnapshot(SOS.targetPet);
  },



  setTrackMode(mode){
    this.trackMode=mode;
    const allBtn=$('btn-mode-all'), focusBtn=$('btn-mode-focus');
    if(allBtn) allBtn.classList.toggle('btn-success', mode==='all');
    if(focusBtn) focusBtn.classList.toggle('btn-success', mode==='focus');

    if(mode==='all'){
      this.focusPetId=null;
      $('sos-focus-banner').classList.add('hidden');
      Toast.show('Tracking all pets');
    }else{
      Toast.show('Focus mode: tap a pet to focus');
    }
    this.renderPetChips();
  },

  addPet(pet){
    this.pets.push(pet);
    this.render();
    this.renderPetChips();
  },

  onAdvertisement(event){
    // Route to Wizard if open
    if(Wizard.isOpen()){
      Wizard.handleAdv(event);
      return;
    }

    const now=nowMs();

    // Global throttle (dynamic by mode + congestion)
    let throttle = perfProfile.globalThrottleMs;
    if(BLE.congestionLevel()==='high') throttle=Math.max(throttle, 120);
    if(BLE.usingFilters) throttle=Math.min(throttle, 90);

    if(now - globalLastProcessMs < throttle) return;
    globalLastProcessMs = now;

    // Route
    routeAdvertisement(event, this.pets, now);

    // SOS update
    if(SOS.targetPet){
      if(event.rssi && matchScore(event, SOS.targetPet.signature)>0.4){
        SOS.updateHC(event.rssi);
      }
      SOS.updateSnapshot(SOS.targetPet);
    }
  },

  async triggerAlert(pet){
    if(this.demoMode) return;
    // Audio / vibration
    if(Settings.prefs.sound) AudioEngine.alertForZone(pet.zone.stable);
    if(Settings.prefs.vibrate && navigator.vibrate){
      const z=pet.zone.stable;
      if(z==='CAUTION') navigator.vibrate([120,80,120]);
      else if(z==='WARNING') navigator.vibrate([160,80,160,80,220]);
      else if(z==='DANGER') navigator.vibrate([220,80,220,80,220,120,360]);
      else if(z==='LOST') navigator.vibrate([400,200,400,200,600]);
    }

    // Notifications
    if(Settings.prefs.notifWanted && 'Notification' in window && Notification.permission==='granted'){
      try{
        new Notification('Santa AI: '+pet.name, {body:`${pet.zone.stable} ‚Äî ~${pet.distMeters.toFixed(1)}m (approx)`});
      }catch(e){}
    }

    // TTS
    if(Settings.prefs.tts){
      VoiceAnnouncer.speak(VoiceAnnouncer.zoneMessage(pet));
    }
  },

  _watchdog(){
    const now=nowMs();

    // If scanning is on but silent for too long, restart
    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);

      if(silent > perfProfile.scanStallMs){
        BLE.stallCount++;
        BLE.restartScan('scan_stall');
      }

      // advPerSec should drop to 0 if silent
      if(silent > 2000) BLE.advPerSec=0;
    }

    // Pet LOST detection
    for(const p of this.pets){
      if(!p.lastSeenMs) continue;
      const silence = now - p.lastSeenMs;

      if(silence > perfProfile.lostMs){
        p.markLost(now);
      }
    }

    // Render coach occasionally
    Coach.render();
  },

  renderPetChips(){
    const row=$('pet-chips');
    if(!row) return;

    if(this.pets.length<=1){
      row.classList.add('hidden');
      row.innerHTML='';
      return;
    }

    row.classList.remove('hidden');
    row.innerHTML = this.pets.map(p=>{
      const active = (this.trackMode==='focus' && this.focusPetId===p.id);
      return `<div class="pet-chip ${active?'active':''}" onclick="App.focusFromChip('${p.id}')">${p.icon} ${p.name}</div>`;
    }).join('');
  },

  focusFromChip(id){
    if(this.trackMode!=='focus'){
      this.setTrackMode('focus');
    }
    this.focusPetId=id;
    Toast.show('Focus: '+(this.pets.find(p=>p.id===id)?.name||'Pet'));
    this.renderPetChips();
    if(BLE.scanning && BLE.lastScanMode==='track') BLE.restartScan('focus_change');
    if(SOS.targetPet && SOS.targetPet.id===id) $('sos-focus-banner').classList.remove('hidden');
  },

  render(){
    // Empty vs dashboard
    const empty=$('empty-state');
    const dash=$('dash-controls');
    const dash2=$('dash-controls2');

    if(!this.pets.length){
      if(empty) empty.classList.remove('hidden');
      if(dash) dash.classList.add('hidden');
      if(dash2) dash2.classList.add('hidden');
      $('pet-list').innerHTML='';
      return;
    }else{
      if(empty) empty.classList.add('hidden');
      if(dash) dash.classList.remove('hidden');
      if(dash2) dash2.classList.remove('hidden');
    }

    // Buttons state
    const scanBtn=$('btn-scan-toggle');
    if(scanBtn){
      if(this.demoMode){
        scanBtn.textContent='‚ñ∂ Start Monitoring';
        scanBtn.disabled=true;
        scanBtn.style.opacity='.6';
      }else{
        scanBtn.disabled=false;
        scanBtn.style.opacity='1';
        scanBtn.textContent = this.monitoringWanted ? '‚èπ Stop Monitoring' : '‚ñ∂ Start Monitoring';
      }
    }
    const demoBtn=$('btn-demo-toggle');
    if(demoBtn){
      demoBtn.textContent = this.demoMode ? 'üß™ Demo ON' : 'üß™ Demo';
      demoBtn.classList.toggle('btn-success', this.demoMode);
    }

    // Status bar
    const bar=$('scan-status-bar');
    const badge=$('congestionBadge');
    const now=nowMs();

    if(bar){
      if(this.demoMode){
        bar.textContent='üß™ Demo Mode ‚Äî simulated data';
      }else if(BLE.scanning){
        const silent = BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null;
        const modeTxt = BLE.usingFilters ? 'filters' : 'accept-all';
        bar.textContent=`üì° Scanning (${BLE.advPerSec} adv/s, ${modeTxt}) ¬∑ last adv ${silent!==null?fmtAgo(silent):'--'} ago`;
      }else{
        bar.textContent='üì° Not scanning';
      }
    }

    if(badge){
      const lvl = this.demoMode ? 'low' : BLE.congestionLevel();
      badge.className='badge '+(lvl==='high'?'high':lvl==='med'?'med':'ok');
      badge.textContent = lvl.toUpperCase();
    }

    // Scan health bar
    const row=$('scan-health-row');
    if(row){
      if(this.demoMode || !BLE.scanning){
        row.classList.add('hidden');
      }else{
        row.classList.remove('hidden');
        const silent = BLE.lastAnyAdvMs ? (now - BLE.lastAnyAdvMs) : 999999;
        const ratio = clamp(1 - silent/perfProfile.scanStallMs, 0, 1);
        const fill=$('scan-health-fill');
        const meta=$('scan-health-meta');
        if(fill){
          fill.style.width=Math.round(ratio*100)+'%';
          fill.style.background = silent<2000 ? 'var(--accent-green)' : (silent<perfProfile.scanStallMs*0.7 ? 'var(--accent-yellow)' : 'var(--zone-danger)');
        }
        if(meta){
          meta.textContent = silent<999999 ? fmtAgo(silent)+' ago' : '--';
        }
      }
    }

    // Render pet chips
    this.renderPetChips();

    // Render pet list
    const list=$('pet-list');
    if(list){
      const now=nowMs();
      list.innerHTML = this.pets.map(p=>{
        const z=p.zone.stable.toLowerCase();
        const dotColor = 'var(--zone-'+z+')';
        const strength=p.signatureStrength();
        const weakSig = strength<=2;
        const amb = p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000;

        return `
          <div class="pet-card zone-${z}" onclick="Detail.open('${p.id}')">
            <div class="pet-icon-circle">${p.icon}</div>
            <div class="pet-details">
              <div class="pet-name">${p.name}</div>
              <div class="pet-status-row">
                <span class="status-dot" style="background:${dotColor}"></span>
                <span>${p.zone.stable}</span>
                <span style="opacity:.55">¬∑</span>
                <span>${p.getLastSeenText(now)}</span>
              </div>
              <div class="zone-badge ${z}">${p.zone.stable}</div>
              <div class="pet-conf">${p.confidence}% confidence ¬∑ ~${p.distMeters.toFixed(1)}m</div>
              ${amb ? `<div class="pet-why">‚ö† Signal ambiguous ‚Äî tap to re-verify</div>` :
                weakSig ? `<div class="pet-why">Tip: weak signature ‚Äî Focus mode recommended</div>` :
                (p.batterySuspect ? `<div class="pet-why">üîã Battery suspected ‚Äî replace CR2032</div>` :
                (p.whyText ? `<div class="pet-why">${p.whyText}</div>` : '')
              )}
            </div>
            <div class="pet-signal">
              <div class="pet-rssi" style="color:${dotColor}">
                ${p.lastRawRssi!==null ? Math.round(p.smoothedRssi) : '--'} dBm
                <span class="trend-arrow">${p.trendArrow}</span>
              </div>
              <div style="font-size:.62rem;color:var(--text-muted);margin-top:2px">${p.rescueId}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // SOS availability
    if(this.pets.length>0){
      $('sos-no-pets').classList.add('hidden');
      $('sos-content').classList.remove('hidden');
    }else{
      $('sos-no-pets').classList.remove('hidden');
      $('sos-content').classList.add('hidden');
    }
  },

  /* ----------------------------- PWA ----------------------------- */
  registerPWA(){
    if(!('serviceWorker' in navigator)) return;

    const manifest = {
      name: "Santa Claus AI v"+APP_VERSION,
      short_name: "Santa AI",
      start_url: "./",
      display: "standalone",
      background_color: "#0d1117",
      theme_color: "#c0392b",
      description: "Offline pet safety using Bluetooth proximity (not GPS).",
      icons: [
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' rx='40' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='120'%3E%F0%9F%8E%85%3C/text%3E%3C/svg%3E", sizes:"192x192", type:"image/svg+xml"},
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512'%3E%3Crect width='512' height='512' rx='96' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='340'%3E%F0%9F%8E%85%3C/text%3E%3C/svg%3E", sizes:"512x512", type:"image/svg+xml"}
      ]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('pwa-manifest');
    if(link) link.setAttribute('href', url);

    const swCode = `
      const CACHE='santa-ai-v39-cache';
      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      });
      self.addEventListener('fetch', e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  },

  setupInstallBanner(){
    let deferredPrompt=null;
    const banner=$('installBanner');
    const btn=$('installBtn');
    const dismiss=$('installDismiss');
    const dismissed = localStorage.getItem(LS_PREFIX+'installDismissed')==='1';

    window.addEventListener('beforeinstallprompt', e=>{
      e.preventDefault();
      deferredPrompt=e;
      if(!dismissed && banner) banner.classList.add('active');
    });

    if(btn){
      btn.addEventListener('click', async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(()=>{});
        deferredPrompt=null;
        if(banner) banner.classList.remove('active');
      });
    }

    if(dismiss){
      dismiss.addEventListener('click', ()=>{
        localStorage.setItem(LS_PREFIX+'installDismissed','1');
        if(banner) banner.classList.remove('active');
      });
    }
  }
};

/* ----------------------------- GLOBAL EVENT HOOKS ----------------------------- */
// Prime audio on first user gesture (helps autoplay restrictions)
document.addEventListener('pointerdown', async ()=>{
  await AudioEngine.ensure();
}, {once:true});

/* ----------------------------- INIT ----------------------------- */
document.addEventListener('DOMContentLoaded', ()=>App.init());

</script>
</body>
</html>
