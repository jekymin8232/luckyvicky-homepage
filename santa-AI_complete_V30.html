<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#c0392b">
<title>Santa Claus AI v3.0 ‚Äî Offline Pet Safety</title>
<link rel="manifest" id="pwa-manifest">
<style>
/* ============================================================
   SANTA CLAUS AI v3.0 ‚Äî MASTER STYLESHEET
   ¬© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI
   https://mcorpai.org | contact@mcorpai.org
   Managed by: https://mediatorsfoundation.org

   M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
   Humanitarian use only. Military/surveillance use prohibited.
   Zero External Dependencies | 100% Offline | Vanilla CSS/JS
   ============================================================ */

:root {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-card: #1c2333;
  --bg-elevated: #21283b;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --accent-red: #c0392b;
  --accent-green: #2ecc71;
  --accent-yellow: #f1c40f;
  --accent-orange: #e67e22;
  --accent-blue: #3498db;
  --zone-safe: #2ecc71;
  --zone-caution: #f1c40f;
  --zone-warning: #e67e22;
  --zone-danger: #e74c3c;
  --zone-lost: #9b59b6;
  --border-color: #30363d;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --shadow-soft: 0 2px 12px rgba(0,0,0,0.3);
  --transition-fast: 0.15s ease;
  --transition-normal: 0.3s ease;
  --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  --font-mono: 'Courier New', Courier, monospace;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

/* APP SHELL */
#app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; padding-bottom: 72px; }

/* HEADER */
.header {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  padding: 16px 20px 12px;
  text-align: center;
  border-bottom: 1px solid var(--border-color);
  position: sticky; top: 0; z-index: 100;
}
.header-logo { font-size: 2rem; }
.header-title { font-family: 'Georgia', serif; font-size: 1.5rem; color: var(--accent-red); letter-spacing: 1px; text-shadow: 0 0 20px rgba(192,57,43,0.4); }
.header-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.header-mission { font-size: 0.65rem; color: var(--accent-blue); margin-top: 4px; font-style: italic; opacity: 0.85; line-height: 1.3; }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg-secondary); border-top: 1px solid var(--border-color);
  display: flex; z-index: 100; max-width: 480px; margin: 0 auto;
}
.bnav-btn {
  flex: 1; padding: 8px 4px 6px; text-align: center; cursor: pointer;
  border: none; background: none; color: var(--text-muted);
  font-size: 0.65rem; font-family: var(--font-body);
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  transition: color var(--transition-fast);
}
.bnav-btn .bnav-icon { font-size: 1.3rem; }
.bnav-btn.active { color: var(--accent-red); }
.bnav-btn:active { opacity: 0.7; }

/* PANELS */
.panel { display: none; padding: 16px; animation: fadeIn 0.25s ease; }
.panel.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* CARDS */
.card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border-color); padding: 14px; margin-bottom: 10px; }

/* PET CARDS */
.pet-card {
  display: flex; align-items: center; gap: 12px;
  padding: 14px; margin-bottom: 10px;
  background: var(--bg-card); border-radius: var(--radius-md);
  border: 2px solid var(--border-color);
  transition: all var(--transition-normal); cursor: pointer; position: relative;
}
.pet-card:active { transform: scale(0.98); }
.pet-card.zone-safe { border-color: rgba(46,204,113,0.4); }
.pet-card.zone-caution { border-color: rgba(241,196,15,0.5); }
.pet-card.zone-warning { border-color: rgba(230,126,34,0.6); }
.pet-card.zone-danger { border-color: var(--zone-danger); box-shadow: 0 0 15px rgba(231,76,60,0.25); animation: pulseDanger 1.2s ease infinite; }
.pet-card.zone-lost { border-color: var(--zone-lost); opacity: 0.85; }
@keyframes pulseDanger { 0%,100% { box-shadow: 0 0 10px rgba(231,76,60,0.2); } 50% { box-shadow: 0 0 25px rgba(231,76,60,0.4); } }

.pet-icon-circle {
  width: 48px; height: 48px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; background: rgba(255,255,255,0.05); flex-shrink: 0;
}
.pet-details { flex: 1; min-width: 0; }
.pet-name { font-weight: 700; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pet-status-row { display: flex; align-items: center; gap: 6px; margin-top: 3px; font-size: 0.78rem; color: var(--text-secondary); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.pet-signal { text-align: right; flex-shrink: 0; min-width: 55px; }
.pet-rssi { font-family: var(--font-mono); font-weight: 700; font-size: 0.95rem; }
.zone-badge { font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; letter-spacing: 0.5px; }
.zone-badge.safe { background: rgba(46,204,113,0.15); color: var(--zone-safe); }
.zone-badge.caution { background: rgba(241,196,15,0.15); color: var(--zone-caution); }
.zone-badge.warning { background: rgba(230,126,34,0.15); color: var(--zone-warning); }
.zone-badge.danger { background: rgba(231,76,60,0.15); color: var(--zone-danger); }
.zone-badge.lost { background: rgba(155,89,182,0.15); color: var(--zone-lost); }

/* TREND ARROW */
.trend-arrow { font-size: 1.1rem; margin-left: 2px; }

/* EMPTY STATE */
.empty-state { text-align: center; padding: 40px 20px; }
.empty-icon { font-size: 3.5rem; margin-bottom: 12px; }
.empty-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
.empty-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

/* BUTTONS */
.btn { border: none; cursor: pointer; font-family: var(--font-body); font-weight: 600; border-radius: var(--radius-sm); transition: all var(--transition-fast); }
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent-red); color: #fff; padding: 12px 24px; font-size: 0.95rem; border-radius: 24px; box-shadow: 0 4px 12px rgba(192,57,43,0.35); }
.btn-secondary { background: var(--bg-elevated); color: var(--text-primary); padding: 10px 16px; font-size: 0.85rem; border: 1px solid var(--border-color); }
.btn-block { width: 100%; padding: 13px; font-size: 0.9rem; }
.btn-success { background: var(--accent-green); color: #000; }
.btn-danger-outline { background: none; color: var(--zone-danger); border: 1px solid var(--zone-danger); padding: 10px 16px; font-size: 0.85rem; }
.btn-sm { padding: 6px 12px; font-size: 0.75rem; }

/* OVERLAY (WIZARD/SETTINGS/HELP) */
.overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg-primary); z-index: 500;
  display: none; flex-direction: column;
}
.overlay.active { display: flex; }
.overlay-header {
  padding: 14px 16px; background: var(--bg-secondary);
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border-color); flex-shrink: 0;
}
.overlay-header h3 { font-size: 1rem; }
.overlay-close { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
.overlay-body { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }

/* WIZARD */
.wizard-step { display: none; }
.wizard-step.active { display: block; animation: fadeIn 0.3s ease; }
.step-pills { display: flex; gap: 6px; justify-content: center; margin-bottom: 16px; }
.step-pill { width: 32px; height: 4px; border-radius: 2px; background: var(--border-color); }
.step-pill.done { background: var(--accent-green); }
.step-pill.current { background: var(--accent-red); }

.scan-item {
  background: var(--bg-card); padding: 12px; margin-bottom: 8px;
  border-radius: var(--radius-sm); border: 2px solid transparent;
  cursor: pointer; display: flex; justify-content: space-between; align-items: center;
  transition: all var(--transition-fast);
}
.scan-item:active { transform: scale(0.98); }
.scan-item.selected { border-color: var(--accent-green); background: rgba(46,204,113,0.08); }
.scan-item-name { font-weight: 600; font-size: 0.9rem; }
.scan-item-id { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.scan-item-right { text-align: right; }
.scan-rssi { font-family: var(--font-mono); font-weight: 700; }
.rssi-bar-track { height: 4px; width: 80px; background: var(--bg-elevated); border-radius: 2px; overflow: hidden; margin-top: 4px; }
.rssi-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.tag-score { font-size: 0.65rem; color: var(--accent-yellow); margin-top: 2px; }

.verify-box { text-align: center; padding: 24px; border: 2px dashed var(--border-color); border-radius: var(--radius-md); margin: 16px 0; }
.verify-value { font-size: 3rem; font-weight: 900; font-family: var(--font-mono); margin: 8px 0; }
.verify-label { font-size: 0.8rem; color: var(--text-muted); }

.icon-picker { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.icon-opt {
  width: 48px; height: 48px; font-size: 1.6rem;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-card); border: 2px solid var(--border-color);
  border-radius: var(--radius-sm); cursor: pointer;
}
.icon-opt.selected { border-color: var(--accent-green); background: rgba(46,204,113,0.1); }

.text-input {
  width: 100%; padding: 12px; font-size: 1rem;
  background: var(--bg-card); border: 1px solid var(--border-color);
  color: var(--text-primary); border-radius: var(--radius-sm);
  font-family: var(--font-body);
}
.text-input:focus { outline: none; border-color: var(--accent-blue); }

/* SOS MODE */
.sos-ring-container { display: flex; justify-content: center; padding: 30px 0 20px; }
.sos-ring {
  width: 180px; height: 180px; border-radius: 50%;
  background: radial-gradient(circle, rgba(231,76,60,0.15), rgba(192,57,43,0.3));
  border: 6px solid var(--accent-red);
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem; font-weight: 900; color: #fff; cursor: pointer;
  box-shadow: 0 0 40px rgba(192,57,43,0.4); animation: pulse 2s infinite;
  font-family: 'Georgia', serif; letter-spacing: 3px;
}
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.04); } }
.sos-ring:active { transform: scale(0.95); }

.hc-card { margin-top: 16px; }
.hc-main { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
.hc-arrow { font-size: 2.5rem; }
.hc-text { font-weight: 700; font-size: 1.1rem; }
.hc-rssi { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }

/* SOS ACTIVE OVERLAY */
.sos-active {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 9999; background: #000; display: none;
  flex-direction: column; align-items: center; justify-content: center;
}
.sos-active.active { display: flex; }
.sos-active-text { font-size: 2rem; font-weight: 900; color: #fff; text-align: center; padding: 20px; letter-spacing: 2px; }
.sos-cancel-btn {
  margin-top: 24px; padding: 14px 40px;
  background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4);
  border-radius: 24px; color: #fff; font-size: 1rem; font-weight: 700; cursor: pointer;
}

/* PET TIPS */
.tip-card { padding: 14px; margin-bottom: 10px; border-radius: var(--radius-sm); border-left: 4px solid var(--accent-blue); background: var(--bg-card); }
.tip-card.danger { border-left-color: var(--zone-danger); }
.tip-card.safe { border-left-color: var(--zone-safe); }
.tip-card.info { border-left-color: var(--accent-blue); }
.tip-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 6px; }
.tip-body { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6; }

/* SETTINGS */
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(48,54,61,0.5); }
.setting-label { font-weight: 600; font-size: 0.9rem; }
.setting-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

/* TOAST */
.toast-container { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 10000; max-width: 400px; width: 90%; }
.toast {
  background: var(--bg-elevated); color: var(--text-primary);
  padding: 12px 16px; border-radius: var(--radius-sm);
  border: 1px solid var(--border-color); margin-bottom: 8px;
  font-size: 0.85rem; box-shadow: var(--shadow-soft);
  animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* TOGGLE */
.toggle { width: 44px; height: 24px; border-radius: 12px; background: var(--border-color); position: relative; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
.toggle::after { content: ''; width: 20px; height: 20px; border-radius: 50%; background: #fff; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
.toggle.on { background: var(--accent-green); }
.toggle.on::after { left: 22px; }

/* MISC */
.text-center { text-align: center; }
.mt-8 { margin-top: 8px; }
.mt-16 { margin-top: 16px; }
.mb-8 { margin-bottom: 8px; }
.gap-8 { display: flex; gap: 8px; }
.hidden { display: none !important; }
.section-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; margin-top: 16px; }
.divider { height: 1px; background: var(--border-color); margin: 16px 0; }
.info-box { background: rgba(52,152,219,0.1); border: 1px solid rgba(52,152,219,0.3); border-radius: var(--radius-sm); padding: 10px 12px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }
</style>
</head>
<body>

<div id="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-logo">üéÖ</div>
    <div class="header-title">Santa Claus AI</div>
    <div class="header-sub">Offline Pet Safety System v3.0</div>
    <div class="header-mission">"The more people know about this AI, the more homeless people can become independent."</div>
  </header>

  <!-- PANEL: DASHBOARD -->
  <div id="panel-home" class="panel active">
    <div id="pet-list"></div>
    <div id="empty-state" class="empty-state">
      <div class="empty-icon">üêï‚Äçü¶∫</div>
      <div class="empty-title">No Pets Protected Yet</div>
      <div class="empty-desc">Connect a cheap BLE tag ($2‚Äì5) to your pet's collar and start tracking.</div>
      <button class="btn btn-primary mt-16" onclick="Wizard.open()">+ Add New Pet</button>
      <div class="info-box mt-16" style="text-align:left">
        <strong>üí° Works with:</strong> Any cheap BLE tag (iTag, Key Finder, Anti-lost tags). No GPS needed. No internet needed.
      </div>
    </div>
    <div id="dash-controls" class="hidden">
      <button class="btn btn-secondary btn-block mt-8" onclick="Wizard.open()">+ Add Another Pet</button>
    </div>
  </div>

  <!-- PANEL: SOS -->
  <div id="panel-sos" class="panel">
    <div id="sos-no-pets" class="text-center" style="padding:40px 0;color:var(--text-muted)">
      <div style="font-size:3rem">üîç</div>
      <p class="mt-8">Add a pet first to use SOS mode.</p>
    </div>
    <div id="sos-content" class="hidden">
      <h3 class="text-center" style="color:var(--zone-danger)">EMERGENCY FINDER</h3>
      <div class="sos-ring-container">
        <div class="sos-ring" id="sos-btn" ontouchstart="SOS.holdStart()" ontouchend="SOS.holdEnd()" onmousedown="SOS.holdStart()" onmouseup="SOS.holdEnd()">SOS</div>
      </div>
      <p class="text-center" style="font-size:0.8rem;color:var(--text-muted)">Hold 3 seconds to activate alarm + strobe</p>

      <div id="sos-pet-select" class="mt-16"></div>

      <div class="card hc-card mt-16">
        <div class="section-title" style="margin-top:0">üî• Hot & Cold Tracker</div>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:8px">Walk slowly. The signal trend shows direction.</p>
        <div class="hc-main">
          <div class="hc-arrow" id="hc-arrow">‚ùì</div>
          <div style="text-align:right">
            <div class="hc-text" id="hc-text">WAITING...</div>
            <div class="hc-rssi" id="hc-rssi">-- dBm</div>
          </div>
        </div>
      </div>

      <div class="card mt-8">
        <div class="section-title" style="margin-top:0">üìã Last Signal Snapshot</div>
        <div id="sos-snapshot" style="font-size:0.82rem;color:var(--text-secondary);line-height:1.8">No data yet</div>
      </div>

      <div class="gap-8 mt-8">
        <button class="btn btn-secondary btn-block" onclick="SOS.shareMessage()">üì§ Share / Copy</button>
        <button class="btn btn-secondary btn-block" onclick="SOS.saveLocation()">üìç Save Location</button>
      </div>
    </div>
  </div>

  <!-- PANEL: TIPS -->
  <div id="panel-tips" class="panel">
    <h2 style="margin-bottom:16px">üê∂ Must-Read Pet Safety</h2>
    <div class="tip-card danger">
      <div class="tip-title">üö´ TOXIC FOODS ‚Äî Never Feed These!</div>
      <div class="tip-body">
        <strong>Chocolate:</strong> Contains theobromine ‚Üí heart arrhythmia, seizures, can be fatal. Dark chocolate is worst.<br><br>
        <strong>Grapes & Raisins:</strong> Even small amounts ‚Üí sudden kidney failure. No safe dose known.<br><br>
        <strong>Onions & Garlic:</strong> Destroys red blood cells ‚Üí anemia, weakness, organ damage. All forms (raw, cooked, powder).<br><br>
        <strong>Xylitol:</strong> Found in sugar-free gum, candy, toothpaste ‚Üí fatal hypoglycemia (blood sugar crash), liver failure within hours.<br><br>
        <strong>Macadamia Nuts:</strong> ‚Üí Weakness, vomiting, tremors, hyperthermia. Symptoms within 12 hours.<br><br>
        <strong>Alcohol:</strong> Even small amounts ‚Üí vomiting, diarrhea, difficulty breathing, coma.
      </div>
    </div>
    <div class="tip-card safe">
      <div class="tip-title">‚úÖ SAFE SNACKS (In Moderation)</div>
      <div class="tip-body">
        <strong>Carrots:</strong> Great for dental health, low calorie, rich in vitamin A.<br><br>
        <strong>Blueberries:</strong> Powerful antioxidants, great training treats.<br><br>
        <strong>Plain Rice + Boiled Chicken:</strong> Best remedy for upset stomach. No seasoning.<br><br>
        <strong>Watermelon (seedless):</strong> Hydrating, vitamins A, B6, C. Remove seeds and rind.<br><br>
        <strong>Pumpkin (plain, cooked):</strong> Excellent for digestion, rich in fiber.
      </div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">üè• Emergency Signs ‚Äî See a Vet Immediately</div>
      <div class="tip-body">
        ‚Ä¢ Difficulty breathing or persistent coughing<br>
        ‚Ä¢ Seizures or loss of consciousness<br>
        ‚Ä¢ Bleeding that won't stop<br>
        ‚Ä¢ Suspected poisoning (vomiting, tremors, lethargy)<br>
        ‚Ä¢ Inability to urinate or defecate for 24+ hours<br>
        ‚Ä¢ Sudden collapse or inability to stand
      </div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">üì° BLE Tag Tips for Best Results</div>
      <div class="tip-body">
        ‚Ä¢ Keep the tag on the collar, not inside a metal case<br>
        ‚Ä¢ Replace CR2032 battery every 6‚Äì12 months<br>
        ‚Ä¢ Walls, metal, and crowds weaken Bluetooth signal<br>
        ‚Ä¢ This is a proximity alert, NOT GPS tracking<br>
        ‚Ä¢ Best range: 10‚Äì30 meters (open area)
      </div>
    </div>
  </div>

  <!-- PANEL: SETTINGS -->
  <div id="panel-settings" class="panel">
    <h2 style="margin-bottom:16px">‚öôÔ∏è Settings</h2>

    <div class="section-title">Registered Pets</div>
    <div id="settings-pet-list"></div>

    <div class="section-title">Alerts</div>
    <div class="setting-row">
      <div><div class="setting-label">Sound Alerts</div><div class="setting-desc">Play warning sounds for zone changes</div></div>
      <div class="toggle on" id="toggle-sound" onclick="Settings.toggle('sound')"></div>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Vibration</div><div class="setting-desc">Haptic feedback for alerts</div></div>
      <div class="toggle on" id="toggle-vibrate" onclick="Settings.toggle('vibrate')"></div>
    </div>

    <div class="section-title">Data</div>
    <button class="btn btn-secondary btn-block" onclick="DataManager.exportAll()">üì§ Export Backup (JSON)</button>
    <button class="btn btn-secondary btn-block mt-8" onclick="DataManager.importFile()">üì• Import Backup</button>
    <input type="file" id="import-input" accept=".json" class="hidden" onchange="DataManager.handleImport(event)">
    <button class="btn btn-danger-outline btn-block mt-16" onclick="Settings.resetApp()">üóëÔ∏è Factory Reset (Delete Everything)</button>

    <div class="divider"></div>
    <div style="font-size:0.75rem;color:var(--text-muted);line-height:1.6">
      <p><strong>Santa Claus AI v3.0</strong></p>
      <p>¬© 2026 Morgan J. (Gyu-min Jeon)</p>
      <p>M-Corp Ethical AI | <a href="https://mcorpai.org" style="color:var(--accent-blue)">mcorpai.org</a></p>
      <p>Managed by <a href="https://mediatorsfoundation.org" style="color:var(--accent-blue)">mediatorsfoundation.org</a></p>
      <p style="margin-top:6px">Zero data collection. All processing on-device. GDPR-compliant by design.</p>
      <p style="margin-top:4px"><a href="#" onclick="Help.open();return false" style="color:var(--accent-blue)">üìñ User Guide & Legal</a></p>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="bnav-btn active" data-tab="home" onclick="Nav.go('home')"><span class="bnav-icon">üè†</span>Home</button>
  <button class="bnav-btn" data-tab="sos" onclick="Nav.go('sos')"><span class="bnav-icon">üÜò</span>SOS</button>
  <button class="bnav-btn" data-tab="tips" onclick="Nav.go('tips')"><span class="bnav-icon">üìñ</span>Tips</button>
  <button class="bnav-btn" data-tab="settings" onclick="Nav.go('settings')"><span class="bnav-icon">‚öôÔ∏è</span>Settings</button>
</nav>

<!-- WIZARD OVERLAY -->
<div id="wizard-overlay" class="overlay">
  <div class="overlay-header">
    <h3 id="wizard-title">Add New Pet</h3>
    <button class="overlay-close" onclick="Wizard.close()">‚úï</button>
  </div>
  <div class="overlay-body">
    <div class="step-pills mb-8">
      <div class="step-pill" id="sp-1"></div>
      <div class="step-pill" id="sp-2"></div>
      <div class="step-pill" id="sp-3"></div>
    </div>

    <!-- STEP 1: Proximity Scan -->
    <div id="wiz-step-1" class="wizard-step">
      <div class="text-center mb-8">
        <p style="font-size:0.9rem">üì° <strong>Step 1:</strong> Hold the tag very close to your phone (2‚Äì5 cm).</p>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-top:4px">We'll find the strongest signal nearby.</p>
      </div>
      <div id="scan-status" class="text-center mb-8" style="font-size:0.8rem;color:var(--accent-yellow)">Starting scan...</div>
      <div id="scan-list"></div>
      <button class="btn btn-secondary btn-block mt-8" onclick="Wizard.rescan()">üîÑ Re-Scan</button>
      <div class="info-box mt-8">üí° If your tag isn't showing, make sure it has a battery and is within 5 cm. Turning off nearby earbuds/watches helps.</div>
    </div>

    <!-- STEP 2: Move to Confirm -->
    <div id="wiz-step-2" class="wizard-step">
      <div class="text-center">
        <p style="font-size:0.9rem">üö∂ <strong>Step 2:</strong> Move the tag 2‚Äì3 meters away from the phone.</p>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-top:4px">We'll verify it's really your tag by checking signal drop.</p>
      </div>
      <div class="verify-box">
        <div class="verify-label">SIGNAL DROP</div>
        <div class="verify-value" id="verify-delta">0</div>
        <div class="verify-label">dB (Need: ‚â• 10)</div>
      </div>
      <div id="verify-status" class="text-center" style="font-size:0.9rem;color:var(--text-muted)">Waiting for movement...</div>
      <button id="btn-skip-verify" class="btn btn-secondary btn-block mt-16" onclick="Wizard.skipVerify()">Skip verification (less accurate)</button>
      <button id="btn-verified" class="btn btn-success btn-block mt-8 hidden" onclick="Wizard.goStep3()">‚úÖ Confirmed! Next ‚Üí</button>
    </div>

    <!-- STEP 3: Name & Icon -->
    <div id="wiz-step-3" class="wizard-step">
      <p style="font-size:0.9rem;margin-bottom:12px">üè∑Ô∏è <strong>Step 3:</strong> Name your pet</p>
      <input id="input-name" class="text-input" type="text" placeholder="e.g. Max, Buddy, Luna" maxlength="20">
      <p style="font-size:0.85rem;margin-top:16px;margin-bottom:8px">Choose an icon:</p>
      <div class="icon-picker" id="icon-picker"></div>
      <button class="btn btn-success btn-block mt-16" onclick="Wizard.save()">üíæ Save & Start Tracking</button>
    </div>
  </div>
</div>

<!-- HELP OVERLAY -->
<div id="help-overlay" class="overlay">
  <div class="overlay-header">
    <h3>üìñ User Guide</h3>
    <button class="overlay-close" onclick="Help.close()">‚úï</button>
  </div>
  <div class="overlay-body" id="help-body"></div>
</div>

<!-- SOS ACTIVE OVERLAY -->
<div id="sos-active" class="sos-active">
  <div class="sos-active-text">üö® LOST PET ALERT üö®<br><br><span id="sos-active-name"></span></div>
  <div id="sos-strobe-area" style="width:100%;height:60px;margin:16px 0"></div>
  <button class="sos-cancel-btn" onclick="SOS.deactivate()">TAP TO STOP</button>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<!-- ============================================================
     SANTA CLAUS AI v3.0 ‚Äî JAVASCRIPT ENGINE
     100% Vanilla JS | Zero Dependencies | Offline-First
     BLE Advertisement Scanning Architecture
     ============================================================ -->
<script>
/* ============================================================
   SANTA CLAUS AI v3.0 ‚Äî CORE APPLICATION
   ¬© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI

   M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
   HUMANITARIAN USE ONLY.
   Military, surveillance, and oppressive use PROHIBITED.
   See: UDHR, Geneva Conventions, UNCRC, CRPD, GDPR.
   Full license: https://mcorpai.org/license

   Architecture: BLE Advertisement Scanning (NOT GATT connection)
   AI: Kalman Filter (per-pet), Hysteresis Zone Logic
   Storage: IndexedDB + localStorage fallback
   Audio: Web Audio API
   ============================================================ */
'use strict';

// --- ETHICAL MANIFEST (Layer 1: Purpose Declaration) ---
const ETHICAL_MANIFEST = Object.freeze({
  project: 'Santa Claus AI',
  version: '3.0',
  org: 'M-Corp Ethical AI',
  license: 'Hippocratic License 3.0 Derivative',
  purpose: 'Offline pet safety for low-income families',
  permitted: ['humanitarian','disaster-response','animal-welfare','education','research'],
  prohibited: ['military','surveillance','weapons','tracking-individuals','oppression'],
  legal: ['UDHR','Geneva-IV','UNCRC','CRPD','GDPR-Art25'],
  contact: 'contact@mcorpai.org'
});

// --- CONSTANTS ---
const DB_NAME = 'SantaAI_V30';
const DB_VERSION = 1;
const LOST_THRESHOLD_MS = 9000;
const RESTART_THRESHOLD_MS = 15000;
const MAX_RESTARTS_PER_MIN = 3;
const ALERT_COOLDOWN_MS = 20000;
const ZONE_CONFIRM_COUNT = 4;
const ZONE_CONFIRM_MS = 2500;
const WATCHDOG_INTERVAL_MS = 3000;
const UI_RENDER_INTERVAL_MS = 400;
const MAX_RSSI_SAMPLES = 50;
const ICONS = ['üê∂','üêï','üê©','ü¶Æ','üêï‚Äçü¶∫','üê±','üêà','üêà‚Äç‚¨õ','üê∞','üêπ','üê¢','ü¶ú','üêæ','ü¶¥'];

const ZONE_ORDER = { SAFE: 0, CAUTION: 1, WARNING: 2, DANGER: 3, LOST: 4 };
const ZONE_THRESHOLDS = {
  cautionEnter: -72, cautionExit: -68,
  warningEnter: -83, warningExit: -79,
  dangerEnter: -93, dangerExit: -89
};

// --- UTILITY ---
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const median = arr => {
  if (!arr.length) return 0;
  const s = [...arr].sort((a, b) => a - b);
  const m = Math.floor(s.length / 2);
  return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
};

// --- TOAST ---
const Toast = {
  show(msg, duration) {
    duration = duration || 3000;
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    $('toast-container').appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transition = '0.3s'; setTimeout(() => el.remove(), 300); }, duration);
  }
};

// --- STORAGE (IndexedDB + localStorage fallback) ---
const Store = {
  db: null,
  async init() {
    return new Promise(resolve => {
      try {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('pets')) db.createObjectStore('pets', { keyPath: 'id' });
          if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
        };
        req.onsuccess = e => { this.db = e.target.result; resolve(); };
        req.onerror = () => { console.warn('IndexedDB failed, using localStorage'); resolve(); };
      } catch (e) { resolve(); }
    });
  },
  async savePet(pet) {
    const data = { id: pet.id, name: pet.name, icon: pet.icon, signature: pet.signature, createdAt: pet.createdAt };
    if (this.db) {
      return new Promise(r => {
        const tx = this.db.transaction('pets', 'readwrite');
        tx.objectStore('pets').put(data);
        tx.oncomplete = () => r();
        tx.onerror = () => { localStorage.setItem('pet_' + data.id, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem('pet_' + data.id, JSON.stringify(data));
  },
  async getAllPets() {
    if (this.db) {
      return new Promise(r => {
        const req = this.db.transaction('pets', 'readonly').objectStore('pets').getAll();
        req.onsuccess = () => r(req.result || []);
        req.onerror = () => r(this._lsPets());
      });
    }
    return this._lsPets();
  },
  _lsPets() {
    const pets = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith('pet_')) { try { pets.push(JSON.parse(localStorage.getItem(k))); } catch (e) {} }
    }
    return pets;
  },
  async deletePet(id) {
    if (this.db) {
      return new Promise(r => { const tx = this.db.transaction('pets', 'readwrite'); tx.objectStore('pets').delete(id); tx.oncomplete = () => r(); });
    }
    localStorage.removeItem('pet_' + id);
  },
  async clearAll() {
    if (this.db) {
      const tx = this.db.transaction(['pets', 'settings'], 'readwrite');
      tx.objectStore('pets').clear();
      tx.objectStore('settings').clear();
    }
    localStorage.clear();
  },
  async saveSetting(key, value) {
    if (this.db) {
      return new Promise(r => { const tx = this.db.transaction('settings', 'readwrite'); tx.objectStore('settings').put({ key, value }); tx.oncomplete = () => r(); });
    }
    localStorage.setItem('s_' + key, JSON.stringify(value));
  },
  async getSetting(key, def) {
    if (this.db) {
      return new Promise(r => {
        const req = this.db.transaction('settings', 'readonly').objectStore('settings').get(key);
        req.onsuccess = () => r(req.result ? req.result.value : def);
        req.onerror = () => r(def);
      });
    }
    const v = localStorage.getItem('s_' + key);
    return v !== null ? JSON.parse(v) : def;
  }
};

// --- KALMAN FILTER (Per-Pet Signal Smoothing) ---
class KalmanFilter {
  constructor() { this.x = -70; this.p = 4; this.Q = 2; this.R = 25; }
  update(z) {
    const pPred = this.p + this.Q;
    const K = pPred / (pPred + this.R);
    this.x = this.x + K * (z - this.x);
    this.p = (1 - K) * pPred;
    return this.x;
  }
  reset() { this.x = -70; this.p = 4; }
}

// --- RING BUFFER ---
class RingBuffer {
  constructor(size) { this.size = size; this.buf = []; }
  push(v) { this.buf.push(v); if (this.buf.length > this.size) this.buf.shift(); }
  get data() { return this.buf; }
  get length() { return this.buf.length; }
  get last() { return this.buf[this.buf.length - 1]; }
  clear() { this.buf = []; }
  slice(a, b) { return this.buf.slice(a, b); }
}

// --- PET CLASS (Fully Isolated State) ---
class Pet {
  constructor(data) {
    this.id = data.id || 'pet_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);
    this.name = data.name || 'My Pet';
    this.icon = data.icon || 'üê∂';
    this.createdAt = data.createdAt || Date.now();
    this.signature = data.signature || {};

    // Real-time state (NOT persisted)
    this.kalman = new KalmanFilter();
    this.rssiRing = new RingBuffer(MAX_RSSI_SAMPLES);
    this.lastSeenMs = 0;
    this.lastRawRssi = null;
    this.smoothedRssi = -100;

    // Zone state machine
    this.zone = {
      stable: 'SAFE',
      candidate: 'SAFE',
      candidateCount: 0,
      candidateSinceMs: 0,
      lastAlertMs: 0
    };

    // Trend
    this.trendArrow = '‚Üí';
  }

  processRssi(rssi, now) {
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;

    // 1. Kalman smooth
    this.smoothedRssi = this.kalman.update(rssi);
    this.rssiRing.push(this.smoothedRssi);

    // 2. Compute instant zone (with hysteresis)
    const sr = this.smoothedRssi;
    const prev = this.zone.stable;
    let instant;

    if (prev === 'SAFE') {
      if (sr <= ZONE_THRESHOLDS.dangerEnter) instant = 'DANGER';
      else if (sr <= ZONE_THRESHOLDS.warningEnter) instant = 'WARNING';
      else if (sr <= ZONE_THRESHOLDS.cautionEnter) instant = 'CAUTION';
      else instant = 'SAFE';
    } else if (prev === 'CAUTION') {
      if (sr <= ZONE_THRESHOLDS.dangerEnter) instant = 'DANGER';
      else if (sr <= ZONE_THRESHOLDS.warningEnter) instant = 'WARNING';
      else if (sr > ZONE_THRESHOLDS.cautionExit) instant = 'SAFE';
      else instant = 'CAUTION';
    } else if (prev === 'WARNING') {
      if (sr <= ZONE_THRESHOLDS.dangerEnter) instant = 'DANGER';
      else if (sr > ZONE_THRESHOLDS.warningExit) instant = 'CAUTION';
      else instant = 'WARNING';
    } else if (prev === 'DANGER') {
      if (sr > ZONE_THRESHOLDS.dangerExit) instant = 'WARNING';
      else instant = 'DANGER';
    } else {
      // Coming back from LOST
      if (sr <= ZONE_THRESHOLDS.dangerEnter) instant = 'DANGER';
      else if (sr <= ZONE_THRESHOLDS.warningEnter) instant = 'WARNING';
      else if (sr <= ZONE_THRESHOLDS.cautionEnter) instant = 'CAUTION';
      else instant = 'SAFE';
    }

    // 3. Stabilize (anti-flapping)
    if (instant === this.zone.candidate) {
      this.zone.candidateCount++;
    } else {
      this.zone.candidate = instant;
      this.zone.candidateCount = 1;
      this.zone.candidateSinceMs = now;
    }

    const stableCondition =
      this.zone.candidateCount >= ZONE_CONFIRM_COUNT ||
      (now - this.zone.candidateSinceMs >= ZONE_CONFIRM_MS && this.zone.candidateCount >= 2);

    if (stableCondition && this.zone.candidate !== this.zone.stable) {
      const prevStable = this.zone.stable;
      this.zone.stable = this.zone.candidate;

      // Alert on escalation only + cooldown
      if (ZONE_ORDER[this.zone.stable] > ZONE_ORDER[prevStable] &&
          (now - this.zone.lastAlertMs > ALERT_COOLDOWN_MS)) {
        this.zone.lastAlertMs = now;
        App.triggerAlert(this);
      }
    }

    // 4. Trend arrow
    if (this.rssiRing.length >= 8) {
      const recent = median(this.rssiRing.slice(-4));
      const older = median(this.rssiRing.slice(-8, -4));
      const diff = recent - older;
      if (diff > 3) this.trendArrow = '‚Üë';
      else if (diff < -3) this.trendArrow = '‚Üì';
      else this.trendArrow = '‚Üí';
    }
  }

  markLost(now) {
    if (this.zone.stable !== 'LOST') {
      this.zone.stable = 'LOST';
      this.zone.candidate = 'LOST';
      this.zone.candidateCount = 99;
      this.trendArrow = '‚úï';
      if (now - this.zone.lastAlertMs > ALERT_COOLDOWN_MS) {
        this.zone.lastAlertMs = now;
        App.triggerAlert(this);
      }
    }
  }

  getLastSeenText(now) {
    if (!this.lastSeenMs) return 'Never';
    const sec = Math.round((now - this.lastSeenMs) / 1000);
    if (sec < 2) return 'Just now';
    if (sec < 60) return sec + 's ago';
    if (sec < 3600) return Math.floor(sec / 60) + 'm ago';
    return 'Long ago';
  }

  toJSON() {
    return { id: this.id, name: this.name, icon: this.icon, signature: this.signature, createdAt: this.createdAt };
  }
}

// --- BLE ENGINE (Advertisement Scanning) ---
const BLE = {
  scanning: false,
  scanReq: null,
  _handler: null,
  restartCount: 0,
  restartWindowStart: 0,
  supported: false,

  checkSupport() {
    if (!navigator.bluetooth) return false;
    if (typeof navigator.bluetooth.requestLEScan !== 'function') return false;
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      if (!location.protocol.startsWith('file')) return false;
    }
    return true;
  },

  async startScan(mode) {
    if (this.scanning) return true;
    this.supported = this.checkSupport();
    if (!this.supported) return false;

    try {
      // Register handler once
      if (!this._handler) {
        this._handler = (event) => App.onAdvertisement(event);
        navigator.bluetooth.addEventListener('advertisementreceived', this._handler);
      }

      const options = { acceptAllAdvertisements: true, keepRepeatedDevices: true };
      this.scanReq = await navigator.bluetooth.requestLEScan(options);
      this.scanning = true;
      return true;
    } catch (e) {
      console.error('BLE scan error:', e);
      if (e.name === 'NotAllowedError') Toast.show('‚ö†Ô∏è Bluetooth permission denied. Please allow access.');
      else Toast.show('‚ö†Ô∏è Scan failed: ' + (e.message || 'Unknown error'));
      return false;
    }
  },

  stopScan() {
    if (this.scanReq) { try { this.scanReq.stop(); } catch (e) {} }
    this.scanning = false;
  },

  async restartScan() {
    const now = Date.now();
    if (now - this.restartWindowStart > 60000) {
      this.restartCount = 0;
      this.restartWindowStart = now;
    }
    if (this.restartCount >= MAX_RESTARTS_PER_MIN) return;
    this.restartCount++;
    this.stopScan();
    await new Promise(r => setTimeout(r, 500));
    await this.startScan('track');
  }
};

// --- MATCH SCORE (Advertisement ‚Üí Pet) ---
function matchScore(event, signature) {
  if (!signature) return 0;
  let score = 0;
  const devName = event.device.name || '';
  const devId = event.device.id || '';

  // Device ID match (strongest signal)
  if (signature.deviceId && devId === signature.deviceId) score += 0.6;

  // Name match
  if (signature.nameExact && devName === signature.nameExact) score += 0.5;
  else if (signature.namePrefix && devName.toLowerCase().startsWith(signature.namePrefix.toLowerCase())) score += 0.3;

  // Service UUID match
  if (signature.serviceUuids && event.uuids) {
    const evUuids = event.uuids.map(u => u.toString().toLowerCase());
    const matches = signature.serviceUuids.filter(u => evUuids.includes(u.toLowerCase()));
    if (matches.length > 0) score += 0.25;
  }

  // Manufacturer data match
  if (signature.manufacturerId !== undefined && event.manufacturerData) {
    event.manufacturerData.forEach((value, key) => {
      if (key === signature.manufacturerId) score += 0.2;
    });
  }

  // Boost for confirmed tags
  if (signature.confirmed) score = Math.min(1.0, score * 1.15);

  return Math.min(1.0, score);
}

// --- WIZARD ---
const Wizard = {
  candidates: {},
  selectedId: null,
  selectedSig: null,
  baselineRssi: null,
  verified: false,
  chosenIcon: 'üê∂',
  scanTimer: null,
  verifyTimer: null,

  open() {
    $('wizard-overlay').classList.add('active');
    this.candidates = {};
    this.selectedId = null;
    this.selectedSig = null;
    this.baselineRssi = null;
    this.verified = false;
    this.chosenIcon = 'üê∂';
    this._showStep(1);
    this._startScan();
    this._buildIconPicker();
  },

  close() {
    $('wizard-overlay').classList.remove('active');
    clearInterval(this.scanTimer);
    clearInterval(this.verifyTimer);
    if (App.pets.length > 0 && !BLE.scanning) BLE.startScan('track');
  },

  _showStep(n) {
    document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
    $('wiz-step-' + n).classList.add('active');
    for (let i = 1; i <= 3; i++) {
      const pill = $('sp-' + i);
      pill.className = 'step-pill';
      if (i < n) pill.classList.add('done');
      else if (i === n) pill.classList.add('current');
    }
  },

  async _startScan() {
    $('scan-status').textContent = 'Starting scan...';
    $('scan-list').innerHTML = '';
    this.candidates = {};

    const ok = await BLE.startScan('register');
    if (!ok) {
      $('scan-status').textContent = '‚ö†Ô∏è BLE not supported. Showing demo devices.';
      this._startDemoScan();
      return;
    }
    $('scan-status').textContent = 'üì° Scanning... Hold tag close to phone.';
    clearInterval(this.scanTimer);
    this.scanTimer = setInterval(() => this._renderCandidates(), 1000);
  },

  _startDemoScan() {
    const demoDevices = [
      { id: 'demo_itag_001', name: 'iTAG' },
      { id: 'demo_finder_002', name: 'Key Finder' },
      { id: 'demo_unknown_003', name: '' },
      { id: 'demo_buds_004', name: 'Galaxy Buds Pro' },
    ];
    let tick = 0;
    clearInterval(this.scanTimer);
    this.scanTimer = setInterval(() => {
      const dev = demoDevices[tick % demoDevices.length];
      const rssi = dev.name === 'iTAG' ? -48 - Math.random() * 8 : -65 - Math.random() * 25;
      this.handleAdv({ device: { id: dev.id, name: dev.name }, rssi, uuids: [] });
      tick++;
      this._renderCandidates();
    }, 300);
  },

  handleAdv(event) {
    const id = event.device.id || ('unknown_' + Math.random().toString(36).slice(2, 8));
    const name = event.device.name || '';
    const rssi = event.rssi;
    if (typeof rssi !== 'number' || isNaN(rssi)) return;

    if (!this.candidates[id]) {
      this.candidates[id] = {
        id, name, rssiSamples: new RingBuffer(30),
        firstSeen: Date.now(), lastSeen: 0,
        uuids: event.uuids || [], manufacturerData: null
      };
    }
    const c = this.candidates[id];
    c.rssiSamples.push(rssi);
    c.lastSeen = Date.now();
    if (event.manufacturerData) c.manufacturerData = event.manufacturerData;
    if (name && !c.name) c.name = name;
  },

  _tagLikelihood(c) {
    let score = 0;
    const med = median(c.rssiSamples.data);
    // Proximity (closer = higher)
    score += clamp((med + 100) / 50, 0, 1) * 40;
    // Repeatability
    score += clamp(c.rssiSamples.length / 15, 0, 1) * 25;
    // Stability (low variance = better)
    if (c.rssiSamples.length >= 5) {
      const m = median(c.rssiSamples.data);
      const variance = c.rssiSamples.data.reduce((s, v) => s + (v - m) ** 2, 0) / c.rssiSamples.length;
      score += clamp(1 - variance / 200, 0, 1) * 15;
    }
    // Name hint
    const n = (c.name || '').toLowerCase();
    if (/itag|finder|anti.?lost|isearch|key|tile|nut|tag/.test(n)) score += 15;
    // Penalize known non-tags
    if (/buds|watch|band|airpod|galaxy|pixel|bose|sony|jbl|speaker|headphone|tv|car/.test(n)) score -= 30;
    return Math.round(clamp(score, 0, 100));
  },

  _renderCandidates() {
    const now = Date.now();
    const arr = Object.values(this.candidates)
      .filter(c => now - c.lastSeen < 6000 && c.rssiSamples.length >= 2)
      .map(c => ({ ...c, med: median(c.rssiSamples.data), score: this._tagLikelihood(c) }))
      .sort((a, b) => b.score - a.score)
      .slice(0, 8);

    if (arr.length === 0) {
      $('scan-list').innerHTML = '<div class="text-center" style="color:var(--text-muted);padding:20px">No devices found yet...</div>';
      return;
    }

    $('scan-list').innerHTML = arr.map(c => {
      const pct = clamp((c.med + 100) * 2, 0, 100);
      const color = pct > 60 ? 'var(--accent-green)' : pct > 30 ? 'var(--accent-yellow)' : 'var(--accent-red)';
      const sel = this.selectedId === c.id;
      return `<div class="scan-item ${sel ? 'selected' : ''}" onclick="Wizard.selectCandidate('${c.id}')">
        <div>
          <div class="scan-item-name">${c.name || '‚ü®Unknown Tag‚ü©'}</div>
          <div class="scan-item-id">${c.id.length > 16 ? c.id.slice(0, 8) + '‚Ä¶' + c.id.slice(-4) : c.id}</div>
          <div class="tag-score">Tag likelihood: ${c.score}%</div>
        </div>
        <div class="scan-item-right">
          <div class="scan-rssi" style="color:${color}">${Math.round(c.med)} dBm</div>
          <div class="rssi-bar-track"><div class="rssi-bar-fill" style="width:${pct}%;background:${color}"></div></div>
        </div>
      </div>`;
    }).join('');
  },

  selectCandidate(id) {
    this.selectedId = id;
    const c = this.candidates[id];
    if (!c) return;
    this.selectedSig = {
      deviceId: c.id,
      nameExact: c.name || null,
      namePrefix: c.name ? c.name.slice(0, Math.min(6, c.name.length)) : null,
      serviceUuids: c.uuids && c.uuids.length ? c.uuids.map(u => u.toString()) : null,
      confirmed: false
    };
    this._renderCandidates();
    setTimeout(() => this._goStep2(), 400);
  },

  _goStep2() {
    this._showStep(2);
    const c = this.candidates[this.selectedId];
    if (!c) return;
    this.baselineRssi = median(c.rssiSamples.slice(-6));
    this.verified = false;
    $('verify-delta').textContent = '0';
    $('verify-delta').style.color = 'var(--text-muted)';
    $('verify-status').textContent = 'Waiting for movement...';
    $('verify-status').style.color = 'var(--text-muted)';
    $('btn-verified').classList.add('hidden');
    $('btn-skip-verify').classList.remove('hidden');

    clearInterval(this.verifyTimer);
    this.verifyTimer = setInterval(() => {
      const cc = this.candidates[this.selectedId];
      if (!cc || cc.rssiSamples.length < 3) return;
      const current = median(cc.rssiSamples.slice(-4));
      const delta = this.baselineRssi - current;
      $('verify-delta').textContent = Math.round(delta);

      if (delta >= 10) {
        $('verify-delta').style.color = 'var(--accent-green)';
        $('verify-status').textContent = '‚úÖ Signal drop confirmed! This is your tag.';
        $('verify-status').style.color = 'var(--accent-green)';
        $('btn-verified').classList.remove('hidden');
        $('btn-skip-verify').classList.add('hidden');
        this.verified = true;
        clearInterval(this.verifyTimer);
      } else if (delta >= 5) {
        $('verify-delta').style.color = 'var(--accent-yellow)';
        $('verify-status').textContent = 'Keep moving the tag further away...';
      } else {
        $('verify-delta').style.color = 'var(--text-muted)';
      }
    }, 500);
  },

  skipVerify() {
    this.verified = false;
    clearInterval(this.verifyTimer);
    this.goStep3();
  },

  goStep3() {
    clearInterval(this.verifyTimer);
    if (this.selectedSig) this.selectedSig.confirmed = this.verified;
    this._showStep(3);
    $('input-name').value = '';
    $('input-name').focus();
  },

  _buildIconPicker() {
    $('icon-picker').innerHTML = ICONS.map(ic =>
      `<div class="icon-opt ${ic === this.chosenIcon ? 'selected' : ''}" onclick="Wizard.pickIcon('${ic}')">${ic}</div>`
    ).join('');
  },

  pickIcon(ic) {
    this.chosenIcon = ic;
    this._buildIconPicker();
  },

  rescan() {
    this.candidates = {};
    this.selectedId = null;
    $('scan-list').innerHTML = '';
    $('scan-status').textContent = 'üì° Re-scanning...';
    if (!BLE.scanning) this._startScan();
  },

  async save() {
    const name = ($('input-name').value || '').trim() || 'My Pet';
    const pet = new Pet({
      id: 'pet_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6),
      name,
      icon: this.chosenIcon,
      signature: this.selectedSig || {},
      createdAt: Date.now()
    });
    App.addPet(pet);
    await Store.savePet(pet);
    Toast.show('üéâ ' + name + ' is now protected!');
    this.close();
    if (!BLE.scanning) BLE.startScan('track');
  }
};

// --- WEB AUDIO (Simple alert sounds) ---
const Audio = {
  ctx: null,
  _getCtx() {
    if (!this.ctx) {
      try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {}
    }
    return this.ctx;
  },
  beep(freq, dur, vol) {
    const ctx = this._getCtx();
    if (!ctx) return;
    try {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq || 800;
      gain.gain.value = vol || 0.3;
      osc.start();
      osc.stop(ctx.currentTime + (dur || 0.2));
    } catch (e) {}
  },
  alertForZone(zone) {
    if (zone === 'CAUTION') this.beep(600, 0.15, 0.2);
    else if (zone === 'WARNING') { this.beep(800, 0.15, 0.3); setTimeout(() => this.beep(800, 0.15, 0.3), 200); }
    else if (zone === 'DANGER') { this.beep(1000, 0.2, 0.5); setTimeout(() => this.beep(1200, 0.2, 0.5), 250); setTimeout(() => this.beep(1400, 0.3, 0.5), 500); }
    else if (zone === 'LOST') { this.beep(400, 0.4, 0.5); setTimeout(() => this.beep(300, 0.5, 0.5), 500); }
  }
};

// --- SOS MODULE ---
const SOS = {
  active: false,
  holdTimer: null,
  strobeTimer: null,
  targetPet: null,
  hcHistory: new RingBuffer(12),
  savedLocation: null,

  holdStart() {
    this.holdTimer = setTimeout(() => this.activate(), 2000);
  },
  holdEnd() {
    clearTimeout(this.holdTimer);
  },

  activate() {
    this.active = true;
    const pet = this.targetPet || (App.pets.length ? App.pets[0] : null);
    $('sos-active-name').textContent = pet ? pet.name : 'PET';
    $('sos-active').classList.add('active');
    if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
    Audio.beep(1000, 0.5, 0.7);
    this._startStrobe();
  },

  deactivate() {
    this.active = false;
    $('sos-active').classList.remove('active');
    clearInterval(this.strobeTimer);
    $('sos-strobe-area').style.background = '';
  },

  _startStrobe() {
    let on = false;
    this.strobeTimer = setInterval(() => {
      $('sos-strobe-area').style.background = on ? '#fff' : '#e74c3c';
      $('sos-active').style.background = on ? '#300' : '#000';
      on = !on;
    }, 400);
  },

  updateHC(rssi) {
    this.hcHistory.push(rssi);
    if (this.hcHistory.length < 6) return;
    const recent = median(this.hcHistory.slice(-3));
    const older = median(this.hcHistory.slice(-6, -3));
    const diff = recent - older;
    const elA = $('hc-arrow'), elT = $('hc-text'), elR = $('hc-rssi');
    elR.textContent = Math.round(recent) + ' dBm';

    if (diff > 3) { elA.textContent = 'üî•'; elT.textContent = 'HOT ‚Äî Getting Closer!'; elT.style.color = 'var(--zone-danger)'; }
    else if (diff < -3) { elA.textContent = 'üßä'; elT.textContent = 'COLD ‚Äî Moving Away'; elT.style.color = 'var(--accent-blue)'; }
    else { elA.textContent = '‚û°Ô∏è'; elT.textContent = 'STEADY ‚Äî Keep searching'; elT.style.color = 'var(--text-muted)'; }
  },

  updateSnapshot(pet) {
    if (!pet) return;
    const now = Date.now();
    const lines = [
      `<strong>${pet.name}</strong> ${pet.icon}`,
      `Status: <span style="color:var(--zone-${pet.zone.stable.toLowerCase()})">${pet.zone.stable}</span>`,
      `Last seen: ${pet.getLastSeenText(now)}`,
      `Signal: ${pet.lastRawRssi !== null ? Math.round(pet.smoothedRssi) + ' dBm' : 'N/A'}`,
      `Trend: ${pet.trendArrow}`
    ];
    if (this.savedLocation) lines.push(`üìç ${this.savedLocation.lat.toFixed(5)}, ${this.savedLocation.lon.toFixed(5)}`);
    $('sos-snapshot').innerHTML = lines.join('<br>');
  },

  async saveLocation() {
    if (!navigator.geolocation) { Toast.show('üìç Geolocation not available'); return; }
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 10000 }));
      this.savedLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude, time: Date.now() };
      Toast.show('üìç Location saved!');
      const pet = this.targetPet || App.pets[0];
      if (pet) this.updateSnapshot(pet);
    } catch (e) {
      Toast.show('üìç Could not get location: ' + (e.message || 'Permission denied'));
    }
  },

  shareMessage() {
    const pet = this.targetPet || (App.pets.length ? App.pets[0] : null);
    let msg = 'üö® LOST PET ALERT\n';
    if (pet) {
      msg += `Name: ${pet.name}\n`;
      msg += `Last signal: ${pet.getLastSeenText(Date.now())}\n`;
      msg += `Status: ${pet.zone.stable}\n`;
    }
    if (this.savedLocation) {
      msg += `Location: ${this.savedLocation.lat.toFixed(5)}, ${this.savedLocation.lon.toFixed(5)}\n`;
      msg += `Map: https://maps.google.com/?q=${this.savedLocation.lat},${this.savedLocation.lon}\n`;
    }
    msg += '\nSent via Santa Claus AI (mcorpai.org)';

    if (navigator.share) {
      navigator.share({ title: 'Lost Pet Alert', text: msg }).catch(() => {});
    } else {
      navigator.clipboard.writeText(msg).then(() => Toast.show('üìã Copied to clipboard!')).catch(() => Toast.show('Could not copy'));
    }
  },

  renderPetSelect() {
    if (App.pets.length === 0) return;
    const html = App.pets.map(p =>
      `<button class="btn btn-sm ${this.targetPet && this.targetPet.id === p.id ? 'btn-success' : 'btn-secondary'}" style="margin:0 4px 4px 0" onclick="SOS.selectPet('${p.id}')">${p.icon} ${p.name}</button>`
    ).join('');
    $('sos-pet-select').innerHTML = '<div class="section-title" style="margin-top:0">Select Pet</div>' + html;
  },

  selectPet(id) {
    this.targetPet = App.pets.find(p => p.id === id) || null;
    this.hcHistory.clear();
    this.renderPetSelect();
    if (this.targetPet) this.updateSnapshot(this.targetPet);
  }
};

// --- NAVIGATION ---
const Nav = {
  current: 'home',
  go(tab) {
    this.current = tab;
    document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
    $('panel-' + tab).classList.add('active');
    document.querySelectorAll('.bnav-btn').forEach(el => {
      el.classList.toggle('active', el.dataset.tab === tab);
    });
    if (tab === 'sos') {
      if (App.pets.length > 0) {
        $('sos-no-pets').classList.add('hidden');
        $('sos-content').classList.remove('hidden');
        if (!SOS.targetPet && App.pets.length) SOS.selectPet(App.pets[0].id);
        SOS.renderPetSelect();
      } else {
        $('sos-no-pets').classList.remove('hidden');
        $('sos-content').classList.add('hidden');
      }
    }
    if (tab === 'settings') Settings.renderPetList();
  }
};

// --- SETTINGS ---
const Settings = {
  prefs: { sound: true, vibrate: true },

  async load() {
    this.prefs.sound = await Store.getSetting('sound', true);
    this.prefs.vibrate = await Store.getSetting('vibrate', true);
    this._updateToggles();
  },

  toggle(key) {
    this.prefs[key] = !this.prefs[key];
    Store.saveSetting(key, this.prefs[key]);
    this._updateToggles();
  },

  _updateToggles() {
    const ts = $('toggle-sound');
    const tv = $('toggle-vibrate');
    if (ts) ts.classList.toggle('on', this.prefs.sound);
    if (tv) tv.classList.toggle('on', this.prefs.vibrate);
  },

  renderPetList() {
    const el = $('settings-pet-list');
    if (!App.pets.length) { el.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;padding:8px 0">No pets registered.</div>'; return; }
    el.innerHTML = App.pets.map(p =>
      `<div class="setting-row">
        <div><span style="font-size:1.2rem">${p.icon}</span> <strong>${p.name}</strong>
        <div style="font-size:0.7rem;color:var(--text-muted)">Added ${new Date(p.createdAt).toLocaleDateString()}</div></div>
        <button class="btn btn-danger-outline btn-sm" onclick="Settings.removePet('${p.id}')">Remove</button>
      </div>`
    ).join('');
  },

  async removePet(id) {
    if (!confirm('Remove this pet? You can re-add it later.')) return;
    await Store.deletePet(id);
    App.pets = App.pets.filter(p => p.id !== id);
    App.render();
    this.renderPetList();
    Toast.show('Pet removed');
    if (App.pets.length === 0) BLE.stopScan();
  },

  resetApp() {
    if (!confirm('‚ö†Ô∏è DELETE ALL DATA? This cannot be undone.')) return;
    if (!confirm('Are you absolutely sure?')) return;
    Store.clearAll();
    location.reload();
  }
};

// --- DATA MANAGER (Export/Import) ---
const DataManager = {
  async exportAll() {
    const pets = App.pets.map(p => p.toJSON());
    const data = { version: '3.0', exported: new Date().toISOString(), pets, settings: Settings.prefs };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'santa-ai-backup-' + Date.now() + '.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('üì§ Backup exported!');
  },

  importFile() { $('import-input').click(); },

  async handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data.pets || !Array.isArray(data.pets)) throw new Error('Invalid backup');
      for (const pd of data.pets) {
        const pet = new Pet(pd);
        App.pets.push(pet);
        await Store.savePet(pet);
      }
      if (data.settings) {
        Settings.prefs = { ...Settings.prefs, ...data.settings };
        await Store.saveSetting('sound', Settings.prefs.sound);
        await Store.saveSetting('vibrate', Settings.prefs.vibrate);
      }
      App.render();
      Toast.show('üì• ' + data.pets.length + ' pet(s) imported!');
    } catch (e) {
      Toast.show('‚ö†Ô∏è Import failed: ' + e.message);
    }
    event.target.value = '';
  }
};

// --- HELP ---
const Help = {
  open() {
    $('help-overlay').classList.add('active');
    $('help-body').innerHTML = this._content();
  },
  close() { $('help-overlay').classList.remove('active'); },
  _content() {
    return `
    <h2 style="margin-bottom:12px">üìñ How to Use Santa Claus AI</h2>
    <div class="tip-card info">
      <div class="tip-title">Step 1: Get a BLE Tag</div>
      <div class="tip-body">Buy any cheap Bluetooth tag ($2‚Äì5). Look for: "iTag", "Key Finder", "Anti-lost". Uses CR2032 battery. No app needed.</div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">Step 2: Register Your Tag</div>
      <div class="tip-body">Tap "+ Add New Pet" on Home screen. Hold tag close to phone (2‚Äì5 cm). Select the strongest signal. Move tag away to verify. Name your pet and save.</div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">Step 3: Track Automatically</div>
      <div class="tip-body">Once saved, your pet is tracked automatically. The app shows 5 zones: SAFE (green), CAUTION (yellow), WARNING (orange), DANGER (red), LOST (purple).</div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">SOS Mode</div>
      <div class="tip-body">If your pet goes missing: Go to SOS tab. Hold SOS button 3 seconds for alarm + strobe. Use Hot & Cold tracker to find direction. Save location and share alert message.</div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">Multiple Pets</div>
      <div class="tip-body">Add as many pets as needed. Each gets a separate tag and independent tracking. Dangerous pets are highlighted automatically.</div>
    </div>
    <div class="tip-card info">
      <div class="tip-title">Important Limitations</div>
      <div class="tip-body">
        ‚Ä¢ This is NOT GPS. It measures Bluetooth signal strength (proximity only).<br>
        ‚Ä¢ Walls, metal, and crowds reduce signal range.<br>
        ‚Ä¢ Best on Android Chrome. iOS support is limited.<br>
        ‚Ä¢ Screen lock may pause scanning. Keep screen on when actively tracking.<br>
        ‚Ä¢ Tag battery (CR2032) lasts 6‚Äì12 months.
      </div>
    </div>

    <div class="divider"></div>
    <h3>‚öñÔ∏è Legal & License</h3>
    <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.6;margin-top:8px">
      <p><strong>M-Corp Ethical AI License</strong> (Hippocratic 3.0 Derivative)</p>
      <p style="margin-top:6px">PERMITTED: Humanitarian, animal welfare, education, research.</p>
      <p>PROHIBITED: Military, surveillance, weapons, tracking individuals, oppression.</p>
      <p style="margin-top:6px">Legal basis: UDHR, Geneva Convention IV, UNCRC, CRPD, GDPR Art. 25.</p>
      <p style="margin-top:6px"><strong>DISCLAIMER:</strong> THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. Bluetooth distance estimates are approximations only. This is not a substitute for physical supervision of pets.</p>
      <p style="margin-top:8px"><strong>Ten Principles of Ethical AI</strong></p>
      <p>1. Minimize hallucinations ‚Äî Statistical methods with known error bounds</p>
      <p>2. Ensure transparency ‚Äî 100% open-source, every line auditable</p>
      <p>3. Guarantee accessibility ‚Äî Works on $50 phones with $2 tags</p>
      <p>4. Eliminate data exploitation ‚Äî Zero data collection, no servers</p>
      <p>5. Operate in low-resource environments ‚Äî No internet required</p>
      <p>6. Remove legal liability ‚Äî No data controller, comprehensive disclaimers</p>
      <p>7. Affordable ‚Äî $2 tag is all you need</p>
      <p>8. Emphasize simplicity ‚Äî Single file, no build tools</p>
      <p>9. Non-specialist friendly ‚Äî Guided setup, clear instructions</p>
      <p>10. Allow simple deletion ‚Äî Erase all data with one tap</p>
      <p style="margin-top:8px">¬© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI</p>
      <p>Contact: contact@mcorpai.org | mcorpai.org</p>
    </div>`;
  }
};

// --- MAIN APP ---
const App = {
  pets: [],
  watchdogTimer: null,
  renderTimer: null,
  demoTimer: null,
  demoMode: false,

  async init() {
    // Ethical self-identification (Layer 3)
    console.log('%cüéÖ Santa Claus AI v3.0 ‚Äî M-Corp Ethical AI', 'font-size:16px;font-weight:bold;color:#c0392b');
    console.log('%cHumanitarian use only. Military/surveillance use PROHIBITED.', 'color:#e67e22');
    console.log('%cLicense: Hippocratic 3.0 Derivative | UDHR | Geneva | GDPR', 'color:#8b949e');
    console.log('%c' + JSON.stringify(ETHICAL_MANIFEST.prohibited), 'color:#e74c3c');

    await Store.init();
    await Settings.load();

    // Load saved pets
    const saved = await Store.getAllPets();
    this.pets = saved.map(d => new Pet(d));

    this.render();

    // Auto-start tracking if pets exist
    if (this.pets.length > 0) {
      const ok = await BLE.startScan('track');
      if (!ok) {
        Toast.show('üì° BLE not available. Using demo mode.');
        this._startDemo();
      }
    }

    // Watchdog
    this.watchdogTimer = setInterval(() => this._watchdog(), WATCHDOG_INTERVAL_MS);

    // UI render loop (batched, not per-event)
    this.renderTimer = setInterval(() => this.render(), UI_RENDER_INTERVAL_MS);

    // Visibility change
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && this.pets.length > 0 && !BLE.scanning && !this.demoMode) {
        BLE.restartScan();
      }
    });

    // PWA
    this._registerPWA();

    // Notifications
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  },

  onAdvertisement(event) {
    const now = Date.now();

    // Wizard mode
    if ($('wizard-overlay').classList.contains('active')) {
      Wizard.handleAdv(event);
      return;
    }

    // Multi-pet matching
    const rssi = event.rssi;
    if (typeof rssi !== 'number' || isNaN(rssi)) return;

    let bestPet = null, bestScore = 0;
    for (const pet of this.pets) {
      const sc = matchScore(event, pet.signature);
      if (sc > bestScore) { bestScore = sc; bestPet = pet; }
    }

    const threshold = (bestPet && bestPet.signature && bestPet.signature.confirmed) ? 0.40 : 0.55;
    if (bestPet && bestScore >= threshold) {
      bestPet.processRssi(rssi, now);

      // SOS hot/cold
      if (SOS.targetPet && SOS.targetPet.id === bestPet.id) {
        SOS.updateHC(rssi);
        SOS.updateSnapshot(bestPet);
      }
    }
  },

  addPet(pet) {
    this.pets.push(pet);
    this.render();
  },

  triggerAlert(pet) {
    if (Settings.prefs.sound) Audio.alertForZone(pet.zone.stable);
    if (Settings.prefs.vibrate && navigator.vibrate) {
      const patterns = { CAUTION: [100], WARNING: [200, 100, 200], DANGER: [400, 100, 400], LOST: [500, 200, 500, 200, 500] };
      navigator.vibrate(patterns[pet.zone.stable] || [100]);
    }
    if ('Notification' in window && Notification.permission === 'granted') {
      try { new Notification(pet.icon + ' ' + pet.name + ': ' + pet.zone.stable, { body: 'Santa Claus AI Alert', silent: true }); } catch (e) {}
    }
  },

  _watchdog() {
    const now = Date.now();
    for (const pet of this.pets) {
      if (!pet.lastSeenMs) continue;
      const silence = now - pet.lastSeenMs;

      if (silence > LOST_THRESHOLD_MS) {
        pet.markLost(now);
      }
      if (silence > RESTART_THRESHOLD_MS && BLE.scanning) {
        BLE.restartScan();
      }
    }
  },

  render() {
    const now = Date.now();
    const list = $('pet-list');
    const empty = $('empty-state');
    const controls = $('dash-controls');

    if (this.pets.length === 0) {
      list.innerHTML = '';
      empty.classList.remove('hidden');
      controls.classList.add('hidden');
      return;
    }

    empty.classList.add('hidden');
    controls.classList.remove('hidden');

    // Sort: LOST > DANGER > WARNING > CAUTION > SAFE, then by lastSeen
    const sorted = [...this.pets].sort((a, b) => {
      const za = ZONE_ORDER[a.zone.stable] || 0;
      const zb = ZONE_ORDER[b.zone.stable] || 0;
      if (zb !== za) return zb - za;
      return (a.lastSeenMs || 0) - (b.lastSeenMs || 0);
    });

    list.innerHTML = sorted.map(pet => {
      const z = pet.zone.stable.toLowerCase();
      const isLost = pet.zone.stable === 'LOST';
      const rssiDisplay = isLost ? '--' : Math.round(pet.smoothedRssi);
      const lastSeen = pet.getLastSeenText(now);

      return `<div class="pet-card zone-${z}" onclick="Nav.go('sos');SOS.selectPet('${pet.id}')">
        <div class="pet-icon-circle">${pet.icon}</div>
        <div class="pet-details">
          <div class="pet-name">${pet.name}</div>
          <div class="pet-status-row">
            <div class="status-dot" style="background:var(--zone-${z})"></div>
            <span>${isLost ? 'NO SIGNAL' : pet.zone.stable}</span>
            <span style="margin-left:auto;font-size:0.7rem;color:var(--text-muted)">${lastSeen}</span>
          </div>
        </div>
        <div class="pet-signal">
          <div class="pet-rssi">${rssiDisplay}<span class="trend-arrow">${pet.trendArrow}</span></div>
          <span class="zone-badge ${z}">${pet.zone.stable}</span>
        </div>
      </div>`;
    }).join('');
  },

  // --- DEMO MODE ---
  _startDemo() {
    if (this.demoMode) return;
    this.demoMode = true;
    let tick = 0;
    this.demoTimer = setInterval(() => {
      const now = Date.now();
      this.pets.forEach((pet, i) => {
        // Simulate different patterns per pet
        const base = -65 - i * 8;
        const wave = Math.sin((tick + i * 30) / 15) * 18;
        const noise = (Math.random() - 0.5) * 6;
        const rssi = base + wave + noise;
        pet.processRssi(rssi, now);

        if (SOS.targetPet && SOS.targetPet.id === pet.id) {
          SOS.updateHC(rssi);
          SOS.updateSnapshot(pet);
        }
      });
      tick++;
    }, 600);
  },

  // --- PWA ---
  _registerPWA() {
    const manifest = {
      name: 'Santa Claus AI', short_name: 'SantaAI',
      description: 'Offline Pet Safety System',
      start_url: '.', display: 'standalone',
      background_color: '#0d1117', theme_color: '#c0392b',
      icons: [{ src: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üéÖ</text></svg>'), sizes: '512x512', type: 'image/svg+xml' }]
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const link = $('pwa-manifest');
    if (link) link.href = URL.createObjectURL(blob);

    if ('serviceWorker' in navigator) {
      const sw = `const C='santa-ai-v30';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])));self.skipWaiting()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))))});`;
      const swBlob = new Blob([sw], { type: 'application/javascript' });
      navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(() => {});
    }
  }
};

// --- BOOTSTRAP ---
document.addEventListener('DOMContentLoaded', () => App.init());
</script>

<!-- ============================================================
     SANTA CLAUS AI v3.0 ‚Äî COPYRIGHT & ETHICAL NOTICE
     
     ¬© 2026 Morgan J. (Gyu-min Jeon)
     M-Corp Ethical AI | https://mcorpai.org
     Managed by: https://mediatorsfoundation.org
     Contact: contact@mcorpai.org
     
     M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
     HUMANITARIAN USE ONLY.
     
     PROHIBITED USES: Military operations, mass surveillance,
     weapons systems, individual tracking, political oppression,
     unlawful interception, border militarization.
     
     Legal basis: UDHR Articles 3,5,12,13 | Geneva Convention IV |
     UNCRC Articles 3,16 | CRPD Article 22 | GDPR Article 25 |
     Wassenaar Arrangement | EU Regulation 2021/821
     
     TEN PRINCIPLES OF ETHICAL AI:
     1. Minimize hallucinations
     2. Ensure transparency
     3. Guarantee accessibility
     4. Eliminate data exploitation
     5. Operate in low-resource environments
     6. Remove legal liability
     7. Affordable
     8. Emphasize simplicity
     9. Non-specialist friendly
     10. Collect no data, allow simple deletion
     
     Zero data collection. All AI processing on-device only.
     GDPR-compliant by design (Article 25: Data Protection by Default).
     ============================================================ -->
</body>
</html>
