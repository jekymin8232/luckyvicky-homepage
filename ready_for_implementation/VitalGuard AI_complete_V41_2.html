<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#c0392b">
<title>VitalGuard AI v4.1.2 â€” Lifeâ€‘Saving Offline AI Demo</title>
<link rel="manifest" id="pwa-manifest">
<style>
/* ============================================================
   VitalGuard AI v4.1.2 â€” MASTER STYLESHEET
   Â© 2026 Morgan J. (Gyu-min Jeon) | M-Corp Ethical AI
   https://mcorpai.org | contact@mcorpai.org
   Managed by: https://mcorpai.org
   M-Corp Ethical AI License (Hippocratic 3.0 Derivative)
   Humanitarian use only. Military/surveillance use prohibited.
   Zero External Dependencies | 100% Offline | Vanilla CSS/JS
   ============================================================ */
:root{--bg-primary:#0d1117;--bg-secondary:#161b22;--bg-card:#1c2333;--bg-elevated:#21283b;--text-primary:#e6edf3;--text-secondary:#8b949e;--text-muted:#6e7681;--accent-red:#c0392b;--accent-green:#2ecc71;--accent-yellow:#f1c40f;--accent-orange:#e67e22;--accent-blue:#3498db;--zone-safe:#2ecc71;--zone-caution:#f1c40f;--zone-warning:#e67e22;--zone-danger:#e74c3c;--zone-lost:#9b59b6;--border-color:#30363d;--radius-sm:8px;--radius-md:12px;--radius-lg:20px;--shadow-soft:0 2px 12px rgba(0,0,0,.3);--tr-fast:.15s ease;--tr-norm:.3s ease;--font-body:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;--font-mono:'Courier New',Courier,monospace}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;user-select:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg-primary)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
#app{max-width:480px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:72px}
.header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);padding:14px 20px 10px;text-align:center;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:100}
.header-logo{font-size:2rem}.header-title{font-family:'Georgia',serif;font-size:1.4rem;color:var(--accent-red);letter-spacing:1px;text-shadow:0 0 20px rgba(192,57,43,.4)}
.header-sub{font-size:.68rem;color:var(--text-muted);margin-top:2px}
.header-mission{font-size:.62rem;color:var(--accent-blue);margin-top:3px;font-style:italic;opacity:.85;line-height:1.3}
.header-disclaimer{font-size:.58rem;color:var(--accent-orange);margin-top:3px;line-height:1.3;opacity:.9}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;z-index:100;max-width:480px;margin:0 auto}
.bnav-btn{flex:1;padding:8px 4px 6px;text-align:center;cursor:pointer;border:none;background:none;color:var(--text-muted);font-size:.63rem;font-family:var(--font-body);display:flex;flex-direction:column;align-items:center;gap:2px;transition:color var(--tr-fast)}
.bnav-btn .bnav-icon{font-size:1.3rem}.bnav-btn.active{color:var(--accent-red)}.bnav-btn:active{opacity:.7}
.panel{display:none;padding:16px;animation:fadeIn .25s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-color);padding:14px;margin-bottom:10px}
.pet-card{display:flex;align-items:center;gap:12px;padding:14px;margin-bottom:10px;background:var(--bg-card);border-radius:var(--radius-md);border:2px solid var(--border-color);transition:all var(--tr-norm);cursor:pointer;position:relative}
.pet-card:active{transform:scale(.98)}
.pet-card.zone-safe{border-color:rgba(46,204,113,.4)}.pet-card.zone-caution{border-color:rgba(241,196,15,.5)}.pet-card.zone-warning{border-color:rgba(230,126,34,.6)}.pet-card.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 15px rgba(231,76,60,.25);animation:pulseDanger 1.2s ease infinite}.pet-card.zone-lost{border-color:var(--zone-lost);opacity:.85}
@keyframes pulseDanger{0%,100%{box-shadow:0 0 15px rgba(231,76,60,.25)}50%{box-shadow:0 0 25px rgba(231,76,60,.45)}}
.pet-icon-circle{width:48px;height:48px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0}
.pet-details{flex:1;min-width:0}.pet-name{font-weight:700;font-size:.95rem;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pet-status-row{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text-secondary)}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pet-signal{text-align:right;flex-shrink:0}.pet-rssi{font-size:.9rem;font-weight:600;font-family:var(--font-mono);line-height:1}
.trend-arrow{font-size:.7rem;margin-left:2px}
.zone-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.6rem;font-weight:700;letter-spacing:.5px;margin-top:3px;color:#000}
.zone-badge.safe{background:var(--zone-safe)}.zone-badge.caution{background:var(--zone-caution)}.zone-badge.warning{background:var(--zone-warning)}.zone-badge.danger{background:var(--zone-danger);color:#fff}.zone-badge.lost{background:var(--zone-lost);color:#fff}
.pet-conf{font-size:.6rem;color:var(--text-muted);margin-top:2px}
.pet-why{font-size:.58rem;color:var(--accent-orange);margin-top:1px;font-style:italic}
.section-title{font-size:.85rem;font-weight:700;margin-bottom:10px;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.btn{padding:10px 18px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:var(--font-body);font-size:.85rem;font-weight:600;transition:all var(--tr-fast);text-align:center}
.btn:active{transform:scale(.96)}.btn-primary{background:var(--accent-red);color:#fff}.btn-success{background:var(--accent-green);color:#000}
.btn-secondary{background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-danger-outline{background:transparent;color:var(--zone-danger);border:1px solid var(--zone-danger);font-size:.75rem;padding:6px 12px}
.btn-sm{font-size:.75rem;padding:6px 12px}.btn-block{width:100%}
.btn-add{background:linear-gradient(135deg,var(--accent-red),#e74c3c);color:#fff;font-size:1rem;padding:14px;border-radius:var(--radius-md);width:100%;margin-top:8px;box-shadow:var(--shadow-soft)}
.hidden{display:none!important}
.text-center{text-align:center}.text-muted{color:var(--text-muted)}
.divider{height:1px;background:var(--border-color);margin:16px 0}
.empty-state{text-align:center;padding:40px 20px}.empty-icon{font-size:3.5rem;margin-bottom:12px}.empty-text{color:var(--text-secondary);font-size:.9rem;line-height:1.5}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);color:var(--text-primary);padding:10px 20px;border-radius:var(--radius-lg);font-size:.82rem;z-index:9999;border:1px solid var(--border-color);box-shadow:var(--shadow-soft);white-space:nowrap;max-width:90%}
/* OVERLAY */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:200;overflow-y:auto;padding:0}
.overlay.active{display:block}.overlay-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border-color);position:sticky;top:0;background:var(--bg-primary);z-index:10}
.overlay-title{font-weight:700;font-size:1.05rem}.overlay-close{background:none;border:none;color:var(--text-primary);font-size:1.4rem;cursor:pointer;padding:4px 8px}
.overlay-body{padding:16px 20px 80px}
/* WIZARD */
.wizard-step{display:none}.wizard-step.active{display:block}
.step-pills{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
.step-pill{width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);color:var(--text-muted);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;border:2px solid var(--border-color)}
.step-pill.current{border-color:var(--accent-red);color:var(--accent-red)}.step-pill.done{background:var(--accent-green);color:#000;border-color:var(--accent-green)}
.scan-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px;border:2px solid transparent;cursor:pointer;transition:all var(--tr-fast)}
.scan-item.selected{border-color:var(--accent-green);background:rgba(46,204,113,.08)}
.scan-item-name{font-weight:600;font-size:.85rem}.scan-item-id{font-size:.65rem;color:var(--text-muted);font-family:var(--font-mono)}
.tag-score{font-size:.65rem;color:var(--accent-blue);margin-top:2px}
.scan-item-right{text-align:right}.scan-rssi{font-size:.85rem;font-weight:600;font-family:var(--font-mono)}
.rssi-bar-track{width:60px;height:4px;background:var(--bg-primary);border-radius:2px;margin-top:4px}
.rssi-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.icon-picker{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
.icon-opt{width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border-radius:var(--radius-sm);background:var(--bg-elevated);border:2px solid transparent;cursor:pointer}
.icon-opt.selected{border-color:var(--accent-green);background:rgba(46,204,113,.1)}
/* SOS */
.sos-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;flex-direction:column;align-items:center;justify-content:center;background:#000}
.sos-active.active{display:flex}
.sos-active-text{font-size:2rem;font-weight:900;color:#fff;text-align:center;padding:20px;letter-spacing:2px}
.hc-display{text-align:center;padding:20px;background:var(--bg-card);border-radius:var(--radius-md);margin:10px 0}
.hc-arrow{font-size:3rem;display:block;margin-bottom:8px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color)}
.toggle{width:44px;height:24px;border-radius:12px;background:var(--bg-elevated);border:1px solid var(--border-color);position:relative;cursor:pointer;transition:all var(--tr-fast);flex-shrink:0}
.toggle::after{content:'';width:20px;height:20px;border-radius:50%;background:var(--text-muted);position:absolute;top:1px;left:1px;transition:all var(--tr-fast)}
.toggle.on{background:var(--accent-green);border-color:var(--accent-green)}.toggle.on::after{left:22px;background:#fff}
/* TIP CARDS */
.tip-card{padding:14px;border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--accent-blue);background:var(--bg-card)}
.tip-card.warn{border-left-color:var(--accent-orange)}.tip-card.danger{border-left-color:var(--zone-danger)}
.tip-card.info{border-left-color:var(--accent-blue)}
.tip-title{font-weight:700;font-size:.85rem;margin-bottom:4px}.tip-body{font-size:.78rem;color:var(--text-secondary);line-height:1.5}
/* PET DETAIL OVERLAY */
.detail-ring{width:160px;height:160px;border-radius:50%;border:6px solid var(--zone-safe);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:20px auto;transition:all .5s;position:relative}
.detail-ring.zone-safe{border-color:var(--zone-safe);box-shadow:0 0 30px rgba(46,204,113,.2)}.detail-ring.zone-caution{border-color:var(--zone-caution);box-shadow:0 0 30px rgba(241,196,15,.3)}.detail-ring.zone-warning{border-color:var(--zone-warning);box-shadow:0 0 30px rgba(230,126,34,.3)}.detail-ring.zone-danger{border-color:var(--zone-danger);box-shadow:0 0 40px rgba(231,76,60,.4);animation:pulseDanger 1.2s ease infinite}.detail-ring.zone-lost{border-color:var(--zone-lost);box-shadow:0 0 30px rgba(155,89,182,.3)}
.detail-dist{font-size:2rem;font-weight:900;line-height:1}.detail-unit{font-size:.7rem;color:var(--text-muted)}.detail-zone{font-size:.75rem;font-weight:700;margin-top:4px}
.rssi-meter{height:8px;background:var(--bg-elevated);border-radius:4px;margin:8px 0;overflow:hidden}.rssi-meter-fill{height:100%;border-radius:4px;transition:width .4s,background .4s}
.signal-bars{display:flex;gap:3px;align-items:flex-end;justify-content:center;height:20px;margin:8px 0}
.signal-bars .bar{width:6px;border-radius:2px;background:var(--text-muted);transition:background .3s}
.alert-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:.75rem;border-bottom:1px solid rgba(48,54,61,.5)}
.alert-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:6px}
/* LEASH PRESETS */
.leash-row{display:flex;gap:6px;margin:8px 0}.leash-btn{flex:1;padding:8px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);cursor:pointer;font-size:.75rem;font-weight:600;transition:all var(--tr-fast)}
.leash-btn.active{border-color:var(--accent-green);color:var(--accent-green);background:rgba(46,204,113,.08)}
.slider-row{display:flex;align-items:center;gap:8px;margin:6px 0}
.slider-row label{font-size:.72rem;color:var(--text-secondary);min-width:55px}
.slider-row input[type=range]{flex:1;accent-color:var(--accent-blue)}
.slider-row .val{font-size:.72rem;color:var(--accent-blue);min-width:50px;text-align:right;font-family:var(--font-mono)}
/* CHARITY */
.charity-box{background:linear-gradient(135deg,rgba(46,204,113,.08),rgba(52,152,219,.08));border:1px solid rgba(46,204,113,.25);border-radius:var(--radius-md);padding:14px;margin:10px 0;text-align:center}
.charity-box p{font-size:.8rem;margin:4px 0}
.highlight-box{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:14px;margin:10px 0}
.highlight-box p{font-size:.8rem;margin:4px 0;line-height:1.5;color:var(--text-secondary)}
.warning-legal{background:rgba(231,76,60,.06);border:1px solid rgba(231,76,60,.2);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.warning-legal p{font-size:.78rem;margin:3px 0;color:var(--text-secondary)}
.perf-select{display:flex;gap:4px;margin:8px 0}.perf-opt{flex:1;padding:8px 4px;text-align:center;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-muted);cursor:pointer;font-size:.68rem;font-weight:600}
.perf-opt.active{border-color:var(--accent-blue);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.rescue-card{background:linear-gradient(135deg,rgba(192,57,43,.08),rgba(231,76,60,.05));border:2px solid rgba(192,57,43,.3);border-radius:var(--radius-md);padding:16px;margin:10px 0;text-align:center}
.rescue-id{font-size:1.6rem;font-weight:900;font-family:var(--font-mono);letter-spacing:4px;color:var(--accent-red);margin:8px 0}
.collapsible-header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;cursor:pointer;border-bottom:1px solid var(--border-color)}
.collapsible-header .arrow{transition:transform .2s}.collapsible-header.open .arrow{transform:rotate(90deg)}
.collapsible-body{display:none;padding:12px 0}.collapsible-body.open{display:block}


/* ============================================================
   V4.1 UI & FEATURE ADDITIONS
   (Merged from V20 feature set + V35 engine hardening + V38 layout ideas)
   ============================================================ */
.header-links{margin-top:6px;font-size:.62rem;color:var(--text-muted);display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.header-link{color:var(--accent-blue);text-decoration:none;border-bottom:1px dotted rgba(52,152,219,.45);padding-bottom:1px}
.header-link:active{opacity:.7}
.header-link-sep{opacity:.45}
.lang-select{background:var(--bg-elevated);border:1px solid var(--border-color);color:var(--text-primary);border-radius:10px;padding:4px 8px;font-size:.62rem}
.lang-select:focus{outline:2px solid rgba(52,152,219,.35);outline-offset:2px}


.install-banner{display:none;background:rgba(52,152,219,.12);border-bottom:1px solid rgba(52,152,219,.25);padding:10px 14px;font-size:.72rem}
.install-banner.active{display:flex;align-items:center;justify-content:space-between;gap:10px}
.install-banner .btn{padding:6px 10px;font-size:.7rem}

.file-warning{background:rgba(241,196,15,.08);border:1px solid rgba(241,196,15,.25);border-radius:var(--radius-md);padding:12px;margin:10px 0}
.file-warning .title{font-weight:800;font-size:.78rem;color:var(--accent-yellow);margin-bottom:6px}
.file-warning .body{font-size:.72rem;color:var(--text-secondary);line-height:1.5}
.file-warning .actions{display:flex;gap:8px;margin-top:10px}

.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:.6rem;font-weight:800;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary)}
.badge.ok{border-color:rgba(46,204,113,.35);color:var(--accent-green)}
.badge.med{border-color:rgba(241,196,15,.35);color:var(--accent-yellow)}
.badge.high{border-color:rgba(231,76,60,.35);color:var(--zone-danger)}

.scan-health-row{display:flex;align-items:center;gap:8px;margin:8px 0}
.scan-health-label{font-size:.65rem;color:var(--text-muted);min-width:74px}
.scan-health-bar{flex:1;height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;border:1px solid rgba(48,54,61,.85)}
.scan-health-fill{height:100%;width:0%;background:var(--accent-green);transition:width .35s,background .35s}
.scan-health-meta{font-size:.62rem;color:var(--text-muted);min-width:86px;text-align:right;font-family:var(--font-mono)}

.pet-chips{display:flex;gap:6px;overflow-x:auto;padding:6px 2px 10px;margin-bottom:4px}
.pet-chip{flex:0 0 auto;padding:6px 10px;border-radius:999px;border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-secondary);font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap}
.pet-chip.active{border-color:rgba(52,152,219,.6);color:var(--accent-blue);background:rgba(52,152,219,.08)}
.pet-chip:active{transform:scale(.98)}

.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:10px 0}
.qr-canvas{width:180px;height:180px;border-radius:12px;border:1px solid rgba(48,54,61,.8);background:#fff}

.voice-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.voice-row .btn{flex:1}
.slider-mini{width:100%;accent-color:var(--accent-blue)}

.emergency-active{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:400;background:#000;color:#fff;align-items:center;justify-content:center;flex-direction:column;padding:20px;text-align:center}
.emergency-active.active{display:flex}
.strobe-on{background:#fff!important;color:#000!important}
.emergency-big{font-size:2.1rem;font-weight:900;letter-spacing:1px}
.emergency-sub{font-size:.85rem;color:rgba(255,255,255,.85);line-height:1.4;margin-top:10px;max-width:520px}
.kbd{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-elevated);font-family:var(--font-mono);font-size:.68rem;color:var(--text-secondary)}
</style>
</head>
<body>

<div id="app">
  <!-- INSTALL BANNER (APP INSTALL) -->
  <div id="installBanner" class="install-banner">
    <div>
      <strong id="i18n_install_title">Install VitalGuard AI</strong><br>
      <span id="i18n_install_sub" style="color:var(--text-secondary)">Works better as an installed app â€” faster launch, more reliable Bluetooth behavior.</span>
    </div>
    <div style="display:flex;gap:6px;flex-shrink:0">
      <button class="btn btn-sm btn-secondary" id="installDismiss">Not now</button>
      <button class="btn btn-sm btn-primary" id="installBtn">Install</button>
    </div>
  </div>

  <header class="header">
    <div class="header-logo">ğŸ›¡ï¸</div>
    <div class="header-title" id="i18n_app_title">VitalGuard AI</div>
    <div class="header-sub" id="i18n_app_sub">v4.1.2 â€” Lifeâ€‘Saving Offline AI Demo | McorpAI</div>
    <div class="header-mission" id="i18n_app_mission">Runs fully offline. No cloud. No telemetry. GDPRâ€‘friendly by design.</div>
    <div class="header-disclaimer" id="i18n_app_disclaimer">Demo skin: â€œPet Safety Leashâ€ using Bluetooth proximity (not GPS). Built to keep working when networks fail.</div>
    <div class="header-links">
      <a class="header-link" href="https://github.com/jekymin8232/luckyvicky-homepage" target="_blank" rel="noopener" id="i18n_github_link">GitHub Source</a>
      <span class="header-link-sep">Â·</span>
      <a class="header-link" href="#" onclick="Help.open();return false;" id="i18n_help_link">Help</a>
      <span class="header-link-sep">Â·</span>
      <a class="header-link" href="#" onclick="Legal.open();return false;" id="i18n_about_link">About</a>
      <span class="header-link-sep">Â·</span>
      <select id="langSelect" class="lang-select" aria-label="Language">
        <option value="en">English</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="fr">FranÃ§ais</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡(å°ç£)</option>
        <option value="es">EspaÃ±ol</option>
      </select>
    </div>
  </header>

  <!-- HOME -->
  <div id="panel-home" class="panel active">
    <div id="first-run-banner" class="file-warning hidden">
      <div class="title">âš  Important: Run via HTTPS / localhost for best BLE reliability</div>
      <div class="body">
        You are running from <span class="kbd" id="fr-proto">file://</span>. Some browsers restrict Bluetooth scanning, audio, and background behavior on local files.<br>
        <br>
        Recommended:
        <ul style="margin:8px 0 0 16px;line-height:1.5">
          <li>Use <span class="kbd">https://</span> hosting, or</li>
          <li>Use <span class="kbd">http://localhost</span> (local server), or</li>
          <li>Install as an App (ì•± ì„¤ì¹˜) when available.</li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn btn-secondary btn-sm" onclick="App.dismissFirstRun()">Got it</button>
        <button class="btn btn-sm btn-secondary" onclick="Help.open()">Open Help</button>
      </div>
    </div>

    
    <div id="vgHero" class="card" style="margin-top:12px">
      <div class="section-title" id="i18n_hero_title">ğŸ›¡ï¸ Lifeâ€‘Saving Offline AI Demo</div>
      <div id="i18n_hero_body" style="font-size:.82rem;color:var(--text-secondary);line-height:1.6">
        VitalGuard AI is an offlineâ€‘only AI + Bluetooth proximity demo that keeps working when the cloud is unavailable. It collects no analytics or personal data and stores everything locally on your device.
      </div>
      <div class="small" id="i18n_contact_line" style="margin-top:10px;opacity:.85;text-align:center">Contact: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px">
        <span class="badge ok" id="i18n_badge_offline">100% Offline</span>
        <span class="badge ok" id="i18n_badge_gdpr">GDPRâ€‘friendly</span>
        <span class="badge med" id="i18n_badge_ble">BLE Proximity Mesh</span>
        <span class="badge med" id="i18n_badge_tiny">~100KB AI Engine</span>
      </div>
    </div>
<div id="empty-state" class="empty-state">
      <div class="empty-icon">ğŸ›¡ï¸</div>
      <div class="empty-text" id="i18n_empty_text">No demo tags registered yet.<br>Add a cheap BLE keyâ€‘finder tag to run the offline proximity demo.</div>
      <button class="btn-add" onclick="Wizard.open()" id="i18n_empty_btn">+ Add Demo Tag</button>
    </div>

    <div id="dash-controls" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="section-title" style="margin-bottom:0">ğŸ¾ My Pets</div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm btn-secondary" id="btn-mode-all" onclick="App.setTrackMode('all')" style="font-size:.65rem">Track All</button>
          <button class="btn btn-sm btn-secondary" id="btn-mode-focus" onclick="App.setTrackMode('focus')" style="font-size:.65rem">Focus</button>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div id="scan-status-bar" style="font-size:.68rem;color:var(--text-muted);flex:1;min-width:0"></div>
        <span id="congestionBadge" class="badge ok">LOW</span>
      </div>

      <div id="scan-health-row" class="scan-health-row hidden">
        <div class="scan-health-label">Scan health</div>
        <div class="scan-health-bar"><div id="scan-health-fill" class="scan-health-fill"></div></div>
        <div id="scan-health-meta" class="scan-health-meta">--</div>
      </div>

      <div class="pet-chips hidden" id="pet-chips"></div>

      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" id="btn-scan-toggle" style="flex:1" onclick="App.toggleMonitoring()">â–¶ Start Monitoring</button>
          <button class="btn btn-secondary" id="btn-demo-toggle" style="flex:1" onclick="App.toggleDemo()">ğŸ§ª Demo</button>
        </div>
        <div style="margin-top:10px;font-size:.7rem;color:var(--text-muted);line-height:1.5">
          Tip: Monitoring works best when the screen stays on. In emergencies, use SOS Finder or Emergency Mode.
        </div>
      </div>

      <div id="coach-card" class="card" style="display:none">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ§  Safety Coach</div>
        <div id="coach-body" style="font-size:.78rem;color:var(--text-secondary);line-height:1.55"></div>
      </div>
    </div>

    <div id="pet-list"></div>

    <div id="dash-controls2" class="hidden">
      <button class="btn-add" onclick="Wizard.open()">+ Add New Pet</button>
    </div>
  </div>

  <!-- SOS -->
  <div id="panel-sos" class="panel">
    <div id="sos-no-pets" class="text-center" style="padding:40px 0;color:var(--text-muted)">Add a pet first to use SOS Finder.</div>
    <div id="sos-content" class="hidden">
      <div class="section-title">ğŸ” SOS Pet Finder</div>
      <div id="sos-pet-select"></div>

      <div class="hc-display">
        <div id="hc-arrow" class="hc-arrow">ğŸ”</div>
        <div id="hc-text" style="font-size:.9rem;font-weight:600;margin-bottom:4px">Select a pet to begin</div>
        <div id="hc-rssi" style="font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">--</div>
      </div>

      <div id="sos-snapshot" class="card" style="font-size:.8rem;line-height:1.6"></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.saveLocation()">ğŸ“ Save Location</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SOS.shareMessage()">ğŸ“¤ Share Alert</button>
      </div>

      <div class="card" style="margin-top:12px;text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds for full pet alarm</div>
        <button class="btn btn-primary" style="font-size:1.1rem;padding:16px 30px;border-radius:50px"
          ontouchstart="SOS.holdStart()" ontouchend="SOS.holdEnd()"
          onmousedown="SOS.holdStart()" onmouseup="SOS.holdEnd()"
        >ğŸš¨ SOS ALARM</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ›¡ Personal Emergency Mode</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          For personal safety (siren + strobe + QR contact card). Works even without internet.
        </div>
        <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Open Emergency Mode</button>
      </div>

      <div id="sos-focus-banner" class="hidden" style="margin-top:10px;padding:10px;background:rgba(52,152,219,.1);border:1px solid rgba(52,152,219,.3);border-radius:var(--radius-sm);font-size:.72rem;color:var(--accent-blue);text-align:center">
        ğŸ¯ Focus Mode ON â€” tracking only selected pet for best accuracy
      </div>
    </div>
  </div>

  <!-- TIPS -->
  <div id="panel-tips" class="panel">
    <div class="section-title" id="i18n_tips_title">ğŸ“‹ Demo Guide & Field Notes</div>
    <div id="tipsI18n"></div>
  </div>

  <!-- SETTINGS -->
<div id="panel-settings" class="panel">
    <div class="section-title">âš™ï¸ Settings</div>

    <div class="card">
      <div class="setting-row"><span style="font-size:.82rem">ğŸ”Š Sound</span><div class="toggle" id="toggle-sound" onclick="Settings.toggle('sound')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">ğŸ“³ Vibration</span><div class="toggle" id="toggle-vibrate" onclick="Settings.toggle('vibrate')"></div></div>
      <div class="setting-row"><span style="font-size:.82rem">ğŸ”” Notifications</span><div class="toggle" id="toggle-notif" onclick="Settings.toggleNotif()"></div></div>
      <div id="notif-hint" class="hidden" style="font-size:.72rem;color:var(--accent-orange);margin-top:8px">Enable notifications in browser settings if denied.</div>
      <div class="setting-row"><span style="font-size:.82rem">âš¡ High Alert Mode</span><div class="toggle" id="toggle-highalert" onclick="Settings.toggle('highAlert')"></div></div>

      <div style="margin-top:12px">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Performance</div>
        <div class="perf-select">
          <div class="perf-opt" id="perf-saver" onclick="Settings.setPerf('saver')">Saver</div>
          <div class="perf-opt active" id="perf-balanced" onclick="Settings.setPerf('balanced')">Balanced</div>
          <div class="perf-opt" id="perf-fast" onclick="Settings.setPerf('fast')">Fast</div>
        </div>
        <div style="font-size:.68rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
          Saver reduces battery use. Fast increases responsiveness (may use more CPU/battery).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ™ Voice & Audio Tools</div>

      <div class="setting-row">
        <span style="font-size:.82rem">ğŸ§  Voice Recall (play your voice on CAUTION)</span>
        <div class="toggle" id="toggle-voiceRecall" onclick="Settings.toggle('voiceRecall')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Example: Record â€œCome here!â€ and it will play when your pet enters CAUTION zone (best effort).
      </div>
      <div class="voice-row">
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">ğŸ™ Record 5s</button>
        <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">â–¶ Play</button>
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">ğŸ—£ Voice Announcer (TTS)</span>
        <div class="toggle" id="toggle-tts" onclick="Settings.toggle('tts')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Speaks zone changes (requires device voices). If blocked, use sound/vibration instead.
      </div>

      <div class="divider"></div>

      <div class="setting-row">
        <span style="font-size:.82rem">ğŸ§ Audio Keepalive (prevents suspension)</span>
        <div class="toggle" id="toggle-keepAlive" onclick="Settings.toggle('keepAlive')"></div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);line-height:1.45;margin-top:6px">
        Uses a near-silent audio signal to keep monitoring alive on some devices. May slightly increase battery usage.
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:.78rem;color:var(--text-secondary)">Master volume</span>
          <span id="volumeVal" style="font-size:.72rem;color:var(--text-muted);font-family:var(--font-mono)">70%</span>
        </div>
        <input id="volumeSlider" class="slider-mini" type="range" min="0" max="100" value="70" oninput="Settings.setVolume(this.value)">
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ›¡ Emergency Mode</div>
      <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
        Personal siren + strobe + QR contact card. Configure once, then activate quickly when needed.
      </div>
      <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="Emergency.open()">Configure / Activate</button>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ¾ Registered Pets</div>
      <div id="settings-pet-list"></div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ’¾ Backup & Data</div>
      <button class="btn btn-secondary btn-block" onclick="DataManager.exportAll()">â¬‡ï¸ Export Backup (JSON)</button>
      <input type="file" id="import-input" accept="application/json" style="display:none" onchange="DataManager.handleImport(event)">
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="DataManager.importFile()">â¬†ï¸ Import Backup</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Diag.open()">ğŸ§ª Diagnostics</button>
      <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="Settings.resetApp()">ğŸ—‘ï¸ RESET ALL DATA</button>
      <div style="font-size:.7rem;color:var(--text-muted);margin-top:10px;line-height:1.45">
        Backups stay on your device. No cloud. No tracking. You can delete everything anytime.
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ“š Guides</div>
      <button class="btn btn-secondary btn-block" onclick="Help.open()">Open Help</button>
      <button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="Legal.open()">About & Legal</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bnav-btn active" data-tab="home" onclick="Nav.go('home')"><span class="bnav-icon">ğŸ </span><span>Home</span></button>
    <button class="bnav-btn" data-tab="sos" onclick="Nav.go('sos')"><span class="bnav-icon">ğŸš¨</span><span>SOS</span></button>
    <button class="bnav-btn" data-tab="tips" onclick="Nav.go('tips')"><span class="bnav-icon">ğŸ“‹</span><span>Tips</span></button>
    <button class="bnav-btn" data-tab="settings" onclick="Nav.go('settings')"><span class="bnav-icon">âš™ï¸</span><span>Settings</span></button>
  </nav>

  <!-- WIZARD OVERLAY -->
  <div id="wizard-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="wizard-title">Add Demo Tag Wizard</div>
      <button class="overlay-close" onclick="Wizard.close()">âœ•</button>
    </div>
    <div class="overlay-body">
      <div class="step-pills">
        <div class="step-pill current" id="sp-1">1</div>
        <div class="step-pill" id="sp-2">2</div>
        <div class="step-pill" id="sp-3">3</div>
      </div>

      <!-- STEP 1 -->
      <div class="wizard-step active" id="wiz-step-1">
        <div class="tip-card info">
          <div class="tip-title">Step 1 â€” Scan nearby BLE tags</div>
          <div class="tip-body">Hold the tag <strong>2â€“5 cm</strong> from your phone for 10 seconds. Pick the strongest signal.</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div id="scan-status" style="font-size:.75rem;color:var(--text-muted)">Starting scan...</div>
          <button class="btn btn-sm btn-secondary" onclick="Wizard.rescan()">ğŸ”„ Rescan</button>
        </div>
        <div id="scan-list" style="margin-top:10px"></div>
      </div>

      <!-- STEP 2 -->
      <div class="wizard-step" id="wiz-step-2">
        <div class="tip-card info">
          <div class="tip-title">Step 2 â€” Verify (reduce false matches)</div>
          <div class="tip-body">Move the tag <strong>2â€“3 meters</strong> away. We confirm a noticeable signal drop.</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:.72rem;color:var(--text-muted)">Signal drop</div>
          <div id="verify-delta" style="font-size:2rem;font-weight:900;margin:6px 0">0</div>
          <div id="verify-status" style="font-size:.8rem;color:var(--text-muted)">Waiting for movement...</div>
          <button class="btn btn-success btn-block hidden" id="btn-verified" style="margin-top:12px" onclick="Wizard.goStep3()">âœ… Verified</button>
          <button class="btn btn-secondary btn-block" id="btn-skip-verify" style="margin-top:12px" onclick="Wizard.skipVerify()">Skip</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin-bottom:8px">ğŸ“ Optional: Distance Calibration</div>
          <div style="font-size:.75rem;color:var(--text-secondary);line-height:1.5">
            For better distance estimates (still approximate): record RSSI at known distances.
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(1)">Record 1m</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Wizard.recordCalib(10)">Record 10m</button>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:.72rem;color:var(--text-muted)">
            <span>1m: <span id="calib-1m">--</span></span>
            <span>10m: <span id="calib-10m">--</span></span>
          </div>
          <button class="btn btn-sm btn-secondary" style="margin-top:10px;width:100%" onclick="Wizard.clearCalib()">Clear calibration</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="wizard-step" id="wiz-step-3">
        <div class="tip-card info">
          <div class="tip-title">Step 3 â€” Name your pet</div>
          <div class="tip-body">Choose an icon and a name. You can change it later.</div>
        </div>

        <div style="margin-top:12px">
          <div class="icon-picker" id="icon-picker"></div>

          <div style="margin-top:10px">
            <label style="font-size:.72rem;color:var(--text-secondary)">Pet Name</label>
            <input id="input-name" type="text" placeholder="My Pet" style="width:100%;margin-top:6px;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
          </div>

          <button class="btn btn-primary btn-block" id="btn-wiz-save" style="margin-top:14px" onclick="Wizard.save()">âœ… Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAIL OVERLAY -->
  <div id="detail-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="detail-title">Pet</div>
      <button class="overlay-close" onclick="Detail.close()">âœ•</button>
    </div>
    <div class="overlay-body" id="detail-body"></div>
  </div>

  <!-- HELP OVERLAY -->
  <div id="help-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="i18n_help_title">Help</div>
      <button class="overlay-close" onclick="Help.close()">âœ•</button>
    </div>
    <div class="overlay-body" id="help-body"></div>
  </div>

  <!-- LEGAL OVERLAY -->
  <div id="legal-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title" id="i18n_legal_title">About</div>
      <button class="overlay-close" onclick="Legal.close()">âœ•</button>
    </div>
    <div class="overlay-body" id="legal-body"></div>
  </div>

  <!-- DIAGNOSTICS OVERLAY -->
  <div id="diag-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Diagnostics</div>
      <button class="overlay-close" onclick="Diag.close()">âœ•</button>
    </div>
    <div class="overlay-body" id="diag-body"></div>
  </div>

  <!-- EMERGENCY OVERLAY -->
  <div id="emg-overlay" class="overlay">
    <div class="overlay-header">
      <div class="overlay-title">Emergency Mode</div>
      <button class="overlay-close" onclick="Emergency.close()">âœ•</button>
    </div>
    <div class="overlay-body" id="emg-body"></div>
  </div>

  <!-- SOS ACTIVE SCREEN -->
  <div id="sos-active" class="sos-active" onclick="SOS.deactivate()">
    <div id="sos-strobe-area" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.2"></div>
    <div class="sos-active-text">ğŸš¨ SOS<br><span id="sos-active-name">PET</span></div>
    <div style="font-size:.75rem;color:#fff;opacity:.8">Tap screen to stop</div>
  </div>

  <!-- EMERGENCY ACTIVE SCREEN -->
  <div id="emergency-active" class="emergency-active">
    <div id="emg-strobe" style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:.25"></div>
    <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center">
      <div class="emergency-big">ğŸ›¡ EMERGENCY</div>
      <div id="emg-active-name" style="margin-top:8px;font-size:1.05rem;font-weight:800"></div>
      <div id="emg-active-sub" class="emergency-sub"></div>
      <div class="qr-wrap">
        <canvas id="emg-qr" class="qr-canvas" width="180" height="180"></canvas>
        <div style="font-size:.72rem;color:rgba(255,255,255,.85)">Scan for contact info</div>
      </div>
      <div style="display:flex;gap:10px;width:100%;max-width:360px;margin-top:12px">
        <a id="emg-call" class="btn btn-primary" style="flex:1;text-decoration:none;text-align:center" href="#">ğŸ“ Call</a>
        <button class="btn btn-secondary" style="flex:1" onclick="Emergency.share()">ğŸ“¤ Share</button>
      </div>
      <button class="btn btn-danger-outline" style="margin-top:14px" onclick="Emergency.deactivate()">Stop Siren</button>
      <div style="margin-top:10px;font-size:.7rem;color:rgba(255,255,255,.75)">Tip: If Shake SOS is enabled, shaking your phone will activate Emergency.</div>
    </div>
  </div>

</div>

<script>

/* ============================================================
   VitalGuard AI v4.1.2 (V4.1.2)
   - Merged: V20 feature richness + V35 engine hardening + V38 UI ideas
   - Vanilla HTML/CSS/JS, single-file, offline-first.
   - Ethical AI License: Hippocratic 3.0 Derivative (Humanitarian use only)
   ============================================================ */

'use strict';

/* ----------------------------- CONFIG ----------------------------- */
const APP_VERSION = '4.1.2';
const SCHEMA_VERSION = 2;

// Backward compatibility (do not change)
const DB_NAME = 'VitalGuardAI_V41';
const DB_VERSION = 2; // v3.9+ adds optional blob store
const LS_PREFIX = 'vg41_';

const MAX_RSSI_SAMPLES = 60;
const ZONE_CONFIRM_COUNT = 4; // v4.1: more stable zone transitions
const ZONE_CONFIRM_MS = 2000; // v4.1: more stable zone transitions
const ALERT_COOLDOWN_MS = 20000;
const MAX_RESTARTS_PER_MIN = 3;

// High Alert tightens RSSI boundaries by +10 dBm (stronger signal required)
const HIGH_ALERT_SHRINK = 10;

// Collision gap from V35 (0.08)
const GAP_MIN = 0.08;
const MATCH_THRESHOLD_CONFIRMED = 0.40;
const MATCH_THRESHOLD_UNCONFIRMED = 0.55;

// Icons
const ICONS = ['ğŸ¶','ğŸ±','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¹','ğŸ¯','ğŸµ','ğŸ¸','ğŸ¦®','ğŸ•','ğŸ©','ğŸˆ','ğŸ¾','ğŸ¦œ','ğŸ¦','ğŸ¢','ğŸ ','ğŸ¦'];

// Leash presets
const DEFAULT_THRESHOLDS = {
  cautionEnter:-65, cautionExit:-60,
  warningEnter:-78, warningExit:-72,
  dangerEnter:-88, dangerExit:-82
};

const LEASH_PRESETS = {
  '5m':  {cautionEnter:-58,cautionExit:-53,warningEnter:-68,warningExit:-63,dangerEnter:-78,dangerExit:-73},
  '10m': {cautionEnter:-65,cautionExit:-60,warningEnter:-78,warningExit:-72,dangerEnter:-88,dangerExit:-82},
  '15m': {cautionEnter:-72,cautionExit:-67,warningEnter:-85,warningExit:-79,dangerEnter:-94,dangerExit:-88}
};

const PERF_PROFILES = {
  saver:    {petInterval:1200, renderInterval:800,  lostMs:12000, restartMs:18000, restartCooldown:22000, scanStallMs:12000, globalThrottleMs:140},
  balanced: {petInterval:800,  renderInterval:450,  lostMs:9000,  restartMs:14000, restartCooldown:15000, scanStallMs:9000,  globalThrottleMs:80},
  fast:     {petInterval:500,  renderInterval:300,  lostMs:7000,  restartMs:10000, restartCooldown:9000,  scanStallMs:6500,  globalThrottleMs:60}
};

const ZONE_ORDER = {SAFE:0, CAUTION:1, WARNING:2, DANGER:3, LOST:4};

/* ----------------------------- UTILS ----------------------------- */
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function median(arr) {
  if(!arr || !arr.length) return 0;
  const s=[...arr].sort((a,b)=>a-b);
  const m=Math.floor(s.length/2);
  return s.length%2?s[m]:(s[m-1]+s[m])/2;
}
function genRescueId() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r='';
  for(let i=0;i<8;i++) r+=c[Math.floor(Math.random()*c.length)];
  return r;
}
function fmtAgo(ms) {
  if(!ms) return '--';
  const s=Math.max(0, Math.round(ms/100)/10); // 0.1s precision
  if(s<1) return s.toFixed(1)+'s';
  if(s<60) return Math.round(s)+'s';
  const m=Math.floor(s/60);
  return m+'m';
}
function safeJson(obj) {
  try { return JSON.stringify(obj, null, 2); } catch(e){ return '{"error":"json_failed"}'; }
}
function nowMs(){ return Date.now(); }

/* ----------------------------- ETHICAL MANIFEST ----------------------------- */
const ETHICAL_MANIFEST = {
  version: APP_VERSION,
  license: 'Hippocratic 3.0 Derivative',
  purpose: 'Humanitarian pet safety for low-income families',
  prohibited: ['military','surveillance','weapons','individual_tracking','oppression','border_militarization'],
  principles: ['minimize_hallucinations','transparency','accessibility','no_data_exploitation','low_resource','no_liability','affordable','simplicity','non_specialist','allow_deletion']
};

/* ----------------------------- STATE ----------------------------- */
let perfProfile = PERF_PROFILES.balanced;
let globalLastProcessMs = 0;

/* ----------------------------- TOAST ----------------------------- */
const Toast = {
  show(msg, dur=2500) {
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=msg;
    document.body.appendChild(el);
    setTimeout(()=>{
      el.style.opacity='0';
      el.style.transition='0.3s';
      setTimeout(()=>el.remove(),300);
    }, dur);
  }
};


/* ----------------------------- I18N (7 Languages) ----------------------------- */
/*
  VitalGuard AI is intended to be shown to non-technical audiences (diplomats, NGOs, universities, companies).
  This tiny i18n layer keeps everything in a single offline HTML file (no libraries, no network).
*/
const I18N = (function(){
  const STORAGE_KEY = 'vg_lang_v412';
  const RTL_LANGS = new Set(['ar']);

  const STR = {
    en: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” Lifeâ€‘Saving Offline AI Demo | McorpAI',
      app_mission: 'Runs fully offline. No cloud. No telemetry. GDPRâ€‘friendly by design.',
      app_disclaimer: 'Demo skin: â€œPet Safety Leashâ€ using Bluetooth proximity (not GPS). Built to keep working when networks fail.',
      github: 'GitHub Source',
      help: 'Help',
      about: 'About',
      help_title: 'Help',
      legal_title: 'About',
      tips_title: 'ğŸ“‹ Demo Guide & Field Notes',
      install_title: 'Install VitalGuard AI',
      empty_text: 'No demo tags registered yet.<br>Add a cheap BLE keyâ€‘finder tag to run the offline proximity demo.',
      empty_btn: '+ Add Demo Tag',
      hero_title: 'ğŸ›¡ï¸ Lifeâ€‘Saving Offline AI Demo',
      hero_body: 'VitalGuard AI is an offlineâ€‘only AI + Bluetooth proximity demo that keeps working when the cloud is unavailable. It collects no analytics or personal data and stores everything locally on your device.',
      badge_offline: '100% Offline',
      badge_gdpr: 'GDPRâ€‘friendly',
      badge_ble: 'BLE Proximity Mesh',
      badge_tiny: '~100KB AI Engine',
      contact_line: 'Contact: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Home',
      nav_sos: 'SOS',
      nav_tips: 'Guide',
      nav_settings: 'Settings',
      install_sub: 'Works better as an installed app â€” faster launch, more reliable Bluetooth behavior.',
      install_btn: 'Install',
      install_dismiss: 'Not now'
    },
    ko: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” ìƒëª…ì„ êµ¬í•˜ëŠ” ì˜¤í”„ë¼ì¸ AI ë°ëª¨ | McorpAI',
      app_mission: 'ì™„ì „ ì˜¤í”„ë¼ì¸. í´ë¼ìš°ë“œ ì—†ìŒ. ì¶”ì (í…”ë ˆë©”íŠ¸ë¦¬) ì—†ìŒ. GDPR ì¹œí™” ì„¤ê³„.',
      app_disclaimer: 'ë°ëª¨ ìŠ¤í‚¨: â€œê°•ì•„ì§€ ì•ˆì „ ëª©ì¤„(Pet Safety Leash)â€ â€” ë¸”ë£¨íˆ¬ìŠ¤ ê·¼ì ‘( GPS ì•„ë‹˜ ). ë„¤íŠ¸ì›Œí¬ê°€ ëŠê²¨ë„ ë™ì‘í•˜ë„ë¡ ì„¤ê³„.',
      github: 'GitHub ì†ŒìŠ¤',
      help: 'ì‚¬ìš©ë²•',
      about: 'ì†Œê°œ',
      help_title: 'ì‚¬ìš©ë²•',
      legal_title: 'ì†Œê°œ',
      tips_title: 'ğŸ“‹ ë°ëª¨ ê°€ì´ë“œ & í•„ë“œ ë…¸íŠ¸',
      install_title: 'VitalGuard AI ì„¤ì¹˜',
      empty_text: 'ë“±ë¡ëœ ë°ëª¨ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì €ê°€ BLE í‚¤íŒŒì¸ë” íƒœê·¸ë¥¼ ì¶”ê°€í•´ ì˜¤í”„ë¼ì¸ ê·¼ì ‘ ë°ëª¨ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.',
      empty_btn: '+ ë°ëª¨ íƒœê·¸ ì¶”ê°€',
      hero_title: 'ğŸ›¡ï¸ ìƒëª…ì„ êµ¬í•˜ëŠ” ì˜¤í”„ë¼ì¸ AI ë°ëª¨',
      hero_body: 'VitalGuard AIëŠ” ì¸í„°ë„·/í´ë¼ìš°ë“œ ì—†ì´ë„ ë™ì‘í•˜ëŠ” AI+ë¸”ë£¨íˆ¬ìŠ¤ ê·¼ì ‘ ë°ëª¨ì…ë‹ˆë‹¤. ë¶„ì„/ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•Šìœ¼ë©° ëª¨ë“  ë°ì´í„°ëŠ” ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.',
      badge_offline: 'ì™„ì „ ì˜¤í”„ë¼ì¸',
      badge_gdpr: 'GDPR ì¹œí™”',
      badge_ble: 'BLE ê·¼ì ‘ ë©”ì‰¬',
      badge_tiny: '~100KB AI ë‘ë‡Œ',
      contact_line: 'ë¬¸ì˜: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (í•œêµ­ëª…: Gyumin Jeon)'
    ,
      nav_home: 'í™ˆ',
      nav_sos: 'ê¸´ê¸‰',
      nav_tips: 'ê°€ì´ë“œ',
      nav_settings: 'ì„¤ì •',
      install_sub: 'ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ë” ì•ˆì •ì ì…ë‹ˆë‹¤ â€” ë” ë¹ ë¥¸ ì‹¤í–‰, ë¸”ë£¨íˆ¬ìŠ¤ ë™ì‘ ì•ˆì •.',
      install_btn: 'ì•± ì„¤ì¹˜',
      install_dismiss: 'ë‚˜ì¤‘ì—'
    },
    ar: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ù„Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø£Ø±ÙˆØ§Ø­ | McorpAI',
      app_mission: 'ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù„Ø§ Ø³Ø­Ø§Ø¨Ø©. Ù„Ø§ ØªØªØ¨Ø¹. Ù…ØµÙ…Ù… Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ù‹Ø§ Ù…Ø¹ GDPR.',
      app_disclaimer: 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶: Â«Ù…Ù‚ÙˆØ¯ Ø£Ù…Ø§Ù† Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©Â» Ø¹Ø¨Ø± Ù‚Ø±Ø¨ Bluetooth (Ù„ÙŠØ³ GPS). Ù…ØµÙ…Ù… Ù„Ù„Ø¹Ù…Ù„ Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø´Ø¨ÙƒØ§Øª.',
      github: 'Ù…ØµØ¯Ø± GitHub',
      help: 'Ù…Ø³Ø§Ø¹Ø¯Ø©',
      about: 'Ø­ÙˆÙ„',
      help_title: 'Ù…Ø³Ø§Ø¹Ø¯Ø©',
      legal_title: 'Ø­ÙˆÙ„',
      tips_title: 'ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙŠØ¯Ø§Ù†ÙŠØ©',
      install_title: 'ØªØ«Ø¨ÙŠØª VitalGuard AI',
      empty_text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø³Ø¬Ù‘Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯.<br>Ø£Ø¶Ù Ø¹Ù„Ø§Ù…Ø© BLE Ø±Ø®ÙŠØµØ© (Ù…ÙØ¹ÙØ«Ù‘ÙØ± Ù…ÙØ§ØªÙŠØ­) Ù„ØªØ´ØºÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¨ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.',
      empty_btn: '+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø±Ø¶',
      hero_title: 'ğŸ›¡ï¸ Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ù„Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø£Ø±ÙˆØ§Ø­',
      hero_body: 'VitalGuard AI Ù‡Ùˆ Ø¹Ø±Ø¶ AI + Ù‚Ø±Ø¨ Bluetooth ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙˆÙŠØ³ØªÙ…Ø± Ø¹Ù†Ø¯Ù…Ø§ ØªØªØ¹Ø·Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©. Ù„Ø§ ÙŠØ¬Ù…Ø¹ Ø£ÙŠ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ©ØŒ ÙˆÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.',
      badge_offline: 'Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ 100%',
      badge_gdpr: 'ØµØ¯ÙŠÙ‚ Ù„Ù€ GDPR',
      badge_ble: 'Ø´Ø¨ÙƒØ© Ù‚Ø±Ø¨ BLE',
      badge_tiny: 'Ù…Ø­Ø±Ùƒ AI ~100KB',
      contact_line: 'Ù„Ù„ØªÙˆØ§ØµÙ„: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
      nav_sos: 'SOS',
      nav_tips: 'Ø§Ù„Ø¯Ù„ÙŠÙ„',
      nav_settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
      install_sub: 'ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ ÙƒØªØ·Ø¨ÙŠÙ‚ Ù…ÙØ«Ø¨Øª â€” ØªØ´ØºÙŠÙ„ Ø£Ø³Ø±Ø¹ ÙˆBluetooth Ø£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©.',
      install_btn: 'ØªØ«Ø¨ÙŠØª',
      install_dismiss: 'Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†'
    },
    ja: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” å‘½ã‚’æ•‘ã†ã‚ªãƒ•ãƒ©ã‚¤ãƒ³AIãƒ‡ãƒ¢ | McorpAI',
      app_mission: 'å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãªã—ã€‚ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãªã—ã€‚GDPRã«é…æ…®ã—ãŸè¨­è¨ˆã€‚',
      app_disclaimer: 'ãƒ‡ãƒ¢ç”¨ã‚¹ã‚­ãƒ³ï¼šã€Œãƒšãƒƒãƒˆå®‰å…¨ãƒªãƒ¼ãƒ‰ã€â€” Bluetoothè¿‘æ¥ï¼ˆGPSã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã§ã‚‚å‹•ä½œã™ã‚‹è¨­è¨ˆã€‚',
      github: 'GitHub ã‚½ãƒ¼ã‚¹',
      help: 'ä½¿ã„æ–¹',
      about: 'æ¦‚è¦',
      help_title: 'ä½¿ã„æ–¹',
      legal_title: 'æ¦‚è¦',
      tips_title: 'ğŸ“‹ ãƒ‡ãƒ¢ã‚¬ã‚¤ãƒ‰ & ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒ¼ãƒˆ',
      install_title: 'VitalGuard AI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«',
      empty_text: 'ãƒ‡ãƒ¢ç”¨ã‚¿ã‚°ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å®‰ä¾¡ãªBLEã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¿‘æ¥ãƒ‡ãƒ¢ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚',
      empty_btn: '+ ãƒ‡ãƒ¢ã‚¿ã‚°ã‚’è¿½åŠ ',
      hero_title: 'ğŸ›¡ï¸ å‘½ã‚’æ•‘ã†ã‚ªãƒ•ãƒ©ã‚¤ãƒ³AIãƒ‡ãƒ¢',
      hero_body: 'VitalGuard AI ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãŒä½¿ãˆãªã„çŠ¶æ³ã§ã‚‚å‹•ä½œã™ã‚‹ã€ŒAI + Bluetoothè¿‘æ¥ã€ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¢ã§ã™ã€‚è§£æã‚„å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã›ãšã€ã™ã¹ã¦ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã™ã€‚',
      badge_offline: 'å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³',
      badge_gdpr: 'GDPRé…æ…®',
      badge_ble: 'BLEè¿‘æ¥ãƒ¡ãƒƒã‚·ãƒ¥',
      badge_tiny: '~100KB AI',
      contact_line: 'é€£çµ¡å…ˆ: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'ãƒ›ãƒ¼ãƒ ',
      nav_sos: 'SOS',
      nav_tips: 'ã‚¬ã‚¤ãƒ‰',
      nav_settings: 'è¨­å®š',
      install_sub: 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨å®‰å®šã—ã¾ã™ â€” èµ·å‹•ãŒé€Ÿãã€BluetoothãŒã‚ˆã‚Šç¢ºå®Ÿã€‚',
      install_btn: 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«',
      install_dismiss: 'ä»Šã¯ã—ãªã„'
    },
    fr: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” DÃ©mo dâ€™IA hors ligne pour sauver des vies | McorpAI',
      app_mission: 'Fonctionne entiÃ¨rement hors ligne. Pas de cloud. Pas de tÃ©lÃ©mÃ©trie. ConÃ§u pour Ãªtre compatible RGPD.',
      app_disclaimer: 'Habillage de dÃ©moÂ : Â«Â Laisse de sÃ©curitÃ© pour animauxÂ Â» via la proximitÃ© Bluetooth (pas GPS). ConÃ§u pour fonctionner mÃªme quand les rÃ©seaux tombent.',
      github: 'Code GitHub',
      help: 'Aide',
      about: 'Ã€ propos',
      help_title: 'Aide',
      legal_title: 'Ã€ propos',
      tips_title: 'ğŸ“‹ Guide de dÃ©mo & notes terrain',
      install_title: 'Installer VitalGuard AI',
      empty_text: 'Aucune balise de dÃ©mo enregistrÃ©e.<br>Ajoutez une balise BLE bon marchÃ© (porteâ€‘clÃ©s antiâ€‘perte) pour lancer la dÃ©mo de proximitÃ© hors ligne.',
      empty_btn: '+ Ajouter une balise',
      hero_title: 'ğŸ›¡ï¸ DÃ©mo dâ€™IA hors ligne pour sauver des vies',
      hero_body: 'VitalGuard AI est une dÃ©mo hors ligne (IA + proximitÃ© Bluetooth) qui continue de fonctionner lorsque le cloud est indisponible. Aucune collecte de donnÃ©esÂ : tout reste sur votre appareil.',
      badge_offline: '100% hors ligne',
      badge_gdpr: 'RGPDâ€‘friendly',
      badge_ble: 'Maille de proximitÃ© BLE',
      badge_tiny: 'Moteur AI ~100KB',
      contact_line: 'Contact: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Accueil',
      nav_sos: 'SOS',
      nav_tips: 'Guide',
      nav_settings: 'ParamÃ¨tres',
      install_sub: 'Meilleur en appli installÃ©e â€” dÃ©marrage plus rapide, Bluetooth plus fiable.',
      install_btn: 'Installer',
      install_dismiss: 'Plus tard'
    },
    'zh-TW': {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” æ•‘å‘½é›¢ç·š AI ç¤ºç¯„ | McorpAI',
      app_mission: 'å®Œå…¨é›¢ç·šé‹ä½œã€‚ç„¡é›²ç«¯ã€‚ç„¡è¿½è¹¤ã€‚ä»¥ GDPR å‹å–„ç‚ºè¨­è¨ˆåŸå‰‡ã€‚',
      app_disclaimer: 'ç¤ºç¯„å¤–è§€ï¼šã€Œå¯µç‰©å®‰å…¨ç‰½ç¹©ã€â€” ä»¥è—ç‰™è¿‘è·é›¢åµæ¸¬ï¼ˆé GPSï¼‰ã€‚ç‚ºç¶²è·¯ä¸­æ–·æƒ…å¢ƒè€Œè¨­è¨ˆã€‚',
      github: 'GitHub åŸå§‹ç¢¼',
      help: 'èªªæ˜',
      about: 'é—œæ–¼',
      help_title: 'èªªæ˜',
      legal_title: 'é—œæ–¼',
      tips_title: 'ğŸ“‹ ç¤ºç¯„æŒ‡å—èˆ‡ç¾å ´ç­†è¨˜',
      install_title: 'å®‰è£ VitalGuard AI',
      empty_text: 'å°šæœªè¨»å†Šä»»ä½•ç¤ºç¯„æ¨™ç±¤ã€‚<br>æ–°å¢ä¾¿å®œçš„ BLE é˜²ä¸Ÿé‘°åŒ™åœˆæ¨™ç±¤ï¼Œå³å¯é–‹å§‹é›¢ç·šè¿‘è·é›¢ç¤ºç¯„ã€‚',
      empty_btn: '+ æ–°å¢ç¤ºç¯„æ¨™ç±¤',
      hero_title: 'ğŸ›¡ï¸ æ•‘å‘½é›¢ç·š AI ç¤ºç¯„',
      hero_body: 'VitalGuard AI æ˜¯ã€ŒAI + è—ç‰™è¿‘è·é›¢ã€çš„é›¢ç·šç¤ºç¯„ï¼šé›²ç«¯ä¸å¯ç”¨æ™‚ä»èƒ½é‹ä½œã€‚ä¸æ”¶é›†åˆ†ææˆ–å€‹è³‡ï¼Œæ‰€æœ‰è³‡æ–™åªå­˜åœ¨ä½ çš„è£ç½®ä¸Šã€‚',
      badge_offline: 'å®Œå…¨é›¢ç·š',
      badge_gdpr: 'GDPR å‹å–„',
      badge_ble: 'BLE è¿‘è·é›¢ç¶²æ ¼',
      badge_tiny: '~100KB AI å¼•æ“',
      contact_line: 'è¯çµ¡: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'é¦–é ',
      nav_sos: 'SOS',
      nav_tips: 'æŒ‡å—',
      nav_settings: 'è¨­å®š',
      install_sub: 'å®‰è£æˆ App æœƒæ›´ç©©å®š â€” å•Ÿå‹•æ›´å¿«ã€è—ç‰™æ›´å¯é ã€‚',
      install_btn: 'å®‰è£',
      install_dismiss: 'ç¨å¾Œ'
    },
    es: {
      app_title: 'VitalGuard AI',
      app_sub: 'v4.1.2 â€” Demo de IA sin conexiÃ³n para salvar vidas | McorpAI',
      app_mission: 'Funciona totalmente sin conexiÃ³n. Sin nube. Sin telemetrÃ­a. DiseÃ±ado para ser compatible con el GDPR.',
      app_disclaimer: 'Piel de demo: â€œCorrea de seguridad para mascotasâ€ usando proximidad Bluetooth (no GPS). DiseÃ±ado para funcionar cuando fallan las redes.',
      github: 'CÃ³digo en GitHub',
      help: 'Ayuda',
      about: 'Acerca de',
      help_title: 'Ayuda',
      legal_title: 'Acerca de',
      tips_title: 'ğŸ“‹ GuÃ­a de demo y notas de campo',
      install_title: 'Instalar VitalGuard AI',
      empty_text: 'AÃºn no hay etiquetas registradas.<br>Agrega una etiqueta BLE barata (buscador de llaves) para iniciar la demo de proximidad sin conexiÃ³n.',
      empty_btn: '+ AÃ±adir etiqueta',
      hero_title: 'ğŸ›¡ï¸ Demo de IA sin conexiÃ³n para salvar vidas',
      hero_body: 'VitalGuard AI es una demo sin conexiÃ³n (IA + proximidad Bluetooth) que sigue funcionando cuando la nube no estÃ¡ disponible. No recopila analÃ­ticas ni datos personales: todo queda en tu dispositivo.',
      badge_offline: '100% sin conexiÃ³n',
      badge_gdpr: 'Compatible GDPR',
      badge_ble: 'Malla de proximidad BLE',
      badge_tiny: 'Motor AI ~100KB',
      contact_line: 'Contacto: contact@mcorpai.org â€¢ mcorpai.org â€¢ Morgan J. (Gyumin Jeon)'
    ,
      nav_home: 'Inicio',
      nav_sos: 'SOS',
      nav_tips: 'GuÃ­a',
      nav_settings: 'Ajustes',
      install_sub: 'Mejor como app instalada â€” inicio mÃ¡s rÃ¡pido, Bluetooth mÃ¡s fiable.',
      install_btn: 'Instalar',
      install_dismiss: 'Ahora no'
    }
  };

  const HTML = {
    tips: {
      en: `
        <div class="tip-card info">
          <div class="tip-title">What you are looking at</div>
          <div class="tip-body">
            This page is a <strong>technology demonstration</strong>. The UI is intentionally â€œPet Safety Leashâ€ because it is universal and harmless,
            but the underlying engine is built for <strong>lifeâ€‘saving offline scenarios</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2â€‘minute demo</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Get a cheap BLE keyâ€‘finder tag (often called <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home â†’ <strong>Add Demo Tag</strong> â†’ follow the wizard (near â†’ move away â†’ name).</li>
              <li>Start monitoring. Watch the zone change (SAFE â†’ CAUTION â†’ WARNING) as distance changes.</li>
              <li>Try SOS: generate an offline QR card and test the audio beacon.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ Why offline matters in disasters</div>
        <div class="tip-card warn">
          <div class="tip-title">When the network fails</div>
          <div class="tip-body">
            During wildfires, landslides, tsunamis, and mass evacuations, cloud apps can fail: no signal, no power, no accounts, no payments.
            VitalGuard AI keeps a <strong>tiny offline â€œbrainâ€</strong> on the device, so the demo still runs.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Example deployments (easy to understand)</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Evacuation centers:</strong> put BLE tags on medical kits / generators â†’ alert if moved outside a zone.</li>
              <li><strong>Search & rescue:</strong> tag team members or gear â†’ help locate what is nearby when visibility is poor.</li>
              <li><strong>Family reunification:</strong> a phone can monitor proximity between a guardian and a child (not GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Privacy & GDPR</div>
          <div class="tip-body">
            No accounts. No analytics. No cloud calls. Data is stored locally and can be erased anytime.
            Exports (backup/diagnostics) happen only when you press the button.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Important limitation</div>
          <div class="tip-body">
            Bluetooth RSSI is noisy (walls, crowds, pockets). Use zones as <em>signals</em>, not exact meters.
            This is a demo, not a certified lifeâ€‘critical device.
          </div>
        </div>
      `,
      ko: `
        <div class="tip-card info">
          <div class="tip-title">ì§€ê¸ˆ ë³´ê³  ìˆëŠ” ê²ƒì€?</div>
          <div class="tip-body">
            ì´ í˜ì´ì§€ëŠ” <strong>ê¸°ìˆ  ì‹œì—°(ë°ëª¨)</strong>ì…ë‹ˆë‹¤. UIê°€ â€œê°•ì•„ì§€ ì•ˆì „ ëª©ì¤„â€ì²˜ëŸ¼ ë³´ì´ë„ë¡ ë§Œë“  ì´ìœ ëŠ” ê°€ì¥ ë³´í¸ì ì´ê³  ë¬´í•´í•œ ì‚¬ë¡€ì´ê¸° ë•Œë¬¸ì´ë©°,
            ì‹¤ì œ í•µì‹¬ì€ <strong>ì¬ë‚œ/ì…§ë‹¤ìš´ í™˜ê²½ì—ì„œë„ ë™ì‘í•˜ëŠ” ì˜¤í”„ë¼ì¸ AI ì—”ì§„</strong>ì…ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2ë¶„ ë°ëª¨ ì ˆì°¨</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>ì €ê°€ BLE í‚¤íŒŒì¸ë” íƒœê·¸ ì¤€ë¹„ (<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> ë“±).</li>
              <li>Home â†’ <strong>ë°ëª¨ íƒœê·¸ ì¶”ê°€</strong> â†’ ìœ„ìë“œ(ê°€ê¹Œì´ â†’ ë©€ë¦¬ ì´ë™ â†’ ì´ë¦„ ì§€ì •).</li>
              <li>ëª¨ë‹ˆí„°ë§ ì‹œì‘ â†’ ê±°ë¦¬ ë³€í™”ì— ë”°ë¼ SAFE â†’ CAUTION â†’ WARNING ì¡´ì´ ë°”ë€ŒëŠ”ì§€ í™•ì¸.</li>
              <li>SOSì—ì„œ ì˜¤í”„ë¼ì¸ QR ì¹´ë“œ ìƒì„± + ì˜¤ë””ì˜¤ ë¹„ì½˜ í…ŒìŠ¤íŠ¸.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ ì¬ë‚œì—ì„œ â€œì˜¤í”„ë¼ì¸â€ì´ ì¤‘ìš”í•œ ì´ìœ </div>
        <div class="tip-card warn">
          <div class="tip-title">ë„¤íŠ¸ì›Œí¬ê°€ ëŠê¸°ë©´</div>
          <div class="tip-body">
            ì‚°ë¶ˆÂ·ì‚°ì‚¬íƒœÂ·ì“°ë‚˜ë¯¸Â·ëŒ€ê·œëª¨ ëŒ€í”¼ ìƒí™©ì—ì„œëŠ” ì‹ í˜¸/ì „ë ¥/ê³„ì •/ê²°ì œê°€ ëª¨ë‘ ë¶ˆì•ˆì •í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            VitalGuard AIëŠ” ê¸°ê¸° ì•ˆì— <strong>ì‘ì€ ì˜¤í”„ë¼ì¸ ë‘ë‡Œ</strong>ë¥¼ ë„£ì–´ ì´ëŸ° ìƒí™©ì—ì„œë„ ë°ëª¨ê°€ ê³„ì† ë™ì‘í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ì´í•´í•˜ê¸° ì‰¬ìš´ í™œìš© ì˜ˆì‹œ</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ëŒ€í”¼ì†Œ:</strong> ì˜ë£Œ í‚¤íŠ¸/ë°œì „ê¸° ë“±ì— BLE íƒœê·¸ ë¶€ì°© â†’ ì§€ì • êµ¬ì—­ ì´íƒˆ ì‹œ ê²½ë³´.</li>
              <li><strong>ìˆ˜ìƒ‰/êµ¬ì¡°:</strong> íŒ€ì›/ì¥ë¹„ì— íƒœê·¸ â†’ ì‹œì•¼ê°€ ë‚˜ì  ë•Œ â€œê·¼ì²˜ì— ë¬´ì—‡ì´ ìˆëŠ”ì§€â€ ë¹ ë¥´ê²Œ íŒŒì•….</li>
              <li><strong>ê°€ì¡± ì¬ê²°í•©:</strong> ë³´í˜¸ìâ€‘ì•„ì´ ê·¼ì ‘ ëª¨ë‹ˆí„°ë§( GPS ì•„ë‹˜ ).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">ê°œì¸ì •ë³´ & GDPR</div>
          <div class="tip-body">
            ê³„ì • ì—†ìŒ Â· ë¶„ì„ ì—†ìŒ Â· í´ë¼ìš°ë“œ í†µì‹  ì—†ìŒ. ë°ì´í„°ëŠ” ê¸°ê¸°ì—ë§Œ ì €ì¥ë˜ë©° ì–¸ì œë“  ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ë°±ì—…/ì§„ë‹¨ ë‚´ë³´ë‚´ê¸°ëŠ” ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ì¤‘ìš”í•œ í•œê³„</div>
          <div class="tip-body">
            BLE RSSIëŠ” ë²½/ì‚¬ëŒ/ì£¼ë¨¸ë‹ˆ ë“± í™˜ê²½ì— ë”°ë¼ í¬ê²Œ í”ë“¤ë¦½ë‹ˆë‹¤. ë¯¸í„° ë‹¨ìœ„ â€œì •í™•í•œ ê±°ë¦¬â€ê°€ ì•„ë‹ˆë¼ <em>ì‹ í˜¸</em>ë¡œ ë³´ì„¸ìš”.
            ë³¸ íŒŒì¼ì€ ë°ëª¨ì´ë©° ìƒëª…â€‘ì•ˆì „ ì¸ì¦ ì¥ë¹„ê°€ ì•„ë‹™ë‹ˆë‹¤.
          </div>
        </div>
      `,
      ar: `
        <div class="tip-card info">
          <div class="tip-title">Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ±Ø§Ù‡ Ù‡Ù†Ø§ØŸ</div>
          <div class="tip-body">
            Ù‡Ø°Ù‡ <strong>ØªØ¬Ø±Ø¨Ø© ØªÙ‚Ù†ÙŠØ©</strong>. ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø¬Ù‡Ø© â€œÙ…Ù‚ÙˆØ¯ Ø£Ù…Ø§Ù† Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©â€ Ù„Ø£Ù†Ù‡Ø§ Ø¹Ø§Ù…Ø© ÙˆØºÙŠØ± Ø­Ø³Ø§Ø³Ø©ØŒ
            Ù„ÙƒÙ† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…ÙˆØ¬Ù‘Ù‡ Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª <strong>Ø§Ù„Ø¥Ù†Ù‚Ø§Ø° ÙˆØ§Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ø¹Ø±Ø¶ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© BLE Ø±Ø®ÙŠØµØ© (ØºØ§Ù„Ø¨Ù‹Ø§ <span class="kbd">iTag</span> Ø£Ùˆ <span class="kbd">Key Finder</span>).</li>
              <li>Home â†’ <strong>Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø±Ø¶</strong> Ø«Ù… Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ (Ù‚Ø±ÙŠØ¨ â†’ Ø§Ø¨ØªØ¹Ø¯ â†’ Ø³Ù…Ù‘ÙÙ‡Ø§).</li>
              <li>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ´Ø§Ù‡Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (SAFE â†’ CAUTION â†’ WARNING) Ù…Ø¹ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù‚Ø±Ø¨.</li>
              <li>Ø¬Ø±Ù‘Ø¨ SOS: Ø£Ù†Ø´Ø¦ Ø¨Ø·Ø§Ù‚Ø© QR Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙˆØ§Ø®ØªØ¨Ø± Ù…Ù†Ø§Ø±Ø© Ø§Ù„ØµÙˆØª.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ Ù„Ù…Ø§Ø°Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„ÙƒÙˆØ§Ø±Ø«</div>
        <div class="tip-card warn">
          <div class="tip-title">Ø¹Ù†Ø¯Ù…Ø§ ØªØªØ¹Ø·Ù„ Ø§Ù„Ø´Ø¨ÙƒØ§Øª</div>
          <div class="tip-body">
            Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø±Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ÙˆØ£Ù…ÙˆØ§Ø¬ ØªØ³ÙˆÙ†Ø§Ù…ÙŠ ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù„Ø§Ø¡ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù‚Ø¯ ØªÙØ´Ù„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: Ù„Ø§ Ø¥Ø´Ø§Ø±Ø©ØŒ Ù„Ø§ Ø·Ø§Ù‚Ø©ØŒ Ù„Ø§ Ø­Ø³Ø§Ø¨Ø§Øª.
            VitalGuard AI ÙŠØ­ØªÙØ¸ Ø¨Ù€ <strong>Ø¹Ù‚Ù„ ØµØºÙŠØ± Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„</strong> Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙŠØ³ØªÙ…Ø± Ø§Ù„Ø¹Ø±Ø¶.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ø£Ù…Ø«Ù„Ø© Ø³Ù‡Ù„Ø© Ø§Ù„ÙÙ‡Ù…</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø¥ÙŠÙˆØ§Ø¡:</strong> Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø¥Ø³Ø¹Ø§Ù/Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª â†’ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø®Ø±ÙˆØ¬Ù‡Ø§ Ù…Ù† Ù…Ù†Ø·Ù‚Ø©.</li>
              <li><strong>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø°:</strong> Ø¹Ù„Ù‘Ù… Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª â†’ Ù…Ø¹Ø±ÙØ© Ù…Ø§ Ù‡Ùˆ Ù‚Ø±ÙŠØ¨ Ø¹Ù†Ø¯ Ø¶Ø¹Ù Ø§Ù„Ø±Ø¤ÙŠØ©.</li>
              <li><strong>Ù„Ù…Ù‘ Ø´Ù…Ù„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©:</strong> Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ø±Ø¨ Ø·ÙÙ„ ÙˆÙˆÙ„ÙŠ Ø£Ù…Ø± (Ù„ÙŠØ³ GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ùˆ GDPR</div>
          <div class="tip-body">
            Ù„Ø§ Ø­Ø³Ø§Ø¨Ø§ØªØŒ Ù„Ø§ ØªØ­Ù„ÙŠÙ„Ø§ØªØŒ Ù„Ø§ Ø³Ø­Ø§Ø¨Ø©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙˆÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª. Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠØªÙ… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Ù‚ÙŠØ¯ Ù…Ù‡Ù…</div>
          <div class="tip-body">
            Ø¥Ø´Ø§Ø±Ø© Bluetooth (RSSI) Ù…ØªÙ‚Ù„Ø¨Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† ÙˆØ§Ù„Ø­Ø´ÙˆØ¯ ÙˆØ§Ù„Ø¬ÙŠÙˆØ¨. Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¥Ø´Ø§Ø±Ø§Øª Ù„Ø§ Ø£Ù…ØªØ§Ø± Ø¯Ù‚ÙŠÙ‚Ø©.
            Ù‡Ø°Ø§ Ø¹Ø±Ø¶ ØªÙ‚Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ø¬Ù‡Ø§Ø²Ù‹Ø§ Ù…Ø¹ØªÙ…Ø¯Ù‹Ø§ Ù„Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ø±Ø¬Ø©.
          </div>
        </div>
      `,
      ja: `
        <div class="tip-card info">
          <div class="tip-title">ã“ã‚Œã¯ä½•ã®ãƒ‡ãƒ¢ï¼Ÿ</div>
          <div class="tip-body">
            ã“ã‚Œã¯ <strong>æŠ€è¡“ãƒ‡ãƒ¢</strong> ã§ã™ã€‚UI ã‚’ã€Œãƒšãƒƒãƒˆå®‰å…¨ãƒªãƒ¼ãƒ‰ã€ã«ã—ã¦ã„ã‚‹ã®ã¯ã€æœ€ã‚‚æ™®éçš„ã§ç„¡å®³ãªä¾‹ã ã‹ã‚‰ã§ã™ã€‚
            ã—ã‹ã—ä¸­èº«ã¯ <strong>ç½å®³/ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ç’°å¢ƒã§ã‚‚å‹•ãã‚ªãƒ•ãƒ©ã‚¤ãƒ³AIã‚¨ãƒ³ã‚¸ãƒ³</strong> ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2åˆ†ãƒ‡ãƒ¢</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>å®‰ä¾¡ãª BLE ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆ<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> ãªã©ï¼‰ã‚’ç”¨æ„ã€‚</li>
              <li>Home â†’ <strong>ãƒ‡ãƒ¢ã‚¿ã‚°è¿½åŠ </strong> â†’ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼ˆè¿‘ãâ†’é›¢ã‚Œã‚‹â†’åå‰ï¼‰ã€‚</li>
              <li>ç›£è¦–ã‚’é–‹å§‹ã—ã€SAFE â†’ CAUTION â†’ WARNING ã®å¤‰åŒ–ã‚’ç¢ºèªã€‚</li>
              <li>SOS: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ QR ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ + éŸ³ã®ãƒ“ãƒ¼ã‚³ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã€‚</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ ç½å®³ã§ã€Œã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€ãŒé‡è¦ãªç†ç”±</div>
        <div class="tip-card warn">
          <div class="tip-title">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè½ã¡ã‚‹ã¨</div>
          <div class="tip-body">
            å±±ç«äº‹ãƒ»åœŸç ‚ç½å®³ãƒ»æ´¥æ³¢ãƒ»å¤§è¦æ¨¡é¿é›£ã§ã¯ã€é›»æ³¢/é›»åŠ›/ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ/èª²é‡‘ãŒæˆç«‹ã—ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
            VitalGuard AI ã¯ç«¯æœ«å†…ã« <strong>å°ã•ãªã‚ªãƒ•ãƒ©ã‚¤ãƒ³è„³</strong> ã‚’æŒã¡ã€ãƒ‡ãƒ¢ã‚’ç¶™ç¶šã§ãã¾ã™ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">åˆ†ã‹ã‚Šã‚„ã™ã„ç”¨é€”ä¾‹</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>é¿é›£æ‰€:</strong> åŒ»ç™‚ã‚­ãƒƒãƒˆ/ç™ºé›»æ©Ÿã«ã‚¿ã‚° â†’ ã‚¾ãƒ¼ãƒ³å¤–ã«å‡ºãŸã‚‰è­¦å‘Šã€‚</li>
              <li><strong>æœç´¢æ•‘åŠ©:</strong> éšŠå“¡/è£…å‚™ã«ã‚¿ã‚° â†’ è¦–ç•Œä¸è‰¯ã§ã‚‚ã€Œè¿‘ãã«ä½•ãŒã‚ã‚‹ã‹ã€ã‚’æŠŠæ¡ã€‚</li>
              <li><strong>å®¶æ—ã®å†ä¼š:</strong> ä¿è­·è€…ã¨å­ã©ã‚‚ã®è¿‘æ¥ç›£è¦–ï¼ˆGPSã§ã¯ãªã„ï¼‰ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ / GDPR</div>
          <div class="tip-body">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—ãƒ»è§£æãªã—ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰é€šä¿¡ãªã—ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã€ã„ã¤ã§ã‚‚æ¶ˆå»ã§ãã¾ã™ã€‚
            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ãƒœã‚¿ãƒ³æ“ä½œæ™‚ã®ã¿ã§ã™ã€‚
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">é‡è¦ãªåˆ¶é™</div>
          <div class="tip-body">
            Bluetooth RSSI ã¯å£ã‚„äººæ··ã¿ã§å¤§ããæºã‚Œã¾ã™ã€‚è·é›¢ã‚’ã€Œæ­£ç¢ºãªãƒ¡ãƒ¼ãƒˆãƒ«ã€ã¨ã—ã¦æ‰±ã‚ãšã€ã‚¾ãƒ¼ãƒ³ã‚’ <em>ç›®å®‰</em> ã«ã—ã¦ãã ã•ã„ã€‚
            æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ‡ãƒ¢ã§ã‚ã‚Šã€ç”Ÿå‘½å®‰å…¨ã®èªè¨¼æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        </div>
      `,
      fr: `
        <div class="tip-card info">
          <div class="tip-title">Ce que vous voyez</div>
          <div class="tip-body">
            Ceci est une <strong>dÃ©mo technologique</strong>. Lâ€™interface â€œLaisse de sÃ©curitÃ©â€ est volontairement neutre,
            mais le moteur sert des scÃ©narios <strong>hors ligne et de sauvetage</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">DÃ©mo en 2 minutes</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Procurezâ€‘vous une balise BLE bon marchÃ© (souvent <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home â†’ <strong>Ajouter une balise</strong> â†’ assistant (prÃ¨s â†’ Ã©loignezâ€‘vous â†’ nom).</li>
              <li>DÃ©marrez la surveillance et observez SAFE â†’ CAUTION â†’ WARNING selon la proximitÃ©.</li>
              <li>Testez SOSÂ : QR hors ligne + balise audio.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ Pourquoi le horsâ€‘ligne est crucial</div>
        <div class="tip-card warn">
          <div class="tip-title">Quand le rÃ©seau tombe</div>
          <div class="tip-body">
            Incendies, glissements de terrain, tsunamis, Ã©vacuationsÂ : les applis cloud peuvent Ã©chouer (signal/paiement/comptes).
            VitalGuard AI garde un <strong>petit â€œcerveauâ€</strong> sur lâ€™appareil pour continuer.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Exemples simples</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Centres dâ€™Ã©vacuation:</strong> balises sur kits mÃ©dicaux/gÃ©nÃ©rateurs â†’ alerte si sortie de zone.</li>
              <li><strong>Recherche & sauvetage:</strong> balises sur personnes/Ã©quipements â†’ savoir ce qui est proche quand la visibilitÃ© est faible.</li>
              <li><strong>RÃ©unification familiale:</strong> suivi de proximitÃ© (pas GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Vie privÃ©e & RGPD</div>
          <div class="tip-body">
            Pas de comptes, pas dâ€™analytics, pas de cloud. DonnÃ©es locales, effaÃ§ables Ã  tout moment. Export uniquement sur action.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Limitation importante</div>
          <div class="tip-body">
            Le RSSI Bluetooth est bruitÃ© (murs, foule). Utilisez les zones comme <em>indications</em>, pas des mÃ¨tres exacts.
            DÃ©mo non certifiÃ©e pour un usage vital.
          </div>
        </div>
      `,
      'zh-TW': `
        <div class="tip-card info">
          <div class="tip-title">ä½ æ­£åœ¨çœ‹çš„å…§å®¹</div>
          <div class="tip-body">
            é€™æ˜¯ä¸€å€‹ <strong>æŠ€è¡“ç¤ºç¯„</strong>ã€‚ä»‹é¢åˆ»æ„åšæˆã€Œå¯µç‰©å®‰å…¨ç‰½ç¹©ã€æ˜¯å› ç‚ºå®ƒæœ€æ™®éä¸”ä¸å…·çˆ­è­°ï¼›
            ä½†æ ¸å¿ƒå…¶å¯¦æ˜¯åœ¨å±•ç¤º <strong>é›¢ç·šã€å¯æ•‘å‘½çš„ AI å¼•æ“</strong>ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2 åˆ†é˜ç¤ºç¯„æµç¨‹</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>æº–å‚™ä¾¿å®œçš„ BLE é˜²ä¸Ÿé‘°åŒ™åœˆï¼ˆå¸¸è¦‹é—œéµå­— <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>ï¼‰ã€‚</li>
              <li>Home â†’ <strong>æ–°å¢ç¤ºç¯„æ¨™ç±¤</strong> â†’ ä¾ç²¾éˆæµç¨‹ï¼ˆé è¿‘â†’èµ°é â†’å‘½åï¼‰ã€‚</li>
              <li>é–‹å§‹ç›£æ¸¬ï¼Œè§€å¯Ÿ SAFE â†’ CAUTION â†’ WARNING ä¾è¿‘è·é›¢è®ŠåŒ–ã€‚</li>
              <li>æ¸¬è©¦ SOSï¼šç”¢ç”Ÿé›¢ç·š QR åç‰‡èˆ‡éŸ³è¨Šä¿¡æ¨™ã€‚</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ ç‚ºä»€éº¼ç½å®³æƒ…å¢ƒéœ€è¦é›¢ç·š</div>
        <div class="tip-card warn">
          <div class="tip-title">ç•¶ç¶²è·¯å¤±æ•ˆ</div>
          <div class="tip-body">
            å±±ç«ã€åœŸçŸ³æµã€æµ·å˜¯ã€å¤§è¦æ¨¡æ’¤é›¢æ™‚ï¼Œé›²ç«¯ App å¯èƒ½å¤±æ•ˆï¼ˆç„¡è¨Šè™Ÿ/ç„¡é›»/ç„¡å¸³è™Ÿ/ç„¡ä»˜æ¬¾ï¼‰ã€‚
            VitalGuard AI æŠŠ <strong>å°å‹é›¢ç·šå¤§è…¦</strong> æ”¾åœ¨è£ç½®å…§ï¼Œæ‰€ä»¥ç¤ºç¯„ä»èƒ½é‹ä½œã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">å®¹æ˜“ç†è§£çš„éƒ¨ç½²ä¾‹å­</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>é¿é›£ä¸­å¿ƒ:</strong> é†«ç™‚åŒ…/ç™¼é›»æ©Ÿè²¼ BLE æ¨™ç±¤ â†’ è¶…å‡ºå€åŸŸå°±è­¦ç¤ºã€‚</li>
              <li><strong>æœæ•‘:</strong> äººå“¡/è£å‚™è²¼æ¨™ç±¤ â†’ è¦–ç·šå·®æ™‚å¿«é€ŸçŸ¥é“ã€Œé™„è¿‘æœ‰ä»€éº¼ã€ã€‚</li>
              <li><strong>å®¶å±¬é‡èš:</strong> ç›£æ¸¬ä¿è­·è€…èˆ‡å­©ç«¥çš„è¿‘è·é›¢ï¼ˆé GPSï¼‰ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">éš±ç§èˆ‡ GDPR</div>
          <div class="tip-body">
            ç„¡å¸³è™Ÿã€ç„¡åˆ†æã€ç„¡é›²ç«¯å‘¼å«ã€‚è³‡æ–™åªåœ¨æœ¬æ©Ÿï¼Œå¯éš¨æ™‚åˆªé™¤ï¼›åŒ¯å‡ºåªåœ¨ä½ æŒ‰ä¸‹æŒ‰éˆ•æ™‚ç™¼ç”Ÿã€‚
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">é‡è¦é™åˆ¶</div>
          <div class="tip-body">
            è—ç‰™ RSSI æœƒå—ç‰†å£/äººæ½®/å£è¢‹å½±éŸ¿è€Œå¤§å¹…æ³¢å‹•ã€‚è«‹æŠŠå€åŸŸç•¶ä½œ <em>è¨Šè™Ÿ</em> è€Œéç²¾æº–å…¬å°ºã€‚
            é€™æ˜¯ç¤ºç¯„ï¼Œéç”Ÿå‘½é—œéµèªè­‰è¨­å‚™ã€‚
          </div>
        </div>
      `,
      es: `
        <div class="tip-card info">
          <div class="tip-title">QuÃ© estÃ¡s viendo</div>
          <div class="tip-body">
            Esto es una <strong>demostraciÃ³n tecnolÃ³gica</strong>. La interfaz â€œCorrea de seguridadâ€ es neutral y fÃ¡cil de entender,
            pero el motor estÃ¡ pensado para <strong>escenarios offline que salvan vidas</strong>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Demo en 2 minutos</div>
          <div class="tip-body">
            <ol style="margin:8px 0 0 18px;line-height:1.6">
              <li>Consigue una etiqueta BLE barata (a menudo <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span>).</li>
              <li>Home â†’ <strong>AÃ±adir etiqueta</strong> â†’ asistente (cerca â†’ alÃ©jate â†’ nÃ³mbrala).</li>
              <li>Inicia la monitorizaciÃ³n y observa SAFE â†’ CAUTION â†’ WARNING segÃºn la proximidad.</li>
              <li>Prueba SOS: QR sin conexiÃ³n + baliza de audio.</li>
            </ol>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="font-size:.82rem">ğŸŒ‹ Por quÃ© el modo offline importa</div>
        <div class="tip-card warn">
          <div class="tip-title">Cuando falla la red</div>
          <div class="tip-body">
            Incendios, deslizamientos, tsunamis y evacuaciones: las apps en la nube pueden fallar (sin seÃ±al, sin energÃ­a, sin cuentas).
            VitalGuard AI mantiene un <strong>pequeÃ±o â€œcerebroâ€ offline</strong> en el dispositivo para seguir funcionando.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ejemplos fÃ¡ciles</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Centros de evacuaciÃ³n:</strong> etiquetas en kits mÃ©dicos/generadores â†’ alerta si salen de una zona.</li>
              <li><strong>BÃºsqueda y rescate:</strong> etiquetas en personas/equipo â†’ saber quÃ© estÃ¡ cerca con poca visibilidad.</li>
              <li><strong>ReunificaciÃ³n familiar:</strong> monitorizaciÃ³n de proximidad (no GPS).</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tip-card info">
          <div class="tip-title">Privacidad y GDPR</div>
          <div class="tip-body">
            Sin cuentas, sin analÃ­ticas, sin nube. Datos locales y borrables. ExportaciÃ³n solo cuando tÃº lo decides.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">LimitaciÃ³n importante</div>
          <div class="tip-body">
            El RSSI Bluetooth es ruidoso (paredes, gente). Usa las zonas como <em>seÃ±ales</em>, no metros exactos.
            Demo no certificada para uso crÃ­tico.
          </div>
        </div>
      `
    },

    help: {
      en: `
        <h2 style="margin-bottom:12px">ğŸ“– Quick Start (for nonâ€‘technical audiences)</h2>

        <div class="tip-card info">
          <div class="tip-title">Why this demo looks like â€œPet Safety Leashâ€</div>
          <div class="tip-body">
            To test how flawlessly the offline AI engine and BLE proximity mesh perform in everyday environments, I initially built the prototype skinned as a â€œPet Safety Leashâ€ â€” the most universal and harmless use case.
            <br><br>
            The same engine can be reâ€‘skinned for evacuation, search & rescue, and humanitarian field operations.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) What you need</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> is recommended.<br>
            Get a cheap BLE keyâ€‘finder tag (keywords: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Antiâ€‘lost BLE</span>).<br>
            For best reliability, run via <span class="kbd">https://</span> or <span class="kbd">localhost</span> (not all browsers allow BLE from file://).
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Register a demo tag</div>
          <div class="tip-body">
            Home â†’ <strong>Add Demo Tag</strong>.<br>
            The wizard asks you to (A) hold the tag near the phone, then (B) move it away.
            This helps the app identify the right tag in crowded BLE environments.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Start monitoring</div>
          <div class="tip-body">
            Tap <strong>Start</strong>. You will see a zone such as SAFE / CAUTION / WARNING.
            The â€œAIâ€ is not a giant model â€” it is a set of compact algorithms that:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>smooth noisy signals (Kalman filter),</li>
              <li>stabilize decisions to prevent alert spam (hysteresis + antiâ€‘flapping),</li>
              <li>optionally learn locally from feedback (lightweight learning modules).</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">What this is NOT</div>
          <div class="tip-body">
            This is <strong>not GPS</strong>. Bluetooth proximity works best within tens of meters and is affected by walls, bodies, metal, and pockets.
            Treat it as a <strong>signal</strong> that helps decisions when internet/phones are unreliable.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / Emergency demo</h3>
        <div class="tip-card info">
          <div class="tip-title">Offline QR + audio beacon</div>
          <div class="tip-body">
            SOS mode can generate an <strong>offline QR contact card</strong> and play a loud <strong>audio beacon</strong>.
            This is a demo of â€œresilience primitivesâ€: simple tools that still work during blackouts or censorship.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ Privacy / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">No data collection</div>
          <div class="tip-body">
            VitalGuard AI does not send telemetry, analytics, or personal data to any server. Data stays on the device.
            You can export/backup only by explicit user action, and you can erase everything at any time.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Safety note</div>
          <div class="tip-body">
            This is a technical demonstration. Do not use as the sole tool for lifeâ€‘critical decisions.
          </div>
        </div>
      `,
      ko: `
        <h2 style="margin-bottom:12px">ğŸ“– ë¹ ë¥¸ ì‚¬ìš©ë²• (ë¹„ì „ë¬¸ê°€ìš©)</h2>

        <div class="tip-card info">
          <div class="tip-title">ì™œ â€œê°•ì•„ì§€ ì•ˆì „ ëª©ì¤„â€ì²˜ëŸ¼ ë³´ì´ë‚˜ìš”?</div>
          <div class="tip-body">
            ì˜¤í”„ë¼ì¸ AI ì—”ì§„ê³¼ BLE ê·¼ì ‘ ë©”ì‰¬ê°€ ì¼ìƒ í™˜ê²½ì—ì„œ ì–¼ë§ˆë‚˜ ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ ì‹œí—˜í•˜ê¸° ìœ„í•´,
            ê°€ì¥ ë³´í¸ì ì´ê³  ë¬´í•´í•œ ì‚¬ë¡€ì¸ â€œê°•ì•„ì§€ ì•ˆì „ ëª©ì¤„(Pet Safety Leash)â€ ìŠ¤í‚¨ìœ¼ë¡œ í”„ë¡œí† íƒ€ì…ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
            <br><br>
            ê°™ì€ ì—”ì§„ì„ ëŒ€í”¼/ìˆ˜ìƒ‰Â·êµ¬ì¡°/ì¸ë„ì£¼ì˜ í˜„ì¥ ìš´ì˜ìš©ìœ¼ë¡œ ì‰½ê²Œ ì¬í¬ì¥(ìŠ¤í‚¨ ë³€ê²½)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) ì¤€ë¹„ë¬¼</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> ê¶Œì¥.<br>
            ì €ê°€ BLE í‚¤íŒŒì¸ë” íƒœê·¸ ì¤€ë¹„ (ê²€ìƒ‰ì–´: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Antiâ€‘lost BLE</span>).<br>
            BLE ì•ˆì •ì„±ì„ ìœ„í•´ <span class="kbd">https://</span> ë˜ëŠ” <span class="kbd">localhost</span> ì‹¤í–‰ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) ë°ëª¨ íƒœê·¸ ë“±ë¡</div>
          <div class="tip-body">
            Home â†’ <strong>ë°ëª¨ íƒœê·¸ ì¶”ê°€</strong>.<br>
            ìœ„ìë“œëŠ” (A) íƒœê·¸ë¥¼ ê°€ê¹Œì´ ëŒ€ê¸° â†’ (B) ë©€ë¦¬ ì´ë™í•˜ê¸°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
            ì£¼ë³€ BLE ê¸°ê¸°ê°€ ë§ì„ ë•Œë„ â€œë‚´ íƒœê·¸â€ë¥¼ ì°¾ê¸° ìœ„í•œ ì ˆì°¨ì…ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) ëª¨ë‹ˆí„°ë§ ì‹œì‘</div>
          <div class="tip-body">
            <strong>Start</strong>ë¥¼ ëˆ„ë¥´ë©´ SAFE / CAUTION / WARNING ê°™ì€ ì¡´ì´ í‘œì‹œë©ë‹ˆë‹¤.
            ì—¬ê¸°ì„œ ë§í•˜ëŠ” â€œAIâ€ëŠ” ê±°ëŒ€í•œ ëª¨ë¸ì´ ì•„ë‹ˆë¼, ì‘ì€ ì•Œê³ ë¦¬ì¦˜ ë¬¶ìŒì…ë‹ˆë‹¤:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>ë…¸ì´ì¦ˆ ì‹ í˜¸ë¥¼ ë¶€ë“œëŸ½ê²Œ(ì¹¼ë§Œ í•„í„°),</li>
              <li>ì•Œë¦¼ í­ì£¼ ë°©ì§€(íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ + í”Œë˜í•‘ ì–µì œ),</li>
              <li>ì›í•˜ë©´ ì‚¬ìš©ì í”¼ë“œë°±ì„ ë¡œì»¬ì—ì„œ í•™ìŠµ(ê²½ëŸ‰ í•™ìŠµ ëª¨ë“ˆ).</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ì´ê²ƒì€ ë¬´ì—‡ì´ â€œì•„ë‹Œê°€â€</div>
          <div class="tip-body">
            <strong>GPSê°€ ì•„ë‹™ë‹ˆë‹¤.</strong> BLE ê·¼ì ‘ì€ ìˆ˜ì‹­ ë¯¸í„° ë‚´ì—ì„œ ìœ ìš©í•˜ì§€ë§Œ, ë²½/ì‚¬ëŒ/ê¸ˆì†/ì£¼ë¨¸ë‹ˆì— í¬ê²Œ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.
            â€œì •ë‹µâ€ì´ ì•„ë‹ˆë¼ <strong>ì°¸ê³  ì‹ í˜¸</strong>ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / ê¸´ê¸‰ ë°ëª¨</h3>
        <div class="tip-card info">
          <div class="tip-title">ì˜¤í”„ë¼ì¸ QR + ì˜¤ë””ì˜¤ ë¹„ì½˜</div>
          <div class="tip-body">
            SOS ëª¨ë“œëŠ” <strong>ì˜¤í”„ë¼ì¸ QR ì—°ë½ ì¹´ë“œ</strong>ë¥¼ ë§Œë“¤ê³ , í° ì†Œë¦¬ì˜ <strong>ì˜¤ë””ì˜¤ ë¹„ì½˜</strong>ì„ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ì •ì „/í†µì‹ ì¥ì•  ìƒí™©ì—ì„œë„ ë™ì‘í•˜ëŠ” â€œë³µì›ë ¥(Resilience) ê¸°ë³¸ ë„êµ¬â€ ì‹œì—°ì…ë‹ˆë‹¤.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ ê°œì¸ì •ë³´ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ë°ì´í„° ìˆ˜ì§‘ ì—†ìŒ</div>
          <div class="tip-body">
            VitalGuard AIëŠ” ì„œë²„ë¡œ í…”ë ˆë©”íŠ¸ë¦¬/ë¶„ì„/ê°œì¸ì •ë³´ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ëŠ” ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
            ë°±ì—…/ë‚´ë³´ë‚´ê¸°ëŠ” ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ìˆ˜í–‰ë˜ë©°, ì–¸ì œë“  ì „ì²´ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ì•ˆì „ ì£¼ì˜</div>
          <div class="tip-body">
            ë³¸ íŒŒì¼ì€ ê¸°ìˆ  ì‹œì—°ìš©ì…ë‹ˆë‹¤. ìƒëª…â€‘ì•ˆì „ ì˜ì‚¬ê²°ì •ì˜ ìœ ì¼í•œ ë„êµ¬ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
          </div>
        </div>
      `,
      ar: `
        <h2 style="margin-bottom:12px">ğŸ“– Ø¨Ø¯Ø¡ Ø³Ø±ÙŠØ¹ (Ù„ØºÙŠØ± Ø§Ù„Ù…Ø®ØªØµÙŠÙ†)</h2>

        <div class="tip-card info">
          <div class="tip-title">Ù„Ù…Ø§Ø°Ø§ ØªØ¨Ø¯Ùˆ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙƒÙ€ â€œÙ…Ù‚ÙˆØ¯ Ø£Ù…Ø§Ù† Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øªâ€ØŸ</div>
          <div class="tip-body">
            Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙˆØ´Ø¨ÙƒØ© Ø§Ù„Ù‚Ø±Ø¨ BLE ÙÙŠ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŒ ØªÙ… ØªÙ‚Ø¯ÙŠÙ…Ù‡ Ø¨ÙˆØ§Ø¬Ù‡Ø© â€œÙ…Ù‚ÙˆØ¯ Ø£Ù…Ø§Ù† Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øªâ€ Ù„Ø£Ù†Ù‡Ø§ Ø­Ø§Ù„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø§Ù…Ø© ÙˆØºÙŠØ± Ø­Ø³Ø§Ø³Ø©.
            <br><br>
            ÙˆÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ø±Ùƒ Ù†ÙØ³Ù‡ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø° ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª</div>
          <div class="tip-body">
            ÙŠÙˆØµÙ‰ Ø¨Ù€ <strong>Android + Chrome</strong>.<br>
            Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© BLE Ø±Ø®ÙŠØµØ© (ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø«: <span class="kbd">iTag</span>ØŒ <span class="kbd">Key Finder</span>ØŒ <span class="kbd">Antiâ€‘lost BLE</span>).<br>
            Ù„Ø£ÙØ¶Ù„ Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ø³ØªØ®Ø¯Ù… <span class="kbd">https://</span> Ø£Ùˆ <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ø§Ù…Ø©</div>
          <div class="tip-body">
            Home â†’ <strong>Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø±Ø¶</strong>.<br>
            Ø³ÙŠØ·Ù„Ø¨ Ù…Ù†Ùƒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø«Ù… Ø¥Ø¨Ø¹Ø§Ø¯Ù‡Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ø¨ÙŠØ¦Ø§Øª BLE Ø§Ù„Ù…Ø²Ø¯Ø­Ù…Ø©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</div>
          <div class="tip-body">
            Ø§Ø¶ØºØ· <strong>Start</strong>. Ø³ØªØ±Ù‰ Ù…Ù†Ø§Ø·Ù‚ Ù…Ø«Ù„ SAFE / CAUTION / WARNING.
            â€œØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠâ€ Ù‡Ù†Ø§ Ù„ÙŠØ³ Ù†Ù…ÙˆØ°Ø¬Ù‹Ø§ Ø¶Ø®Ù…Ù‹Ø§ØŒ Ø¨Ù„ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª ØµØºÙŠØ±Ø©:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ø¶Ø¬ÙŠØ¬ (Kalman)ØŒ</li>
              <li>ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø±Ø§Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ØªÙƒØ±Ø± (hysteresis + antiâ€‘flapping)ØŒ</li>
              <li>ØªØ¹Ù„Ù… Ù…Ø­Ù„ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ù…Ø§ Ù„ÙŠØ³ Ø¹Ù„ÙŠÙ‡ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          <div class="tip-body">
            Ù‡Ø°Ø§ <strong>Ù„ÙŠØ³ GPS</strong>. Ø§Ù„Ù‚Ø±Ø¨ Ø¹Ø¨Ø± Bluetooth ÙŠØªØ£Ø«Ø± Ø¨Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† ÙˆØ§Ù„Ø£Ø¬Ø³Ø§Ù… ÙˆØ§Ù„Ø§Ø²Ø¯Ø­Ø§Ù… ÙˆØ§Ù„Ø¬ÙŠÙˆØ¨.
            Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒØ¥Ø´Ø§Ø±Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ„ÙŠØ³ ÙƒÙ…Ø³Ø§ÙØ© Ø¯Ù‚ÙŠÙ‚Ø©.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
        <div class="tip-card info">
          <div class="tip-title">QR Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ + Ù…Ù†Ø§Ø±Ø© ØµÙˆØªÙŠØ©</div>
          <div class="tip-body">
            ÙŠÙ…ÙƒÙ† Ù„ÙˆØ¶Ø¹ SOS Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© QR Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙˆØªØ´ØºÙŠÙ„ Ù…Ù†Ø§Ø±Ø© ØµÙˆØªÙŠØ© Ø¹Ø§Ù„ÙŠØ©.
            Ù‡Ø°Ø§ Ø¹Ø±Ø¶ Ù„Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© ØªØ¹Ù…Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ Ø§Ù„Ø®ØµÙˆØµÙŠØ© / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Ù„Ø§ Ø¬Ù…Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="tip-body">
            Ù„Ø§ ÙŠØ±Ø³Ù„ VitalGuard AI Ø£ÙŠ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ø¥Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù…. ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø².
            ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„Ø§Ù…Ø©</div>
          <div class="tip-body">
            Ù‡Ø°Ø§ Ø¹Ø±Ø¶ ØªÙ‚Ù†ÙŠ. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡ ÙƒØ£Ø¯Ø§Ø© ÙˆØ­ÙŠØ¯Ø© Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø­Ø±Ø¬Ø© Ù„Ù„Ø­ÙŠØ§Ø©.
          </div>
        </div>
      `,
      ja: `
        <h2 style="margin-bottom:12px">ğŸ“– ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆéæŠ€è¡“è€…å‘ã‘ï¼‰</h2>

        <div class="tip-card info">
          <div class="tip-title">ãªãœã€Œãƒšãƒƒãƒˆå®‰å…¨ãƒªãƒ¼ãƒ‰ã€ãªã®ã‹</div>
          <div class="tip-body">
            ã‚ªãƒ•ãƒ©ã‚¤ãƒ³AIã‚¨ãƒ³ã‚¸ãƒ³ã¨ BLE è¿‘æ¥ãƒ¡ãƒƒã‚·ãƒ¥ã®å‹•ä½œã‚’æ—¥å¸¸ç’°å¢ƒã§æ¤œè¨¼ã™ã‚‹ãŸã‚ã€æœ€ã‚‚æ™®éçš„ã§ç„¡å®³ãªä¾‹ã¨ã—ã¦ã€Œãƒšãƒƒãƒˆå®‰å…¨ãƒªãƒ¼ãƒ‰ã€ã‚¹ã‚­ãƒ³ã§ä½œã‚Šã¾ã—ãŸã€‚
            <br><br>
            åŒã˜ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€é¿é›£ãƒ»æœç´¢æ•‘åŠ©ãƒ»äººé“æ”¯æ´ã®ç¾å ´å‘ã‘ã«ã‚¹ã‚­ãƒ³ã‚’å¤‰ãˆã¦å†åˆ©ç”¨ã§ãã¾ã™ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) å¿…è¦ãªã‚‚ã®</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> æ¨å¥¨ã€‚<br>
            å®‰ä¾¡ãª BLE ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆæ¤œç´¢: <span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> / <span class="kbd">Antiâ€‘lost BLE</span>ï¼‰ã€‚<br>
            ã§ãã‚Œã° <span class="kbd">https://</span> ã‹ <span class="kbd">localhost</span> ã§å®Ÿè¡Œã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) ãƒ‡ãƒ¢ã‚¿ã‚°ç™»éŒ²</div>
          <div class="tip-body">
            Home â†’ <strong>ãƒ‡ãƒ¢ã‚¿ã‚°è¿½åŠ </strong>ã€‚<br>
            è¿‘ã¥ã‘ã‚‹â†’é›¢ã™æ‰‹é †ã§ã€æ··é›‘ã—ãŸ BLE ç’°å¢ƒã§ã‚‚æ­£ã—ã„ã‚¿ã‚°ã‚’è¦‹åˆ†ã‘ã‚„ã™ãã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) ç›£è¦–é–‹å§‹</div>
          <div class="tip-body">
            <strong>Start</strong> ã‚’æŠ¼ã™ã¨ SAFE / CAUTION / WARNING ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            ã“ã“ã§ã® â€œAIâ€ ã¯å·¨å¤§ãƒ¢ãƒ‡ãƒ«ã§ã¯ãªãã€å°ã•ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç¾¤ã§ã™ï¼š
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>ãƒã‚¤ã‚ºã‚’å¹³æ»‘åŒ–ï¼ˆKalmanï¼‰ã€</li>
              <li>åˆ¤æ–­ã‚’å®‰å®šåŒ–ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆä¹±ç™ºã‚’é˜²ãï¼ˆãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼‹ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°æŠ‘åˆ¶ï¼‰ã€</li>
              <li>å¿…è¦ã«å¿œã˜ã¦ç«¯æœ«å†…ã§å­¦ç¿’ï¼ˆè»½é‡å­¦ç¿’ï¼‰ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ã“ã‚Œã¯ GPS ã§ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          <div class="tip-body">
            Bluetooth è¿‘æ¥ã¯å£ã‚„äººæ··ã¿ã§å¤§ããå¤‰å‹•ã—ã¾ã™ã€‚è·é›¢ã®â€œæ­£ç¢ºã•â€ã§ã¯ãªãã€åˆ¤æ–­ã®ãŸã‚ã® <strong>ç›®å®‰</strong> ã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / ç·Šæ€¥ãƒ‡ãƒ¢</h3>
        <div class="tip-card info">
          <div class="tip-title">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ QR + éŸ³ãƒ“ãƒ¼ã‚³ãƒ³</div>
          <div class="tip-body">
            SOS ã§ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ QR é€£çµ¡ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€å¤§éŸ³é‡ã®éŸ³ãƒ“ãƒ¼ã‚³ãƒ³ã‚’å†ç”Ÿã§ãã¾ã™ã€‚
            åœé›»ã‚„ãƒãƒƒãƒˆéšœå®³ã§ã‚‚å‹•ã â€œãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹è¦ç´ â€ ã®ãƒ‡ãƒ¢ã§ã™ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ãƒ‡ãƒ¼ã‚¿åé›†ãªã—</div>
          <div class="tip-body">
            VitalGuard AI ã¯ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼/è§£æ/å€‹äººæƒ…å ±ã‚’é€ä¿¡ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã®ã¿ã€‚
            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ãƒœã‚¿ãƒ³æ“ä½œæ™‚ã®ã¿ã§ã€ã„ã¤ã§ã‚‚å…¨æ¶ˆå»ã§ãã¾ã™ã€‚
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">å®‰å…¨ä¸Šã®æ³¨æ„</div>
          <div class="tip-body">
            æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¯æŠ€è¡“ãƒ‡ãƒ¢ã§ã™ã€‚ç”Ÿå‘½ã«é–¢ã‚ã‚‹åˆ¤æ–­ã®å”¯ä¸€ã®æ‰‹æ®µã¨ã—ã¦ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
          </div>
        </div>
      `,
      fr: `
        <h2 style="margin-bottom:12px">ğŸ“– DÃ©marrage rapide (public non technique)</h2>

        <div class="tip-card info">
          <div class="tip-title">Pourquoi â€œLaisse de sÃ©curitÃ©â€ ?</div>
          <div class="tip-body">
            Pour tester le moteur IA hors ligne et la maille de proximitÃ© BLE en conditions rÃ©elles, le prototype est habillÃ© en â€œLaisse de sÃ©curitÃ©â€ â€” un cas dâ€™usage universel et neutre.
            <br><br>
            Le mÃªme moteur peut Ãªtre rÃ©habillÃ© pour lâ€™Ã©vacuation, la rechercheâ€‘sauvetage et les opÃ©rations humanitaires.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) Ce quâ€™il faut</div>
          <div class="tip-body">
            <strong>Android + Chrome</strong> recommandÃ©.<br>
            Balise BLE bon marchÃ© (motsâ€‘clÃ©sÂ : <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Antiâ€‘lost BLE</span>).<br>
            Pour plus de fiabilitÃ©, exÃ©cuter via <span class="kbd">https://</span> ou <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Enregistrer une balise</div>
          <div class="tip-body">
            Home â†’ <strong>Ajouter une balise</strong>.<br>
            Lâ€™assistant demande de rapprocher puis dâ€™Ã©loigner la balise pour lâ€™identifier dans un environnement BLE chargÃ©.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Lancer la surveillance</div>
          <div class="tip-body">
            Appuyez sur <strong>Start</strong>. Vous verrez SAFE / CAUTION / WARNING.
            Ici, â€œIAâ€ = algorithmes compacts :
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>lisser le signal (Kalman),</li>
              <li>stabiliser les dÃ©cisions (hystÃ©rÃ©sis + antiâ€‘flapping),</li>
              <li>apprentissage local optionnel.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ce nâ€™est pas du GPS</div>
          <div class="tip-body">
            Le RSSI Bluetooth est bruitÃ©. Utilisez les zones comme <strong>indications</strong>, pas comme une distance exacte.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / Urgence</h3>
        <div class="tip-card info">
          <div class="tip-title">QR hors ligne + balise audio</div>
          <div class="tip-body">
            Le mode SOS peut gÃ©nÃ©rer une carte QR hors ligne et jouer une balise sonore.
            DÃ©monstration de primitives simples qui fonctionnent pendant une panne.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ Vie privÃ©e / RGPD</h3>
        <div class="tip-card info">
          <div class="tip-title">Aucune collecte</div>
          <div class="tip-body">
            VitalGuard AI nâ€™envoie pas de tÃ©lÃ©mÃ©trie/analytics/donnÃ©es personnelles. Tout reste sur lâ€™appareil.
            Export uniquement sur action explicite, suppression possible Ã  tout moment.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Note de sÃ©curitÃ©</div>
          <div class="tip-body">
            DÃ©mo technique. Ne pas utiliser comme seul outil pour des dÃ©cisions vitales.
          </div>
        </div>
      `,
      'zh-TW': `
        <h2 style="margin-bottom:12px">ğŸ“– å¿«é€Ÿä¸Šæ‰‹ï¼ˆéæŠ€è¡“äººå“¡ï¼‰</h2>

        <div class="tip-card info">
          <div class="tip-title">ç‚ºä»€éº¼çœ‹èµ·ä¾†åƒã€Œå¯µç‰©å®‰å…¨ç‰½ç¹©ã€ï¼Ÿ</div>
          <div class="tip-body">
            ç‚ºäº†åœ¨æ—¥å¸¸ç’°å¢ƒæ¸¬è©¦é›¢ç·š AI å¼•æ“èˆ‡ BLE è¿‘è·é›¢ç¶²æ ¼çš„ç©©å®šæ€§ï¼ŒåŸå‹å…ˆä»¥ã€Œå¯µç‰©å®‰å…¨ç‰½ç¹©ã€å‘ˆç¾â€”â€”æœ€æ™®éä¸”ç„¡å®³çš„æƒ…å¢ƒã€‚
            <br><br>
            åŒä¸€å¥—å¼•æ“ä¹Ÿèƒ½é€éæ›çš®ï¼Œå¿«é€Ÿæ”¹æˆæ’¤é›¢ã€æœæ•‘èˆ‡äººé“ç¾å ´ä½œæ¥­ç”¨é€”ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) ä½ éœ€è¦ä»€éº¼</div>
          <div class="tip-body">
            å»ºè­°ä½¿ç”¨ <strong>Android + Chrome</strong>ã€‚<br>
            æº–å‚™ä¾¿å®œçš„ BLE é˜²ä¸Ÿé‘°åŒ™åœˆï¼ˆæœå°‹ï¼š<span class="kbd">iTag</span> / <span class="kbd">Key Finder</span> / <span class="kbd">Antiâ€‘lost BLE</span>ï¼‰ã€‚<br>
            ç‚ºäº†æ›´ç©©å®šï¼Œå»ºè­°åœ¨ <span class="kbd">https://</span> æˆ– <span class="kbd">localhost</span> åŸ·è¡Œã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) è¨»å†Šç¤ºç¯„æ¨™ç±¤</div>
          <div class="tip-body">
            Home â†’ <strong>æ–°å¢ç¤ºç¯„æ¨™ç±¤</strong>ã€‚<br>
            ç²¾éˆæœƒè¦æ±‚å…ˆé è¿‘å†èµ°é ï¼Œç”¨ä¾†åœ¨ BLE å¾ˆæ“æ“ çš„ç’°å¢ƒä¸­æ‰¾åˆ°æ­£ç¢ºçš„æ¨™ç±¤ã€‚
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) é–‹å§‹ç›£æ¸¬</div>
          <div class="tip-body">
            æŒ‰ä¸‹ <strong>Start</strong> å¾Œæœƒçœ‹åˆ° SAFE / CAUTION / WARNINGã€‚
            é€™è£¡çš„ â€œAIâ€ ä¸æ˜¯å·¨å¤§æ¨¡å‹ï¼Œè€Œæ˜¯å°å‹æ¼”ç®—æ³•çµ„åˆï¼š
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>å¹³æ»‘é›œè¨Šï¼ˆKalmanï¼‰ã€</li>
              <li>ç©©å®šåˆ¤æ–·é¿å…ç‹‚è·³ï¼ˆé²æ»¯ + é˜²æŠ–ï¼‰ã€</li>
              <li>å¯é¸ï¼šåœ¨æœ¬æ©Ÿå¾å›é¥‹å­¸ç¿’ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">é€™ä¸æ˜¯ GPS</div>
          <div class="tip-body">
            è—ç‰™ RSSI æœƒå—ç‰†å£ã€äººç¾¤ã€å£è¢‹å½±éŸ¿ã€‚è«‹æŠŠå€åŸŸç•¶ä½œ <strong>æŒ‡æ¨™</strong>ï¼Œä¸è¦è¦–ç‚ºç²¾æº–è·é›¢ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / ç·Šæ€¥ç¤ºç¯„</h3>
        <div class="tip-card info">
          <div class="tip-title">é›¢ç·š QR + éŸ³è¨Šä¿¡æ¨™</div>
          <div class="tip-body">
            SOS å¯ç”¢ç”Ÿé›¢ç·š QR è¯çµ¡å¡ä¸¦æ’­æ”¾é«˜åˆ†è²éŸ³è¨Šä¿¡æ¨™ã€‚é€™æ˜¯åœ¨å±•ç¤ºåœé›»/æ–·ç¶²æ™‚ä»å¯ç”¨çš„åŸºç¤å·¥å…·ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ éš±ç§ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ä¸æ”¶é›†è³‡æ–™</div>
          <div class="tip-body">
            VitalGuard AI ä¸æœƒæŠŠä»»ä½•åˆ†ææˆ–å€‹è³‡é€åˆ°ä¼ºæœå™¨ã€‚è³‡æ–™åªåœ¨æœ¬æ©Ÿã€‚
            åŒ¯å‡ºåƒ…åœ¨ä½ æŒ‰ä¸‹æŒ‰éˆ•æ™‚ç™¼ç”Ÿï¼Œä¸”å¯éš¨æ™‚å…¨éƒ¨åˆªé™¤ã€‚
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">å®‰å…¨æé†’</div>
          <div class="tip-body">
            é€™æ˜¯æŠ€è¡“ç¤ºç¯„ï¼Œè«‹å‹¿ä½œç‚ºç”Ÿå‘½é—œéµæ±ºç­–çš„å”¯ä¸€å·¥å…·ã€‚
          </div>
        </div>
      `,
      es: `
        <h2 style="margin-bottom:12px">ğŸ“– Inicio rÃ¡pido (para no tÃ©cnicos)</h2>

        <div class="tip-card info">
          <div class="tip-title">Por quÃ© parece una â€œcorrea para mascotasâ€</div>
          <div class="tip-body">
            Para probar el motor de IA offline y la malla de proximidad BLE en entornos cotidianos, el prototipo se mostrÃ³ como â€œCorrea de seguridad para mascotasâ€, el caso mÃ¡s universal y neutro.
            <br><br>
            El mismo motor puede â€œcambiar de pielâ€ para evacuaciÃ³n, bÃºsqueda y rescate, y operaciones humanitarias.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">1) QuÃ© necesitas</div>
          <div class="tip-body">
            Recomendado: <strong>Android + Chrome</strong>.<br>
            Etiqueta BLE barata (busca: <span class="kbd">iTag</span>, <span class="kbd">Key Finder</span>, <span class="kbd">Antiâ€‘lost BLE</span>).<br>
            Para mayor fiabilidad, ejecuta con <span class="kbd">https://</span> o <span class="kbd">localhost</span>.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">2) Registrar una etiqueta</div>
          <div class="tip-body">
            Home â†’ <strong>AÃ±adir etiqueta</strong>.<br>
            El asistente te pide acercar y luego alejar la etiqueta para identificarla en entornos BLE con mucho ruido.
          </div>
        </div>

        <div class="tip-card info">
          <div class="tip-title">3) Iniciar la monitorizaciÃ³n</div>
          <div class="tip-body">
            Pulsa <strong>Start</strong>. VerÃ¡s SAFE / CAUTION / WARNING.
            AquÃ­ â€œIAâ€ significa algoritmos compactos:
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li>suavizar el ruido (Kalman),</li>
              <li>estabilizar decisiones (histÃ©resis + antiâ€‘flapping),</li>
              <li>aprendizaje local opcional.</li>
            </ul>
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Esto NO es GPS</div>
          <div class="tip-body">
            El RSSI Bluetooth es ruidoso. Usa las zonas como <strong>seÃ±ales</strong>, no como distancia exacta.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸš¨ SOS / Emergencia</h3>
        <div class="tip-card info">
          <div class="tip-title">QR offline + baliza de audio</div>
          <div class="tip-body">
            SOS puede generar una tarjeta QR sin conexiÃ³n y reproducir una baliza sonora.
            Es una demo de herramientas simples que funcionan durante apagones.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”’ Privacidad / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Sin recopilaciÃ³n de datos</div>
          <div class="tip-body">
            VitalGuard AI no envÃ­a analÃ­ticas ni datos personales a servidores. Todo queda en el dispositivo.
            ExportaciÃ³n solo con acciÃ³n explÃ­cita, borrado disponible en cualquier momento.
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Nota de seguridad</div>
          <div class="tip-body">
            DemostraciÃ³n tÃ©cnica. No usar como Ãºnica herramienta para decisiones crÃ­ticas.
          </div>
        </div>
      `
    },

    legal: {
      en: `
        <h2 style="margin-bottom:10px">About VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> is a singleâ€‘file, offlineâ€‘only demonstration of a tiny onâ€‘device AI engine paired with Bluetooth proximity sensing.</p>
          <p style="margin-top:8px"><strong>Designed for â€œshutdown conditionsâ€:</strong> no internet, no cloud, no accounts, no app store â€” still functional.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">What makes this credible</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Auditable:</strong> one HTML file, no external libraries, no hidden network calls.</li>
              <li><strong>Privacyâ€‘first:</strong> zero telemetry. Data stays on the device by default.</li>
              <li><strong>Resilient:</strong> BLE proximity + compact mathâ€‘based AI (filters, decision stability, local learning).</li>
              <li><strong>Deployable:</strong> runs on older Android phones with cheap BLE tags.</li>
              <li><strong>Meshâ€‘ready:</strong> concept support for cooperative multiâ€‘phone scanning and offline result sharing.</li>
              <li><strong>Secure exports:</strong> optional encrypted â€œRescue Packâ€ backups for audits/handâ€‘off.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>How it works (plain language)</h3>
        <div class="tip-card info">
          <div class="tip-title">1) Listen</div>
          <div class="tip-body">The phone listens for BLE advertisements. Each advertisement includes an RSSI value (signal strength).</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">2) Stabilize</div>
          <div class="tip-body">RSSI is noisy, so the engine filters it and stabilizes zone decisions to avoid â€œalert spamâ€.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">3) Act</div>
          <div class="tip-body">When the zone crosses a threshold for long enough, the app can alert, log, and provide SOS primitives (QR, audio).</div>
        </div>

        <div class="divider"></div>

        <h3>Privacy / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">No data collection</div>
          <div class="tip-body">
            The demo does not send analytics or personal data anywhere. Optional exports are userâ€‘initiated. You can erase everything.
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ethical use</div>
          <div class="tip-body">
            Humanitarian use only. Military or surveillance use is prohibited by the projectâ€™s ethical license.
          </div>
        </div>

        <div class="divider"></div>

        <h3>Contact</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">Disclaimer</div>
          <div class="tip-body">This is a technology demonstration, not a certified lifeâ€‘critical device.</div>
        </div>
      `,
      ko: `
        <h2 style="margin-bottom:10px">VitalGuard AI ì†Œê°œ</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong>ëŠ” â€œë‹¨ì¼ HTML íŒŒì¼â€ ì•ˆì—ì„œ ë™ì‘í•˜ëŠ” <strong>ì˜¤í”„ë¼ì¸ AI ì—”ì§„ + ë¸”ë£¨íˆ¬ìŠ¤ ê·¼ì ‘</strong> ê¸°ìˆ  ì‹œì—°ì…ë‹ˆë‹¤.</p>
          <p style="margin-top:8px"><strong>ì…§ë‹¤ìš´(Shutdown) ì¡°ê±´</strong>â€”ì¸í„°ë„· ì—†ìŒ, í´ë¼ìš°ë“œ ì—†ìŒ, ê³„ì • ì—†ìŒ, ì•±ìŠ¤í† ì–´ ì—†ìŒâ€”ì—ì„œë„ ë™ì‘í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ì™œ ì‹ ë¢°í•  ë§Œí•œê°€?</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ê°ì‚¬ ê°€ëŠ¥:</strong> ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ë‹¨ì¼ HTML íŒŒì¼(ìˆ¨ì€ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ ì—†ìŒ).</li>
              <li><strong>í”„ë¼ì´ë²„ì‹œ ìš°ì„ :</strong> í…”ë ˆë©”íŠ¸ë¦¬ 0. ë°ì´í„°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ê¸°ê¸°ì—ë§Œ.</li>
              <li><strong>ë³µì›ë ¥:</strong> BLE ê·¼ì ‘ + ìˆ˜í•™ ê¸°ë°˜ ê²½ëŸ‰ AI(í•„í„°/ì•ˆì •í™”/ë¡œì»¬ í•™ìŠµ).</li>
              <li><strong>í˜„ì¥ì„±:</strong> êµ¬í˜• ì•ˆë“œë¡œì´ë“œí° + ì €ê°€ BLE íƒœê·¸ë¡œë„ ì‹œì—° ê°€ëŠ¥.</li>
              <li><strong>ë©”ì‰¬ ì¤€ë¹„:</strong> ì—¬ëŸ¬ ëŒ€ì˜ í° í˜‘ë ¥ ìŠ¤ìº” + ì˜¤í”„ë¼ì¸ ê²°ê³¼ ê³µìœ (í™•ì¥ ë°©í–¥).</li>
              <li><strong>ë³´ì•ˆ ë‚´ë³´ë‚´ê¸°:</strong> ì„ íƒì ìœ¼ë¡œ ì•”í˜¸í™”ëœ â€œRescue Packâ€ ë°±ì—…ì„ ì œê³µ.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ì‘ë™ ì›ë¦¬(ì‰½ê²Œ)</h3>
        <div class="tip-card info">
          <div class="tip-title">1) ë“£ê¸°</div>
          <div class="tip-body">íœ´ëŒ€í°ì´ BLE ê´‘ê³  íŒ¨í‚·ì„ ë“£ìŠµë‹ˆë‹¤. íŒ¨í‚·ì—ëŠ” RSSI(ì‹ í˜¸ì„¸ê¸°)ê°€ í¬í•¨ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">2) ì•ˆì •í™”</div>
          <div class="tip-body">RSSIëŠ” ë…¸ì´ì¦ˆê°€ ì»¤ì„œ í•„í„°ë§í•˜ê³ , ì¡´ íŒì •ì„ ì•ˆì •í™”í•´ â€œì•Œë¦¼ í­ì£¼â€ë¥¼ ì¤„ì…ë‹ˆë‹¤.</div>
        </div>
        <div class="tip-card info">
          <div class="tip-title">3) í–‰ë™</div>
          <div class="tip-body">ì„ê³„ê°’ì„ ì¶©ë¶„íˆ ì˜¤ë˜ ë„˜ìœ¼ë©´ ê²½ë³´/ê¸°ë¡ì„ ë§Œë“¤ê³ , SOS(ì˜¤í”„ë¼ì¸ QR, ì˜¤ë””ì˜¤)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</div>
        </div>

        <div class="divider"></div>

        <h3>ê°œì¸ì •ë³´ / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">ë°ì´í„° ìˆ˜ì§‘ ì—†ìŒ</div>
          <div class="tip-body">
            ì´ ë°ëª¨ëŠ” ë¶„ì„/ê°œì¸ì •ë³´ë¥¼ ì™¸ë¶€ë¡œ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‚´ë³´ë‚´ê¸°/ë°±ì—…ì€ ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì „ì²´ ì‚­ì œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">ìœ¤ë¦¬ì  ì‚¬ìš©</div>
          <div class="tip-body">
            ì¸ë„ì£¼ì˜ ëª©ì ì— í•œí•¨. êµ°ì‚¬ìš©/ê°ì‹œìš© ì‚¬ìš©ì€ ìœ¤ë¦¬ ë¼ì´ì„ ìŠ¤ë¡œ ê¸ˆì§€í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="divider"></div>

        <h3>ì—°ë½ì²˜</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger">
          <div class="tip-title">ë©´ì±…</div>
          <div class="tip-body">ë³¸ íŒŒì¼ì€ ê¸°ìˆ  ì‹œì—°ì´ë©° ìƒëª…â€‘ì•ˆì „ ì¸ì¦ ì¥ë¹„ê°€ ì•„ë‹™ë‹ˆë‹¤.</div>
        </div>
      `,
      ar: `
        <h2 style="margin-bottom:10px">Ø­ÙˆÙ„ VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> Ù‡Ùˆ Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù HTML ÙˆØ§Ø­Ø¯ Ù„Ù…Ø­Ø±Ùƒ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØµØºÙŠØ± ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø±Ø¨ Ø¹Ø¨Ø± Bluetooth.</p>
          <p style="margin-top:8px"><strong>Ù…ØµÙ…Ù… Ù„Ø¸Ø±ÙˆÙ â€œØ§Ù„Ø¥ØºÙ„Ø§Ù‚/Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹â€:</strong> Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†ØªØŒ Ø¨Ø¯ÙˆÙ† Ø³Ø­Ø§Ø¨Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨Ø§Øª â€” ÙˆÙ…Ø¹ Ø°Ù„Ùƒ ÙŠØ¹Ù…Ù„.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Ù„Ù…Ø§Ø°Ø§ Ù‡Ùˆ Ù…Ù‚Ù†Ø¹</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚:</strong> Ù…Ù„Ù ÙˆØ§Ø­Ø¯ØŒ Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©ØŒ Ø¨Ø¯ÙˆÙ† Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø´Ø¨ÙƒØ© Ù…Ø®ÙÙŠØ©.</li>
              <li><strong>Ø®ØµÙˆØµÙŠØ© Ø£ÙˆÙ„Ø§Ù‹:</strong> Ù„Ø§ ØªÙ„ÙŠÙ…ØªØ±ÙŠØ©ØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©.</li>
              <li><strong>Ù…Ø±Ù†:</strong> Ù‚Ø±Ø¨ BLE + Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ØµØºÙŠØ±Ø© Ù„ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ù‚Ø±Ø§Ø±.</li>
              <li><strong>Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ø´Ø±:</strong> ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ù‡ÙˆØ§ØªÙ Android Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª BLE Ø±Ø®ÙŠØµØ©.</li>
              <li><strong>Ø¬Ø§Ù‡Ø² Ù„Ù„Ù€ Mesh:</strong> ØªØµÙˆØ± Ù„Ù„ØªØ¹Ø§ÙˆÙ† Ø¨ÙŠÙ† Ø¹Ø¯Ø© Ù‡ÙˆØ§ØªÙ ÙÙŠ Ø§Ù„Ù…Ø³Ø­ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</li>
              <li><strong>ØªØµØ¯ÙŠØ± Ø¢Ù…Ù†:</strong> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© â€œRescue Packâ€ Ù…Ø´ÙÙ‘Ø±Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ (Ø¨Ø¨Ø³Ø§Ø·Ø©)</h3>
        <div class="tip-card info"><div class="tip-title">1) Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</div><div class="tip-body">Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ³ØªÙ…Ø¹ Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª BLE ÙˆÙŠÙ‚Ø±Ø£ RSSI (Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©).</div></div>
        <div class="tip-card info"><div class="tip-title">2) Ø§Ù„ØªØ«Ø¨ÙŠØª</div><div class="tip-body">Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¶Ø¬ÙŠØ¬ÙŠØ©ØŒ Ù„Ø°Ù„Ùƒ ÙŠØªÙ… ØªÙ†Ø¹ÙŠÙ…Ù‡Ø§ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø±Ø§Ø± Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.</div></div>
        <div class="tip-card info"><div class="tip-title">3) Ø§Ù„ÙØ¹Ù„</div><div class="tip-body">Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹ØªØ¨Ø© Ù„ÙØªØ±Ø© ÙƒØ§ÙÙŠØ©ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØªØ³Ø¬ÙŠÙ„ ÙˆØªÙØ¹ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª SOS.</div></div>

        <div class="divider"></div>

        <h3>Ø§Ù„Ø®ØµÙˆØµÙŠØ© / GDPR</h3>
        <div class="tip-card info">
          <div class="tip-title">Ù„Ø§ Ø¬Ù…Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="tip-body">Ù„Ø§ ÙŠØ±Ø³Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù…. Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆØ¨Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡.</div>
        </div>

        <div class="tip-card warn">
          <div class="tip-title">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø®Ù„Ø§Ù‚ÙŠ</div>
          <div class="tip-body">Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ ÙÙ‚Ø·. ÙŠÙØ­Ø¸Ø± Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø£Ùˆ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„ØªØ±Ø®ÙŠØµ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ.</div>
        </div>

        <div class="divider"></div>

        <h3>Ø§ØªØµØ§Ù„</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Ø§Ù„Ù…ÙˆÙ‚Ø¹: <span class="kbd">mcorpai.org</span><br>
            Ø§Ù„Ù…Ù†Ø´Ø¦: <strong>Morgan J.</strong> (Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±ÙŠ: <strong>Gyumin Jeon</strong>)<br>
            Ø§Ù„Ø¨Ø±ÙŠØ¯: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">ØªÙ†Ø¨ÙŠÙ‡</div><div class="tip-body">Ù‡Ø°Ø§ Ø¹Ø±Ø¶ ØªÙ‚Ù†ÙŠ ÙˆÙ„ÙŠØ³ Ø¬Ù‡Ø§Ø²Ù‹Ø§ Ù…Ø¹ØªÙ…Ø¯Ù‹Ø§ Ù„Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ø±Ø¬Ø©.</div></div>
      `,
      ja: `
        <h2 style="margin-bottom:10px">VitalGuard AI ã«ã¤ã„ã¦</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> ã¯ã€1ã¤ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã§å‹•ä½œã™ã‚‹ã€Œå°ã•ãªã‚ªãƒ•ãƒ©ã‚¤ãƒ³AIã‚¨ãƒ³ã‚¸ãƒ³ + Bluetoothè¿‘æ¥ã€ã®æŠ€è¡“ãƒ‡ãƒ¢ã§ã™ã€‚</p>
          <p style="margin-top:8px"><strong>ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³æ¡ä»¶</strong>ï¼ˆãƒãƒƒãƒˆãªã—ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰ãªã—ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—ï¼‰ã§ã‚‚å‹•ãã“ã¨ã‚’ç›®çš„ã«è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ä¿¡é ¼ã§ãã‚‹ãƒã‚¤ãƒ³ãƒˆ</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>ç›£æŸ»ã—ã‚„ã™ã„:</strong> å˜ä¸€HTMLã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã—ã€éš ã‚ŒãŸé€šä¿¡ãªã—ã€‚</li>
              <li><strong>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å„ªå…ˆ:</strong> ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãªã—ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã€‚</li>
              <li><strong>ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹:</strong> BLEè¿‘æ¥ + æ•°å­¦ãƒ™ãƒ¼ã‚¹ã®è»½é‡AIã€‚</li>
              <li><strong>ç¾å ´å‘ã‘:</strong> å¤ã„Androidç«¯æœ« + å®‰ä¾¡ãªBLEã‚¿ã‚°ã§å‹•ä½œã€‚</li>
              <li><strong>ãƒ¡ãƒƒã‚·ãƒ¥æº–å‚™:</strong> è¤‡æ•°ç«¯æœ«ã®å”èª¿ã‚¹ã‚­ãƒ£ãƒ³ã¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å…±æœ‰ï¼ˆæ‹¡å¼µæ–¹å‘ï¼‰ã€‚</li>
              <li><strong>å®‰å…¨ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ:</strong> ä»»æ„ã§æš—å·åŒ–ã•ã‚ŒãŸã€ŒRescue Packã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>ä»•çµ„ã¿ï¼ˆã‚„ã•ã—ãï¼‰</h3>
        <div class="tip-card info"><div class="tip-title">1) å—ä¿¡</div><div class="tip-body">BLEåºƒå‘Šã‚’å—ä¿¡ã—ã€RSSIï¼ˆä¿¡å·å¼·åº¦ï¼‰ã‚’èª­ã¿ã¾ã™ã€‚</div></div>
        <div class="tip-card info"><div class="tip-title">2) å®‰å®šåŒ–</div><div class="tip-body">ãƒã‚¤ã‚ºãŒå¤§ãã„ã®ã§ãƒ•ã‚£ãƒ«ã‚¿ã§å¹³æ»‘åŒ–ã—ã€ã‚¾ãƒ¼ãƒ³åˆ¤å®šã‚’å®‰å®šåŒ–ã—ã¾ã™ã€‚</div></div>
        <div class="tip-card info"><div class="tip-title">3) è¡Œå‹•</div><div class="tip-body">ä¸€å®šæ¡ä»¶ã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚„ãƒ­ã‚°ã€SOSï¼ˆQR/éŸ³ï¼‰ã‚’æä¾›ã—ã¾ã™ã€‚</div></div>

        <div class="divider"></div>

        <h3>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">ãƒ‡ãƒ¼ã‚¿åé›†ãªã—</div><div class="tip-body">ãƒ‡ãƒ¢ã¯åˆ†æã‚„å€‹äººæƒ…å ±ã‚’é€ä¿¡ã—ã¾ã›ã‚“ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ä»»æ„ã§ã€å…¨æ¶ˆå»ã§ãã¾ã™ã€‚</div></div>

        <div class="tip-card warn"><div class="tip-title">å€«ç†çš„åˆ©ç”¨</div><div class="tip-body">äººé“ç›®çš„ã®ã¿ã€‚è»äº‹/ç›£è¦–ç”¨é€”ã¯ç¦æ­¢ï¼ˆå€«ç†ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼‰ã€‚</div></div>

        <div class="divider"></div>

        <h3>é€£çµ¡å…ˆ</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">å…è²¬</div><div class="tip-body">æŠ€è¡“ãƒ‡ãƒ¢ã§ã‚ã‚Šã€ç”Ÿå‘½å®‰å…¨ã®èªè¨¼æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>
      `,
      fr: `
        <h2 style="margin-bottom:10px">Ã€ propos de VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> est une dÃ©monstration â€œtoutâ€‘enâ€‘unâ€ (un seul fichier HTML) dâ€™un petit moteur IA hors ligne couplÃ© Ã  la proximitÃ© Bluetooth.</p>
          <p style="margin-top:8px"><strong>ConÃ§u pour lâ€™â€œÃ©tat de shutdownâ€ :</strong> pas dâ€™internet, pas de cloud, pas de comptes â€” et pourtant fonctionnel.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Pourquoi câ€™est crÃ©dible</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>AuditabilitÃ©:</strong> un seul fichier, aucune dÃ©pendance externe.</li>
              <li><strong>Vie privÃ©e:</strong> zÃ©ro tÃ©lÃ©mÃ©trie, donnÃ©es locales.</li>
              <li><strong>RÃ©silience:</strong> BLE + IA mathÃ©matique compacte.</li>
              <li><strong>DÃ©ployable:</strong> vieux Android + balises bon marchÃ©.</li>
              <li><strong>PrÃªt pour le mesh:</strong> concept de scan coopÃ©ratif multiâ€‘tÃ©lÃ©phones et partage hors ligne.</li>
              <li><strong>Exports sÃ©curisÃ©s:</strong> sauvegardes â€œRescue Packâ€ chiffrÃ©es en option.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>Fonctionnement (simple)</h3>
        <div class="tip-card info"><div class="tip-title">1) Ã‰couter</div><div class="tip-body">Le tÃ©lÃ©phone Ã©coute les annonces BLE et lit le RSSI.</div></div>
        <div class="tip-card info"><div class="tip-title">2) Stabiliser</div><div class="tip-body">Filtrage + stabilitÃ© de dÃ©cision pour Ã©viter les alertes en boucle.</div></div>
        <div class="tip-card info"><div class="tip-title">3) Agir</div><div class="tip-body">Alerte/Journal/SOS (QR, audio) quand les conditions sont remplies.</div></div>

        <div class="divider"></div>

        <h3>Vie privÃ©e / RGPD</h3>
        <div class="tip-card info"><div class="tip-title">Aucune collecte</div><div class="tip-body">Aucune donnÃ©e nâ€™est envoyÃ©e Ã  des serveurs. Export sur action de lâ€™utilisateur, suppression possible.</div></div>

        <div class="tip-card warn"><div class="tip-title">Usage Ã©thique</div><div class="tip-body">Usage humanitaire uniquement. Usage militaire/surveillance interdit par la licence.</div></div>

        <div class="divider"></div>

        <h3>Contact</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Site: <span class="kbd">mcorpai.org</span><br>
            CrÃ©ateur: <strong>Morgan J.</strong> (Nom corÃ©enÂ : <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">Avertissement</div><div class="tip-body">DÃ©mo technique, pas un dispositif certifiÃ©.</div></div>
      `,
      'zh-TW': `
        <h2 style="margin-bottom:10px">é—œæ–¼ VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> æ˜¯å–®ä¸€ HTML æª”æ¡ˆçš„é›¢ç·šæŠ€è¡“ç¤ºç¯„ï¼šå°å‹ AI å¼•æ“ + è—ç‰™è¿‘è·é›¢åµæ¸¬ã€‚</p>
          <p style="margin-top:8px"><strong>ç‚ºã€Œshutdownã€æƒ…å¢ƒè€Œè¨­è¨ˆï¼š</strong>æ²’ç¶²è·¯ã€æ²’é›²ç«¯ã€æ²’å¸³è™Ÿä¹Ÿèƒ½é‹ä½œã€‚</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">ç‚ºä»€éº¼å®ƒå€¼å¾—ä¿¡ä»»</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>å¯å¯©è¨ˆ:</strong> å–®ä¸€æª”æ¡ˆã€ç„¡å¤–éƒ¨å¥—ä»¶ã€ç„¡éš±è—ç¶²è·¯å‘¼å«ã€‚</li>
              <li><strong>éš±ç§å„ªå…ˆ:</strong> é›¶é™æ¸¬ï¼Œè³‡æ–™åªåœ¨æœ¬æ©Ÿã€‚</li>
              <li><strong>éŸŒæ€§:</strong> BLE è¿‘è·é›¢ + æ•¸å­¸å¼è¼•é‡ AIã€‚</li>
              <li><strong>å¯éƒ¨ç½²:</strong> èˆŠ Android + ä¾¿å®œ BLE æ¨™ç±¤ã€‚</li>
              <li><strong>Mesh æº–å‚™:</strong> å¤šå°æ‰‹æ©Ÿå”ä½œæƒæä¸¦é›¢ç·šåˆ†äº«çµæœï¼ˆæ“´å……æ–¹å‘ï¼‰ã€‚</li>
              <li><strong>å®‰å…¨åŒ¯å‡º:</strong> å¯é¸åŠ å¯†ã€ŒRescue Packã€å‚™ä»½ï¼Œæ–¹ä¾¿äº¤æ¥/ç¨½æ ¸ã€‚</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>é‹ä½œæ–¹å¼ï¼ˆç™½è©±ï¼‰</h3>
        <div class="tip-card info"><div class="tip-title">1) ç›£è½</div><div class="tip-body">æ‰‹æ©Ÿç›£è½ BLE å»£æ’­ä¸¦è®€å– RSSIï¼ˆè¨Šè™Ÿå¼·åº¦ï¼‰ã€‚</div></div>
        <div class="tip-card info"><div class="tip-title">2) ç©©å®š</div><div class="tip-body">RSSI å¾ˆåµï¼Œå…ˆç”¨æ¿¾æ³¢å¹³æ»‘ï¼Œå†æŠŠå€åŸŸåˆ¤æ–·ç©©å®šåŒ–é¿å…ç‹‚è·³ã€‚</div></div>
        <div class="tip-card info"><div class="tip-title">3) è¡Œå‹•</div><div class="tip-body">ç¬¦åˆæ¢ä»¶æ™‚è§¸ç™¼æé†’/è¨˜éŒ„ï¼Œä¸¦æä¾› SOSï¼ˆQR/éŸ³è¨Šï¼‰ã€‚</div></div>

        <div class="divider"></div>

        <h3>éš±ç§ / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">ä¸æ”¶é›†è³‡æ–™</div><div class="tip-body">ç¤ºç¯„ä¸æœƒæŠŠè³‡æ–™é€åˆ°ä¼ºæœå™¨ã€‚åŒ¯å‡ºéœ€ä½¿ç”¨è€…æ“ä½œï¼Œäº¦å¯éš¨æ™‚å…¨åˆªã€‚</div></div>

        <div class="tip-card warn"><div class="tip-title">å€«ç†ä½¿ç”¨</div><div class="tip-body">åƒ…é™äººé“ç”¨é€”ã€‚è»äº‹/ç›£æ§ç”¨é€”ç”±å€«ç†æˆæ¬Šç¦æ­¢ã€‚</div></div>

        <div class="divider"></div>

        <h3>è¯çµ¡æ–¹å¼</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Website: <span class="kbd">mcorpai.org</span><br>
            Creator: <strong>Morgan J.</strong> (Korean name: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">å…è²¬è²æ˜</div><div class="tip-body">æŠ€è¡“ç¤ºç¯„ï¼Œéç”Ÿå‘½é—œéµèªè­‰è¨­å‚™ã€‚</div></div>
      `,
      es: `
        <h2 style="margin-bottom:10px">Acerca de VitalGuard AI</h2>
        <div class="highlight-box">
          <p><strong>VitalGuard AI</strong> es una demostraciÃ³n en un solo archivo HTML de un pequeÃ±o motor de IA offline combinado con proximidad Bluetooth.</p>
          <p style="margin-top:8px"><strong>DiseÃ±ado para â€œshutdownâ€:</strong> sin internet, sin nube, sin cuentas â€” y aun asÃ­ funciona.</p>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Por quÃ© es creÃ­ble</div>
          <div class="tip-body">
            <ul style="margin:8px 0 0 18px;line-height:1.6">
              <li><strong>Auditable:</strong> un solo archivo, sin librerÃ­as externas, sin llamadas ocultas.</li>
              <li><strong>Privacidad primero:</strong> cero telemetrÃ­a, datos locales.</li>
              <li><strong>Resiliente:</strong> BLE + IA matemÃ¡tica compacta.</li>
              <li><strong>Desplegable:</strong> funciona en Android antiguos con etiquetas BLE baratas.</li>
              <li><strong>Listo para mesh:</strong> concepto de escaneo cooperativo multiâ€‘telÃ©fono y comparticiÃ³n offline.</li>
              <li><strong>Exportaciones seguras:</strong> copias â€œRescue Packâ€ cifradas opcionales.</li>
            </ul>
          </div>
        </div>

        <div class="divider"></div>

        <h3>CÃ³mo funciona (simple)</h3>
        <div class="tip-card info"><div class="tip-title">1) Escuchar</div><div class="tip-body">El telÃ©fono escucha anuncios BLE y lee el RSSI.</div></div>
        <div class="tip-card info"><div class="tip-title">2) Estabilizar</div><div class="tip-body">Filtra el ruido y estabiliza decisiones para evitar alertas constantes.</div></div>
        <div class="tip-card info"><div class="tip-title">3) Actuar</div><div class="tip-body">Activa alertas, registros y SOS (QR/audio) cuando se cumplen condiciones.</div></div>

        <div class="divider"></div>

        <h3>Privacidad / GDPR</h3>
        <div class="tip-card info"><div class="tip-title">Sin recopilaciÃ³n</div><div class="tip-body">No se envÃ­a informaciÃ³n a servidores. ExportaciÃ³n solo con acciÃ³n del usuario y borrado disponible.</div></div>

        <div class="tip-card warn"><div class="tip-title">Uso Ã©tico</div><div class="tip-body">Solo uso humanitario. Prohibido uso militar o de vigilancia por licencia Ã©tica.</div></div>

        <div class="divider"></div>

        <h3>Contacto</h3>
        <div class="tip-card info">
          <div class="tip-title">McorpAI</div>
          <div class="tip-body">
            Web: <span class="kbd">mcorpai.org</span><br>
            Creador: <strong>Morgan J.</strong> (Nombre coreano: <strong>Gyumin Jeon</strong>)<br>
            Email: <span class="kbd">contact@mcorpai.org</span>
          </div>
        </div>

        <div class="tip-card danger"><div class="tip-title">Aviso</div><div class="tip-body">DemostraciÃ³n tÃ©cnica, no un dispositivo certificado.</div></div>
      `
    }
  };

  let lang = 'en';

  function currentDict(){
    return STR[lang] || STR.en;
  }
  function t(key){
    const d = currentDict();
    return (d && d[key]) || (STR.en && STR.en[key]) || key;
  }
  function setLang(next){
    if(!next || !STR[next]) next = 'en';
    lang = next;
    try{ localStorage.setItem(STORAGE_KEY, lang); }catch(e){}
    apply();
  }
  function getLang(){ return lang; }

  function apply(){
    // html lang/dir
    const htmlLang = (lang==='zh-TW') ? 'zh-Hant' : lang;
    document.documentElement.lang = htmlLang;
    document.documentElement.dir = RTL_LANGS.has(lang) ? 'rtl' : 'ltr';

    // Header
    if($('i18n_app_title')) $('i18n_app_title').textContent = t('app_title');
    if($('i18n_app_sub')) $('i18n_app_sub').textContent = t('app_sub');
    if($('i18n_app_mission')) $('i18n_app_mission').textContent = t('app_mission');
    if($('i18n_app_disclaimer')) $('i18n_app_disclaimer').textContent = t('app_disclaimer');
    if($('i18n_github_link')) $('i18n_github_link').textContent = t('github');
    if($('i18n_help_link')) $('i18n_help_link').textContent = t('help');
    if($('i18n_about_link')) $('i18n_about_link').textContent = t('about');

    // Overlay titles
    if($('i18n_help_title')) $('i18n_help_title').textContent = t('help_title');
    if($('i18n_legal_title')) $('i18n_legal_title').textContent = t('legal_title');

    // Install banner
    if($('i18n_install_title')) $('i18n_install_title').textContent = t('install_title');
    if($('i18n_install_sub')) $('i18n_install_sub').textContent = t('install_sub');
    if($('installBtn')) $('installBtn').textContent = t('install_btn');
    if($('installDismiss')) $('installDismiss').textContent = t('install_dismiss');

    // Home hero
    if($('i18n_hero_title')) $('i18n_hero_title').textContent = t('hero_title');
    if($('i18n_hero_body')) $('i18n_hero_body').textContent = t('hero_body');
    if($('i18n_badge_offline')) $('i18n_badge_offline').textContent = t('badge_offline');
    if($('i18n_badge_gdpr')) $('i18n_badge_gdpr').textContent = t('badge_gdpr');
    if($('i18n_badge_ble')) $('i18n_badge_ble').textContent = t('badge_ble');
    if($('i18n_badge_tiny')) $('i18n_badge_tiny').textContent = t('badge_tiny');
    if($('i18n_contact_line')) $('i18n_contact_line').textContent = t('contact_line');

    // Empty state
    if($('i18n_empty_text')) $('i18n_empty_text').innerHTML = t('empty_text');
    if($('i18n_empty_btn')) $('i18n_empty_btn').textContent = t('empty_btn');

    // Tips
    if($('i18n_tips_title')) $('i18n_tips_title').textContent = t('tips_title');
    if($('tipsI18n')) $('tipsI18n').innerHTML = (HTML.tips[lang] || HTML.tips.en);

    // Bottom nav labels
    document.querySelectorAll('.bnav-btn').forEach(btn=>{
      const tab = btn.getAttribute('data-tab');
      const label = btn.querySelector('span:last-child');
      if(!label) return;
      if(tab==='home') label.textContent = t('nav_home');
      else if(tab==='sos') label.textContent = t('nav_sos');
      else if(tab==='tips') label.textContent = t('nav_tips');
      else if(tab==='settings') label.textContent = t('nav_settings');
    });
  }

  function init(){
    try{
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved && STR[saved]) lang = saved;
    }catch(e){}
    const sel = $('langSelect');
    if(sel){
      sel.value = lang;
      sel.addEventListener('change', ()=>setLang(sel.value));
    }
    apply();
  }

  return { init, apply, t, setLang, getLang, HTML };
})();

/* ----------------------------- STORAGE ----------------------------- */
const Store = {
  db: null,

  async init() {
    return new Promise(resolve=>{
      try{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains('pets')) db.createObjectStore('pets',{keyPath:'id'});
          if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings',{keyPath:'key'});
          if(!db.objectStoreNames.contains('ai')) db.createObjectStore('ai',{keyPath:'key'});
          if(!db.objectStoreNames.contains('alerts')) db.createObjectStore('alerts',{keyPath:'id'});
          if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs',{keyPath:'key'});
        };
        req.onsuccess = e => { this.db = e.target.result; resolve(); };
        req.onerror = () => { console.warn('IndexedDB open failed'); resolve(); };
      }catch(err){
        console.warn('IndexedDB init exception', err);
        resolve();
      }
    });
  },

  async savePet(pet) {
    const data = pet.toJSON();
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').put(data);
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'pet_'+data.id, JSON.stringify(data));
  },

  async getAllPets() {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('pets','readonly').objectStore('pets').getAll();
        req.onsuccess=()=>r(req.result||[]);
        req.onerror=()=>r(this._lsPets());
      });
    }
    return this._lsPets();
  },

  _lsPets() {
    const p=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX+'pet_')){
        try{ p.push(JSON.parse(localStorage.getItem(k))); }catch(e){}
      }
    }
    return p;
  },

  async deletePet(id) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('pets','readwrite');
        tx.objectStore('pets').delete(id);
        tx.oncomplete=()=>r();
        tx.onerror=()=>r();
      });
    }
    localStorage.removeItem(LS_PREFIX+'pet_'+id);
  },

  async clearAll() {
    if(this.db){
      const tx=this.db.transaction(['pets','settings','ai','alerts','blobs'],'readwrite');
      tx.objectStore('pets').clear();
      tx.objectStore('settings').clear();
      tx.objectStore('ai').clear();
      tx.objectStore('alerts').clear();
      tx.objectStore('blobs').clear();
    }
    // SAFE: only delete our keys, NEVER clear all local storage
    const toRemove=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k && k.startsWith(LS_PREFIX)) toRemove.push(k);
    }
    toRemove.forEach(k=>localStorage.removeItem(k));
  },

  async saveSetting(key, value) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('settings','readwrite');
        tx.objectStore('settings').put({key,value});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'s_'+key, JSON.stringify(value));
  },

  async getSetting(key, def) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('settings','readonly').objectStore('settings').get(key);
        req.onsuccess=()=>r(req.result ? req.result.value : def);
        req.onerror=()=>r(def);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'s_'+key);
    return v!==null ? JSON.parse(v) : def;
  },

  async saveAI(key, data) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('ai','readwrite');
        tx.objectStore('ai').put({key, ...data});
        tx.oncomplete=()=>r();
        tx.onerror=()=>{ localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data)); r(); };
      });
    }
    localStorage.setItem(LS_PREFIX+'ai_'+key, JSON.stringify(data));
  },

  async getAI(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('ai','readonly').objectStore('ai').get(key);
        req.onsuccess=()=>r(req.result || null);
        req.onerror=()=>r(null);
      });
    }
    const v=localStorage.getItem(LS_PREFIX+'ai_'+key);
    return v ? JSON.parse(v) : null;
  },

  async saveBlob(key, blob) {
    if(this.db){
      return new Promise(r=>{
        const tx=this.db.transaction('blobs','readwrite');
        tx.objectStore('blobs').put({key, blob, type: blob ? blob.type : ''});
        tx.oncomplete=()=>r(true);
        tx.onerror=()=>r(false);
      });
    }
    // fallback: base64 in localStorage (best-effort)
    if(!blob){ localStorage.removeItem(LS_PREFIX+'blob_'+key); return false; }
    return new Promise(res=>{
      const fr=new FileReader();
      fr.onload=()=>{ try{ localStorage.setItem(LS_PREFIX+'blob_'+key, fr.result); res(true); }catch(e){ res(false); } };
      fr.onerror=()=>res(false);
      fr.readAsDataURL(blob);
    });
  },

  async getBlob(key) {
    if(this.db){
      return new Promise(r=>{
        const req=this.db.transaction('blobs','readonly').objectStore('blobs').get(key);
        req.onsuccess=()=>r(req.result ? req.result.blob : null);
        req.onerror=()=>r(null);
      });
    }
    const dataUrl = localStorage.getItem(LS_PREFIX+'blob_'+key);
    if(!dataUrl) return null;
    // Convert dataURL back to Blob
    try{
      const parts=dataUrl.split(',');
      const meta=parts[0] || '';
      const b64=parts[1] || '';
      const mime=(meta.match(/data:(.*?);base64/)||[])[1] || 'audio/webm';
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    }catch(e){
      return null;
    }
  }
};

/* ----------------------------- SIGNAL FILTER (KALMAN) ----------------------------- */
// Advanced Kalman filter (from V20, adapted)
class KalmanRSSI {
  constructor(){
    this.x=-70;
    this.v=0;
    this.P=[[2,0],[0,2]];
    this.Q=0.15;
    this.R=5;
    this.history=[];
    this.maxHistory=30;
  }
  update(z){
    const xPred=this.x+this.v;
    const pPred=this.P[0][0]+this.Q;
    const innov=z-xPred;
    const K=pPred/(pPred+this.R);
    this.x=xPred+K*innov;
    this.v=this.v+0.1*(innov-this.v);
    this.P[0][0]=(1-K)*pPred;

    this.history.push(z);
    if(this.history.length>this.maxHistory) this.history.shift();

    if(this.history.length>=5){
      const m=this.history.reduce((a,b)=>a+b,0)/this.history.length;
      const vr=this.history.reduce((a,b)=>a+(b-m)**2,0)/this.history.length;
      this.R=clamp(vr*0.5,1,15);
    }
    return this.x;
  }
  getVelocity(){ return this.v; }
  reset(){ this.x=-70; this.v=0; this.R=5; this.history=[]; }
}

/* ----------------------------- DISTANCE ESTIMATOR (V20) ----------------------------- */
class DistanceEstimator {
  constructor(){
    this.txPower=-59;
    this.n=2.5;
    this.calibPoints=[];
  }
  estimate(rssi){
    if(rssi>=0 || isNaN(rssi)) return 0;
    return clamp(Math.pow(10, (this.txPower - rssi)/(10*this.n)), 0, 100);
  }
  addCalibration(rssi, dist){
    this.calibPoints.push({rssi, dist});
    this._recalc();
  }
  _recalc(){
    if(this.calibPoints.length<2) return;
    const p1=this.calibPoints[this.calibPoints.length-2];
    const p2=this.calibPoints[this.calibPoints.length-1];
    if(p1.dist>0 && p2.dist>0 && p1.dist!==p2.dist){
      const lr=Math.log10(p2.dist/p1.dist);
      if(lr!==0){
        this.n = clamp((p1.rssi - p2.rssi)/(10*lr), 1.5, 4);
        this.txPower = p1.rssi + 10*this.n*Math.log10(p1.dist);
      }
    }
  }
  export(){ return {txPower:this.txPower, n:this.n, calibPoints:this.calibPoints}; }
  import(d){
    if(!d) return;
    this.txPower = typeof d.txPower==='number' ? d.txPower : this.txPower;
    this.n = typeof d.n==='number' ? d.n : this.n;
    this.calibPoints = Array.isArray(d.calibPoints) ? d.calibPoints : [];
  }
}

/* ----------------------------- Q-LEARNING LITE (V20/V35) ----------------------------- */
class QLearningLite {
  constructor(){
    this.qTable={};
    this.lr=0.3;
    this.eps=0.2;
    this.count=0;
  }
  _key(zone){ return zone; }
  _getQ(s){
    if(!this.qTable[s]) this.qTable[s]={widen:0, maintain:0, narrow:0};
    return this.qTable[s];
  }
  chooseAction(zone){
    const q=this._getQ(this._key(zone));
    if(Math.random()<this.eps){
      const a=['widen','maintain','narrow'];
      return a[Math.floor(Math.random()*3)];
    }
    return Object.entries(q).reduce((a,b)=>b[1]>a[1]?b:a, ['maintain',-Infinity])[0];
  }
  update(zone, isHelpful, action){
    const s=this._key(zone);
    const q=this._getQ(s);
    const reward=isHelpful?1:-1;
    q[action]=q[action]+this.lr*(reward-q[action]);
    this.count++;
    if(this.count>50) this.lr=0.1;
    if(this.count>200) this.lr=0.05;
    this.eps=Math.max(0.05, this.eps*0.995);
  }
  applyAction(action, thresholds){
    const step=2;
    const t={...thresholds};
    if(action==='widen'){
      t.cautionEnter=Math.max(-90, t.cautionEnter-step);
      t.warningEnter=Math.max(-98, t.warningEnter-step);
      t.dangerEnter=Math.max(-100, t.dangerEnter-step);
    }else if(action==='narrow'){
      t.cautionEnter=Math.min(-40, t.cautionEnter+step);
      t.warningEnter=Math.min(-55, t.warningEnter+step);
      t.dangerEnter=Math.min(-70, t.dangerEnter+step);
    }
    // maintain exit thresholds relative
    t.cautionExit=t.cautionEnter+5;
    t.warningExit=t.warningEnter+6;
    t.dangerExit=t.dangerEnter+6;
    return t;
  }
  export(){ return {qTable:this.qTable, count:this.count, lr:this.lr, eps:this.eps}; }
  import(d){
    if(!d) return;
    this.qTable=d.qTable||{};
    this.count=d.count||0;
    this.lr=typeof d.lr==='number'?d.lr:this.lr;
    this.eps=typeof d.eps==='number'?d.eps:this.eps;
  }
  reset(){ this.qTable={}; this.lr=0.3; this.eps=0.2; this.count=0; }
}

/* ----------------------------- BEHAVIORAL FINGERPRINT ----------------------------- */
class BehavioralFingerprint {
  constructor(){
    this.window=[];
    this.windowSize=60;
  }
  addReading(rssi){
    this.window.push(rssi);
    if(this.window.length>this.windowSize) this.window.shift();
  }
  getFeatures(){
    if(this.window.length<10) return null;
    const w=this.window;
    const mean=w.reduce((a,b)=>a+b,0)/w.length;
    const variance=w.reduce((a,b)=>a+(b-mean)**2,0)/w.length;
    const recent=w.slice(-5);
    const older=w.slice(-10,-5);
    const trendMean=recent.reduce((a,b)=>a+b,0)/recent.length;
    const olderMean=older.length?older.reduce((a,b)=>a+b,0)/older.length:mean;
    const trend=trendMean-olderMean;
    return {mean, variance, trend};
  }
  classify(){
    const f=this.getFeatures();
    if(!f) return 'unknown';
    if(f.trend<-5 && f.variance>30) return 'rapid_departure';
    if(f.trend<-3) return 'moving_away';
    if(f.trend>3) return 'approaching';
    if(f.variance>50) return 'unstable';
    return 'stable';
  }
}

/* ----------------------------- RING BUFFER ----------------------------- */
class RingBuffer {
  constructor(size){ this.size=size; this.buf=[]; }
  push(v){ this.buf.push(v); if(this.buf.length>this.size) this.buf.shift(); }
  get data(){ return this.buf; }
  get length(){ return this.buf.length; }
  get last(){ return this.buf[this.buf.length-1]; }
  clear(){ this.buf=[]; }
  slice(a,b){ return this.buf.slice(a,b); }
}

/* ----------------------------- PET MODEL ----------------------------- */
class Pet {
  constructor(data){
    this.id = data.id || ('pet_'+Date.now()+'_'+Math.random().toString(36).slice(2,6));
    this.name = data.name || 'My Pet';
    this.icon = data.icon || 'ğŸ¶';
    this.createdAt = data.createdAt || Date.now();
    this.signature = data.signature || {};
    this.rescueId = data.rescueId || genRescueId();
    this.thresholds = data.thresholds || {...DEFAULT_THRESHOLDS};
    this.leashPreset = data.leashPreset || '10m';
    this.aiToggles = data.aiToggles || {qlearn:false, behavior:true};
    this.aiState = data.aiState || {};

    // Runtime modules (not raw-persisted; but we import params when available)
    this.kalman = new KalmanRSSI();
    this.distance = new DistanceEstimator();
    if(data.distanceCalib) this.distance.import(data.distanceCalib);

    this.qlearn = new QLearningLite();
    if(this.aiState && this.aiState.qlearn) this.qlearn.import(this.aiState.qlearn);

    this.behavior = new BehavioralFingerprint();
    this.rssiRing = new RingBuffer(MAX_RSSI_SAMPLES);

    // runtime state
    this.lastSeenMs=0;
    this.lastRawRssi=null;
    this.smoothedRssi=-100;
    this.lastProcessMs=0;

    this.zone={stable:'SAFE', candidate:'SAFE', candidateCount:0, candidateSinceMs:0, lastAlertMs:0};
    this.trendArrow='â†’';
    this.confidence=0;
    this.whyText='';
    this.alertHistory = Array.isArray(data.alertHistory) ? data.alertHistory : [];
    this.ambiguousCount = data.ambiguousCount || 0;
    this.lastAmbiguousMs = data.lastAmbiguousMs || 0;
    this.distMeters=0;
    this.lostFlips=0;
    this.batterySuspect=false;

    // AI coach state
    this.lastAiSuggestion=null;
  }

  getMinInterval(){
    const z=this.zone.stable;
    const base=perfProfile.petInterval;
    if(z==='SAFE') return base*2;
    if(z==='CAUTION') return base*1.4;
    if(z==='WARNING') return base*0.7;
    return base*0.5;
  }

  ingestRaw(rssi, now){
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    if(this.aiToggles.behavior) this.behavior.addReading(rssi);
  }

  _effectiveThresholds(){
    const t=this.thresholds;
    const ha = Settings.prefs.highAlert ? HIGH_ALERT_SHRINK : 0;
    const te = {
      cautionEnter: clamp(t.cautionEnter + ha, -90, -40),
      cautionExit:  clamp(t.cautionExit  + ha, -85, -35),
      warningEnter: clamp(t.warningEnter + ha, -98, -55),
      warningExit:  clamp(t.warningExit  + ha, -92, -49),
      dangerEnter: clamp(t.dangerEnter + ha, -100, -70),
      dangerExit:  clamp(t.dangerExit  + ha, -94, -64)
    };
    // ensure hysteresis remains valid
    if(te.cautionExit <= te.cautionEnter) te.cautionExit = te.cautionEnter + 5;
    if(te.warningExit <= te.warningEnter) te.warningExit = te.warningEnter + 6;
    if(te.dangerExit <= te.dangerEnter) te.dangerExit = te.dangerEnter + 6;
    return te;
  }

  processRssi(rssi, now){
    const dtProcess = this.lastProcessMs ? (now - this.lastProcessMs) : 9999;
    this.lastSeenMs = now;
    this.lastRawRssi = rssi;
    this.lastProcessMs = now;

    this.smoothedRssi = this.kalman.update(rssi);
    this.rssiRing.push(this.smoothedRssi);

    if(this.aiToggles.behavior) this.behavior.addReading(rssi);

    this.distMeters = this.distance.estimate(this.smoothedRssi);

    // Confidence estimation
    const freshness=clamp(1-(dtProcess)/10000,0,1);
    const sampleCount=clamp(this.rssiRing.length/20,0,1);
    const f=this.behavior.getFeatures();
    const stability=f?clamp(1-f.variance/120,0,1):0.5;
    this.confidence=Math.round((freshness*0.25 + sampleCount*0.35 + stability*0.40)*100);

    // Zone w/ hysteresis
    const sr=this.smoothedRssi;
    const prev=this.zone.stable;
    const t=this._effectiveThresholds();
    let instant;

    if(prev==='SAFE'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }else if(prev==='CAUTION'){
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr>t.cautionExit?'SAFE' : 'CAUTION';
    }else if(prev==='WARNING'){
      instant = sr<=t.dangerEnter?'DANGER' : sr>t.warningExit?'CAUTION' : 'WARNING';
    }else if(prev==='DANGER'){
      instant = sr>t.dangerExit?'WARNING' : 'DANGER';
    }else{
      instant = sr<=t.dangerEnter?'DANGER' : sr<=t.warningEnter?'WARNING' : sr<=t.cautionEnter?'CAUTION' : 'SAFE';
    }

    // Stabilize transitions
    if(instant===this.zone.candidate){
      this.zone.candidateCount++;
    }else{
      this.zone.candidate = instant;
      this.zone.candidateCount = 1;
      this.zone.candidateSinceMs = now;
    }

    const confirmReq = Settings.prefs.highAlert ? Math.max(2, ZONE_CONFIRM_COUNT-1) : ZONE_CONFIRM_COUNT;
    const stable = this.zone.candidateCount>=confirmReq || ((now-this.zone.candidateSinceMs)>=ZONE_CONFIRM_MS && this.zone.candidateCount>=2);

    if(stable && this.zone.candidate!==this.zone.stable){
      const prevS=this.zone.stable;
      this.zone.stable=this.zone.candidate;

      if(ZONE_ORDER[this.zone.stable] > ZONE_ORDER[prevS]){
        // Escalation (worse zone)
        const vel=this.kalman.getVelocity();
        const beh=this.behavior.classify();
        if(beh==='rapid_departure') this.whyText='Signal weakening fast';
        else if(vel<-2) this.whyText='Signal declining steadily';
        else this.whyText='Boundary threshold crossed';

        if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
          this.zone.lastAlertMs = now;
          App.triggerAlert(this);
          this._addAlert(now);
        }
      }else{
        this.whyText='Signal improving';
      }
    }

    // Trend arrow
    if(this.rssiRing.length>=8){
      const recent=median(this.rssiRing.slice(-4));
      const older=median(this.rssiRing.slice(-8,-4));
      const diff=recent-older;
      this.trendArrow = diff>3?'â†‘':diff<-3?'â†“':'â†’';
    }

    // Battery suspicion heuristic
    if(this.zone.stable==='LOST') this.lostFlips++;
    if(this.lostFlips>=3) this.batterySuspect=true;
  }

  markLost(now){
    if(this.zone.stable!=='LOST'){
      this.zone.stable='LOST';
      this.zone.candidate='LOST';
      this.zone.candidateCount=99;
      this.trendArrow='âœ•';
      this.whyText='No signal for '+Math.round((now-this.lastSeenMs)/1000)+'s';
      this.confidence=0;

      this.lostFlips++;
      if(this.lostFlips>=3) this.batterySuspect=true;

      if(now-this.zone.lastAlertMs > ALERT_COOLDOWN_MS){
        this.zone.lastAlertMs = now;
        App.triggerAlert(this);
        this._addAlert(now);
      }
    }
  }

  _addAlert(now){
    this.alertHistory.unshift({
      time: now,
      zone: this.zone.stable,
      rssi: Math.round(this.smoothedRssi),
      dist: this.distMeters.toFixed(1),
      why: this.whyText
    });
    if(this.alertHistory.length>40) this.alertHistory.pop();
  }

  getLastSeenText(now){
    if(!this.lastSeenMs) return 'Never';
    const s=Math.round((now-this.lastSeenMs)/1000);
    if(s<2) return 'Just now';
    if(s<60) return s+'s ago';
    if(s<3600) return Math.floor(s/60)+'m ago';
    return 'Long ago';
  }

  signatureStrength(){
    // Quick heuristic
    const sig=this.signature||{};
    let s=0;
    if(sig.confirmed) s+=2;
    if(sig.nameExact) s+=2;
    if(sig.namePrefix) s+=1;
    if(sig.manufacturerId!==undefined) s+=1;
    if(sig.manufacturerDataPrefixHex) s+=1;
    if(sig.serviceUuids && sig.serviceUuids.length) s+=1;
    if(sig.deviceId) s+=1;
    return s; // 0..8
  }

  toJSON(){
    return {
      id:this.id,
      name:this.name,
      icon:this.icon,
      signature:this.signature,
      createdAt:this.createdAt,
      rescueId:this.rescueId,
      thresholds:this.thresholds,
      leashPreset:this.leashPreset,
      aiToggles:this.aiToggles,
      aiState:{ qlearn: this.qlearn.export() },
      distanceCalib:this.distance.export(),
      alertHistory:this.alertHistory.slice(0,40),
      ambiguousCount:this.ambiguousCount,
      lastAmbiguousMs:this.lastAmbiguousMs
    };
  }
}


/* ----------------------------- QR GENERATOR (V4.1: Standard QR) ----------------------------- */
/*
  âœ… Standard QR (scannable)
  Offline embedded library: Project Nayuki QR Code generator (MIT License).
  (The library code is included below for offline-first operation.)
*/
/*
 * QR Code generator library (TypeScript)
 *
 * Copyright (c) Project Nayuki. (MIT License)
 * https://www.nayuki.io/page/qr-code-generator-library
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 * - The above copyright notice and this permission notice shall be included in
 *   all copies or substantial portions of the Software.
 * - The Software is provided "as is", without warranty of any kind, express or
 *   implied, including but not limited to the warranties of merchantability,
 *   fitness for a particular purpose and noninfringement. In no event shall the
 *   authors or copyright holders be liable for any claim, damages or other
 *   liability, whether in an action of contract, tort or otherwise, arising from,
 *   out of or in connection with the Software or the use or other dealings in the
 *   Software.
 */
"use strict";
var qrcodegen;
(function (qrcodegen) {
    /*---- QR Code symbol class ----*/
    /*
     * A QR Code symbol, which is a type of two-dimension barcode.
     * Invented by Denso Wave and described in the ISO/IEC 18004 standard.
     * Instances of this class represent an immutable square grid of dark and light cells.
     * The class provides static factory functions to create a QR Code from text or binary data.
     * The class covers the QR Code Model 2 specification, supporting all versions (sizes)
     * from 1 to 40, all 4 error correction levels, and 4 character encoding modes.
     *
     * Ways to create a QR Code object:
     * - High level: Take the payload data and call QrCode.encodeText() or QrCode.encodeBinary().
     * - Mid level: Custom-make the list of segments and call QrCode.encodeSegments().
     * - Low level: Custom-make the array of data codeword bytes (including
     *   segment headers and final padding, excluding error correction codewords),
     *   supply the appropriate version number, and call the QrCode() constructor.
     * (Note that all ways require supplying the desired error correction level.)
     */
    var QrCode = /** @class */ (function () {
        /*-- Constructor (low level) and fields --*/
        // Creates a new QR Code with the given version number,
        // error correction level, data codeword bytes, and mask number.
        // This is a low-level API that most users should not use directly.
        // A mid-level API is the encodeSegments() function.
        function QrCode(
        // The version number of this QR Code, which is between 1 and 40 (inclusive).
        // This determines the size of this barcode.
        version, 
        // The error correction level used in this QR Code.
        errorCorrectionLevel, dataCodewords, msk) {
            this.version = version;
            this.errorCorrectionLevel = errorCorrectionLevel;
            // The modules of this QR Code (false = light, true = dark).
            // Immutable after constructor finishes. Accessed through getModule().
            this.modules = [];
            // Indicates function modules that are not subjected to masking. Discarded when constructor finishes.
            this.isFunction = [];
            // Check scalar arguments
            if (version < QrCode.MIN_VERSION || version > QrCode.MAX_VERSION)
                throw new RangeError("Version value out of range");
            if (msk < -1 || msk > 7)
                throw new RangeError("Mask value out of range");
            this.size = version * 4 + 17;
            // Initialize both grids to be size*size arrays of Boolean false
            var row = [];
            for (var i = 0; i < this.size; i++)
                row.push(false);
            for (var i = 0; i < this.size; i++) {
                this.modules.push(row.slice()); // Initially all light
                this.isFunction.push(row.slice());
            }
            // Compute ECC, draw modules
            this.drawFunctionPatterns();
            var allCodewords = this.addEccAndInterleave(dataCodewords);
            this.drawCodewords(allCodewords);
            // Do masking
            if (msk == -1) { // Automatically choose best mask
                var minPenalty = 1000000000;
                for (var i = 0; i < 8; i++) {
                    this.applyMask(i);
                    this.drawFormatBits(i);
                    var penalty = this.getPenaltyScore();
                    if (penalty < minPenalty) {
                        msk = i;
                        minPenalty = penalty;
                    }
                    this.applyMask(i); // Undoes the mask due to XOR
                }
            }
            assert(0 <= msk && msk <= 7);
            this.mask = msk;
            this.applyMask(msk); // Apply the final choice of mask
            this.drawFormatBits(msk); // Overwrite old format bits
            this.isFunction = [];
        }
        /*-- Static factory functions (high level) --*/
        // Returns a QR Code representing the given Unicode text string at the given error correction level.
        // As a conservative upper bound, this function is guaranteed to succeed for strings that have 738 or fewer
        // Unicode code points (not UTF-16 code units) if the low error correction level is used. The smallest possible
        // QR Code version is automatically chosen for the output. The ECC level of the result may be higher than the
        // ecl argument if it can be done without increasing the version.
        QrCode.encodeText = function (text, ecl) {
            var segs = qrcodegen.QrSegment.makeSegments(text);
            return QrCode.encodeSegments(segs, ecl);
        };
        // Returns a QR Code representing the given binary data at the given error correction level.
        // This function always encodes using the binary segment mode, not any text mode. The maximum number of
        // bytes allowed is 2953. The smallest possible QR Code version is automatically chosen for the output.
        // The ECC level of the result may be higher than the ecl argument if it can be done without increasing the version.
        QrCode.encodeBinary = function (data, ecl) {
            var seg = qrcodegen.QrSegment.makeBytes(data);
            return QrCode.encodeSegments([seg], ecl);
        };
        /*-- Static factory functions (mid level) --*/
        // Returns a QR Code representing the given segments with the given encoding parameters.
        // The smallest possible QR Code version within the given range is automatically
        // chosen for the output. Iff boostEcl is true, then the ECC level of the result
        // may be higher than the ecl argument if it can be done without increasing the
        // version. The mask number is either between 0 to 7 (inclusive) to force that
        // mask, or -1 to automatically choose an appropriate mask (which may be slow).
        // This function allows the user to create a custom sequence of segments that switches
        // between modes (such as alphanumeric and byte) to encode text in less space.
        // This is a mid-level API; the high-level API is encodeText() and encodeBinary().
        QrCode.encodeSegments = function (segs, ecl, minVersion, maxVersion, mask, boostEcl) {
            if (minVersion === void 0) { minVersion = 1; }
            if (maxVersion === void 0) { maxVersion = 40; }
            if (mask === void 0) { mask = -1; }
            if (boostEcl === void 0) { boostEcl = true; }
            if (!(QrCode.MIN_VERSION <= minVersion && minVersion <= maxVersion && maxVersion <= QrCode.MAX_VERSION)
                || mask < -1 || mask > 7)
                throw new RangeError("Invalid value");
            // Find the minimal version number to use
            var version;
            var dataUsedBits;
            for (version = minVersion;; version++) {
                var dataCapacityBits_1 = QrCode.getNumDataCodewords(version, ecl) * 8; // Number of data bits available
                var usedBits = QrSegment.getTotalBits(segs, version);
                if (usedBits <= dataCapacityBits_1) {
                    dataUsedBits = usedBits;
                    break; // This version number is found to be suitable
                }
                if (version >= maxVersion) // All versions in the range could not fit the given data
                    throw new RangeError("Data too long");
            }
            // Increase the error correction level while the data still fits in the current version number
            for (var _i = 0, _a = [QrCode.Ecc.MEDIUM, QrCode.Ecc.QUARTILE, QrCode.Ecc.HIGH]; _i < _a.length; _i++) { // From low to high
                var newEcl = _a[_i];
                if (boostEcl && dataUsedBits <= QrCode.getNumDataCodewords(version, newEcl) * 8)
                    ecl = newEcl;
            }
            // Concatenate all segments to create the data bit string
            var bb = [];
            for (var _b = 0, segs_1 = segs; _b < segs_1.length; _b++) {
                var seg = segs_1[_b];
                appendBits(seg.mode.modeBits, 4, bb);
                appendBits(seg.numChars, seg.mode.numCharCountBits(version), bb);
                for (var _c = 0, _d = seg.getData(); _c < _d.length; _c++) {
                    var b = _d[_c];
                    bb.push(b);
                }
            }
            assert(bb.length == dataUsedBits);
            // Add terminator and pad up to a byte if applicable
            var dataCapacityBits = QrCode.getNumDataCodewords(version, ecl) * 8;
            assert(bb.length <= dataCapacityBits);
            appendBits(0, Math.min(4, dataCapacityBits - bb.length), bb);
            appendBits(0, (8 - bb.length % 8) % 8, bb);
            assert(bb.length % 8 == 0);
            // Pad with alternating bytes until data capacity is reached
            for (var padByte = 0xEC; bb.length < dataCapacityBits; padByte ^= 0xEC ^ 0x11)
                appendBits(padByte, 8, bb);
            // Pack bits into bytes in big endian
            var dataCodewords = [];
            while (dataCodewords.length * 8 < bb.length)
                dataCodewords.push(0);
            bb.forEach(function (b, i) {
                return dataCodewords[i >>> 3] |= b << (7 - (i & 7));
            });
            // Create the QR Code object
            return new QrCode(version, ecl, dataCodewords, mask);
        };
        /*-- Accessor methods --*/
        // Returns the color of the module (pixel) at the given coordinates, which is false
        // for light or true for dark. The top left corner has the coordinates (x=0, y=0).
        // If the given coordinates are out of bounds, then false (light) is returned.
        QrCode.prototype.getModule = function (x, y) {
            return 0 <= x && x < this.size && 0 <= y && y < this.size && this.modules[y][x];
        };
        /*-- Private helper methods for constructor: Drawing function modules --*/
        // Reads this object's version field, and draws and marks all function modules.
        QrCode.prototype.drawFunctionPatterns = function () {
            // Draw horizontal and vertical timing patterns
            for (var i = 0; i < this.size; i++) {
                this.setFunctionModule(6, i, i % 2 == 0);
                this.setFunctionModule(i, 6, i % 2 == 0);
            }
            // Draw 3 finder patterns (all corners except bottom right; overwrites some timing modules)
            this.drawFinderPattern(3, 3);
            this.drawFinderPattern(this.size - 4, 3);
            this.drawFinderPattern(3, this.size - 4);
            // Draw numerous alignment patterns
            var alignPatPos = this.getAlignmentPatternPositions();
            var numAlign = alignPatPos.length;
            for (var i = 0; i < numAlign; i++) {
                for (var j = 0; j < numAlign; j++) {
                    // Don't draw on the three finder corners
                    if (!(i == 0 && j == 0 || i == 0 && j == numAlign - 1 || i == numAlign - 1 && j == 0))
                        this.drawAlignmentPattern(alignPatPos[i], alignPatPos[j]);
                }
            }
            // Draw configuration data
            this.drawFormatBits(0); // Dummy mask value; overwritten later in the constructor
            this.drawVersion();
        };
        // Draws two copies of the format bits (with its own error correction code)
        // based on the given mask and this object's error correction level field.
        QrCode.prototype.drawFormatBits = function (mask) {
            // Calculate error correction code and pack bits
            var data = this.errorCorrectionLevel.formatBits << 3 | mask; // errCorrLvl is uint2, mask is uint3
            var rem = data;
            for (var i = 0; i < 10; i++)
                rem = (rem << 1) ^ ((rem >>> 9) * 0x537);
            var bits = (data << 10 | rem) ^ 0x5412; // uint15
            assert(bits >>> 15 == 0);
            // Draw first copy
            for (var i = 0; i <= 5; i++)
                this.setFunctionModule(8, i, getBit(bits, i));
            this.setFunctionModule(8, 7, getBit(bits, 6));
            this.setFunctionModule(8, 8, getBit(bits, 7));
            this.setFunctionModule(7, 8, getBit(bits, 8));
            for (var i = 9; i < 15; i++)
                this.setFunctionModule(14 - i, 8, getBit(bits, i));
            // Draw second copy
            for (var i = 0; i < 8; i++)
                this.setFunctionModule(this.size - 1 - i, 8, getBit(bits, i));
            for (var i = 8; i < 15; i++)
                this.setFunctionModule(8, this.size - 15 + i, getBit(bits, i));
            this.setFunctionModule(8, this.size - 8, true); // Always dark
        };
        // Draws two copies of the version bits (with its own error correction code),
        // based on this object's version field, iff 7 <= version <= 40.
        QrCode.prototype.drawVersion = function () {
            if (this.version < 7)
                return;
            // Calculate error correction code and pack bits
            var rem = this.version; // version is uint6, in the range [7, 40]
            for (var i = 0; i < 12; i++)
                rem = (rem << 1) ^ ((rem >>> 11) * 0x1F25);
            var bits = this.version << 12 | rem; // uint18
            assert(bits >>> 18 == 0);
            // Draw two copies
            for (var i = 0; i < 18; i++) {
                var color = getBit(bits, i);
                var a = this.size - 11 + i % 3;
                var b = Math.floor(i / 3);
                this.setFunctionModule(a, b, color);
                this.setFunctionModule(b, a, color);
            }
        };
        // Draws a 9*9 finder pattern including the border separator,
        // with the center module at (x, y). Modules can be out of bounds.
        QrCode.prototype.drawFinderPattern = function (x, y) {
            for (var dy = -4; dy <= 4; dy++) {
                for (var dx = -4; dx <= 4; dx++) {
                    var dist = Math.max(Math.abs(dx), Math.abs(dy)); // Chebyshev/infinity norm
                    var xx = x + dx;
                    var yy = y + dy;
                    if (0 <= xx && xx < this.size && 0 <= yy && yy < this.size)
                        this.setFunctionModule(xx, yy, dist != 2 && dist != 4);
                }
            }
        };
        // Draws a 5*5 alignment pattern, with the center module
        // at (x, y). All modules must be in bounds.
        QrCode.prototype.drawAlignmentPattern = function (x, y) {
            for (var dy = -2; dy <= 2; dy++) {
                for (var dx = -2; dx <= 2; dx++)
                    this.setFunctionModule(x + dx, y + dy, Math.max(Math.abs(dx), Math.abs(dy)) != 1);
            }
        };
        // Sets the color of a module and marks it as a function module.
        // Only used by the constructor. Coordinates must be in bounds.
        QrCode.prototype.setFunctionModule = function (x, y, isDark) {
            this.modules[y][x] = isDark;
            this.isFunction[y][x] = true;
        };
        /*-- Private helper methods for constructor: Codewords and masking --*/
        // Returns a new byte string representing the given data with the appropriate error correction
        // codewords appended to it, based on this object's version and error correction level.
        QrCode.prototype.addEccAndInterleave = function (data) {
            var ver = this.version;
            var ecl = this.errorCorrectionLevel;
            if (data.length != QrCode.getNumDataCodewords(ver, ecl))
                throw new RangeError("Invalid argument");
            // Calculate parameter numbers
            var numBlocks = QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
            var blockEccLen = QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver];
            var rawCodewords = Math.floor(QrCode.getNumRawDataModules(ver) / 8);
            var numShortBlocks = numBlocks - rawCodewords % numBlocks;
            var shortBlockLen = Math.floor(rawCodewords / numBlocks);
            // Split data into blocks and append ECC to each block
            var blocks = [];
            var rsDiv = QrCode.reedSolomonComputeDivisor(blockEccLen);
            for (var i = 0, k = 0; i < numBlocks; i++) {
                var dat = data.slice(k, k + shortBlockLen - blockEccLen + (i < numShortBlocks ? 0 : 1));
                k += dat.length;
                var ecc = QrCode.reedSolomonComputeRemainder(dat, rsDiv);
                if (i < numShortBlocks)
                    dat.push(0);
                blocks.push(dat.concat(ecc));
            }
            // Interleave (not concatenate) the bytes from every block into a single sequence
            var result = [];
            var _loop_1 = function (i) {
                blocks.forEach(function (block, j) {
                    // Skip the padding byte in short blocks
                    if (i != shortBlockLen - blockEccLen || j >= numShortBlocks)
                        result.push(block[i]);
                });
            };
            for (var i = 0; i < blocks[0].length; i++) {
                _loop_1(i);
            }
            assert(result.length == rawCodewords);
            return result;
        };
        // Draws the given sequence of 8-bit codewords (data and error correction) onto the entire
        // data area of this QR Code. Function modules need to be marked off before this is called.
        QrCode.prototype.drawCodewords = function (data) {
            if (data.length != Math.floor(QrCode.getNumRawDataModules(this.version) / 8))
                throw new RangeError("Invalid argument");
            var i = 0; // Bit index into the data
            // Do the funny zigzag scan
            for (var right = this.size - 1; right >= 1; right -= 2) { // Index of right column in each column pair
                if (right == 6)
                    right = 5;
                for (var vert = 0; vert < this.size; vert++) { // Vertical counter
                    for (var j = 0; j < 2; j++) {
                        var x = right - j; // Actual x coordinate
                        var upward = ((right + 1) & 2) == 0;
                        var y = upward ? this.size - 1 - vert : vert; // Actual y coordinate
                        if (!this.isFunction[y][x] && i < data.length * 8) {
                            this.modules[y][x] = getBit(data[i >>> 3], 7 - (i & 7));
                            i++;
                        }
                        // If this QR Code has any remainder bits (0 to 7), they were assigned as
                        // 0/false/light by the constructor and are left unchanged by this method
                    }
                }
            }
            assert(i == data.length * 8);
        };
        // XORs the codeword modules in this QR Code with the given mask pattern.
        // The function modules must be marked and the codeword bits must be drawn
        // before masking. Due to the arithmetic of XOR, calling applyMask() with
        // the same mask value a second time will undo the mask. A final well-formed
        // QR Code needs exactly one (not zero, two, etc.) mask applied.
        QrCode.prototype.applyMask = function (mask) {
            if (mask < 0 || mask > 7)
                throw new RangeError("Mask value out of range");
            for (var y = 0; y < this.size; y++) {
                for (var x = 0; x < this.size; x++) {
                    var invert = void 0;
                    switch (mask) {
                        case 0:
                            invert = (x + y) % 2 == 0;
                            break;
                        case 1:
                            invert = y % 2 == 0;
                            break;
                        case 2:
                            invert = x % 3 == 0;
                            break;
                        case 3:
                            invert = (x + y) % 3 == 0;
                            break;
                        case 4:
                            invert = (Math.floor(x / 3) + Math.floor(y / 2)) % 2 == 0;
                            break;
                        case 5:
                            invert = x * y % 2 + x * y % 3 == 0;
                            break;
                        case 6:
                            invert = (x * y % 2 + x * y % 3) % 2 == 0;
                            break;
                        case 7:
                            invert = ((x + y) % 2 + x * y % 3) % 2 == 0;
                            break;
                        default: throw new Error("Unreachable");
                    }
                    if (!this.isFunction[y][x] && invert)
                        this.modules[y][x] = !this.modules[y][x];
                }
            }
        };
        // Calculates and returns the penalty score based on state of this QR Code's current modules.
        // This is used by the automatic mask choice algorithm to find the mask pattern that yields the lowest score.
        QrCode.prototype.getPenaltyScore = function () {
            var result = 0;
            // Adjacent modules in row having same color, and finder-like patterns
            for (var y = 0; y < this.size; y++) {
                var runColor = false;
                var runX = 0;
                var runHistory = [0, 0, 0, 0, 0, 0, 0];
                for (var x = 0; x < this.size; x++) {
                    if (this.modules[y][x] == runColor) {
                        runX++;
                        if (runX == 5)
                            result += QrCode.PENALTY_N1;
                        else if (runX > 5)
                            result++;
                    }
                    else {
                        this.finderPenaltyAddHistory(runX, runHistory);
                        if (!runColor)
                            result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                        runColor = this.modules[y][x];
                        runX = 1;
                    }
                }
                result += this.finderPenaltyTerminateAndCount(runColor, runX, runHistory) * QrCode.PENALTY_N3;
            }
            // Adjacent modules in column having same color, and finder-like patterns
            for (var x = 0; x < this.size; x++) {
                var runColor = false;
                var runY = 0;
                var runHistory = [0, 0, 0, 0, 0, 0, 0];
                for (var y = 0; y < this.size; y++) {
                    if (this.modules[y][x] == runColor) {
                        runY++;
                        if (runY == 5)
                            result += QrCode.PENALTY_N1;
                        else if (runY > 5)
                            result++;
                    }
                    else {
                        this.finderPenaltyAddHistory(runY, runHistory);
                        if (!runColor)
                            result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                        runColor = this.modules[y][x];
                        runY = 1;
                    }
                }
                result += this.finderPenaltyTerminateAndCount(runColor, runY, runHistory) * QrCode.PENALTY_N3;
            }
            // 2*2 blocks of modules having same color
            for (var y = 0; y < this.size - 1; y++) {
                for (var x = 0; x < this.size - 1; x++) {
                    var color = this.modules[y][x];
                    if (color == this.modules[y][x + 1] &&
                        color == this.modules[y + 1][x] &&
                        color == this.modules[y + 1][x + 1])
                        result += QrCode.PENALTY_N2;
                }
            }
            // Balance of dark and light modules
            var dark = 0;
            for (var _i = 0, _a = this.modules; _i < _a.length; _i++) {
                var row = _a[_i];
                dark = row.reduce(function (sum, color) { return sum + (color ? 1 : 0); }, dark);
            }
            var total = this.size * this.size; // Note that size is odd, so dark/total != 1/2
            // Compute the smallest integer k >= 0 such that (45-5k)% <= dark/total <= (55+5k)%
            var k = Math.ceil(Math.abs(dark * 20 - total * 10) / total) - 1;
            assert(0 <= k && k <= 9);
            result += k * QrCode.PENALTY_N4;
            assert(0 <= result && result <= 2568888); // Non-tight upper bound based on default values of PENALTY_N1, ..., N4
            return result;
        };
        /*-- Private helper functions --*/
        // Returns an ascending list of positions of alignment patterns for this version number.
        // Each position is in the range [0,177), and are used on both the x and y axes.
        // This could be implemented as lookup table of 40 variable-length lists of integers.
        QrCode.prototype.getAlignmentPatternPositions = function () {
            if (this.version == 1)
                return [];
            else {
                var numAlign = Math.floor(this.version / 7) + 2;
                var step = Math.floor((this.version * 8 + numAlign * 3 + 5) / (numAlign * 4 - 4)) * 2;
                var result = [6];
                for (var pos = this.size - 7; result.length < numAlign; pos -= step)
                    result.splice(1, 0, pos);
                return result;
            }
        };
        // Returns the number of data bits that can be stored in a QR Code of the given version number, after
        // all function modules are excluded. This includes remainder bits, so it might not be a multiple of 8.
        // The result is in the range [208, 29648]. This could be implemented as a 40-entry lookup table.
        QrCode.getNumRawDataModules = function (ver) {
            if (ver < QrCode.MIN_VERSION || ver > QrCode.MAX_VERSION)
                throw new RangeError("Version number out of range");
            var result = (16 * ver + 128) * ver + 64;
            if (ver >= 2) {
                var numAlign = Math.floor(ver / 7) + 2;
                result -= (25 * numAlign - 10) * numAlign - 55;
                if (ver >= 7)
                    result -= 36;
            }
            assert(208 <= result && result <= 29648);
            return result;
        };
        // Returns the number of 8-bit data (i.e. not error correction) codewords contained in any
        // QR Code of the given version number and error correction level, with remainder bits discarded.
        // This stateless pure function could be implemented as a (40*4)-cell lookup table.
        QrCode.getNumDataCodewords = function (ver, ecl) {
            return Math.floor(QrCode.getNumRawDataModules(ver) / 8) -
                QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver] *
                    QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
        };
        // Returns a Reed-Solomon ECC generator polynomial for the given degree. This could be
        // implemented as a lookup table over all possible parameter values, instead of as an algorithm.
        QrCode.reedSolomonComputeDivisor = function (degree) {
            if (degree < 1 || degree > 255)
                throw new RangeError("Degree out of range");
            // Polynomial coefficients are stored from highest to lowest power, excluding the leading term which is always 1.
            // For example the polynomial x^3 + 255x^2 + 8x + 93 is stored as the uint8 array [255, 8, 93].
            var result = [];
            for (var i = 0; i < degree - 1; i++)
                result.push(0);
            result.push(1); // Start off with the monomial x^0
            // Compute the product polynomial (x - r^0) * (x - r^1) * (x - r^2) * ... * (x - r^{degree-1}),
            // and drop the highest monomial term which is always 1x^degree.
            // Note that r = 0x02, which is a generator element of this field GF(2^8/0x11D).
            var root = 1;
            for (var i = 0; i < degree; i++) {
                // Multiply the current product by (x - r^i)
                for (var j = 0; j < result.length; j++) {
                    result[j] = QrCode.reedSolomonMultiply(result[j], root);
                    if (j + 1 < result.length)
                        result[j] ^= result[j + 1];
                }
                root = QrCode.reedSolomonMultiply(root, 0x02);
            }
            return result;
        };
        // Returns the Reed-Solomon error correction codeword for the given data and divisor polynomials.
        QrCode.reedSolomonComputeRemainder = function (data, divisor) {
            var result = divisor.map(function (_) { return 0; });
            var _loop_2 = function (b) {
                var factor = b ^ result.shift();
                result.push(0);
                divisor.forEach(function (coef, i) {
                    return result[i] ^= QrCode.reedSolomonMultiply(coef, factor);
                });
            };
            for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {
                var b = data_1[_i];
                _loop_2(b);
            }
            return result;
        };
        // Returns the product of the two given field elements modulo GF(2^8/0x11D). The arguments and result
        // are unsigned 8-bit integers. This could be implemented as a lookup table of 256*256 entries of uint8.
        QrCode.reedSolomonMultiply = function (x, y) {
            if (x >>> 8 != 0 || y >>> 8 != 0)
                throw new RangeError("Byte out of range");
            // Russian peasant multiplication
            var z = 0;
            for (var i = 7; i >= 0; i--) {
                z = (z << 1) ^ ((z >>> 7) * 0x11D);
                z ^= ((y >>> i) & 1) * x;
            }
            assert(z >>> 8 == 0);
            return z;
        };
        // Can only be called immediately after a light run is added, and
        // returns either 0, 1, or 2. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyCountPatterns = function (runHistory) {
            var n = runHistory[1];
            assert(n <= this.size * 3);
            var core = n > 0 && runHistory[2] == n && runHistory[3] == n * 3 && runHistory[4] == n && runHistory[5] == n;
            return (core && runHistory[0] >= n * 4 && runHistory[6] >= n ? 1 : 0)
                + (core && runHistory[6] >= n * 4 && runHistory[0] >= n ? 1 : 0);
        };
        // Must be called at the end of a line (row or column) of modules. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyTerminateAndCount = function (currentRunColor, currentRunLength, runHistory) {
            if (currentRunColor) { // Terminate dark run
                this.finderPenaltyAddHistory(currentRunLength, runHistory);
                currentRunLength = 0;
            }
            currentRunLength += this.size; // Add light border to final run
            this.finderPenaltyAddHistory(currentRunLength, runHistory);
            return this.finderPenaltyCountPatterns(runHistory);
        };
        // Pushes the given value to the front and drops the last value. A helper function for getPenaltyScore().
        QrCode.prototype.finderPenaltyAddHistory = function (currentRunLength, runHistory) {
            if (runHistory[0] == 0)
                currentRunLength += this.size; // Add light border to initial run
            runHistory.pop();
            runHistory.unshift(currentRunLength);
        };
        /*-- Constants and tables --*/
        // The minimum version number supported in the QR Code Model 2 standard.
        QrCode.MIN_VERSION = 1;
        // The maximum version number supported in the QR Code Model 2 standard.
        QrCode.MAX_VERSION = 40;
        // For use in getPenaltyScore(), when evaluating which mask is best.
        QrCode.PENALTY_N1 = 3;
        QrCode.PENALTY_N2 = 3;
        QrCode.PENALTY_N3 = 40;
        QrCode.PENALTY_N4 = 10;
        QrCode.ECC_CODEWORDS_PER_BLOCK = [
            // Version: (note that index 0 is for padding, and is set to an illegal value)
            //0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40    Error correction level
            [-1, 7, 10, 15, 20, 26, 18, 20, 24, 30, 18, 20, 24, 26, 30, 22, 24, 28, 30, 28, 28, 28, 28, 30, 30, 26, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // Low
            [-1, 10, 16, 26, 18, 24, 16, 18, 22, 22, 26, 30, 22, 22, 24, 24, 28, 28, 26, 26, 26, 26, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28], // Medium
            [-1, 13, 22, 18, 26, 18, 24, 18, 22, 20, 24, 28, 26, 24, 20, 30, 24, 28, 28, 26, 30, 28, 30, 30, 30, 30, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // Quartile
            [-1, 17, 28, 22, 16, 22, 28, 26, 26, 24, 28, 24, 28, 22, 24, 24, 30, 28, 28, 26, 28, 30, 24, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30], // High
        ];
        QrCode.NUM_ERROR_CORRECTION_BLOCKS = [
            // Version: (note that index 0 is for padding, and is set to an illegal value)
            //0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40    Error correction level
            [-1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 4, 4, 4, 4, 4, 6, 6, 6, 6, 7, 8, 8, 9, 9, 10, 12, 12, 12, 13, 14, 15, 16, 17, 18, 19, 19, 20, 21, 22, 24, 25], // Low
            [-1, 1, 1, 1, 2, 2, 4, 4, 4, 5, 5, 5, 8, 9, 9, 10, 10, 11, 13, 14, 16, 17, 17, 18, 20, 21, 23, 25, 26, 28, 29, 31, 33, 35, 37, 38, 40, 43, 45, 47, 49], // Medium
            [-1, 1, 1, 2, 2, 4, 4, 6, 6, 8, 8, 8, 10, 12, 16, 12, 17, 16, 18, 21, 20, 23, 23, 25, 27, 29, 34, 34, 35, 38, 40, 43, 45, 48, 51, 53, 56, 59, 62, 65, 68], // Quartile
            [-1, 1, 1, 2, 4, 4, 4, 5, 6, 8, 8, 11, 11, 16, 16, 18, 16, 19, 21, 25, 25, 25, 34, 30, 32, 35, 37, 40, 42, 45, 48, 51, 54, 57, 60, 63, 66, 70, 74, 77, 81], // High
        ];
        return QrCode;
    }());
    qrcodegen.QrCode = QrCode;
    // Appends the given number of low-order bits of the given value
    // to the given buffer. Requires 0 <= len <= 31 and 0 <= val < 2^len.
    function appendBits(val, len, bb) {
        if (len < 0 || len > 31 || val >>> len != 0)
            throw new RangeError("Value out of range");
        for (var i = len - 1; i >= 0; i--) // Append bit by bit
            bb.push((val >>> i) & 1);
    }
    // Returns true iff the i'th bit of x is set to 1.
    function getBit(x, i) {
        return ((x >>> i) & 1) != 0;
    }
    // Throws an exception if the given condition is false.
    function assert(cond) {
        if (!cond)
            throw new Error("Assertion error");
    }
    /*---- Data segment class ----*/
    /*
     * A segment of character/binary/control data in a QR Code symbol.
     * Instances of this class are immutable.
     * The mid-level way to create a segment is to take the payload data
     * and call a static factory function such as QrSegment.makeNumeric().
     * The low-level way to create a segment is to custom-make the bit buffer
     * and call the QrSegment() constructor with appropriate values.
     * This segment class imposes no length restrictions, but QR Codes have restrictions.
     * Even in the most favorable conditions, a QR Code can only hold 7089 characters of data.
     * Any segment longer than this is meaningless for the purpose of generating QR Codes.
     */
    var QrSegment = /** @class */ (function () {
        /*-- Constructor (low level) and fields --*/
        // Creates a new QR Code segment with the given attributes and data.
        // The character count (numChars) must agree with the mode and the bit buffer length,
        // but the constraint isn't checked. The given bit buffer is cloned and stored.
        function QrSegment(
        // The mode indicator of this segment.
        mode, 
        // The length of this segment's unencoded data. Measured in characters for
        // numeric/alphanumeric/kanji mode, bytes for byte mode, and 0 for ECI mode.
        // Always zero or positive. Not the same as the data's bit length.
        numChars, 
        // The data bits of this segment. Accessed through getData().
        bitData) {
            this.mode = mode;
            this.numChars = numChars;
            this.bitData = bitData;
            if (numChars < 0)
                throw new RangeError("Invalid argument");
            this.bitData = bitData.slice(); // Make defensive copy
        }
        /*-- Static factory functions (mid level) --*/
        // Returns a segment representing the given binary data encoded in
        // byte mode. All input byte arrays are acceptable. Any text string
        // can be converted to UTF-8 bytes and encoded as a byte mode segment.
        QrSegment.makeBytes = function (data) {
            var bb = [];
            for (var _i = 0, data_2 = data; _i < data_2.length; _i++) {
                var b = data_2[_i];
                appendBits(b, 8, bb);
            }
            return new QrSegment(QrSegment.Mode.BYTE, data.length, bb);
        };
        // Returns a segment representing the given string of decimal digits encoded in numeric mode.
        QrSegment.makeNumeric = function (digits) {
            if (!QrSegment.isNumeric(digits))
                throw new RangeError("String contains non-numeric characters");
            var bb = [];
            for (var i = 0; i < digits.length;) { // Consume up to 3 digits per iteration
                var n = Math.min(digits.length - i, 3);
                appendBits(parseInt(digits.substring(i, i + n), 10), n * 3 + 1, bb);
                i += n;
            }
            return new QrSegment(QrSegment.Mode.NUMERIC, digits.length, bb);
        };
        // Returns a segment representing the given text string encoded in alphanumeric mode.
        // The characters allowed are: 0 to 9, A to Z (uppercase only), space,
        // dollar, percent, asterisk, plus, hyphen, period, slash, colon.
        QrSegment.makeAlphanumeric = function (text) {
            if (!QrSegment.isAlphanumeric(text))
                throw new RangeError("String contains unencodable characters in alphanumeric mode");
            var bb = [];
            var i;
            for (i = 0; i + 2 <= text.length; i += 2) { // Process groups of 2
                var temp = QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)) * 45;
                temp += QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i + 1));
                appendBits(temp, 11, bb);
            }
            if (i < text.length) // 1 character remaining
                appendBits(QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)), 6, bb);
            return new QrSegment(QrSegment.Mode.ALPHANUMERIC, text.length, bb);
        };
        // Returns a new mutable list of zero or more segments to represent the given Unicode text string.
        // The result may use various segment modes and switch modes to optimize the length of the bit stream.
        QrSegment.makeSegments = function (text) {
            // Select the most efficient segment encoding automatically
            if (text == "")
                return [];
            else if (QrSegment.isNumeric(text))
                return [QrSegment.makeNumeric(text)];
            else if (QrSegment.isAlphanumeric(text))
                return [QrSegment.makeAlphanumeric(text)];
            else
                return [QrSegment.makeBytes(QrSegment.toUtf8ByteArray(text))];
        };
        // Returns a segment representing an Extended Channel Interpretation
        // (ECI) designator with the given assignment value.
        QrSegment.makeEci = function (assignVal) {
            var bb = [];
            if (assignVal < 0)
                throw new RangeError("ECI assignment value out of range");
            else if (assignVal < (1 << 7))
                appendBits(assignVal, 8, bb);
            else if (assignVal < (1 << 14)) {
                appendBits(2, 2, bb);
                appendBits(assignVal, 14, bb);
            }
            else if (assignVal < 1000000) {
                appendBits(6, 3, bb);
                appendBits(assignVal, 21, bb);
            }
            else
                throw new RangeError("ECI assignment value out of range");
            return new QrSegment(QrSegment.Mode.ECI, 0, bb);
        };
        // Tests whether the given string can be encoded as a segment in numeric mode.
        // A string is encodable iff each character is in the range 0 to 9.
        QrSegment.isNumeric = function (text) {
            return QrSegment.NUMERIC_REGEX.test(text);
        };
        // Tests whether the given string can be encoded as a segment in alphanumeric mode.
        // A string is encodable iff each character is in the following set: 0 to 9, A to Z
        // (uppercase only), space, dollar, percent, asterisk, plus, hyphen, period, slash, colon.
        QrSegment.isAlphanumeric = function (text) {
            return QrSegment.ALPHANUMERIC_REGEX.test(text);
        };
        /*-- Methods --*/
        // Returns a new copy of the data bits of this segment.
        QrSegment.prototype.getData = function () {
            return this.bitData.slice(); // Make defensive copy
        };
        // (Package-private) Calculates and returns the number of bits needed to encode the given segments at
        // the given version. The result is infinity if a segment has too many characters to fit its length field.
        QrSegment.getTotalBits = function (segs, version) {
            var result = 0;
            for (var _i = 0, segs_2 = segs; _i < segs_2.length; _i++) {
                var seg = segs_2[_i];
                var ccbits = seg.mode.numCharCountBits(version);
                if (seg.numChars >= (1 << ccbits))
                    return Infinity; // The segment's length doesn't fit the field's bit width
                result += 4 + ccbits + seg.bitData.length;
            }
            return result;
        };
        // Returns a new array of bytes representing the given string encoded in UTF-8.
        QrSegment.toUtf8ByteArray = function (str) {
            str = encodeURI(str);
            var result = [];
            for (var i = 0; i < str.length; i++) {
                if (str.charAt(i) != "%")
                    result.push(str.charCodeAt(i));
                else {
                    result.push(parseInt(str.substring(i + 1, i + 3), 16));
                    i += 2;
                }
            }
            return result;
        };
        /*-- Constants --*/
        // Describes precisely all strings that are encodable in numeric mode.
        QrSegment.NUMERIC_REGEX = /^[0-9]*$/;
        // Describes precisely all strings that are encodable in alphanumeric mode.
        QrSegment.ALPHANUMERIC_REGEX = /^[A-Z0-9 $%*+.\/:-]*$/;
        // The set of all legal characters in alphanumeric mode,
        // where each character value maps to the index in the string.
        QrSegment.ALPHANUMERIC_CHARSET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:";
        return QrSegment;
    }());
    qrcodegen.QrSegment = QrSegment;
})(qrcodegen || (qrcodegen = {}));
/*---- Public helper enumeration ----*/
(function (qrcodegen) {
    var QrCode;
    (function (QrCode) {
        /*
         * The error correction level in a QR Code symbol. Immutable.
         */
        var Ecc = /** @class */ (function () {
            /*-- Constructor and fields --*/
            function Ecc(
            // In the range 0 to 3 (unsigned 2-bit integer).
            ordinal, 
            // (Package-private) In the range 0 to 3 (unsigned 2-bit integer).
            formatBits) {
                this.ordinal = ordinal;
                this.formatBits = formatBits;
            }
            /*-- Constants --*/
            Ecc.LOW = new Ecc(0, 1); // The QR Code can tolerate about  7% erroneous codewords
            Ecc.MEDIUM = new Ecc(1, 0); // The QR Code can tolerate about 15% erroneous codewords
            Ecc.QUARTILE = new Ecc(2, 3); // The QR Code can tolerate about 25% erroneous codewords
            Ecc.HIGH = new Ecc(3, 2); // The QR Code can tolerate about 30% erroneous codewords
            return Ecc;
        }());
        QrCode.Ecc = Ecc;
    })(QrCode = qrcodegen.QrCode || (qrcodegen.QrCode = {}));
})(qrcodegen || (qrcodegen = {}));
/*---- Public helper enumeration ----*/
(function (qrcodegen) {
    var QrSegment;
    (function (QrSegment) {
        /*
         * Describes how a segment's data bits are interpreted. Immutable.
         */
        var Mode = /** @class */ (function () {
            /*-- Constructor and fields --*/
            function Mode(
            // The mode indicator bits, which is a uint4 value (range 0 to 15).
            modeBits, 
            // Number of character count bits for three different version ranges.
            numBitsCharCount) {
                this.modeBits = modeBits;
                this.numBitsCharCount = numBitsCharCount;
            }
            /*-- Method --*/
            // (Package-private) Returns the bit width of the character count field for a segment in
            // this mode in a QR Code at the given version number. The result is in the range [0, 16].
            Mode.prototype.numCharCountBits = function (ver) {
                return this.numBitsCharCount[Math.floor((ver + 7) / 17)];
            };
            /*-- Constants --*/
            Mode.NUMERIC = new Mode(0x1, [10, 12, 14]);
            Mode.ALPHANUMERIC = new Mode(0x2, [9, 11, 13]);
            Mode.BYTE = new Mode(0x4, [8, 16, 16]);
            Mode.KANJI = new Mode(0x8, [8, 10, 12]);
            Mode.ECI = new Mode(0x7, [0, 0, 0]);
            return Mode;
        }());
        QrSegment.Mode = Mode;
    })(QrSegment = qrcodegen.QrSegment || (qrcodegen.QrSegment = {}));
})(qrcodegen || (qrcodegen = {}));


const QRGenerator = {
  // payload: string | object
  generate(payload, canvas, size=180, opts={}){
    try{
      if(!canvas) return;
      const text = (typeof payload === 'string') ? payload : safeJson(payload);
      const ecc = (opts.ecc || 'M').toUpperCase();
      const border = (opts.border ?? 4);
      const ecl = ({
        'L': qrcodegen.QrCode.Ecc.LOW,
        'M': qrcodegen.QrCode.Ecc.MEDIUM,
        'Q': qrcodegen.QrCode.Ecc.QUARTILE,
        'H': qrcodegen.QrCode.Ecc.HIGH
      })[ecc] || qrcodegen.QrCode.Ecc.MEDIUM;

      const qr = qrcodegen.QrCode.encodeText(text, ecl);
      this._draw(canvas, qr, size, border);
    }catch(e){
      console.warn('QRGenerator failed:', e);
      try{
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.height = size;
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = '#111';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText('QR error', 10, 20);
      }catch(_){}
      Toast.show('QR generation failed. Try shorter text / code.', 2500);
    }
  },
  _draw(canvas, qr, size, border){
    const n = qr.size;
    const scale = Math.floor(size / (n + border*2)) || 1;
    const realSize = (n + border*2) * scale;

    const ctx = canvas.getContext('2d');
    canvas.width = canvas.height = realSize;

    // background
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,realSize,realSize);

    ctx.fillStyle = '#000';
    for(let y=0;y<n;y++){
      for(let x=0;x<n;x++){
        if(qr.getModule(x,y)){
          ctx.fillRect((x+border)*scale, (y+border)*scale, scale, scale);
        }
      }
    }
  }
};


/* ----------------------------- VOICE RECALL (V20) ----------------------------- */
const VoiceRecall = {
  key:'voice_recall',
  rec:null,
  chunks:[],
  recording:false,

  async hasClip(){
    const b=await Store.getBlob(this.key);
    return !!b;
  },

  async record5s(){
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        Toast.show('Mic not supported on this device/browser');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
      const mr = new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
      this.rec=mr;
      this.chunks=[];
      this.recording=true;

      Toast.show('Recording... (5 seconds)');
      mr.ondataavailable = e => { if(e.data && e.data.size>0) this.chunks.push(e.data); };
      mr.onstop = async () => {
        this.recording=false;
        stream.getTracks().forEach(t=>t.stop());
        const blob = new Blob(this.chunks, {type: mr.mimeType || 'audio/webm'});
        const ok = await Store.saveBlob(this.key, blob);
        if(ok) Toast.show('Voice Recall saved âœ”');
        else Toast.show('Could not save recording (storage full?)');
      };

      mr.start();
      setTimeout(()=>{ try{ mr.stop(); }catch(e){} }, 5000);
    }catch(e){
      Toast.show('Recording failed: '+(e.message||e.name||'unknown'));
    }
  },

  async play(opts={}){
    try{
      const blob = await Store.getBlob(this.key);
      if(!blob){
        if(!opts.silentFail) Toast.show('No voice clip yet. Record first.');
        return false;
      }
      // Best effort unlock audio context
      await AudioEngine.ensure();

      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.volume = AudioEngine.vol;
      const p = a.play();
      if(p && p.catch) await p.catch(()=>{});
      setTimeout(()=>URL.revokeObjectURL(url), 15000);
      return true;
    }catch(e){
      if(!opts.silentFail) Toast.show('Playback blocked by browser');
      return false;
    }
  },

  async clear(){
    await Store.saveBlob(this.key, null);
    Toast.show('Voice clip cleared');
  }
};

/* ----------------------------- VOICE ANNOUNCER (TTS) ----------------------------- */
const VoiceAnnouncer = {
  lastSpokenMs:0,

  supported(){
    return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
  },

  speak(text){
    if(!Settings.prefs.tts) return;
    if(!this.supported()) return;
    const now=nowMs();
    if(now-this.lastSpokenMs<4500) return; // avoid spam
    this.lastSpokenMs=now;

    try{
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.02;
      u.pitch = 1.0;
      u.volume = clamp(AudioEngine.vol, 0.1, 1);
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  },

  zoneMessage(pet){
    const z=pet.zone.stable;
    if(z==='SAFE') return `${pet.name} safe.`;
    if(z==='CAUTION') return `${pet.name} caution.`;
    if(z==='WARNING') return `${pet.name} warning.`;
    if(z==='DANGER') return `${pet.name} danger.`;
    if(z==='LOST') return `${pet.name} lost signal.`;
    return `${pet.name} status changed.`;
  }
};

/* ----------------------------- BLE MATCHING ----------------------------- */
function _mfgPrefixHexFromEvent(event){
  try{
    if(!event.manufacturerData) return null;
    let pref=null;
    event.manufacturerData.forEach((v,k)=>{
      if(pref) return;
      const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
      pref=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    });
    return pref;
  }catch(e){
    return null;
  }
}

function matchScore(event, sig){
  if(!sig) return 0;
  let score=0;
  const dn=event.device.name||'';
  const di=event.device.id||'';

  if(sig.deviceId && di===sig.deviceId) score+=0.60;

  if(sig.nameExact && dn===sig.nameExact) score+=0.50;
  else if(sig.namePrefix && dn.toLowerCase().startsWith(sig.namePrefix.toLowerCase())) score+=0.30;

  if(sig.serviceUuids && event.uuids){
    const eu=event.uuids.map(u=>u.toString().toLowerCase());
    if(sig.serviceUuids.some(u=>eu.includes(u.toLowerCase()))) score+=0.25;
  }

  if(sig.manufacturerId!==undefined && event.manufacturerData){
    event.manufacturerData.forEach((v,k)=>{ if(k===sig.manufacturerId) score+=0.20; });
  }

  if(sig.manufacturerDataPrefixHex && event.manufacturerData){
    const pref=_mfgPrefixHexFromEvent(event);
    if(pref && pref===sig.manufacturerDataPrefixHex) score+=0.20; // v4.1: stronger manufacturer prefix weight
  }

  if(sig.confirmed) score=Math.min(1, score*1.15);
  return Math.min(1, score);
}

function routeAdvertisement(event, pets, now){
  if(!pets.length) return;

  const rssi=event.rssi;
  if(typeof rssi!=='number' || isNaN(rssi)) return;

  const scores=pets
    .map(p=>({pet:p, score:matchScore(event,p.signature)}))
    .filter(s=>s.score>0)
    .sort((a,b)=>b.score-a.score);

  if(scores.length===0) return;

  const top1=scores[0];
  const threshold = (top1.pet.signature && top1.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
  if(top1.score < threshold) return;

  // Collision protection
  if(scores.length>=2){
    const top2=scores[1];
    const t2=(top2.pet.signature && top2.pet.signature.confirmed) ? MATCH_THRESHOLD_CONFIRMED : MATCH_THRESHOLD_UNCONFIRMED;
    if(top2.score>=t2 && (top1.score-top2.score)<GAP_MIN){
      top1.pet.ambiguousCount++;
      top1.pet.lastAmbiguousMs=now;
      top1.pet.whyText='Signal ambiguous (multiple tags match)';
      return;
    }
  }

  // Focus mode: process only focused pet; others keep raw
  if(App.trackMode==='focus' && App.focusPetId && top1.pet.id!==App.focusPetId){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  // Per-pet throttle
  if(now-top1.pet.lastProcessMs < top1.pet.getMinInterval()){
    top1.pet.ingestRaw(rssi, now);
    return;
  }

  top1.pet.processRssi(rssi, now);
}

/* ----------------------------- BLE ENGINE (V35 hardened + V40 fixes) ----------------------------- */
const BLE = {
  scanning:false,
  scanReq:null,
  _handler:null,
  supported:false,

  // restart protection
  restartCount:0,
  restartWindowStart:0,
  restartInProgress:false,
  lastRestartMs:0,
  lastRestartReason:'',

  // scan mode
  lastScanMode:'track',
  usingFilters:false,

  // scan health
  lastAnyAdvMs:0,
  stallCount:0,

  // adv/sec rolling
  advPerSec:0,
  _secStart:0,
  _secCount:0,
  _secRing:new RingBuffer(6),

  lastErrorName:'',
  lastErrorMessage:'',

  checkSupport(){
    if(!navigator.bluetooth) return false;
    if(typeof navigator.bluetooth.requestLEScan!=='function') return false;
    if(location.protocol!=='https:' && location.hostname!=='localhost' && location.hostname!=='127.0.0.1' && !location.protocol.startsWith('file')) return false;
    return true;
  },

  _resetCounters(){
    this.lastAnyAdvMs = nowMs();
    this.advPerSec = 0;
    this._secStart = nowMs();
    this._secCount = 0;
    this._secRing.clear();
  },

  markAdv(now){
    // rolling adv/sec
    if(!this._secStart) this._secStart=now;
    if(now - this._secStart >= 1000){
      this._secRing.push(this._secCount);
      const avg = this._secRing.length ? (this._secRing.data.reduce((a,b)=>a+b,0)/this._secRing.length) : this._secCount;
      this.advPerSec = Math.round(avg*10)/10;
      this._secStart = now;
      this._secCount = 0;
    }
    this._secCount++;
    this.lastAnyAdvMs = now;
  },

  congestionLevel(){
    const a=this.advPerSec;
    if(a>12) return 'high';
    if(a>=3) return 'med';
    return 'low';
  },

  _buildTrackFilters(){
    // Prefer filters to reduce overload.
    // Only uses namePrefix (safe), because IDs aren't usable in scan filters.
    let pets = App.pets || [];
    if(App.trackMode==='focus' && App.focusPetId){
      pets = pets.filter(p=>p.id===App.focusPetId);
    }
    const prefixes = pets
      .map(p=>p.signature && p.signature.namePrefix ? String(p.signature.namePrefix).trim() : '')
      .filter(x=>x && x.length>=2);

    // De-dup
    const uniq=[...new Set(prefixes)].slice(0,5);
    if(!uniq.length) return null;

    // Build filters
    return uniq.map(p=>({namePrefix:p}));
  },

  async startScan(mode='track', opts={}){
    this.lastErrorName=''; this.lastErrorMessage='';
    this.supported=this.checkSupport();
    if(!this.supported) return false;

    // If already scanning in same mode, do nothing
    if(this.scanning && this.lastScanMode===mode && this.scanReq) return true;

    // Switch mode: stop first (important when track uses filters)
    if(this.scanning && this.lastScanMode!==mode){
      this.stopScan();
      await new Promise(r=>setTimeout(r, 250));
    }

    try{
      // Ensure single event handler registration
      if(!this._handler){
        this._handler = e => {
          const n=nowMs();
          this.markAdv(n);
          App.onAdvertisement(e);
        };
        navigator.bluetooth.addEventListener('advertisementreceived', this._handler);
      }

      let options={keepRepeatedDevices:true};

      if(mode==='track'){
        const filters=this._buildTrackFilters();
        if(filters && filters.length){
          options.filters=filters;
          this.usingFilters=true;
        }else{
          options.acceptAllAdvertisements=true;
          this.usingFilters=false;
        }
      }else{
        // register / wizard
        options.acceptAllAdvertisements=true;
        this.usingFilters=false;
      }

      // request scan
      this.lastScanMode=mode;
      this.scanReq = await navigator.bluetooth.requestLEScan(options);
      this.scanning = true;
      this._resetCounters();
      return true;

    }catch(e){
      console.error('BLE scan error:', e);
      this.lastErrorName = e && e.name ? e.name : 'Error';
      this.lastErrorMessage = e && e.message ? e.message : '';

      // Do not spam on silent attempts (auto-start)
      if(!opts.silent){
        if(this.lastErrorName==='NotAllowedError') Toast.show('Bluetooth permission denied');
        else if(this.lastErrorName==='SecurityError') Toast.show('Scan blocked: insecure context');
        else Toast.show('Scan failed: '+(this.lastErrorMessage||this.lastErrorName||'Unknown'));
      }
      this.scanning=false;
      this.scanReq=null;
      this.advPerSec=0;
      return false;
    }
  },

  stopScan(){
    if(this.scanReq){
      try{ this.scanReq.stop(); }catch(e){}
    }
    this.scanReq=null;
    this.scanning=false;
    this.advPerSec=0;
    this._secCount=0;
    this._secStart=nowMs();
  },

  async restartScan(reason='restart'){
    if(this.restartInProgress) return;
    const now=nowMs();

    if(now-this.lastRestartMs < perfProfile.restartCooldown) return;

    if(now-this.restartWindowStart > 60000){
      this.restartCount=0;
      this.restartWindowStart=now;
    }
    if(this.restartCount >= MAX_RESTARTS_PER_MIN) return;

    this.restartInProgress=true;
    this.restartCount++;
    this.lastRestartMs=now;
    this.lastRestartReason=reason;

    this.stopScan();
    await new Promise(r=>setTimeout(r, 600));
    await this.startScan(this.lastScanMode || 'track', {silent:true});
    this.restartInProgress=false;
  }
};

/* ----------------------------- WIZARD (V35 + V40 signature hardening) ----------------------------- */
const Wizard = {
  mode:'add', // 'add' | 'reverify'
  targetPetId:null,

  candidates:{},
  selectedId:null,
  selectedSig:null,
  baselineRssi:null,
  verified:false,
  chosenIcon:'ğŸ¶',

  scanTimer:null,
  verifyTimer:null,

  calib:{}, // {1:rssi,10:rssi}

  isOpen(){
    return $('wizard-overlay').classList.contains('active');
  },

  open(petId=null){
    this.mode = petId ? 'reverify' : 'add';
    this.targetPetId = petId || null;

    $('wizard-title').textContent = (this.mode==='reverify') ? 'Re-verify Tag' : 'Add Pet Wizard';

    $('wizard-overlay').classList.add('active');

    this.candidates={};
    this.selectedId=null;
    this.selectedSig=null;
    this.baselineRssi=null;
    this.verified=false;
    this.calib={};

    this.chosenIcon='ğŸ¶';
    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===petId);
      if(p){ this.chosenIcon=p.icon; }
    }

    this._showStep(1);
    this._buildIconPicker();

    // Switch to register scan (accept all), real restart
    this._startScan();
  },

  close(){
    $('wizard-overlay').classList.remove('active');
    clearInterval(this.scanTimer);
    clearInterval(this.verifyTimer);

    // Return to tracking scan if monitoring desired
    if(App.pets.length>0 && App.monitoringWanted){
      BLE.startScan('track', {silent:true});
    }
  },

  _showStep(n){
    document.querySelectorAll('.wizard-step').forEach(el=>el.classList.remove('active'));
    $('wiz-step-'+n).classList.add('active');
    for(let i=1;i<=3;i++){
      const p=$('sp-'+i);
      p.className='step-pill';
      if(i<n) p.classList.add('done');
      else if(i===n) p.classList.add('current');
    }

    // Update save button label for reverify
    if(n===3){
      $('btn-wiz-save').textContent = (this.mode==='reverify') ? 'âœ… Update' : 'âœ… Save';
      if(this.mode==='reverify'){
        const p=App.pets.find(x=>x.id===this.targetPetId);
        if(p){
          $('input-name').value=p.name;
          this.chosenIcon=p.icon;
          this._buildIconPicker();
        }
      }else{
        $('input-name').value='';
      }
    }
  },

  async _startScan(){
    $('scan-status').textContent='Starting scan...';
    $('scan-list').innerHTML='';
    this.candidates={};

    // Always ensure register scan mode
    BLE.stopScan();
    await new Promise(r=>setTimeout(r, 250));
    const ok = await BLE.startScan('register');
    if(!ok){
      $('scan-status').textContent='BLE not supported or blocked. Showing demo devices.';
      this._startDemoScan();
      return;
    }
    $('scan-status').textContent='Scanning... Hold tag close to phone.';
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>this._renderCandidates(), 900);
  },

  _startDemoScan(){
    const dd=[
      {id:'demo_itag_001',name:'iTAG'},
      {id:'demo_finder_002',name:'Key Finder'},
      {id:'demo_unknown_003',name:''},
      {id:'demo_buds_004',name:'Galaxy Buds Pro'}
    ];
    let t=0;
    clearInterval(this.scanTimer);
    this.scanTimer=setInterval(()=>{
      const d=dd[t%dd.length];
      const r=d.name==='iTAG' ? (-48-Math.random()*8) : (-65-Math.random()*25);
      this.handleAdv({device:{id:d.id,name:d.name}, rssi:r, uuids:[]});
      t++;
      this._renderCandidates();
    }, 320);
  },

  handleAdv(ev){
    const id = ev.device.id || ('unknown_'+Math.random().toString(36).slice(2,8));
    const name = ev.device.name || '';
    const rssi = ev.rssi;
    if(typeof rssi!=='number' || isNaN(rssi)) return;

    if(!this.candidates[id]){
      this.candidates[id]={
        id, name,
        rssiSamples:new RingBuffer(30),
        firstSeen:nowMs(),
        lastSeen:0,
        uuids:ev.uuids||[],
        manufacturerData:null,
        manufacturerId:null
      };
    }
    const c=this.candidates[id];
    c.rssiSamples.push(rssi);
    c.lastSeen=nowMs();

    if(ev.manufacturerData){
      c.manufacturerData=ev.manufacturerData;
      ev.manufacturerData.forEach((v,k)=>{ c.manufacturerId=k; });
    }
    if(name && !c.name) c.name=name;
  },

  _tagLikelihood(c){
    // Simple heuristic from V35 (kept)
    let s=0;
    const med=median(c.rssiSamples.data);
    s += clamp((med+100)/50,0,1)*40;
    s += clamp(c.rssiSamples.length/15,0,1)*25;

    if(c.rssiSamples.length>=5){
      const m=median(c.rssiSamples.data);
      const v=c.rssiSamples.data.reduce((a,b)=>a+(b-m)**2,0)/c.rssiSamples.length;
      s += clamp(1 - v/200, 0, 1)*15;
    }

    const n=(c.name||'').toLowerCase();
    if(/itag|finder|anti.?lost|isearch|key|tile|nut|tag/.test(n)) s+=15;
    if(/buds|watch|band|airpod|galaxy|pixel|bose|sony|jbl|speaker|headphone|tv|car/.test(n)) s-=30;

    return Math.round(clamp(s,0,100));
  },

  _renderCandidates(){
    const now=nowMs();
    const arr = Object.values(this.candidates)
      .filter(c => now - c.lastSeen < 6000 && c.rssiSamples.length>=2)
      .map(c => ({...c, med: median(c.rssiSamples.data), score: this._tagLikelihood(c)}))
      .sort((a,b)=>b.score-a.score)
      .slice(0, 8);

    if(!arr.length){
      $('scan-list').innerHTML='<div class="text-center" style="color:var(--text-muted);padding:20px">No devices found yet...</div>';
      return;
    }

    $('scan-list').innerHTML = arr.map(c=>{
      const pct=clamp((c.med+100)*2,0,100);
      const col=pct>60?'var(--accent-green)':pct>30?'var(--accent-yellow)':'var(--accent-red)';
      const sel=this.selectedId===c.id;
      const displayId = c.id.length>16 ? (c.id.slice(0,8)+'â€¦'+c.id.slice(-4)) : c.id;
      return `
        <div class="scan-item ${sel?'selected':''}" onclick="Wizard.selectCandidate('${c.id}')">
          <div>
            <div class="scan-item-name">${c.name||'âŸ¨Unknown TagâŸ©'}</div>
            <div class="scan-item-id">${displayId}</div>
            <div class="tag-score">Tag likelihood: ${c.score}%</div>
          </div>
          <div class="scan-item-right">
            <div class="scan-rssi" style="color:${col}">${Math.round(c.med)} dBm</div>
            <div class="rssi-bar-track"><div class="rssi-bar-fill" style="width:${pct}%;background:${col}"></div></div>
          </div>
        </div>
      `;
    }).join('');
  },

  selectCandidate(id){
    this.selectedId=id;
    const c=this.candidates[id];
    if(!c) return;

    // manufacturer prefix hex (first 2 bytes)
    let mfgPrefix=null;
    try{
      if(c.manufacturerData){
        for(const [k,v] of c.manufacturerData.entries()){
          const u8=new Uint8Array(v.buffer, v.byteOffset, Math.min(v.byteLength,2));
          mfgPrefix=[...u8].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
          break;
        }
      }
    }catch(e){ mfgPrefix=null; }

    this.selectedSig = {
      deviceId: c.id,
      nameExact: c.name || null,
      namePrefix: c.name ? c.name.slice(0, Math.min(6, c.name.length)) : null,
      serviceUuids: (c.uuids && c.uuids.length) ? c.uuids.map(u=>u.toString()) : null,
      manufacturerId: (c.manufacturerId!==null && c.manufacturerId!==undefined) ? c.manufacturerId : undefined,
      manufacturerDataPrefixHex: mfgPrefix || null,
      confirmed:false
    };

    this._renderCandidates();
    setTimeout(()=>this._goStep2(), 350);
  },

  _goStep2(){
    this._showStep(2);
    const c=this.candidates[this.selectedId];
    if(!c) return;

    this.baselineRssi = median(c.rssiSamples.slice(-6));
    this.verified=false;

    $('verify-delta').textContent='0';
    $('verify-delta').style.color='var(--text-muted)';
    $('verify-status').textContent='Waiting for movement...';
    $('verify-status').style.color='var(--text-muted)';

    $('btn-verified').classList.add('hidden');
    $('btn-skip-verify').classList.remove('hidden');

    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';

    clearInterval(this.verifyTimer);
    this.verifyTimer=setInterval(()=>{
      const cc=this.candidates[this.selectedId];
      if(!cc || cc.rssiSamples.length<3) return;

      const cur=median(cc.rssiSamples.slice(-4));
      const delta=this.baselineRssi-cur;

      $('verify-delta').textContent = Math.round(delta);

      if(delta>=10){
        $('verify-delta').style.color='var(--accent-green)';
        $('verify-status').textContent='Signal drop confirmed!';
        $('verify-status').style.color='var(--accent-green)';
        $('btn-verified').classList.remove('hidden');
        $('btn-skip-verify').classList.add('hidden');
        this.verified=true;
        clearInterval(this.verifyTimer);
      }else if(delta>=5){
        $('verify-delta').style.color='var(--accent-yellow)';
        $('verify-status').textContent='Keep moving further away...';
      }else{
        $('verify-delta').style.color='var(--text-muted)';
      }
    }, 520);
  },

  skipVerify(){
    this.verified=false;
    clearInterval(this.verifyTimer);
    this.goStep3();
  },

  goStep3(){
    clearInterval(this.verifyTimer);
    if(this.selectedSig) this.selectedSig.confirmed=this.verified;
    this._showStep(3);

    if(this.mode==='add'){
      $('input-name').value='';
      $('input-name').focus();
    }else{
      $('input-name').focus();
    }
  },

  _buildIconPicker(){
    $('icon-picker').innerHTML = ICONS.map(ic=>`
      <div class="icon-opt ${ic===this.chosenIcon?'selected':''}" onclick="Wizard.pickIcon('${ic}')">${ic}</div>
    `).join('');
  },

  pickIcon(ic){
    this.chosenIcon=ic;
    this._buildIconPicker();
  },

  rescan(){
    // Force true scan restart (fixes V38 issue)
    this.candidates={};
    this.selectedId=null;
    $('scan-list').innerHTML='';
    $('scan-status').textContent='Re-scanning...';
    BLE.stopScan();
    setTimeout(()=>this._startScan(), 280);
  },

  _currentCandidateMedian(){
    const c=this.candidates[this.selectedId];
    if(!c || c.rssiSamples.length<3) return null;
    return median(c.rssiSamples.slice(-4));
  },

  recordCalib(dist){
    const med=this._currentCandidateMedian();
    if(med===null) { Toast.show('Need more samplesâ€¦'); return; }
    this.calib[dist]=med;
    if(dist===1) $('calib-1m').textContent=Math.round(med)+' dBm';
    if(dist===10) $('calib-10m').textContent=Math.round(med)+' dBm';
    Toast.show(`Calibration recorded at ${dist}m`);
  },

  clearCalib(){
    this.calib={};
    $('calib-1m').textContent='--';
    $('calib-10m').textContent='--';
    Toast.show('Calibration cleared');
  },

  async save(){
    const name = ($('input-name').value||'').trim() || 'My Pet';
    const sig = this.selectedSig || {};
    sig.confirmed = !!this.verified;

    // Attach calibration to be applied on pet.distance later
    const calibPoints=[];
    if(typeof this.calib[1]==='number') calibPoints.push({rssi:this.calib[1], dist:1});
    if(typeof this.calib[10]==='number') calibPoints.push({rssi:this.calib[10], dist:10});

    if(this.mode==='reverify'){
      const p=App.pets.find(x=>x.id===this.targetPetId);
      if(!p){ Toast.show('Pet not found'); this.close(); return; }
      p.name=name;
      p.icon=this.chosenIcon;
      p.signature=sig;
      p.ambiguousCount=0;
      p.lastAmbiguousMs=0;
      if(calibPoints.length){
        p.distance = new DistanceEstimator();
        calibPoints.forEach(pt=>p.distance.addCalibration(pt.rssi, pt.dist));
      }
      await Store.savePet(p);
      Toast.show('Tag signature updated âœ”');
      this.close();
      App.render();
      return;
    }

    const pet=new Pet({name, icon:this.chosenIcon, signature:sig, createdAt:nowMs()});
    if(calibPoints.length){
      calibPoints.forEach(pt=>pet.distance.addCalibration(pt.rssi, pt.dist));
    }

    App.addPet(pet);
    await Store.savePet(pet);

    Toast.show(name+' is now protected!');
    this.close();

    // Auto suggestions if signature seems weak
    if(pet.signatureStrength()<=2){
      Toast.show('Tip: Use Focus mode for best accuracy (weak tag signature)');
    }

    // Start monitoring if user wants
    if(App.monitoringWanted) BLE.startScan('track', {silent:true});
  }
};

/* ----------------------------- SOS MODULE (V35) ----------------------------- */
const SOS = {
  active:false,
  holdTimer:null,
  strobeTimer:null,
  targetPet:null,
  hcHistory:new RingBuffer(12),
  savedLocation:null,

  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  activate(){
    this.active=true;
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    $('sos-active-name').textContent = p ? p.name : 'PET';
    $('sos-active').classList.add('active');
    if(navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
    AudioEngine.alertForZone('DANGER');
    this._startStrobe();
  },

  deactivate(){
    this.active=false;
    $('sos-active').classList.remove('active');
    clearInterval(this.strobeTimer);
    $('sos-strobe-area').style.background='';
    $('sos-active').style.background='#000';
  },

  _startStrobe(){
    let on=false;
    this.strobeTimer=setInterval(()=>{
      $('sos-strobe-area').style.background=on?'#fff':'#e74c3c';
      $('sos-active').style.background=on?'#300':'#000';
      on=!on;
    }, 420);
  },

  updateHC(rssi){
    this.hcHistory.push(rssi);
    if(this.hcHistory.length<6) return;
    const r=median(this.hcHistory.slice(-3));
    const o=median(this.hcHistory.slice(-6,-3));
    const d=r-o;
    const a=$('hc-arrow'), t=$('hc-text'), rv=$('hc-rssi');
    rv.textContent=Math.round(r)+' dBm';
    if(d>3){
      a.textContent='ğŸ”¥';
      t.textContent='HOT â€” Getting Closer!';
      t.style.color='var(--zone-danger)';
    }else if(d<-3){
      a.textContent='ğŸ§Š';
      t.textContent='COLD â€” Moving Away';
      t.style.color='var(--accent-blue)';
    }else{
      a.textContent='â¡ï¸';
      t.textContent='STEADY â€” Keep searching';
      t.style.color='var(--text-muted)';
    }
  },

  updateSnapshot(pet){
    if(!pet) return;
    const now=nowMs();
    const l=[
      '<strong>'+pet.name+'</strong> '+pet.icon,
      'Status: <span style="color:var(--zone-'+pet.zone.stable.toLowerCase()+')">'+pet.zone.stable+'</span>',
      'Last seen: '+pet.getLastSeenText(now),
      'Signal: '+(pet.lastRawRssi!==null ? Math.round(pet.smoothedRssi)+' dBm' : 'N/A'),
      'Distance: ~'+pet.distMeters.toFixed(1)+'m (approx)',
      'Confidence: '+pet.confidence+'%',
      'Rescue ID: <strong>'+pet.rescueId+'</strong>'
    ];
    if(pet.batterySuspect) l.push('âš  Possible weak battery (frequent LOST)');
    if(this.savedLocation) l.push('ğŸ“ '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5));
    $('sos-snapshot').innerHTML=l.join('<br>');
  },

  async saveLocation(){
    if(!navigator.geolocation){ Toast.show('Geolocation not available'); return; }
    try{
      const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000}));
      this.savedLocation={lat:pos.coords.latitude, lon:pos.coords.longitude, time:nowMs()};
      Toast.show('Location saved!');
      const p=this.targetPet || App.pets[0];
      if(p) this.updateSnapshot(p);
    }catch(e){
      Toast.show('Could not get location: '+(e.message||'Denied'));
    }
  },

  shareMessage(){
    const p=this.targetPet || (App.pets.length?App.pets[0]:null);
    let m='LOST PET ALERT\n';
    if(p){
      m+='Name: '+p.name+'\nRescue ID: '+p.rescueId+'\nLast signal: '+p.getLastSeenText(nowMs())+'\nStatus: '+p.zone.stable+'\nApprox distance: ~'+p.distMeters.toFixed(1)+'m\n';
    }
    if(this.savedLocation){
      m+='Owner location: '+this.savedLocation.lat.toFixed(5)+', '+this.savedLocation.lon.toFixed(5)+'\n';
      m+='Map: https://maps.google.com/?q='+this.savedLocation.lat+','+this.savedLocation.lon+'\n';
    }
    m+='\nSent via VitalGuard AI (mcorpai.org)\nNOT GPS â€” Bluetooth proximity only';

    if(navigator.share){
      navigator.share({title:'Lost Pet Alert', text:m}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(m).then(()=>Toast.show('Copied to clipboard!')).catch(()=>Toast.show('Could not copy'));
    }
  },

  renderPetSelect(){
    if(!App.pets.length) return;
    $('sos-pet-select').innerHTML =
      '<div class="section-title" style="margin-top:0">Select Pet</div>' +
      App.pets.map(p=>`
        <button class="btn btn-sm ${this.targetPet && this.targetPet.id===p.id ? 'btn-success':'btn-secondary'}"
          style="margin:0 4px 4px 0"
          onclick="SOS.selectPet('${p.id}')"
        >${p.icon} ${p.name}</button>
      `).join('');
  },

  selectPet(id){
    this.targetPet = App.pets.find(p=>p.id===id) || null;
    this.hcHistory.clear();
    this.renderPetSelect();
    if(this.targetPet){
      this.updateSnapshot(this.targetPet);
      App.focusPetId=this.targetPet.id;
      $('sos-focus-banner').classList.remove('hidden');
      if(App.trackMode==='focus') Toast.show('Focus Mode: '+this.targetPet.name);
    }
  }
};

/* ----------------------------- EMERGENCY MODE (V20) ----------------------------- */
const Emergency = {
  active:false,
  strobeTimer:null,
  wakeLock:null,
  shakeEnabled:false,
  shakeArmed:false,
  lastShakeMs:0,

  data:{ name:'', phone:'', medical:'' },

  async load(){
    this.data.name = await Store.getSetting('emg_name','');
    this.data.phone = await Store.getSetting('emg_phone','');
    this.data.medical = await Store.getSetting('emg_medical','');
    this.shakeEnabled = await Store.getSetting('emg_shake', false);
  },

  async save(){
    await Store.saveSetting('emg_name', this.data.name||'');
    await Store.saveSetting('emg_phone', this.data.phone||'');
    await Store.saveSetting('emg_medical', this.data.medical||'');
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Emergency profile saved');
  },

  open(){
    $('emg-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('emg-overlay').classList.remove('active');
  },

  render(){
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    const shakeState = this.shakeEnabled ? 'ON' : 'OFF';

    $('emg-body').innerHTML = `
      <div class="tip-card danger">
        <div class="tip-title">Emergency Mode</div>
        <div class="tip-body">
          This mode is for <strong>personal safety</strong> (siren + strobe + QR contact card).
          Configure now, so you can activate fast when needed.
        </div>
      </div>

      <div class="card">
        <div style="font-size:.75rem;color:var(--text-secondary);margin-bottom:6px">Your name</div>
        <input id="emg-name" type="text" value="${(this.data.name||'').replace(/"/g,'&quot;')}" placeholder="Your Name"
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Emergency phone</div>
        <input id="emg-phone" type="text" value="${(this.data.phone||'').replace(/"/g,'&quot;')}" placeholder="+82..."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem">
        <div style="font-size:.75rem;color:var(--text-secondary);margin:12px 0 6px">Medical / notes (optional)</div>
        <textarea id="emg-medical" rows="3" placeholder="Allergies, conditions, etc."
          style="width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);font-size:.9rem;resize:vertical">${(this.data.medical||'')}</textarea>

        <button class="btn btn-secondary btn-block" style="margin-top:12px" onclick="Emergency.saveFromUI()">ğŸ’¾ Save Profile</button>
      </div>

      <div class="card">
        <div class="section-title" style="font-size:.8rem;margin-bottom:8px">Shake SOS</div>
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Current: <strong>${shakeState}</strong><br>
          If enabled, shaking your phone can activate Emergency (best effort; may need permission on iOS).
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.toggleShake()">Toggle</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Emergency.requestMotionPermission()">iOS Permission</button>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:8px">Hold 2 seconds to activate</div>
        <button class="btn btn-primary" style="font-size:1.05rem;padding:14px 26px;border-radius:50px"
          ontouchstart="Emergency.holdStart()" ontouchend="Emergency.holdEnd()"
          onmousedown="Emergency.holdStart()" onmouseup="Emergency.holdEnd()"
        >ğŸ›¡ ACTIVATE EMERGENCY</button>
      </div>

      <div class="tip-card warn">
        <div class="tip-title">Safety Note</div>
        <div class="tip-body">
          This tool helps call attention and share contact info. It does not guarantee safety.
          Always prioritize real emergency services in your region.
        </div>
      </div>
    `;
  },

  saveFromUI(){
    this.data.name = ($('emg-name').value||'').trim();
    this.data.phone = ($('emg-phone').value||'').trim();
    this.data.medical = ($('emg-medical').value||'').trim();
    this.save();
    this.render();
  },

  async toggleShake(){
    this.shakeEnabled = !this.shakeEnabled;
    await Store.saveSetting('emg_shake', !!this.shakeEnabled);
    Toast.show('Shake SOS ' + (this.shakeEnabled?'ON':'OFF'));
    this.render();
  },

  async requestMotionPermission(){
    // iOS 13+ requires permission for motion sensors
    try{
      if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        const res = await DeviceMotionEvent.requestPermission();
        Toast.show('Motion permission: '+res);
      }else{
        Toast.show('Motion permission not required on this device');
      }
    }catch(e){
      Toast.show('Motion permission failed');
    }
  },

  holdTimer:null,
  holdStart(){ this.holdTimer=setTimeout(()=>this.activate(), 2000); },
  holdEnd(){ clearTimeout(this.holdTimer); },

  async activate(){
    this.data.name = ($('emg-name') ? ($('emg-name').value||'').trim() : this.data.name);
    this.data.phone = ($('emg-phone') ? ($('emg-phone').value||'').trim() : this.data.phone);
    this.data.medical = ($('emg-medical') ? ($('emg-medical').value||'').trim() : this.data.medical);

    await this.save();

    this.active=true;
    $('emergency-active').classList.add('active');

    // Wake lock (best effort)
    try{
      if('wakeLock' in navigator && navigator.wakeLock && navigator.wakeLock.request){
        this.wakeLock = await navigator.wakeLock.request('screen');
      }
    }catch(e){ this.wakeLock=null; }

    // Strobe
    this._startStrobe();

    // Siren & vibration
    AudioEngine.startEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([800,200,800,200,800,400,1200]);

    // QR contact card
    const payload = this.getPayload();
    QRGenerator.generate(payload, $('emg-qr'), 180);

    // UI fields
    $('emg-active-name').textContent = this.data.name ? this.data.name : 'UNKNOWN';
    $('emg-active-sub').textContent = this.data.medical ? ('Info: '+this.data.medical) : 'Tap CALL or SHARE to contact someone.';
    const phoneSan = (this.data.phone||'').replace(/[^0-9+]/g,'');
    $('emg-call').href = phoneSan ? ('tel:'+phoneSan) : '#';

    // Arm shake detection
    this.shakeArmed = this.shakeEnabled;
    this.lastShakeMs=0;
  },

  async deactivate(){
    this.active=false;
    $('emergency-active').classList.remove('active');

    clearInterval(this.strobeTimer);
    this.strobeTimer=null;

    AudioEngine.stopEmergencySiren();
    if(navigator.vibrate) navigator.vibrate([100,60,100]);

    if(this.wakeLock){
      try{ await this.wakeLock.release(); }catch(e){}
      this.wakeLock=null;
    }
  },

  _startStrobe(){
    let on=false;
    clearInterval(this.strobeTimer);
    this.strobeTimer=setInterval(()=>{
      const root=$('emergency-active');
      if(!root) return;
      root.classList.toggle('strobe-on', on);
      on=!on;
    }, 320);
  },

  getPayload(){
    // short payload string
    const phone=(this.data.phone||'').trim();
    const med=(this.data.medical||'').trim();
    return `EMERGENCY|NAME:${this.data.name||''}|PHONE:${phone}|INFO:${med}|APP:VitalGuardAI`;
  },

  share(){
    const text = `EMERGENCY\nName: ${this.data.name||'N/A'}\nPhone: ${this.data.phone||'N/A'}\nInfo: ${this.data.medical||''}\nSent via VitalGuard AI`;
    if(navigator.share){
      navigator.share({title:'Emergency', text}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(text).then(()=>Toast.show('Copied to clipboard')).catch(()=>Toast.show('Could not copy'));
    }
  },

  // Shake detection (best effort)
  handleMotion(e){
    if(!this.shakeEnabled) return;
    if(this.active) return;
    if(!this.shakeArmed) return;

    const now=nowMs();
    const a=e.accelerationIncludingGravity;
    if(!a) return;

    const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
    if(mag>25){
      if(now-this.lastShakeMs<1800) return;
      this.lastShakeMs=now;
      Toast.show('Shake detected â€” activating Emergency');
      this.activate();
    }
  }
};

// Register motion listener once (no permission request on load)
window.addEventListener('devicemotion', e=>Emergency.handleMotion(e), {passive:true});

/* ----------------------------- PET DETAIL OVERLAY (expanded) ----------------------------- */
const Detail = {
  pet:null,

  open(id){
    this.pet=App.pets.find(p=>p.id===id);
    if(!this.pet) return;

    if(App.trackMode==='focus'){
      App.focusPetId=id;
      App.renderPetChips();
    }

    $('detail-title').textContent=this.pet.icon+' '+this.pet.name;
    $('detail-overlay').classList.add('active');
    this.render();
  },

  close(){
    $('detail-overlay').classList.remove('active');
  },

  async render(){
    const p=this.pet;
    if(!p) return;

    const z=p.zone.stable.toLowerCase();
    const now=nowMs();
    const sig=p.signature||{};
    const strength=p.signatureStrength();

    const sigLines=[];
    if(sig.nameExact) sigLines.push('Name: <span class="kbd">'+sig.nameExact+'</span>');
    if(sig.namePrefix) sigLines.push('Prefix: <span class="kbd">'+sig.namePrefix+'</span>');
    if(sig.manufacturerId!==undefined) sigLines.push('MFG ID: <span class="kbd">'+sig.manufacturerId+'</span>');
    if(sig.manufacturerDataPrefixHex) sigLines.push('MFG HEX: <span class="kbd">'+sig.manufacturerDataPrefixHex+'</span>');
    if(sig.deviceId) sigLines.push('Device ID: <span class="kbd">'+(sig.deviceId.length>16?(sig.deviceId.slice(0,8)+'â€¦'+sig.deviceId.slice(-4)):sig.deviceId)+'</span>');
    if(sig.confirmed) sigLines.push('Verified: <span class="kbd">YES</span>');

    const congestion = BLE.congestionLevel();

    let html=`
      <div class="detail-ring zone-${z}">
        <div class="detail-dist">${p.distMeters<1?p.distMeters.toFixed(1):Math.round(p.distMeters)}</div>
        <div class="detail-unit">meters (approx)</div>
        <div class="detail-zone" style="color:var(--zone-${z})">${p.zone.stable}</div>
      </div>

      <div style="text-align:center;font-size:.65rem;color:var(--text-muted)">
        Not GPS â€” Bluetooth proximity estimate only
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
        <span style="font-size:.78rem">Signal Strength</span>
        <span style="font-size:.78rem;font-family:var(--font-mono)">${Math.round(p.smoothedRssi)} dBm ${p.trendArrow}</span>
      </div>

      <div class="rssi-meter">
        <div class="rssi-meter-fill" style="width:${clamp((p.smoothedRssi+100)/70*100,0,100)}%;background:var(--zone-${z})"></div>
      </div>

      <div class="signal-bars">
        ${[12,16,20,24,28].map((h,i)=>`<div class="bar" style="height:${h}px;width:6px;border-radius:2px;background:${i<Math.ceil(clamp((p.smoothedRssi+100)/70*5,0,5))?'var(--zone-'+z+')':'var(--text-muted)'}"></div>`).join('')}
      </div>

      <div style="display:flex;justify-content:space-between;margin:8px 0">
        <span style="font-size:.75rem;color:var(--text-secondary)">Confidence: <strong>${p.confidence}%</strong></span>
        <span style="font-size:.72rem;color:var(--accent-orange);font-style:italic">${p.whyText||''}</span>
      </div>

      ${p.ambiguousCount>0 ? `
        <div class="warning-legal" style="margin-top:10px">
          <p><strong>âš  Signal ambiguous</strong> â€” multiple tags look similar.</p>
          <p style="font-size:.75rem">Fix: Bring tag close â†’ Re-verify signature. This improves matching and prevents false alerts.</p>
          <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      `:''}

      ${p.batterySuspect ? `
        <div class="tip-card warn">
          <div class="tip-title">ğŸ”‹ Battery Suspected</div>
          <div class="tip-body">Frequent LOST flips suggest a weak CR2032 battery or signal shielding. Consider replacing battery and keeping the tag outside metal/waterproof cages.</div>
        </div>
      `:''}

      <div class="rescue-card">
        <div style="font-size:.72rem;color:var(--text-secondary)">Rescue ID (write on collar)</div>
        <div class="rescue-id">${p.rescueId}</div>
        <div style="font-size:.62rem;color:var(--text-muted)">If found, rescuer can contact you using this ID.</div>
        <div class="qr-wrap">
          <canvas id="qr-${p.id}" class="qr-canvas" width="180" height="180"></canvas>
          <div style="font-size:.72rem;color:var(--text-secondary)">QR contact code (visual)</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">ğŸ™ Voice Tools</div>
      <div class="card" style="margin-bottom:12px">
        <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.5">
          Voice Recall plays on <strong>CAUTION</strong> zone to call your pet back (best effort).
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <span style="font-size:.78rem">Voice Recall</span>
          <div class="toggle ${Settings.prefs.voiceRecall?'on':''}" onclick="Settings.toggle('voiceRecall')"></div>
        </div>
        <div class="voice-row">
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.record5s()">ğŸ™ Record 5s</button>
          <button class="btn btn-secondary btn-sm" onclick="VoiceRecall.play()">â–¶ Play</button>
        </div>
      </div>

      <div class="section-title" style="font-size:.8rem">ğŸš Invisible Leash Distance</div>
      <div class="leash-row">
        ${Object.keys(LEASH_PRESETS).map(k=>`<div class="leash-btn ${p.leashPreset===k?'active':''}" onclick="Detail.setLeash('${k}')">${k}</div>`).join('')}
        <div class="leash-btn ${p.leashPreset==='custom'?'active':''}" onclick="Detail.setLeash('custom')">Custom</div>
      </div>

      <div style="margin-top:12px">
        <div class="slider-row"><label>Caution</label><input type="range" min="-90" max="-40" value="${p.thresholds.cautionEnter}" oninput="Detail.updateThreshold('cautionEnter',this.value)"><span class="val" id="dt-caution">${p.thresholds.cautionEnter} dBm</span></div>
        <div class="slider-row"><label>Warning</label><input type="range" min="-98" max="-55" value="${p.thresholds.warningEnter}" oninput="Detail.updateThreshold('warningEnter',this.value)"><span class="val" id="dt-warning">${p.thresholds.warningEnter} dBm</span></div>
        <div class="slider-row"><label>Danger</label><input type="range" min="-100" max="-70" value="${p.thresholds.dangerEnter}" oninput="Detail.updateThreshold('dangerEnter',this.value)"><span class="val" id="dt-danger">${p.thresholds.dangerEnter} dBm</span></div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">ğŸ§  AI Modules</div>
      <div class="card">
        <div class="setting-row">
          <span style="font-size:.78rem">Behavior Fingerprint</span>
          <div class="toggle ${p.aiToggles.behavior?'on':''}" onclick="Detail.toggleAI('behavior')"></div>
        </div>
        <div class="setting-row">
          <span style="font-size:.78rem">Q-Learning Coach (suggest thresholds)</span>
          <div class="toggle ${p.aiToggles.qlearn?'on':''}" onclick="Detail.toggleAI('qlearn')"></div>
        </div>

        <div style="margin-top:10px;font-size:.75rem;color:var(--text-secondary);line-height:1.5">
          Current behavior: <strong>${p.behavior.classify()}</strong><br>
          Congestion: <strong>${congestion.toUpperCase()}</strong> (${BLE.advPerSec} adv/s)
        </div>

        <button class="btn btn-secondary btn-sm" style="margin-top:10px;width:100%" onclick="Detail.suggestAI()">âœ¨ Suggest Adjustment</button>

        <div id="ai-suggestion" style="margin-top:10px;font-size:.75rem;color:var(--text-muted);line-height:1.5"></div>
        <div id="ai-feedback" class="hidden" style="margin-top:10px">
          <div style="font-size:.72rem;color:var(--text-secondary);margin-bottom:6px">Was this suggestion helpful?</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(true)">ğŸ‘ Helpful</button>
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.aiFeedback(false)">ğŸ‘ False alarm</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">ğŸ” Tag Signature</div>
      <div class="card" style="font-size:.75rem;color:var(--text-secondary);line-height:1.6">
        Strength: <strong>${strength}/8</strong><br>
        ${sigLines.length ? sigLines.join('<br>') : 'No signature captured'}
        <div style="margin-top:10px">
          <button class="btn btn-secondary btn-sm" onclick="Wizard.open('${p.id}')">Re-verify Tag</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" style="font-size:.8rem">ğŸ“œ Alert History</div>
      <div id="detail-alerts">
        ${p.alertHistory.length ? p.alertHistory.slice(0,18).map(a=>{
          const t=new Date(a.time);
          return `
            <div class="alert-item">
              <span><span class="alert-dot" style="background:var(--zone-${a.zone.toLowerCase()})"></span>${a.zone} â€” ~${a.dist}m</span>
              <span style="color:var(--text-muted)">${t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${a.why?('('+a.why+')'):''}</span>
            </div>
          `;
        }).join('') : '<div style="font-size:.75rem;color:var(--text-muted);text-align:center;padding:12px">No alerts yet</div>'}
      </div>
    `;

    $('detail-body').innerHTML=html;

    // Generate QR for rescue ID and name (visual code)
    const qrPayload = `VG_TAG|NAME:${p.name}|RESCUE:${p.rescueId}|APP:VitalGuardAI`;
    QRGenerator.generate(qrPayload, $('qr-'+p.id), 180);
  },

  async setLeash(preset){
    if(!this.pet) return;
    if(preset==='custom'){
      this.pet.leashPreset='custom';
    }else{
      this.pet.leashPreset=preset;
      this.pet.thresholds={...LEASH_PRESETS[preset]};
    }
    await Store.savePet(this.pet);
    this.render();
  },

  async updateThreshold(key,val){
    if(!this.pet) return;
    val=parseInt(val);
    this.pet.thresholds[key]=val;

    if(key==='cautionEnter') this.pet.thresholds.cautionExit=val+5;
    if(key==='warningEnter') this.pet.thresholds.warningExit=val+6;
    if(key==='dangerEnter') this.pet.thresholds.dangerExit=val+6;

    this.pet.leashPreset='custom';

    const id = key==='cautionEnter'?'dt-caution':key==='warningEnter'?'dt-warning':'dt-danger';
    $(id).textContent = val+' dBm';

    await Store.savePet(this.pet);
  },

  async toggleAI(key){
    if(!this.pet) return;
    this.pet.aiToggles[key]=!this.pet.aiToggles[key];
    await Store.savePet(this.pet);
    this.render();
  },

  async suggestAI(){
    const p=this.pet;
    if(!p) return;

    if(!p.aiToggles.qlearn){
      Toast.show('Enable Q-Learning Coach first');
      return;
    }

    const zone=p.zone.stable;
    const action=p.qlearn.chooseAction(zone);
    p.lastAiSuggestion={zone, action, at:nowMs()};

    const msg = (action==='widen') ? 'Suggestion: WIDEN boundaries (less sensitive)'
              : (action==='narrow') ? 'Suggestion: NARROW boundaries (more sensitive)'
              : 'Suggestion: MAINTAIN current boundaries';

    $('ai-suggestion').innerHTML = `
      <div style="padding:10px;border-radius:10px;border:1px solid rgba(52,152,219,.25);background:rgba(52,152,219,.06)">
        <strong>${msg}</strong><br>
        <span style="color:var(--text-muted)">Tap â€œApplyâ€ to update thresholds.</span>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.applySuggestion()">Apply</button>
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Detail.resetQ()">Reset AI</button>
        </div>
      </div>
    `;
    $('ai-feedback').classList.add('hidden');
  },

  async applySuggestion(){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;

    const newT=p.qlearn.applyAction(action, p.thresholds);
    p.thresholds=newT;
    p.leashPreset='custom';
    await Store.savePet(p);

    $('ai-feedback').classList.remove('hidden');
    Toast.show('Thresholds updated ('+action+')');
    this.render();
  },

  async aiFeedback(helpful){
    const p=this.pet;
    if(!p || !p.lastAiSuggestion) return;
    const {zone, action}=p.lastAiSuggestion;
    p.qlearn.update(zone, !!helpful, action);
    p.lastAiSuggestion=null;
    await Store.savePet(p);
    Toast.show(helpful?'AI reward saved':'AI penalty saved');
    $('ai-feedback').classList.add('hidden');
  },

  async resetQ(){
    const p=this.pet;
    if(!p) return;
    p.qlearn.reset();
    await Store.savePet(p);
    Toast.show('AI state reset');
    this.render();
  }
};

/* ----------------------------- NAV ----------------------------- */
const Nav = {
  current:'home',
  go(tab){
    this.current=tab;
    document.querySelectorAll('.panel').forEach(el=>el.classList.remove('active'));
    $('panel-'+tab).classList.add('active');

    document.querySelectorAll('.bnav-btn').forEach(el=>{
      el.classList.toggle('active', el.dataset.tab===tab);
    });

    if(tab==='sos'){
      if(App.pets.length>0){
        $('sos-no-pets').classList.add('hidden');
        $('sos-content').classList.remove('hidden');
        if(!SOS.targetPet && App.pets.length) SOS.selectPet(App.pets[0].id);
        SOS.renderPetSelect();
      }else{
        $('sos-no-pets').classList.remove('hidden');
        $('sos-content').classList.add('hidden');
      }
    }

    if(tab==='settings') Settings.renderPetList();
  }
};

/* ----------------------------- SETTINGS ----------------------------- */
const Settings = {
  prefs:{
    sound:true,
    vibrate:true,
    notifWanted:false,
    highAlert:false,
    perfMode:'balanced',
    voiceRecall:false,
    tts:false,
    keepAlive:true,
    volume:70
  },

  async load(){
    this.prefs.sound = await Store.getSetting('sound', true);
    this.prefs.vibrate = await Store.getSetting('vibrate', true);
    this.prefs.notifWanted = await Store.getSetting('notifWanted', false);
    this.prefs.highAlert = await Store.getSetting('highAlert', false);
    this.prefs.perfMode = await Store.getSetting('perfMode', 'balanced');

    this.prefs.voiceRecall = await Store.getSetting('voiceRecall', false);
    this.prefs.tts = await Store.getSetting('tts', false);
    this.prefs.keepAlive = await Store.getSetting('keepAlive', true);
    this.prefs.volume = await Store.getSetting('volume', 70);

    perfProfile = PERF_PROFILES[this.prefs.perfMode] || PERF_PROFILES.balanced;
    this._updateToggles();
    this._updatePerfUI();
    this._updateVolumeUI();
  },

  _updateToggles(){
    const ts=$('toggle-sound'), tv=$('toggle-vibrate'), tn=$('toggle-notif'), th=$('toggle-highalert');
    const tvr=$('toggle-voiceRecall'), tts=$('toggle-tts'), tka=$('toggle-keepAlive');

    if(ts) ts.classList.toggle('on', this.prefs.sound);
    if(tv) tv.classList.toggle('on', this.prefs.vibrate);
    if(tn) tn.classList.toggle('on', this.prefs.notifWanted && ('Notification' in window) && Notification.permission==='granted');
    if(th) th.classList.toggle('on', this.prefs.highAlert);

    if(tvr) tvr.classList.toggle('on', this.prefs.voiceRecall);
    if(tts) tts.classList.toggle('on', this.prefs.tts);
    if(tka) tka.classList.toggle('on', this.prefs.keepAlive);
  },

  _updatePerfUI(){
    document.querySelectorAll('.perf-opt').forEach(el=>el.classList.remove('active'));
    const id='perf-'+this.prefs.perfMode;
    if($(id)) $(id).classList.add('active');
  },

  _updateVolumeUI(){
    const v=clamp(parseInt(this.prefs.volume)||0,0,100);
    const sv=$('volumeSlider');
    const vv=$('volumeVal');
    if(sv) sv.value=v;
    if(vv) vv.textContent=v+'%';
    AudioEngine.setVolume01(v/100);
  },

  async toggle(key){
    this.prefs[key]=!this.prefs[key];
    await Store.saveSetting(key, this.prefs[key]);
    this._updateToggles();

    if(key==='highAlert') Toast.show(this.prefs.highAlert?'High Alert ON':'High Alert OFF');
    if(key==='keepAlive'){
      Toast.show(this.prefs.keepAlive?'Audio Keepalive ON':'Audio Keepalive OFF');
      if(this.prefs.keepAlive && App.monitoringWanted) AudioEngine.startKeepAlive();
      else AudioEngine.stopKeepAlive();
    }
    if(key==='sound' && !this.prefs.sound) AudioEngine.stopKeepAlive();
  },

  async toggleNotif(){
    if(!('Notification' in window)){ Toast.show('Notifications not supported'); return; }

    if(Notification.permission==='granted'){
      this.prefs.notifWanted=!this.prefs.notifWanted;
      await Store.saveSetting('notifWanted', this.prefs.notifWanted);
      this._updateToggles();
      return;
    }
    if(Notification.permission==='denied'){
      $('notif-hint').classList.remove('hidden');
      Toast.show('Denied. Enable in browser settings.');
      return;
    }

    // request on user gesture
    const result = await Notification.requestPermission();
    if(result==='granted'){
      this.prefs.notifWanted=true;
      await Store.saveSetting('notifWanted', true);
      Toast.show('Notifications enabled!');
    }else{
      $('notif-hint').classList.remove('hidden');
      Toast.show('Permission denied');
    }
    this._updateToggles();
  },

  async setPerf(mode){
    this.prefs.perfMode=mode;
    perfProfile = PERF_PROFILES[mode] || PERF_PROFILES.balanced;
    await Store.saveSetting('perfMode', mode);
    this._updatePerfUI();

    // Reset timers to apply new profile
    App.resetTimers();
    Toast.show('Performance: '+mode);
  },

  async setVolume(v){
    v=clamp(parseInt(v)||0,0,100);
    this.prefs.volume=v;
    await Store.saveSetting('volume', v);
    this._updateVolumeUI();
  },

  renderPetList(){
    const el=$('settings-pet-list');
    if(!App.pets.length){
      el.innerHTML='<div style="color:var(--text-muted);font-size:.82rem;padding:8px 0">No pets registered.</div>';
      return;
    }
    el.innerHTML = App.pets.map(p=>`
      <div class="setting-row">
        <div>
          <span style="font-size:1.2rem">${p.icon}</span> <strong>${p.name}</strong>
          <div style="font-size:.65rem;color:var(--text-muted)">ID: ${p.rescueId} | Added ${new Date(p.createdAt).toLocaleDateString()}</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="Settings.removePet('${p.id}')">Remove</button>
      </div>
    `).join('');
  },

  async removePet(id){
    if(!confirm('Remove this pet?')) return;
    await Store.deletePet(id);
    App.pets = App.pets.filter(p=>p.id!==id);
    App.render();
    this.renderPetList();
    Toast.show('Pet removed');
    if(!App.pets.length) BLE.stopScan();
  },

  resetApp(){
    if(!confirm('DELETE ALL VitalGuard AI DATA?')) return;
    if(!confirm('Are you sure? This cannot be undone.')) return;
    Store.clearAll();
    location.reload();
  }
};

/* ----------------------------- DATA MANAGER ----------------------------- */
const DataManager = {
  async exportAll(){
    const includeVoice = await Store.getBlob(VoiceRecall.key) ? confirm('Include Voice Recall audio in backup? (file will be larger)') : false;
    let voiceBase64=null;

    if(includeVoice){
      const blob=await Store.getBlob(VoiceRecall.key);
      if(blob){
        voiceBase64 = await new Promise(res=>{
          const fr=new FileReader();
          fr.onload=()=>res(fr.result);
          fr.onerror=()=>res(null);
          fr.readAsDataURL(blob);
        });
      }
    }

    const data={
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      exported:new Date().toISOString(),
      pets:App.pets.map(p=>p.toJSON()),
      settings:Settings.prefs,
      voiceRecall: voiceBase64 ? {included:true, dataUrl:voiceBase64} : {included:false}
    };

    const blob=new Blob([safeJson(data)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-2-backup-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Backup exported!');
  },

  importFile(){ $('import-input').click(); },

  async handleImport(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;

    try{
      const text=await file.text();
      const data=JSON.parse(text);
      if(!data.pets || !Array.isArray(data.pets)) throw new Error('Invalid backup');

      const merge = (App.pets.length>0) ? confirm('Merge with existing pets?\nCancel = Replace all') : true;

      if(!merge){
        App.pets=[];
        await Store.clearAll();
        await Store.init();
      }

      let imported=0;
      for(const pd of data.pets){
        if(App.pets.find(p=>p.id===pd.id)) continue;
        const pet=new Pet(pd);
        App.pets.push(pet);
        await Store.savePet(pet);
        imported++;
      }

      if(data.settings){
        // Import known settings only
        const keys=['sound','vibrate','notifWanted','highAlert','perfMode','voiceRecall','tts','keepAlive','volume'];
        for(const k of keys){
          if(k in data.settings){
            Settings.prefs[k]=data.settings[k];
            await Store.saveSetting(k, data.settings[k]);
          }
        }
        perfProfile = PERF_PROFILES[Settings.prefs.perfMode] || PERF_PROFILES.balanced;
        Settings._updateToggles();
        Settings._updatePerfUI();
        Settings._updateVolumeUI();
        App.resetTimers();
      }

      if(data.voiceRecall && data.voiceRecall.included && data.voiceRecall.dataUrl){
        // restore voice clip
        try{
          const parts=data.voiceRecall.dataUrl.split(',');
          const meta=parts[0]||'';
          const b64=parts[1]||'';
          const mime=(meta.match(/data:(.*?);base64/)||[])[1]||'audio/webm';
          const bin=atob(b64);
          const u8=new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
          const blob=new Blob([u8], {type:mime});
          await Store.saveBlob(VoiceRecall.key, blob);
        }catch(e){}
      }

      App.render();
      Toast.show(imported+' pet(s) imported');

    }catch(e){
      Toast.show('Import failed: '+(e.message||'unknown'));
    }

    ev.target.value='';
  }
};

/* ----------------------------- HELP (expanded) ----------------------------- */
/* ----------------------------- HELP (i18n) ----------------------------- */
const Help = {
  open(){
    try{
      if($('help-body')) $('help-body').innerHTML = this._content();
    }catch(e){}
    $('help-overlay').classList.add('active');
  },
  close(){
    $('help-overlay').classList.remove('active');
  },
  _content(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.help && (I18N.HTML.help[lang] || I18N.HTML.help.en)) || '';
  }
};

/* ----------------------------- ABOUT / LEGAL (i18n) ----------------------------- */
const Legal = {
  open(){
    try{
      if($('legal-body')) $('legal-body').innerHTML = this._content();
    }catch(e){}
    $('legal-overlay').classList.add('active');
  },
  close(){
    $('legal-overlay').classList.remove('active');
  },
  _content(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
  }
};

/* ----------------------------- DIAGNOSTICS (Download JSON) ----------------------------- */
const Diag = {
  open(){
    $('diag-overlay').classList.add('active');
    this.render();
  },
  close(){ $('diag-overlay').classList.remove('active'); },

  snapshot(){
    const now=nowMs();
    return {
      appVersion:APP_VERSION,
      schemaVersion:SCHEMA_VERSION,
      time:new Date().toISOString(),
      env:{
        ua:navigator.userAgent,
        protocol:location.protocol,
        secureContext: !!window.isSecureContext,
        bluetooth: !!navigator.bluetooth,
        leScan: !!(navigator.bluetooth && navigator.bluetooth.requestLEScan),
        notifications: ('Notification' in window)? Notification.permission : 'unsupported'
      },
      perfMode: Settings.prefs.perfMode,
      scan:{
        supported: BLE.supported,
        scanning: BLE.scanning,
        mode: BLE.lastScanMode,
        usingFilters: BLE.usingFilters,
        advPerSec: BLE.advPerSec,
        congestion: BLE.congestionLevel(),
        lastAnyAdvAgoMs: BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null,
        restartsInMinute: BLE.restartCount,
        lastRestartReason: BLE.lastRestartReason,
        stallCount: BLE.stallCount,
        lastErrorName: BLE.lastErrorName,
        lastErrorMessage: BLE.lastErrorMessage
      },
      monitoringWanted: App.monitoringWanted,
      trackMode: App.trackMode,
      focusPetId: App.focusPetId,
      pets: App.pets.map(p=>({
        id:p.id,
        name:p.name,
        rescueId:p.rescueId,
        zone:p.zone.stable,
        rssi:p.smoothedRssi,
        dist:p.distMeters,
        confidence:p.confidence,
        lastSeenAgoMs: p.lastSeenMs ? (now-p.lastSeenMs) : null,
        signatureStrength: p.signatureStrength(),
        ambiguousCount: p.ambiguousCount,
        batterySuspect: p.batterySuspect
      }))
    };
  },

  render(){
    const snap=this.snapshot();
    $('diag-body').innerHTML = `
      <div class="tip-card info">
        <div class="tip-title">Diagnostics Snapshot</div>
        <div class="tip-body">
          Use this for debugging scan issues, sharing with maintainers, or checking device compatibility.
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:10px 0">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.copy()">ğŸ“‹ Copy</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.download()">â¬‡ï¸ Download</button>
      </div>

      <pre id="diag-pre" style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4">${safeJson(snap)}</pre>

      <div class="tip-card warn">
        <div class="tip-title">Privacy Note</div>
        <div class="tip-body">
          This snapshot stays local unless you manually share it. It contains device info (user-agent) but no GPS history or cloud identifiers.
        </div>
      </div>
    `;
  },

  copy(){
    const text = $('diag-pre') ? $('diag-pre').textContent : safeJson(this.snapshot());
    navigator.clipboard.writeText(text).then(()=>Toast.show('Copied')).catch(()=>Toast.show('Copy blocked'));
  },

  download(){
    const snap=this.snapshot();
    const blob=new Blob([safeJson(snap)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-2-diagnostics-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Downloaded');
  }
};

/* ----------------------------- META-COGNITIVE COACH (Idea Amplifier) ----------------------------- */
const Coach = {
  lastRenderMs:0,

  compute(){
    const now=nowMs();
    const tips=[];

    // Environment
    if(location.protocol.startsWith('file')){
      tips.push('You are running from <span class="kbd">file://</span>. For best BLE reliability, use HTTPS/localhost or install as an app (ì•± ì„¤ì¹˜).');
    }
    if(!BLE.checkSupport()){
      tips.push('This browser may not support BLE scanning (Web Bluetooth LE Scan). Use Android Chrome, or Demo mode.');
    }

    // Scan health
    if(App.monitoringWanted && !BLE.scanning){
      tips.push('Monitoring is OFF. Tap <strong>Start Monitoring</strong>.');
      if(BLE.lastErrorName==='NotAllowedError') tips.push('Bluetooth permission was denied. Enable Bluetooth permission and retry.');
      if(BLE.lastErrorName==='SecurityError') tips.push('Secure context required. Use HTTPS/localhost.');
    }

    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);
      if(silent > perfProfile.scanStallMs*0.8){
        tips.push('Scan looks stalled. The watchdog will auto-restart if needed. Try keeping the screen on.');
      }
      const cong = BLE.congestionLevel();
      if(cong==='high'){
        tips.push('High BLE congestion detected. Use <strong>Focus</strong> mode to improve accuracy.');
      }
      if(!BLE.usingFilters){
        tips.push('No scan filters available (tags may have no name). Focus mode helps when multiple devices are nearby.');
      }
    }

    // Pet-specific hints
    for(const p of App.pets){
      if(p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000){
        tips.push(`<strong>${p.name}</strong>: Signal ambiguous. Tap pet card â†’ Re-verify Tag.`);
        break;
      }
      if(p.batterySuspect){
        tips.push(`<strong>${p.name}</strong>: Possible weak battery. Replace CR2032 and re-verify.`);
        break;
      }
    }

    return tips;
  },

  render(){
    const tips=this.compute();
    const card=$('coach-card');
    const body=$('coach-body');
    if(!card || !body) return;

    if(!tips.length){
      card.style.display='none';
      return;
    }

    body.innerHTML = `
      <ul style="margin-left:18px;line-height:1.6">
        ${tips.slice(0,6).map(t=>'<li>'+t+'</li>').join('')}
      </ul>
    `;
    card.style.display='block';
  }
};

/* ----------------------------- APP CORE ----------------------------- */
const App = {
  pets:[],
  trackMode:'all',
  focusPetId:null,
  demoMode:false,
  monitoringWanted:false,

  renderTimer:null,
  watchdogTimer:null,

  async init(){
    // First-run banner / context warning
    this.initFirstRunBanner();

    await Store.init();
    await Settings.load();
    await Emergency.load();

    // Apply volume early
    Settings._updateVolumeUI();

    // Load pets
    const petsData = await Store.getAllPets();
    this.pets = petsData.map(d=>new Pet(d));

    // Hide first-run banner once you already have pets (file:// first-run condition)
    if(location.protocol.startsWith('file') && this.pets.length>0){
      const b=$('first-run-banner');
      if(b) b.classList.add('hidden');
    }

    // Restore monitoring preference
    this.monitoringWanted = await Store.getSetting('monitoringWanted', false);

    this.render();

    // timers
    this.resetTimers();

    // PWA
    this.registerPWA();

    // install banner
    this.setupInstallBanner();

    // Attempt auto-start if wanted
    if(this.pets.length && this.monitoringWanted){
      // silent attempt; if user gesture is required, show banner + keep button
      await BLE.startScan('track', {silent:true});
      if(BLE.scanning){
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        // show coach guidance
        Coach.render();
      }
    }

    // Visibility resume
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible'){
        if(this.monitoringWanted && this.pets.length && !BLE.scanning && !this.demoMode){
          BLE.startScan('track', {silent:true});
        }
      }
    });

    // Safety: stop keepalive when leaving
    window.addEventListener('pagehide', ()=>{
      AudioEngine.stopKeepAlive();
    });

    Toast.show('VitalGuard AI v'+APP_VERSION+' ready');
  },

  initFirstRunBanner(){
    const banner=$('first-run-banner');
    if(!banner) return;
    const dismissed = localStorage.getItem(LS_PREFIX+'firstRunDismissed')==='1';
    const protoSpan=$('fr-proto');
    if(protoSpan) protoSpan.textContent=location.protocol;
    if(dismissed) return;

    // show when file:// OR insecure context
    if(location.protocol.startsWith('file') || !window.isSecureContext){
      banner.classList.remove('hidden');
    }
  },

  dismissFirstRun(){
    localStorage.setItem(LS_PREFIX+'firstRunDismissed','1');
    $('first-run-banner').classList.add('hidden');
  },

  resetTimers(){
    if(this.renderTimer) clearInterval(this.renderTimer);
    if(this.watchdogTimer) clearInterval(this.watchdogTimer);

    this.renderTimer=setInterval(()=>this.render(), perfProfile.renderInterval);
    this.watchdogTimer=setInterval(()=>this._watchdog(), 2000);
  },

  async toggleMonitoring(){
    if(this.demoMode){
      Toast.show('Demo mode is ON. Turn it off to use BLE monitoring.');
      return;
    }

    this.monitoringWanted = !this.monitoringWanted;
    await Store.saveSetting('monitoringWanted', this.monitoringWanted);

    if(this.monitoringWanted){
      const ok = await BLE.startScan('track');
      if(ok){
        Toast.show('Monitoring started');
        if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      }else{
        Toast.show('Could not start scanning (see Coach/Help)');
        this.monitoringWanted=false;
        await Store.saveSetting('monitoringWanted', false);
      }
    }else{
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      Toast.show('Monitoring stopped');
    }

    this.render();
    Coach.render();
  },

  async toggleDemo(){
    this.demoMode=!this.demoMode;
    if(this.demoMode){
      this.monitoringWanted=false;
      await Store.saveSetting('monitoringWanted', false);
      BLE.stopScan();
      AudioEngine.stopKeepAlive();
      this._startDemo();
      Toast.show('Demo mode ON');
    }else{
      this._stopDemo();
      Toast.show('Demo mode OFF');
    }
    this.render();
    Coach.render();
  },
  _startDemo(){
    if(this.demoTimer) clearInterval(this.demoTimer);
    // Initialize per-pet demo phases
    this.pets.forEach(p=>{ if(p._demoPhase===undefined) p._demoPhase=Math.random()*Math.PI*2; });
    this.demoTimer=setInterval(()=>this._demoTick(), 450);
  },

  _stopDemo(){
    if(this.demoTimer){ clearInterval(this.demoTimer); this.demoTimer=null; }
  },

  _demoTick(){
    const now=nowMs();
    // Simulated RSSI wave: shows zone transitions without BLE hardware.
    this.pets.forEach(p=>{
      const t=now/1000;
      const phase=p._demoPhase||0;
      const swing = 32*Math.abs(Math.sin((t+phase)/7)); // 0..32
      const noise = Math.random()*4;
      const rssi = -54 - swing - noise;

      if(now - p.lastProcessMs >= p.getMinInterval()){
        p.processRssi(rssi, now);
      }else{
        p.ingestRaw(rssi, now);
      }
    });

    if(SOS.targetPet) SOS.updateSnapshot(SOS.targetPet);
  },



  setTrackMode(mode){
    this.trackMode=mode;
    const allBtn=$('btn-mode-all'), focusBtn=$('btn-mode-focus');
    if(allBtn) allBtn.classList.toggle('btn-success', mode==='all');
    if(focusBtn) focusBtn.classList.toggle('btn-success', mode==='focus');

    if(mode==='all'){
      this.focusPetId=null;
      $('sos-focus-banner').classList.add('hidden');
      Toast.show('Tracking all pets');
    }else{
      Toast.show('Focus mode: tap a pet to focus');
    }
    this.renderPetChips();
  },

  addPet(pet){
    this.pets.push(pet);
    this.render();
    this.renderPetChips();
  },

  onAdvertisement(event){
    // Route to Wizard if open
    if(Wizard.isOpen()){
      Wizard.handleAdv(event);
      return;
    }

    const now=nowMs();

    // Global throttle (dynamic by mode + congestion)
    let throttle = perfProfile.globalThrottleMs;
    if(BLE.congestionLevel()==='high') throttle=Math.max(throttle, 120);
    if(BLE.usingFilters) throttle=Math.min(throttle, 90);

    if(now - globalLastProcessMs < throttle) return;
    globalLastProcessMs = now;

    // Route
    routeAdvertisement(event, this.pets, now);

    // SOS update
    if(SOS.targetPet){
      if(event.rssi && matchScore(event, SOS.targetPet.signature)>0.4){
        SOS.updateHC(event.rssi);
      }
      SOS.updateSnapshot(SOS.targetPet);
    }
  },

  async triggerAlert(pet){
    if(this.demoMode) return;
    // Audio / vibration
    if(Settings.prefs.sound) AudioEngine.alertForZone(pet.zone.stable);
    if(Settings.prefs.vibrate && navigator.vibrate){
      const z=pet.zone.stable;
      if(z==='CAUTION') navigator.vibrate([120,80,120]);
      else if(z==='WARNING') navigator.vibrate([160,80,160,80,220]);
      else if(z==='DANGER') navigator.vibrate([220,80,220,80,220,120,360]);
      else if(z==='LOST') navigator.vibrate([400,200,400,200,600]);
    }

    // Notifications
    if(Settings.prefs.notifWanted && 'Notification' in window && Notification.permission==='granted'){
      try{
        new Notification('VitalGuard AI: '+pet.name, {body:`${pet.zone.stable} â€” ~${pet.distMeters.toFixed(1)}m (approx)`});
      }catch(e){}
    }

    // TTS
    if(Settings.prefs.tts){
      VoiceAnnouncer.speak(VoiceAnnouncer.zoneMessage(pet));
    }
  },

  _watchdog(){
    const now=nowMs();

    // If scanning is on but silent for too long, restart
    if(BLE.scanning){
      const silent = now - (BLE.lastAnyAdvMs||0);

      if(silent > perfProfile.scanStallMs){
        BLE.stallCount++;
        BLE.restartScan('scan_stall');
      }

      // advPerSec should drop to 0 if silent
      if(silent > 2000) BLE.advPerSec=0;
    }

    // Pet LOST detection
    for(const p of this.pets){
      if(!p.lastSeenMs) continue;
      const silence = now - p.lastSeenMs;

      if(silence > perfProfile.lostMs){
        p.markLost(now);
      }
    }

    // Render coach occasionally
    Coach.render();
  },

  renderPetChips(){
    const row=$('pet-chips');
    if(!row) return;

    if(this.pets.length<=1){
      row.classList.add('hidden');
      row.innerHTML='';
      return;
    }

    row.classList.remove('hidden');
    row.innerHTML = this.pets.map(p=>{
      const active = (this.trackMode==='focus' && this.focusPetId===p.id);
      return `<div class="pet-chip ${active?'active':''}" onclick="App.focusFromChip('${p.id}')">${p.icon} ${p.name}</div>`;
    }).join('');
  },

  focusFromChip(id){
    if(this.trackMode!=='focus'){
      this.setTrackMode('focus');
    }
    this.focusPetId=id;
    Toast.show('Focus: '+(((this.pets.find(p=>p.id===id)||{}).name||'Pet')));
    this.renderPetChips();
    if(BLE.scanning && BLE.lastScanMode==='track') BLE.restartScan('focus_change');
    if(SOS.targetPet && SOS.targetPet.id===id) $('sos-focus-banner').classList.remove('hidden');
  },

  render(){
    // Empty vs dashboard
    const empty=$('empty-state');
    const dash=$('dash-controls');
    const dash2=$('dash-controls2');

    if(!this.pets.length){
      if(empty) empty.classList.remove('hidden');
      if(dash) dash.classList.add('hidden');
      if(dash2) dash2.classList.add('hidden');
      $('pet-list').innerHTML='';
      return;
    }else{
      if(empty) empty.classList.add('hidden');
      if(dash) dash.classList.remove('hidden');
      if(dash2) dash2.classList.remove('hidden');
    }

    // Buttons state
    const scanBtn=$('btn-scan-toggle');
    if(scanBtn){
      if(this.demoMode){
        scanBtn.textContent='â–¶ Start Monitoring';
        scanBtn.disabled=true;
        scanBtn.style.opacity='.6';
      }else{
        scanBtn.disabled=false;
        scanBtn.style.opacity='1';
        scanBtn.textContent = this.monitoringWanted ? 'â¹ Stop Monitoring' : 'â–¶ Start Monitoring';
      }
    }
    const demoBtn=$('btn-demo-toggle');
    if(demoBtn){
      demoBtn.textContent = this.demoMode ? 'ğŸ§ª Demo ON' : 'ğŸ§ª Demo';
      demoBtn.classList.toggle('btn-success', this.demoMode);
    }

    // Status bar
    const bar=$('scan-status-bar');
    const badge=$('congestionBadge');
    const now=nowMs();

    if(bar){
      if(this.demoMode){
        bar.textContent='ğŸ§ª Demo Mode â€” simulated data';
      }else if(BLE.scanning){
        const silent = BLE.lastAnyAdvMs ? (now-BLE.lastAnyAdvMs) : null;
        const modeTxt = BLE.usingFilters ? 'filters' : 'accept-all';
        bar.textContent=`ğŸ“¡ Scanning (${BLE.advPerSec} adv/s, ${modeTxt}) Â· last adv ${silent!==null?fmtAgo(silent):'--'} ago`;
      }else{
        bar.textContent='ğŸ“¡ Not scanning';
      }
    }

    if(badge){
      const lvl = this.demoMode ? 'low' : BLE.congestionLevel();
      badge.className='badge '+(lvl==='high'?'high':lvl==='med'?'med':'ok');
      badge.textContent = lvl.toUpperCase();
    }

    // Scan health bar
    const row=$('scan-health-row');
    if(row){
      if(this.demoMode || !BLE.scanning){
        row.classList.add('hidden');
      }else{
        row.classList.remove('hidden');
        const silent = BLE.lastAnyAdvMs ? (now - BLE.lastAnyAdvMs) : 999999;
        const ratio = clamp(1 - silent/perfProfile.scanStallMs, 0, 1);
        const fill=$('scan-health-fill');
        const meta=$('scan-health-meta');
        if(fill){
          fill.style.width=Math.round(ratio*100)+'%';
          fill.style.background = silent<2000 ? 'var(--accent-green)' : (silent<perfProfile.scanStallMs*0.7 ? 'var(--accent-yellow)' : 'var(--zone-danger)');
        }
        if(meta){
          meta.textContent = silent<999999 ? fmtAgo(silent)+' ago' : '--';
        }
      }
    }

    // Render pet chips
    this.renderPetChips();

    // Render pet list
    const list=$('pet-list');
    if(list){
      const now=nowMs();
      list.innerHTML = this.pets.map(p=>{
        const z=p.zone.stable.toLowerCase();
        const dotColor = 'var(--zone-'+z+')';
        const strength=p.signatureStrength();
        const weakSig = strength<=2;
        const amb = p.ambiguousCount>0 && (now-p.lastAmbiguousMs)<60000;

        return `
          <div class="pet-card zone-${z}" onclick="Detail.open('${p.id}')">
            <div class="pet-icon-circle">${p.icon}</div>
            <div class="pet-details">
              <div class="pet-name">${p.name}</div>
              <div class="pet-status-row">
                <span class="status-dot" style="background:${dotColor}"></span>
                <span>${p.zone.stable}</span>
                <span style="opacity:.55">Â·</span>
                <span>${p.getLastSeenText(now)}</span>
              </div>
              <div class="zone-badge ${z}">${p.zone.stable}</div>
              <div class="pet-conf">${p.confidence}% confidence Â· ~${p.distMeters.toFixed(1)}m</div>
              ${amb ? `<div class="pet-why">âš  Signal ambiguous â€” tap to re-verify</div>` :
                weakSig ? `<div class="pet-why">Tip: weak signature â€” Focus mode recommended</div>` :
                (p.batterySuspect ? `<div class="pet-why">ğŸ”‹ Battery suspected â€” replace CR2032</div>` :
                (p.whyText ? `<div class="pet-why">${p.whyText}</div>` : '')
              )}
            </div>
            <div class="pet-signal">
              <div class="pet-rssi" style="color:${dotColor}">
                ${p.lastRawRssi!==null ? Math.round(p.smoothedRssi) : '--'} dBm
                <span class="trend-arrow">${p.trendArrow}</span>
              </div>
              <div style="font-size:.62rem;color:var(--text-muted);margin-top:2px">${p.rescueId}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // SOS availability
    if(this.pets.length>0){
      $('sos-no-pets').classList.add('hidden');
      $('sos-content').classList.remove('hidden');
    }else{
      $('sos-no-pets').classList.remove('hidden');
      $('sos-content').classList.add('hidden');
    }
  },

  /* ----------------------------- PWA ----------------------------- */
  registerPWA(){
    if(!('serviceWorker' in navigator)) return;

    const manifest = {
      name: "VitalGuard AI v"+APP_VERSION,
      short_name: "VitalGuard AI",
      start_url: "./",
      display: "standalone",
      background_color: "#0d1117",
      theme_color: "#c0392b",
      description: "Lifeâ€‘Saving Offline AI Demo â€” Bluetooth proximity + tiny onâ€‘device AI (no cloud).",
      icons: [
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' rx='40' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='120'%3E%F0%9F%8E%85%3C/text%3E%3C/svg%3E", sizes:"192x192", type:"image/svg+xml"},
        {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512'%3E%3Crect width='512' height='512' rx='96' fill='%23c0392b'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='340'%3E%F0%9F%8E%85%3C/text%3E%3C/svg%3E", sizes:"512x512", type:"image/svg+xml"}
      ]
    };

    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('pwa-manifest');
    if(link) link.setAttribute('href', url);

    const swCode = `
      const CACHE='vitalguard-ai-v41-2-cache';
      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      });
      self.addEventListener('fetch', e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  },

  setupInstallBanner(){
    let deferredPrompt=null;
    const banner=$('installBanner');
    const btn=$('installBtn');
    const dismiss=$('installDismiss');
    const dismissed = localStorage.getItem(LS_PREFIX+'installDismissed')==='1';

    window.addEventListener('beforeinstallprompt', e=>{
      e.preventDefault();
      deferredPrompt=e;
      if(!dismissed && banner) banner.classList.add('active');
    });

    if(btn){
      btn.addEventListener('click', async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(()=>{});
        deferredPrompt=null;
        if(banner) banner.classList.remove('active');
      });
    }

    if(dismiss){
      dismiss.addEventListener('click', ()=>{
        localStorage.setItem(LS_PREFIX+'installDismissed','1');
        if(banner) banner.classList.remove('active');
      });
    }
  }
};


/* ============================================================
   V4.1 Upgrade Pack (VitalGuardAI)
   - Adds: Reset/Initialize center, ErrorShield, Conductor AI,
           AI Pack v4 (kNN + IsolationForestLite + RLS calibration),
           Encrypted backup (AES-GCM), Wake Lock for monitoring,
           Accessibility toggles, richer About & Social Impact deck.
   ============================================================ */

(function(){
  /* ----------------------------- SAFE TEXT / SANITIZER ----------------------------- */
  const Sanitizer = {
    // Remove risky characters while keeping names readable (prevents HTML injection from user input/import).
    name(s){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      s = s.replace(/[<>`]/g,'');
      if(!s) return 'My Pet';
      return s.slice(0, 28);
    },
    phone(s){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      // allow digits + + - space
      s = s.replace(/[^0-9+\-\s]/g,'');
      return s.slice(0, 24);
    },
    text(s, max=220){
      s = String((s===undefined||s===null)?'':s).replace(/[\u0000-\u001F\u007F]/g,'').trim();
      s = s.replace(/[<>`]/g,'');
      return s.slice(0, max);
    },
    icon(s){
      s = String((s===undefined||s===null)?'ğŸ¶':s);
      // allow only known icons (prevents weird glyphs breaking UI)
      return ICONS.includes(s) ? s : 'ğŸ¶';
    }
  };

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  function downloadText(filename, text, mime='text/plain'){
    const blob=new Blob([text], {type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2500);
  }

  /* ----------------------------- ERROR SHIELD (Crash-safe logging) ----------------------------- */
  const ErrorShield = {
    ring: new RingBuffer(36),
    loaded:false,
    persistTimer:null,
    lastCaptureAt:0,

    async load(){
      try{
        const saved = await Store.getAI('errors');
        if(saved && Array.isArray(saved.items)){
          saved.items.slice(-36).forEach(it=>this.ring.push(it));
        }
      }catch(e){}
      this.loaded=true;
    },

    _schedulePersist(){
      clearTimeout(this.persistTimer);
      this.persistTimer = setTimeout(async ()=>{
        try{
          await Store.saveAI('errors', {key:'errors', items:this.ring.data});
        }catch(e){}
      }, 1200);
    },

    capture(kind, info){
      const now = nowMs();
      // avoid loops
      if(now - this.lastCaptureAt < 60) return;
      this.lastCaptureAt = now;

      const entry = {
        t: new Date(now).toISOString(),
        kind,
        msg: Sanitizer.text((info && info.msg!=null)?info.msg:'unknown', 260),
        where: Sanitizer.text((info && info.where!=null)?info.where:'', 120),
        stack: Sanitizer.text((info && info.stack!=null)?info.stack:'', 700)
      };
      try{ this.ring.push(entry); }catch(e){}
      this._schedulePersist();
    },

    hook(){
      window.addEventListener('error', (e)=>{
        this.capture('error', {
          msg: e.message || 'window.error',
          where: (e.filename||'') + ':' + (e.lineno||0) + ':' + (e.colno||0),
          stack: e.error && e.error.stack ? e.error.stack : ''
        });
      });
      window.addEventListener('unhandledrejection', (e)=>{
        const r=e.reason;
        this.capture('promise', {
          msg: (r && (r.message||r.name)) ? (r.name? (r.name+': '+(r.message||'')) : r.message) : String(r),
          where: 'unhandledrejection',
          stack: (r && r.stack) ? r.stack : ''
        });
      });
    },

    clear(){
      this.ring.clear();
      Store.saveAI('errors', {key:'errors', items:[]}).catch(()=>{});
      Toast.show('Error log cleared');
      var d=$('diag-overlay'); if(d && d.classList.contains('active')) Diag.render();
    }
  };

  /* ----------------------------- CAPABILITY MATRIX ----------------------------- */
  const Capabilities = {
    async battery(){
      try{
        if(navigator.getBattery) return await navigator.getBattery();
      }catch(e){}
      return null;
    },
    computeSync(){
      const caps = {
        secureContext: !!window.isSecureContext,
        protocol: location.protocol,
        webBluetooth: !!navigator.bluetooth,
        leScan: !!(navigator.bluetooth && navigator.bluetooth.requestLEScan),
        advEvents: !!(navigator.bluetooth && navigator.bluetooth.addEventListener),
        serviceWorker: 'serviceWorker' in navigator,
        caches: 'caches' in window,
        wakeLock: !!(navigator.wakeLock && navigator.wakeLock.request),
        notification: 'Notification' in window,
        vibration: !!navigator.vibrate,
        share: !!navigator.share,
        clipboard: !!(navigator.clipboard && navigator.clipboard.writeText),
        geolocation: 'geolocation' in navigator,
        mediaDevices: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
        mediaRecorder: 'MediaRecorder' in window,
        tts: ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window)
      };
      return caps;
    },
    badgeHTML(ok){
      return ok ? '<span class="kbd" style="background:rgba(46,204,113,.14);border-color:rgba(46,204,113,.22);color:var(--accent-green)">OK</span>'
                : '<span class="kbd" style="background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.22);color:var(--accent-red)">NO</span>';
    },
    renderHTML(extra={}){
      const c = {...this.computeSync(), ...extra};
      const rows = [
        ['Secure context', c.secureContext],
        ['Web Bluetooth', c.webBluetooth],
        ['LE Scan API', c.leScan],
        ['Wake Lock', c.wakeLock],
        ['Service Worker', c.serviceWorker],
        ['Notifications', c.notification],
        ['Vibration', c.vibration],
        ['Share', c.share],
        ['Clipboard', c.clipboard],
        ['Geolocation', c.geolocation],
        ['Voice/TTS', c.tts],
        ['MediaRecorder', c.mediaRecorder],
      ];
      return `
        <div class="card" style="margin-top:10px">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">Device Capability Matrix</div>
          ${rows.map(r=>`
            <div class="setting-row" style="padding:10px 0">
              <span style="font-size:.78rem;color:var(--text-secondary)">${r[0]}</span>
              ${this.badgeHTML(!!r[1])}
            </div>
          `).join('')}
          <div style="margin-top:8px;font-size:.72rem;color:var(--text-muted)">
            Protocol: <span class="kbd">${Sanitizer.text(c.protocol, 18)}</span>
          </div>
        </div>
      `;
    }
  };

  /* ----------------------------- ACCESSIBILITY (UX) ----------------------------- */
  const Accessibility = {
    apply(){
      const root=document.documentElement;
      root.classList.toggle('a11y-large', !!Settings.prefs.largeText);
      root.classList.toggle('a11y-contrast', !!Settings.prefs.highContrast);
      root.classList.toggle('a11y-reduceMotion', !!Settings.prefs.reduceMotion);
    },
    injectCSS(){
      if(document.getElementById('v40-a11y-style')) return;
      const css = document.createElement('style');
      css.id='v40-a11y-style';
      css.textContent = `
        :root.a11y-large{ font-size: 18px; }
        :root.a11y-contrast{
          --bg-primary:#000;
          --bg-secondary:#060606;
          --bg-elevated:#0c0c0c;
          --text-primary:#fff;
          --text-secondary:#dcdcdc;
          --text-muted:#b5b5b5;
          --border-color: rgba(255,255,255,.18);
        }
        :root.a11y-reduceMotion *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
      `;
      document.head.appendChild(css);
    }
  };

  /* ----------------------------- WAKE LOCK (Monitoring keep-awake) ----------------------------- */
  const WakeLockManager = {
    lock:null,
    async request(){
      try{
        if(!Settings.prefs.screenAwake) return false;
        if(!(navigator.wakeLock && navigator.wakeLock.request)) return false;
        this.lock = await navigator.wakeLock.request('screen');
        this.lock.addEventListener('release', ()=>{ this.lock=null; });
        return true;
      }catch(e){
        this.lock=null;
        return false;
      }
    },
    async release(){
      try{
        if(this.lock){ await this.lock.release(); }
      }catch(e){}
      this.lock=null;
    },
    hookVisibility(){
      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState==='visible'){
          if(App.monitoringWanted && BLE.scanning && Settings.prefs.screenAwake){
            this.request();
          }
        }else{
          // don't force release; browser may auto-release anyway
        }
      });
    }
  };

  /* ----------------------------- AI PACK v4.1 ----------------------------- */

  // kNN classifier (personalized, learns from feedback)
  class KNNLite {
    constructor(k=5){
      this.k=k;
      this.samples=[]; // {x:number[], y:0|1}
    }
    _dist(a,b){
      let s=0;
      for(let i=0;i<a.length;i++){
        const d=(a[i]-b[i]);
        s+=d*d;
      }
      return Math.sqrt(s);
    }
    add(x,y){
      if(!Array.isArray(x) || x.length<3) return;
      this.samples.push({x:x.slice(0,8), y: y?1:0, t: nowMs()});
      if(this.samples.length>180) this.samples.shift();
    }
    predict(x){
      if(!Array.isArray(x) || this.samples.length<6) return {label:null, conf:0};
      const k=Math.min(this.k, this.samples.length);
      const sorted=this.samples
        .map(s=>({d:this._dist(x,s.x), y:s.y}))
        .sort((a,b)=>a.d-b.d)
        .slice(0,k);
      const sum=sorted.reduce((a,b)=>a+b.y,0);
      const p=sum/k;
      return {label: p>=0.5?1:0, conf: Math.round(Math.max(p,1-p)*100)};
    }
    export(){
      return {k:this.k, samples:this.samples.slice(-180)};
    }
    import(d){
      if(!d) return;
      this.k = typeof d.k==='number' ? d.k : this.k;
      if(Array.isArray(d.samples)) this.samples = d.samples.slice(-180);
    }
    reset(){
      this.samples=[];
    }
  }

  // RLS calibration for path-loss model: RSSI = a + b*log10(dist)
  class RLSCalibrator {
    constructor(){
      this.theta=[-59, -25]; // [a, b] where bâ‰ˆ-10n
      this.P=[[100,0],[0,100]];
      this.lambda=0.985;
      this.count=0;
    }
    update(dist, rssi){
      if(!dist || dist<=0 || !isFinite(dist) || !isFinite(rssi)) return;
      const x=[1, Math.log10(dist)];
      // P*x
      const Px=[this.P[0][0]*x[0]+this.P[0][1]*x[1], this.P[1][0]*x[0]+this.P[1][1]*x[1]];
      const denom = this.lambda + x[0]*Px[0] + x[1]*Px[1];
      const K=[Px[0]/denom, Px[1]/denom];
      const yHat = this.theta[0]*x[0] + this.theta[1]*x[1];
      const err = rssi - yHat;
      this.theta[0] += K[0]*err;
      this.theta[1] += K[1]*err;

      // P = (P - K*x^T*P)/lambda
      const xTP=[x[0]*this.P[0][0]+x[1]*this.P[1][0], x[0]*this.P[0][1]+x[1]*this.P[1][1]];
      const KP=[[K[0]*xTP[0], K[0]*xTP[1]],[K[1]*xTP[0], K[1]*xTP[1]]];
      this.P=[
        [(this.P[0][0]-KP[0][0])/this.lambda, (this.P[0][1]-KP[0][1])/this.lambda],
        [(this.P[1][0]-KP[1][0])/this.lambda, (this.P[1][1]-KP[1][1])/this.lambda]
      ];

      this.count++;
    }
    params(){
      // Convert to txPower & n (approx)
      const a=this.theta[0];
      const b=this.theta[1];
      const n = clamp(Math.abs(b)/10, 1.5, 4.5);
      const tx = clamp(a, -78, -40);
      return {txPower:tx, n:n, a:a, b:b, count:this.count};
    }
    export(){ return {theta:this.theta, P:this.P, lambda:this.lambda, count:this.count}; }
    import(d){
      if(!d) return;
      if(Array.isArray(d.theta) && d.theta.length===2) this.theta=[d.theta[0], d.theta[1]];
      if(Array.isArray(d.P) && d.P.length===2) this.P=d.P;
      if(typeof d.lambda==='number') this.lambda=d.lambda;
      this.count = d.count||0;
    }
    reset(){
      this.theta=[-59,-25];
      this.P=[[100,0],[0,100]];
      this.count=0;
    }
  }

  // Isolation Forest (lite, small dimensional) for anomaly scoring
  class IsolationForestLite {
    constructor(opts={}){
      this.trees=[];
      this.nTrees=opts.nTrees||10;
      this.sampleSize=opts.sampleSize||48;
      this.maxDepth=opts.maxDepth||8;
      this.trained=false;
      this.dim=opts.dim||5;
    }

    _randInt(n){ return Math.floor(Math.random()*n); }
    _harmonic(n){
      // approximation H(n) ~ ln(n) + gamma
      const gamma=0.5772156649;
      return Math.log(n) + gamma;
    }
    _c(n){
      if(n<=1) return 0;
      return 2*this._harmonic(n-1) - (2*(n-1)/n);
    }

    _buildTree(samples, depth){
      if(depth>=this.maxDepth || samples.length<=1){
        return {leaf:true, n:samples.length, depth};
      }
      const q=this._randInt(this.dim);
      let min=Infinity,max=-Infinity;
      for(const s of samples){
        const v=s[q];
        if(v<min) min=v;
        if(v>max) max=v;
      }
      if(!isFinite(min) || !isFinite(max) || min===max){
        return {leaf:true, n:samples.length, depth};
      }
      const split = min + Math.random()*(max-min);
      const left=[], right=[];
      for(const s of samples){
        (s[q] < split ? left : right).push(s);
      }
      return {leaf:false, q, split, left:this._buildTree(left, depth+1), right:this._buildTree(right, depth+1), depth};
    }

    train(data){
      if(!Array.isArray(data) || data.length<12) { this.trained=false; this.trees=[]; return; }
      // sample subset for each tree
      this.dim = data[0].length;
      this.trees=[];
      for(let i=0;i<this.nTrees;i++){
        const subset=[];
        for(let j=0;j<Math.min(this.sampleSize, data.length);j++){
          subset.push(data[this._randInt(data.length)]);
        }
        this.trees.push(this._buildTree(subset, 0));
      }
      this.trained=true;
    }

    _pathLen(x, node){
      if(!node || node.leaf){
        const n = node ? node.n : 1;
        // leaf adjustment
        return (node ? node.depth : 0) + this._c(n);
      }
      if(x[node.q] < node.split) return this._pathLen(x, node.left);
      return this._pathLen(x, node.right);
    }

    score(x){
      if(!this.trained || !this.trees.length) return 0.0;
      let sum=0;
      for(const t of this.trees) sum += this._pathLen(x, t);
      const Eh = sum/this.trees.length;
      const cn = this._c(this.sampleSize);
      const s = Math.pow(2, -Eh / (cn || 1));
      return clamp(s, 0, 1);
    }

    export(){
      // Keep it light: don't persist trees (huge). Persist only config.
      return {nTrees:this.nTrees, sampleSize:this.sampleSize, maxDepth:this.maxDepth, dim:this.dim, trained:false};
    }
    import(d){
      if(!d) return;
      if(typeof d.nTrees==='number') this.nTrees=d.nTrees;
      if(typeof d.sampleSize==='number') this.sampleSize=d.sampleSize;
      if(typeof d.maxDepth==='number') this.maxDepth=d.maxDepth;
      if(typeof d.dim==='number') this.dim=d.dim;
    }
    reset(){ this.trees=[]; this.trained=false; }
  }

  const AIPackV4 = {
    enabledDefault: true,

    attachPet(p){
      if(!p) return;
      p.aiToggles = Object.assign({knn:true, anomaly:true, rls:false}, p.aiToggles||{});
      if(!p.ai4){
        p.ai4 = {
          knn: new KNNLite(5),
          rls: new RLSCalibrator(),
          iso: new IsolationForestLite({nTrees:10, sampleSize:48, maxDepth:8, dim:5}),
          // safe baseline samples for training
          safeSamples: new RingBuffer(120),
          lastX: null,
          lastAnom: 0,
          lastKnn: {label:null, conf:0},
          lastTrainMs: 0
        };
      }
      // import persisted states if present
      try{
        const st = p.aiState || {};
        if(st.knn) p.ai4.knn.import(st.knn);
        if(st.rls) p.ai4.rls.import(st.rls);
        if(st.iso) p.ai4.iso.import(st.iso);
      }catch(e){}
    },

    featureVector(p, now){
      // Normalize into small [0..1]ish space for learning
      const rssi = clamp((p.smoothedRssi + 100)/70, 0, 1);                 // -100..-30
      const vel = clamp((p.kalman.getVelocity() + 10)/20, 0, 1);           // approx
      const f = p.behavior.getFeatures() || {variance:60, trend:0};
      const varN = clamp(f.variance/160, 0, 1);
      const trendN = clamp((f.trend + 12)/24, 0, 1);
      const silentN = clamp(((now - (p.lastSeenMs||now))/ (perfProfile.lostMs||9000)), 0, 1);
      return [rssi, vel, varN, trendN, silentN];
    },

    onPetProcessed(p, now){
      if(!p || !p.ai4) return;
      const x=this.featureVector(p, now);
      p.ai4.lastX = x;

      // Anomaly: train only on SAFE windows to learn baseline
      if(p.aiToggles.anomaly){
        if(p.zone.stable==='SAFE' && p.confidence>=50){
          p.ai4.safeSamples.push(x);
        }
        // retrain occasionally
        if(p.ai4.safeSamples.length>=30 && (now - p.ai4.lastTrainMs)>30000){
          try{
            p.ai4.iso.train(p.ai4.safeSamples.data);
            p.ai4.lastTrainMs=now;
          }catch(e){}
        }
        const a = p.ai4.iso.trained ? p.ai4.iso.score(x) : 0;
        // hybrid with heuristic when untrained
        const heuristic = clamp((Math.max(0, (-p.kalman.getVelocity())/6) + (((p.behavior.getFeatures && p.behavior.getFeatures())||{}).variance||60)/220)/2, 0, 1);
        p.ai4.lastAnom = p.ai4.iso.trained ? clamp((a*0.7 + heuristic*0.3),0,1) : heuristic;
      }

      // kNN prediction only when we have samples
      if(p.aiToggles.knn){
        p.ai4.lastKnn = p.ai4.knn.predict(x);
      }
    },

    learnFromFeedback(p, helpful){
      if(!p || !p.ai4 || !p.ai4.lastX) return;
      // label: 1 means "real danger (helpful)", 0 means "false alarm / safe"
      p.ai4.knn.add(p.ai4.lastX, helpful?1:0);
    },

    exportState(p){
      const st = p.aiState || {};
      if(p.ai4){
        st.knn = p.ai4.knn.export();
        st.rls = p.ai4.rls.export();
        st.iso = p.ai4.iso.export();
      }
      return st;
    },

    explain(p){
      if(!p || !p.ai4) return {anom:0, knn:null};
      return {
        anom: Math.round((p.ai4.lastAnom||0)*100),
        knn: (!p.ai4.lastKnn || p.ai4.lastKnn.label===null) ? null : {label:p.ai4.lastKnn.label, conf:p.ai4.lastKnn.conf}
      };
    }
  };

  /* ----------------------------- CONDUCTOR AI (Self-heal / UX suggestions) ----------------------------- */
  const ConductorAI = {
    enabled:true,
    lastTick:0,
    lastSuggest:0,
    safeMode:false,
    battery:null,
    lastBatteryAt:0,

    async init(){
      this.enabled = await Store.getSetting('autoOptimize', true);
      try{
        this.battery = await Capabilities.battery();
      }catch(e){ this.battery=null; }
    },

    async refreshBattery(){
      const now=nowMs();
      if(now - this.lastBatteryAt < 15000) return;
      this.lastBatteryAt=now;
      try{
        if(navigator.getBattery){
          this.battery = await navigator.getBattery();
        }
      }catch(e){}
    },

    batteryInfo(){
      const b=this.battery;
      if(!b) return null;
      return {
        level: (typeof b.level==='number') ? b.level : null,
        charging: !!b.charging
      };
    },

    compute(){
      const now=nowMs();
      const tips=[];
      const actions=[];

      // Environment guidance
      if(location.protocol.startsWith('file')){
        tips.push({k:'env_file', t:'Running from file:// can reduce BLE reliability. Use HTTPS/localhost or install as an app (ì•± ì„¤ì¹˜).'});
      }
      if(!window.isSecureContext && !location.hostname.includes('localhost')){
        tips.push({k:'env_secure', t:'Secure context required for reliable BLE. Use HTTPS/localhost.'});
      }

      // Scan health
      if(App.monitoringWanted && !BLE.scanning){
        tips.push({k:'scan_off', t:'Monitoring is OFF. Tap Start Monitoring.'});
      }
      if(BLE.scanning){
        const silent = now - (BLE.lastAnyAdvMs||0);
        if(silent > perfProfile.scanStallMs*0.9){
          tips.push({k:'scan_stall', t:'Scan looks stalled. The watchdog will try restart. Keep screen awake, or enable Audio Keepalive.'});
          if(!Settings.prefs.keepAlive) actions.push({label:'Enable Keepalive', fn:()=>Settings.toggle('keepAlive')});
          if(!Settings.prefs.screenAwake) actions.push({label:'Enable Screen Awake', fn:()=>Settings.toggleV40('screenAwake')});
        }
        if(BLE.congestionLevel()==='high'){
          tips.push({k:'scan_cong', t:'High BLE congestion. Use Focus mode on one pet for better accuracy.'});
          if(App.trackMode!=='focus') actions.push({label:'Switch to Focus', fn:()=>App.setTrackMode('focus')});
        }
      }

      // Battery / performance
      const bi=this.batteryInfo();
      if(bi && bi.level!==null){
        const pct=Math.round(bi.level*100);
        if(pct<=18 && App.monitoringWanted && Settings.prefs.perfMode!=='saver'){
          tips.push({k:'bat_low', t:`Battery is low (${pct}%). Consider Saver performance mode.`});
          actions.push({label:'Set Saver Mode', fn:()=>Settings.setPerf('saver')});
        }
      }

      // Pet-specific detection errors
      const troubled = App.pets.find(p=>p.ambiguousCount>0 && (now-(p.lastAmbiguousMs||0))<120000);
      if(troubled){
        tips.push({k:'ambig', t:`${troubled.name}: signal ambiguous. Re-verify tag near the phone to improve matching.`});
        actions.push({label:'Re-verify Tag', fn:()=>Wizard.open(troubled.id)});
      }

      // Safe mode suggestion
      if(BLE.stallCount>=3 || BLE.restartCount>=MAX_RESTARTS_PER_MIN){
        tips.push({k:'safe', t:'Frequent scan restarts detected. Consider Safe Mode (reduces CPU, increases stability).'});
        if(!this.safeMode) actions.push({label:'Enable Safe Mode', fn:()=>SafeMode.enable('scan_instability')});
      }

      return {tips, actions};
    },

    tick(){
      const now=nowMs();
      if(now - this.lastTick < 900) return;
      this.lastTick=now;
      if(!this.enabled) return;
      this.refreshBattery();
      // no auto-actions without consent; only suggestions
    }
  };

  const SafeMode = {
    active:false,
    reason:'',
    async enable(reason='manual'){
      if(this.active) return;
      this.active=true;
      this.reason=reason;
      await Store.saveSetting('safeMode', true);
      await Store.saveSetting('safeModeReason', reason);
      // apply conservative settings
      if(Settings.prefs.perfMode!=='saver') await Settings.setPerf('saver');
      // reduce motion can help old devices
      if(!Settings.prefs.reduceMotion){ Settings.prefs.reduceMotion=true; await Store.saveSetting('reduceMotion', true); }
      Accessibility.apply();
      V40UI.renderSafeBanner();
      Toast.show('Safe Mode enabled');
    },
    async disable(){
      this.active=false;
      this.reason='';
      await Store.saveSetting('safeMode', false);
      await Store.saveSetting('safeModeReason', '');
      V40UI.renderSafeBanner();
      Toast.show('Safe Mode disabled');
    },
    async load(){
      this.active = await Store.getSetting('safeMode', false);
      this.reason = await Store.getSetting('safeModeReason', '') || '';
    }
  };

  /* ----------------------------- RESET / INITIALIZE CENTER ----------------------------- */
  const ResetCenter = {
    ensureUI(){
      if($('reset-overlay')) return;
      const wrap=document.createElement('div');
      wrap.innerHTML = `
        <div id="reset-overlay" class="overlay">
          <div class="overlay-header">
            <div class="overlay-title">Reset / Initialize</div>
            <button class="overlay-close" onclick="ResetCenter.close()">âœ•</button>
          </div>
          <div class="overlay-body" id="reset-body"></div>
        </div>
      `;
      document.body.appendChild(wrap.firstElementChild);
    },

    open(){
      this.ensureUI();
      this.render();
      $('reset-overlay').classList.add('active');
    },
    close(){
      var ro=$('reset-overlay'); if(ro) ro.classList.remove('active');
    },

    async render(){
      const caps = Capabilities.computeSync();
      const pwaHint = caps.serviceWorker ? 'This may also clear app cache depending on option.' : 'Service Worker not supported here.';
      $('reset-body').innerHTML = `
        <div class="tip-card warn">
          <div class="tip-title">Reset Options (V4.1)</div>
          <div class="tip-body">
            Use this if you experience bugs, tag confusion, or you want to hand the phone to a new owner.
            <br><br>
            <strong>Reminder:</strong> VitalGuard AI stores data locally (IndexedDB/localStorage). No cloud sync.
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">1) Soft Reset (recommended first)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Clears temporary state: scan timers, recent errors, UI cache. Keeps pets, signatures, and calibration.
          </div>
          <button class="btn btn-secondary btn-block" style="margin-top:10px" onclick="ResetCenter.soft()">Soft Reset</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">2) Hard Reset (re-tag required)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Deletes pets, signatures, alerts, AI learning, and settings. You will need to re-add tags.
          </div>
          <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="ResetCenter.hard()">Hard Reset</button>
        </div>

        <div class="card">
          <div class="section-title" style="font-size:.8rem;margin:0 0 8px">3) Factory Reset (deep clean)</div>
          <div style="font-size:.78rem;color:var(--text-secondary);line-height:1.55">
            Hard Reset + clear Service Worker registrations and caches (best effort). ${pwaHint}
          </div>
          <button class="btn btn-danger-outline btn-block" style="margin-top:10px" onclick="ResetCenter.factory()">Factory Reset</button>
        </div>

        <div class="tip-card info">
          <div class="tip-title">Export before you wipe</div>
          <div class="tip-body">
            Tip: Go to Settings â†’ Backup to export your pets/signatures before hard reset.
          </div>
        </div>
      `;
    },

    async soft(){
      if(!confirm('Soft reset? (Keeps pets)')) return;
      try{
        // stop timers and restart scan cleanly
        BLE.stopScan();
        App.resetTimers();
        ErrorShield.clear();
        // clear minor UI settings
        await Store.saveSetting('lastTab', 'home');
        await Store.saveSetting('coachDismissed', false);
      }catch(e){}
      Toast.show('Soft reset done');
      this.close();
      // best effort: restart monitoring if it was wanted
      if(App.monitoringWanted) BLE.startScan('track', {silent:true});
    },

    async _confirmHard(){
      const msg = 'Type RESET to confirm (case-sensitive).';
      const v = prompt(msg, '');
      return v === 'RESET';
    },

    async hard(){
      if(!await this._confirmHard()) { Toast.show('Cancelled'); return; }
      try{
        BLE.stopScan();
        AudioEngine.stopKeepAlive();
        await WakeLockManager.release();
      }catch(e){}

      try{
        await Store.clearAll();
      }catch(e){}
      Toast.show('Hard reset complete');
      this.close();
      setTimeout(()=>location.reload(), 700);
    },

    async factory(){
      if(!await this._confirmHard()) { Toast.show('Cancelled'); return; }

      try{
        BLE.stopScan();
        AudioEngine.stopKeepAlive();
        await WakeLockManager.release();
      }catch(e){}

      try{
        await Store.clearAll();
      }catch(e){}

      // Best effort: unregister SW and delete caches
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
      }catch(e){}
      try{
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
      }catch(e){}

      // Best effort: delete our database (may fail if open)
      try{ indexedDB.deleteDatabase(DB_NAME); }catch(e){}

      Toast.show('Factory reset complete');
      this.close();
      setTimeout(()=>location.reload(), 900);
    }
  };

  /* ----------------------------- ENCRYPTED BACKUP (AES-GCM) ----------------------------- */
  const CryptoBox = {
    supported(){
      return !!(window.crypto && crypto.subtle && window.TextEncoder && window.TextDecoder);
    },
    _b64(u8){
      let s='';
      for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]);
      return btoa(s);
    },
    _u8(b64){
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return u8;
    },
    async _deriveKey(pass, salt){
      const enc=new TextEncoder();
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'},
        baseKey,
        {name:'AES-GCM', length:256},
        false,
        ['encrypt','decrypt']
      );
    },
    async encryptString(plain, pass){
      const enc=new TextEncoder();
      const salt=crypto.getRandomValues(new Uint8Array(16));
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const key=await this._deriveKey(pass, salt);
      const ct=await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plain));
      return {
        enc:true,
        v:1,
        alg:'AES-GCM',
        it:120000,
        salt:this._b64(salt),
        iv:this._b64(iv),
        ct:this._b64(new Uint8Array(ct))
      };
    },
    async decryptToString(pack, pass){
      const dec=new TextDecoder();
      const salt=this._u8(pack.salt);
      const iv=this._u8(pack.iv);
      const ct=this._u8(pack.ct);
      const key=await this._deriveKey(pass, salt);
      const pt=await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return dec.decode(pt);
    }
  };

  /* ----------------------------- V40 UI INJECTION ----------------------------- */
  const V40UI = {
    injected:false,

    inject(){
      if(this.injected) return;
      this.injected=true;

      Accessibility.injectCSS();
      ResetCenter.ensureUI();

      // Inject Advanced toggles card into Settings panel (UX)
      const panel=$('panel-settings');
      if(panel && !document.getElementById('v40-advanced-card')){
        const card=document.createElement('div');
        card.className='card';
        card.id='v40-advanced-card';
        card.innerHTML = `
          <div class="section-title" style="font-size:.8rem;margin-top:0">V4.1 Advanced</div>

          <div class="setting-row">
            <span style="font-size:.78rem">Screen Awake (Wake Lock)</span>
            <div class="toggle" id="toggle-screenAwake" onclick="Settings.toggleV40('screenAwake')"></div>
          </div>

          <div class="setting-row">
            <span style="font-size:.78rem">Use Scan Filters (less noise)</span>
            <div class="toggle" id="toggle-scanFilters" onclick="Settings.toggleV40('useScanFilters')"></div>
          </div>

          <div class="setting-row">
            <span style="font-size:.78rem">Auto Optimize (Conductor)</span>
            <div class="toggle" id="toggle-autoOptimize" onclick="Settings.toggleV40('autoOptimize')"></div>
          </div>

          <div class="divider"></div>

          <div class="section-title" style="font-size:.8rem;margin-top:0">Accessibility</div>

          <div class="setting-row">
            <span style="font-size:.78rem">Large Text</span>
            <div class="toggle" id="toggle-largeText" onclick="Settings.toggleV40('largeText')"></div>
          </div>
          <div class="setting-row">
            <span style="font-size:.78rem">High Contrast</span>
            <div class="toggle" id="toggle-highContrast" onclick="Settings.toggleV40('highContrast')"></div>
          </div>
          <div class="setting-row">
            <span style="font-size:.78rem">Reduce Motion</span>
            <div class="toggle" id="toggle-reduceMotion" onclick="Settings.toggleV40('reduceMotion')"></div>
          </div>

          <div class="divider"></div>

          <div class="section-title" style="font-size:.8rem;margin-top:0">Tools</div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-secondary btn-sm" onclick="ResetCenter.open()">ğŸ§¼ Reset / Initialize</button>
            <button class="btn btn-secondary btn-sm" onclick="V40UI.exportEncrypted()">ğŸ” Encrypted Backup</button>
            <button class="btn btn-secondary btn-sm" onclick="V40UI.showPitch()">ğŸ“Š Impact Deck</button>
          </div>

          <div id="v40-adv-hint" style="margin-top:10px;font-size:.72rem;color:var(--text-muted);line-height:1.45">
            Tip: Screen Awake helps prevent OS from pausing BLE scanning.
          </div>
        `;
        // place near bottom but before the "Guides" card if possible
        const guidesBtn = panel.querySelector('button[onclick="Help.open()"]');
        const guidesCard = guidesBtn ? guidesBtn.closest('.card') : null;
        panel.insertBefore(card, guidesCard || null);
      }

      this.renderSafeBanner();
    },

    renderSafeBanner(){
      // small banner in Home panel if safe mode
      const home=$('panel-home');
      if(!home) return;
      let banner=document.getElementById('safe-banner');
      if(!banner){
        banner=document.createElement('div');
        banner.id='safe-banner';
        banner.style.margin='10px 0';
        home.insertBefore(banner, (home.firstElementChild && home.firstElementChild.nextElementSibling) ? home.firstElementChild.nextElementSibling : null);
      }
      if(SafeMode.active){
        banner.innerHTML = `
          <div class="tip-card warn" style="margin:0">
            <div class="tip-title">ğŸ›¡ Safe Mode ON</div>
            <div class="tip-body">
              Stability-first settings are active ${SafeMode.reason?('('+Sanitizer.text(SafeMode.reason,60)+')'):''}.
              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn btn-secondary btn-sm" style="flex:1" onclick="SafeMode.disable()">Disable</button>
                <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.open()">Diagnostics</button>
              </div>
            </div>
          </div>
        `;
      }else{
        banner.innerHTML='';
      }
    },

    async exportEncrypted(){
      if(!CryptoBox.supported()){ Toast.show('WebCrypto not supported'); return; }
      const pass = prompt('Set a passphrase for encrypted backup (write it down).', '');
      if(!pass || pass.length<6){ Toast.show('Passphrase too short'); return; }

      // Use DataManager export structure
      const includeVoice = await Store.getBlob(VoiceRecall.key) ? confirm('Include Voice Recall audio? (larger file)') : false;
      let voiceBase64=null;

      if(includeVoice){
        const blob=await Store.getBlob(VoiceRecall.key);
        if(blob){
          voiceBase64 = await new Promise(res=>{
            const fr=new FileReader();
            fr.onload=()=>res(fr.result);
            fr.onerror=()=>res(null);
            fr.readAsDataURL(blob);
          });
        }
      }

      const data={
        appVersion:APP_VERSION,
        schemaVersion:SCHEMA_VERSION,
        exported:new Date().toISOString(),
        pets:App.pets.map(p=>p.toJSON()),
        settings:Settings.prefs,
        voiceRecall: voiceBase64 ? {included:true, dataUrl:voiceBase64} : {included:false}
      };

      try{
        const pack = await CryptoBox.encryptString(JSON.stringify(data), pass);
        downloadText('vitalguard-ai-v41-2-backup-encrypted-'+Date.now()+'.json', safeJson(pack), 'application/json');
        Toast.show('Encrypted backup exported');
      }catch(e){
        Toast.show('Encrypt failed');
      }
    },

    showPitch(){
      // open About & Legal directly on Impact tab
      try{
        Legal.open('impact');
      }catch(e){
        Legal.open();
      }
    }
  };

  /* ----------------------------- PATCH: Settings (new prefs + toggles) ----------------------------- */
  Settings.prefs = Object.assign({
    useScanFilters:true,
    screenAwake:false,
    autoOptimize:true,
    largeText:false,
    highContrast:false,
    reduceMotion:false
  }, Settings.prefs||{});

  const _settingsLoad = Settings.load.bind(Settings);
  Settings.load = async function(){
    await _settingsLoad();

    this.prefs.useScanFilters = await Store.getSetting('useScanFilters', true);
    this.prefs.screenAwake = await Store.getSetting('screenAwake', false);
    this.prefs.autoOptimize = await Store.getSetting('autoOptimize', true);
    this.prefs.largeText = await Store.getSetting('largeText', false);
    this.prefs.highContrast = await Store.getSetting('highContrast', false);
    this.prefs.reduceMotion = await Store.getSetting('reduceMotion', false);

    Accessibility.apply();
    this._updateToggles();
    this._updateTogglesV40();
  };

  Settings._updateTogglesV40 = function(){
    const t1=$('toggle-scanFilters');
    const t2=$('toggle-screenAwake');
    const t3=$('toggle-autoOptimize');
    const t4=$('toggle-largeText');
    const t5=$('toggle-highContrast');
    const t6=$('toggle-reduceMotion');
    if(t1) t1.classList.toggle('on', !!this.prefs.useScanFilters);
    if(t2) t2.classList.toggle('on', !!this.prefs.screenAwake);
    if(t3) t3.classList.toggle('on', !!this.prefs.autoOptimize);
    if(t4) t4.classList.toggle('on', !!this.prefs.largeText);
    if(t5) t5.classList.toggle('on', !!this.prefs.highContrast);
    if(t6) t6.classList.toggle('on', !!this.prefs.reduceMotion);
  };

  Settings.toggleV40 = async function(key){
    if(!(key in this.prefs)) return;
    this.prefs[key]=!this.prefs[key];
    await Store.saveSetting(key, this.prefs[key]);

    if(key==='useScanFilters'){
      Toast.show(this.prefs.useScanFilters?'Scan filters ON':'Scan filters OFF');
      // Apply immediately: restart scan (best effort)
      if(BLE.scanning) BLE.restartScan('toggle_filters');
    }
    if(key==='screenAwake'){
      Toast.show(this.prefs.screenAwake?'Screen Awake ON':'Screen Awake OFF');
      if(this.prefs.screenAwake && App.monitoringWanted && BLE.scanning) WakeLockManager.request();
      else WakeLockManager.release();
    }
    if(key==='autoOptimize'){
      Toast.show(this.prefs.autoOptimize?'Conductor ON':'Conductor OFF');
      ConductorAI.enabled=this.prefs.autoOptimize;
      await Store.saveSetting('autoOptimize', this.prefs.autoOptimize);
    }
    if(key==='largeText' || key==='highContrast' || key==='reduceMotion'){
      Accessibility.apply();
      Toast.show('Accessibility updated');
    }

    this._updateTogglesV40();
  };

  // Replace the old destructive Settings.resetApp with the reset center
  Settings.resetApp = function(){ ResetCenter.open(); };

  /* ----------------------------- PATCH: BLE filters toggle ----------------------------- */
  const _buildTrackFilters = BLE._buildTrackFilters.bind(BLE);
  BLE._buildTrackFilters = function(pets){
    if(Settings && Settings.prefs && Settings.prefs.useScanFilters===false) return null;
    return _buildTrackFilters(pets);
  };

  /* ----------------------------- PATCH: Pet AI attach + safe sanitize ----------------------------- */
  const _origPetToJSON = Pet.prototype.toJSON;
  Pet.prototype.toJSON = function(){
    const d=_origPetToJSON.call(this);
    d.name = Sanitizer.name(d.name);
    d.icon = Sanitizer.icon(d.icon);
    d.aiToggles = Object.assign({knn:true, anomaly:true, rls:false}, d.aiToggles||{});
    d.aiState = d.aiState || {};
    try{
      if(this.ai4){
        d.aiState.knn = this.ai4.knn.export();
        d.aiState.rls = this.ai4.rls.export();
        d.aiState.iso = this.ai4.iso.export();
      }
    }catch(e){}
    return d;
  };

  const _origProcess = Pet.prototype.processRssi;
  Pet.prototype.processRssi = function(rssi, now){
    _origProcess.call(this, rssi, now);
    try{
      AIPackV4.attachPet(this);
      AIPackV4.onPetProcessed(this, now);
    }catch(e){}
  };

  const _origMarkLost = Pet.prototype.markLost;
  Pet.prototype.markLost = function(now){
    _origMarkLost.call(this, now);
    try{
      AIPackV4.attachPet(this);
      AIPackV4.onPetProcessed(this, now);
    }catch(e){}
  };

  /* ----------------------------- PATCH: Detail feedback => kNN learning + extra explain ----------------------------- */
  const _origAiFeedback = Detail.aiFeedback.bind(Detail);
  Detail.aiFeedback = async function(helpful){
    try{
      if(this.pet){
        AIPackV4.attachPet(this.pet);
        AIPackV4.learnFromFeedback(this.pet, helpful);
        await Store.savePet(this.pet);
      }
    }catch(e){}
    return _origAiFeedback(helpful);
  };

  const _origDetailRender = Detail.render.bind(Detail);
  Detail.render = async function(){
    await _origDetailRender();

    const p=this.pet;
    if(!p) return;
    AIPackV4.attachPet(p);

    // Add V4 AI explain block under AI section (best effort)
    try{
      const explain=AIPackV4.explain(p);
      const aiSuggestion = document.getElementById('ai-suggestion');
      if(aiSuggestion){
        const box=document.createElement('div');
        box.className='tip-card info';
        box.style.marginTop='10px';
        const knnText = (explain.knn===null) ? 'kNN: learningâ€¦ (need feedback samples)'
          : (`kNN: <strong>${explain.knn.label? 'DANGER':'SAFE'}</strong> (${explain.knn.conf}% confidence)`);
        box.innerHTML = `
          <div class="tip-title">AI Explain (V4)</div>
          <div class="tip-body">
            Anomaly score: <strong>${explain.anom}%</strong><br>
            ${knnText}<br>
            <span style="color:var(--text-muted)">These are advisory signals. Primary logic remains hysteresis + Kalman smoothing.</span>
          </div>
        `;
        // Insert only once
        if(!document.getElementById('v40-ai-explain')){
          box.id='v40-ai-explain';
          aiSuggestion.parentElement.appendChild(box);
        }
      }
    }catch(e){}
  };

  /* ----------------------------- PATCH: Wizard + Emergency sanitize ----------------------------- */
  const _wizardSave = Wizard.save.bind(Wizard);
  Wizard.save = async function(){
    try{
      if($('input-name')) $('input-name').value = Sanitizer.name($('input-name').value||'');
      this.chosenIcon = Sanitizer.icon(this.chosenIcon);
    }catch(e){}
    return _wizardSave();
  };

  const _emgSaveFromUI = Emergency.saveFromUI.bind(Emergency);
  Emergency.saveFromUI = function(){
    try{
      if($('emg-name')) $('emg-name').value = Sanitizer.text($('emg-name').value||'', 50);
      if($('emg-phone')) $('emg-phone').value = Sanitizer.phone($('emg-phone').value||'');
      if($('emg-medical')) $('emg-medical').value = Sanitizer.text($('emg-medical').value||'', 220);
    }catch(e){}
    return _emgSaveFromUI();
  };

  /* ----------------------------- PATCH: App init / monitoring => wake lock + conductor + error shield ----------------------------- */
  const _appInit = App.init.bind(App);
  App.init = async function(){
    ErrorShield.hook();
    V40UI.inject();

    await _appInit();

    // Post-init loads
    try{ await ErrorShield.load(); }catch(e){}
    try{ await SafeMode.load(); }catch(e){}
    try{ await ConductorAI.init(); }catch(e){}
    try{ WakeLockManager.hookVisibility(); }catch(e){}

    // Upgrade pets with new AI + sanitize imported names/icons
    try{
      for(const p of this.pets){
        p.name = Sanitizer.name(p.name);
        p.icon = Sanitizer.icon(p.icon);
        AIPackV4.attachPet(p);
      }
    }catch(e){}

    Accessibility.apply();
    if(Settings._updateTogglesV40) Settings._updateTogglesV40();
    V40UI.renderSafeBanner();
  };

  const _toggleMonitoring = App.toggleMonitoring.bind(App);
  App.toggleMonitoring = async function(){
    const before = this.monitoringWanted;
    await _toggleMonitoring();
    const after = this.monitoringWanted;
    if(after && !before){
      // just turned on
      if(Settings.prefs.keepAlive) AudioEngine.startKeepAlive();
      if(Settings.prefs.screenAwake) WakeLockManager.request();
    }
    if(!after && before){
      await WakeLockManager.release();
    }
  };

  const _watchdog = App._watchdog.bind(App);
  App._watchdog = function(){
    try{ _watchdog(); }catch(e){}
    try{ ConductorAI.tick(); }catch(e){}
    // auto safe-mode trigger (best effort, non-destructive)
    try{
      if(!SafeMode.active && (BLE.stallCount>=4 || BLE.restartCount>=MAX_RESTARTS_PER_MIN+1)){
        SafeMode.enable('auto_scan_instability');
      }
    }catch(e){}
  };

  /* ----------------------------- PATCH: Diagnostics (capabilities + error log + battery) ----------------------------- */
  const _diagSnapshot = Diag.snapshot.bind(Diag);
  Diag.snapshot = function(){
    const s=_diagSnapshot();
    try{
      s.capabilities = Capabilities.computeSync();
      s.safeMode = {active:SafeMode.active, reason:SafeMode.reason};
      s.errors = ErrorShield.ring.data;
      const bi=ConductorAI.batteryInfo();
      if(bi) s.battery = bi;
    }catch(e){}
    return s;
  };

  Diag.render = function(){
    const snap=this.snapshot();
    const errs = (snap.errors||[]).slice(-12).reverse();
    $('diag-body').innerHTML = `
      <div class="tip-card info">
        <div class="tip-title">Diagnostics Snapshot (V4.1)</div>
        <div class="tip-body">
          Use this for debugging scan issues, checking device compatibility, or sharing with maintainers.
        </div>
      </div>

      <div style="display:flex;gap:8px;margin:10px 0">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.copy()">ğŸ“‹ Copy</button>
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="Diag.download()">â¬‡ï¸ Download</button>
      </div>

      ${Capabilities.renderHTML()}

      <div class="card" style="margin-top:10px">
        <div class="section-title" style="font-size:.8rem;margin:0 0 8px">Recent Errors</div>
        ${errs.length ? errs.map(e=>`
          <div style="border-top:1px solid var(--border-color);padding:10px 0;font-size:.72rem;color:var(--text-secondary);line-height:1.45">
            <div style="color:var(--text-muted)">${e.t} Â· <span class="kbd">${e.kind}</span></div>
            <div><strong>${e.msg}</strong></div>
            ${e.where?`<div style="color:var(--text-muted)">${e.where}</div>`:''}
          </div>
        `).join('') : `<div style="font-size:.75rem;color:var(--text-muted);padding:6px 0">No errors captured.</div>`}
        <button class="btn btn-secondary btn-sm" style="margin-top:10px;width:100%" onclick="ErrorShield.clear()">Clear Error Log</button>
      </div>

      <pre id="diag-pre" style="white-space:pre-wrap;background:var(--bg-elevated);padding:12px;border-radius:12px;border:1px solid var(--border-color);font-size:.72rem;color:var(--text-secondary);line-height:1.4;margin-top:10px">${safeJson(snap)}</pre>

      <div class="tip-card warn">
        <div class="tip-title">Privacy Note</div>
        <div class="tip-body">
          This snapshot stays local unless you manually share it. It contains device info (user-agent), but no cloud identifiers.
        </div>
      </div>
    `;
  };

  Diag.download = function(){
    const snap=this.snapshot();
    const blob=new Blob([safeJson(snap)], {type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='vitalguard-ai-v41-2-diagnostics-'+Date.now()+'.json';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('Downloaded');
  };

  /* ----------------------------- PATCH: Coach card (tips + one-tap actions) ----------------------------- */
  Coach.compute = function(){
    const {tips, actions} = ConductorAI.compute();
    // keep original small tips too (fallback)
    const baseTips=[];
    try{
      if(!BLE.checkSupport()){
        baseTips.push({k:'ble', t:'This browser may not support BLE scanning. Use Android Chrome or Demo mode.'});
      }
    }catch(e){}
    return {tips:[...baseTips, ...tips], actions};
  };

  Coach.render = function(){
    const res=this.compute();
    const tips=res.tips||[];
    const actions=res.actions||[];
    const card=$('coach-card');
    const body=$('coach-body');
    if(!card || !body) return;
    if(!tips.length && !actions.length){ card.style.display='none'; return; }

    body.innerHTML = `
      <ul style="margin-left:18px;line-height:1.6">
        ${tips.slice(0,6).map(t=>'<li>'+t.t+'</li>').join('')}
      </ul>
      ${actions.length ? `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          ${actions.slice(0,3).map((a,i)=>`<button class="btn btn-secondary btn-sm" onclick="(${a.fn.toString()})()">${a.label}</button>`).join('')}
        </div>
      `:''}
    `;
    card.style.display='block';
  };

    /* ----------------------------- PATCH: Legal / About (VitalGuard Demo) ----------------------------- */
  // Replace the previous social-impact deck with a diplomacyâ€‘friendly, lifeâ€‘saving demo explanation.
  Legal.open = function(){
    try{
      const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
      if($('legal-body')) $('legal-body').innerHTML = (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
    }catch(e){
      if($('legal-body')) $('legal-body').textContent = '';
    }
    $('legal-overlay').classList.add('active');
  };
  Legal._content = function(){
    const lang = (window.I18N && I18N.getLang) ? I18N.getLang() : 'en';
    return (I18N && I18N.HTML && I18N.HTML.legal && (I18N.HTML.legal[lang] || I18N.HTML.legal.en)) || '';
  };

  /* ----------------------------- PATCH: SOS snapshot sanitize ----------------------------- */
  const _sosUpdateSnapshot = SOS.updateSnapshot.bind(SOS);
  SOS.updateSnapshot = function(pet){
    try{
      if(pet){
        pet.name = Sanitizer.name(pet.name);
        pet.icon = Sanitizer.icon(pet.icon);
      }
    }catch(e){}
    return _sosUpdateSnapshot(pet);
  };

  /* ----------------------------- PATCH: Data import supports encrypted pack ----------------------------- */
  const _handleImport = DataManager.handleImport.bind(DataManager);
  DataManager.handleImport = async function(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;
    try{
      const text=await file.text();
      let data=JSON.parse(text);

      if(data && data.enc){
        if(!CryptoBox.supported()) throw new Error('Crypto not supported');
        const pass = prompt('Enter passphrase to decrypt this backup:', '');
        if(!pass) throw new Error('No passphrase');
        const plain = await CryptoBox.decryptToString(data, pass);
        data = JSON.parse(plain);
        // Build a fake event payload for original handler
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const f2 = new File([blob], 'decrypted-backup.json', {type:'application/json'});
        const ev2 = {target:{files:[f2]}};
        return _handleImport(ev2);
      }
    }catch(e){
      // fall through to normal handler
    }
    return _handleImport(ev);
  };

  
/* ----------------------------- V4.1 EXTRA PATCHES -----------------------------
   Goals:
   - Real scannable QR (handled earlier via Nayuki QR generator)
   - Calibration Pro (RLS) fully integrated (Wizard + Detail)
   - Rescue Pack share/import standardized in SOS panel (text/code/QR)
   - Per-pet alert preferences (sound/vibrate/voice + min zone)
   - Stability improvements: max 10 active pets, lost flip counter fix, better false-lost resistance
------------------------------------------------------------------------------- */

const V41_MAX_ACTIVE_PETS = 10;

const V41_DEFAULT_ALERT_PREFS = {
  sound: true,
  vibrate: true,
  tts: true,
  minZone: 'WARNING' // v4.1 default: reduce noise (no beep on CAUTION by default)
};

const V41_ZONE_RANK = { SAFE:0, CAUTION:1, WARNING:2, DANGER:3, LOST:4 };

function v41ZoneRank(z){ return V41_ZONE_RANK[z] ?? 0; }

function v41EnsureAlertPrefs(p){
  if(!p) return;
  if(!p.alertPrefs || typeof p.alertPrefs !== 'object') p.alertPrefs = {};
  for(const k of Object.keys(V41_DEFAULT_ALERT_PREFS)){
    if(p.alertPrefs[k] === undefined) p.alertPrefs[k] = V41_DEFAULT_ALERT_PREFS[k];
  }
  if(!(p.alertPrefs.minZone in V41_ZONE_RANK)) p.alertPrefs.minZone = 'WARNING';
}

/* -------- Lost flip counter fix (batterySuspect) -------- */
(function(){
  const WINDOW_MS_DEFAULT = 30 * 60 * 1000; // 30 minutes
  const _origMarkLost = Pet.prototype.markLost;
  const _origProcess = Pet.prototype.processRssi;

  Pet.prototype._v41PruneLostEvents = function(now){
    const windowMs = (Settings?.prefs?.batteryWindowMs ?? WINDOW_MS_DEFAULT);
    const arr = Array.isArray(this.lostEvents) ? this.lostEvents : [];
    this.lostEvents = arr.filter(t => (now - t) < windowMs);
    this.lostFlips = this.lostEvents.length;
    this.batterySuspect = (this.lostFlips >= 3);
  };

  Pet.prototype.markLost = function(now){
    if(this.disabled) return;
      // v4.1 walking/unstable guard: delay LOST a bit when the signal is fluctuating (reduces false LOST while walking)
      try{
        const stable = this.zone?.stable;
        const silence = now - (this.lastSeenMs || 0);
        const cls = this.behavior?.classify?.() || '';
        const extendMs = 12000;
        if(stable !== 'LOST' && stable !== 'DANGER' && (cls === 'moving_away' || cls === 'unstable')){
          if(silence < extendMs) return;
        }
      }catch(_){}

    const wasLost = (this.zone?.stable === 'LOST');
    _origMarkLost.call(this, now);
    if(!Array.isArray(this.lostEvents)) this.lostEvents = [];
    if(!wasLost && this.zone?.stable === 'LOST'){
      this.lostEvents.push(now);
    }
    this._v41PruneLostEvents(now);
  };

  Pet.prototype.processRssi = function(rssi, now){
    if(this.disabled) return;
    _origProcess.call(this, rssi, now);
    if(!Array.isArray(this.lostEvents)) this.lostEvents = [];
    this._v41PruneLostEvents(now);
  };
})();

/* -------- Per-pet alerts (sound/vibrate/tts + min zone) -------- */
(function(){
  const _origTrigger = App.triggerAlert.bind(App);
  App.triggerAlert = function(pet, from, to){
    try{
      if(!pet || pet.disabled) return;

      v41EnsureAlertPrefs(pet);
      const prefs = pet.alertPrefs || V41_DEFAULT_ALERT_PREFS;
      const minRank = v41ZoneRank(prefs.minZone || 'WARNING');
      if(v41ZoneRank(to) < minRank) return;

      const key = `${pet.id}:${from}->${to}`;
      const now = nowMs();
      const last = this._alertCooldown.get(key) || 0;
      if(now - last < ALERT_COOLDOWN_MS) return;
      this._alertCooldown.set(key, now);

      if(Settings.prefs.sound && prefs.sound) AudioEngine.alertForZone(to);
      if(Settings.prefs.vibrate && prefs.vibrate && navigator.vibrate) navigator.vibrate([200,120,200]);
      if(Settings.prefs.tts && prefs.tts) VoiceAnnouncer.say(`${pet.name} ${to.toLowerCase()}`);
    }catch(e){
      console.warn('v4.1 triggerAlert patch failed:', e);
      return _origTrigger(pet, from, to);
    }
  };
})();

/* -------- Max 10 active pets: enforce + disable overflow -------- */
(function(){
  const _origAddPet = App.addPet.bind(App);
  App.addPet = function(pet){
    try{
      if(!pet) return;
      const activeCount = this.pets.filter(p => !p.disabled).length;
      if(activeCount >= V41_MAX_ACTIVE_PETS){
        Toast.show(`Max ${V41_MAX_ACTIVE_PETS} active pets for stability. Disable/remove one first.`, 3200);
        return;
      }
      pet.disabled = false;
      v41EnsureAlertPrefs(pet);
      return _origAddPet(pet);
    }catch(e){
      console.warn('v4.1 addPet patch failed:', e);
      return _origAddPet(pet);
    }
  };
})();

/* -------- Leash distance slider (2mâ€“15m) in Detail -> auto thresholds -------- */
const V41UI = {};

V41UI._distanceToRssi = function(pet, meters){
  const tx = (pet?.distance?.txPower ?? -59);
  const n = (pet?.distance?.n ?? 2.5);
  return tx - 10 * n * Math.log10(Math.max(1, meters));
};

V41UI.applyMetersLeash = function(pet, meters){
  if(!pet) return;
  const m = Math.max(2, Math.min(15, Math.round(Number(meters)||10)));
  const warn = Math.round(this._distanceToRssi(pet, m));
  const caution = warn + 8;
  const danger = warn - 7;

  pet.thresholds = pet.thresholds || {...DEFAULT_THRESHOLDS};
  pet.thresholds.cautionEnter = caution;
  pet.thresholds.cautionExit  = caution + 5;
  pet.thresholds.warningEnter = warn;
  pet.thresholds.warningExit  = warn + 6;
  pet.thresholds.dangerEnter  = danger;
  pet.thresholds.dangerExit   = danger + 6;

  pet.leashPreset = 'custom'; // we still store exact thresholds
  pet.leashDistanceM = m;
  Store.savePet(pet);

  // update UI sliders + labels if present
  const ct = document.getElementById('custom-thresholds');
  if(ct){
    const labels = {
      'dt-caution': caution,
      'dt-warning': warn,
      'dt-danger': danger
    };
    for(const id in labels){
      const el = document.getElementById(id);
      if(el) el.textContent = `${labels[id]} dBm`;
    }
    // sliders are in order: caution, warning, danger (in the template)
    const sliders = ct.querySelectorAll('input[type="range"]');
    if(sliders && sliders.length >= 3){
      sliders[0].value = caution;
      sliders[1].value = warn;
      sliders[2].value = danger;
    }
  }
  Toast.show(`Leash distance set to ${m}m (auto thresholds).`, 1800);
};

V41UI.injectDetailMetersLeash = function(pet){
  try{
    if(!pet) return;
    v41EnsureAlertPrefs(pet);
    const host = document.getElementById('custom-thresholds');
    if(!host) return;
    if(document.getElementById('v41-meters-leash')) return;

    const m0 = pet.leashDistanceM || (pet.leashPreset && /^\d+m$/.test(pet.leashPreset) ? parseInt(pet.leashPreset,10) : 10);

    const box = document.createElement('div');
    box.id = 'v41-meters-leash';
    box.style.margin = '0 0 12px 0';
    box.innerHTML = `
      <div class="section-title" style="margin-top:0">Distance leash (2â€“15m)</div>
      <div style="font-size:.74rem;color:var(--text-muted);line-height:1.45;margin:-4px 0 10px 0">
        Sets thresholds from your calibration model (txPower / n). For best accuracy, run <b>Calibration Pro</b>.
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <input id="v41-leash-m" type="range" min="2" max="15" step="1" value="${m0}" style="flex:1" />
        <span class="kbd" id="v41-leash-m-label">${m0}m</span>
        <button class="btn btn-sm btn-secondary" id="v41-leash-apply">Apply</button>
      </div>
    `;
    host.prepend(box);

    const slider = box.querySelector('#v41-leash-m');
    const label = box.querySelector('#v41-leash-m-label');
    const applyBtn = box.querySelector('#v41-leash-apply');

    slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });
    applyBtn.addEventListener('click', ()=>{ V41UI.applyMetersLeash(pet, slider.value); });
  }catch(e){
    console.warn('injectDetailMetersLeash failed:', e);
  }
};

/* -------- Calibration Pro (RLS) UI (Wizard + Detail) -------- */
(function(){
  // Extend Wizard with Calibration Pro state
  Wizard._ensureCalibPro = function(){
    if(!this.calibPro || typeof this.calibPro !== 'object') this.calibPro = { points: [], rls: new RLSCalibrator() };
    if(!Array.isArray(this.calibPro.points)) this.calibPro.points = [];
    if(!this.calibPro.rls) this.calibPro.rls = new RLSCalibrator();
    return this.calibPro;
  };

  Wizard.clearCalibPro = function(){
    const cp = this._ensureCalibPro();
    cp.points = [];
    cp.rls.reset();
    Toast.show('Calibration Pro cleared.', 1600);
    this._refreshCalibModelUI();
    V41UI.renderWizardCalibPro();
  };

  Wizard.recordCalibPro = function(dist){
    const cand = this.selectedCandidate();
    if(!cand){
      Toast.show('Select your tag first.', 2000);
      return;
    }
    const d = Math.max(2, Math.min(15, Number(dist)||5));
    const rssi = cand.rssi;
    if(!Number.isFinite(rssi)){
      Toast.show('RSSI not ready. Wait a moment and try again.', 2200);
      return;
    }
    const cp = this._ensureCalibPro();
    cp.points.push({dist:d, rssi:rssi, t: nowMs()});
    cp.rls.update(d, rssi);
    Toast.show(`Pro sample saved: ${d}m @ ${rssi}dBm`, 1700);
    this._refreshCalibModelUI('pro');
    V41UI.renderWizardCalibPro();
  };

  Wizard._refreshCalibModelUI = function(force){
    const txEl = document.getElementById('calib-tx');
    const nEl = document.getElementById('calib-n');
    if(!txEl || !nEl) return;

    let tx = -59, n = 2.5;
    try{
      if(force === 'pro'){
        const cp = this._ensureCalibPro();
        if(cp.points.length >= 2){
          const p = cp.rls.params();
          tx = p.txPower;
          n = p.n;
        }
      }else{
        const tmp = new DistanceEstimator();
        if(this.calib['1m'] && Number.isFinite(this.calib['1m'].rssi)) tmp.addCalibration(this.calib['1m'].rssi, 1);
        if(this.calib['10m'] && Number.isFinite(this.calib['10m'].rssi)) tmp.addCalibration(this.calib['10m'].rssi, 10);
        tx = tmp.txPower;
        n = tmp.n;
      }
    }catch(e){}

    txEl.textContent = Math.round(tx);
    nEl.textContent = Number(n).toFixed(2);
  };

  // Patch Wizard.recordCalib to update model label in real-time
  const _wizRecord = Wizard.recordCalib.bind(Wizard);
  Wizard.recordCalib = function(dist){
    _wizRecord(dist);
    this._refreshCalibModelUI();
  };

  // Reset pro state when wizard resets
  const _wizReset = Wizard.reset.bind(Wizard);
  Wizard.reset = function(){
    _wizReset();
    this.calibPro = { points: [], rls: new RLSCalibrator() };
    this._refreshCalibModelUI();
    V41UI.renderWizardCalibPro();
  };

  // Override Wizard.save to apply Pro calibration cleanly
  const _wizSaveFallback = Wizard.save.bind(Wizard);
  Wizard.save = async function(){
    try{
      const cand = this.selectedCandidate();
      if(!cand){
        Toast.show('Select your tag first.', 2200);
        return;
      }

      // Stability guard: max active pets
      if(this.mode !== 'reverify'){
        const activeCount = App.pets.filter(p => !p.disabled).length;
        if(activeCount >= V41_MAX_ACTIVE_PETS){
          Toast.show(`Max ${V41_MAX_ACTIVE_PETS} active pets for stability. Disable/remove one first.`, 3200);
          return;
        }
      }

      // Sanitize inputs
      let name = ($('wiz-name').value || '').trim() || 'My Pet';
      name = name.replace(/[\n\r\t]+/g,' ').slice(0,24);
      let icon = ($('wiz-icon').value || 'ğŸ¶').trim() || 'ğŸ¶';
      if(icon.length > 2) icon = icon.slice(0,2);

      // Use the selected signature (Step 1 â†’ Select)
      const signature = this.selectedSig ? {...this.selectedSig} : null;
      if(!signature){
        Toast.show('Tag signature not ready. Select your tag again.', 2200);
        return;
      }

      let pet;
      if(this.mode === 'reverify' && this.petRef){
        pet = this.petRef;
        pet.name = name;
        pet.icon = icon;
        pet.signature = signature;
        pet.disabled = false;
      }else{
        pet = new Pet({ name, icon, signature });
        pet.disabled = false;
        v41EnsureAlertPrefs(pet);
        App.addPet(pet);
      }

      // Basic calibration points (1m, 10m)
      pet.distance = pet.distance || new DistanceEstimator();
      if(this.calib['1m'] && Number.isFinite(this.calib['1m'].rssi)) pet.distance.addCalibration(this.calib['1m'].rssi, 1);
      if(this.calib['10m'] && Number.isFinite(this.calib['10m'].rssi)) pet.distance.addCalibration(this.calib['10m'].rssi, 10);

      // Pro calibration (RLS): needs 3+ samples for stability
      const cp = this.calibPro;
      if(cp && Array.isArray(cp.points) && cp.points.length >= 3){
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(pet.ai4 && pet.ai4.rls){
          pet.ai4.rls.reset();
          cp.points.forEach(pt=>{
            if(Number.isFinite(pt.dist) && Number.isFinite(pt.rssi)) pet.ai4.rls.update(pt.dist, pt.rssi);
          });
          pet.aiToggles = pet.aiToggles || {};
          pet.aiToggles.rls = true;

          pet.aiState = pet.aiState || {};
          pet.aiState.rls = pet.ai4.rls.export();

          const params = pet.ai4.rls.params();
          pet.distance.txPower = params.txPower;
          pet.distance.n = params.n;

          // keep samples for reference (do not call addCalibration -> would re-fit using only last 2 points)
          pet.distance.calibPoints = Array.isArray(pet.distance.calibPoints) ? pet.distance.calibPoints : [];
          cp.points.forEach(pt=> pet.distance.calibPoints.push({dist:pt.dist, rssi:pt.rssi, pro:true, t:pt.t||nowMs()}));
        }
      }

      Store.savePet(pet);
      App.render();

      this.close();
      Toast.show('Saved!', 1500);
    }catch(e){
      console.warn('Wizard.save v4.1 failed; falling back.', e);
      return _wizSaveFallback();
    }
  };

  /* Wizard UI injection */
  V41UI.injectWizardCalibPro = function(){
    try{
      const step2 = document.getElementById('wizard-step-2');
      if(!step2) return;
      if(document.getElementById('v41-calibpro-wizard')) return;

      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'v41-calibpro-wizard';
      card.innerHTML = `
        <div class="section-title">Calibration Pro (RLS)</div>
        <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
          Optional: record multiple samples (2â€“15m). The model learns <b>txPower</b> & <b>n</b> for better distance accuracy.
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <input id="v41-calibpro-dist" type="range" min="2" max="15" step="1" value="5" style="flex:1" />
          <span class="kbd" id="v41-calibpro-dist-label">5m</span>
          <button class="btn btn-sm btn-secondary" id="v41-calibpro-record">Record</button>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-sm btn-secondary" style="flex:1" id="v41-calibpro-clear">Clear</button>
          <button class="btn btn-sm btn-primary" style="flex:1" id="v41-calibpro-preview">Use Pro model</button>
        </div>

        <div id="v41-calibpro-stats" style="margin-top:10px;font-size:.74rem;color:var(--text-secondary);line-height:1.45"></div>
        <div id="v41-calibpro-list" style="margin-top:8px;font-size:.72rem;color:var(--text-muted);max-height:90px;overflow:auto;border:1px solid var(--border-color);border-radius:10px;padding:8px;background:var(--bg-elevated)"></div>
      `;
      step2.appendChild(card);

      const slider = card.querySelector('#v41-calibpro-dist');
      const label = card.querySelector('#v41-calibpro-dist-label');

      slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });
      card.querySelector('#v41-calibpro-record').addEventListener('click', ()=>Wizard.recordCalibPro(Number(slider.value)));
      card.querySelector('#v41-calibpro-clear').addEventListener('click', ()=>Wizard.clearCalibPro());
      card.querySelector('#v41-calibpro-preview').addEventListener('click', ()=>{
        Wizard._refreshCalibModelUI('pro');
        Toast.show('Using Pro model for the preview. It will be applied on Save.', 1800);
      });

      V41UI.renderWizardCalibPro();
    }catch(e){
      console.warn('injectWizardCalibPro failed:', e);
    }
  };

  V41UI.renderWizardCalibPro = function(){
    const card = document.getElementById('v41-calibpro-wizard');
    if(!card) return;
    const stats = card.querySelector('#v41-calibpro-stats');
    const list = card.querySelector('#v41-calibpro-list');
    const cp = Wizard._ensureCalibPro();

    const pts = cp.points || [];
    if(pts.length === 0){
      stats.textContent = 'No samples yet. Tip: record 3â€“6 points (e.g., 2m, 5m, 10m).';
      list.textContent = 'â€”';
      return;
    }

    const params = cp.rls.params();
    stats.innerHTML = `
      Samples: <b>${pts.length}</b> Â· txPower: <b>${Math.round(params.txPower)}</b>dBm Â· n: <b>${params.n.toFixed(2)}</b>
      <div style="margin-top:6px;color:var(--text-muted)">Pro calibration is stored when you press <b>Save</b>.</div>
    `;

    list.innerHTML = pts.slice().reverse().map(pt=>{
      const t = pt.t ? new Date(pt.t).toLocaleTimeString() : '';
      return `<div style="display:flex;justify-content:space-between;gap:10px">
        <span>${pt.dist}m</span>
        <span>${pt.rssi}dBm</span>
        <span style="opacity:.7">${t}</span>
      </div>`;
    }).join('');
  };

  /* Detail UI injection */
  V41UI.injectDetailCalibPro = function(pet){
    try{
      if(!pet) return;
      const body = document.getElementById('detail-body');
      if(!body) return;
      if(document.getElementById('v41-calibpro-detail')) return;

      try{ AIPackV4.attachPet(pet); }catch(_){}

      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'v41-calibpro-detail';
      card.innerHTML = `
        <div class="section-title">Calibration Pro (RLS)</div>
        <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
          Record distance samples while standing still. The model updates <b>txPower</b> & <b>n</b> immediately.
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <input id="v41-dcalib-dist" type="range" min="2" max="15" step="1" value="5" style="flex:1" />
          <span class="kbd" id="v41-dcalib-dist-label">5m</span>
          <button class="btn btn-sm btn-secondary" id="v41-dcalib-record">Record</button>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-sm btn-secondary" style="flex:1" id="v41-dcalib-clear">Reset</button>
          <button class="btn btn-sm btn-primary" style="flex:1" id="v41-dcalib-apply-leash">Apply to leash</button>
        </div>

        <div id="v41-dcalib-stats" style="margin-top:10px;font-size:.74rem;color:var(--text-secondary);line-height:1.45"></div>
        <div id="v41-dcalib-list" style="margin-top:8px;font-size:.72rem;color:var(--text-muted);max-height:90px;overflow:auto;border:1px solid var(--border-color);border-radius:10px;padding:8px;background:var(--bg-elevated)"></div>
      `;

      // insert close to leash section if possible
      const anchor = Array.from(body.querySelectorAll('.card')).find(c => c.innerText.includes('Leash Presets')) || null;
      if(anchor && anchor.nextSibling) body.insertBefore(card, anchor.nextSibling);
      else body.appendChild(card);

      const slider = card.querySelector('#v41-dcalib-dist');
      const label = card.querySelector('#v41-dcalib-dist-label');
      slider.addEventListener('input', ()=>{ label.textContent = `${slider.value}m`; });

      const getRssi = ()=>{
        const arr = (pet.rssiRing && Array.isArray(pet.rssiRing.data)) ? pet.rssiRing.data.filter(v=>Number.isFinite(v)) : [];
        if(arr.length === 0) return pet.smoothedRssi;
        const tail = arr.slice(-8);
        tail.sort((a,b)=>a-b);
        const mid = Math.floor(tail.length/2);
        return tail.length%2 ? tail[mid] : Math.round((tail[mid-1]+tail[mid])/2);
      };

      const render = ()=>{
        const stats = card.querySelector('#v41-dcalib-stats');
        const list = card.querySelector('#v41-dcalib-list');

        const rls = pet.ai4?.rls;
        const pts = (pet.distance?.calibPoints || []).filter(pt => pt && pt.pro);
        if(!rls){
          stats.textContent = 'RLS calibrator not ready yet.';
          list.textContent = 'â€”';
          return;
        }
        const params = rls.params();
        stats.innerHTML = `
          Samples: <b>${pts.length}</b> Â· txPower: <b>${Math.round(params.txPower)}</b>dBm Â· n: <b>${params.n.toFixed(2)}</b>
          <div style="margin-top:6px;color:var(--text-muted)">Tip: record 3â€“6 points (2m, 5m, 10m). Then set leash distance slider.</div>
        `;
        list.innerHTML = (pts.slice().reverse().slice(0,12).map(pt=>{
          const t = pt.t ? new Date(pt.t).toLocaleTimeString() : '';
          return `<div style="display:flex;justify-content:space-between;gap:10px">
            <span>${pt.dist}m</span><span>${pt.rssi}dBm</span><span style="opacity:.7">${t}</span>
          </div>`;
        }).join('')) || 'â€”';
      };

      card.querySelector('#v41-dcalib-record').addEventListener('click', ()=>{
        const rssi = getRssi();
        if(!Number.isFinite(rssi)){
          Toast.show('RSSI not ready. Start monitoring first.', 2200);
          return;
        }
        const d = Number(slider.value);
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(!pet.ai4?.rls){
          Toast.show('RLS calibrator not ready.', 2000);
          return;
        }
        pet.ai4.rls.update(d, rssi);
        pet.aiToggles = pet.aiToggles || {};
        pet.aiToggles.rls = true;

        pet.aiState = pet.aiState || {};
        pet.aiState.rls = pet.ai4.rls.export();

        const params = pet.ai4.rls.params();
        pet.distance.txPower = params.txPower;
        pet.distance.n = params.n;

        pet.distance.calibPoints = Array.isArray(pet.distance.calibPoints) ? pet.distance.calibPoints : [];
        pet.distance.calibPoints.push({dist:d, rssi:rssi, pro:true, t: nowMs()});

        Store.savePet(pet);
        Toast.show(`Saved: ${d}m @ ${rssi}dBm`, 1600);

        render();
      });

      card.querySelector('#v41-dcalib-clear').addEventListener('click', ()=>{
        try{ AIPackV4.attachPet(pet); }catch(_){}
        if(pet.ai4?.rls){
          pet.ai4.rls.reset();
          pet.aiState = pet.aiState || {};
          pet.aiState.rls = pet.ai4.rls.export();
        }
        if(pet.distance?.calibPoints) pet.distance.calibPoints = pet.distance.calibPoints.filter(pt => !pt.pro);
        Store.savePet(pet);
        Toast.show('Calibration Pro reset.', 1600);
        render();
      });

      card.querySelector('#v41-dcalib-apply-leash').addEventListener('click', ()=>{
        const m = pet.leashDistanceM || 10;
        V41UI.applyMetersLeash(pet, m);
        render();
      });

      render();
    }catch(e){
      console.warn('injectDetailCalibPro failed:', e);
    }
  };
})();

/* -------- Per-pet alerts UI in Detail -------- */
V41UI.injectDetailAlertPrefs = function(pet){
  try{
    if(!pet) return;
    const body = document.getElementById('detail-body');
    if(!body) return;
    if(document.getElementById('v41-alertprefs-detail')) return;

    v41EnsureAlertPrefs(pet);
    const prefs = pet.alertPrefs;

    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'v41-alertprefs-detail';
    card.innerHTML = `
      <div class="section-title">Alerts (per pet)</div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Alarm sound</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Works only when global <b>Sound</b> is enabled.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-sound" ${prefs.sound ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Vibrate</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Uses global Vibrate setting as master switch.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-vibrate" ${prefs.vibrate ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row">
        <div>
          <div style="font-weight:700">Voice</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">Uses global Voice/TTS as master switch.</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="v41-ap-tts" ${prefs.tts ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-row" style="align-items:flex-start">
        <div>
          <div style="font-weight:700">Alert starts at</div>
          <div style="font-size:.72rem;color:var(--text-muted);line-height:1.4">
            Recommended: <b>WARNING</b> for â€œout of rangeâ€. Use CAUTION if you want early beeps.
          </div>
        </div>
        <select id="v41-ap-minzone" class="input" style="max-width:160px">
          <option value="CAUTION">CAUTION</option>
          <option value="WARNING">WARNING</option>
          <option value="DANGER">DANGER</option>
          <option value="LOST">LOST</option>
        </select>
      </div>
    `;

    const anchor = Array.from(body.querySelectorAll('.card')).find(c => c.innerText.includes('Leash Presets')) || null;
    if(anchor && anchor.nextSibling) body.insertBefore(card, anchor.nextSibling);
    else body.appendChild(card);

    const sel = card.querySelector('#v41-ap-minzone');
    sel.value = prefs.minZone || 'WARNING';

    const save = ()=>{
      Store.savePet(pet);
      Toast.show('Alert settings saved.', 1200);
    };

    card.querySelector('#v41-ap-sound').addEventListener('change', (e)=>{ pet.alertPrefs.sound = e.target.checked; save(); });
    card.querySelector('#v41-ap-vibrate').addEventListener('change', (e)=>{ pet.alertPrefs.vibrate = e.target.checked; save(); });
    card.querySelector('#v41-ap-tts').addEventListener('change', (e)=>{ pet.alertPrefs.tts = e.target.checked; save(); });
    sel.addEventListener('change', (e)=>{ pet.alertPrefs.minZone = e.target.value; save(); });
  }catch(e){
    console.warn('injectDetailAlertPrefs failed:', e);
  }
};

/* -------- Rescue Pack (share/import) for SOS panel -------- */
(function(){
  function b64urlEncodeUtf8(str){
    const u8 = new TextEncoder().encode(str);
    let bin = '';
    const chunk = 0x8000;
    for(let i=0;i<u8.length;i+=chunk){
      bin += String.fromCharCode(...u8.subarray(i, i+chunk));
    }
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  function b64urlDecodeUtf8(b64){
    let s = b64.replace(/-/g,'+').replace(/_/g,'/');
    const pad = s.length % 4;
    if(pad) s += '='.repeat(4-pad);
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(u8);
  }

  // Small CRC32 for paste/typing integrity
  const CRC32_TABLE = (function(){
    const table = new Uint32Array(256);
    for(let i=0;i<256;i++){
      let c = i;
      for(let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
      table[i] = c >>> 0;
    }
    return table;
  })();

  function crc32(str){
    const u8 = new TextEncoder().encode(str);
    let c = 0xFFFFFFFF;
    for(const b of u8){
      c = CRC32_TABLE[(c ^ b) & 0xFF] ^ (c >>> 8);
    }
    return (c ^ 0xFFFFFFFF) >>> 0;
  }

  function crcHex(u32){ return u32.toString(16).padStart(8,'0'); }

  SOS.buildRescuePack = function(pet){
    if(!pet) return null;

    const sig = pet.signature || {};
    const pack = {
      v: 1,
      t: nowMs(),
      e: nowMs() + (72 * 60 * 60 * 1000), // expires in 72h
      p: {
        n: pet.name,
        i: pet.icon,
        r: pet.rescueId
      },
      s: {
        ne: sig.nameExact || null,
        np: sig.namePrefix || null,
        mi: sig.manufacturerId || null,
        mf: sig.manufacturerDataPrefixHex || null,
        sv: Array.isArray(sig.serviceUuids) ? sig.serviceUuids.slice(0,6) : [],
        ap: (sig.appearance ?? null)
      }
    };

    // optional: include last saved location (if any)
    if(SOS.savedLocation && SOS.savedLocation.lat && SOS.savedLocation.lon){
      pack.l = { la: SOS.savedLocation.lat, lo: SOS.savedLocation.lon, ts: SOS.savedLocation.ts || nowMs() };
    }
    return pack;
  };

  SOS.encodeRescuePack = function(pack){
    const json = safeJson(pack);
    const crc = crcHex(crc32(json));
    return `VG-RP1.${b64urlEncodeUtf8(json)}.${crc}`;
  };

  SOS.decodeRescuePack = function(code){
    if(!code || typeof code !== 'string') throw new Error('Empty code');
    const txt = code.trim();
    if(!txt.startsWith('VG-RP1.')) throw new Error('Not a Rescue Pack (VG-RP1)');
    const parts = txt.split('.');
    if(parts.length < 3) throw new Error('Invalid code format');
    const b64 = parts[1];
    const crc = (parts[2] || '').toLowerCase();
    const json = b64urlDecodeUtf8(b64);
    const want = crcHex(crc32(json));
    if(crc && crc !== want) throw new Error('Checksum mismatch (code may be corrupted)');
    const pack = safeParseJson(json);
    if(!pack || pack.v !== 1) throw new Error('Unsupported pack version');
    return pack;
  };

  SOS._assist = { active:false, pet:null, pack:null, lastMatch:0 };

  SOS.startRescueAssist = function(code){
    try{
      const pack = SOS.decodeRescuePack(code);
      const sig = pack.s || {};
      const signature = {
        deviceId: null,
        nameExact: sig.ne || null,
        namePrefix: sig.np || null,
        manufacturerDataPrefixHex: sig.mf || null,
        manufacturerId: sig.mi || null,
        serviceUuids: sig.sv || [],
        appearance: (sig.ap ?? null)
      };

      const pet = new Pet({
        name: (pack.p?.n || 'Rescue Target'),
        icon: (pack.p?.i || 'ğŸ¾'),
        rescueId: (pack.p?.r || 'UNKNOWN'),
        signature
      });
      pet.disabled = false; // it is not in App.pets; but keep consistent
      v41EnsureAlertPrefs(pet);
      pet.alertPrefs.sound = false; // helpers: silent by default (use HOT/COLD UI)
      pet.alertPrefs.vibrate = true;
      pet.alertPrefs.tts = false;
      pet.alertPrefs.minZone = 'WARNING';

      SOS._assist = { active:true, pet, pack, lastMatch:0 };
      Toast.show('Rescue Assist started. Keep monitoring on and walk around.', 2600);

      // Restart scan so filters include assist prefix when possible
      try{
        if(BLE.scanning){
          BLE.stopScan();
          setTimeout(()=>BLE.startScan('track', {silent:true}), 250);
        }else{
          BLE.startScan('track', {silent:false});
        }
      }catch(_){}

      V41UI.renderRescueAssist();
    }catch(e){
      Toast.show(`Import failed: ${e.message}`, 2600);
    }
  };

  SOS.stopRescueAssist = function(){
    SOS._assist = { active:false, pet:null, pack:null, lastMatch:0 };
    Toast.show('Rescue Assist stopped.', 1600);
    V41UI.renderRescueAssist();
  };

  SOS._handleAssistAdv = function(ev){
    try{
      if(!SOS._assist.active || !SOS._assist.pet) return;
      const s = matchScore(ev, SOS._assist.pet.signature);
      if(s < 0.48) return;

      SOS._assist.lastMatch = nowMs();
      SOS._assist.pet.processRssi(ev.rssi, nowMs());
    }catch(e){}
  };

  // Patch App.onAdvertisement to also update Rescue Assist
  const _origOnAdv = App.onAdvertisement.bind(App);
  App.onAdvertisement = function(ev){
    _origOnAdv(ev);
    SOS._handleAssistAdv(ev);
    V41UI.renderRescueAssistMini(); // lightweight
  };

  // Patch BLE filter builder to include assist namePrefix (if present)
  const _origBuild = BLE._buildTrackFilters.bind(BLE);
  BLE._buildTrackFilters = function(){
    const filters = _origBuild();
    try{
      if(!Settings.prefs.useScanFilters) return null;
      const ap = SOS._assist?.active && SOS._assist.pet?.signature?.namePrefix ? SOS._assist.pet.signature.namePrefix : null;
      if(!ap || ap.length < 2) return filters;
      const f = Array.isArray(filters) ? filters.slice() : (filters ? [filters] : []);
      if(!f.some(x=>x.namePrefix === ap)){
        f.push({namePrefix: ap});
      }
      return f.length ? f.slice(0,5) : null;
    }catch(e){
      return filters;
    }
  };

  V41UI.injectSOSRescuePack = function(){
    const panel = document.getElementById('panel-sos');
    if(!panel) return;
    if(document.getElementById('v41-rescuepack-card')) return;

    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'v41-rescuepack-card';
    card.innerHTML = `
      <div class="section-title">Rescue Pack (code / QR)</div>
      <div style="font-size:.76rem;color:var(--text-muted);line-height:1.45">
        Share this to helpers. They can import it to scan for your tag signature on their device.
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-sm btn-secondary" id="v41-rp-generate" style="flex:1;min-width:150px">Generate for selected pet</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-share" style="flex:1;min-width:120px">Share</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-copy" style="flex:1;min-width:120px">Copy</button>
        <button class="btn btn-sm btn-secondary" id="v41-rp-sms" style="flex:1;min-width:120px">SMS</button>
      </div>

      <textarea id="v41-rp-code" class="input" style="margin-top:10px;height:88px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:.72rem" placeholder="Rescue Pack code appears here..."></textarea>

      <div style="display:flex;gap:12px;align-items:flex-start;margin-top:10px">
        <canvas id="v41-rp-qr" width="220" height="220" style="border:1px solid var(--border-color);border-radius:12px;background:#fff"></canvas>
        <div style="flex:1">
          <div class="section-title" style="margin-top:0">Import to help others</div>
          <div style="font-size:.74rem;color:var(--text-muted);line-height:1.45;margin:-4px 0 8px 0">
            Paste a Rescue Pack code and start <b>Rescue Assist</b>.
          </div>
          <textarea id="v41-rp-import" class="input" style="height:74px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:.72rem" placeholder="Paste code..."></textarea>
          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-sm btn-primary" id="v41-rp-start" style="flex:1">Start Assist</button>
            <button class="btn btn-sm btn-secondary" id="v41-rp-stop" style="flex:1">Stop</button>
          </div>
        </div>
      </div>

      <div id="v41-rp-assist" class="highlight-box" style="margin-top:12px;display:none"></div>
    `;

    // Insert right after the first SOS card (Rescue Broadcast)
    const cards = panel.querySelectorAll('.card');
    if(cards && cards.length > 0) panel.insertBefore(card, cards[1] || null);
    else panel.appendChild(card);

    const codeEl = card.querySelector('#v41-rp-code');
    const qrCanvas = card.querySelector('#v41-rp-qr');

    const generate = ()=>{
      const pet = SOS.selectedPet();
      if(!pet){
        Toast.show('No pet selected.', 2000);
        return;
      }
      const pack = SOS.buildRescuePack(pet);
      const code = SOS.encodeRescuePack(pack);
      codeEl.value = code;
      QRGenerator.generate(code, qrCanvas, 220, {ecc:'M', border:4});
      Toast.show('Rescue Pack generated.', 1400);
    };

    card.querySelector('#v41-rp-generate').addEventListener('click', generate);

    card.querySelector('#v41-rp-copy').addEventListener('click', async ()=>{
      try{
        if(!codeEl.value.trim()){ generate(); }
        await navigator.clipboard.writeText(codeEl.value.trim());
        Toast.show('Copied.', 1200);
      }catch(e){
        Toast.show('Copy failed (clipboard permission).', 2200);
      }
    });

    card.querySelector('#v41-rp-share').addEventListener('click', async ()=>{
      try{
        if(!codeEl.value.trim()){ generate(); }
        const text = codeEl.value.trim();
        if(navigator.share){
          await navigator.share({ title:'VitalGuard AI Rescue Pack', text });
        }else{
          await navigator.clipboard.writeText(text);
          Toast.show('Share not supported. Copied to clipboard.', 2400);
        }
      }catch(e){
        Toast.show('Share cancelled.', 1500);
      }
    });

    card.querySelector('#v41-rp-start').addEventListener('click', ()=>{
      const txt = card.querySelector('#v41-rp-import').value.trim();
      if(!txt){ Toast.show('Paste a code first.', 2000); return; }
      SOS.startRescueAssist(txt);
      V41UI.renderRescueAssist();
    });

    card.querySelector('#v41-rp-stop').addEventListener('click', ()=>{
      SOS.stopRescueAssist();
      V41UI.renderRescueAssist();
    });

    // draw placeholder
    try{
      const ctx = qrCanvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,qrCanvas.width, qrCanvas.height);
      ctx.fillStyle = '#999'; ctx.font = '12px system-ui'; ctx.fillText('QR', 10, 20);
    }catch(_){}
  };

  V41UI.renderRescueAssist = function(){
    const box = document.getElementById('v41-rp-assist');
    if(!box) return;

    if(!SOS._assist.active || !SOS._assist.pet){
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }
    box.style.display = 'block';
    const pet = SOS._assist.pet;
    const age = pet.lastSeenMs ? Math.round((nowMs() - pet.lastSeenMs)/1000) : null;
    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:900">${pet.icon} ${pet.name} <span class="badge">${pet.zone?.stable || 'â€”'}</span></div>
          <div style="font-size:.74rem;color:var(--text-muted);line-height:1.4">
            Rescue ID: <b>${pet.rescueId}</b> Â· last seen: <b>${age===null?'â€”':age+'s'}</b> ago
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:.78rem">RSSI: <b>${Number.isFinite(pet.smoothedRssi)? Math.round(pet.smoothedRssi):'â€”'}</b>dBm</div>
          <div style="font-size:.78rem">Distance: <b>${Number.isFinite(pet.estimatedDistanceM)? pet.estimatedDistanceM.toFixed(1):'â€”'}</b>m</div>
        </div>
      </div>
    `;
  };

  // lightweight periodic update without DOM churn
  V41UI._lastAssistPaint = 0;
  V41UI.renderRescueAssistMini = function(){
    const now = nowMs();
    if(now - V41UI._lastAssistPaint < 600) return;
    V41UI._lastAssistPaint = now;
    V41UI.renderRescueAssist();
  };
})();

/* -------- Patch Detail.render to inject v4.1 UI blocks -------- */
(function(){
  const _origDetailRender = Detail.render.bind(Detail);
  Detail.render = function(p){
    _origDetailRender(p);
    V41UI.injectDetailMetersLeash(p);
    V41UI.injectDetailAlertPrefs(p);
    V41UI.injectDetailCalibPro(p);
  };
})();

/* -------- Patch V40UI.inject to include v4.1 injections -------- */
(function(){
  const _origInject = V40UI.inject.bind(V40UI);
  V40UI.inject = function(){
    _origInject();
    V41UI.injectWizardCalibPro();
    V41UI.injectSOSRescuePack();
  };
})();

/* -------- Diagnostics: implement missing Run Self-Test button -------- */
(function(){
  if(typeof Diag.runQuickTest === 'function') return;
  Diag._lastSelfTest = null;

  const _origSnapshot = Diag.snapshot.bind(Diag);
  Diag.snapshot = function(){
    const snap = _origSnapshot();
    if(Diag._lastSelfTest) snap.selfTest = Diag._lastSelfTest;
    return snap;
  };

  Diag.runQuickTest = function(){
    const results = [];
    const t0 = performance.now();

    // 1) QR generator
    try{
      const qr = qrcodegen.QrCode.encodeText('VG-SELFTEST', qrcodegen.QrCode.Ecc.MEDIUM);
      results.push({test:'QR', ok:true, detail:`version ${qr.version} size ${qr.size}`});
    }catch(e){
      results.push({test:'QR', ok:false, detail:String(e)});
    }

    // 2) RLS calibrator sanity
    try{
      const rls = new RLSCalibrator();
      // synthetic: tx=-59, n=2.2
      const tx = -59, n = 2.2;
      const dists = [2,3,5,8,10,12];
      dists.forEach(d=>{
        const rssi = tx - 10*n*Math.log10(d);
        rls.update(d, rssi);
      });
      card.querySelector('#v41-rp-sms').addEventListener('click', ()=>{
        try{
          if(!codeEl.value.trim()){ generate(); }
          const text = encodeURIComponent(codeEl.value.trim());
          // NOTE: SMS URL schemes vary by platform; this works on most mobile browsers.
          window.location.href = `sms:?&body=${text}`;
        }catch(e){
          Toast.show('SMS not supported on this device.', 2400);
        }
      });

      const p = rls.params();
      const ok = Math.abs(p.txPower - tx) < 6 && Math.abs(p.n - n) < 0.8;
      results.push({test:'RLS', ok, detail:`tx ${p.txPower.toFixed(1)} n ${p.n.toFixed(2)}`});
    }catch(e){
      results.push({test:'RLS', ok:false, detail:String(e)});
    }

    // 3) Rescue Pack encode/decode sanity (if pet exists)
    try{
      const pet = App.pets && App.pets[0] ? App.pets[0] : null;
      if(pet && SOS.buildRescuePack){
        const code = SOS.encodeRescuePack(SOS.buildRescuePack(pet));
        const pack = SOS.decodeRescuePack(code);
        const ok = pack && pack.p && pack.p.r === pet.rescueId;
        results.push({test:'RescuePack', ok, detail: ok ? 'encode/decode ok' : 'mismatch'});
      }else{
        results.push({test:'RescuePack', ok:true, detail:'skipped (no pets)'});
      }
    }catch(e){
      results.push({test:'RescuePack', ok:false, detail:String(e)});
    }

    // 4) Performance micro-bench (10 pets Ã— 200 adv)
    try{
      const pets = [];
      for(let i=0;i<10;i++){
        const p = new Pet({name:'T'+i, icon:'ğŸ¾', signature:{namePrefix:'TAG'+i}});
        pets.push(p);
      }
      // fake advertisement event (name matches only one)
      const fakeEv = { device:{id:'x'}, name:'TAG3_ABC', manufacturerData:null, serviceData:null, uuids:[] };
      const t1 = performance.now();
      for(let k=0;k<200;k++){
        pets.forEach(p=>matchScore(fakeEv, p.signature));
      }
      const ms = performance.now() - t1;
      results.push({test:'Perf', ok: ms < 40, detail:`matchScore loop ~${ms.toFixed(1)}ms`});
    }catch(e){
      results.push({test:'Perf', ok:false, detail:String(e)});
    }

    const dt = performance.now() - t0;
    const okAll = results.every(r=>r.ok);

    Diag._lastSelfTest = { time: new Date().toISOString(), ok: okAll, dtMs: Math.round(dt), results };
    console.log('[VitalGuardAI SelfTest]', Diag._lastSelfTest);

    Toast.show(okAll ? `Self-Test OK (${Math.round(dt)}ms)` : `Self-Test found issues (see Diagnostics)`, 2600);

    try{
      // refresh diag view if open
      if(document.getElementById('diag-overlay')?.classList.contains('active')){
        Diag.open();
      }
    }catch(_){}
  };
})();



/* -------- Persist & restore v4.1 per-pet fields (alertPrefs / leashDistanceM / disabled / lostEvents) -------- */
(function(){
  // 1) Persist extra fields
  const _toJSON = Pet.prototype.toJSON;
  Pet.prototype.toJSON = function(){
    const base = _toJSON.call(this);
    try{
      base.alertPrefs = this.alertPrefs;
      base.leashDistanceM = this.leashDistanceM;
      base.disabled = !!this.disabled;
      base.lostEvents = Array.isArray(this.lostEvents) ? this.lostEvents : [];
    }catch(_){}
    return base;
  };

  // 2) Restore extra fields after App.init loads pets
  const _origInit = App.init.bind(App);
  App.init = async function(){
    await _origInit();
    try{
      const raws = await Store.getAllPets();
      const byId = new Map(raws.map(r => [r.id, r]));

      let activeCount = 0;
      let autoDisabled = 0;
      let changed = 0;

      for(const p of this.pets){
        const r = byId.get(p.id);
        if(r){
          if(r.alertPrefs) p.alertPrefs = r.alertPrefs;
          if(Number.isFinite(r.leashDistanceM)) p.leashDistanceM = r.leashDistanceM;
          if(r.disabled !== undefined) p.disabled = !!r.disabled;
          if(Array.isArray(r.lostEvents)) p.lostEvents = r.lostEvents;
        }

        v41EnsureAlertPrefs(p);

        if(!p.leashDistanceM){
          const m = (p.leashPreset && /^\d+m$/.test(p.leashPreset)) ? parseInt(p.leashPreset,10) : null;
          if(m){ p.leashDistanceM = m; changed++; }
        }

        if(!p.disabled){
          activeCount++;
          if(activeCount > V41_MAX_ACTIVE_PETS){
            p.disabled = true;
            autoDisabled++;
            changed++;
          }
        }
      }

      if(autoDisabled > 0){
        Toast.show(`Stability: ${autoDisabled} pets auto-disabled (over ${V41_MAX_ACTIVE_PETS} active).`, 4200);
      }

      // Persist changes only if needed
      if(changed > 0){
        for(const p of this.pets){
          Store.savePet(p);
        }
      }

      this.render();
    }catch(e){
      console.warn('v4.1 init migrate failed:', e);
    }
  };
})();


/* ----------------------------- FINAL: boot once ----------------------------- */
  // Ensure injection is ready even if Settings tab opened before init
  try{ V40UI.inject(); }catch(e){}

})();


/* ----------------------------- GLOBAL EVENT HOOKS ----------------------------- */
// Prime audio on first user gesture (helps autoplay restrictions)
document.addEventListener('pointerdown', async ()=>{
  await AudioEngine.ensure();
}, {once:true});

/* ----------------------------- INIT ----------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{ try{ I18N.init(); }catch(e){} App.init(); });

</script>
</body>
</html>
